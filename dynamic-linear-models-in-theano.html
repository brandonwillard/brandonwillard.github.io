<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Dynamic Linear Models in Theano - Brandon T. Willard</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://brandonwillard.github.io/dynamic-linear-models-in-theano.html">

        <meta name="author" content="Brandon T. Willard" />
        <meta name="keywords" content="symbolic-pymc,theano,statistics,timeseries,dlm,ffbs,gibbs" />

        <meta property="og:site_name" content="Brandon T. Willard" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Dynamic Linear Models in Theano"/>
        <meta property="og:url" content="https://brandonwillard.github.io/dynamic-linear-models-in-theano.html"/>
        <meta property="og:description" content=""/>
        <meta property="article:published_time" content="2020-03-18" />
            <meta property="article:section" content="articles" />
            <meta property="article:tag" content="symbolic-pymc" />
            <meta property="article:tag" content="theano" />
            <meta property="article:tag" content="statistics" />
            <meta property="article:tag" content="timeseries" />
            <meta property="article:tag" content="dlm" />
            <meta property="article:tag" content="ffbs" />
            <meta property="article:tag" content="gibbs" />
            <meta property="article:author" content="Brandon T. Willard" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://brandonwillard.github.io/theme/css/bootstrap.readable.min.css" type="text/css"/>
    <link href="https://brandonwillard.github.io/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://brandonwillard.github.io/theme/css/academicons.min.css" rel="stylesheet">

    <link href="https://brandonwillard.github.io/theme/css/pygments/vim.css" rel="stylesheet">
    <link rel="stylesheet" href="https://brandonwillard.github.io/theme/css/style.css" type="text/css"/>
        <link href="https://brandonwillard.github.io/extra/custom.css" rel="stylesheet">

        <link href="https://brandonwillard.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Brandon T. Willard ATOM Feed"/>

        <link href="https://brandonwillard.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Brandon T. Willard RSS Feed"/>


        <link href="https://brandonwillard.github.io/feeds/articles.atom.xml" type="application/atom+xml" rel="alternate"
              title="Brandon T. Willard articles ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://brandonwillard.github.io/" class="navbar-brand">
Brandon T. Willard            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://brandonwillard.github.io/pages/publications.html">
                             Publications
                          </a></li>
                         <li><a href="https://brandonwillard.github.io/pages/projects.html">
                             Projects
                          </a></li>
                         <li><a href="https://brandonwillard.github.io/pages/about.html">
                             About
                          </a></li>
                        <li class="active">
                            <a href="https://brandonwillard.github.io/category/articles.html">Articles</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://brandonwillard.github.io/dynamic-linear-models-in-theano.html"
                       rel="bookmark"
                       title="Permalink to Dynamic Linear Models in Theano">
                        Dynamic Linear Models in Theano
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2020-03-18T00:00:00-05:00"> Wed 18 March 2020</time>
    </span>
          <span class="label label-default">Modified</span>
            <span class="modified">
                <i class="fa fa-calendar"></i><time datetime="2020-05-02T00:00:00-05:00"> Sat 02 May 2020</time>
            </span>





<span class="label label-default">Tags</span>
	<a href="https://brandonwillard.github.io/tag/symbolic-pymc.html">symbolic-pymc</a>
        /
	<a href="https://brandonwillard.github.io/tag/theano.html">theano</a>
        /
	<a href="https://brandonwillard.github.io/tag/statistics.html">statistics</a>
        /
	<a href="https://brandonwillard.github.io/tag/timeseries.html">timeseries</a>
        /
	<a href="https://brandonwillard.github.io/tag/dlm.html">dlm</a>
        /
	<a href="https://brandonwillard.github.io/tag/ffbs.html">ffbs</a>
        /
	<a href="https://brandonwillard.github.io/tag/gibbs.html">gibbs</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Brandon T. Willard" />
  <title>Dynamic Linear Models in Theano</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
</head>
<body>
<!--  -->
<!-- <div id="header"> -->
<!-- <h1 class="title">Dynamic Linear Models in Theano</h1> -->
<!--  -->
<!--  -->
<!-- <h2 class="author">Brandon T. Willard</h2> -->
<!--  -->
<!--  -->
<!-- <h3 class="date">2020–03–18</h3> -->
<!--  -->
<!-- </div> -->
<!--  -->
<ul>
<li><a href="#org8ae0857">Introduction</a></li>
<li><a href="#org8873a63">Analytic Posteriors</a></li>
<li><a href="#orgefb3ef8">Posterior Estimation</a>
<ul>
<li><a href="#org1d9986d">SVD-based Filtering</a></li>
<li><a href="#org350fa8d">SVD-based Smoothing</a></li>
<li><a href="#org9beb158">Example</a></li>
</ul></li>
<li><a href="#orgaa30fc5">Forward-filtering Backward-sampling</a>
<ul>
<li><a href="#org231ac83">Simulation Example</a></li>
</ul></li>
<li><a href="#orge6290b1">Non-Gaussian Extension</a>
<ul>
<li><a href="#orgeeb5707">Simulation Example</a></li>
</ul></li>
<li><a href="#orgd705951">Augmented FFBS Sampler</a>
<ul>
<li><a href="#orgafe10a4">Simulation Example</a></li>
<li><a href="#orgf74c6fe">COVID–19 Example</a></li>
</ul></li>
<li><a href="#org24da3be">Discussion</a></li>
</ul>
<div class="abstract">
<p>In this document we detail how dynamic linear models (DLMs) can be implemented in Theano (or similar tensor libraries), as well as a complementary Rao-Blackwellized sampler tailored to the structure of DLMs. Furthermore, we provide an example of how DLMs can be extended–via Gaussian scale-mixtures–to model non-gaussian observations. The example is a Pólya-Gamma extension to forward-filtering backward-sampling for negative-binomial observations.</p>
</div>
<p><a id="org8ae0857"></a></p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>For a proper introduction of dynamic linear models and their estimation, see <a id="4bbd465b4e78e5c5151b0cbba54d984e"><a href="#harrison_bayesian_1999">Harrison &amp; West (1999)</a></a>,<a id="1c3f471fd137724bd53b01eb4d6534fe"><a href="#PetrisDynamicLinearModels2009">Petris, Petrone &amp; Campagnoli (2009)</a></a>, and <a id="8247a823e73eba801aad2942a49b03be"><a href="#GamermanMarkovchainMonte2006">Gamerman &amp; Lopes (2006)</a></a>,<a id="c6a5d83a82b5963f42264d85625b5153"><a href="#pole_applied_1994">Pole, West &amp; Harrison (1994)</a></a>. The focus of this document is on some practical details behind DLM estimation in Python–and, particularly, libraries like Theano <a id="25fdcab375e353d7bb32eec7b13064c6"><a href="#bergstra_theano:_2010">(Bergstra, Breuleux, Bastien, Lamblin, Pascanu, Desjardins, Turian, Warde-Farley &amp; Bengio 2010)</a></a>. Throughout, we use some custom random variable objects from <code>symbolic-pymc</code> <a id="e8fa26b92264fca946be25e6b617fc56"><a href="#Willardsymbolicpymc2019">(Willard 2019)</a></a>. This is largely because <code>symbolic-pymc</code> offers a necessary non-standard distribution and its random variables work well within the <code>scan</code> operations we employ.</p>
<p>In the future, we plan to build optimizations that automate much of the work done here (and more). This exposition sets the foundation for such work by first motivating the use and generality of Bayesian frameworks like DLMs, then by demonstrating the analytic steps that produce customized, efficient samplers. These are the steps that would undergo automation in the future.</p>
<p><a id="org8873a63"></a></p>
</section>
<section id="analytic-posteriors" class="level1">
<h1>Analytic Posteriors</h1>
<p>We start by considering the simple form of a DLM <a id="4bbd465b4e78e5c5151b0cbba54d984e"><a href="#harrison_bayesian_1999">(Harrison &amp; West 1999)</a></a> with prior <span class="math inline">\(\theta_0 \sim \operatorname{N}\left( m_0, C_0 \right)\)</span>:</p>
<p><span class="math display">\[\begin{align}
  y_t &amp;= F_t^{\top} \theta_{t} + \epsilon_t, \quad \epsilon_t \sim \operatorname{N}\left( 0, V \right)
  \label{eq:basic-dlm-obs}
  \\
  \theta_t &amp;= G_t \theta_{t-1} + \nu_t, \quad \nu_t \sim \operatorname{N}\left( 0, W \right)
  \label{eq:basic-dlm-state}
\end{align}\]</span></p>
<p>for <span class="math inline">\(t \in \{1, \dots, T\}\)</span>, <span class="math inline">\(y_t \in \mathbb{R}\)</span>, and <span class="math inline">\(\theta_t \in \mathbb{R}^{M}\)</span>.</p>
<p>The most “notationally” faithful representation of the timeseries model in <span class="math inline">\(\eqref{eq:basic-dlm-state}\)</span> using Theano is provided in Listing <a href="#orge6ada13">2</a>. It represents the notion of a recursion–to the best of Theano’s ability–by way of the <code>scan</code> operator.</p>
<figure>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="im">import</span> theano</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="im">import</span> theano.tensor <span class="im">as</span> tt</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="im">from</span> cycler <span class="im">import</span> cycler</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="im">from</span> matplotlib.collections <span class="im">import</span> LineCollection</a>
<a class="sourceLine" id="cb1-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="im">from</span> theano.printing <span class="im">import</span> debugprint <span class="im">as</span> tt_dprint</a>
<a class="sourceLine" id="cb1-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="im">from</span> symbolic_pymc.theano.random_variables <span class="im">import</span> NormalRV, MvNormalRV, GammaRV, observed</a>
<a class="sourceLine" id="cb1-15" data-line-number="15"></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"></a>
<a class="sourceLine" id="cb1-17" data-line-number="17">plt.style.use(<span class="st">&#39;ggplot&#39;</span>)</a>
<a class="sourceLine" id="cb1-18" data-line-number="18">plt_orig_cycler <span class="op">=</span> plt.rcParams[<span class="st">&#39;axes.prop_cycle&#39;</span>]</a>
<a class="sourceLine" id="cb1-19" data-line-number="19">plt.rc(<span class="st">&#39;text&#39;</span>, usetex<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb1-20" data-line-number="20"></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="co"># theano.config.cxx = &quot;&quot;</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="co"># theano.config.mode = &quot;FAST_COMPILE&quot;</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23">tt.config.compute_test_value <span class="op">=</span> <span class="st">&#39;ignore&#39;</span></a></code></pre></div>
</figure>
<figure id="orge6ada13">
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" data-line-number="1"></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">N_obs_tt <span class="op">=</span> tt.iscalar(<span class="st">&quot;N_obs&quot;</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">N_theta_tt <span class="op">=</span> tt.iscalar(<span class="st">&quot;N_theta&quot;</span>)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">G_tt <span class="op">=</span> tt.specify_shape(tt.matrix(), [N_theta_tt, N_theta_tt])</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">G_tt.name <span class="op">=</span> <span class="st">&#39;G_t&#39;</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">F_tt <span class="op">=</span> tt.specify_shape(tt.col(), [N_theta_tt, <span class="dv">1</span>])</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">F_tt.name <span class="op">=</span> <span class="st">&#39;F_t&#39;</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">rng_state <span class="op">=</span> np.random.RandomState(np.random.MT19937(np.random.SeedSequence(<span class="dv">1234</span>)))</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">rng_init_state <span class="op">=</span> rng_state.get_state()</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">rng_tt <span class="op">=</span> theano.shared(rng_state, name<span class="op">=</span><span class="st">&#39;rng&#39;</span>, borrow<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">rng_tt.tag.is_rng <span class="op">=</span> <span class="va">True</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15">rng_tt.default_update <span class="op">=</span> rng_tt</a>
<a class="sourceLine" id="cb2-16" data-line-number="16"></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">m_0_tt <span class="op">=</span> tt.zeros([N_theta_tt])</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">m_0_tt.name <span class="op">=</span> <span class="st">&quot;m_0&quot;</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19">C_0_tt <span class="op">=</span> <span class="fl">1000.0</span> <span class="op">*</span> tt.eye(N_theta_tt)</a>
<a class="sourceLine" id="cb2-20" data-line-number="20">C_0_tt.name <span class="op">=</span> <span class="st">&quot;C_0&quot;</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">theta_0_rv <span class="op">=</span> MvNormalRV(m_0_tt, C_0_tt, rng<span class="op">=</span>rng_tt, name<span class="op">=</span><span class="st">&#39;theta_0&#39;</span>)</a>
<a class="sourceLine" id="cb2-23" data-line-number="23"></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">phi_W_true <span class="op">=</span> np.r_[<span class="fl">5.0</span>, <span class="fl">10.0</span>]</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">phi_W_tt <span class="op">=</span> theano.shared(phi_W_true, name<span class="op">=</span><span class="st">&#39;phi_W&#39;</span>)</a>
<a class="sourceLine" id="cb2-26" data-line-number="26">W_tt <span class="op">=</span> tt.eye(N_theta_tt) <span class="op">*</span> tt.inv(phi_W_tt)</a>
<a class="sourceLine" id="cb2-27" data-line-number="27">W_tt.name <span class="op">=</span> <span class="st">&quot;W_t&quot;</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28"></a>
<a class="sourceLine" id="cb2-29" data-line-number="29">phi_V_true <span class="op">=</span> <span class="fl">0.1</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30">phi_V_tt <span class="op">=</span> theano.shared(phi_V_true, name<span class="op">=</span><span class="st">&#39;phi_V&#39;</span>)</a>
<a class="sourceLine" id="cb2-31" data-line-number="31">V_tt <span class="op">=</span> tt.inv(phi_V_tt)</a>
<a class="sourceLine" id="cb2-32" data-line-number="32">V_tt.name <span class="op">=</span> <span class="st">&quot;V_t&quot;</span></a>
<a class="sourceLine" id="cb2-33" data-line-number="33"></a>
<a class="sourceLine" id="cb2-34" data-line-number="34"><span class="kw">def</span> state_step(theta_tm1, G_t, W_t, N_theta, rng):</a>
<a class="sourceLine" id="cb2-35" data-line-number="35">    nu_rv <span class="op">=</span> MvNormalRV(tt.zeros([N_theta]), W_t, rng<span class="op">=</span>rng, name<span class="op">=</span><span class="st">&#39;nu&#39;</span>)</a>
<a class="sourceLine" id="cb2-36" data-line-number="36">    theta_t <span class="op">=</span> G_t.dot(theta_tm1) <span class="op">+</span> nu_rv</a>
<a class="sourceLine" id="cb2-37" data-line-number="37">    <span class="cf">return</span> theta_t</a>
<a class="sourceLine" id="cb2-38" data-line-number="38"></a>
<a class="sourceLine" id="cb2-39" data-line-number="39"></a>
<a class="sourceLine" id="cb2-40" data-line-number="40">theta_t_rv, theta_t_updates <span class="op">=</span> theano.scan(fn<span class="op">=</span>state_step,</a>
<a class="sourceLine" id="cb2-41" data-line-number="41">                                          outputs_info<span class="op">=</span>{<span class="st">&quot;initial&quot;</span>: theta_0_rv, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb2-42" data-line-number="42">                                          non_sequences<span class="op">=</span>[G_tt, W_tt, N_theta_tt, rng_tt],</a>
<a class="sourceLine" id="cb2-43" data-line-number="43">                                          n_steps<span class="op">=</span>N_obs_tt,</a>
<a class="sourceLine" id="cb2-44" data-line-number="44">                                          strict<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb2-45" data-line-number="45">                                          name<span class="op">=</span><span class="st">&#39;theta_t&#39;</span>)</a>
<a class="sourceLine" id="cb2-46" data-line-number="46"></a>
<a class="sourceLine" id="cb2-47" data-line-number="47"><span class="kw">def</span> obs_step(theta_t, F_t, V_t, rng):</a>
<a class="sourceLine" id="cb2-48" data-line-number="48">    eps_rv <span class="op">=</span> NormalRV(<span class="fl">0.0</span>, tt.sqrt(V_t), rng<span class="op">=</span>rng, name<span class="op">=</span><span class="st">&#39;eps&#39;</span>)</a>
<a class="sourceLine" id="cb2-49" data-line-number="49">    y_t <span class="op">=</span> F_t.T.dot(theta_t) <span class="op">+</span> eps_rv</a>
<a class="sourceLine" id="cb2-50" data-line-number="50">    <span class="cf">return</span> y_t</a>
<a class="sourceLine" id="cb2-51" data-line-number="51"></a>
<a class="sourceLine" id="cb2-52" data-line-number="52"></a>
<a class="sourceLine" id="cb2-53" data-line-number="53">Y_t_rv, Y_t_updates <span class="op">=</span> theano.scan(fn<span class="op">=</span>obs_step,</a>
<a class="sourceLine" id="cb2-54" data-line-number="54">                                  sequences<span class="op">=</span>[theta_t_rv],</a>
<a class="sourceLine" id="cb2-55" data-line-number="55">                                  non_sequences<span class="op">=</span>[F_tt, V_tt, rng_tt],</a>
<a class="sourceLine" id="cb2-56" data-line-number="56">                                  strict<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb2-57" data-line-number="57">                                  name<span class="op">=</span><span class="st">&#39;Y_t&#39;</span>)</a></code></pre></div>
<figcaption>
Listing 2
</figcaption>
</figure>
<p>Throughout we’ll use data sampled from <span class="math inline">\(\eqref{eq:basic-dlm-state}\)</span> for demonstration purposes. Our simulation has the following model parameter values:</p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    T = 200,\quad M = 2
    \\
    W_t = \operatorname{diag}\left( \phi_W \right)
    ,\quad
    V_t = \operatorname{diag}\left( \phi_V \right)
    \\
    \phi_W = \left(1.1, 10\right),\quad \phi_V = 0.7
    \\
    G_t = \begin{pmatrix}
    1 &amp; 0.1 \\
    0 &amp; 1 \\
    \end{pmatrix},\quad
    F_t = \begin{pmatrix}
    1 \\
    0
    \end{pmatrix}
    \\
    \theta_0 = \begin{pmatrix}
    0 \\
    0
    \end{pmatrix}
  \end{gathered}
  \label{eq:sim-settings}
\end{equation}\]</span></p>
<p>A sample from <span class="math inline">\(\eqref{eq:sim-settings}\)</span> is generated in Listing <a href="#org721f0b8">3</a>.</p>
<figure id="org721f0b8">
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="im">from</span> theano <span class="im">import</span> function <span class="im">as</span> tt_function</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">dlm_sim_values <span class="op">=</span> {</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    N_obs_tt: <span class="dv">200</span>,</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    N_theta_tt: <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    G_tt: np.r_[<span class="st">&#39;0,2&#39;</span>,</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">                [<span class="fl">1.0</span>, <span class="fl">0.1</span>],</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">                [<span class="fl">0.0</span>, <span class="fl">1.0</span>]].astype(tt.config.floatX),</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">    F_tt: np.r_[[[<span class="fl">1.0</span>],</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">                 [<span class="fl">0.0</span>]]].astype(tt.config.floatX)</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"></a>
<a class="sourceLine" id="cb3-13" data-line-number="13">rng_tt.get_value(borrow<span class="op">=</span><span class="va">True</span>).set_state(rng_init_state)</a>
<a class="sourceLine" id="cb3-14" data-line-number="14"></a>
<a class="sourceLine" id="cb3-15" data-line-number="15">simulate_dlm <span class="op">=</span> tt_function([N_obs_tt, N_theta_tt, G_tt, F_tt],</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">                           [Y_t_rv, theta_t_rv],</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">                           givens<span class="op">=</span>{theta_0_rv: np.r_[<span class="fl">0.0</span>, <span class="fl">0.0</span>]},</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">                           updates<span class="op">=</span>Y_t_updates)</a>
<a class="sourceLine" id="cb3-19" data-line-number="19"></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">y_sim, theta_t_sim <span class="op">=</span> simulate_dlm(dlm_sim_values[N_obs_tt], dlm_sim_values[N_theta_tt], dlm_sim_values[G_tt], dlm_sim_values[F_tt])</a>
<a class="sourceLine" id="cb3-21" data-line-number="21"></a>
<a class="sourceLine" id="cb3-22" data-line-number="22">rng_sim_state <span class="op">=</span> rng_tt.get_value(borrow<span class="op">=</span><span class="va">True</span>).get_state()</a></code></pre></div>
<figcaption>
Listing 3
</figcaption>
</figure>
<p>In Figure <a href="#org04355d9">4</a> we plot a sample from the model in Listing <a href="#orge6ada13">2</a> for a fixed RNG seed.</p>
<figure id="org04355d9">
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" data-line-number="1">plt.clf()</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">_ <span class="op">=</span> ax.plot(y_sim, label<span class="op">=</span><span class="vs">r&#39;$y_t$&#39;</span>, color<span class="op">=</span><span class="st">&#39;black&#39;</span>, linewidth<span class="op">=</span><span class="fl">0.7</span>)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">plt.tight_layout()</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">plt.legend()</a></code></pre></div>
<figcaption>
Listing 4
</figcaption>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/basic-dlm-sim-plot.png" alt="" />
<figcaption>
</figcaption>
</figure>
<p>The standard DLM is essentially a <a href="https://en.wikipedia.org/wiki/Kalman_filter">Kalman Filter</a> and enjoys many well documented closed-form results. In the following, we will simply state the relevant prior predictive and posterior results.</p>
<p>Given all the prior and observed data up to time <span class="math inline">\(t\)</span>, <span class="math inline">\(D_t\)</span>, these distribution are given by the following:</p>
<p><span class="math display">\[\begin{align}
  \theta_{t} \mid D_{t-1} &amp;\sim \operatorname{N}\left( a_{t}, R_{t} \right)
  \\
  y_{t} \mid D_{t-1} &amp;\sim \operatorname{N}\left( f_{t}, Q_{t} \right)
\end{align}\]</span></p>
<p>The prior predictive moments are as follows:</p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    a_t = G_t m_{t-1}, \quad R_t = G_t C_{t-1} G_t^\top + W_t
    \\
    f_t = F_t^\top a_{t}, \quad Q_t = F_t^\top C_{t-1} F_t + V_t
  \end{gathered}
  \label{eq:dlm-prior-predictive}
\end{equation}\]</span></p>
<p>We’ll also want to compute the posterior moments for <span class="math inline">\(\theta_t \mid D_t\)</span>, which are as follows:</p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    m_t = a_{t} + R_t F_t Q_t^{-1} \left(y_t - f_t\right),
    \quad C_t = R_t  - R_t F_t Q_t^{-1} F_t^\top R_t
  \end{gathered}
  \label{eq:dlm-post-moments}
\end{equation}\]</span></p>
<p>These “filtered” moments/distributions are one “kind” of posterior result for a DLM, and they only take into account the data <strong>up to</strong> time <span class="math inline">\(t\)</span>. The other kind are the “smoothed” distributions, which provide posterior distributions for each time <span class="math inline">\(t\)</span> given all observations preceding <strong>and</strong> following <span class="math inline">\(t\)</span>.</p>
<p>Notationally, we’ve used <span class="math inline">\(D_t\)</span> to signify all conditional observations and parameters up to time <span class="math inline">\(t\)</span>, so the smoothed distributions are given by <span class="math inline">\(\theta_t \mid D_T\)</span>, in contrast to <span class="math inline">\(\theta_t \mid D_t\)</span></p>
<p>The smoothed <span class="math inline">\(\theta_t\)</span> distributions are still Gaussian, i.e. <span class="math inline">\(\left(\theta_t \mid D_T\right) \sim \operatorname{N}\left(s_t, S_t\right)\)</span> and its moments are as follows:</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    s_t &amp;= m_t + C_t G_{t+1}^\top R_{t+1}^{-1} \left( s_{t+1} - a_{t+1} \right)
    \\
    S_t &amp;= C_t - C_t G_{t+1}^\top R_{t+1}^{-1} \left( R_{t+1} - S_{t+1} \right) R_{t+1}^{-1} G_{t+1} C_t
  \end{aligned}
  \label{eq:dlm-smooth-moments}
\end{equation}\]</span></p>
<div class="remark" data-markdown="">
<p>In most cases, models will not be as simple as the standard DLM. Even so, these basic closed-form solutions can still be relevant. For instance, efficient MCMC algorithms can be constructed using these closed-form results for <strong>conditionally linear</strong> models. In those cases, we can compute the posterior moments–in closed-form–conditional on samples generated by other means.</p>
</div>
<p>The standard approach is called forward-filtering backward-sampling (FFBS) and uses smoothed posteriors <span class="math inline">\(\theta_t \mid \theta_{t+1}, D_T\)</span> conditioned on all other parameters.</p>
<p>We’ll build up to forward-backward sampling in what follows, but, first, we need to establish how the requisite quantities can be computed symbolically.</p>
<p><a id="orgefb3ef8"></a></p>
</section>
<section id="posterior-estimation" class="level1">
<h1>Posterior Estimation</h1>
<p>In Listings <a href="#org224c0e5">6</a> and <a href="#org911f8da">7</a>, we demonstrate how the posterior moments in <span class="math inline">\(\eqref{eq:dlm-post-moments}\)</span> and <span class="math inline">\(\eqref{eq:dlm-smooth-moments}\)</span> can be computed in Theano.</p>
<p>Unfortunately, if we attempt to implement the exact closed-form updates in <span class="math inline">\(\eqref{eq:dlm-post-moments}\)</span> or <span class="math inline">\(\eqref{eq:dlm-smooth-moments}\)</span>, our results will be fraught with numerical errors. This is a very basic issue with naively implemented Kalman filters. The solution to these issues usually involves some analytic reformulations that compensate for the covariance matrix subtractions. The standard approaches generally use some form of matrix decomposition that directly accounts for the positive semi-definite nature of the covariance matrices.</p>
<p>The approach taken here is based on the singular value decomposition (SVD) and effectively computes only one symmetric “half” of the updated covariances. The SVD also allows for easy inversions. See <a id="0ae04c048b20d07f32d7f0f75bb51483"><a href="#ZhangFixedintervalsmoothingalgorithm1996">Zhang &amp; Li (1996)</a></a> for more details, or <a id="3a4d89388a434d7b1b91dc8690f3a03b"><a href="#PetrisDynamiclinearmodels2009">Petris, Petrone &amp; Campagnoli (2009)</a></a> for a concise overview of the procedure in the context of DLMs.</p>
<figure>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="im">import</span> warnings</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">warnings.filterwarnings(<span class="st">&quot;ignore&quot;</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>, message<span class="op">=</span><span class="st">&quot;Using a non-tuple sequence&quot;</span>)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="im">from</span> theano.tensor.nlinalg <span class="im">import</span> matrix_dot</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="kw">def</span> tt_finite_inv(x, eps_truncate<span class="op">=</span><span class="va">False</span>):</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">    <span class="co">&quot;&quot;&quot;Compute the element-wise reciprocal with special handling for small inputs.</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="co">    Parameters</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="co">    ==========</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co">    x: Tensor-like</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="co">        The value for which the reciprocal, i.e. `1/x`, is computed.</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="co">    eps_truncate: bool (optional)</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="co">        Determines whether or not a floating-point epsilon truncation is used to</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18"><span class="co">        upper-bound the returned values.</span></a>
<a class="sourceLine" id="cb5-19" data-line-number="19"><span class="co">        If not (the default), infinite values are simply set to zero.</span></a>
<a class="sourceLine" id="cb5-20" data-line-number="20"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb5-21" data-line-number="21">    <span class="cf">if</span> eps_truncate:</a>
<a class="sourceLine" id="cb5-22" data-line-number="22">        eps <span class="op">=</span> np.finfo(<span class="bu">getattr</span>(x, <span class="st">&#39;dtype&#39;</span>, <span class="va">None</span>) <span class="kw">or</span> theano.config.floatX).eps</a>
<a class="sourceLine" id="cb5-23" data-line-number="23">        <span class="cf">return</span> tt.minimum(tt.inv(x), np.reciprocal(np.sqrt(eps)))</a>
<a class="sourceLine" id="cb5-24" data-line-number="24">    <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb5-25" data-line-number="25">        y <span class="op">=</span> tt.inv(x)</a>
<a class="sourceLine" id="cb5-26" data-line-number="26">        res_subtensor <span class="op">=</span> y[tt.isinf(y)]</a>
<a class="sourceLine" id="cb5-27" data-line-number="27">        <span class="cf">return</span> tt.set_subtensor(res_subtensor, <span class="fl">0.0</span>)</a></code></pre></div>
</figure>
<p><a id="org1d9986d"></a></p>
<section id="svd-based-filtering" class="level2">
<h2>SVD-based Filtering</h2>
<p>The SVD forms of the filtering equations in <span class="math inline">\(\eqref{eq:dlm-post-moments}\)</span> are produced through creative use of the SVDs of its component matrices. Using a slightly modified version of the formulation established in <a id="3a4d89388a434d7b1b91dc8690f3a03b"><a href="#PetrisDynamiclinearmodels2009">Petris, Petrone &amp; Campagnoli (2009)</a></a>, the SVD for a matrix <span class="math inline">\(M\)</span> is given by <span class="math inline">\(M = U_{M} D_{M} V_{M}^\top\)</span>. A symmetric matrix then takes the form <span class="math inline">\(M = U_{M} D_{M} U_{M}^\top\)</span> and its “square-root” is given by <span class="math inline">\(M = N_M^\top N_M\)</span> with <span class="math inline">\(N_M = S_{M} U_{M}^\top\)</span> and <span class="math inline">\(S_{M} = D_{M}^{1/2}\)</span>. Likewise, matrix (generalized) inverses take the form <span class="math inline">\(M^{-1} = U_{M} S_{M}^{-1} U_{M}^\top\)</span>.</p>
<p>The idea here is that we can combine these SVD identities to derive square-root relationship between the SVD of <span class="math inline">\(C_t^{-1}\)</span> and the SVDs of <span class="math inline">\(C_{t-1}\)</span>, <span class="math inline">\(W_t\)</span>, <span class="math inline">\(V_t\)</span>, and <span class="math inline">\(R_t\)</span>, then we can easily invert <span class="math inline">\(C_t^{-1}\)</span> to arrive at the desired numerically stable SVD of <span class="math inline">\(C_t\)</span>.</p>
<p>First, note that <span class="math inline">\(N_{R_t}^\top N_{R_t} = G_t C_{t-1} G_t^\top + W_t = R_t\)</span> for</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    N_{R_t} &amp;=
      \begin{pmatrix}
        S_{C_{t-1}} U_{C_{t-1}}^\top G_t^\top
        \\
        N_{W_t}
      \end{pmatrix}
  \end{aligned}
  .
  \label{eq:N_R_t}
\end{equation}\]</span></p>
<p>From this, we know that the SVD of <span class="math inline">\(R_t\)</span> can be easily derived from the SVD of its square root, <span class="math inline">\(N_{R_t}\)</span>, i.e. <span class="math inline">\(U_{R_t} = V_{N_{R_t}}\)</span> and <span class="math inline">\(S_{R_t} = D_{N_{R_t}}\)</span>. In other words, we can obtain a matrix’s SVD by computing the SVD of its “half”, which is itself entirely comprised of previous SVD components. The inherent symmetry of our covariance matrices is nicely preserved because we’re only ever using and computing one “half” of these matrices.</p>
<p>With the updated SVD of <span class="math inline">\(R_t\)</span>, we can use the identity <span class="math inline">\(C_t^{-1} = F_t V_t^{-1} F_t^\top + R_t^{-1}\)</span>–obtained via the classic <a href="https://en.wikipedia.org/wiki/Woodbury_matrix_identity">Sherman-Morrison-Woodbury matrix inverse identity</a>–to employ the same technique as before and produce the SVD of <span class="math inline">\(C_t^{-1}\)</span> by way of the SVD of yet another block square-root matrix,</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    N_{C_t^{-1}} &amp;=
      \begin{pmatrix}
        N_{V_t^{-1}} F_t^\top U_{R_t}
        \\
        S_{R_t}^{-1}
      \end{pmatrix}
  \end{aligned}
  .
  \label{eq:N_C_t_inv}
\end{equation}\]</span></p>
<p>Again, we compute the SVD of <span class="math inline">\(N_{C_t^{-1}}\)</span> at this step and obtain <span class="math inline">\(V_{N_{C_t^{-1}}}\)</span> and <span class="math inline">\(D_{N_{C_t^{-1}}}\)</span>.</p>
<p>This time, the block square-root matrix relationship isn’t so direct, and we have to multiply by <span class="math inline">\(U_{R_t}\)</span>: <span class="math inline">\(U_{R_t} N_{C_t^{-1}}^\top N_{C_t^{-1}} U_{R_t}^\top = C_t^{-1}\)</span>. However, since the additional <span class="math inline">\(U_{R_t}\)</span> terms are orthogonal, we are able to derive the SVD of <span class="math inline">\(C_t\)</span> as <span class="math inline">\(U_{C_t} = U_{R_t} V_{N_{C_t^{-1}}}\)</span> and <span class="math inline">\(S_{C_t} = D_{N_{C_t^{-1}}}^{-1}\)</span>.</p>
<p>These quantities are computed in Listing <a href="#org224c0e5">6</a>.</p>
<figure id="org224c0e5">
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="im">from</span> theano.tensor.nlinalg <span class="im">import</span> svd</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">y_tt <span class="op">=</span> tt.specify_shape(tt.col(), [N_obs_tt, <span class="dv">1</span>])</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">y_tt.name <span class="op">=</span> <span class="st">&#39;y_t&#39;</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="kw">def</span> filtering_step(y_t, m_tm1, U_C_tm1, S_C_tm1, F_t, G_t, N_W_t, N_V_t_inv):</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    <span class="co">&quot;&quot;&quot;Compute the sequential posterior state and prior predictive parameters.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">    <span class="co"># R_t = N_R.T.dot(N_R)</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12">    N_R <span class="op">=</span> tt.join(<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">                  matrix_dot(S_C_tm1, U_C_tm1.T, G_t.T),</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">                  N_W_t)</a>
<a class="sourceLine" id="cb6-15" data-line-number="15">    <span class="co"># </span><span class="al">TODO</span><span class="co">: All this could be much more efficient if we only computed *one* set of singular</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16">    <span class="co"># vectors for these non-square matrices.</span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17">    _, d_N_R_t, V_N_R_t_T <span class="op">=</span> svd(N_R)</a>
<a class="sourceLine" id="cb6-18" data-line-number="18"></a>
<a class="sourceLine" id="cb6-19" data-line-number="19">    U_R_t <span class="op">=</span> V_N_R_t_T.T</a>
<a class="sourceLine" id="cb6-20" data-line-number="20">    S_R_t <span class="op">=</span> tt.diag(d_N_R_t)</a>
<a class="sourceLine" id="cb6-21" data-line-number="21">    S_R_t_inv <span class="op">=</span> tt.diag(tt_finite_inv(d_N_R_t))</a>
<a class="sourceLine" id="cb6-22" data-line-number="22"></a>
<a class="sourceLine" id="cb6-23" data-line-number="23">    N_C_t_inv <span class="op">=</span> tt.join(<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb6-24" data-line-number="24">                        matrix_dot(N_V_t_inv, F_t.T, U_R_t),</a>
<a class="sourceLine" id="cb6-25" data-line-number="25">                        S_R_t_inv)</a>
<a class="sourceLine" id="cb6-26" data-line-number="26">    _, d_N_C_t_inv, V_N_C_t_inv_T <span class="op">=</span> svd(N_C_t_inv)</a>
<a class="sourceLine" id="cb6-27" data-line-number="27"></a>
<a class="sourceLine" id="cb6-28" data-line-number="28">    U_C_t <span class="op">=</span> U_R_t.dot(V_N_C_t_inv_T.T)</a>
<a class="sourceLine" id="cb6-29" data-line-number="29">    d_C_t <span class="op">=</span> tt_finite_inv(tt.square(d_N_C_t_inv))</a>
<a class="sourceLine" id="cb6-30" data-line-number="30">    D_C_t <span class="op">=</span> tt.diag(d_C_t)</a>
<a class="sourceLine" id="cb6-31" data-line-number="31">    S_C_t <span class="op">=</span> tt.diag(tt.sqrt(d_C_t))</a>
<a class="sourceLine" id="cb6-32" data-line-number="32"></a>
<a class="sourceLine" id="cb6-33" data-line-number="33">    C_t <span class="op">=</span> matrix_dot(U_C_t, D_C_t, U_C_t.T)</a>
<a class="sourceLine" id="cb6-34" data-line-number="34"></a>
<a class="sourceLine" id="cb6-35" data-line-number="35">    a_t <span class="op">=</span> G_t.dot(m_tm1)</a>
<a class="sourceLine" id="cb6-36" data-line-number="36">    f_t <span class="op">=</span> F_t.T.dot(a_t)</a>
<a class="sourceLine" id="cb6-37" data-line-number="37">    <span class="co"># A_t = R_t @ F_t @ inv(Q_t) = C_t @ F_t @ inv(V_t)</span></a>
<a class="sourceLine" id="cb6-38" data-line-number="38">    m_t <span class="op">=</span> a_t <span class="op">+</span> matrix_dot(C_t, F_t, N_V_t_inv.T, N_V_t_inv, y_t <span class="op">-</span> f_t)</a>
<a class="sourceLine" id="cb6-39" data-line-number="39"></a>
<a class="sourceLine" id="cb6-40" data-line-number="40">    <span class="cf">return</span> [m_t, U_C_t, S_C_t, a_t, U_R_t, S_R_t]</a>
<a class="sourceLine" id="cb6-41" data-line-number="41"></a>
<a class="sourceLine" id="cb6-42" data-line-number="42"></a>
<a class="sourceLine" id="cb6-43" data-line-number="43">_, d_C_0_tt, Vt_C_0_tt <span class="op">=</span> svd(C_0_tt)</a>
<a class="sourceLine" id="cb6-44" data-line-number="44">U_C_0_tt <span class="op">=</span> Vt_C_0_tt.T</a>
<a class="sourceLine" id="cb6-45" data-line-number="45">S_C_0_tt <span class="op">=</span> tt.diag(tt.sqrt(d_C_0_tt))</a>
<a class="sourceLine" id="cb6-46" data-line-number="46"></a>
<a class="sourceLine" id="cb6-47" data-line-number="47">_, d_W_tt, Vt_W_tt <span class="op">=</span> svd(W_tt)</a>
<a class="sourceLine" id="cb6-48" data-line-number="48">U_W_tt <span class="op">=</span> Vt_W_tt.T</a>
<a class="sourceLine" id="cb6-49" data-line-number="49">s_W_tt <span class="op">=</span> tt.sqrt(d_W_tt)</a>
<a class="sourceLine" id="cb6-50" data-line-number="50">N_W_tt <span class="op">=</span> tt.diag(s_W_tt).dot(U_W_tt.T)</a>
<a class="sourceLine" id="cb6-51" data-line-number="51"></a>
<a class="sourceLine" id="cb6-52" data-line-number="52">_, D_V_tt, Vt_V_tt <span class="op">=</span> svd(tt.as_tensor_variable(V_tt, ndim<span class="op">=</span><span class="dv">2</span>) <span class="cf">if</span> V_tt.ndim <span class="op">&lt;</span> <span class="dv">2</span> <span class="cf">else</span> V_tt)</a>
<a class="sourceLine" id="cb6-53" data-line-number="53">U_V_tt <span class="op">=</span> Vt_V_tt.T</a>
<a class="sourceLine" id="cb6-54" data-line-number="54">S_V_inv_tt <span class="op">=</span> tt.diag(tt.sqrt(tt_finite_inv(D_V_tt, eps_truncate<span class="op">=</span><span class="va">True</span>)))</a>
<a class="sourceLine" id="cb6-55" data-line-number="55">N_V_inv_tt <span class="op">=</span> S_V_inv_tt.dot(U_V_tt.T)</a>
<a class="sourceLine" id="cb6-56" data-line-number="56"></a>
<a class="sourceLine" id="cb6-57" data-line-number="57"></a>
<a class="sourceLine" id="cb6-58" data-line-number="58">filter_res, filter_updates <span class="op">=</span> theano.scan(fn<span class="op">=</span>filtering_step,</a>
<a class="sourceLine" id="cb6-59" data-line-number="59">                                         sequences<span class="op">=</span>y_tt,</a>
<a class="sourceLine" id="cb6-60" data-line-number="60">                                         outputs_info<span class="op">=</span>[</a>
<a class="sourceLine" id="cb6-61" data-line-number="61">                                             {<span class="st">&quot;initial&quot;</span>: m_0_tt, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb6-62" data-line-number="62">                                             {<span class="st">&quot;initial&quot;</span>: U_C_0_tt, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb6-63" data-line-number="63">                                             {<span class="st">&quot;initial&quot;</span>: S_C_0_tt, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb6-64" data-line-number="64">                                             {}, {}, {}, <span class="co"># a_t, U_R_t, S_R_t</span></a>
<a class="sourceLine" id="cb6-65" data-line-number="65">                                         ],</a>
<a class="sourceLine" id="cb6-66" data-line-number="66">                                         non_sequences<span class="op">=</span>[F_tt, G_tt, N_W_tt, N_V_inv_tt],</a>
<a class="sourceLine" id="cb6-67" data-line-number="67">                                         strict<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb6-68" data-line-number="68">                                         name<span class="op">=</span><span class="st">&#39;theta_filtered&#39;</span>)</a>
<a class="sourceLine" id="cb6-69" data-line-number="69"></a>
<a class="sourceLine" id="cb6-70" data-line-number="70">(m_t, U_C_t, S_C_t, a_t, U_R_t, S_R_t) <span class="op">=</span> filter_res</a></code></pre></div>
<figcaption>
Listing 6
</figcaption>
</figure>
<p><a id="org350fa8d"></a></p>
</section>
<section id="svd-based-smoothing" class="level2">
<h2>SVD-based Smoothing</h2>
<p>We can use the ideas to produce SVD versions of the smoothing equations in <span class="math inline">\(\eqref{eq:dlm-smooth-moments}\)</span>. In this case, some extra steps are required in order to SVD-decompose <span class="math inline">\(S_t\)</span> in the same manner as <span class="math inline">\(R_t\)</span> and <span class="math inline">\(C_t^{-1}\)</span> were.</p>
<p>First, notice that our target, <span class="math inline">\(S_t\)</span>, is a difference of matrices, unlike the matrix sums that comprised <span class="math inline">\(R_t\)</span> and <span class="math inline">\(C_t^{-1}\)</span> above. Furthermore, <span class="math inline">\(S_t\)</span> is given as a difference of a (transformed) difference. To address the latter, we start by expanding <span class="math inline">\(S_t\)</span> and setting <span class="math inline">\(B_t = C_t G_{t+1}^\top R_{t+1}^{-1}\)</span> to obtain</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    S_t &amp;= C_t - B_t R_{t+1} B_t^\top + B_t S_{t+1} B_t^\top
      \\
      &amp;= H_t + B_t S_{t+1} B_t^\top
  \end{aligned}
  \label{eq:S_t_decomp}
\end{equation}\]</span></p>
<p>Having turned <span class="math inline">\(S_t\)</span> into a sum of two terms, we can now consider another blocked SVD-based square-root reformulation, which starts with the reformulation of <span class="math inline">\(H_t\)</span>.</p>
<p>We can use the definition of <span class="math inline">\(R_t = G_{t+1} C_t G_{t+1}^\top + W_{t+1}\)</span> to get</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    H_t &amp;= C_t - B_t R_{t+1} B_t^\top
    \\
    &amp;= C_t - C_t G_{t+1}^\top R_{t+1}^{-1} G_{t+1} C_t
    \\
    &amp;= C_t - C_t G_{t+1}^\top \left(G_{t+1} C_t G_{t+1}^\top + W_{t+1}\right)^{-1} G_{t+1} C_t
    .
  \end{aligned}
\end{equation}\]</span></p>
<p>This form of <span class="math inline">\(H_t\)</span> fits the Woodbury identity and results in <span class="math inline">\(H_t^{-1} = G_{t+1}^\top W_{t+1}^{-1} G_{t+1} + C_t^{-1}\)</span>, which is amenable to our square-root formulation.</p>
<p>Specifically, <span class="math inline">\(H_t^{-1} = U_{C_t} N_{H_t}^{-\top} N_{H_t}^{-1} U_{C_t}^\top\)</span>, where</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    N_{H_t}^{-1} &amp;=
      \begin{pmatrix}
        N_{W_{t+1}}^{-1} G_{t+1} U_{C_t}
        \\
        S_{C_t}^{-1}
      \end{pmatrix}
  \end{aligned}
  .
  \label{eq:N_H_t_inv}
\end{equation}\]</span></p>
<p>By inverting the SVD of <span class="math inline">\(N_{H_t}^{-1}\)</span> we obtain the SVD of <span class="math inline">\(H_t\)</span> as <span class="math inline">\(U_{H_t} = U_{C_t} V_{N_{H_t}^{-1}}\)</span> and <span class="math inline">\(D_{H_t} = {D_{N_{H_t}^{-1}}}^{-2} = S_{H_t}^2\)</span>.</p>
<p>Finally, using <span class="math inline">\(\eqref{eq:S_t_decomp}\)</span> and <span class="math inline">\(\eqref{eq:N_H_t_inv}\)</span> we can derive the last blocked square-root decomposition <span class="math inline">\(S_t = N_{S_t}^\top N_{S_t}\)</span>:</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    N_{S_t} &amp;=
      \begin{pmatrix}
        S_{H_t} U_{H_t}^\top
        \\
        S_{S_{t+1}} U_{S_{t+1}}^\top B_t^\top
      \end{pmatrix}
  \end{aligned}
  .
  \label{eq:N_S_t}
\end{equation}\]</span></p>
<p>Again, we take the SVD of <span class="math inline">\(N_{S_t}\)</span> and derive the SVD of <span class="math inline">\(S_t\)</span> as <span class="math inline">\(U_{S_t} = V_{N_{S_t}}\)</span> and <span class="math inline">\(D_{S_t} = D_{N_{S_t}}^2 = S_{S_t}^2\)</span>.</p>
<figure id="org911f8da">
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">def</span> smoother_step(m_t, U_C_t, S_C_t, a_tp1, U_R_tp1, S_R_tp1, s_tp1, U_S_tp1, S_S_tp1, G_tp1, N_W_tp1_inv):</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">    <span class="co">&quot;&quot;&quot;Smooth a series starting from the &quot;forward&quot;/sequentially computed posterior moments.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">    N_C_t <span class="op">=</span> S_C_t.dot(U_C_t.T)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">    S_R_tp1_inv <span class="op">=</span> tt_finite_inv(S_R_tp1)</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">    N_R_tp1_inv <span class="op">=</span> S_R_tp1_inv.dot(U_R_tp1.T)</a>
<a class="sourceLine" id="cb7-8" data-line-number="8"></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">    <span class="co"># B_t = C_t @ G_tp1.T @ inv(R_tp1)</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10">    B_t <span class="op">=</span> matrix_dot(N_C_t.T, N_C_t, G_tp1.T, N_R_tp1_inv.T, N_R_tp1_inv)</a>
<a class="sourceLine" id="cb7-11" data-line-number="11"></a>
<a class="sourceLine" id="cb7-12" data-line-number="12">    S_C_t_inv <span class="op">=</span> tt_finite_inv(S_C_t)</a>
<a class="sourceLine" id="cb7-13" data-line-number="13"></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">    <span class="co"># U_C_t @ N_H_t_inv.T @ N_H_t_inv @ U_C_t.T = G_tp1.T @ W_tp1_inv @ G_tp1 + C_t_inv</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15">    N_H_t_inv <span class="op">=</span> tt.join(<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">                        matrix_dot(N_W_tp1_inv, G_tp1, U_C_t),</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">                        S_C_t_inv)</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">    _, d_N_H_t_inv, V_N_H_t_T <span class="op">=</span> svd(N_H_t_inv)</a>
<a class="sourceLine" id="cb7-19" data-line-number="19"></a>
<a class="sourceLine" id="cb7-20" data-line-number="20">    <span class="co"># H_t = inv(U_C_t @ N_H_t_inv.T @ N_H_t_inv @ U_C_t.T) = C_t - B_t @ R_tp1 @ B_t.T</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21">    U_H_t <span class="op">=</span> U_C_t.dot(V_N_H_t_T.T)</a>
<a class="sourceLine" id="cb7-22" data-line-number="22">    S_H_t <span class="op">=</span> tt.diag(tt_finite_inv(d_N_H_t_inv))</a>
<a class="sourceLine" id="cb7-23" data-line-number="23"></a>
<a class="sourceLine" id="cb7-24" data-line-number="24">    <span class="co"># S_t = N_S_t.T.dot(N_S_t) = C_t - matrix_dot(B_t, R_tp1 - S_tp1, B_t.T)</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25">    N_S_t <span class="op">=</span> tt.join(<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb7-26" data-line-number="26">                     S_H_t.dot(U_H_t.T),</a>
<a class="sourceLine" id="cb7-27" data-line-number="27">                     matrix_dot(S_S_tp1, U_S_tp1.T, B_t.T))</a>
<a class="sourceLine" id="cb7-28" data-line-number="28">    _, d_N_S_t, V_N_S_t_T <span class="op">=</span> svd(N_S_t)</a>
<a class="sourceLine" id="cb7-29" data-line-number="29"></a>
<a class="sourceLine" id="cb7-30" data-line-number="30">    U_S_t <span class="op">=</span> V_N_S_t_T.T</a>
<a class="sourceLine" id="cb7-31" data-line-number="31">    S_S_t <span class="op">=</span> tt.diag(d_N_S_t)</a>
<a class="sourceLine" id="cb7-32" data-line-number="32"></a>
<a class="sourceLine" id="cb7-33" data-line-number="33">    s_t <span class="op">=</span> m_t <span class="op">+</span> B_t.dot(s_tp1 <span class="op">-</span> a_tp1)</a>
<a class="sourceLine" id="cb7-34" data-line-number="34"></a>
<a class="sourceLine" id="cb7-35" data-line-number="35">    <span class="cf">return</span> [s_t, U_S_t, S_S_t]</a>
<a class="sourceLine" id="cb7-36" data-line-number="36"></a>
<a class="sourceLine" id="cb7-37" data-line-number="37"></a>
<a class="sourceLine" id="cb7-38" data-line-number="38">N_W_inv_tt <span class="op">=</span> tt.diag(tt_finite_inv(s_W_tt, eps_truncate<span class="op">=</span><span class="va">True</span>)).dot(U_W_tt.T)</a>
<a class="sourceLine" id="cb7-39" data-line-number="39"></a>
<a class="sourceLine" id="cb7-40" data-line-number="40">m_T <span class="op">=</span> m_t[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-41" data-line-number="41">U_C_T <span class="op">=</span> U_C_t[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-42" data-line-number="42">S_C_T <span class="op">=</span> S_C_t[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-43" data-line-number="43"></a>
<a class="sourceLine" id="cb7-44" data-line-number="44"><span class="co"># These series only go from N_obs - 1 to 1</span></a>
<a class="sourceLine" id="cb7-45" data-line-number="45">smoother_res, _ <span class="op">=</span> theano.scan(fn<span class="op">=</span>smoother_step,</a>
<a class="sourceLine" id="cb7-46" data-line-number="46">                              sequences<span class="op">=</span>[</a>
<a class="sourceLine" id="cb7-47" data-line-number="47">                                  {<span class="st">&quot;input&quot;</span>: m_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-48" data-line-number="48">                                  {<span class="st">&quot;input&quot;</span>: U_C_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-49" data-line-number="49">                                  {<span class="st">&quot;input&quot;</span>: S_C_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-50" data-line-number="50">                                  {<span class="st">&quot;input&quot;</span>: a_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-51" data-line-number="51">                                  {<span class="st">&quot;input&quot;</span>: U_R_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-52" data-line-number="52">                                  {<span class="st">&quot;input&quot;</span>: S_R_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]}</a>
<a class="sourceLine" id="cb7-53" data-line-number="53">                              ],</a>
<a class="sourceLine" id="cb7-54" data-line-number="54">                              outputs_info<span class="op">=</span>[</a>
<a class="sourceLine" id="cb7-55" data-line-number="55">                                  {<span class="st">&quot;initial&quot;</span>: m_T, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-56" data-line-number="56">                                  {<span class="st">&quot;initial&quot;</span>: U_C_T, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-57" data-line-number="57">                                  {<span class="st">&quot;initial&quot;</span>: S_C_T, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-58" data-line-number="58">                              ],</a>
<a class="sourceLine" id="cb7-59" data-line-number="59">                              non_sequences<span class="op">=</span>[G_tt, N_W_inv_tt],</a>
<a class="sourceLine" id="cb7-60" data-line-number="60">                              go_backwards<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb7-61" data-line-number="61">                              strict<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb7-62" data-line-number="62">                              name<span class="op">=</span><span class="st">&#39;theta_smoothed_obs&#39;</span>)</a>
<a class="sourceLine" id="cb7-63" data-line-number="63"></a>
<a class="sourceLine" id="cb7-64" data-line-number="64">(s_t_rev, U_S_t_rev, S_S_t_rev) <span class="op">=</span> smoother_res</a>
<a class="sourceLine" id="cb7-65" data-line-number="65"></a>
<a class="sourceLine" id="cb7-66" data-line-number="66">s_t <span class="op">=</span> s_t_rev[::<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-67" data-line-number="67">U_S_t <span class="op">=</span> U_S_t_rev[::<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-68" data-line-number="68">S_S_t <span class="op">=</span> S_S_t_rev[::<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-69" data-line-number="69"></a>
<a class="sourceLine" id="cb7-70" data-line-number="70">s_t <span class="op">=</span> tt.join(<span class="dv">0</span>, s_t, [m_T])</a>
<a class="sourceLine" id="cb7-71" data-line-number="71">U_S_t <span class="op">=</span> tt.join(<span class="dv">0</span>, U_S_t, [U_C_T])</a>
<a class="sourceLine" id="cb7-72" data-line-number="72">S_S_t <span class="op">=</span> tt.join(<span class="dv">0</span>, S_S_t, [S_C_T])</a></code></pre></div>
<figcaption>
Listing 7
</figcaption>
</figure>
<p><a id="org9beb158"></a></p>
</section>
<section id="example" class="level2">
<h2>Example</h2>
<p>Listing <a href="#org6c20a11">8</a> computes the filtered and smoothed means for our simulated series, and Figure <a href="#org822c0f2">9</a> shows the results.</p>
<figure id="org6c20a11">
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" data-line-number="1">filter_smooth_dlm <span class="op">=</span> tt_function([y_tt, N_theta_tt, G_tt, F_tt], [m_t, s_t])</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co"># phi_W_tt.set_value(phi_W_true)</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co"># phi_V_tt.set_value(phi_V_true)</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">phi_W_tt.set_value(np.r_[<span class="fl">100.0</span>, <span class="fl">100.0</span>])</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">phi_V_tt.set_value(<span class="fl">1.5</span>)</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">(m_t_sim, s_t_sim) <span class="op">=</span> filter_smooth_dlm(y_sim, dlm_sim_values[N_theta_tt], dlm_sim_values[G_tt], dlm_sim_values[F_tt])</a></code></pre></div>
<figcaption>
Listing 8
</figcaption>
</figure>
<figure id="org822c0f2">
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="im">from</span> cycler <span class="im">import</span> cycler</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">bivariate_cycler <span class="op">=</span> plt_orig_cycler <span class="op">*</span> cycler(<span class="st">&#39;linestyle&#39;</span>, [<span class="st">&#39;-&#39;</span>, <span class="st">&#39;--&#39;</span>])</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">plt.close(fig<span class="op">=</span><span class="st">&#39;all&#39;</span>)</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">ax.set_prop_cycle(bivariate_cycler)</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">ax.plot(theta_t_sim, label<span class="op">=</span><span class="vs">r&#39;$\theta_t$&#39;</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>, color<span class="op">=</span><span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">ax.autoscale(enable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">ax.plot(m_t_sim, label<span class="op">=</span><span class="vs">r&#39;$E[\theta_t \mid D_</span><span class="sc">{t}</span><span class="vs">]$&#39;</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">ax.plot(s_t_sim, label<span class="op">=</span><span class="vs">r&#39;$E[\theta_t \mid D_</span><span class="sc">{T}</span><span class="vs">]$&#39;</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">plt.legend(framealpha<span class="op">=</span><span class="fl">0.4</span>)</a>
<a class="sourceLine" id="cb9-13" data-line-number="13">plt.tight_layout()</a></code></pre></div>
<figcaption>
Listing 9
</figcaption>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/svd-steps-sim-plot.png" alt="Filtered and smoothed \theta_t–against the true \theta_t–computed using the SVD approach. " />
<figcaption>
Filtered and smoothed <span class="math inline">\(\theta_t\)</span>–against the true <span class="math inline">\(\theta_t\)</span>–computed using the SVD approach.
</figcaption>
</figure>
<p><a id="orgaa30fc5"></a></p>
</section>
</section>
<section id="forward-filtering-backward-sampling" class="level1">
<h1>Forward-filtering Backward-sampling</h1>
<p>We can use the smoothing and filtering steps in the previous section to perform more efficient MCMC estimation than would otherwise be possible without the Rao-Blackwellization inherent to both steps.</p>
<p>Forward-filtering backward-sampling <a id="66fb99775f308e808a193bd7bb2d2038"><a href="#Fruhwirth-SchnatterDataaugmentationdynamic1994">(Fr-Schnatter 1994)</a></a> works by first computing the forward filtered moments, allowing one to draw <span class="math inline">\(\theta_T\)</span> from <span class="math inline">\(\left(\theta_T \mid D_T\right) \sim \operatorname{N}\left(m_T, C_T\right)\)</span> and, subsequently, <span class="math inline">\(\theta_t\)</span> from <span class="math inline">\(\left(\theta_t \mid \theta_{t+1}, D_T \right) \sim \operatorname{N}\left(h_t, H_t\right)\)</span>.</p>
<p>The latter distribution’s moments are easily derived from the filtered and smoothed moments:</p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    h_t = m_t + B_t \left(\theta_{t+1} - a_{t+1}\right)
    \\
    H_t = C_t - B_t R_{t+1} B^\top_t
  \end{gathered}
  \label{eq:ffbs-moments}
\end{equation}\]</span></p>
<p>Since all the quantities in <span class="math inline">\(\eqref{eq:ffbs-moments}\)</span> appear in the filtering and smoothing moments, we can use the SVD-based approach described earlier to perform the updates and sampling. We reproduce the relevant subset of calculations in Listing <a href="#org6d942a3">10</a>.</p>
<figure id="org6d942a3">
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">def</span> ffbs_step(m_t, U_C_t, S_C_t, a_tp1, U_R_tp1, S_R_tp1, theta_tp1, F_tp1, G_tp1, N_W_tp1_inv, rng):</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    <span class="co">&quot;&quot;&quot;Perform forward-filtering backward-sampling.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    S_C_t_inv <span class="op">=</span> tt_finite_inv(S_C_t)</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">    <span class="co"># H_t_inv = U_C_t @ N_H_t_inv.T @ N_H_t_inv @ U_C_t.T = G_tp1^T @ W_tp1_inv @ G_tp1.T + C_t_inv</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">    N_H_t_inv <span class="op">=</span> tt.join(<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">                        matrix_dot(N_W_tp1_inv, G_tp1, U_C_t),</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">                        S_C_t_inv)</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">    _, d_N_H_t_inv, V_N_H_t_inv_T <span class="op">=</span> svd(N_H_t_inv)</a>
<a class="sourceLine" id="cb10-11" data-line-number="11"></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">    U_H_t <span class="op">=</span> U_C_t.dot(V_N_H_t_inv_T.T)</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">    s_H_t <span class="op">=</span> tt_finite_inv(d_N_H_t_inv)</a>
<a class="sourceLine" id="cb10-14" data-line-number="14"></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">    N_C_t <span class="op">=</span> S_C_t.dot(U_C_t.T)</a>
<a class="sourceLine" id="cb10-16" data-line-number="16"></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">    S_R_tp1_inv <span class="op">=</span> tt_finite_inv(S_R_tp1)</a>
<a class="sourceLine" id="cb10-18" data-line-number="18">    N_R_tp1_inv <span class="op">=</span> S_R_tp1_inv.dot(U_R_tp1.T)</a>
<a class="sourceLine" id="cb10-19" data-line-number="19"></a>
<a class="sourceLine" id="cb10-20" data-line-number="20">    <span class="co"># B_t = C_t @ G_tp1.T @ inv(R_tp1)</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21">    <span class="co"># B_t = matrix_dot(U_H_t * s_H_t, s_H_t * U_H_t.T,</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22">    <span class="co">#                  G_tp1.T, N_W_tp1_inv.T, N_W_tp1_inv)</span></a>
<a class="sourceLine" id="cb10-23" data-line-number="23">    B_t <span class="op">=</span> matrix_dot(N_C_t.T, N_C_t, G_tp1.T, N_R_tp1_inv.T, N_R_tp1_inv)</a>
<a class="sourceLine" id="cb10-24" data-line-number="24"></a>
<a class="sourceLine" id="cb10-25" data-line-number="25">    h_t <span class="op">=</span> m_t <span class="op">+</span> B_t.dot(theta_tp1 <span class="op">-</span> a_tp1)</a>
<a class="sourceLine" id="cb10-26" data-line-number="26">    h_t.name <span class="op">=</span> <span class="st">&#39;h_t&#39;</span></a>
<a class="sourceLine" id="cb10-27" data-line-number="27"></a>
<a class="sourceLine" id="cb10-28" data-line-number="28">    <span class="co"># </span><span class="al">TODO</span><span class="co">: Add an option or optimization to use the SVD to sample in</span></a>
<a class="sourceLine" id="cb10-29" data-line-number="29">    <span class="co"># `MvNormalRV`.</span></a>
<a class="sourceLine" id="cb10-30" data-line-number="30">    <span class="co"># theta_t = MvNormalRV(h_t, H_t, rng=rng, name=&#39;theta_t_ffbs&#39;)</span></a>
<a class="sourceLine" id="cb10-31" data-line-number="31">    theta_t <span class="op">=</span> h_t <span class="op">+</span> tt.dot(U_H_t, s_H_t <span class="op">*</span></a>
<a class="sourceLine" id="cb10-32" data-line-number="32">                           MvNormalRV(tt.zeros_like(h_t),</a>
<a class="sourceLine" id="cb10-33" data-line-number="33">                                      tt.eye(h_t.shape[<span class="dv">0</span>]),</a>
<a class="sourceLine" id="cb10-34" data-line-number="34">                                      rng<span class="op">=</span>rng))</a>
<a class="sourceLine" id="cb10-35" data-line-number="35"></a>
<a class="sourceLine" id="cb10-36" data-line-number="36">    <span class="co"># These are statistics we&#39;re gathering for other posterior updates</span></a>
<a class="sourceLine" id="cb10-37" data-line-number="37">    theta_tp1_diff <span class="op">=</span> theta_tp1 <span class="op">-</span> G_tp1.dot(theta_t)</a>
<a class="sourceLine" id="cb10-38" data-line-number="38">    f_tp1 <span class="op">=</span> F_tp1.T.dot(theta_t)</a>
<a class="sourceLine" id="cb10-39" data-line-number="39"></a>
<a class="sourceLine" id="cb10-40" data-line-number="40">    <span class="co"># Sequentially sample/update quantities conditional on `theta_t` here...</span></a>
<a class="sourceLine" id="cb10-41" data-line-number="41"></a>
<a class="sourceLine" id="cb10-42" data-line-number="42">    <span class="cf">return</span> [theta_t, theta_tp1_diff, f_tp1]</a>
<a class="sourceLine" id="cb10-43" data-line-number="43"></a>
<a class="sourceLine" id="cb10-44" data-line-number="44"></a>
<a class="sourceLine" id="cb10-45" data-line-number="45"><span class="co"># C_T = matrix_dot(U_C_T, tt.square(S_C_T), U_C_T.T)</span></a>
<a class="sourceLine" id="cb10-46" data-line-number="46"><span class="co"># theta_T_post = MvNormalRV(m_T, C_T, rng=rng_tt)</span></a>
<a class="sourceLine" id="cb10-47" data-line-number="47">theta_T_post <span class="op">=</span> m_T <span class="op">+</span> matrix_dot(U_C_T, S_C_T,</a>
<a class="sourceLine" id="cb10-48" data-line-number="48">                                MvNormalRV(tt.zeros_like(m_T),</a>
<a class="sourceLine" id="cb10-49" data-line-number="49">                                           tt.eye(m_T.shape[<span class="dv">0</span>]),</a>
<a class="sourceLine" id="cb10-50" data-line-number="50">                                           rng<span class="op">=</span>rng_tt))</a>
<a class="sourceLine" id="cb10-51" data-line-number="51">theta_T_post.name <span class="op">=</span> <span class="st">&quot;theta_T_post&quot;</span></a>
<a class="sourceLine" id="cb10-52" data-line-number="52"></a>
<a class="sourceLine" id="cb10-53" data-line-number="53"></a>
<a class="sourceLine" id="cb10-54" data-line-number="54">ffbs_output, ffbs_updates <span class="op">=</span> theano.scan(fn<span class="op">=</span>ffbs_step,</a>
<a class="sourceLine" id="cb10-55" data-line-number="55">                                        sequences<span class="op">=</span>[</a>
<a class="sourceLine" id="cb10-56" data-line-number="56">                                            {<span class="st">&quot;input&quot;</span>: m_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb10-57" data-line-number="57">                                            {<span class="st">&quot;input&quot;</span>: U_C_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb10-58" data-line-number="58">                                            {<span class="st">&quot;input&quot;</span>: S_C_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb10-59" data-line-number="59">                                            {<span class="st">&quot;input&quot;</span>: a_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb10-60" data-line-number="60">                                            {<span class="st">&quot;input&quot;</span>: U_R_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb10-61" data-line-number="61">                                            {<span class="st">&quot;input&quot;</span>: S_R_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]}</a>
<a class="sourceLine" id="cb10-62" data-line-number="62">                                        ],</a>
<a class="sourceLine" id="cb10-63" data-line-number="63">                                        outputs_info<span class="op">=</span>[</a>
<a class="sourceLine" id="cb10-64" data-line-number="64">                                            {<span class="st">&quot;initial&quot;</span>: theta_T_post, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb10-65" data-line-number="65">                                            {}, {}, <span class="co"># theta_tp1_diff, f_tp1</span></a>
<a class="sourceLine" id="cb10-66" data-line-number="66">                                        ],</a>
<a class="sourceLine" id="cb10-67" data-line-number="67">                                        non_sequences<span class="op">=</span>[F_tt, G_tt, N_W_inv_tt, rng_tt],</a>
<a class="sourceLine" id="cb10-68" data-line-number="68">                                        go_backwards<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb10-69" data-line-number="69">                                        strict<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb10-70" data-line-number="70">                                        name<span class="op">=</span><span class="st">&#39;ffbs_samples&#39;</span>)</a>
<a class="sourceLine" id="cb10-71" data-line-number="71"></a>
<a class="sourceLine" id="cb10-72" data-line-number="72">(theta_t_post_rev, theta_t_diff_rev, f_t_rev) <span class="op">=</span> ffbs_output</a>
<a class="sourceLine" id="cb10-73" data-line-number="73"></a>
<a class="sourceLine" id="cb10-74" data-line-number="74">theta_t_post <span class="op">=</span> tt.join(<span class="dv">0</span>, theta_t_post_rev[::<span class="op">-</span><span class="dv">1</span>], [theta_T_post])</a>
<a class="sourceLine" id="cb10-75" data-line-number="75"></a>
<a class="sourceLine" id="cb10-76" data-line-number="76"><span class="co"># We need to add the missing end-points onto these statistics...</span></a>
<a class="sourceLine" id="cb10-77" data-line-number="77">f_t_post <span class="op">=</span> tt.join(<span class="dv">0</span>, f_t_rev[::<span class="op">-</span><span class="dv">1</span>], [F_tt.T.dot(theta_T_post)])</a></code></pre></div>
<figcaption>
Listing 10
</figcaption>
</figure>
<p>Quantities besides the state values, <span class="math inline">\(\theta_t\)</span>, can be sampled sequentially (i.e. within the function <code>ffbs_step</code> in Listing <a href="#org6d942a3">10</a>), or after FFBS when all <span class="math inline">\(\theta_t \mid D_T\)</span> have been sampled. These quantities can use the conditionally Gaussian form of <span class="math inline">\(\left(\theta_t \mid \theta_{t+1}, D_T \right)\)</span> to derive Gibbs steps, further Rao-Blackwellize hierarchical quantities, or apply any other means of producing posterior samples conditional on <span class="math inline">\(\left(\theta_t \mid \theta_{t+1}, D_T \right)\)</span>.</p>
<p>In our simulation example, we will further augment our original model by adding the classic conjugate gamma priors to our previously fixed state and observation precision parameters, <span class="math inline">\(\phi_W\)</span> and <span class="math inline">\(\phi_V\)</span>, respectively:</p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    \phi_{W} \sim \operatorname{Gamma}\left( a_W, b_W \right)
    ,\quad
    \phi_{V} \sim \operatorname{Gamma}\left( a_V, b_V \right)
  \end{gathered}
  \label{eq:phi-gamma-priors}
\end{equation}\]</span></p>
<p>This classical conjugate prior allows one to derive simple closed-form posteriors for a Gibbs sampler conditional on <span class="math inline">\(y_t\)</span>, <span class="math inline">\(\theta_t\)</span>, and <span class="math inline">\(\theta_{t-1}\)</span>, as follows:</p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    \phi_{W} \mid D_T \sim
    \operatorname{Gamma}\left( a_W + \frac{N}{2}, b_W + \frac{1}{2} \sum_{t=1}^N \left( \theta_t - G_t \theta_{t-1} \right)^2 \right)
    ,\quad
    \phi_{V} \mid D_T \sim
    \operatorname{Gamma}\left( a_V + \frac{N}{2}, b_V + \frac{1}{2} \sum_{t=1}^N \left( y_t - F_t^\top \theta_t \right)^2 \right)
  \end{gathered}
  \label{eq:phi-gamma-posteriors}
\end{equation}\]</span></p>
<p>Those posterior computations are implemented in Listings <a href="#org4e5c0a0">11</a> and <a href="#org1156a41">12</a>, and they are used to update the shared Theano variables for <span class="math inline">\(\phi_W\)</span> and <span class="math inline">\(\phi_V\)</span> within a Gibbs sampling loop in Listing <a href="#org005b0cb">13</a>.</p>
<p><a id="org231ac83"></a></p>
<section id="simulation-example" class="level2">
<h2>Simulation Example</h2>
<figure id="org4e5c0a0">
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb11-1" data-line-number="1">phi_W_a, phi_W_b <span class="op">=</span> theano.shared(np.r_[<span class="fl">2.5</span>, <span class="fl">2.5</span>]), theano.shared(np.r_[<span class="fl">0.5</span>, <span class="fl">0.5</span>])</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">phi_W_a_post_tt <span class="op">=</span> phi_W_a <span class="op">+</span> N_obs_tt <span class="op">*</span> <span class="fl">0.5</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">phi_W_SS_tt <span class="op">=</span> tt.square(theta_t_diff_rev).<span class="bu">sum</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">phi_W_b_post_tt <span class="op">=</span> phi_W_b <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> phi_W_SS_tt</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">phi_W_post_tt <span class="op">=</span> GammaRV(phi_W_a_post_tt, phi_W_b_post_tt, rng<span class="op">=</span>rng_tt, name<span class="op">=</span><span class="st">&#39;phi_W_post&#39;</span>)</a></code></pre></div>
<figcaption>
Listing 11
</figcaption>
</figure>
<figure id="org1156a41">
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb12-1" data-line-number="1">phi_V_a, phi_V_b <span class="op">=</span> theano.shared(<span class="fl">0.125</span>), theano.shared(<span class="fl">0.25</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"></a>
<a class="sourceLine" id="cb12-3" data-line-number="3">phi_V_a_post_tt <span class="op">=</span> phi_V_a <span class="op">+</span> N_obs_tt <span class="op">*</span> <span class="fl">0.5</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">phi_V_SS_tt <span class="op">=</span> tt.square(y_tt <span class="op">-</span> f_t_post).<span class="bu">sum</span>()</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">phi_V_b_post_tt <span class="op">=</span> phi_V_b <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> phi_V_SS_tt</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">phi_V_post_tt <span class="op">=</span> GammaRV(phi_V_a_post_tt, phi_V_b_post_tt, rng<span class="op">=</span>rng_tt, name<span class="op">=</span><span class="st">&#39;phi_V_post&#39;</span>)</a></code></pre></div>
<figcaption>
Listing 12
</figcaption>
</figure>
<figure id="org005b0cb">
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb13-1" data-line-number="1">ffbs_dlm <span class="op">=</span> tt_function([y_tt, N_obs_tt, N_theta_tt, G_tt, F_tt],</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">                       [theta_t_post, phi_W_post_tt, phi_V_post_tt,</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">                        phi_W_SS_tt, phi_V_SS_tt],</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">                       updates<span class="op">=</span>ffbs_updates)</a>
<a class="sourceLine" id="cb13-5" data-line-number="5"></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">rng_tt.get_value(borrow<span class="op">=</span><span class="va">True</span>).set_state(rng_sim_state)</a>
<a class="sourceLine" id="cb13-7" data-line-number="7"></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">phi_W_0 <span class="op">=</span> phi_W_a.get_value()<span class="op">/</span>phi_W_b.get_value()</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">phi_V_0 <span class="op">=</span> phi_V_a.get_value()<span class="op">/</span>phi_V_b.get_value()</a>
<a class="sourceLine" id="cb13-10" data-line-number="10"></a>
<a class="sourceLine" id="cb13-11" data-line-number="11">phi_W_tt.set_value(phi_W_0)</a>
<a class="sourceLine" id="cb13-12" data-line-number="12">phi_V_tt.set_value(phi_V_0)</a>
<a class="sourceLine" id="cb13-13" data-line-number="13"></a>
<a class="sourceLine" id="cb13-14" data-line-number="14">chain <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15">theta_label <span class="op">=</span> <span class="vs">r&#39;$\theta_t \mid D_T$&#39;</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16">phi_W_label <span class="op">=</span> <span class="vs">r&#39;$\phi_W \mid D_T$&#39;</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17">phi_V_label <span class="op">=</span> <span class="vs">r&#39;$\phi_V \mid D_T$&#39;</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18">theta_t_post_sim, phi_W_post_sim, phi_V_post_sim <span class="op">=</span> <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19">posterior_samples <span class="op">=</span> {theta_label: [[]], phi_W_label: [[]], phi_V_label: [[]]}</a>
<a class="sourceLine" id="cb13-20" data-line-number="20"></a>
<a class="sourceLine" id="cb13-21" data-line-number="21"><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>):</a>
<a class="sourceLine" id="cb13-22" data-line-number="22"></a>
<a class="sourceLine" id="cb13-23" data-line-number="23">    theta_t_post_sim, phi_W_post_sim, phi_V_post_sim, phi_W_SS_sim, phi_V_SS_sim <span class="op">=</span> ffbs_dlm(</a>
<a class="sourceLine" id="cb13-24" data-line-number="24">        y_sim,</a>
<a class="sourceLine" id="cb13-25" data-line-number="25">        dlm_sim_values[N_obs_tt], dlm_sim_values[N_theta_tt],</a>
<a class="sourceLine" id="cb13-26" data-line-number="26">        dlm_sim_values[G_tt], dlm_sim_values[F_tt])</a>
<a class="sourceLine" id="cb13-27" data-line-number="27"></a>
<a class="sourceLine" id="cb13-28" data-line-number="28">    <span class="co"># Update variance precision parameters</span></a>
<a class="sourceLine" id="cb13-29" data-line-number="29">    phi_W_tt.set_value(phi_W_post_sim)</a>
<a class="sourceLine" id="cb13-30" data-line-number="30">    phi_V_tt.set_value(phi_V_post_sim)</a>
<a class="sourceLine" id="cb13-31" data-line-number="31"></a>
<a class="sourceLine" id="cb13-32" data-line-number="32">    posterior_samples[theta_label][chain].append(theta_t_post_sim)</a>
<a class="sourceLine" id="cb13-33" data-line-number="33">    posterior_samples[phi_W_label][chain].append(phi_W_post_sim)</a>
<a class="sourceLine" id="cb13-34" data-line-number="34">    posterior_samples[phi_V_label][chain].append(phi_V_post_sim)</a>
<a class="sourceLine" id="cb13-35" data-line-number="35"></a>
<a class="sourceLine" id="cb13-36" data-line-number="36">    <span class="bu">print</span>(<span class="ss">f&#39;i=</span><span class="sc">{i}</span><span class="ss">,</span><span class="ch">\t</span><span class="ss">phi_W=</span><span class="sc">{</span>phi_W_post_sim<span class="sc">}</span><span class="ch">\t</span><span class="ss">(</span><span class="sc">{</span>phi_W_SS_sim<span class="sc">}</span><span class="ss">),</span><span class="ch">\t</span><span class="ss">phi_V=</span><span class="sc">{</span>phi_V_post_sim<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>phi_V_SS_sim<span class="sc">}</span><span class="ss">)&#39;</span>)</a>
<a class="sourceLine" id="cb13-37" data-line-number="37"></a>
<a class="sourceLine" id="cb13-38" data-line-number="38">posterior_samples <span class="op">=</span> {k: np.asarray(v) <span class="cf">for</span> k,v <span class="kw">in</span> posterior_samples.items()}</a></code></pre></div>
<figcaption>
Listing 13
</figcaption>
</figure>
<p>Figure <a href="#org010a945">14</a> shows the posterior <span class="math inline">\(\theta_t\)</span> samples and Figure <a href="#org968df9e">15</a> plots the posterior sample traces.</p>
<figure id="org010a945">
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb14-1" data-line-number="1">plt.clf()</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">ax.autoscale(enable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb14-5" data-line-number="5"></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="co"># bivariate_cycler =  cycler(&#39;linestyle&#39;, [&#39;-&#39;, &#39;--&#39;]) * plt_orig_cycler</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="co"># ax.set_prop_cycle(bivariate_cycler)</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"></a>
<a class="sourceLine" id="cb14-9" data-line-number="9">thetas_shape <span class="op">=</span> posterior_samples[theta_label][<span class="dv">0</span>].shape</a>
<a class="sourceLine" id="cb14-10" data-line-number="10"></a>
<a class="sourceLine" id="cb14-11" data-line-number="11">cycle <span class="op">=</span> ax._get_lines.prop_cycler</a>
<a class="sourceLine" id="cb14-12" data-line-number="12"></a>
<a class="sourceLine" id="cb14-13" data-line-number="13">bivariate_obs_cycler <span class="op">=</span>  cycler(<span class="st">&#39;linestyle&#39;</span>, [<span class="st">&#39;-&#39;</span>, <span class="st">&#39;--&#39;</span>]) <span class="op">*</span> cycler(<span class="st">&#39;color&#39;</span>, [<span class="st">&#39;black&#39;</span>])</a>
<a class="sourceLine" id="cb14-14" data-line-number="14"></a>
<a class="sourceLine" id="cb14-15" data-line-number="15">ax.set_prop_cycle(bivariate_obs_cycler)</a>
<a class="sourceLine" id="cb14-16" data-line-number="16">ax.plot(theta_t_sim, label<span class="op">=</span><span class="vs">r&#39;$\theta_t$&#39;</span>, linewidth<span class="op">=</span><span class="fl">1.0</span>)</a>
<a class="sourceLine" id="cb14-17" data-line-number="17"></a>
<a class="sourceLine" id="cb14-18" data-line-number="18">ax.autoscale(enable<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb14-19" data-line-number="19">ax.autoscale(enable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb14-20" data-line-number="20"></a>
<a class="sourceLine" id="cb14-21" data-line-number="21"><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(thetas_shape[<span class="op">-</span><span class="dv">1</span>]):</a>
<a class="sourceLine" id="cb14-22" data-line-number="22"></a>
<a class="sourceLine" id="cb14-23" data-line-number="23">    styles <span class="op">=</span> <span class="bu">next</span>(cycle)</a>
<a class="sourceLine" id="cb14-24" data-line-number="24">    thetas <span class="op">=</span> posterior_samples[theta_label][<span class="dv">0</span>].T[d].T</a>
<a class="sourceLine" id="cb14-25" data-line-number="25"></a>
<a class="sourceLine" id="cb14-26" data-line-number="26">    theta_lines <span class="op">=</span> np.empty(thetas_shape[:<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> (<span class="dv">2</span>,))</a>
<a class="sourceLine" id="cb14-27" data-line-number="27">    theta_lines.T[<span class="dv">0</span>] <span class="op">=</span> np.tile(np.arange(thetas_shape[<span class="op">-</span><span class="dv">2</span>]), [thetas_shape[<span class="op">-</span><span class="dv">3</span>], <span class="dv">1</span>]).T</a>
<a class="sourceLine" id="cb14-28" data-line-number="28">    theta_lines.T[<span class="dv">1</span>] <span class="op">=</span> thetas.T</a>
<a class="sourceLine" id="cb14-29" data-line-number="29"></a>
<a class="sourceLine" id="cb14-30" data-line-number="30">    ax.add_collection(</a>
<a class="sourceLine" id="cb14-31" data-line-number="31">        LineCollection(theta_lines,</a>
<a class="sourceLine" id="cb14-32" data-line-number="32">                       label<span class="op">=</span>theta_label,</a>
<a class="sourceLine" id="cb14-33" data-line-number="33">                       alpha<span class="op">=</span><span class="fl">0.3</span>, linewidth<span class="op">=</span><span class="fl">0.9</span>,</a>
<a class="sourceLine" id="cb14-34" data-line-number="34">                       <span class="op">**</span>styles)</a>
<a class="sourceLine" id="cb14-35" data-line-number="35">    )</a>
<a class="sourceLine" id="cb14-36" data-line-number="36"></a>
<a class="sourceLine" id="cb14-37" data-line-number="37">plt.tight_layout()</a>
<a class="sourceLine" id="cb14-38" data-line-number="38"></a>
<a class="sourceLine" id="cb14-39" data-line-number="39">plt.legend(framealpha<span class="op">=</span><span class="fl">0.4</span>)</a></code></pre></div>
<figcaption>
Listing 14
</figcaption>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/ffbs-sim-theta-plot.png" alt="Posterior \theta_t samples generated by a FFBS-based Gibbs sampler. " />
<figcaption>
Posterior <span class="math inline">\(\theta_t\)</span> samples generated by a FFBS-based Gibbs sampler.
</figcaption>
</figure>
<figure id="org968df9e">
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="im">import</span> arviz <span class="im">as</span> az</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"></a>
<a class="sourceLine" id="cb15-3" data-line-number="3">az_trace <span class="op">=</span> az.from_dict(posterior<span class="op">=</span>posterior_samples)</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">az.plot_trace(az_trace, compact<span class="op">=</span><span class="va">True</span>)</a></code></pre></div>
<figcaption>
Listing 15
</figcaption>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/ffbs-sim-trace-plot.png" alt="Posterior sample traces for the FFBS-based Gibbs sampler. " />
<figcaption>
Posterior sample traces for the FFBS-based Gibbs sampler.
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb16-1" data-line-number="1">plt.close(<span class="st">&#39;all&#39;</span>)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"></a>
<a class="sourceLine" id="cb16-3" data-line-number="3">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb16-4" data-line-number="4"></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">ax.plot(y_sim, label<span class="op">=</span><span class="vs">r&#39;$y_t$&#39;</span>, linewidth<span class="op">=</span><span class="fl">1.0</span>, color<span class="op">=</span><span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb16-6" data-line-number="6"></a>
<a class="sourceLine" id="cb16-7" data-line-number="7">ax.autoscale(enable<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">ax.autoscale(enable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb16-9" data-line-number="9"></a>
<a class="sourceLine" id="cb16-10" data-line-number="10">f_t_ordinates <span class="op">=</span> np.dot(posterior_samples[theta_label][<span class="dv">0</span>], dlm_sim_values[F_tt].squeeze())</a>
<a class="sourceLine" id="cb16-11" data-line-number="11"></a>
<a class="sourceLine" id="cb16-12" data-line-number="12">f_t_lines <span class="op">=</span> np.empty(f_t_ordinates.shape <span class="op">+</span> (<span class="dv">2</span>,))</a>
<a class="sourceLine" id="cb16-13" data-line-number="13">f_t_lines.T[<span class="dv">0</span>] <span class="op">=</span> np.tile(np.arange(f_t_ordinates.shape[<span class="dv">1</span>]), [f_t_ordinates.shape[<span class="dv">0</span>], <span class="dv">1</span>]).T</a>
<a class="sourceLine" id="cb16-14" data-line-number="14">f_t_lines.T[<span class="dv">1</span>] <span class="op">=</span> f_t_ordinates.T</a>
<a class="sourceLine" id="cb16-15" data-line-number="15"></a>
<a class="sourceLine" id="cb16-16" data-line-number="16">ax.add_collection(</a>
<a class="sourceLine" id="cb16-17" data-line-number="17">    LineCollection(f_t_lines,</a>
<a class="sourceLine" id="cb16-18" data-line-number="18">                   label<span class="op">=</span><span class="vs">r&#39;$E[y_t \mid \theta_t, D_T]$&#39;</span>,</a>
<a class="sourceLine" id="cb16-19" data-line-number="19">                   alpha<span class="op">=</span><span class="fl">0.3</span>, linewidth<span class="op">=</span><span class="fl">0.9</span>, color<span class="op">=</span><span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb16-20" data-line-number="20">)</a>
<a class="sourceLine" id="cb16-21" data-line-number="21"></a>
<a class="sourceLine" id="cb16-22" data-line-number="22">plt.tight_layout()</a>
<a class="sourceLine" id="cb16-23" data-line-number="23"></a>
<a class="sourceLine" id="cb16-24" data-line-number="24">plt.legend(framealpha<span class="op">=</span><span class="fl">0.4</span>)</a></code></pre></div>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/ffbs-sim-pred-plot.png" alt="Posterior predicive sample means generated by a FFBS-based Gibbs sampler. " />
<figcaption>
Posterior predicive sample means generated by a FFBS-based Gibbs sampler.
</figcaption>
</figure>
<p><a id="orge6290b1"></a></p>
</section>
</section>
<section id="non-gaussian-extension" class="level1">
<h1>Non-Gaussian Extension</h1>
<p>Let’s say we want to model count observations that are driven by a smooth time-varying process. We can assume a negative-binomial observation model with a log-link function–in standard GLM fashion <a id="820d466dbb5494bd5a5cb080d0b82638"><a href="#mccullagh_generalized_1989">(McCullagh &amp; Nelder 1989)</a></a>–and connect it to the same state and observation dynamics as the basic DLM in <span class="math inline">\(\eqref{eq:basic-dlm-state}\)</span> via its mean <span class="math inline">\(\mu_t = \exp\left(\eta_t\right)\)</span>:</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    Y_t &amp;\sim \operatorname{NB}\left(r, p_t\right)
    \\
    E[Y_t \mid \theta_t] &amp;= \mu_t = \exp\left( F_t^\top \theta_t \right)
    \\
    \theta_t &amp;= G_t \theta_{t-1} + \nu_t, \quad \nu_t \sim \operatorname{N}\left( 0, W \right)
  \end{aligned}
\label{eq:nb-dlm}
\end{equation}\]</span></p>
<p>Under the parameterization <span class="math inline">\(p_t = \frac{\mu_t}{\mu_t + r}\)</span>, the negative-binomial density function takes the following form:</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    \operatorname{p}\left(Y_t = y_t \mid r, p_t\right) &amp;=
    \frac{\Gamma\left( y_t + r \right)}{y_t!\,\Gamma(r)}
    \left( 1 - p_t \right)^r \left( p_t \right)^{y_t}
    \\
    &amp;=
    \frac{\Gamma\left( y_t + r \right)}{y_t!\,\Gamma(r)}
    \left( \frac{r}{r + \mu_t} \right)^r \left( \frac{\mu_t}{r + \mu_t} \right)^{y_t}
    \\
    &amp;=
    \frac{\Gamma\left( y_t + r \right)}{y_t!\,\Gamma(r)}
    \frac{\left( \mu_t / r \right)^{y_t}}{\left( 1 + \mu_t / r \right)^{r + y_t}}
    \\
    &amp;=
    \frac{\Gamma\left( y_t + r \right)}{y_t!\,\Gamma(r)}
    \frac{\left( e^{\eta_t - \log r} \right)^{y_t}}{\left( 1 + e^{\eta_t - \log r} \right)^{r + y_t}}
    .
  \end{aligned}
\label{eq:nb-pmf}
\end{equation}\]</span></p>
<p>The logit-inverse form in <span class="math inline">\(\eqref{eq:nb-pmf}\)</span> has a Gaussian scale-mixture representation in the Pólya-Gamma distribution <a id="2776c69c558410bc65a3a0a0f1ff5bf4"><a href="#polson_bayesian_2013">(Polson, Scott &amp; Windle 2013)</a></a>. Said scale-mixture is as follows:</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    \frac{e^{\psi a}}{\left(1 + e^{\psi}\right)^b} &amp;=
    2^{-b} e^{\kappa \psi} \int^{\infty}_{0} e^{-\frac{\omega}{2} \psi^2} \operatorname{p}(\omega) d\omega
    \\
    &amp;=
    2^{-b} \int^{\infty}_{0} e^{-\frac{\omega}{2} \left( \psi - \frac{\kappa}{\omega} \right)^2}
      e^{\frac{\kappa^2}{2 \omega} } \operatorname{p}(\omega) d\omega
    .
  \end{aligned}
\label{eq:pg-identity}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\kappa = a - b / 2\)</span> and <span class="math inline">\(\omega_t \sim \operatorname{PG}\left(b, 0\right)\)</span>.</p>
<p>When the Gaussian scale-mixture identity of <span class="math inline">\(\eqref{eq:pg-identity}\)</span> is applied to our observation model in <span class="math inline">\(\eqref{eq:nb-pmf}\)</span>, <span class="math inline">\(a = y_t\)</span>, <span class="math inline">\(b = r + y_t\)</span>, <span class="math inline">\(\kappa = (y_t - r)/2\)</span>, and <span class="math inline">\(\psi = \eta_t - \log r\)</span>.</p>
<p>From the scale mixture formulation, we obtain the following augmented joint observation model density:</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    \operatorname{p}(\theta_t \mid \omega, y_t, r, D_{t-1}) &amp;\propto
    \exp\left(-\frac{\omega}{2} \left( F_t^\top \theta_t - \left( \log r + \frac{y_t - r}{2 \omega} \right) \right)^2 \right)
    \operatorname{p}(\theta_t \mid D_{t-1})
    \\
    &amp;=
    e^{-\frac{\omega}{2} \left(y^*_t - F_t^\top \theta_t \right)^2}
    \operatorname{p}(\theta_t \mid D_{t-1})
    \\
    &amp;\propto \operatorname{p}\left( y^*_t \mid F_t^\top \theta_t, \omega^{-1} \right)
    \operatorname{p}(\theta_t \mid D_{t-1})
  \end{aligned}
\label{eq:nb-aug-obs}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(y^*_t = \log r + \frac{y_t - r}{2 \omega}\)</span>.</p>
<p>The reformulation at the end of <span class="math inline">\(\eqref{nb-aug-obs}\)</span> characterizes a distribution of “virtual” observations,</p>
<p><span class="math display">\[\begin{equation}
  y^*_t = F_t^\top \theta_t + \epsilon^*_t,\quad
  \epsilon^*_t \sim \operatorname{N}\left(0, V^*_t \right)
  ,
  \label{eq:nb-virtual-obs}
\end{equation}\]</span></p>
<p>with <span class="math inline">\(V_t = \operatorname{diag}\left( \omega^{-1}_t \right)\)</span>.</p>
<p>The augmented observation equation in <span class="math inline">\(\eqref{eq:nb-virtual-obs}\)</span> recovers our original DLM formulation and details the changes needed to use the Pólya-Gamma scale-mixture. Specifically, we need to sample <span class="math inline">\(\omega_t \sim \operatorname{PG}\left(r + y_t, F_t^\top \theta_t - \log r \right)\)</span> and perform the following substitutions: <span class="math inline">\(y_t \to y^*_t\)</span> and <span class="math inline">\(V_t \to V^*_t\)</span>.</p>
<p><a id="orgeeb5707"></a></p>
<section id="simulation-example-1" class="level2">
<h2>Simulation Example</h2>
<p>Listing <a href="#orga5ba480">17</a> creates a Theano graph for negative-binomial model defined in <span class="math inline">\(\eqref{eq:nb-dlm}\)</span>.</p>
<figure id="orga5ba480">
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="im">from</span> symbolic_pymc.theano.random_variables <span class="im">import</span> NegBinomialRV</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">r_tt <span class="op">=</span> tt.iscalar(<span class="st">&#39;r&#39;</span>)</a>
<a class="sourceLine" id="cb17-5" data-line-number="5"></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="kw">def</span> nb_obs_step(theta_t, F_t, r, rng):</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">    mu_t <span class="op">=</span> tt.exp(F_t.T.dot(theta_t))</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">    p_t <span class="op">=</span> mu_t <span class="op">/</span> (mu_t <span class="op">+</span> r)</a>
<a class="sourceLine" id="cb17-10" data-line-number="10">    y_t <span class="op">=</span> NegBinomialRV(r, (<span class="fl">1.</span> <span class="op">-</span> p_t), rng<span class="op">=</span>rng, name<span class="op">=</span><span class="st">&#39;y_t&#39;</span>)</a>
<a class="sourceLine" id="cb17-11" data-line-number="11">    <span class="cf">return</span> y_t, p_t</a>
<a class="sourceLine" id="cb17-12" data-line-number="12"></a>
<a class="sourceLine" id="cb17-13" data-line-number="13"></a>
<a class="sourceLine" id="cb17-14" data-line-number="14">nb_obs_res, nb_Y_t_updates <span class="op">=</span> theano.scan(fn<span class="op">=</span>nb_obs_step,</a>
<a class="sourceLine" id="cb17-15" data-line-number="15">                                         sequences<span class="op">=</span>[theta_t_rv],</a>
<a class="sourceLine" id="cb17-16" data-line-number="16">                                         non_sequences<span class="op">=</span>[F_tt, r_tt, rng_tt],</a>
<a class="sourceLine" id="cb17-17" data-line-number="17">                                         outputs_info<span class="op">=</span>[</a>
<a class="sourceLine" id="cb17-18" data-line-number="18">                                             {}, {}, <span class="co"># y_t, p_t</span></a>
<a class="sourceLine" id="cb17-19" data-line-number="19">                                         ],</a>
<a class="sourceLine" id="cb17-20" data-line-number="20">                                         strict<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb17-21" data-line-number="21">                                         name<span class="op">=</span><span class="st">&#39;Y_t&#39;</span>)</a>
<a class="sourceLine" id="cb17-22" data-line-number="22"></a>
<a class="sourceLine" id="cb17-23" data-line-number="23">nb_Y_t_rv, nb_p_t_tt <span class="op">=</span> nb_obs_res</a></code></pre></div>
<figcaption>
Listing 17
</figcaption>
</figure>
<p>Listing <a href="#org1bd6385">18</a> specifies parameters for a simulation from <span class="math inline">\(\eqref{eq:nb-dlm}\)</span> and samples a series.</p>
<figure id="org1bd6385">
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb18-1" data-line-number="1">nb_dlm_sim_values <span class="op">=</span> dlm_sim_values.copy()</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">nb_dlm_sim_values[F_tt] <span class="op">=</span> np.array([[<span class="fl">1.0</span>],</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">                                    [<span class="fl">0.0</span>]], dtype<span class="op">=</span>theano.config.floatX)</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">nb_dlm_sim_values[G_tt] <span class="op">=</span> np.array([[<span class="fl">1.0</span>, <span class="fl">0.1</span>],</a>
<a class="sourceLine" id="cb18-5" data-line-number="5">                                    [<span class="fl">0.0</span>, <span class="fl">0.8</span>]], dtype<span class="op">=</span>theano.config.floatX)</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">nb_dlm_sim_values[r_tt] <span class="op">=</span> <span class="dv">1000</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7"></a>
<a class="sourceLine" id="cb18-8" data-line-number="8">phi_W_tt.set_value(np.r_[<span class="fl">10.0</span>, <span class="fl">10.0</span>])</a>
<a class="sourceLine" id="cb18-9" data-line-number="9"></a>
<a class="sourceLine" id="cb18-10" data-line-number="10">rng_tt.get_value(borrow<span class="op">=</span><span class="va">True</span>).set_state(rng_init_state)</a>
<a class="sourceLine" id="cb18-11" data-line-number="11"></a>
<a class="sourceLine" id="cb18-12" data-line-number="12">simulate_nb_dlm <span class="op">=</span> tt_function([N_obs_tt, N_theta_tt, G_tt, F_tt, r_tt],</a>
<a class="sourceLine" id="cb18-13" data-line-number="13">                              [nb_Y_t_rv, theta_t_rv, nb_p_t_tt],</a>
<a class="sourceLine" id="cb18-14" data-line-number="14">                              givens<span class="op">=</span>{theta_0_rv: np.r_[<span class="fl">1.0</span>, <span class="fl">0.5</span>]},</a>
<a class="sourceLine" id="cb18-15" data-line-number="15">                              updates<span class="op">=</span>nb_Y_t_updates)</a>
<a class="sourceLine" id="cb18-16" data-line-number="16"></a>
<a class="sourceLine" id="cb18-17" data-line-number="17">sim_nb_res <span class="op">=</span> simulate_nb_dlm(nb_dlm_sim_values[N_obs_tt],</a>
<a class="sourceLine" id="cb18-18" data-line-number="18">                             nb_dlm_sim_values[N_theta_tt],</a>
<a class="sourceLine" id="cb18-19" data-line-number="19">                             nb_dlm_sim_values[G_tt],</a>
<a class="sourceLine" id="cb18-20" data-line-number="20">                             nb_dlm_sim_values[F_tt],</a>
<a class="sourceLine" id="cb18-21" data-line-number="21">                             nb_dlm_sim_values[r_tt])</a>
<a class="sourceLine" id="cb18-22" data-line-number="22"></a>
<a class="sourceLine" id="cb18-23" data-line-number="23">nb_y_sim, nb_theta_t_sim, nb_p_t_sim <span class="op">=</span> sim_nb_res</a></code></pre></div>
<figcaption>
Listing 18
</figcaption>
</figure>
<p>In Figure <a href="#orgf31ba4c">19</a> we plot the sample generated in Listing <a href="#orga5ba480">17</a>.</p>
<figure id="orgf31ba4c">
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb19-1" data-line-number="1">plt.clf()</a>
<a class="sourceLine" id="cb19-2" data-line-number="2"></a>
<a class="sourceLine" id="cb19-3" data-line-number="3">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb19-4" data-line-number="4">_ <span class="op">=</span> ax.plot(nb_y_sim, label<span class="op">=</span><span class="vs">r&#39;$y_t$&#39;</span>, color<span class="op">=</span><span class="st">&#39;black&#39;</span>, linewidth<span class="op">=</span><span class="fl">1.2</span>, drawstyle<span class="op">=</span><span class="st">&#39;steps-pre&#39;</span>)</a>
<a class="sourceLine" id="cb19-5" data-line-number="5"></a>
<a class="sourceLine" id="cb19-6" data-line-number="6">plt.tight_layout()</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">plt.legend()</a></code></pre></div>
<figcaption>
Listing 19
</figcaption>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/nb-dlm-sim-plot.png" alt="A series sampled from our negative-binomial model defined in \eqref{eq:nb-dlm}. " />
<figcaption>
A series sampled from our negative-binomial model defined in <span class="math inline">\(\eqref{eq:nb-dlm}\)</span>.
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb20-1" data-line-number="1">plt.clf()</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"></a>
<a class="sourceLine" id="cb20-3" data-line-number="3">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">ax.autoscale(enable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb20-5" data-line-number="5"></a>
<a class="sourceLine" id="cb20-6" data-line-number="6">bivariate_obs_cycler <span class="op">=</span>  cycler(<span class="st">&#39;linestyle&#39;</span>, [<span class="st">&#39;-&#39;</span>, <span class="st">&#39;--&#39;</span>]) <span class="op">*</span> cycler(<span class="st">&#39;color&#39;</span>, [<span class="st">&#39;black&#39;</span>])</a>
<a class="sourceLine" id="cb20-7" data-line-number="7"></a>
<a class="sourceLine" id="cb20-8" data-line-number="8">ax.set_prop_cycle(bivariate_obs_cycler)</a>
<a class="sourceLine" id="cb20-9" data-line-number="9">ax.plot(nb_theta_t_sim, label<span class="op">=</span><span class="vs">r&#39;$\theta_t$&#39;</span>, linewidth<span class="op">=</span><span class="fl">1.0</span>)</a>
<a class="sourceLine" id="cb20-10" data-line-number="10"></a>
<a class="sourceLine" id="cb20-11" data-line-number="11">ax.autoscale(enable<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb20-12" data-line-number="12"></a>
<a class="sourceLine" id="cb20-13" data-line-number="13">plt.tight_layout()</a>
<a class="sourceLine" id="cb20-14" data-line-number="14"></a>
<a class="sourceLine" id="cb20-15" data-line-number="15">plt.legend(framealpha<span class="op">=</span><span class="fl">0.4</span>)</a></code></pre></div>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/nb-theta-sim-plot.png" alt="Simulated \theta_t values from \eqref{eq:nb-dlm}. " />
<figcaption>
Simulated <span class="math inline">\(\theta_t\)</span> values from <span class="math inline">\(\eqref{eq:nb-dlm}\)</span>.
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb21-1" data-line-number="1">plt.clf()</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"></a>
<a class="sourceLine" id="cb21-3" data-line-number="3">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb21-4" data-line-number="4"></a>
<a class="sourceLine" id="cb21-5" data-line-number="5">ax.plot(nb_p_t_sim, label<span class="op">=</span><span class="vs">r&#39;$p_t$&#39;</span>, linewidth<span class="op">=</span><span class="fl">1.0</span>, color<span class="op">=</span><span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb21-6" data-line-number="6"></a>
<a class="sourceLine" id="cb21-7" data-line-number="7">plt.tight_layout()</a>
<a class="sourceLine" id="cb21-8" data-line-number="8">plt.legend(framealpha<span class="op">=</span><span class="fl">0.4</span>)</a></code></pre></div>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/nb-p-sim-plot.png" alt="Simulated p_t \mid \theta_t values from \eqref{eq:nb-dlm}. " />
<figcaption>
Simulated <span class="math inline">\(p_t \mid \theta_t\)</span> values from <span class="math inline">\(\eqref{eq:nb-dlm}\)</span>.
</figcaption>
</figure>
<p><a id="orgd705951"></a></p>
</section>
</section>
<section id="augmented-ffbs-sampler" class="level1">
<h1>Augmented FFBS Sampler</h1>
<p>In order to create a FFBS sampler for our Pólya-Gamma DLM in <span class="math inline">\(\eqref{eq:nb-aug-obs}\)</span>, we need to update the filtering code to use time-varying “virtual” observation variances, <span class="math inline">\(V^*_t\)</span>. After this change is made, all Theano graphs that depend on the resulting objects need to be recreated, as well. This is done in Listing <a href="#org6e0be06">22</a>.</p>
<figure id="org6e0be06">
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb22-1" data-line-number="1">V_t_tt <span class="op">=</span> tt.specify_shape(tt.col(), [N_obs_tt, <span class="dv">1</span>])</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">V_t_tt.name <span class="op">=</span> <span class="st">&#39;V_t&#39;</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="kw">def</span> nb_filtering_step(y_t, V_t, m_tm1, U_C_tm1, S_C_tm1, F_t, G_t, N_W_t):</a>
<a class="sourceLine" id="cb22-6" data-line-number="6">    N_V_t_inv <span class="op">=</span> tt.diag(tt_finite_inv(tt.sqrt(V_t), eps_truncate<span class="op">=</span><span class="va">True</span>))</a>
<a class="sourceLine" id="cb22-7" data-line-number="7">    <span class="cf">return</span> filtering_step(y_t, m_tm1, U_C_tm1, S_C_tm1, F_t, G_t, N_W_t, N_V_t_inv)</a>
<a class="sourceLine" id="cb22-8" data-line-number="8"></a>
<a class="sourceLine" id="cb22-9" data-line-number="9"></a>
<a class="sourceLine" id="cb22-10" data-line-number="10">filter_res, filter_updates <span class="op">=</span> theano.scan(fn<span class="op">=</span>nb_filtering_step,</a>
<a class="sourceLine" id="cb22-11" data-line-number="11">                                         sequences<span class="op">=</span>[y_tt, V_t_tt],</a>
<a class="sourceLine" id="cb22-12" data-line-number="12">                                         outputs_info<span class="op">=</span>[</a>
<a class="sourceLine" id="cb22-13" data-line-number="13">                                             {<span class="st">&quot;initial&quot;</span>: m_0_tt, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb22-14" data-line-number="14">                                             {<span class="st">&quot;initial&quot;</span>: U_C_0_tt, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb22-15" data-line-number="15">                                             {<span class="st">&quot;initial&quot;</span>: S_C_0_tt, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb22-16" data-line-number="16">                                             {}, {}, {}  <span class="co"># a_t, U_R_t, S_R_t</span></a>
<a class="sourceLine" id="cb22-17" data-line-number="17">                                         ],</a>
<a class="sourceLine" id="cb22-18" data-line-number="18">                                         non_sequences<span class="op">=</span>[F_tt, G_tt, N_W_tt],</a>
<a class="sourceLine" id="cb22-19" data-line-number="19">                                         strict<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb22-20" data-line-number="20">                                         name<span class="op">=</span><span class="st">&#39;theta_filtered&#39;</span>)</a>
<a class="sourceLine" id="cb22-21" data-line-number="21"></a>
<a class="sourceLine" id="cb22-22" data-line-number="22">(m_t, U_C_t, S_C_t, a_t, U_R_t, S_R_t) <span class="op">=</span> filter_res</a>
<a class="sourceLine" id="cb22-23" data-line-number="23"></a>
<a class="sourceLine" id="cb22-24" data-line-number="24">m_T <span class="op">=</span> m_t[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb22-25" data-line-number="25">U_C_T <span class="op">=</span> U_C_t[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb22-26" data-line-number="26">S_C_T <span class="op">=</span> S_C_t[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb22-27" data-line-number="27"></a>
<a class="sourceLine" id="cb22-28" data-line-number="28">C_T <span class="op">=</span> matrix_dot(U_C_T, tt.square(S_C_T), U_C_T.T)</a>
<a class="sourceLine" id="cb22-29" data-line-number="29">theta_T_post <span class="op">=</span> MvNormalRV(m_T, C_T, rng<span class="op">=</span>rng_tt)</a>
<a class="sourceLine" id="cb22-30" data-line-number="30">theta_T_post.name <span class="op">=</span> <span class="st">&quot;theta_T_post&quot;</span></a>
<a class="sourceLine" id="cb22-31" data-line-number="31"></a>
<a class="sourceLine" id="cb22-32" data-line-number="32">ffbs_output, ffbs_updates <span class="op">=</span> theano.scan(fn<span class="op">=</span>ffbs_step,</a>
<a class="sourceLine" id="cb22-33" data-line-number="33">                                        sequences<span class="op">=</span>[</a>
<a class="sourceLine" id="cb22-34" data-line-number="34">                                            {<span class="st">&quot;input&quot;</span>: m_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb22-35" data-line-number="35">                                            {<span class="st">&quot;input&quot;</span>: U_C_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb22-36" data-line-number="36">                                            {<span class="st">&quot;input&quot;</span>: S_C_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb22-37" data-line-number="37">                                            {<span class="st">&quot;input&quot;</span>: a_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb22-38" data-line-number="38">                                            {<span class="st">&quot;input&quot;</span>: U_R_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb22-39" data-line-number="39">                                            {<span class="st">&quot;input&quot;</span>: S_R_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]}</a>
<a class="sourceLine" id="cb22-40" data-line-number="40">                                        ],</a>
<a class="sourceLine" id="cb22-41" data-line-number="41">                                        outputs_info<span class="op">=</span>[</a>
<a class="sourceLine" id="cb22-42" data-line-number="42">                                            {<span class="st">&quot;initial&quot;</span>: theta_T_post, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb22-43" data-line-number="43">                                            {}, {}, <span class="co"># theta_tp1_diff, f_tp1</span></a>
<a class="sourceLine" id="cb22-44" data-line-number="44">                                        ],</a>
<a class="sourceLine" id="cb22-45" data-line-number="45">                                        non_sequences<span class="op">=</span>[F_tt, G_tt, N_W_inv_tt, rng_tt],</a>
<a class="sourceLine" id="cb22-46" data-line-number="46">                                        go_backwards<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb22-47" data-line-number="47">                                        strict<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb22-48" data-line-number="48">                                        name<span class="op">=</span><span class="st">&#39;ffbs_samples&#39;</span>)</a>
<a class="sourceLine" id="cb22-49" data-line-number="49"></a>
<a class="sourceLine" id="cb22-50" data-line-number="50">(theta_t_post_rev, theta_t_diff_rev, f_t_rev) <span class="op">=</span> ffbs_output</a>
<a class="sourceLine" id="cb22-51" data-line-number="51"></a>
<a class="sourceLine" id="cb22-52" data-line-number="52">theta_t_post <span class="op">=</span> tt.join(<span class="dv">0</span>, theta_t_post_rev[::<span class="op">-</span><span class="dv">1</span>], [theta_T_post])</a>
<a class="sourceLine" id="cb22-53" data-line-number="53"></a>
<a class="sourceLine" id="cb22-54" data-line-number="54">f_t_post <span class="op">=</span> tt.join(<span class="dv">0</span>, f_t_rev[::<span class="op">-</span><span class="dv">1</span>], [F_tt.T.dot(theta_T_post)])</a></code></pre></div>
<figcaption>
Listing 22
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb23-1" data-line-number="1">phi_W_a_post_tt <span class="op">=</span> phi_W_a <span class="op">+</span> N_obs_tt <span class="op">*</span> <span class="fl">0.5</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2">phi_W_b_post_tt <span class="op">=</span> phi_W_b <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> tt.square(theta_t_diff_rev).<span class="bu">sum</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">phi_W_post_tt <span class="op">=</span> GammaRV(phi_W_a_post_tt, phi_W_b_post_tt, rng<span class="op">=</span>rng_tt, name<span class="op">=</span><span class="st">&#39;phi_W_post&#39;</span>)</a></code></pre></div>
</figure>
<p><a id="orgafe10a4"></a></p>
<section id="simulation-example-2" class="level2">
<h2>Simulation Example</h2>
<p>In Listing <a href="#orgdf7d0e4">24</a> we sample the initial values and create Theano terms for posterior/updated <span class="math inline">\(\omega_t\)</span>-related values.</p>
<figure id="orgdf7d0e4">
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="im">from</span> pypolyagamma <span class="im">import</span> PyPolyaGamma</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"></a>
<a class="sourceLine" id="cb24-3" data-line-number="3"><span class="im">from</span> symbolic_pymc.theano.random_variables <span class="im">import</span> PolyaGammaRV</a>
<a class="sourceLine" id="cb24-4" data-line-number="4"></a>
<a class="sourceLine" id="cb24-5" data-line-number="5"></a>
<a class="sourceLine" id="cb24-6" data-line-number="6">y_raw_tt <span class="op">=</span> theano.shared(nb_y_sim.astype(theano.config.floatX), name<span class="op">=</span><span class="st">&#39;y_raw_t&#39;</span>)</a>
<a class="sourceLine" id="cb24-7" data-line-number="7"></a>
<a class="sourceLine" id="cb24-8" data-line-number="8">r_sim <span class="op">=</span> np.array(nb_dlm_sim_values[r_tt], dtype<span class="op">=</span><span class="st">&#39;double&#39;</span>)</a>
<a class="sourceLine" id="cb24-9" data-line-number="9"></a>
<a class="sourceLine" id="cb24-10" data-line-number="10"><span class="co"># XXX: testing</span></a>
<a class="sourceLine" id="cb24-11" data-line-number="11">F_t_theta_0 <span class="op">=</span> np.dot(nb_theta_t_sim, nb_dlm_sim_values[F_tt])</a>
<a class="sourceLine" id="cb24-12" data-line-number="12"></a>
<a class="sourceLine" id="cb24-13" data-line-number="13">omega_0 <span class="op">=</span> np.empty(nb_y_sim.shape[<span class="dv">0</span>], dtype<span class="op">=</span><span class="st">&#39;double&#39;</span>)</a>
<a class="sourceLine" id="cb24-14" data-line-number="14">PyPolyaGamma(<span class="dv">12344</span>).pgdrawv(r_sim <span class="op">+</span> nb_y_sim.squeeze(),</a>
<a class="sourceLine" id="cb24-15" data-line-number="15">                            F_t_theta_0.squeeze() <span class="op">-</span> np.log(r_sim),</a>
<a class="sourceLine" id="cb24-16" data-line-number="16">                            omega_0)</a>
<a class="sourceLine" id="cb24-17" data-line-number="17">omega_0 <span class="op">=</span> np.expand_dims(omega_0, <span class="dv">-1</span>)</a>
<a class="sourceLine" id="cb24-18" data-line-number="18"></a>
<a class="sourceLine" id="cb24-19" data-line-number="19">y_aug_0 <span class="op">=</span> np.log(r_sim) <span class="op">+</span> (nb_y_sim <span class="op">-</span> r_sim) <span class="op">/</span> (<span class="fl">2.0</span> <span class="op">*</span> omega_0)</a>
<a class="sourceLine" id="cb24-20" data-line-number="20"></a>
<a class="sourceLine" id="cb24-21" data-line-number="21">omega_t_tt <span class="op">=</span> theano.shared(omega_0, name<span class="op">=</span><span class="st">&#39;omega_t&#39;</span>)</a>
<a class="sourceLine" id="cb24-22" data-line-number="22"></a>
<a class="sourceLine" id="cb24-23" data-line-number="23">omega_post_tt <span class="op">=</span> PolyaGammaRV(r_tt <span class="op">+</span> y_raw_tt, theta_t_post.dot(F_tt) <span class="op">-</span> tt.log(r_tt), rng<span class="op">=</span>rng_tt, name<span class="op">=</span><span class="st">&#39;omega_post&#39;</span>)</a>
<a class="sourceLine" id="cb24-24" data-line-number="24"></a>
<a class="sourceLine" id="cb24-25" data-line-number="25">y_aug_post_tt <span class="op">=</span> tt.log(r_tt) <span class="op">+</span> (y_raw_tt <span class="op">-</span> r_tt) <span class="op">/</span> (<span class="fl">2.0</span> <span class="op">*</span> omega_post_tt)</a>
<a class="sourceLine" id="cb24-26" data-line-number="26">y_aug_post_tt.name <span class="op">=</span> <span class="st">&#39;y_aug_post&#39;</span></a></code></pre></div>
<figcaption>
Listing 24
</figcaption>
</figure>
<p>Finally, the sampler steps are defined and executed in Listing <a href="#org2dd74e9">25</a>.</p>
<figure id="org2dd74e9">
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb25-1" data-line-number="1">nb_ffbs_dlm <span class="op">=</span> tt_function([N_obs_tt, N_theta_tt, y_tt, G_tt, F_tt, V_t_tt, r_tt],</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">                          [theta_t_post, phi_W_post_tt, omega_post_tt, y_aug_post_tt],</a>
<a class="sourceLine" id="cb25-3" data-line-number="3">                          updates<span class="op">=</span>ffbs_updates)</a>
<a class="sourceLine" id="cb25-4" data-line-number="4"></a>
<a class="sourceLine" id="cb25-5" data-line-number="5">rng_tt.get_value(borrow<span class="op">=</span><span class="va">True</span>).set_state(rng_sim_state)</a>
<a class="sourceLine" id="cb25-6" data-line-number="6"></a>
<a class="sourceLine" id="cb25-7" data-line-number="7">phi_W_tt.set_value(np.r_[<span class="fl">10.0</span>, <span class="fl">10.0</span>])</a>
<a class="sourceLine" id="cb25-8" data-line-number="8"></a>
<a class="sourceLine" id="cb25-9" data-line-number="9">chain <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb25-10" data-line-number="10"></a>
<a class="sourceLine" id="cb25-11" data-line-number="11">theta_label <span class="op">=</span> <span class="vs">r&#39;$\theta_t \mid D_T$&#39;</span></a>
<a class="sourceLine" id="cb25-12" data-line-number="12">phi_W_label <span class="op">=</span> <span class="vs">r&#39;$\phi_W \mid D_T$&#39;</span></a>
<a class="sourceLine" id="cb25-13" data-line-number="13">omega_label <span class="op">=</span> <span class="vs">r&#39;$\omega_t \mid D_T$&#39;</span></a>
<a class="sourceLine" id="cb25-14" data-line-number="14"></a>
<a class="sourceLine" id="cb25-15" data-line-number="15">theta_t_post_sim, phi_W_post_sim, omega_post_sim, y_aug_post_sim <span class="op">=</span> <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span></a>
<a class="sourceLine" id="cb25-16" data-line-number="16">nb_posterior_samples <span class="op">=</span> {theta_label: [[]], phi_W_label: [[]], omega_label: [[]]}</a>
<a class="sourceLine" id="cb25-17" data-line-number="17"></a>
<a class="sourceLine" id="cb25-18" data-line-number="18">V_t_sim <span class="op">=</span> np.reciprocal(omega_0)</a>
<a class="sourceLine" id="cb25-19" data-line-number="19">y_aug_sim <span class="op">=</span> y_aug_0</a>
<a class="sourceLine" id="cb25-20" data-line-number="20"></a>
<a class="sourceLine" id="cb25-21" data-line-number="21"><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>):</a>
<a class="sourceLine" id="cb25-22" data-line-number="22"></a>
<a class="sourceLine" id="cb25-23" data-line-number="23">    nb_ffbs_res <span class="op">=</span> nb_ffbs_dlm(</a>
<a class="sourceLine" id="cb25-24" data-line-number="24">        nb_dlm_sim_values[N_obs_tt],</a>
<a class="sourceLine" id="cb25-25" data-line-number="25">        nb_dlm_sim_values[N_theta_tt],</a>
<a class="sourceLine" id="cb25-26" data-line-number="26">        y_aug_sim,</a>
<a class="sourceLine" id="cb25-27" data-line-number="27">        nb_dlm_sim_values[G_tt],</a>
<a class="sourceLine" id="cb25-28" data-line-number="28">        nb_dlm_sim_values[F_tt],</a>
<a class="sourceLine" id="cb25-29" data-line-number="29">        V_t_sim,</a>
<a class="sourceLine" id="cb25-30" data-line-number="30">        nb_dlm_sim_values[r_tt])</a>
<a class="sourceLine" id="cb25-31" data-line-number="31"></a>
<a class="sourceLine" id="cb25-32" data-line-number="32">    theta_t_post_sim, phi_W_post_sim, omega_post_sim, y_aug_post_sim <span class="op">=</span> nb_ffbs_res</a>
<a class="sourceLine" id="cb25-33" data-line-number="33"></a>
<a class="sourceLine" id="cb25-34" data-line-number="34">    phi_W_tt.set_value(phi_W_post_sim)</a>
<a class="sourceLine" id="cb25-35" data-line-number="35">    omega_t_tt.set_value(omega_post_sim)</a>
<a class="sourceLine" id="cb25-36" data-line-number="36"></a>
<a class="sourceLine" id="cb25-37" data-line-number="37">    V_t_sim <span class="op">=</span> np.reciprocal(omega_post_sim)</a>
<a class="sourceLine" id="cb25-38" data-line-number="38">    y_aug_sim <span class="op">=</span> y_aug_post_sim</a>
<a class="sourceLine" id="cb25-39" data-line-number="39"></a>
<a class="sourceLine" id="cb25-40" data-line-number="40">    nb_posterior_samples[theta_label][chain].append(theta_t_post_sim)</a>
<a class="sourceLine" id="cb25-41" data-line-number="41">    nb_posterior_samples[phi_W_label][chain].append(phi_W_post_sim)</a>
<a class="sourceLine" id="cb25-42" data-line-number="42">    nb_posterior_samples[omega_label][chain].append(omega_post_sim)</a>
<a class="sourceLine" id="cb25-43" data-line-number="43"></a>
<a class="sourceLine" id="cb25-44" data-line-number="44">    <span class="bu">print</span>(<span class="ss">f&#39;i=</span><span class="sc">{i}</span><span class="ss">,</span><span class="ch">\t</span><span class="ss">phi_W=</span><span class="sc">{</span>phi_W_post_sim<span class="sc">}</span><span class="ss">&#39;</span>)</a>
<a class="sourceLine" id="cb25-45" data-line-number="45"></a>
<a class="sourceLine" id="cb25-46" data-line-number="46">nb_posterior_samples <span class="op">=</span> {k: np.asarray(v) <span class="cf">for</span> k,v <span class="kw">in</span> nb_posterior_samples.items()}</a></code></pre></div>
<figcaption>
Listing 25
</figcaption>
</figure>
<p>Figure <a href="#orgf9a4406">26</a> shows the posterior <span class="math inline">\(\theta_t\)</span> samples, Figure <a href="#orga6f3d67">27</a> plots the posterior sample traces, and Figure <a href="#org528d6ec">28</a> shows <span class="math inline">\(p_t \mid \theta_t\)</span>.</p>
<figure id="orgf9a4406">
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb26-1" data-line-number="1">plt.clf()</a>
<a class="sourceLine" id="cb26-2" data-line-number="2"></a>
<a class="sourceLine" id="cb26-3" data-line-number="3">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">ax.autoscale(enable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb26-5" data-line-number="5"></a>
<a class="sourceLine" id="cb26-6" data-line-number="6">thetas_shape <span class="op">=</span> nb_posterior_samples[theta_label][<span class="dv">0</span>].shape</a>
<a class="sourceLine" id="cb26-7" data-line-number="7"></a>
<a class="sourceLine" id="cb26-8" data-line-number="8">cycle <span class="op">=</span> ax._get_lines.prop_cycler</a>
<a class="sourceLine" id="cb26-9" data-line-number="9"></a>
<a class="sourceLine" id="cb26-10" data-line-number="10">bivariate_obs_cycler <span class="op">=</span>  cycler(<span class="st">&#39;linestyle&#39;</span>, [<span class="st">&#39;-&#39;</span>, <span class="st">&#39;--&#39;</span>]) <span class="op">*</span> cycler(<span class="st">&#39;color&#39;</span>, [<span class="st">&#39;black&#39;</span>])</a>
<a class="sourceLine" id="cb26-11" data-line-number="11"></a>
<a class="sourceLine" id="cb26-12" data-line-number="12">ax.set_prop_cycle(bivariate_obs_cycler)</a>
<a class="sourceLine" id="cb26-13" data-line-number="13">ax.plot(nb_theta_t_sim, label<span class="op">=</span><span class="vs">r&#39;$\theta_t$&#39;</span>, linewidth<span class="op">=</span><span class="fl">1.0</span>)</a>
<a class="sourceLine" id="cb26-14" data-line-number="14"></a>
<a class="sourceLine" id="cb26-15" data-line-number="15">ax.autoscale(enable<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb26-16" data-line-number="16">ax.autoscale(enable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb26-17" data-line-number="17"></a>
<a class="sourceLine" id="cb26-18" data-line-number="18"><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(thetas_shape[<span class="op">-</span><span class="dv">1</span>]):</a>
<a class="sourceLine" id="cb26-19" data-line-number="19"></a>
<a class="sourceLine" id="cb26-20" data-line-number="20">    styles <span class="op">=</span> <span class="bu">next</span>(cycle)</a>
<a class="sourceLine" id="cb26-21" data-line-number="21">    thetas <span class="op">=</span> nb_posterior_samples[theta_label][<span class="dv">0</span>].T[d].T</a>
<a class="sourceLine" id="cb26-22" data-line-number="22"></a>
<a class="sourceLine" id="cb26-23" data-line-number="23">    theta_lines <span class="op">=</span> np.empty(thetas_shape[:<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> (<span class="dv">2</span>,))</a>
<a class="sourceLine" id="cb26-24" data-line-number="24">    theta_lines.T[<span class="dv">0</span>] <span class="op">=</span> np.tile(np.arange(thetas_shape[<span class="op">-</span><span class="dv">2</span>]), [thetas_shape[<span class="op">-</span><span class="dv">3</span>], <span class="dv">1</span>]).T</a>
<a class="sourceLine" id="cb26-25" data-line-number="25">    theta_lines.T[<span class="dv">1</span>] <span class="op">=</span> thetas.T</a>
<a class="sourceLine" id="cb26-26" data-line-number="26"></a>
<a class="sourceLine" id="cb26-27" data-line-number="27">    ax.add_collection(</a>
<a class="sourceLine" id="cb26-28" data-line-number="28">        LineCollection(theta_lines,</a>
<a class="sourceLine" id="cb26-29" data-line-number="29">                       label<span class="op">=</span>theta_label,</a>
<a class="sourceLine" id="cb26-30" data-line-number="30">                       alpha<span class="op">=</span><span class="fl">0.05</span>, linewidth<span class="op">=</span><span class="fl">0.9</span>,</a>
<a class="sourceLine" id="cb26-31" data-line-number="31">                       <span class="op">**</span>styles)</a>
<a class="sourceLine" id="cb26-32" data-line-number="32">    )</a>
<a class="sourceLine" id="cb26-33" data-line-number="33"></a>
<a class="sourceLine" id="cb26-34" data-line-number="34">plt.tight_layout()</a>
<a class="sourceLine" id="cb26-35" data-line-number="35"></a>
<a class="sourceLine" id="cb26-36" data-line-number="36">plt.legend(framealpha<span class="op">=</span><span class="fl">0.4</span>)</a></code></pre></div>
<figcaption>
Listing 26
</figcaption>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/nb-ffbs-sim-plot.png" alt="Posterior \theta_t samples generated by our Pólya-Gamma FFBS sampler. " />
<figcaption>
Posterior <span class="math inline">\(\theta_t\)</span> samples generated by our Pólya-Gamma FFBS sampler.
</figcaption>
</figure>
<figure id="orga6f3d67">
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="im">import</span> arviz <span class="im">as</span> az</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"></a>
<a class="sourceLine" id="cb27-3" data-line-number="3">az_trace <span class="op">=</span> az.from_dict(posterior<span class="op">=</span>nb_posterior_samples)</a>
<a class="sourceLine" id="cb27-4" data-line-number="4">az.plot_trace(az_trace, compact<span class="op">=</span><span class="va">True</span>)</a></code></pre></div>
<figcaption>
Listing 27
</figcaption>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/nb-ffbs-trace-plot.png" alt="Posterior sample traces for our Pólya-Gamma FFBS Gibbs sampler. " />
<figcaption>
Posterior sample traces for our Pólya-Gamma FFBS Gibbs sampler.
</figcaption>
</figure>
<figure id="org528d6ec">
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb28-1" data-line-number="1">plt.close(<span class="st">&#39;all&#39;</span>)</a>
<a class="sourceLine" id="cb28-2" data-line-number="2"></a>
<a class="sourceLine" id="cb28-3" data-line-number="3">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb28-4" data-line-number="4"></a>
<a class="sourceLine" id="cb28-5" data-line-number="5">ax.plot(nb_p_t_sim, label<span class="op">=</span><span class="vs">r&#39;$p_t$&#39;</span>, linewidth<span class="op">=</span><span class="fl">1.0</span>, color<span class="op">=</span><span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb28-6" data-line-number="6"></a>
<a class="sourceLine" id="cb28-7" data-line-number="7">ax.autoscale(enable<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb28-8" data-line-number="8">ax.autoscale(enable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb28-9" data-line-number="9"></a>
<a class="sourceLine" id="cb28-10" data-line-number="10">mu_t_sim <span class="op">=</span> np.exp(np.dot(nb_posterior_samples[theta_label][<span class="dv">0</span>], nb_dlm_sim_values[F_tt].squeeze()))</a>
<a class="sourceLine" id="cb28-11" data-line-number="11">p_t_sim <span class="op">=</span> mu_t_sim <span class="op">/</span> (mu_t_sim <span class="op">+</span> nb_dlm_sim_values[r_tt])</a>
<a class="sourceLine" id="cb28-12" data-line-number="12"></a>
<a class="sourceLine" id="cb28-13" data-line-number="13">p_t_lines <span class="op">=</span> np.empty(p_t_sim.shape <span class="op">+</span> (<span class="dv">2</span>,))</a>
<a class="sourceLine" id="cb28-14" data-line-number="14">p_t_lines.T[<span class="dv">0</span>] <span class="op">=</span> np.tile(np.arange(p_t_sim.shape[<span class="dv">1</span>]), [p_t_sim.shape[<span class="dv">0</span>], <span class="dv">1</span>]).T</a>
<a class="sourceLine" id="cb28-15" data-line-number="15">p_t_lines.T[<span class="dv">1</span>] <span class="op">=</span> p_t_sim.T</a>
<a class="sourceLine" id="cb28-16" data-line-number="16"></a>
<a class="sourceLine" id="cb28-17" data-line-number="17">ax.add_collection(</a>
<a class="sourceLine" id="cb28-18" data-line-number="18">    LineCollection(p_t_lines,</a>
<a class="sourceLine" id="cb28-19" data-line-number="19">                   label<span class="op">=</span><span class="vs">r&#39;$p_t \mid \theta_t, D_T$&#39;</span>,</a>
<a class="sourceLine" id="cb28-20" data-line-number="20">                   alpha<span class="op">=</span><span class="fl">0.3</span>, linewidth<span class="op">=</span><span class="fl">0.9</span>, color<span class="op">=</span><span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb28-21" data-line-number="21">)</a>
<a class="sourceLine" id="cb28-22" data-line-number="22"></a>
<a class="sourceLine" id="cb28-23" data-line-number="23">plt.tight_layout()</a>
<a class="sourceLine" id="cb28-24" data-line-number="24"></a>
<a class="sourceLine" id="cb28-25" data-line-number="25">plt.legend(framealpha<span class="op">=</span><span class="fl">0.4</span>)</a></code></pre></div>
<figcaption>
Listing 28
</figcaption>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/nb-ffbs-sim-pred-plot.png" alt="p_t \mid \theta_t, D_T samples generated by our Pólya-Gamma FFBS sampler. " />
<figcaption>
<span class="math inline">\(p_t \mid \theta_t, D_T\)</span> samples generated by our Pólya-Gamma FFBS sampler.
</figcaption>
</figure>
<p><a id="orgf74c6fe"></a></p>
</section>
<section id="covid19-example" class="level2">
<h2>COVID–19 Example</h2>
<p>As another example, we’ll use data from the COVID–19 outbreak in New York and we’ll only concentrate on the positive test counts. We do not make any qualitative assertions about the results; we simply want to apply our implementation to a real-life dataset. If anything, we would simply like to highlight the potential provided by these flexible and constructive Bayesian frameworks and provide a concrete starting point for motivated Python developers.</p>
<p>To start, Listing <a href="#org703a0b2">29</a> pulls and formats the COVID–19 data and Figure <a href="#org9c1b4d3">30</a> plots it.</p>
<figure id="org703a0b2">
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="im">import</span> pandas <span class="im">as</span> pd</a>
<a class="sourceLine" id="cb29-2" data-line-number="2"></a>
<a class="sourceLine" id="cb29-3" data-line-number="3"></a>
<a class="sourceLine" id="cb29-4" data-line-number="4">url <span class="op">=</span> <span class="st">&#39;https://covidtracking.com/api/v1/states/daily.csv&#39;</span></a>
<a class="sourceLine" id="cb29-5" data-line-number="5">states <span class="op">=</span> pd.read_csv(url, parse_dates<span class="op">=</span>[<span class="st">&#39;date&#39;</span>], index_col<span class="op">=</span>[<span class="st">&#39;state&#39;</span>,<span class="st">&#39;date&#39;</span>]).sort_index()</a>
<a class="sourceLine" id="cb29-6" data-line-number="6">state <span class="op">=</span> <span class="st">&#39;NY&#39;</span></a>
<a class="sourceLine" id="cb29-7" data-line-number="7"></a>
<a class="sourceLine" id="cb29-8" data-line-number="8">counts <span class="op">=</span> states.loc[state, [<span class="st">&#39;positive&#39;</span>, <span class="st">&#39;total&#39;</span>]].diff().loc[<span class="st">&#39;2020-03-20&#39;</span>:]</a>
<a class="sourceLine" id="cb29-9" data-line-number="9">counts.columns <span class="op">=</span> [<span class="st">&#39;new_positive_tests&#39;</span>, <span class="st">&#39;new_total_tests&#39;</span>]</a></code></pre></div>
<figcaption>
Listing 29
</figcaption>
</figure>
<figure id="org9c1b4d3">
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb30-1" data-line-number="1">plt.clf()</a>
<a class="sourceLine" id="cb30-2" data-line-number="2"></a>
<a class="sourceLine" id="cb30-3" data-line-number="3">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb30-4" data-line-number="4">_ <span class="op">=</span> ax.plot(counts.new_positive_tests, label<span class="op">=</span><span class="vs">r&#39;$y_t$&#39;</span>, color<span class="op">=</span><span class="st">&#39;black&#39;</span>, linewidth<span class="op">=</span><span class="fl">1.2</span>, drawstyle<span class="op">=</span><span class="st">&#39;steps-pre&#39;</span>)</a>
<a class="sourceLine" id="cb30-5" data-line-number="5"></a>
<a class="sourceLine" id="cb30-6" data-line-number="6">plt.tight_layout()</a>
<a class="sourceLine" id="cb30-7" data-line-number="7">plt.legend()</a></code></pre></div>
<figcaption>
Listing 30
</figcaption>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/nb-dlm-ny-plot.png" alt="COVID–19 positive test counts in NY " />
<figcaption>
COVID–19 positive test counts in NY
</figcaption>
</figure>
<p>Our example model is a simple Gaussian walk given by the following values:</p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    F_t = \begin{pmatrix}
      1
    \end{pmatrix}
    ,\quad
    G_t = \begin{pmatrix}
      1
    \end{pmatrix}
    \\
    W_t = \begin{pmatrix}
      \phi_{W}^{-1}
    \end{pmatrix}
    , \quad
    \phi_{W} \sim \operatorname{Gamma}\left(2.5, 0.5\right)
    , \quad
    \phi_{W} = 10
  \end{gathered}
  \label{eq:ny-model-settings}
  \;.
\end{equation}\]</span></p>
<p>Again, we set <span class="math inline">\(r = 1000\)</span>, effectively making our negative-binomial a Poisson approximation. Listing <a href="#org2352b66">31</a> sets the initial values in <span class="math inline">\(\eqref{eq:ny-model-settings}\)</span> and Listing <a href="#orgde4fb94">32</a> specifies the sampler loop.</p>
<figure id="org2352b66">
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb31-1" data-line-number="1">nb_dlm_ny_values <span class="op">=</span> {</a>
<a class="sourceLine" id="cb31-2" data-line-number="2">    N_obs_tt: counts.new_positive_tests.shape[<span class="dv">0</span>],</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">    N_theta_tt: <span class="dv">1</span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb31-5" data-line-number="5">nb_dlm_ny_values[F_tt] <span class="op">=</span> np.array([[<span class="fl">1.0</span>]], dtype<span class="op">=</span>theano.config.floatX)</a>
<a class="sourceLine" id="cb31-6" data-line-number="6">nb_dlm_ny_values[G_tt] <span class="op">=</span> np.array([[<span class="fl">1.0</span>]], dtype<span class="op">=</span>theano.config.floatX)</a>
<a class="sourceLine" id="cb31-7" data-line-number="7">nb_dlm_ny_values[r_tt] <span class="op">=</span> <span class="dv">1000</span></a>
<a class="sourceLine" id="cb31-8" data-line-number="8"></a>
<a class="sourceLine" id="cb31-9" data-line-number="9">phi_W_a.set_value(np.r_[<span class="fl">2.5</span>])</a>
<a class="sourceLine" id="cb31-10" data-line-number="10">phi_W_b.set_value(np.r_[<span class="fl">0.5</span>])</a>
<a class="sourceLine" id="cb31-11" data-line-number="11">phi_W_tt.set_value(np.r_[<span class="fl">10.0</span>])</a>
<a class="sourceLine" id="cb31-12" data-line-number="12"></a>
<a class="sourceLine" id="cb31-13" data-line-number="13">rng_tt.get_value(borrow<span class="op">=</span><span class="va">True</span>).set_state(rng_init_state)</a>
<a class="sourceLine" id="cb31-14" data-line-number="14"></a>
<a class="sourceLine" id="cb31-15" data-line-number="15">y_raw_tt.set_value(np.expand_dims(counts.new_positive_tests, <span class="dv">-1</span>).astype(theano.config.floatX))</a>
<a class="sourceLine" id="cb31-16" data-line-number="16"></a>
<a class="sourceLine" id="cb31-17" data-line-number="17">r_ny <span class="op">=</span> np.array(nb_dlm_ny_values[r_tt], dtype<span class="op">=</span><span class="st">&#39;double&#39;</span>)</a>
<a class="sourceLine" id="cb31-18" data-line-number="18"></a>
<a class="sourceLine" id="cb31-19" data-line-number="19">omega_0 <span class="op">=</span> np.empty(counts.new_positive_tests.shape[<span class="dv">0</span>], dtype<span class="op">=</span><span class="st">&#39;double&#39;</span>)</a>
<a class="sourceLine" id="cb31-20" data-line-number="20">PyPolyaGamma(<span class="dv">12344</span>).pgdrawv(r_ny <span class="op">+</span> counts.new_positive_tests.values,</a>
<a class="sourceLine" id="cb31-21" data-line-number="21">                            F_t_theta_0.squeeze() <span class="op">-</span> np.log(r_ny),</a>
<a class="sourceLine" id="cb31-22" data-line-number="22">                            omega_0)</a>
<a class="sourceLine" id="cb31-23" data-line-number="23">omega_0 <span class="op">=</span> np.expand_dims(omega_0, <span class="dv">-1</span>)</a>
<a class="sourceLine" id="cb31-24" data-line-number="24"></a>
<a class="sourceLine" id="cb31-25" data-line-number="25">y_aug_0 <span class="op">=</span> np.log(r_ny) <span class="op">+</span> (counts.new_positive_tests.values[:, np.newaxis] <span class="op">-</span> r_ny) <span class="op">/</span> (<span class="fl">2.0</span> <span class="op">*</span> omega_0)</a>
<a class="sourceLine" id="cb31-26" data-line-number="26"></a>
<a class="sourceLine" id="cb31-27" data-line-number="27">omega_t_tt.set_value(omega_0)</a></code></pre></div>
<figcaption>
Listing 31
</figcaption>
</figure>
<figure id="orgde4fb94">
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb32-1" data-line-number="1">nb_ffbs_dlm <span class="op">=</span> tt_function([N_obs_tt, N_theta_tt, y_tt, G_tt, F_tt, V_t_tt, r_tt],</a>
<a class="sourceLine" id="cb32-2" data-line-number="2">                          [theta_t_post, phi_W_post_tt, omega_post_tt, y_aug_post_tt],</a>
<a class="sourceLine" id="cb32-3" data-line-number="3">                          <span class="co"># mode=&#39;FAST_COMPILE&#39;,</span></a>
<a class="sourceLine" id="cb32-4" data-line-number="4">                          updates<span class="op">=</span>ffbs_updates)</a>
<a class="sourceLine" id="cb32-5" data-line-number="5"></a>
<a class="sourceLine" id="cb32-6" data-line-number="6">rng_tt.get_value(borrow<span class="op">=</span><span class="va">True</span>).set_state(rng_sim_state)</a>
<a class="sourceLine" id="cb32-7" data-line-number="7"></a>
<a class="sourceLine" id="cb32-8" data-line-number="8">chain <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb32-9" data-line-number="9"></a>
<a class="sourceLine" id="cb32-10" data-line-number="10">theta_label <span class="op">=</span> <span class="vs">r&#39;$\theta_t \mid D_T$&#39;</span></a>
<a class="sourceLine" id="cb32-11" data-line-number="11">phi_W_label <span class="op">=</span> <span class="vs">r&#39;$\phi_W \mid D_T$&#39;</span></a>
<a class="sourceLine" id="cb32-12" data-line-number="12">omega_label <span class="op">=</span> <span class="vs">r&#39;$\omega_t \mid D_T$&#39;</span></a>
<a class="sourceLine" id="cb32-13" data-line-number="13"></a>
<a class="sourceLine" id="cb32-14" data-line-number="14">theta_t_post_sim, phi_W_post_sim, omega_post_sim, y_aug_post_sim <span class="op">=</span> <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span></a>
<a class="sourceLine" id="cb32-15" data-line-number="15">nb_ny_posterior_samples <span class="op">=</span> {theta_label: [[]], phi_W_label: [[]], omega_label: [[]]}</a>
<a class="sourceLine" id="cb32-16" data-line-number="16"></a>
<a class="sourceLine" id="cb32-17" data-line-number="17">V_t_sim <span class="op">=</span> np.reciprocal(omega_0)</a>
<a class="sourceLine" id="cb32-18" data-line-number="18">y_aug_sim <span class="op">=</span> y_aug_0</a>
<a class="sourceLine" id="cb32-19" data-line-number="19"></a>
<a class="sourceLine" id="cb32-20" data-line-number="20"><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5000</span>):</a>
<a class="sourceLine" id="cb32-21" data-line-number="21"></a>
<a class="sourceLine" id="cb32-22" data-line-number="22">    nb_ffbs_res <span class="op">=</span> nb_ffbs_dlm(</a>
<a class="sourceLine" id="cb32-23" data-line-number="23">        nb_dlm_ny_values[N_obs_tt],</a>
<a class="sourceLine" id="cb32-24" data-line-number="24">        nb_dlm_ny_values[N_theta_tt],</a>
<a class="sourceLine" id="cb32-25" data-line-number="25">        y_aug_sim,</a>
<a class="sourceLine" id="cb32-26" data-line-number="26">        nb_dlm_ny_values[G_tt],</a>
<a class="sourceLine" id="cb32-27" data-line-number="27">        nb_dlm_ny_values[F_tt],</a>
<a class="sourceLine" id="cb32-28" data-line-number="28">        V_t_sim,</a>
<a class="sourceLine" id="cb32-29" data-line-number="29">        nb_dlm_ny_values[r_tt])</a>
<a class="sourceLine" id="cb32-30" data-line-number="30"></a>
<a class="sourceLine" id="cb32-31" data-line-number="31">    theta_t_post_sim, phi_W_post_sim, omega_post_sim, y_aug_post_sim <span class="op">=</span> nb_ffbs_res</a>
<a class="sourceLine" id="cb32-32" data-line-number="32"></a>
<a class="sourceLine" id="cb32-33" data-line-number="33">    phi_W_tt.set_value(phi_W_post_sim)</a>
<a class="sourceLine" id="cb32-34" data-line-number="34">    omega_t_tt.set_value(omega_post_sim)</a>
<a class="sourceLine" id="cb32-35" data-line-number="35"></a>
<a class="sourceLine" id="cb32-36" data-line-number="36">    V_t_sim <span class="op">=</span> np.reciprocal(omega_post_sim)</a>
<a class="sourceLine" id="cb32-37" data-line-number="37">    y_aug_sim <span class="op">=</span> y_aug_post_sim</a>
<a class="sourceLine" id="cb32-38" data-line-number="38"></a>
<a class="sourceLine" id="cb32-39" data-line-number="39">    nb_ny_posterior_samples[theta_label][chain].append(theta_t_post_sim)</a>
<a class="sourceLine" id="cb32-40" data-line-number="40">    nb_ny_posterior_samples[phi_W_label][chain].append(phi_W_post_sim)</a>
<a class="sourceLine" id="cb32-41" data-line-number="41">    nb_ny_posterior_samples[omega_label][chain].append(omega_post_sim)</a>
<a class="sourceLine" id="cb32-42" data-line-number="42"></a>
<a class="sourceLine" id="cb32-43" data-line-number="43">    <span class="bu">print</span>(<span class="ss">f&#39;i=</span><span class="sc">{i}</span><span class="ss">,</span><span class="ch">\t</span><span class="ss">phi_W=</span><span class="sc">{</span>phi_W_post_sim<span class="sc">}</span><span class="ss">&#39;</span>)</a>
<a class="sourceLine" id="cb32-44" data-line-number="44"></a>
<a class="sourceLine" id="cb32-45" data-line-number="45"><span class="co"># Convert and thin samples</span></a>
<a class="sourceLine" id="cb32-46" data-line-number="46">nb_ny_posterior_samples <span class="op">=</span> {k: np.asarray(v)[:, <span class="dv">1000</span>:] <span class="cf">for</span> k,v <span class="kw">in</span> nb_ny_posterior_samples.items()}</a></code></pre></div>
<figcaption>
Listing 32
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="im">import</span> arviz <span class="im">as</span> az</a>
<a class="sourceLine" id="cb33-2" data-line-number="2"></a>
<a class="sourceLine" id="cb33-3" data-line-number="3">az_trace <span class="op">=</span> az.from_dict(posterior<span class="op">=</span>nb_ny_posterior_samples)</a>
<a class="sourceLine" id="cb33-4" data-line-number="4">az.plot_trace(az_trace, compact<span class="op">=</span><span class="va">True</span>)</a></code></pre></div>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/nb-ffbs-ny-trace-plot.png" alt="Posterior sample traces for the NY data. " />
<figcaption>
Posterior sample traces for the NY data.
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb34-1" data-line-number="1">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb34-2" data-line-number="2"></a>
<a class="sourceLine" id="cb34-3" data-line-number="3">thetas_shape <span class="op">=</span> nb_ny_posterior_samples[theta_label][<span class="dv">0</span>].shape</a>
<a class="sourceLine" id="cb34-4" data-line-number="4"></a>
<a class="sourceLine" id="cb34-5" data-line-number="5">cycle <span class="op">=</span> ax._get_lines.prop_cycler</a>
<a class="sourceLine" id="cb34-6" data-line-number="6"></a>
<a class="sourceLine" id="cb34-7" data-line-number="7">bivariate_obs_cycler <span class="op">=</span>  cycler(<span class="st">&#39;linestyle&#39;</span>, [<span class="st">&#39;-&#39;</span>, <span class="st">&#39;--&#39;</span>]) <span class="op">*</span> cycler(<span class="st">&#39;color&#39;</span>, [<span class="st">&#39;black&#39;</span>])</a>
<a class="sourceLine" id="cb34-8" data-line-number="8"></a>
<a class="sourceLine" id="cb34-9" data-line-number="9">ax.set_prop_cycle(bivariate_obs_cycler)</a>
<a class="sourceLine" id="cb34-10" data-line-number="10"></a>
<a class="sourceLine" id="cb34-11" data-line-number="11"><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(thetas_shape[<span class="op">-</span><span class="dv">1</span>]):</a>
<a class="sourceLine" id="cb34-12" data-line-number="12"></a>
<a class="sourceLine" id="cb34-13" data-line-number="13">    styles <span class="op">=</span> <span class="bu">next</span>(cycle)</a>
<a class="sourceLine" id="cb34-14" data-line-number="14">    thetas <span class="op">=</span> nb_ny_posterior_samples[theta_label][<span class="dv">0</span>].T[d].T</a>
<a class="sourceLine" id="cb34-15" data-line-number="15"></a>
<a class="sourceLine" id="cb34-16" data-line-number="16">    theta_lines <span class="op">=</span> np.empty(thetas_shape[:<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> (<span class="dv">2</span>,))</a>
<a class="sourceLine" id="cb34-17" data-line-number="17">    theta_lines.T[<span class="dv">0</span>] <span class="op">=</span> np.tile(np.arange(thetas_shape[<span class="op">-</span><span class="dv">2</span>]), [thetas_shape[<span class="op">-</span><span class="dv">3</span>], <span class="dv">1</span>]).T</a>
<a class="sourceLine" id="cb34-18" data-line-number="18">    theta_lines.T[<span class="dv">1</span>] <span class="op">=</span> thetas.T</a>
<a class="sourceLine" id="cb34-19" data-line-number="19"></a>
<a class="sourceLine" id="cb34-20" data-line-number="20">    ax.add_collection(</a>
<a class="sourceLine" id="cb34-21" data-line-number="21">        LineCollection(theta_lines,</a>
<a class="sourceLine" id="cb34-22" data-line-number="22">                       label<span class="op">=</span>theta_label,</a>
<a class="sourceLine" id="cb34-23" data-line-number="23">                       alpha<span class="op">=</span><span class="fl">0.05</span>, linewidth<span class="op">=</span><span class="fl">0.9</span>,</a>
<a class="sourceLine" id="cb34-24" data-line-number="24">                       <span class="op">**</span>styles)</a>
<a class="sourceLine" id="cb34-25" data-line-number="25">    )</a>
<a class="sourceLine" id="cb34-26" data-line-number="26"></a>
<a class="sourceLine" id="cb34-27" data-line-number="27">ax.autoscale(enable<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb34-28" data-line-number="28">plt.tight_layout()</a>
<a class="sourceLine" id="cb34-29" data-line-number="29"></a>
<a class="sourceLine" id="cb34-30" data-line-number="30">plt.legend(framealpha<span class="op">=</span><span class="fl">0.4</span>)</a></code></pre></div>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/nb-ffbs-ny-sim-plot.png" alt="Posterior \theta_t samples for the negative-binomial NY data model. " />
<figcaption>
Posterior <span class="math inline">\(\theta_t\)</span> samples for the negative-binomial NY data model.
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="im">import</span> scipy</a>
<a class="sourceLine" id="cb35-2" data-line-number="2"></a>
<a class="sourceLine" id="cb35-3" data-line-number="3"></a>
<a class="sourceLine" id="cb35-4" data-line-number="4">plt.close(<span class="st">&#39;all&#39;</span>)</a>
<a class="sourceLine" id="cb35-5" data-line-number="5"></a>
<a class="sourceLine" id="cb35-6" data-line-number="6">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb35-7" data-line-number="7"></a>
<a class="sourceLine" id="cb35-8" data-line-number="8">ax.plot(counts.new_positive_tests.values, label<span class="op">=</span><span class="vs">r&#39;$y_t$&#39;</span>, linewidth<span class="op">=</span><span class="fl">1.0</span>, color<span class="op">=</span><span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb35-9" data-line-number="9"></a>
<a class="sourceLine" id="cb35-10" data-line-number="10">mu_t_sim <span class="op">=</span> np.exp(np.dot(nb_ny_posterior_samples[theta_label][<span class="dv">0</span>], nb_dlm_ny_values[F_tt].squeeze()))</a>
<a class="sourceLine" id="cb35-11" data-line-number="11">p_t_sim <span class="op">=</span> mu_t_sim <span class="op">/</span> (mu_t_sim <span class="op">+</span> nb_dlm_ny_values[r_tt])</a>
<a class="sourceLine" id="cb35-12" data-line-number="12"></a>
<a class="sourceLine" id="cb35-13" data-line-number="13">y_t_sim <span class="op">=</span> scipy.stats.nbinom.rvs(nb_dlm_ny_values[r_tt], (<span class="fl">1.</span> <span class="op">-</span> p_t_sim)).squeeze()</a>
<a class="sourceLine" id="cb35-14" data-line-number="14"></a>
<a class="sourceLine" id="cb35-15" data-line-number="15">y_t_lines <span class="op">=</span> np.empty(y_t_sim.shape <span class="op">+</span> (<span class="dv">2</span>,))</a>
<a class="sourceLine" id="cb35-16" data-line-number="16">y_t_lines.T[<span class="dv">0</span>] <span class="op">=</span> np.tile(np.arange(y_t_sim.shape[<span class="dv">1</span>]), [y_t_sim.shape[<span class="dv">0</span>], <span class="dv">1</span>]).T</a>
<a class="sourceLine" id="cb35-17" data-line-number="17">y_t_lines.T[<span class="dv">1</span>] <span class="op">=</span> y_t_sim.T</a>
<a class="sourceLine" id="cb35-18" data-line-number="18"></a>
<a class="sourceLine" id="cb35-19" data-line-number="19">ax.add_collection(</a>
<a class="sourceLine" id="cb35-20" data-line-number="20">    LineCollection(y_t_lines,</a>
<a class="sourceLine" id="cb35-21" data-line-number="21">                   label<span class="op">=</span><span class="vs">r&#39;$y_t \mid \theta_t, D_T$&#39;</span>,</a>
<a class="sourceLine" id="cb35-22" data-line-number="22">                   alpha<span class="op">=</span><span class="fl">0.3</span>, linewidth<span class="op">=</span><span class="fl">0.9</span>, color<span class="op">=</span><span class="st">&#39;red&#39;</span>),</a>
<a class="sourceLine" id="cb35-23" data-line-number="23">)</a>
<a class="sourceLine" id="cb35-24" data-line-number="24"></a>
<a class="sourceLine" id="cb35-25" data-line-number="25">ax.autoscale(enable<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb35-26" data-line-number="26">plt.tight_layout()</a>
<a class="sourceLine" id="cb35-27" data-line-number="27"></a>
<a class="sourceLine" id="cb35-28" data-line-number="28">plt.legend(framealpha<span class="op">=</span><span class="fl">0.4</span>)</a></code></pre></div>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/figures/nb-ffbs-ny-pred-plot.png" alt="Posterior predictive values for the negative-binomial NY data model. " />
<figcaption>
Posterior predictive values for the negative-binomial NY data model.
</figcaption>
</figure>
<p><a id="org24da3be"></a></p>
</section>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>We’ve implemented a highly extensible Bayesian timeseries framework with respectable model coverage (e.g. ARIMA models, polynomial trends, Fourier seasonality, dynamic regression, etc.), and shown how such a basic class can be extended to non-Gaussian observations. Additionally, we were able to show how an existing model-specialized sampler, i.e. FFBS, can be adapted alongside such an extension using the conditional linearity provided by a Gaussian scale-mixture.</p>
<p>In general, the same scale-mixture and conditional linearity techniques can be employed for other observation distributions (e.g. Beta, Binomial), as well as state-of-the-art shrinkage and sparsity priors <a id="4902d622d6ba9f93a92f53f2df8a726b"><a href="#BhadraDefaultBayesiananalysis2016">(Bhadra, Datta, Polson &amp; Willard 2016)</a></a>,<a id="4d6738c60064f8c0e0d27f8cd67cff8c"><a href="#datta2016bayesian">(Datta &amp; Dunson 2016)</a></a>.</p>
<p>Although we used Gibbs sampling, these techniques do not necessitate it; one can use Metropolis–or any other mathematically sound–steps instead.</p>
<p>Bayesian frameworks like these have considerable flexibility and are amenable to much analytic creativity; unfortunately, we don’t often see this–directly, at least–in practice. There are clearly some roadblocks to the average applied statistics/data science developer when attempting to implement these models straight from published papers. Those roadblocks often involve subtle numeric stability issues and a sometimes non-standard mathematics proficiency.</p>
<p>We hope that future automations will be able to address more straight-forward numerical stability issues by–for instance–automating the SVD-based reformulations used herein. The scale mixture manipulations are likewise amenable to certain automations, but, at the very least, it would serve the Bayesian community–and all who desire to construct non-trivial principled statistical models–well to develop low-level tools that codify and generate such scale-mixture variations. In this way, even experimentation by knowledgeable developers will be much easier and less error-prone.</p>
</section>
<section id="bibliography" class="level1">
<h1>Bibliography</h1>
<p><a id="harrison_bayesian_1999"></a> Harrison &amp; West, Bayesian Forecasting &amp; Dynamic Models, Springer (1999). <a href="#4bbd465b4e78e5c5151b0cbba54d984e">↩</a></p>
<p><a id="PetrisDynamicLinearModels2009"></a> Petris, Petrone &amp; Campagnoli, Dynamic Linear Models, Springer (2009). <a href="#1c3f471fd137724bd53b01eb4d6534fe">↩</a></p>
<p><a id="GamermanMarkovchainMonte2006"></a> Gamerman &amp; Lopes, Markov Chain Monte Carlo: Stochastic Simulation for Bayesian Inference, CRC Press (2006). <a href="#8247a823e73eba801aad2942a49b03be">↩</a></p>
<p><a id="pole_applied_1994"></a> Pole, West &amp; Harrison, Applied Bayesian Forecasting and Time Series Analysis, CRC Press (1994). <a href="#c6a5d83a82b5963f42264d85625b5153">↩</a></p>
<p><a id="bergstra_theano:_2010"></a> Bergstra, Breuleux, Bastien, Lamblin, Pascanu, Desjardins, Turian, Warde-Farley &amp; Bengio, Theano: A CPU and GPU Math Expression Compiler, in in: Proceedings of the Python for Scientific Computing Conference (SciPy), edited by (2010) <a href="#25fdcab375e353d7bb32eec7b13064c6">↩</a></p>
<p><a id="Willardsymbolicpymc2019"></a> Willard, Symbolic-Pymc, <i></i>, (2019). <a href="https://github.com/pymc-devs/symbolic-pymc">link</a>. <a href="#e8fa26b92264fca946be25e6b617fc56">↩</a></p>
<p><a id="ZhangFixedintervalsmoothingalgorithm1996"></a> Zhang &amp; Li, Fixed-Interval Smoothing Algorithm Based on Singular Value Decomposition, 916–921, in in: , Proceedings of the 1996 IEEE International Conference on Control Applications, 1996, edited by (1996) <a href="#0ae04c048b20d07f32d7f0f75bb51483">↩</a></p>
<p><a id="PetrisDynamiclinearmodels2009"></a> Petris, Petrone &amp; Campagnoli, Dynamic Linear Models, Springer (2009). <a href="#3a4d89388a434d7b1b91dc8690f3a03b">↩</a></p>
<p><a id="Fruhwirth-SchnatterDataaugmentationdynamic1994"></a> Fr&quot;uhwirth-Schnatter, Data Augmentation and Dynamic Linear Models, <i>Journal of time series analysis</i>, <b>15(2)</b>, 183–202 (1994). <a href="http://onlinelibrary.wiley.com/doi/10.1111/j.1467-9892.1994.tb00184.x/abstract">link</a>. <a href="#66fb99775f308e808a193bd7bb2d2038">↩</a></p>
<p><a id="mccullagh_generalized_1989"></a> McCullagh &amp; Nelder, Generalized Linear Models, CRC press (1989). <a href="#820d466dbb5494bd5a5cb080d0b82638">↩</a></p>
<p><a id="polson_bayesian_2013"></a> Polson, Scott &amp; Windle, Bayesian Inference for Logistic Models Using P'olyaLatent Variables, <i>Journal of the American Statistical Association</i>, <b>108(504)</b>, 1339–1349 (2013). <a href="http://www.tandfonline.com/doi/abs/10.1080/01621459.2013.829001">link</a>. <a href="#2776c69c558410bc65a3a0a0f1ff5bf4">↩</a></p>
<p><a id="BhadraDefaultBayesiananalysis2016"></a> Bhadra, Datta, Polson &amp; Willard, Default Bayesian analysis with global-local shrinkage priors, <i>Biometrika</i>, <b>103(4)</b>, 955–969 (2016). <a href="http://dx.doi.org/10.1093/biomet/asw041">doi</a>. <a href="#4902d622d6ba9f93a92f53f2df8a726b">↩</a></p>
<p><a id="datta2016bayesian"></a> Datta &amp; Dunson, Bayesian Inference on Quasi-Sparse Count Data, <i>Biometrika</i>, <b>103(4)</b>, 971–983 (2016). <a href="#4d6738c60064f8c0e0d27f8cd67cff8c">↩</a></p>
</section>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  CommonHTML: { linebreaks: { automatic: true } },
  "HTML-CSS": { linebreaks: { automatic: true } },
  SVG: { linebreaks: { automatic: true } },
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
</body>
</html>

            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'brandonwillard-github-io'; // required: replace example with your forum shortname

                    var disqus_identifier = 'dynamic-linear-models-in-theano';
                var disqus_url = 'https://brandonwillard.github.io/dynamic-linear-models-in-theano.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="https://brandonwillard.github.io//images/profile-pic.png"/>
        </p>
    <p>
      <strong>About Brandon T. Willard</strong><br/>
        applied math/stats person
    </p>
</div><!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://github.com/brandonwillard"><i class="fa fa-github-square fa-lg"></i> github</a></li>
    <li class="list-group-item"><a href="https://scholar.google.com/citations?user=g0oUxG4AAAAJ&hl=en"><i class="ai ai-google-scholar ai-lg"></i> google scholar</a></li>
    <li class="list-group-item"><a href="https://www.linkedin.com/in/brandon-t-willard-468bb410/"><i class="fa fa-linkedin fa-lg"></i> linkedin</a></li>
    <li class="list-group-item"><a href="https://bitbucket.io/brandonwillard"><i class="fa fa-bitbucket-square fa-lg"></i> bitbucket</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Brandon T. Willard
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en">Creative Commons Attribution-NonCommercial 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://brandonwillard.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://brandonwillard.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://brandonwillard.github.io/theme/js/respond.min.js"></script>


    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'brandonwillard-github-io'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-91585967-1', '');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->


</body>
</html>