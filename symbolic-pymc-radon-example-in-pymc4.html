<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Symbolic PyMC Radon Example in PyMC4 - Brandon T. Willard</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://brandonwillard.github.io/symbolic-pymc-radon-example-in-pymc4.html">

        <meta name="author" content="Brandon T. Willard" />
        <meta name="keywords" content="pymc4,tensorflow,symbolic computation,python,symbolic-pymc" />

        <meta property="og:site_name" content="Brandon T. Willard" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Symbolic PyMC Radon Example in PyMC4"/>
        <meta property="og:url" content="https://brandonwillard.github.io/symbolic-pymc-radon-example-in-pymc4.html"/>
        <meta property="og:description" content=""/>
        <meta property="article:published_time" content="2019-09-08" />
            <meta property="article:section" content="articles" />
            <meta property="article:tag" content="pymc4" />
            <meta property="article:tag" content="tensorflow" />
            <meta property="article:tag" content="symbolic computation" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="symbolic-pymc" />
            <meta property="article:author" content="Brandon T. Willard" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://brandonwillard.github.io/theme/css/bootstrap.readable.min.css" type="text/css"/>
    <link href="https://brandonwillard.github.io/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://brandonwillard.github.io/theme/css/academicons.min.css" rel="stylesheet">

    <link href="https://brandonwillard.github.io/theme/css/pygments/vim.css" rel="stylesheet">
    <link rel="stylesheet" href="https://brandonwillard.github.io/theme/css/style.css" type="text/css"/>
        <link href="https://brandonwillard.github.io/extra/custom.css" rel="stylesheet">

        <link href="https://brandonwillard.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Brandon T. Willard ATOM Feed"/>

        <link href="https://brandonwillard.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Brandon T. Willard RSS Feed"/>


        <link href="https://brandonwillard.github.io/feeds/articles.atom.xml" type="application/atom+xml" rel="alternate"
              title="Brandon T. Willard articles ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://brandonwillard.github.io/" class="navbar-brand">
Brandon T. Willard            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://brandonwillard.github.io/pages/about.html">
                             About
                          </a></li>
                         <li><a href="https://brandonwillard.github.io/pages/projects.html">
                             Projects
                          </a></li>
                         <li><a href="https://brandonwillard.github.io/pages/publications.html">
                             Publications
                          </a></li>
                        <li class="active">
                            <a href="https://brandonwillard.github.io/category/articles.html">Articles</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://brandonwillard.github.io/symbolic-pymc-radon-example-in-pymc4.html"
                       rel="bookmark"
                       title="Permalink to Symbolic PyMC Radon Example in PyMC4">
                        Symbolic PyMC Radon Example in PyMC4
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2019-09-08T00:00:00-05:00"> Sun 08 September 2019</time>
    </span>
          <span class="label label-default">Modified</span>
            <span class="modified">
                <i class="fa fa-calendar"></i><time datetime="2019-10-18T00:00:00-05:00"> Fri 18 October 2019</time>
            </span>





<span class="label label-default">Tags</span>
	<a href="https://brandonwillard.github.io/tag/pymc4.html">pymc4</a>
        /
	<a href="https://brandonwillard.github.io/tag/tensorflow.html">tensorflow</a>
        /
	<a href="https://brandonwillard.github.io/tag/symbolic-computation.html">symbolic computation</a>
        /
	<a href="https://brandonwillard.github.io/tag/python.html">python</a>
        /
	<a href="https://brandonwillard.github.io/tag/symbolic-pymc.html">symbolic-pymc</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Brandon T. Willard" />
  <title>Symbolic PyMC Radon Example in PyMC4</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
</head>
<body>
<!--  -->
<!-- <div id="header"> -->
<!-- <h1 class="title">Symbolic PyMC Radon Example in PyMC4</h1> -->
<!--  -->
<!--  -->
<!-- <h2 class="author">Brandon T. Willard</h2> -->
<!--  -->
<!--  -->
<!-- <h3 class="date">2019–09–08</h3> -->
<!--  -->
<!-- </div> -->
<!--  -->
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p><a href="https://github.com/pymc-devs/symbolic-pymc">Symbolic PyMC</a> is a library that provides tools for symbolic manipulation of Tensor library models in TensorFlow and Theano. Over time, we plan to add tools that are somewhat specialized toward Bayesian model manipulation and the mathematical identities relevant to model manipulation for MCMC.</p>
<p>The main approach taken by Symbolic PyMC is relational/logic programming powered by a <a href="http://minikanren.org/">miniKanren</a> implementation in pure Python based on <a href="https://github.com/pymc-devs/kanren"><code>kanren</code></a>.</p>
<p>As an example of Symbolic PyMC’s usage, we will create a model “optimizer” that approximates the re-centering and re-scaling commonly demonstrated with the radon dataset. This example already exists for Theano in PyMC3 and can be found in the <a href="https://github.com/pymc-devs/symbolic-pymc#automatic-re-centering-and-re-scaling">project README</a>. Here, we will operate on TensorFlow graphs via PyMC4 and approximate the same optimization using a very different approach targeted toward the log-likelihood graph.</p>
<p>To get started, we download the radon dataset and define the un-centered model in Listings <a href="#orgb52aa39">1</a>, <a href="#org84a4bd7">2</a>, and <a href="#orgf0b697c">3</a>.</p>
<div class="sourceCode" id="orgb52aa39"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgb52aa39-1" data-line-number="1"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="orgb52aa39-2" data-line-number="2"><span class="im">import</span> pandas <span class="im">as</span> pd</a>
<a class="sourceLine" id="orgb52aa39-3" data-line-number="3"><span class="im">import</span> tensorflow <span class="im">as</span> tf</a>
<a class="sourceLine" id="orgb52aa39-4" data-line-number="4"></a>
<a class="sourceLine" id="orgb52aa39-5" data-line-number="5"><span class="im">import</span> pymc4 <span class="im">as</span> pm</a>
<a class="sourceLine" id="orgb52aa39-6" data-line-number="6"><span class="im">import</span> arviz <span class="im">as</span> az</a></code></pre></div>
<div class="sourceCode" id="org84a4bd7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org84a4bd7-1" data-line-number="1">data <span class="op">=</span> pd.read_csv(<span class="st">&#39;https://github.com/pymc-devs/pymc3/raw/master/pymc3/examples/data/radon.csv&#39;</span>)</a>
<a class="sourceLine" id="org84a4bd7-2" data-line-number="2"></a>
<a class="sourceLine" id="org84a4bd7-3" data-line-number="3">county_names <span class="op">=</span> data.county.unique()</a>
<a class="sourceLine" id="org84a4bd7-4" data-line-number="4">county_idx <span class="op">=</span> data[<span class="st">&#39;county_code&#39;</span>].values.astype(np.int32)</a></code></pre></div>
<div class="sourceCode" id="orgf0b697c"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgf0b697c-1" data-line-number="1"><span class="at">@pm.model</span></a>
<a class="sourceLine" id="orgf0b697c-2" data-line-number="2"><span class="kw">def</span> hierarchical_model(data, county_idx):</a>
<a class="sourceLine" id="orgf0b697c-3" data-line-number="3">    <span class="co"># Hyperpriors</span></a>
<a class="sourceLine" id="orgf0b697c-4" data-line-number="4">    mu_a <span class="op">=</span> <span class="cf">yield</span> pm.Normal(<span class="st">&#39;mu_alpha&#39;</span>, mu<span class="op">=</span><span class="fl">0.</span>, sigma<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="orgf0b697c-5" data-line-number="5">    sigma_a <span class="op">=</span> <span class="cf">yield</span> pm.HalfCauchy(<span class="st">&#39;sigma_alpha&#39;</span>, beta<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="orgf0b697c-6" data-line-number="6">    mu_b <span class="op">=</span> <span class="cf">yield</span> pm.Normal(<span class="st">&#39;mu_beta&#39;</span>, mu<span class="op">=</span><span class="fl">0.</span>, sigma<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="orgf0b697c-7" data-line-number="7">    sigma_b <span class="op">=</span> <span class="cf">yield</span> pm.HalfCauchy(<span class="st">&#39;sigma_beta&#39;</span>, beta<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="orgf0b697c-8" data-line-number="8"></a>
<a class="sourceLine" id="orgf0b697c-9" data-line-number="9">    <span class="co"># Intercept for each county, distributed around group mean mu_a</span></a>
<a class="sourceLine" id="orgf0b697c-10" data-line-number="10">    a <span class="op">=</span> <span class="cf">yield</span> pm.Normal(<span class="st">&#39;alpha&#39;</span>, mu<span class="op">=</span>mu_a, sigma<span class="op">=</span>sigma_a, plate<span class="op">=</span><span class="bu">len</span>(data.county.unique()))</a>
<a class="sourceLine" id="orgf0b697c-11" data-line-number="11">    <span class="co"># Intercept for each county, distributed around group mean mu_a</span></a>
<a class="sourceLine" id="orgf0b697c-12" data-line-number="12">    b <span class="op">=</span> <span class="cf">yield</span> pm.Normal(<span class="st">&#39;beta&#39;</span>, mu<span class="op">=</span>mu_b, sigma<span class="op">=</span>sigma_b, plate<span class="op">=</span><span class="bu">len</span>(data.county.unique()))</a>
<a class="sourceLine" id="orgf0b697c-13" data-line-number="13"></a>
<a class="sourceLine" id="orgf0b697c-14" data-line-number="14">    <span class="co"># Model error</span></a>
<a class="sourceLine" id="orgf0b697c-15" data-line-number="15">    eps <span class="op">=</span> <span class="cf">yield</span> pm.HalfCauchy(<span class="st">&#39;eps&#39;</span>, beta<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="orgf0b697c-16" data-line-number="16"></a>
<a class="sourceLine" id="orgf0b697c-17" data-line-number="17">    <span class="co"># Expected value</span></a>
<a class="sourceLine" id="orgf0b697c-18" data-line-number="18">    <span class="co">#radon_est = a[county_idx] + b[county_idx] * data.floor.values</span></a>
<a class="sourceLine" id="orgf0b697c-19" data-line-number="19">    radon_est <span class="op">=</span> tf.gather(a, county_idx) <span class="op">+</span> tf.gather(</a>
<a class="sourceLine" id="orgf0b697c-20" data-line-number="20">        b, county_idx) <span class="op">*</span> data.floor.values</a>
<a class="sourceLine" id="orgf0b697c-21" data-line-number="21"></a>
<a class="sourceLine" id="orgf0b697c-22" data-line-number="22">    <span class="co"># Data likelihood</span></a>
<a class="sourceLine" id="orgf0b697c-23" data-line-number="23">    y_like <span class="op">=</span> <span class="cf">yield</span> pm.Normal(<span class="st">&#39;y_like&#39;</span>, mu<span class="op">=</span>radon_est, sigma<span class="op">=</span>eps, observed<span class="op">=</span>data.log_radon)</a>
<a class="sourceLine" id="orgf0b697c-24" data-line-number="24"></a>
<a class="sourceLine" id="orgf0b697c-25" data-line-number="25"></a>
<a class="sourceLine" id="orgf0b697c-26" data-line-number="26">init_num_chains <span class="op">=</span> <span class="dv">50</span></a>
<a class="sourceLine" id="orgf0b697c-27" data-line-number="27">model <span class="op">=</span> hierarchical_model(data, county_idx)</a></code></pre></div>
<p>In Listing <a href="#org76f5220">5</a>, we estimates the model using the sample routine from the <a href="https://github.com/pymc-devs/pymc4/blob/master/notebooks/radon_hierarchical.ipynb">PyMC4 Radon example Notebook</a> in Listing <a href="#org9df08c0">4</a>. The same plots are reproduce here in Figures <a href="#org2d6c05e">6</a> and <a href="#orgef38802">7</a>.</p>
<div class="sourceCode" id="org9df08c0"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org9df08c0-1" data-line-number="1"><span class="kw">def</span> sample(model, init_num_chains<span class="op">=</span><span class="dv">50</span>, num_samples<span class="op">=</span><span class="dv">500</span>, burn_in<span class="op">=</span><span class="dv">500</span>):</a>
<a class="sourceLine" id="org9df08c0-2" data-line-number="2">    init_num_chains <span class="op">=</span> <span class="dv">50</span></a>
<a class="sourceLine" id="org9df08c0-3" data-line-number="3">    pm4_trace, _ <span class="op">=</span> pm.inference.sampling.sample(</a>
<a class="sourceLine" id="org9df08c0-4" data-line-number="4">        model, num_chains<span class="op">=</span>init_num_chains, num_samples<span class="op">=</span><span class="dv">10</span>, burn_in<span class="op">=</span><span class="dv">10</span>, step_size<span class="op">=</span><span class="fl">1.</span>, xla<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="org9df08c0-5" data-line-number="5">    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</a>
<a class="sourceLine" id="org9df08c0-6" data-line-number="6">        step_size_ <span class="op">=</span> []</a>
<a class="sourceLine" id="org9df08c0-7" data-line-number="7">        <span class="cf">for</span> _, x <span class="kw">in</span> pm4_trace.items():</a>
<a class="sourceLine" id="org9df08c0-8" data-line-number="8">            std <span class="op">=</span> tf.math.reduce_std(x, axis<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>])</a>
<a class="sourceLine" id="org9df08c0-9" data-line-number="9">            step_size_.append(</a>
<a class="sourceLine" id="org9df08c0-10" data-line-number="10">                std[tf.newaxis, ...] <span class="op">*</span> tf.ones([init_num_chains] <span class="op">+</span> std.shape, dtype<span class="op">=</span>std.dtype))</a>
<a class="sourceLine" id="org9df08c0-11" data-line-number="11">        pm4_trace, _ <span class="op">=</span> pm.inference.sampling.sample(</a>
<a class="sourceLine" id="org9df08c0-12" data-line-number="12">            model, num_chains<span class="op">=</span>init_num_chains, num_samples<span class="op">=</span><span class="dv">10</span> <span class="op">+</span> <span class="dv">10</span><span class="op">*</span>i, burn_in<span class="op">=</span><span class="dv">10</span> <span class="op">+</span> <span class="dv">10</span><span class="op">*</span>i,</a>
<a class="sourceLine" id="org9df08c0-13" data-line-number="13">            step_size<span class="op">=</span>step_size_, xla<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="org9df08c0-14" data-line-number="14"></a>
<a class="sourceLine" id="org9df08c0-15" data-line-number="15">    num_chains <span class="op">=</span> <span class="dv">5</span></a>
<a class="sourceLine" id="org9df08c0-16" data-line-number="16">    step_size_ <span class="op">=</span> []</a>
<a class="sourceLine" id="org9df08c0-17" data-line-number="17">    <span class="cf">for</span> _, x <span class="kw">in</span> pm4_trace.items():</a>
<a class="sourceLine" id="org9df08c0-18" data-line-number="18">        std <span class="op">=</span> tf.math.reduce_std(x, axis<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>])</a>
<a class="sourceLine" id="org9df08c0-19" data-line-number="19">        step_size_.append(</a>
<a class="sourceLine" id="org9df08c0-20" data-line-number="20">            std[tf.newaxis, ...] <span class="op">*</span> tf.ones([num_chains]<span class="op">+</span>std.shape, dtype<span class="op">=</span>std.dtype))</a>
<a class="sourceLine" id="org9df08c0-21" data-line-number="21"></a>
<a class="sourceLine" id="org9df08c0-22" data-line-number="22">    pm4_trace, sample_stat <span class="op">=</span> pm.inference.sampling.sample(</a>
<a class="sourceLine" id="org9df08c0-23" data-line-number="23">        model, num_chains<span class="op">=</span>num_chains, num_samples<span class="op">=</span>num_samples, burn_in<span class="op">=</span>burn_in,</a>
<a class="sourceLine" id="org9df08c0-24" data-line-number="24">        step_size<span class="op">=</span>step_size_, xla<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="org9df08c0-25" data-line-number="25"></a>
<a class="sourceLine" id="org9df08c0-26" data-line-number="26">    az_trace <span class="op">=</span> pm.inference.utils.trace_to_arviz(pm4_trace, sample_stat)</a>
<a class="sourceLine" id="org9df08c0-27" data-line-number="27"></a>
<a class="sourceLine" id="org9df08c0-28" data-line-number="28">    <span class="cf">return</span> az_trace</a></code></pre></div>
<div class="sourceCode" id="org76f5220"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org76f5220-1" data-line-number="1">az_trace <span class="op">=</span> sample(model)</a></code></pre></div>
<div class="sourceCode" id="org6569169"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org6569169-1" data-line-number="1"><span class="im">import</span> arviz <span class="im">as</span> az</a>
<a class="sourceLine" id="org6569169-2" data-line-number="2"><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</a>
<a class="sourceLine" id="org6569169-3" data-line-number="3"></a>
<a class="sourceLine" id="org6569169-4" data-line-number="4"><span class="im">import</span> seaborn <span class="im">as</span> sns</a>
<a class="sourceLine" id="org6569169-5" data-line-number="5"></a>
<a class="sourceLine" id="org6569169-6" data-line-number="6"><span class="im">from</span> matplotlib <span class="im">import</span> rcParams</a>
<a class="sourceLine" id="org6569169-7" data-line-number="7"></a>
<a class="sourceLine" id="org6569169-8" data-line-number="8"></a>
<a class="sourceLine" id="org6569169-9" data-line-number="9">rcParams[<span class="st">&#39;figure.figsize&#39;</span>] <span class="op">=</span> (<span class="fl">11.7</span>, <span class="fl">8.27</span>)</a>
<a class="sourceLine" id="org6569169-10" data-line-number="10"></a>
<a class="sourceLine" id="org6569169-11" data-line-number="11"><span class="co"># plt.rc(&#39;text&#39;, usetex=True)</span></a>
<a class="sourceLine" id="org6569169-12" data-line-number="12">sns.set_style(<span class="st">&quot;whitegrid&quot;</span>)</a>
<a class="sourceLine" id="org6569169-13" data-line-number="13">sns.set_context(<span class="st">&quot;paper&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="orgdd90ae2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgdd90ae2-1" data-line-number="1">_ <span class="op">=</span> az.plot_energy(az_trace)</a></code></pre></div>
<figure id="fig:pymc4-radon-plot-energy">
<img src="https://brandonwillard.github.io/figures/pymc4-radon-plot-energy.png" alt="" />
<figcaption>
</figcaption>
</figure>
<figure id="fig:pymc4-radon-plot-trace">
<img src="https://brandonwillard.github.io/figures/pymc4-radon-plot-trace.png" alt="" />
<figcaption>
</figcaption>
</figure>
</section>
<section id="applying-an-optimization" class="level1">
<h1>Applying an Optimization</h1>
<p>In order to apply our optimization, we need to do some work to obtain a graph of the log-likelihood function generated by the model in Listing <a href="#orgf0b697c">3</a>. With the graph in-hand, we can perform the re-centering and re-scaling transform–in log-space this time–and obtain a new log-likelihood graph from which better samples can be generated.</p>
<p>This exercise introduces the TensorFlow function-graph elements that mirror Theano’s <code>tt.function</code> and <code>FunctionGraph</code>s: <code>tensorflow.python.framework.func_graph.FuncGraph</code>. <code>FuncGraph</code> is a subclass of the regular <code>Graph</code> objects upon which implicitly <code>symbolic_pymc</code> operates. Just as with Theano’s <code>FunctionGraph</code>s, <code>FuncGraph</code> simply specializes a graph by specifying inputs and outputs from elements (i.e. tensors) within a graph.</p>
</section>
<section id="log-likelihood-funcgraphs" class="level1">
<h1>Log-likelihood <code>FuncGraph</code>s</h1>
<p>In Listing <a href="#orgc606190">8</a>, we build the log-likelihood function for our model and a corresponding list of initial values for the parameters.</p>
<div class="sourceCode" id="orgc606190"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgc606190-1" data-line-number="1">state <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="orgc606190-2" data-line-number="2">observed <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="orgc606190-3" data-line-number="3"></a>
<a class="sourceLine" id="orgc606190-4" data-line-number="4">logpfn, init <span class="op">=</span> pm.inference.sampling.build_logp_function(model,</a>
<a class="sourceLine" id="orgc606190-5" data-line-number="5">                                                         state<span class="op">=</span>state,</a>
<a class="sourceLine" id="orgc606190-6" data-line-number="6">                                                         observed<span class="op">=</span>observed)</a></code></pre></div>
<p>From here we need <code>FuncGraph</code>s for each input to <code>logpfn</code>. Since <code>logpfn</code> is a <code>tensorflow.python.eager.def_function.Function</code> instance, every time it’s called with a specific tensor it may create a new function-object with it’s own <code>FuncGraph</code>. In other words, it dynamically generates function objects based on the inputs it’s given.</p>
<p>This specialization process can be performed manually using <code>logpfn.get_concrete_function(*args)</code>, which necessarily produces a <code>tensorflow.python.eager.function.ConcreteFunction</code> with the desired <code>FuncGraph</code>. Listing <a href="#org966cccf">9</a> creates and extracts these two objects.</p>
<div class="sourceCode" id="org966cccf"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org966cccf-1" data-line-number="1">logpfn_cf <span class="op">=</span> logpfn.get_concrete_function(<span class="op">*</span>init.values())</a>
<a class="sourceLine" id="org966cccf-2" data-line-number="2">logpfn_fg <span class="op">=</span> logpfn_cf.graph</a></code></pre></div>
<p>The outputs are now available in graph form as <code>logpfn_fg.outputs</code>. The inputs aren’t mapped in this particular function-graph output. I believe there’s a way to generate those as TF placeholders.</p>
</section>
<section id="the-log-space-transform" class="level1">
<h1>The Log-space Transform</h1>
<p>Consider the following two equivalent hierarchical models,</p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    Y = X + \epsilon, \quad
    \epsilon \sim \operatorname{N}\left(0, 1\right)
    \\
    X \sim \operatorname{N}\left(\mu, \sigma^2\right)
  \end{gathered}
\label{eq:model-1}
\end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    Y = \mu + \sigma \cdot \tilde{X} + \epsilon, \quad
    \epsilon \sim \operatorname{N}\left(0, 1\right)
    \\
    \tilde{X} \sim \operatorname{N}\left(0, 1\right)
  \;.
  \end{gathered}
\label{eq:model-2}
\end{equation}\]</span></p>
<p>Models <span class="math inline">\(\eqref{eq:model-1}\)</span> and <span class="math inline">\(\eqref{eq:model-2}\)</span> are represented in (log) measure space, respectively, as follows:</p>
<p><span class="math display">\[\begin{align}
    \log P(Y, X) &amp;= \log P(Y\mid X) + \log P(X)
    \nonumber
    \\
    &amp;= C - \frac{1}{2} \left(y - x\right)^2 - \frac{1}{2 \sigma^2} \left(x - \mu\right)^2
    \label{eq:log-model-1}
    \\
    &amp;= \tilde{C} - \frac{1}{2} \left(y - \mu - \sigma \cdot \tilde{x}\right)^2 - \frac{1}{2} \tilde{x}^2
  \label{eq:log-model-2}
  \;.
\end{align}\]</span></p>
<p>Via term rewriting, Equation <span class="math inline">\(\eqref{eq:log-model-2}\)</span> is produced by first applying the replacement rule <span class="math inline">\(x \to \mu + \sigma \cdot \tilde{x}\)</span> to Equation <span class="math inline">\(\eqref{eq:log-model-1}\)</span>, which produces</p>
<p><span class="math display">\[\begin{align*}
C - \frac{1}{2} \left(y - (\mu + \sigma \cdot \tilde{x})\right)^2 - \frac{1}{2 \sigma^2} \left((\mu + \sigma \cdot \tilde{x}) - \mu\right)^2
\;.
\end{align*}\]</span></p>
<p>After a few applications of some simple algebraic properties–as further replacement rules–one obtains the exact form of Equation <span class="math inline">\(\eqref{eq:log-model-2}\)</span>. Here, we’ll focus only on applying the initial replacement rule.</p>
<p>In our case, the log-density returned by PyMC4–via the TensorFlow Probability library (TFP)– uses <code>tf.math.squared_difference</code> to construct the “squared error” term in the exponential of a normal distribution. Listing <a href="#orgc47d26d">10</a> shows the graph produced by a normal distribution in TFP.</p>
<div class="sourceCode" id="orgc47d26d"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgc47d26d-1" data-line-number="1"><span class="im">import</span> tensorflow_probability <span class="im">as</span> tfp</a>
<a class="sourceLine" id="orgc47d26d-2" data-line-number="2"></a>
<a class="sourceLine" id="orgc47d26d-3" data-line-number="3"><span class="im">from</span> tensorflow.python.eager.context <span class="im">import</span> graph_mode</a>
<a class="sourceLine" id="orgc47d26d-4" data-line-number="4"><span class="im">from</span> tensorflow.python.framework.ops <span class="im">import</span> disable_tensor_equality</a>
<a class="sourceLine" id="orgc47d26d-5" data-line-number="5"></a>
<a class="sourceLine" id="orgc47d26d-6" data-line-number="6"><span class="im">from</span> symbolic_pymc.tensorflow.printing <span class="im">import</span> tf_dprint</a>
<a class="sourceLine" id="orgc47d26d-7" data-line-number="7"></a>
<a class="sourceLine" id="orgc47d26d-8" data-line-number="8"></a>
<a class="sourceLine" id="orgc47d26d-9" data-line-number="9">disable_tensor_equality()</a>
<a class="sourceLine" id="orgc47d26d-10" data-line-number="10"></a>
<a class="sourceLine" id="orgc47d26d-11" data-line-number="11"><span class="cf">with</span> graph_mode(), tf.Graph().as_default() <span class="im">as</span> test_graph:</a>
<a class="sourceLine" id="orgc47d26d-12" data-line-number="12">    mu_tf <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, name<span class="op">=</span><span class="st">&#39;mu&#39;</span>,</a>
<a class="sourceLine" id="orgc47d26d-13" data-line-number="13">                                     shape<span class="op">=</span>tf.TensorShape([<span class="va">None</span>]))</a>
<a class="sourceLine" id="orgc47d26d-14" data-line-number="14">    tau_tf <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, name<span class="op">=</span><span class="st">&#39;tau&#39;</span>,</a>
<a class="sourceLine" id="orgc47d26d-15" data-line-number="15">                                      shape<span class="op">=</span>tf.TensorShape([<span class="va">None</span>]))</a>
<a class="sourceLine" id="orgc47d26d-16" data-line-number="16"></a>
<a class="sourceLine" id="orgc47d26d-17" data-line-number="17">    normal_tfp <span class="op">=</span> tfp.distributions.normal.Normal(mu_tf, tau_tf)</a>
<a class="sourceLine" id="orgc47d26d-18" data-line-number="18"></a>
<a class="sourceLine" id="orgc47d26d-19" data-line-number="19">    value_tf <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, name<span class="op">=</span><span class="st">&#39;value&#39;</span>,</a>
<a class="sourceLine" id="orgc47d26d-20" data-line-number="20">                                        shape<span class="op">=</span>tf.TensorShape([<span class="va">None</span>]))</a>
<a class="sourceLine" id="orgc47d26d-21" data-line-number="21"></a>
<a class="sourceLine" id="orgc47d26d-22" data-line-number="22">    normal_log_lik <span class="op">=</span> normal_tfp.log_prob(value_tf)</a>
<a class="sourceLine" id="orgc47d26d-23" data-line-number="23"></a>
<a class="sourceLine" id="orgc47d26d-24" data-line-number="24">    tf_dprint(normal_log_lik)</a></code></pre></div>
<pre id="org8ee5799" class="text"><code>Tensor(Sub):0,  shape=[None]    &quot;Normal_1/log_prob/sub:0&quot;
|  Op(Sub)  &quot;Normal_1/log_prob/sub&quot;
|  |  Tensor(Mul):0,    shape=[None]    &quot;Normal_1/log_prob/mul:0&quot;
|  |  |  Op(Mul)    &quot;Normal_1/log_prob/mul&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;Normal_1/log_prob/mul/x:0&quot;
|  |  |  |  Tensor(SquaredDifference):0,    shape=[None]    &quot;Normal_1/log_prob/SquaredDifference:0&quot;
|  |  |  |  |  Op(SquaredDifference)    &quot;Normal_1/log_prob/SquaredDifference&quot;
|  |  |  |  |  |  Tensor(RealDiv):0,    shape=[None]    &quot;Normal_1/log_prob/truediv:0&quot;
|  |  |  |  |  |  |  Op(RealDiv)    &quot;Normal_1/log_prob/truediv&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;value:0&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;tau:0&quot;
|  |  |  |  |  |  Tensor(RealDiv):0,    shape=[None]    &quot;Normal_1/log_prob/truediv_1:0&quot;
|  |  |  |  |  |  |  Op(RealDiv)    &quot;Normal_1/log_prob/truediv_1&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;mu:0&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;tau:0&quot;
|  |  Tensor(AddV2):0,  shape=[None]    &quot;Normal_1/log_prob/add:0&quot;
|  |  |  Op(AddV2)  &quot;Normal_1/log_prob/add&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;Normal_1/log_prob/add/x:0&quot;
|  |  |  |  Tensor(Log):0,  shape=[None]    &quot;Normal_1/log_prob/Log:0&quot;
|  |  |  |  |  Op(Log)  &quot;Normal_1/log_prob/Log&quot;
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;tau:0&quot;

</code></pre>
<p>Instead of looking for the entire log-likelihood graph for a distribution, we can focus on only the <code>SquaredDifference</code> operators, since they contain all the relevant terms for our transformation.</p>
<p>More specifically, if we can identify “chains” of such terms, i.e. <code>SquaredDifference(y, x)</code> and <code>SquaredDifference(x, mu)</code>, then we might be able to assume that the corresponding subgraph was formed from such a hierarchical normal model.</p>
<p>Listing <a href="#orgacfcea8">12</a> shows the <code>SquaredDifference</code> sub-graphs in the log-likelihood graph for our radon model. It demonstrates two instances of said <code>SquaredDifference</code> “chains”: they involve tensors named <code>values_5</code> and <code>values_1</code>.</p>
<div class="sourceCode" id="orgacfcea8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgacfcea8-1" data-line-number="1">square_diff_outs <span class="op">=</span> [o <span class="cf">for</span> o <span class="kw">in</span> logpfn_fg.get_operations()</a>
<a class="sourceLine" id="orgacfcea8-2" data-line-number="2">                    <span class="cf">if</span> o.<span class="bu">type</span> <span class="op">==</span> <span class="st">&#39;SquaredDifference&#39;</span>]</a>
<a class="sourceLine" id="orgacfcea8-3" data-line-number="3"></a>
<a class="sourceLine" id="orgacfcea8-4" data-line-number="4"><span class="cf">for</span> t <span class="kw">in</span> square_diff_outs:</a>
<a class="sourceLine" id="orgacfcea8-5" data-line-number="5">    tf_dprint(t)</a></code></pre></div>
<pre id="orga75d153" class="text"><code>Op(SquaredDifference)   &quot;Normal_5/log_prob/SquaredDifference&quot;
|  Tensor(RealDiv):0,   shape=[]    &quot;Normal_5/log_prob/truediv:0&quot;
|  |  Op(RealDiv)   &quot;Normal_5/log_prob/truediv&quot;
|  |  |  Tensor(Placeholder):0, shape=[]    &quot;values_5:0&quot;
|  |  |  Tensor(Const):0,   shape=[]    &quot;Normal/scale:0&quot;
|  Tensor(RealDiv):0,   shape=[]    &quot;Normal_5/log_prob/truediv_1:0&quot;
|  |  Op(RealDiv)   &quot;Normal_5/log_prob/truediv_1&quot;
|  |  |  Tensor(Const):0,   shape=[]    &quot;Normal/loc:0&quot;
|  |  |  Tensor(Const):0,   shape=[]    &quot;Normal/scale:0&quot;
Op(SquaredDifference)   &quot;Normal_1_1/log_prob/SquaredDifference&quot;
|  Tensor(RealDiv):0,   shape=[]    &quot;Normal_1_1/log_prob/truediv:0&quot;
|  |  Op(RealDiv)   &quot;Normal_1_1/log_prob/truediv&quot;
|  |  |  Tensor(Placeholder):0, shape=[]    &quot;values_1:0&quot;
|  |  |  Tensor(Const):0,   shape=[]    &quot;Normal_1/scale:0&quot;
|  Tensor(RealDiv):0,   shape=[]    &quot;Normal_1_1/log_prob/truediv_1:0&quot;
|  |  Op(RealDiv)   &quot;Normal_1_1/log_prob/truediv_1&quot;
|  |  |  Tensor(Const):0,   shape=[]    &quot;Normal_1/loc:0&quot;
|  |  |  Tensor(Const):0,   shape=[]    &quot;Normal_1/scale:0&quot;
Op(SquaredDifference)   &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/SquaredDifference&quot;
|  Tensor(RealDiv):0,   shape=[85]  &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/truediv:0&quot;
|  |  Op(RealDiv)   &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/truediv&quot;
|  |  |  Tensor(Transpose):0,   shape=[85]  &quot;SampleNormal_2_1/log_prob/transpose:0&quot;
|  |  |  |  Op(Transpose)   &quot;SampleNormal_2_1/log_prob/transpose&quot;
|  |  |  |  |  Tensor(Reshape):0,   shape=[85]  &quot;SampleNormal_2_1/log_prob/Reshape:0&quot;
|  |  |  |  |  |  Op(Reshape)   &quot;SampleNormal_2_1/log_prob/Reshape&quot;
|  |  |  |  |  |  |  Tensor(Placeholder):0, shape=[85]  &quot;values_6:0&quot;
|  |  |  |  |  |  |  Tensor(Const):0,   shape=[1]   &quot;SampleNormal_2_1/log_prob/Reshape/shape:0&quot;
|  |  |  |  |  Tensor(Const):0, shape=[1]   &quot;SampleNormal_2_1/log_prob/transpose/perm:0&quot;
|  |  |  Tensor(Exp):0, shape=[]    &quot;exp_1/forward/Exp:0&quot;
|  |  |  |  Op(Exp) &quot;exp_1/forward/Exp&quot;
|  |  |  |  |  Tensor(Placeholder):0,   shape=[]    &quot;values_4:0&quot;
|  Tensor(RealDiv):0,   shape=[]    &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/truediv_1:0&quot;
|  |  Op(RealDiv)   &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/truediv_1&quot;
|  |  |  Tensor(Placeholder):0, shape=[]    &quot;values_5:0&quot;
|  |  |  Tensor(Exp):0, shape=[]    &quot;exp_1/forward/Exp:0&quot;
|  |  |  |  ...
Op(SquaredDifference)   &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/SquaredDifference&quot;
|  Tensor(RealDiv):0,   shape=[85]  &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/truediv:0&quot;
|  |  Op(RealDiv)   &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/truediv&quot;
|  |  |  Tensor(Transpose):0,   shape=[85]  &quot;SampleNormal_3_1/log_prob/transpose:0&quot;
|  |  |  |  Op(Transpose)   &quot;SampleNormal_3_1/log_prob/transpose&quot;
|  |  |  |  |  Tensor(Reshape):0,   shape=[85]  &quot;SampleNormal_3_1/log_prob/Reshape:0&quot;
|  |  |  |  |  |  Op(Reshape)   &quot;SampleNormal_3_1/log_prob/Reshape&quot;
|  |  |  |  |  |  |  Tensor(Placeholder):0, shape=[85]  &quot;values_3:0&quot;
|  |  |  |  |  |  |  Tensor(Const):0,   shape=[1]   &quot;SampleNormal_3_1/log_prob/Reshape/shape:0&quot;
|  |  |  |  |  Tensor(Const):0, shape=[1]   &quot;SampleNormal_3_1/log_prob/transpose/perm:0&quot;
|  |  |  Tensor(Exp):0, shape=[]    &quot;exp_2_1/forward/Exp:0&quot;
|  |  |  |  Op(Exp) &quot;exp_2_1/forward/Exp&quot;
|  |  |  |  |  Tensor(Placeholder):0,   shape=[]    &quot;values_0:0&quot;
|  Tensor(RealDiv):0,   shape=[]    &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/truediv_1:0&quot;
|  |  Op(RealDiv)   &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/truediv_1&quot;
|  |  |  Tensor(Placeholder):0, shape=[]    &quot;values_1:0&quot;
|  |  |  Tensor(Exp):0, shape=[]    &quot;exp_2_1/forward/Exp:0&quot;
|  |  |  |  ...
Op(SquaredDifference)   &quot;Normal_4_1/log_prob/SquaredDifference&quot;
|  Tensor(RealDiv):0,   shape=[919] &quot;Normal_4_1/log_prob/truediv:0&quot;
|  |  Op(RealDiv)   &quot;Normal_4_1/log_prob/truediv&quot;
|  |  |  Tensor(Const):0,   shape=[919] &quot;Normal_4_1/log_prob/value:0&quot;
|  |  |  Tensor(Exp):0, shape=[]    &quot;exp_3_1/forward/Exp:0&quot;
|  |  |  |  Op(Exp) &quot;exp_3_1/forward/Exp&quot;
|  |  |  |  |  Tensor(Placeholder):0,   shape=[]    &quot;values_2:0&quot;
|  Tensor(RealDiv):0,   shape=[919] &quot;Normal_4_1/log_prob/truediv_1:0&quot;
|  |  Op(RealDiv)   &quot;Normal_4_1/log_prob/truediv_1&quot;
|  |  |  Tensor(AddV2):0,   shape=[919] &quot;add:0&quot;
|  |  |  |  Op(AddV2)   &quot;add&quot;
|  |  |  |  |  Tensor(GatherV2):0,  shape=[919] &quot;GatherV2:0&quot;
|  |  |  |  |  |  Op(GatherV2)  &quot;GatherV2&quot;
|  |  |  |  |  |  |  Tensor(Placeholder):0, shape=[85]  &quot;values_6:0&quot;
|  |  |  |  |  |  |  Tensor(Const):0,   shape=[919] &quot;GatherV2/indices:0&quot;
|  |  |  |  |  |  |  Tensor(Const):0,   shape=[]    &quot;GatherV2/axis:0&quot;
|  |  |  |  |  Tensor(Mul):0,   shape=[919] &quot;mul:0&quot;
|  |  |  |  |  |  Op(Mul)   &quot;mul&quot;
|  |  |  |  |  |  |  Tensor(GatherV2):0,    shape=[919] &quot;GatherV2_1:0&quot;
|  |  |  |  |  |  |  |  Op(GatherV2)    &quot;GatherV2_1&quot;
|  |  |  |  |  |  |  |  |  Tensor(Placeholder):0,   shape=[85]  &quot;values_3:0&quot;
|  |  |  |  |  |  |  |  |  Tensor(Const):0, shape=[919] &quot;GatherV2_1/indices:0&quot;
|  |  |  |  |  |  |  |  |  Tensor(Const):0, shape=[]    &quot;GatherV2_1/axis:0&quot;
|  |  |  |  |  |  |  Tensor(Const):0,   shape=[919] &quot;mul/y:0&quot;
|  |  |  Tensor(Exp):0, shape=[]    &quot;exp_3_1/forward/Exp:0&quot;
|  |  |  |  ...

</code></pre>
<section id="graph-normalization" class="level2">
<h2>Graph Normalization</h2>
<p>The <code>grappler</code> library in TensorFlow provides a subset of graph pruning/optimization steps. Ideally, a library like <code>grappler</code> would provide full-fledged graph normalization/canonicalization upon which we could base the subgraphs used in our relations.</p>
<div class="remark" data-markdown="">
<p>While <code>grappler</code> does appear to provide some minimal algebraic normalizations, the extent to which these are performed and their breadth of relevant operator coverage isn’t clear; however, the normalizations that it does provide are worth using, so we’ll make use of them throughout.</p>
</div>
<p>In general, we don’t want our “patterns” to be “brittle”, e.g. rely on explicit–yet variable–term orderings in commutative operators (e.g. a pattern that exclusively targets <code>mt.add(x_lv, y_lv)</code> and won’t match the equivalent <code>mt.add(y_lv, x_lv)</code>).</p>
<p>Listing <a href="#org0c58115">14</a> provides a simple means of applying <code>grappler</code>.</p>
<div class="sourceCode" id="org0c58115"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org0c58115-1" data-line-number="1"><span class="im">from</span> tensorflow.core.protobuf <span class="im">import</span> config_pb2</a>
<a class="sourceLine" id="org0c58115-2" data-line-number="2"></a>
<a class="sourceLine" id="org0c58115-3" data-line-number="3"><span class="im">from</span> tensorflow.python.framework <span class="im">import</span> ops</a>
<a class="sourceLine" id="org0c58115-4" data-line-number="4"><span class="im">from</span> tensorflow.python.framework <span class="im">import</span> importer</a>
<a class="sourceLine" id="org0c58115-5" data-line-number="5"><span class="im">from</span> tensorflow.python.framework <span class="im">import</span> meta_graph</a>
<a class="sourceLine" id="org0c58115-6" data-line-number="6"></a>
<a class="sourceLine" id="org0c58115-7" data-line-number="7"><span class="im">from</span> tensorflow.python.grappler <span class="im">import</span> cluster</a>
<a class="sourceLine" id="org0c58115-8" data-line-number="8"><span class="im">from</span> tensorflow.python.grappler <span class="im">import</span> tf_optimizer</a>
<a class="sourceLine" id="org0c58115-9" data-line-number="9"></a>
<a class="sourceLine" id="org0c58115-10" data-line-number="10"></a>
<a class="sourceLine" id="org0c58115-11" data-line-number="11"><span class="cf">try</span>:</a>
<a class="sourceLine" id="org0c58115-12" data-line-number="12">    gcluster <span class="op">=</span> cluster.Cluster()</a>
<a class="sourceLine" id="org0c58115-13" data-line-number="13"><span class="cf">except</span> tf.errors.UnavailableError:</a>
<a class="sourceLine" id="org0c58115-14" data-line-number="14">    <span class="cf">pass</span></a>
<a class="sourceLine" id="org0c58115-15" data-line-number="15"></a>
<a class="sourceLine" id="org0c58115-16" data-line-number="16">config <span class="op">=</span> config_pb2.ConfigProto()</a>
<a class="sourceLine" id="org0c58115-17" data-line-number="17"></a>
<a class="sourceLine" id="org0c58115-18" data-line-number="18"></a>
<a class="sourceLine" id="org0c58115-19" data-line-number="19"><span class="kw">def</span> normalize_tf_graph(graph_output, graph_inputs<span class="op">=</span>[]):</a>
<a class="sourceLine" id="org0c58115-20" data-line-number="20">    <span class="co">&quot;&quot;&quot;Use grappler to normalize a graph.</span></a>
<a class="sourceLine" id="org0c58115-21" data-line-number="21"></a>
<a class="sourceLine" id="org0c58115-22" data-line-number="22"><span class="co">    Arguments</span></a>
<a class="sourceLine" id="org0c58115-23" data-line-number="23"><span class="co">    =========</span></a>
<a class="sourceLine" id="org0c58115-24" data-line-number="24"><span class="co">    graph_output: Tensor</span></a>
<a class="sourceLine" id="org0c58115-25" data-line-number="25"><span class="co">      A tensor we want to consider as &quot;output&quot; of a FuncGraph.</span></a>
<a class="sourceLine" id="org0c58115-26" data-line-number="26"><span class="co">    graph_inputs: list of Tensor (optional)</span></a>
<a class="sourceLine" id="org0c58115-27" data-line-number="27"><span class="co">      Any tensors that correspond to inputs for the given output node.</span></a>
<a class="sourceLine" id="org0c58115-28" data-line-number="28"></a>
<a class="sourceLine" id="org0c58115-29" data-line-number="29"><span class="co">    Returns</span></a>
<a class="sourceLine" id="org0c58115-30" data-line-number="30"><span class="co">    =======</span></a>
<a class="sourceLine" id="org0c58115-31" data-line-number="31"><span class="co">    The simplified graph.</span></a>
<a class="sourceLine" id="org0c58115-32" data-line-number="32"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org0c58115-33" data-line-number="33">    train_op <span class="op">=</span> graph_output.graph.get_collection_ref(ops.GraphKeys.TRAIN_OP)</a>
<a class="sourceLine" id="org0c58115-34" data-line-number="34">    train_op.clear()</a>
<a class="sourceLine" id="org0c58115-35" data-line-number="35">    train_op.extend([graph_output] <span class="op">+</span> graph_inputs)</a>
<a class="sourceLine" id="org0c58115-36" data-line-number="36"></a>
<a class="sourceLine" id="org0c58115-37" data-line-number="37">    <span class="co"># if graph_inputs is not None:</span></a>
<a class="sourceLine" id="org0c58115-38" data-line-number="38">    <span class="co">#     # ops.GraphKeys.MODEL_VARIABLES?</span></a>
<a class="sourceLine" id="org0c58115-39" data-line-number="39">    <span class="co">#     train_vars = graph_output.graph.get_collection_ref(ops.GraphKeys.TRAINABLE_VARIABLES),</span></a>
<a class="sourceLine" id="org0c58115-40" data-line-number="40">    <span class="co">#     train_vars.clear()</span></a>
<a class="sourceLine" id="org0c58115-41" data-line-number="41">    <span class="co">#     train_vars.extend(graph_inputs)</span></a>
<a class="sourceLine" id="org0c58115-42" data-line-number="42"></a>
<a class="sourceLine" id="org0c58115-43" data-line-number="43">    metagraph <span class="op">=</span> meta_graph.create_meta_graph_def(graph<span class="op">=</span>graph_output.graph)</a>
<a class="sourceLine" id="org0c58115-44" data-line-number="44"></a>
<a class="sourceLine" id="org0c58115-45" data-line-number="45">    optimized_graphdef <span class="op">=</span> tf_optimizer.OptimizeGraph(</a>
<a class="sourceLine" id="org0c58115-46" data-line-number="46">        config, metagraph, verbose<span class="op">=</span><span class="va">True</span>, cluster<span class="op">=</span>gcluster)</a>
<a class="sourceLine" id="org0c58115-47" data-line-number="47"></a>
<a class="sourceLine" id="org0c58115-48" data-line-number="48">    optimized_graph <span class="op">=</span> ops.Graph()</a>
<a class="sourceLine" id="org0c58115-49" data-line-number="49">    <span class="cf">with</span> optimized_graph.as_default():</a>
<a class="sourceLine" id="org0c58115-50" data-line-number="50">        importer.import_graph_def(optimized_graphdef, name<span class="op">=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="org0c58115-51" data-line-number="51"></a>
<a class="sourceLine" id="org0c58115-52" data-line-number="52">    opt_graph_output <span class="op">=</span> optimized_graph.get_tensor_by_name(graph_output.name)</a>
<a class="sourceLine" id="org0c58115-53" data-line-number="53"></a>
<a class="sourceLine" id="org0c58115-54" data-line-number="54">    <span class="cf">return</span> opt_graph_output</a></code></pre></div>
<p>In Listing <a href="#org0c58115">14</a> we run <code>grappler</code> on the log-likelihood graph for a normal random variable from Listing <a href="#orgc47d26d">10</a>.</p>
<div class="sourceCode" id="org66f178c"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org66f178c-1" data-line-number="1">normal_log_lik_opt <span class="op">=</span> normalize_tf_graph(normal_log_lik)</a></code></pre></div>
<p>Listing <a href="#org04c54ca">16</a> compares the computed outputs for the original and normalized graphs–given identical inputs.</p>
<div class="sourceCode" id="org04c54ca"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org04c54ca-1" data-line-number="1">res_unopt <span class="op">=</span> normal_log_lik.<span class="bu">eval</span>({<span class="st">&#39;mu:0&#39;</span>: np.r_[<span class="dv">3</span>], <span class="st">&#39;tau:0&#39;</span>: np.r_[<span class="dv">1</span>], <span class="st">&#39;value:0&#39;</span>: np.r_[<span class="dv">1</span>]},</a>
<a class="sourceLine" id="org04c54ca-2" data-line-number="2">                                 session<span class="op">=</span>tf.compat.v1.Session(graph<span class="op">=</span>normal_log_lik.graph))</a>
<a class="sourceLine" id="org04c54ca-3" data-line-number="3"></a>
<a class="sourceLine" id="org04c54ca-4" data-line-number="4">res_opt <span class="op">=</span> normal_log_lik_opt.<span class="bu">eval</span>({<span class="st">&#39;mu:0&#39;</span>: np.r_[<span class="dv">3</span>], <span class="st">&#39;tau:0&#39;</span>: np.r_[<span class="dv">1</span>], <span class="st">&#39;value:0&#39;</span>: np.r_[<span class="dv">1</span>]},</a>
<a class="sourceLine" id="org04c54ca-5" data-line-number="5">                                  session<span class="op">=</span>tf.compat.v1.Session(graph<span class="op">=</span>normal_log_lik_opt.graph))</a>
<a class="sourceLine" id="org04c54ca-6" data-line-number="6"></a>
<a class="sourceLine" id="org04c54ca-7" data-line-number="7"><span class="co"># They should be equal, naturally</span></a>
<a class="sourceLine" id="org04c54ca-8" data-line-number="8"><span class="cf">assert</span> np.array_equal(res_unopt, res_opt)</a>
<a class="sourceLine" id="org04c54ca-9" data-line-number="9"></a>
<a class="sourceLine" id="org04c54ca-10" data-line-number="10">_ <span class="op">=</span> [res_unopt, res_opt]</a></code></pre></div>
<div class="sourceCode" id="orge8b12fa"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orge8b12fa-1" data-line-number="1">[array([<span class="op">-</span><span class="fl">2.9189386</span>], dtype<span class="op">=</span>float32), array([<span class="op">-</span><span class="fl">2.9189386</span>], dtype<span class="op">=</span>float32)]</a></code></pre></div>
<div class="sourceCode" id="orge1da777"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orge1da777-1" data-line-number="1">tf_dprint(normal_log_lik_opt)</a></code></pre></div>
<pre id="org4ebdf85" class="text"><code>Tensor(Sub):0,  shape=[None]    &quot;Normal_1/log_prob/sub:0&quot;
|  Op(Sub)  &quot;Normal_1/log_prob/sub&quot;
|  |  Tensor(Mul):0,    shape=[None]    &quot;Normal_1/log_prob/mul:0&quot;
|  |  |  Op(Mul)    &quot;Normal_1/log_prob/mul&quot;
|  |  |  |  Tensor(SquaredDifference):0,    shape=[None]    &quot;Normal_1/log_prob/SquaredDifference:0&quot;
|  |  |  |  |  Op(SquaredDifference)    &quot;Normal_1/log_prob/SquaredDifference&quot;
|  |  |  |  |  |  Tensor(RealDiv):0,    shape=[None]    &quot;Normal_1/log_prob/truediv:0&quot;
|  |  |  |  |  |  |  Op(RealDiv)    &quot;Normal_1/log_prob/truediv&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;value:0&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;tau:0&quot;
|  |  |  |  |  |  Tensor(RealDiv):0,    shape=[None]    &quot;Normal_1/log_prob/truediv_1:0&quot;
|  |  |  |  |  |  |  Op(RealDiv)    &quot;Normal_1/log_prob/truediv_1&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;mu:0&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;tau:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;Normal_1/log_prob/mul/x:0&quot;
|  |  Tensor(AddV2):0,  shape=[None]    &quot;Normal_1/log_prob/add:0&quot;
|  |  |  Op(AddV2)  &quot;Normal_1/log_prob/add&quot;
|  |  |  |  Tensor(Log):0,  shape=[None]    &quot;Normal_1/log_prob/Log:0&quot;
|  |  |  |  |  Op(Log)  &quot;Normal_1/log_prob/Log&quot;
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;tau:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;Normal_1/log_prob/add/x:0&quot;

</code></pre>
<p>From the output of Listing <a href="#orge1da777">18</a>, we can see that <code>grappler</code> has performed some constant folding and has reordered the inputs in <code>&quot;add_1_1&quot;</code>–among other things.</p>
</section>
<section id="minikanren-transform-relations" class="level2">
<h2>miniKanren Transform Relations</h2>
<p>In Listing <a href="#org0ad3a96">20</a>, we create miniKanren functions that identify the aforementioned <code>SquaredDifference</code> “chains” and perform the re-centered/scaled <span class="math inline">\(X\)</span> substitution.</p>
<div class="sourceCode" id="org0ad3a96"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org0ad3a96-1" data-line-number="1"><span class="im">from</span> itertools <span class="im">import</span> chain</a>
<a class="sourceLine" id="org0ad3a96-2" data-line-number="2"><span class="im">from</span> functools <span class="im">import</span> partial</a>
<a class="sourceLine" id="org0ad3a96-3" data-line-number="3"></a>
<a class="sourceLine" id="org0ad3a96-4" data-line-number="4"><span class="im">from</span> unification <span class="im">import</span> var, reify, unify</a>
<a class="sourceLine" id="org0ad3a96-5" data-line-number="5"></a>
<a class="sourceLine" id="org0ad3a96-6" data-line-number="6"><span class="im">from</span> kanren <span class="im">import</span> run, eq, lall, conde</a>
<a class="sourceLine" id="org0ad3a96-7" data-line-number="7"><span class="im">from</span> kanren.goals <span class="im">import</span> not_equalo</a>
<a class="sourceLine" id="org0ad3a96-8" data-line-number="8"><span class="im">from</span> kanren.core <span class="im">import</span> goaleval</a>
<a class="sourceLine" id="org0ad3a96-9" data-line-number="9"></a>
<a class="sourceLine" id="org0ad3a96-10" data-line-number="10"><span class="im">from</span> symbolic_pymc.tensorflow.meta <span class="im">import</span> mt</a>
<a class="sourceLine" id="org0ad3a96-11" data-line-number="11"><span class="im">from</span> symbolic_pymc.relations.graph <span class="im">import</span> graph_applyo, reduceo</a>
<a class="sourceLine" id="org0ad3a96-12" data-line-number="12"><span class="im">from</span> symbolic_pymc.etuple <span class="im">import</span> ExpressionTuple, etuple</a>
<a class="sourceLine" id="org0ad3a96-13" data-line-number="13"></a>
<a class="sourceLine" id="org0ad3a96-14" data-line-number="14"></a>
<a class="sourceLine" id="org0ad3a96-15" data-line-number="15"><span class="kw">def</span> onceo(goal):</a>
<a class="sourceLine" id="org0ad3a96-16" data-line-number="16">    <span class="co">&quot;&quot;&quot;A non-relational operator that yields only the first result from a relation.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org0ad3a96-17" data-line-number="17">    <span class="kw">def</span> onceo_goal(s):</a>
<a class="sourceLine" id="org0ad3a96-18" data-line-number="18">        <span class="kw">nonlocal</span> goal</a>
<a class="sourceLine" id="org0ad3a96-19" data-line-number="19">        g <span class="op">=</span> reify(goal, s)</a>
<a class="sourceLine" id="org0ad3a96-20" data-line-number="20">        g_stream <span class="op">=</span> goaleval(g)(s)</a>
<a class="sourceLine" id="org0ad3a96-21" data-line-number="21">        s <span class="op">=</span> <span class="bu">next</span>(g_stream)</a>
<a class="sourceLine" id="org0ad3a96-22" data-line-number="22">        <span class="cf">yield</span> s</a>
<a class="sourceLine" id="org0ad3a96-23" data-line-number="23"></a>
<a class="sourceLine" id="org0ad3a96-24" data-line-number="24">    <span class="cf">return</span> onceo_goal</a>
<a class="sourceLine" id="org0ad3a96-25" data-line-number="25"></a>
<a class="sourceLine" id="org0ad3a96-26" data-line-number="26"></a>
<a class="sourceLine" id="org0ad3a96-27" data-line-number="27"><span class="kw">def</span> tf_graph_applyo(relation, a, b):</a>
<a class="sourceLine" id="org0ad3a96-28" data-line-number="28">    <span class="co">&quot;&quot;&quot;Construct a `graph_applyo` goal that evaluates a relation only at tensor nodes in a meta graph.</span></a>
<a class="sourceLine" id="org0ad3a96-29" data-line-number="29"></a>
<a class="sourceLine" id="org0ad3a96-30" data-line-number="30"><span class="co">    Parameters</span></a>
<a class="sourceLine" id="org0ad3a96-31" data-line-number="31"><span class="co">    ----------</span></a>
<a class="sourceLine" id="org0ad3a96-32" data-line-number="32"><span class="co">    relation: function</span></a>
<a class="sourceLine" id="org0ad3a96-33" data-line-number="33"><span class="co">      A binary relation/goal constructor function</span></a>
<a class="sourceLine" id="org0ad3a96-34" data-line-number="34"><span class="co">    a: lvar, meta graph, or etuple</span></a>
<a class="sourceLine" id="org0ad3a96-35" data-line-number="35"><span class="co">      The left-hand side of the relation.</span></a>
<a class="sourceLine" id="org0ad3a96-36" data-line-number="36"><span class="co">    b: lvar, meta graph, or etuple</span></a>
<a class="sourceLine" id="org0ad3a96-37" data-line-number="37"><span class="co">      The right-hand side of the relation</span></a>
<a class="sourceLine" id="org0ad3a96-38" data-line-number="38"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org0ad3a96-39" data-line-number="39"></a>
<a class="sourceLine" id="org0ad3a96-40" data-line-number="40">    <span class="kw">def</span> _expand_some_nodes(node):</a>
<a class="sourceLine" id="org0ad3a96-41" data-line-number="41">        <span class="cf">if</span> <span class="bu">isinstance</span>(node, mt.Tensor) <span class="kw">and</span> node.op <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="org0ad3a96-42" data-line-number="42">            <span class="cf">return</span> etuple(node.operator, <span class="op">*</span>node.inputs, eval_obj<span class="op">=</span>node)</a>
<a class="sourceLine" id="org0ad3a96-43" data-line-number="43">        <span class="cf">return</span> <span class="va">None</span></a>
<a class="sourceLine" id="org0ad3a96-44" data-line-number="44"></a>
<a class="sourceLine" id="org0ad3a96-45" data-line-number="45">    gapplyo <span class="op">=</span> partial(graph_applyo, relation, preprocess_graph<span class="op">=</span>_expand_some_nodes)</a>
<a class="sourceLine" id="org0ad3a96-46" data-line-number="46">    <span class="cf">return</span> gapplyo(a, b)</a>
<a class="sourceLine" id="org0ad3a96-47" data-line-number="47"></a>
<a class="sourceLine" id="org0ad3a96-48" data-line-number="48"></a>
<a class="sourceLine" id="org0ad3a96-49" data-line-number="49"><span class="kw">def</span> shift_squared_terms(in_obj, graph_inputs<span class="op">=</span>[]):</a>
<a class="sourceLine" id="org0ad3a96-50" data-line-number="50">    <span class="co">&quot;&quot;&quot;Re-center/scale SquaredDifference terms corresponding to hierarchical normals.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org0ad3a96-51" data-line-number="51"></a>
<a class="sourceLine" id="org0ad3a96-52" data-line-number="52">    <span class="kw">def</span> shift_squared_subso(in_graph, out_subs):</a>
<a class="sourceLine" id="org0ad3a96-53" data-line-number="53">        <span class="co">&quot;&quot;&quot;Construct a goal that identifies the SquaredDifference terms we desire.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org0ad3a96-54" data-line-number="54"></a>
<a class="sourceLine" id="org0ad3a96-55" data-line-number="55">        Y_lv, X_lv, mu_lv <span class="op">=</span> var(), var(), var()</a>
<a class="sourceLine" id="org0ad3a96-56" data-line-number="56">        X_denom_lv <span class="op">=</span> var()</a>
<a class="sourceLine" id="org0ad3a96-57" data-line-number="57">        X_form_lv <span class="op">=</span> mt.Placeholder(dtype<span class="op">=</span>var(), shape<span class="op">=</span>var(), name<span class="op">=</span>var())</a>
<a class="sourceLine" id="org0ad3a96-58" data-line-number="58"></a>
<a class="sourceLine" id="org0ad3a96-59" data-line-number="59">        sqr_diff_Y_lv <span class="op">=</span> mt.SquaredDifference(Y_lv,</a>
<a class="sourceLine" id="org0ad3a96-60" data-line-number="60">                                             mt.realdiv(X_lv, var(), name<span class="op">=</span>var()),</a>
<a class="sourceLine" id="org0ad3a96-61" data-line-number="61">                                             name<span class="op">=</span>var())</a>
<a class="sourceLine" id="org0ad3a96-62" data-line-number="62"></a>
<a class="sourceLine" id="org0ad3a96-63" data-line-number="63">        <span class="kw">def</span> Y_sqrdiffo(in_g, out_g):</a>
<a class="sourceLine" id="org0ad3a96-64" data-line-number="64">            <span class="cf">return</span> lall(eq(in_g, sqr_diff_Y_lv),</a>
<a class="sourceLine" id="org0ad3a96-65" data-line-number="65">                        <span class="co"># This just makes sure that we&#39;re only considering X&#39;s</span></a>
<a class="sourceLine" id="org0ad3a96-66" data-line-number="66">                        <span class="co"># that are Placeholders.</span></a>
<a class="sourceLine" id="org0ad3a96-67" data-line-number="67">                        eq(X_lv, X_form_lv))</a>
<a class="sourceLine" id="org0ad3a96-68" data-line-number="68"></a>
<a class="sourceLine" id="org0ad3a96-69" data-line-number="69">        sqr_diff_X_lv <span class="op">=</span> mt.SquaredDifference(mt.mul(X_denom_lv, X_lv, name<span class="op">=</span>var()),</a>
<a class="sourceLine" id="org0ad3a96-70" data-line-number="70">                                             <span class="co"># mt.realdiv(X_lv, X_denom_lv, name=var()),</span></a>
<a class="sourceLine" id="org0ad3a96-71" data-line-number="71">                                             mu_lv,</a>
<a class="sourceLine" id="org0ad3a96-72" data-line-number="72">                                             name<span class="op">=</span>var())</a>
<a class="sourceLine" id="org0ad3a96-73" data-line-number="73"></a>
<a class="sourceLine" id="org0ad3a96-74" data-line-number="74">        <span class="kw">def</span> X_sqrdiffo(in_g, out_g):</a>
<a class="sourceLine" id="org0ad3a96-75" data-line-number="75">            <span class="cf">return</span> eq(in_g, sqr_diff_X_lv)</a>
<a class="sourceLine" id="org0ad3a96-76" data-line-number="76"></a>
<a class="sourceLine" id="org0ad3a96-77" data-line-number="77">        <span class="co"># X_new_mt = mt.mul(X_denom_lv, mt.add(mu_lv, X_lv))</span></a>
<a class="sourceLine" id="org0ad3a96-78" data-line-number="78">        X_new_mt <span class="op">=</span> mt.add(mu_lv, mt.mul(X_denom_lv, X_lv))</a>
<a class="sourceLine" id="org0ad3a96-79" data-line-number="79"></a>
<a class="sourceLine" id="org0ad3a96-80" data-line-number="80">        res <span class="op">=</span> lall(</a>
<a class="sourceLine" id="org0ad3a96-81" data-line-number="81">            <span class="co"># The first (y - x/a)**2 (anywhere in the graph)</span></a>
<a class="sourceLine" id="org0ad3a96-82" data-line-number="82">            tf_graph_applyo(Y_sqrdiffo, in_graph, in_graph),</a>
<a class="sourceLine" id="org0ad3a96-83" data-line-number="83">            <span class="co"># The corresponding (x/b - z)**2 (also anywhere else in the graph)</span></a>
<a class="sourceLine" id="org0ad3a96-84" data-line-number="84">            tf_graph_applyo(X_sqrdiffo, in_graph, in_graph),</a>
<a class="sourceLine" id="org0ad3a96-85" data-line-number="85">            <span class="co"># Not sure if we need this, but we definitely don&#39;t want X == Y</span></a>
<a class="sourceLine" id="org0ad3a96-86" data-line-number="86">            (not_equalo, [Y_lv, X_lv], <span class="va">True</span>),</a>
<a class="sourceLine" id="org0ad3a96-87" data-line-number="87">            <span class="co"># Set the &quot;output&quot;/second argument to the resulting substitution</span></a>
<a class="sourceLine" id="org0ad3a96-88" data-line-number="88">            <span class="co"># pair</span></a>
<a class="sourceLine" id="org0ad3a96-89" data-line-number="89">            eq(out_subs, [X_lv, X_new_mt]))</a>
<a class="sourceLine" id="org0ad3a96-90" data-line-number="90"></a>
<a class="sourceLine" id="org0ad3a96-91" data-line-number="91">        <span class="cf">return</span> res</a>
<a class="sourceLine" id="org0ad3a96-92" data-line-number="92"></a>
<a class="sourceLine" id="org0ad3a96-93" data-line-number="93">    <span class="co"># Normalize and convert to a meta graph</span></a>
<a class="sourceLine" id="org0ad3a96-94" data-line-number="94">    in_obj <span class="op">=</span> mt(normalize_tf_graph(in_obj, graph_inputs<span class="op">=</span>graph_inputs))</a>
<a class="sourceLine" id="org0ad3a96-95" data-line-number="95"></a>
<a class="sourceLine" id="org0ad3a96-96" data-line-number="96">    <span class="co"># This run returns all the substitutions found in the graph</span></a>
<a class="sourceLine" id="org0ad3a96-97" data-line-number="97">    subs_lv <span class="op">=</span> var()</a>
<a class="sourceLine" id="org0ad3a96-98" data-line-number="98">    subs_res <span class="op">=</span> run(<span class="dv">0</span>, subs_lv, shift_squared_subso(in_obj, subs_lv))</a>
<a class="sourceLine" id="org0ad3a96-99" data-line-number="99"></a>
<a class="sourceLine" id="org0ad3a96-100" data-line-number="100">    <span class="kw">def</span> subs_replaceo(in_g, out_g):</a>
<a class="sourceLine" id="org0ad3a96-101" data-line-number="101">        <span class="co">&quot;&quot;&quot;Create a goal that applies substitutions to a graph.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org0ad3a96-102" data-line-number="102">        <span class="kw">def</span> _subs_replaceo(in_g, out_g):</a>
<a class="sourceLine" id="org0ad3a96-103" data-line-number="103">            x_g <span class="op">=</span> conde(<span class="op">*</span>[[eq(in_g, x), eq(out_g, y)]</a>
<a class="sourceLine" id="org0ad3a96-104" data-line-number="104">                          <span class="cf">for</span> x, y <span class="kw">in</span> subs_res])</a>
<a class="sourceLine" id="org0ad3a96-105" data-line-number="105">            <span class="cf">return</span> x_g</a>
<a class="sourceLine" id="org0ad3a96-106" data-line-number="106"></a>
<a class="sourceLine" id="org0ad3a96-107" data-line-number="107">        g <span class="op">=</span> onceo(tf_graph_applyo(_subs_replaceo, in_g, out_g))</a>
<a class="sourceLine" id="org0ad3a96-108" data-line-number="108">        <span class="cf">return</span> g</a>
<a class="sourceLine" id="org0ad3a96-109" data-line-number="109"></a>
<a class="sourceLine" id="org0ad3a96-110" data-line-number="110">    <span class="co"># Apply each substitution once</span></a>
<a class="sourceLine" id="org0ad3a96-111" data-line-number="111">    out_graph_lv <span class="op">=</span> var()</a>
<a class="sourceLine" id="org0ad3a96-112" data-line-number="112">    res <span class="op">=</span> run(<span class="dv">1</span>, out_graph_lv, reduceo(subs_replaceo, in_obj, out_graph_lv))</a>
<a class="sourceLine" id="org0ad3a96-113" data-line-number="113"></a>
<a class="sourceLine" id="org0ad3a96-114" data-line-number="114">    <span class="cf">if</span> res:</a>
<a class="sourceLine" id="org0ad3a96-115" data-line-number="115"></a>
<a class="sourceLine" id="org0ad3a96-116" data-line-number="116">        <span class="kw">def</span> reify_res(graph_res):</a>
<a class="sourceLine" id="org0ad3a96-117" data-line-number="117">            <span class="co">&quot;&quot;&quot;Reconstruct and/or reify meta object results.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org0ad3a96-118" data-line-number="118">            from_etuple <span class="op">=</span> graph_res.eval_obj <span class="cf">if</span> <span class="bu">isinstance</span>(graph_res, ExpressionTuple) <span class="cf">else</span> graph_res</a>
<a class="sourceLine" id="org0ad3a96-119" data-line-number="119">            <span class="cf">if</span> <span class="bu">hasattr</span>(from_etuple, <span class="st">&#39;reify&#39;</span>):</a>
<a class="sourceLine" id="org0ad3a96-120" data-line-number="120">                <span class="cf">return</span> from_etuple.reify()</a>
<a class="sourceLine" id="org0ad3a96-121" data-line-number="121">            <span class="cf">else</span>:</a>
<a class="sourceLine" id="org0ad3a96-122" data-line-number="122">                <span class="cf">return</span> from_etuple</a>
<a class="sourceLine" id="org0ad3a96-123" data-line-number="123"></a>
<a class="sourceLine" id="org0ad3a96-124" data-line-number="124">        res <span class="op">=</span> [reify_res(r) <span class="cf">for</span> r <span class="kw">in</span> res]</a>
<a class="sourceLine" id="org0ad3a96-125" data-line-number="125"></a>
<a class="sourceLine" id="org0ad3a96-126" data-line-number="126">    <span class="cf">if</span> <span class="bu">len</span>(res) <span class="op">==</span> <span class="dv">1</span>:</a>
<a class="sourceLine" id="org0ad3a96-127" data-line-number="127">        graph_res <span class="op">=</span> res[<span class="dv">0</span>]</a>
<a class="sourceLine" id="org0ad3a96-128" data-line-number="128">        <span class="co"># return graph_res, subs_res</span></a>
<a class="sourceLine" id="org0ad3a96-129" data-line-number="129">        <span class="cf">return</span> normalize_tf_graph(graph_res, graph_inputs<span class="op">=</span>graph_inputs), subs_res</a></code></pre></div>
<p>As a test, we will run our miniKanren relations on the log-likelihood graph for a normal-normal hierarchical model in Listing <a href="#org29e93d9">21</a>.</p>
<div class="sourceCode" id="org29e93d9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org29e93d9-1" data-line-number="1"><span class="cf">with</span> graph_mode(), tf.Graph().as_default() <span class="im">as</span> demo_graph:</a>
<a class="sourceLine" id="org29e93d9-2" data-line-number="2">    X_tfp <span class="op">=</span> tfp.distributions.normal.Normal(<span class="fl">0.0</span>, <span class="fl">1.0</span>, name<span class="op">=</span><span class="st">&#39;X&#39;</span>)</a>
<a class="sourceLine" id="org29e93d9-3" data-line-number="3"></a>
<a class="sourceLine" id="org29e93d9-4" data-line-number="4">    x_tf <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, name<span class="op">=</span><span class="st">&#39;value_x&#39;</span>,</a>
<a class="sourceLine" id="org29e93d9-5" data-line-number="5">                                    shape<span class="op">=</span>tf.TensorShape([<span class="va">None</span>]))</a>
<a class="sourceLine" id="org29e93d9-6" data-line-number="6"></a>
<a class="sourceLine" id="org29e93d9-7" data-line-number="7">    tau_tf <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, name<span class="op">=</span><span class="st">&#39;tau&#39;</span>,</a>
<a class="sourceLine" id="org29e93d9-8" data-line-number="8">                                      shape<span class="op">=</span>tf.TensorShape([<span class="va">None</span>]))</a>
<a class="sourceLine" id="org29e93d9-9" data-line-number="9"></a>
<a class="sourceLine" id="org29e93d9-10" data-line-number="10">    Y_tfp <span class="op">=</span> tfp.distributions.normal.Normal(x_tf, tau_tf, name<span class="op">=</span><span class="st">&#39;Y&#39;</span>)</a>
<a class="sourceLine" id="org29e93d9-11" data-line-number="11"></a>
<a class="sourceLine" id="org29e93d9-12" data-line-number="12">    y_tf <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, name<span class="op">=</span><span class="st">&#39;value_y&#39;</span>,</a>
<a class="sourceLine" id="org29e93d9-13" data-line-number="13">                                    shape<span class="op">=</span>tf.TensorShape([<span class="va">None</span>]))</a>
<a class="sourceLine" id="org29e93d9-14" data-line-number="14"></a>
<a class="sourceLine" id="org29e93d9-15" data-line-number="15">    hier_norm_lik <span class="op">=</span> Y_tfp.log_prob(y_tf) <span class="op">+</span> X_tfp.log_prob(x_tf)</a>
<a class="sourceLine" id="org29e93d9-16" data-line-number="16">    hier_norm_lik <span class="op">=</span> normalize_tf_graph(hier_norm_lik)</a></code></pre></div>
<p>Listing <a href="#org59b1e29">22</a> shows the form that a graph representing a hierarchical normal-normal model will generally take in TFP.</p>
<div class="sourceCode" id="org59b1e29"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org59b1e29-1" data-line-number="1">tf_dprint(hier_norm_lik)</a></code></pre></div>
<pre id="org707d199" class="text"><code>Tensor(AddV2):0,    shape=[None]    &quot;add:0&quot;
|  Op(AddV2)    &quot;add&quot;
|  |  Tensor(Sub):0,    shape=[None]    &quot;X_1/log_prob/sub:0&quot;
|  |  |  Op(Sub)    &quot;X_1/log_prob/sub&quot;
|  |  |  |  Tensor(Mul):0,  shape=[None]    &quot;X_1/log_prob/mul:0&quot;
|  |  |  |  |  Op(Mul)  &quot;X_1/log_prob/mul&quot;
|  |  |  |  |  |  Tensor(SquaredDifference):0,  shape=[None]    &quot;X_1/log_prob/SquaredDifference:0&quot;
|  |  |  |  |  |  |  Op(SquaredDifference)  &quot;X_1/log_prob/SquaredDifference&quot;
|  |  |  |  |  |  |  |  Tensor(Mul):0,  shape=[None]    &quot;X_1/log_prob/truediv:0&quot;
|  |  |  |  |  |  |  |  |  Op(Mul)  &quot;X_1/log_prob/truediv&quot;
|  |  |  |  |  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;ConstantFolding/X_1/log_prob/truediv_recip:0&quot;
|  |  |  |  |  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;value_x:0&quot;
|  |  |  |  |  |  |  |  Tensor(Const):0,    shape=[]    &quot;X_1/log_prob/truediv_1:0&quot;
|  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;Y_1/log_prob/mul/x:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;Y_1/log_prob/add/x:0&quot;
|  |  Tensor(Sub):0,    shape=[None]    &quot;Y_1/log_prob/sub:0&quot;
|  |  |  Op(Sub)    &quot;Y_1/log_prob/sub&quot;
|  |  |  |  Tensor(Mul):0,  shape=[None]    &quot;Y_1/log_prob/mul:0&quot;
|  |  |  |  |  Op(Mul)  &quot;Y_1/log_prob/mul&quot;
|  |  |  |  |  |  Tensor(SquaredDifference):0,  shape=[None]    &quot;Y_1/log_prob/SquaredDifference:0&quot;
|  |  |  |  |  |  |  Op(SquaredDifference)  &quot;Y_1/log_prob/SquaredDifference&quot;
|  |  |  |  |  |  |  |  Tensor(RealDiv):0,  shape=[None]    &quot;Y_1/log_prob/truediv:0&quot;
|  |  |  |  |  |  |  |  |  Op(RealDiv)  &quot;Y_1/log_prob/truediv&quot;
|  |  |  |  |  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;value_y:0&quot;
|  |  |  |  |  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;tau:0&quot;
|  |  |  |  |  |  |  |  Tensor(RealDiv):0,  shape=[None]    &quot;Y_1/log_prob/truediv_1:0&quot;
|  |  |  |  |  |  |  |  |  Op(RealDiv)  &quot;Y_1/log_prob/truediv_1&quot;
|  |  |  |  |  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;value_x:0&quot;
|  |  |  |  |  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;tau:0&quot;
|  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;Y_1/log_prob/mul/x:0&quot;
|  |  |  |  Tensor(AddV2):0,    shape=[None]    &quot;Y_1/log_prob/add:0&quot;
|  |  |  |  |  Op(AddV2)    &quot;Y_1/log_prob/add&quot;
|  |  |  |  |  |  Tensor(Log):0,    shape=[None]    &quot;Y_1/log_prob/Log:0&quot;
|  |  |  |  |  |  |  Op(Log)    &quot;Y_1/log_prob/Log&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;tau:0&quot;
|  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;Y_1/log_prob/add/x:0&quot;

</code></pre>
<p>Listing <a href="#orgf81b6e5">24</a> runs our transformation and Listing <a href="#orgae5d6c4">25</a> prints the resulting graph.</p>
<div class="sourceCode" id="orgf81b6e5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgf81b6e5-1" data-line-number="1"><span class="cf">with</span> graph_mode(), demo_graph.as_default():</a>
<a class="sourceLine" id="orgf81b6e5-2" data-line-number="2">    test_output_res, test_remaps <span class="op">=</span> shift_squared_terms(hier_norm_lik, graph_inputs<span class="op">=</span>[x_tf, y_tf])</a></code></pre></div>
<div class="sourceCode" id="orgae5d6c4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgae5d6c4-1" data-line-number="1">tf_dprint(test_output_res)</a></code></pre></div>
<pre id="orgbd059f9" class="text"><code>Tensor(AddV2):0,    shape=[None]    &quot;add_2:0&quot;
|  Op(AddV2)    &quot;add_2&quot;
|  |  Tensor(Sub):0,    shape=[None]    &quot;X_1/log_prob/sub_1:0&quot;
|  |  |  Op(Sub)    &quot;X_1/log_prob/sub_1&quot;
|  |  |  |  Tensor(Mul):0,  shape=[None]    &quot;X_1/log_prob/mul_1:0&quot;
|  |  |  |  |  Op(Mul)  &quot;X_1/log_prob/mul_1&quot;
|  |  |  |  |  |  Tensor(SquaredDifference):0,  shape=[None]    &quot;X_1/log_prob/SquaredDifference_1:0&quot;
|  |  |  |  |  |  |  Op(SquaredDifference)  &quot;X_1/log_prob/SquaredDifference_1&quot;
|  |  |  |  |  |  |  |  Tensor(Const):0,    shape=[]    &quot;X_1/log_prob/truediv_1:0&quot;
|  |  |  |  |  |  |  |  Tensor(Mul):0,  shape=[None]    &quot;X_1/log_prob/truediv_2:0&quot;
|  |  |  |  |  |  |  |  |  Op(Mul)  &quot;X_1/log_prob/truediv_2&quot;
|  |  |  |  |  |  |  |  |  |  Tensor(Add):0,    shape=[None]    &quot;Add_1:0&quot;
|  |  |  |  |  |  |  |  |  |  |  Op(Add)    &quot;Add_1&quot;
|  |  |  |  |  |  |  |  |  |  |  |  Tensor(Mul):0,  shape=[None]    &quot;Mul:0&quot;
|  |  |  |  |  |  |  |  |  |  |  |  |  Op(Mul)  &quot;Mul&quot;
|  |  |  |  |  |  |  |  |  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;ConstantFolding/X_1/log_prob/truediv_recip:0&quot;
|  |  |  |  |  |  |  |  |  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;value_x:0&quot;
|  |  |  |  |  |  |  |  |  |  |  |  Tensor(Const):0,    shape=[]    &quot;X_1/log_prob/truediv_1:0&quot;
|  |  |  |  |  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;ConstantFolding/X_1/log_prob/truediv_recip:0&quot;
|  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;Y_1/log_prob/mul/x:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;Y_1/log_prob/add/x:0&quot;
|  |  Tensor(Sub):0,    shape=[None]    &quot;Y_1/log_prob/sub_1:0&quot;
|  |  |  Op(Sub)    &quot;Y_1/log_prob/sub_1&quot;
|  |  |  |  Tensor(Mul):0,  shape=[None]    &quot;Y_1/log_prob/mul_1:0&quot;
|  |  |  |  |  Op(Mul)  &quot;Y_1/log_prob/mul_1&quot;
|  |  |  |  |  |  Tensor(SquaredDifference):0,  shape=[None]    &quot;Y_1/log_prob/SquaredDifference_1:0&quot;
|  |  |  |  |  |  |  Op(SquaredDifference)  &quot;Y_1/log_prob/SquaredDifference_1&quot;
|  |  |  |  |  |  |  |  Tensor(RealDiv):0,  shape=[None]    &quot;Y_1/log_prob/truediv:0&quot;
|  |  |  |  |  |  |  |  |  Op(RealDiv)  &quot;Y_1/log_prob/truediv&quot;
|  |  |  |  |  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;value_y:0&quot;
|  |  |  |  |  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;tau:0&quot;
|  |  |  |  |  |  |  |  Tensor(RealDiv):0,  shape=[None]    &quot;Y_1/log_prob/truediv_1_1:0&quot;
|  |  |  |  |  |  |  |  |  Op(RealDiv)  &quot;Y_1/log_prob/truediv_1_1&quot;
|  |  |  |  |  |  |  |  |  |  Tensor(Add):0,    shape=[None]    &quot;Add_1:0&quot;
|  |  |  |  |  |  |  |  |  |  |  ...
|  |  |  |  |  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;tau:0&quot;
|  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;Y_1/log_prob/mul/x:0&quot;
|  |  |  |  Tensor(AddV2):0,    shape=[None]    &quot;Y_1/log_prob/add:0&quot;
|  |  |  |  |  Op(AddV2)    &quot;Y_1/log_prob/add&quot;
|  |  |  |  |  |  Tensor(Log):0,    shape=[None]    &quot;Y_1/log_prob/Log:0&quot;
|  |  |  |  |  |  |  Op(Log)    &quot;Y_1/log_prob/Log&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;tau:0&quot;
|  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;Y_1/log_prob/add/x:0&quot;

</code></pre>
<p>From Listing <a href="#orgae5d6c4">25</a> we can see that <code>grappler</code> is not applying enough algebraic simplifications to reduce the <span class="math inline">\(\left(\mu + x - \mu \right)^2\)</span> term.</p>
</section>
</section>
<section id="transforming-the-log-likelihood-graph" class="level1">
<h1>Transforming the Log-likelihood Graph</h1>
<p>Now, we’re ready to apply the transform to the radon model log-likelihood graph.</p>
<div class="sourceCode" id="org537ce90"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org537ce90-1" data-line-number="1"><span class="cf">with</span> graph_mode(), tf.Graph().as_default() <span class="im">as</span> trans_graph: <span class="co">#logpfn_fg.as_default():</span></a>
<a class="sourceLine" id="org537ce90-2" data-line-number="2">    graph_inputs <span class="op">=</span> [logpfn_fg.get_operation_by_name(i.name).outputs[<span class="dv">0</span>]</a>
<a class="sourceLine" id="org537ce90-3" data-line-number="3">                    <span class="cf">for</span> i <span class="kw">in</span> logpfn_cf.structured_input_signature[<span class="dv">0</span>]]</a>
<a class="sourceLine" id="org537ce90-4" data-line-number="4">    logpfn_trans_tf, logpfn_remaps <span class="op">=</span> shift_squared_terms(logpfn_fg.outputs[<span class="dv">0</span>], graph_inputs<span class="op">=</span>graph_inputs)</a></code></pre></div>
<p>Listing <a href="#org73bcbee">28</a> shows the replacements that were made throughout the graph. Two replacements were found and they appear to correspond to the un-centered normal distribution terms <code>a</code> and <code>b</code> in our model–as intended.</p>
<div class="sourceCode" id="org73bcbee"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org73bcbee-1" data-line-number="1"><span class="cf">for</span> r <span class="kw">in</span> logpfn_remaps:</a>
<a class="sourceLine" id="org73bcbee-2" data-line-number="2">    [tf_dprint(i) <span class="cf">for</span> i <span class="kw">in</span> r]</a>
<a class="sourceLine" id="org73bcbee-3" data-line-number="3">    <span class="bu">print</span>(<span class="st">&quot;------&quot;</span>)</a></code></pre></div>
<pre id="org8c33bb8" class="text"><code>Tensor(Placeholder):0,  shape=[]    &quot;values_1:0&quot;
Tensor(Add):0,  shape=[]    &quot;Add_12:0&quot;
|  Op(Add)  &quot;Add&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;add_1/x:0&quot;
|  |  Tensor(Mul):0,    shape=[]    &quot;Mul_4:0&quot;
|  |  |  Op(Mul)    &quot;Mul&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;exp_3_2/inverse_log_det_jacobian/mul_1:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[]    &quot;values_1:0&quot;
------
Tensor(Placeholder):0,  shape=[]    &quot;values_5:0&quot;
Tensor(Add):0,  shape=[]    &quot;Add_13:0&quot;
|  Op(Add)  &quot;Add&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;add_1/x:0&quot;
|  |  Tensor(Mul):0,    shape=[]    &quot;Mul_5:0&quot;
|  |  |  Op(Mul)    &quot;Mul&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;exp_3_2/inverse_log_det_jacobian/mul_1:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[]    &quot;values_5:0&quot;
------

</code></pre>
<p>Likewise, Listing <a href="#org0ce0bba">30</a> shows all <code>Square</code> and <code>SquaredDifference</code> subgraphs that appear in the transformed log-likelihood.</p>
<div class="sourceCode" id="org0ce0bba"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org0ce0bba-1" data-line-number="1">square_diff_outs <span class="op">=</span> [o.outputs[<span class="dv">0</span>] <span class="cf">for</span> o <span class="kw">in</span> logpfn_trans_tf.graph.get_operations()</a>
<a class="sourceLine" id="org0ce0bba-2" data-line-number="2">                    <span class="cf">if</span> o.<span class="bu">type</span> <span class="op">==</span> <span class="st">&#39;SquaredDifference&#39;</span> <span class="kw">or</span> o.<span class="bu">type</span> <span class="op">==</span> <span class="st">&#39;Square&#39;</span>]</a>
<a class="sourceLine" id="org0ce0bba-3" data-line-number="3"></a>
<a class="sourceLine" id="org0ce0bba-4" data-line-number="4"><span class="cf">for</span> t <span class="kw">in</span> square_diff_outs[:<span class="dv">4</span>]:</a>
<a class="sourceLine" id="org0ce0bba-5" data-line-number="5">    tf_dprint(t)</a></code></pre></div>
<pre id="org74e8720" class="text"><code>Tensor(SquaredDifference):0,    shape=[85]  &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/SquaredDifference_1:0&quot;
|  Op(SquaredDifference)    &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/SquaredDifference_1&quot;
|  |  Tensor(RealDiv):0,    shape=[85]  &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/truediv:0&quot;
|  |  |  Op(RealDiv)    &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/truediv&quot;
|  |  |  |  Tensor(Reshape):0,  shape=[85]  &quot;SampleNormal_3_1/log_prob/Reshape:0&quot;
|  |  |  |  |  Op(Reshape)  &quot;SampleNormal_3_1/log_prob/Reshape&quot;
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[85]  &quot;values_3:0&quot;
|  |  |  |  |  |  Tensor(Const):0,  shape=[1]   &quot;SampleNormal_2_1/log_prob/Reshape/shape:0&quot;
|  |  |  |  Tensor(Exp):0,  shape=[]    &quot;exp_2_1/forward/Exp:0&quot;
|  |  |  |  |  Op(Exp)  &quot;exp_2_1/forward/Exp&quot;
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[]    &quot;values_0:0&quot;
|  |  Tensor(RealDiv):0,    shape=[]    &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/truediv_1_1:0&quot;
|  |  |  Op(RealDiv)    &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/truediv_1_1&quot;
|  |  |  |  Tensor(Add):0,  shape=[]    &quot;Add_12:0&quot;
|  |  |  |  |  Op(Add)  &quot;Add_12&quot;
|  |  |  |  |  |  Tensor(Mul):0,    shape=[]    &quot;Mul_4:0&quot;
|  |  |  |  |  |  |  Op(Mul)    &quot;Mul_4&quot;
|  |  |  |  |  |  |  |  Tensor(Const):0,    shape=[]    &quot;exp_3_2/inverse_log_det_jacobian/mul_1:0&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[]    &quot;values_1:0&quot;
|  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;add_1/x:0&quot;
|  |  |  |  Tensor(Exp):0,  shape=[]    &quot;exp_2_1/forward/Exp:0&quot;
|  |  |  |  |  ...
Tensor(SquaredDifference):0,    shape=[]    &quot;Normal_1_1/log_prob/SquaredDifference_1:0&quot;
|  Op(SquaredDifference)    &quot;Normal_1_1/log_prob/SquaredDifference_1&quot;
|  |  Tensor(Mul):0,    shape=[]    &quot;Normal_1_1/log_prob/truediv_1:0&quot;
|  |  |  Op(Mul)    &quot;Normal_1_1/log_prob/truediv_1&quot;
|  |  |  |  Tensor(Add):0,  shape=[]    &quot;Add_12:0&quot;
|  |  |  |  |  Op(Add)  &quot;Add_12&quot;
|  |  |  |  |  |  Tensor(Mul):0,    shape=[]    &quot;Mul_4:0&quot;
|  |  |  |  |  |  |  Op(Mul)    &quot;Mul_4&quot;
|  |  |  |  |  |  |  |  Tensor(Const):0,    shape=[]    &quot;exp_3_2/inverse_log_det_jacobian/mul_1:0&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[]    &quot;values_1:0&quot;
|  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;add_1/x:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;exp_3_2/inverse_log_det_jacobian/mul_1:0&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;add_1/x:0&quot;
Tensor(SquaredDifference):0,    shape=[85]  &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/SquaredDifference_1:0&quot;
|  Op(SquaredDifference)    &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/SquaredDifference_1&quot;
|  |  Tensor(RealDiv):0,    shape=[85]  &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/truediv:0&quot;
|  |  |  Op(RealDiv)    &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/truediv&quot;
|  |  |  |  Tensor(Reshape):0,  shape=[85]  &quot;SampleNormal_2_1/log_prob/Reshape:0&quot;
|  |  |  |  |  Op(Reshape)  &quot;SampleNormal_2_1/log_prob/Reshape&quot;
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[85]  &quot;values_6:0&quot;
|  |  |  |  |  |  Tensor(Const):0,  shape=[1]   &quot;SampleNormal_2_1/log_prob/Reshape/shape:0&quot;
|  |  |  |  Tensor(Exp):0,  shape=[]    &quot;exp_1/forward/Exp:0&quot;
|  |  |  |  |  Op(Exp)  &quot;exp_1/forward/Exp&quot;
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[]    &quot;values_4:0&quot;
|  |  Tensor(RealDiv):0,    shape=[]    &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/truediv_1_1:0&quot;
|  |  |  Op(RealDiv)    &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/truediv_1_1&quot;
|  |  |  |  Tensor(Add):0,  shape=[]    &quot;Add_13:0&quot;
|  |  |  |  |  Op(Add)  &quot;Add_13&quot;
|  |  |  |  |  |  Tensor(Mul):0,    shape=[]    &quot;Mul_5:0&quot;
|  |  |  |  |  |  |  Op(Mul)    &quot;Mul_5&quot;
|  |  |  |  |  |  |  |  Tensor(Const):0,    shape=[]    &quot;exp_3_2/inverse_log_det_jacobian/mul_1:0&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[]    &quot;values_5:0&quot;
|  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;add_1/x:0&quot;
|  |  |  |  Tensor(Exp):0,  shape=[]    &quot;exp_1/forward/Exp:0&quot;
|  |  |  |  |  ...
Tensor(SquaredDifference):0,    shape=[]    &quot;Normal_5/log_prob/SquaredDifference_1:0&quot;
|  Op(SquaredDifference)    &quot;Normal_5/log_prob/SquaredDifference_1&quot;
|  |  Tensor(Mul):0,    shape=[]    &quot;Normal_5/log_prob/truediv_1:0&quot;
|  |  |  Op(Mul)    &quot;Normal_5/log_prob/truediv_1&quot;
|  |  |  |  Tensor(Add):0,  shape=[]    &quot;Add_13:0&quot;
|  |  |  |  |  Op(Add)  &quot;Add_13&quot;
|  |  |  |  |  |  Tensor(Mul):0,    shape=[]    &quot;Mul_5:0&quot;
|  |  |  |  |  |  |  Op(Mul)    &quot;Mul_5&quot;
|  |  |  |  |  |  |  |  Tensor(Const):0,    shape=[]    &quot;exp_3_2/inverse_log_det_jacobian/mul_1:0&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[]    &quot;values_5:0&quot;
|  |  |  |  |  |  Tensor(Const):0,  shape=[]    &quot;add_1/x:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;exp_3_2/inverse_log_det_jacobian/mul_1:0&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;add_1/x:0&quot;

</code></pre>
</section>
<section id="creating-a-new-log-likelihood-function" class="level1">
<h1>Creating a new Log-likelihood Function</h1>
<p>Now that we have a transformed version of the original log-likelihood graph (i.e. <code>logpfn_trans_tf</code>), we need to create a new <code>FuncGraph</code> from it. Listing <a href="#org8555c2e">32</a> provides a simple function that creates a new <code>ConcreteFunction</code> from an updated output node.</p>
<div class="sourceCode" id="org8555c2e"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org8555c2e-1" data-line-number="1"><span class="im">from</span> tensorflow.python.framework.func_graph <span class="im">import</span> FuncGraph</a>
<a class="sourceLine" id="org8555c2e-2" data-line-number="2"><span class="im">from</span> tensorflow.python.eager.function <span class="im">import</span> ConcreteFunction</a>
<a class="sourceLine" id="org8555c2e-3" data-line-number="3"><span class="im">from</span> tensorflow.python.eager.lift_to_graph <span class="im">import</span> lift_to_graph</a>
<a class="sourceLine" id="org8555c2e-4" data-line-number="4"></a>
<a class="sourceLine" id="org8555c2e-5" data-line-number="5"></a>
<a class="sourceLine" id="org8555c2e-6" data-line-number="6"><span class="kw">def</span> new_tf_function(output, orig_cf):</a>
<a class="sourceLine" id="org8555c2e-7" data-line-number="7">    <span class="co">&quot;&quot;&quot;Create a new ConcreteFunction by replacing a single output in an existing FuncGraph.</span></a>
<a class="sourceLine" id="org8555c2e-8" data-line-number="8"></a>
<a class="sourceLine" id="org8555c2e-9" data-line-number="9"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org8555c2e-10" data-line-number="10">    orig_fg <span class="op">=</span> orig_cf.graph</a>
<a class="sourceLine" id="org8555c2e-11" data-line-number="11">    <span class="co"># with trans_graph.as_default(): #orig_fg.as_default():</span></a>
<a class="sourceLine" id="org8555c2e-12" data-line-number="12"></a>
<a class="sourceLine" id="org8555c2e-13" data-line-number="13">    logpfn_fg_new <span class="op">=</span> FuncGraph(<span class="st">&#39;logpfn_new&#39;</span>, orig_fg.collections, orig_fg.capture_by_value)</a>
<a class="sourceLine" id="org8555c2e-14" data-line-number="14"></a>
<a class="sourceLine" id="org8555c2e-15" data-line-number="15">    old_to_new_ops <span class="op">=</span> lift_to_graph([output],</a>
<a class="sourceLine" id="org8555c2e-16" data-line-number="16">                                    logpfn_fg_new,</a>
<a class="sourceLine" id="org8555c2e-17" data-line-number="17">                                    add_sources<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="org8555c2e-18" data-line-number="18">                                    handle_captures<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="org8555c2e-19" data-line-number="19"></a>
<a class="sourceLine" id="org8555c2e-20" data-line-number="20">    logpfn_fg_new.structured_input_signature <span class="op">=</span> orig_fg.structured_input_signature</a>
<a class="sourceLine" id="org8555c2e-21" data-line-number="21"></a>
<a class="sourceLine" id="org8555c2e-22" data-line-number="22">    new_inputs <span class="op">=</span> [old_to_new_ops.get(output.graph.get_operation_by_name(i.name).outputs[<span class="dv">0</span>])</a>
<a class="sourceLine" id="org8555c2e-23" data-line-number="23">                  <span class="cf">for</span> i <span class="kw">in</span> orig_cf.structured_input_signature[<span class="dv">0</span>]]</a>
<a class="sourceLine" id="org8555c2e-24" data-line-number="24"></a>
<a class="sourceLine" id="org8555c2e-25" data-line-number="25">    logpfn_fg_new.inputs <span class="op">=</span> new_inputs</a>
<a class="sourceLine" id="org8555c2e-26" data-line-number="26"></a>
<a class="sourceLine" id="org8555c2e-27" data-line-number="27">    <span class="cf">assert</span> <span class="bu">all</span>(i <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">for</span> i <span class="kw">in</span> logpfn_fg_new.inputs)</a>
<a class="sourceLine" id="org8555c2e-28" data-line-number="28"></a>
<a class="sourceLine" id="org8555c2e-29" data-line-number="29">    logpfn_fg_new.outputs <span class="op">=</span> [old_to_new_ops[output]]</a>
<a class="sourceLine" id="org8555c2e-30" data-line-number="30">    logpfn_fg_new.structured_outputs <span class="op">=</span> logpfn_fg_new.outputs[<span class="dv">0</span>]</a>
<a class="sourceLine" id="org8555c2e-31" data-line-number="31"></a>
<a class="sourceLine" id="org8555c2e-32" data-line-number="32">    <span class="cf">assert</span> logpfn_fg_new.as_graph_element(logpfn_fg_new.outputs[<span class="dv">0</span>]) <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></a>
<a class="sourceLine" id="org8555c2e-33" data-line-number="33"></a>
<a class="sourceLine" id="org8555c2e-34" data-line-number="34">    logpfn_new_cf <span class="op">=</span> ConcreteFunction(logpfn_fg_new)</a>
<a class="sourceLine" id="org8555c2e-35" data-line-number="35">    logpfn_new_cf._arg_keywords <span class="op">=</span> orig_cf._arg_keywords</a>
<a class="sourceLine" id="org8555c2e-36" data-line-number="36">    logpfn_new_cf._num_positional_args <span class="op">=</span> <span class="bu">len</span>(logpfn_fg_new.inputs)</a>
<a class="sourceLine" id="org8555c2e-37" data-line-number="37"></a>
<a class="sourceLine" id="org8555c2e-38" data-line-number="38">    <span class="cf">return</span> logpfn_new_cf</a></code></pre></div>
<div class="sourceCode" id="org1bb5328"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org1bb5328-1" data-line-number="1">logpfn_new_cf <span class="op">=</span> new_tf_function(logpfn_trans_tf, logpfn_cf)</a></code></pre></div>
<p>The new TF function, <code>logpfn_new_cf</code>, in Listing <a href="#org8555c2e">32</a> is the function we are going to use for sampling from the new log-likelihood.</p>
<div class="sourceCode" id="org7bec3c9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org7bec3c9-1" data-line-number="1">_ <span class="op">=</span> logpfn_cf(<span class="op">*</span>init.values()) <span class="op">-</span> logpfn_new_cf(<span class="op">*</span>init.values())</a></code></pre></div>
<div class="sourceCode" id="orgf0ac6d1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgf0ac6d1-1" data-line-number="1">tf.Tensor(<span class="fl">0.0</span>, shape<span class="op">=</span>(), dtype<span class="op">=</span>float32)</a></code></pre></div>
<p>Listing <a href="#org7bec3c9">34</a> shows the difference between a transformed and non-transformed log-likelihood value given the same inputs.</p>
</section>
<section id="sampling-from-the-new-log-likelihood" class="level1">
<h1>Sampling from the new Log-likelihood</h1>
<p>In Listing <a href="#org4a79807">37</a>, we reproduce the remaining steps of <code>pm.inference.sampling.sample</code> and–unnaturally–force the PyMC4 machinery to draw samples from our new transformed log-likelihood function.</p>
<div class="sourceCode" id="orgf17c3d2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgf17c3d2-1" data-line-number="1"><span class="im">from</span> importlib <span class="im">import</span> <span class="bu">reload</span></a>
<a class="sourceLine" id="orgf17c3d2-2" data-line-number="2"></a>
<a class="sourceLine" id="orgf17c3d2-3" data-line-number="3"></a>
<a class="sourceLine" id="orgf17c3d2-4" data-line-number="4"><span class="co"># Let&#39;s make sure we save the original function</span></a>
<a class="sourceLine" id="orgf17c3d2-5" data-line-number="5"><span class="bu">reload</span>(pm.inference.sampling)</a>
<a class="sourceLine" id="orgf17c3d2-6" data-line-number="6">_build_logp_function <span class="op">=</span> pm.inference.sampling.build_logp_function</a>
<a class="sourceLine" id="orgf17c3d2-7" data-line-number="7"></a>
<a class="sourceLine" id="orgf17c3d2-8" data-line-number="8"></a>
<a class="sourceLine" id="orgf17c3d2-9" data-line-number="9"><span class="kw">def</span> _new_build_logp_function(<span class="op">*</span>args, <span class="op">**</span>kwargs):</a>
<a class="sourceLine" id="orgf17c3d2-10" data-line-number="10">    <span class="cf">return</span> logpfn_new_cf, init</a>
<a class="sourceLine" id="orgf17c3d2-11" data-line-number="11"></a>
<a class="sourceLine" id="orgf17c3d2-12" data-line-number="12">pm.inference.sampling.build_logp_function <span class="op">=</span> _new_build_logp_function</a></code></pre></div>
<div class="sourceCode" id="org4a79807"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org4a79807-1" data-line-number="1">az_trace <span class="op">=</span> sample(model)</a></code></pre></div>
<figure id="fig:transformed-model-plot-energy">
<img src="https://brandonwillard.github.io/figures/transformed-model-plot-energy.png" alt="" />
<figcaption>
</figcaption>
</figure>
<figure id="fig:transformed-model-plot-trace">
<img src="https://brandonwillard.github.io/figures/transformed-model-plot-trace.png" alt="" />
<figcaption>
</figcaption>
</figure>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>The goals in the two separate <code>run</code> calls we used in Listing <a href="#org0ad3a96">20</a> could have been combined into a single <code>run</code>. This could’ve been accomplished using some “meta” steps (e.g. construct and evaluate a goal on-the-fly within a miniKanren) or special goals for reading from a miniKanren-generated <code>dict</code>s or association lists. Goals of this nature are not uncommon (e.g. type inference and inhabitation exmaples), and serve to demonstrate the great breadth of activity possible within relational context of miniKanren.</p>
<p>However, the point we want to make doesn’t require much sophistication. Instead, we wanted to demonstrate how a non-trivial “pattern” can be specified and matched using <code>symbolic-pymc</code>, and how easily those results could be used to transform a graph.</p>
<p>More specifically, our goal <code>shift_squared_subso</code> in <a href="#org0ad3a96">20</a> demonstrates <strong>the way in which we were able to specify desired structure(s) within a graph</strong>. We defined one pattern, <code>Y_sqrdiffo</code>, to match anywhere in the graph then another pattern, <code>X_sqrdiffo</code>, that relied on matched terms from <code>Y_sqrdiffo</code> and could also be matched/found anywhere else in the same graph.</p>
<p>Furthermore, our substitutions needed information from both “matched” subgraphs. Specifically, substitution pairs similar to <code>(x, z + x)</code>. Within this framework, we could just as easily have included <code>y</code>–or any terms from either successfully matched subgraph–in the substitution expressions.</p>
<p>In sample-space, the search patterns and substitutions are much easier to specify exactly because they’re single-subgraph patterns that themselves are the subgraphs to be replaced (i.e. if we find a non-standard normal, replace it with a shifted/scaled standard normal). In log-space, we chose to find distinct subgraph “chains”, i.e. all <code>(y - x)**2</code> and <code>(x - z)**2</code> pairs (i.e. “connected” by an “unknown” term <code>x</code>), since these are produced by the log-likelihood form of hierarchical normal distributions.</p>
<p>As a result, we had a non-trivial structure/“pattern” to express–and execute. Using conventional graph search-and-replace functionality would’ve required much more orchestration and resulted considerably less flexible code with little-to-no reusability. In our case, the goals <code>onceo</code> and <code>tf_graph_applyo</code> are universal and the forms in <code>shift_squared_subso</code> can be easily changed to account for more sophisticated (or entirely distinct) patterns and substitutions.</p>
<p>Most related graph manipulation offerings make it easy to find a single subgraph that matches a pattern, but not potentially “co-dependent” and/or distinct subgraphs. In the end, the developer will often have to manually implement a “global” state and orchestrate multiple single-subgraph searches and their results.</p>
<p>For single search-and-replace objectives, this amount of manual developer intervention/orchestration might be excusable; however, for objectives requiring the evaluation of multiple graph transformation, this approach is mostly unmaintainable and extremely difficult to compartmentalize.</p>
<p>This demonstration barely even scratches the surface of what’s possible using miniKanren and relational programming for graph manipulation and symbolic statistical model optimization. As the <code>symbolic-pymc</code> project advances, we’ll cover examples in which miniKanren’s more distinct offerings are demonstrated.</p>
</section>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  CommonHTML: { linebreaks: { automatic: true } },
  "HTML-CSS": { linebreaks: { automatic: true } },
  SVG: { linebreaks: { automatic: true } },
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
</body>
</html>

            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'brandonwillard-github-io'; // required: replace example with your forum shortname

                    var disqus_identifier = 'symbolic-pymc-radon-example-in-pymc4';
                var disqus_url = 'https://brandonwillard.github.io/symbolic-pymc-radon-example-in-pymc4.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="https://brandonwillard.github.io//images/profile-pic.png"/>
        </p>
    <p>
      <strong>About Brandon T. Willard</strong><br/>
        applied math/stats person
    </p>
</div><!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://linkedin.com/pub/brandon-willard/10/bb4/468/"><i class="fa fa-linkedin fa-lg"></i> linkedin</a></li>
    <li class="list-group-item"><a href="https://scholar.google.com/citations?user=g0oUxG4AAAAJ&hl=en"><i class="ai ai-google-scholar ai-lg"></i> google scholar</a></li>
    <li class="list-group-item"><a href="https://plus.google.com/+brandonwillard"><i class="fa fa-google-plus fa-lg"></i> google+</a></li>
    <li class="list-group-item"><a href="https://bitbucket.io/brandonwillard"><i class="fa fa-bitbucket-square fa-lg"></i> bitbucket</a></li>
    <li class="list-group-item"><a href="https://github.com/brandonwillard"><i class="fa fa-github-square fa-lg"></i> github</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2019 Brandon T. Willard
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en">Creative Commons Attribution-NonCommercial 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://brandonwillard.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://brandonwillard.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://brandonwillard.github.io/theme/js/respond.min.js"></script>


    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'brandonwillard-github-io'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-91585967-1', '');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->


</body>
</html>