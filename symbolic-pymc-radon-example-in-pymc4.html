<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Symbolic PyMC Radon Example in PyMC4 - Brandon T. Willard</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://brandonwillard.github.io/symbolic-pymc-radon-example-in-pymc4.html">

        <meta name="author" content="Brandon T. Willard" />
        <meta name="keywords" content="pymc4,tensorflow,symbolic computation,python,symbolic-pymc" />

        <meta property="og:site_name" content="Brandon T. Willard" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Symbolic PyMC Radon Example in PyMC4"/>
        <meta property="og:url" content="https://brandonwillard.github.io/symbolic-pymc-radon-example-in-pymc4.html"/>
        <meta property="og:description" content=""/>
        <meta property="article:published_time" content="2019-09-08" />
            <meta property="article:section" content="articles" />
            <meta property="article:tag" content="pymc4" />
            <meta property="article:tag" content="tensorflow" />
            <meta property="article:tag" content="symbolic computation" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="symbolic-pymc" />
            <meta property="article:author" content="Brandon T. Willard" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://brandonwillard.github.io/theme/css/bootstrap.readable.min.css" type="text/css"/>
    <link href="https://brandonwillard.github.io/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://brandonwillard.github.io/theme/css/academicons.min.css" rel="stylesheet">

    <link href="https://brandonwillard.github.io/theme/css/pygments/vim.css" rel="stylesheet">
    <link rel="stylesheet" href="https://brandonwillard.github.io/theme/css/style.css" type="text/css"/>
        <link href="https://brandonwillard.github.io/extra/custom.css" rel="stylesheet">

        <link href="https://brandonwillard.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Brandon T. Willard ATOM Feed"/>

        <link href="https://brandonwillard.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Brandon T. Willard RSS Feed"/>
        <link href="https://brandonwillard.github.io/feeds/articles.atom.xml" type="application/atom+xml" rel="alternate"
              title="Brandon T. Willard articles ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://brandonwillard.github.io/" class="navbar-brand">
Brandon T. Willard            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://brandonwillard.github.io/pages/publications.html">
                             Publications
                          </a></li>
                         <li><a href="https://brandonwillard.github.io/pages/projects.html">
                             Projects
                          </a></li>
                         <li><a href="https://brandonwillard.github.io/pages/about.html">
                             About
                          </a></li>
                        <li class="active">
                            <a href="https://brandonwillard.github.io/category/articles.html">Articles</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://brandonwillard.github.io/symbolic-pymc-radon-example-in-pymc4.html"
                       rel="bookmark"
                       title="Permalink to Symbolic PyMC Radon Example in PyMC4">
                        Symbolic PyMC Radon Example in PyMC4
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2019-09-08T00:00:00-05:00"> Sun 08 September 2019</time>
    </span>
          <span class="label label-default">Modified</span>
            <span class="modified">
                <i class="fa fa-calendar"></i><time datetime="2019-10-24T00:00:00-05:00"> Thu 24 October 2019</time>
            </span>





<span class="label label-default">Tags</span>
	<a href="https://brandonwillard.github.io/tag/pymc4.html">pymc4</a>
        /
	<a href="https://brandonwillard.github.io/tag/tensorflow.html">tensorflow</a>
        /
	<a href="https://brandonwillard.github.io/tag/symbolic-computation.html">symbolic computation</a>
        /
	<a href="https://brandonwillard.github.io/tag/python.html">python</a>
        /
	<a href="https://brandonwillard.github.io/tag/symbolic-pymc.html">symbolic-pymc</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Brandon T. Willard" />
  <title>Symbolic PyMC Radon Example in PyMC4</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML" id="MathJax-script"></script>
  <script>
   MathJax.Hub.Config({
       tex2jax: {
           processEnvironments: true,
           processRefs: false
       },
       TeX: {
           equationNumbers: { autoNumber: "AMS" },
           extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
       }
   });
  </script>
</head>
<body>
<!--  -->
<!-- <div id="header"> -->
<!-- <h1 class="title">Symbolic PyMC Radon Example in PyMC4</h1> -->
<!--  -->
<!--  -->
<!-- <h2 class="author">Brandon T. Willard</h2> -->
<!--  -->
<!--  -->
<!-- <h3 class="date">2019–09–08</h3> -->
<!--  -->
<!-- </div> -->
<!--  -->
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p><a href="https://github.com/pymc-devs/symbolic-pymc">Symbolic PyMC</a> is a library that provides tools for symbolic manipulation of Tensor library models in TensorFlow (TF) and Theano. Over time, we plan to add tools that are mostly specialized toward Bayesian model manipulation and mathematical identities relevant to MCMC.</p>
<p>The main approach taken by <code>symbolic-pymc</code> is relational/logic programming powered by a <a href="http://minikanren.org/">miniKanren</a> implementation in pure Python (based on the <a href="https://github.com/pymc-devs/kanren"><code>kanren</code></a> package).</p>
<p>As an example of how <code>symbolic-pymc</code>’s offerings can be used, we’ll create a model “optimizer” that approximates the re-centering and re-scaling commonly demonstrated on a hierarchical normal model for the radon dataset. This optimization is <strong>symbolic</strong> and effectively produces another equivalent model with better sampling properties.</p>
<p>A similar example already exists in Theano and PyMC3; it can be found in the <a href="https://github.com/pymc-devs/symbolic-pymc#automatic-re-centering-and-re-scaling">project README</a>. In this case, we will operate on TF graphs via PyMC4 and approximate the same optimization using a very different approach targeted toward the log-likelihood graph.</p>
<p>To get started, we download the radon dataset and define the initial model in Listings <a href="#org15f2d13">1</a>, <a href="#org84a4bd7">2</a>, and <a href="#orgf0b697c">3</a>.</p>
<figure id="org15f2d13">
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="im">import</span> pymc4 <span class="im">as</span> pm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="im">import</span> arviz <span class="im">as</span> az</span></code></pre></div>
<figcaption>
Listing 1
</figcaption>
</figure>
<figure id="org84a4bd7">
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>data <span class="op">=</span> pd.read_csv(<span class="st">&#39;https://github.com/pymc-devs/pymc3/raw/master/pymc3/examples/data/radon.csv&#39;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>county_names <span class="op">=</span> data.county.unique()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>county_idx <span class="op">=</span> data[<span class="st">&#39;county_code&#39;</span>].values.astype(np.int32)</span></code></pre></div>
<figcaption>
Listing 2
</figcaption>
</figure>
<figure id="orgf0b697c">
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="at">@pm.model</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="kw">def</span> hierarchical_model(data, county_idx):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>    <span class="co"># Hyperpriors</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>    mu_a <span class="op">=</span> <span class="cf">yield</span> pm.Normal(<span class="st">&#39;mu_alpha&#39;</span>, mu<span class="op">=</span><span class="fl">0.</span>, sigma<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>    sigma_a <span class="op">=</span> <span class="cf">yield</span> pm.HalfCauchy(<span class="st">&#39;sigma_alpha&#39;</span>, beta<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>    mu_b <span class="op">=</span> <span class="cf">yield</span> pm.Normal(<span class="st">&#39;mu_beta&#39;</span>, mu<span class="op">=</span><span class="fl">0.</span>, sigma<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>    sigma_b <span class="op">=</span> <span class="cf">yield</span> pm.HalfCauchy(<span class="st">&#39;sigma_beta&#39;</span>, beta<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>    <span class="co"># Intercept for each county, distributed around group mean mu_a</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>    a <span class="op">=</span> <span class="cf">yield</span> pm.Normal(<span class="st">&#39;alpha&#39;</span>, mu<span class="op">=</span>mu_a, sigma<span class="op">=</span>sigma_a, plate<span class="op">=</span><span class="bu">len</span>(data.county.unique()))</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>    <span class="co"># Intercept for each county, distributed around group mean mu_a</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>    b <span class="op">=</span> <span class="cf">yield</span> pm.Normal(<span class="st">&#39;beta&#39;</span>, mu<span class="op">=</span>mu_b, sigma<span class="op">=</span>sigma_b, plate<span class="op">=</span><span class="bu">len</span>(data.county.unique()))</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>    <span class="co"># Model error</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>    eps <span class="op">=</span> <span class="cf">yield</span> pm.HalfCauchy(<span class="st">&#39;eps&#39;</span>, beta<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a>    <span class="co"># Expected value</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a>    <span class="co">#radon_est = a[county_idx] + b[county_idx] * data.floor.values</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a>    radon_est <span class="op">=</span> tf.gather(a, county_idx) <span class="op">+</span> tf.gather(</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a>        b, county_idx) <span class="op">*</span> data.floor.values</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a>    <span class="co"># Data likelihood</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a>    y_like <span class="op">=</span> <span class="cf">yield</span> pm.Normal(<span class="st">&#39;y_like&#39;</span>, mu<span class="op">=</span>radon_est, sigma<span class="op">=</span>eps, observed<span class="op">=</span>data.log_radon)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a>init_num_chains <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true"></a>model <span class="op">=</span> hierarchical_model(data, county_idx)</span></code></pre></div>
<figcaption>
Listing 3
</figcaption>
</figure>
<p>In Listing <a href="#org76f5220">5</a>, we estimate the model using the sample routine from <a href="https://github.com/pymc-devs/pymc4/blob/master/notebooks/radon_hierarchical.ipynb">PyMC4’s Radon example Notebook</a> (reproduced in Listing <a href="#org9df08c0">4</a>). The same plots from the aforementioned notebook are also reproduced here in Figures <a href="#org2d6c05e">7</a> and <a href="#orgef38802">8</a>.</p>
<figure id="org9df08c0">
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">def</span> sample(model, init_num_chains<span class="op">=</span><span class="dv">50</span>, num_samples<span class="op">=</span><span class="dv">500</span>, burn_in<span class="op">=</span><span class="dv">500</span>):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    init_num_chains <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>    pm4_trace, _ <span class="op">=</span> pm.inference.sampling.sample(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>        model, num_chains<span class="op">=</span>init_num_chains, num_samples<span class="op">=</span><span class="dv">10</span>, burn_in<span class="op">=</span><span class="dv">10</span>, step_size<span class="op">=</span><span class="fl">1.</span>, xla<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>        step_size_ <span class="op">=</span> []</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>        <span class="cf">for</span> _, x <span class="kw">in</span> pm4_trace.items():</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>            std <span class="op">=</span> tf.math.reduce_std(x, axis<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>            step_size_.append(</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>                std[tf.newaxis, ...] <span class="op">*</span> tf.ones([init_num_chains] <span class="op">+</span> std.shape, dtype<span class="op">=</span>std.dtype))</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>        pm4_trace, _ <span class="op">=</span> pm.inference.sampling.sample(</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>            model, num_chains<span class="op">=</span>init_num_chains, num_samples<span class="op">=</span><span class="dv">10</span> <span class="op">+</span> <span class="dv">10</span><span class="op">*</span>i, burn_in<span class="op">=</span><span class="dv">10</span> <span class="op">+</span> <span class="dv">10</span><span class="op">*</span>i,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>            step_size<span class="op">=</span>step_size_, xla<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>    num_chains <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>    step_size_ <span class="op">=</span> []</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a>    <span class="cf">for</span> _, x <span class="kw">in</span> pm4_trace.items():</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a>        std <span class="op">=</span> tf.math.reduce_std(x, axis<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a>        step_size_.append(</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a>            std[tf.newaxis, ...] <span class="op">*</span> tf.ones([num_chains]<span class="op">+</span>std.shape, dtype<span class="op">=</span>std.dtype))</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a>    pm4_trace, sample_stat <span class="op">=</span> pm.inference.sampling.sample(</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a>        model, num_chains<span class="op">=</span>num_chains, num_samples<span class="op">=</span>num_samples, burn_in<span class="op">=</span>burn_in,</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true"></a>        step_size<span class="op">=</span>step_size_, xla<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true"></a>    az_trace <span class="op">=</span> pm.inference.utils.trace_to_arviz(pm4_trace, sample_stat)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true"></a>    <span class="cf">return</span> az_trace</span></code></pre></div>
<figcaption>
Listing 4
</figcaption>
</figure>
<figure id="org76f5220">
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>az_trace <span class="op">=</span> sample(model)</span></code></pre></div>
<figcaption>
Listing 5
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="im">from</span> matplotlib <span class="im">import</span> rcParams</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>rcParams[<span class="st">&#39;figure.figsize&#39;</span>] <span class="op">=</span> (<span class="fl">11.7</span>, <span class="fl">8.27</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a><span class="co"># plt.rc(&#39;text&#39;, usetex=True)</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>sns.set_style(<span class="st">&quot;whitegrid&quot;</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>sns.set_context(<span class="st">&quot;paper&quot;</span>)</span></code></pre></div>
</figure>
<figure>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>_ <span class="op">=</span> az.plot_energy(az_trace)</span></code></pre></div>
</figure>
<figure id="fig:pymc4-radon-plot-energy" class="plot">
<img src="https://brandonwillard.github.io/figures/pymc4-radon-plot-energy.png" title="fig:" alt="" />
<figcaption>
</figcaption>
</figure>
<figure id="fig:pymc4-radon-plot-trace" class="plot">
<img src="https://brandonwillard.github.io/figures/pymc4-radon-plot-trace.png" title="fig:" alt="" />
<figcaption>
</figcaption>
</figure>
</section>
<section id="the-models-log-likelihood-graph" class="level1">
<h1>The Model’s Log-likelihood Graph</h1>
<p>In order to apply our optimization, we need to obtain a graph of the log-likelihood function generated by the model in Listing <a href="#orgf0b697c">3</a>. With the graph in-hand, we can perform the re-centering and re-scaling transform–in log-space–and produce a new log-likelihood graph that improves sampling.</p>
<p>This exercise introduces the TensorFlow function-graph backed by the class <code>tensorflow.python.framework.func_graph.FuncGraph</code>. <code>FuncGraph</code> is a subclass of the regular <code>Graph</code> objects upon which <code>symbolic-pymc</code> indirectly operates. Just like Theano’s <code>FunctionGraph</code>s, <code>FuncGraph</code> simply specializes a generic graph by specifying which constituent tensors are considered inputs and outputs.</p>
<p>In Listing <a href="#orgc606190">8</a>, we use PyMC4’s internal mechanisms to build the log-likelihood function for our model and a corresponding list of initial values for the parameters.</p>
<figure id="orgc606190">
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>state <span class="op">=</span> <span class="va">None</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>observed <span class="op">=</span> <span class="va">None</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>logpfn, init <span class="op">=</span> pm.inference.sampling.build_logp_function(model,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>                                                         state<span class="op">=</span>state,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>                                                         observed<span class="op">=</span>observed)</span></code></pre></div>
<figcaption>
Listing 8
</figcaption>
</figure>
<p>From here we need <code>FuncGraph</code>s for each input to <code>logpfn</code>. Since <code>logpfn</code> is a <code>tensorflow.python.eager.def_function.Function</code> instance, every time it’s called with a specific tensor it may create a new function-object with its own <code>FuncGraph</code>. In other words, it dynamically generates function objects based on the inputs it’s given.</p>
<p>This specialization process can be performed manually using <code>logpfn.get_concrete_function(*args)</code>, which necessarily produces a <code>tensorflow.python.eager.function.ConcreteFunction</code> with the desired <code>FuncGraph</code>. Listing <a href="#org966cccf">9</a> creates and extracts these two objects.</p>
<figure id="org966cccf">
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a>logpfn_cf <span class="op">=</span> logpfn.get_concrete_function(<span class="op">*</span>init.values())</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>logpfn_fg <span class="op">=</span> logpfn_cf.graph</span></code></pre></div>
<figcaption>
Listing 9
</figcaption>
</figure>
<p>The outputs are now available in graph form as <code>logpfn_fg.outputs</code>.</p>
</section>
<section id="the-log-space-transform" class="level1">
<h1>The Log-space Transform</h1>
<p>Consider the following two equivalent hierarchical models,</p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    Y = X + \epsilon, \quad
    \epsilon \sim \operatorname{N}\left(0, \sigma^2\right)
    \\
    X \sim \operatorname{N}\left(\mu, \tau^2\right)
  \end{gathered}
\label{eq:model-1}
\end{equation}\]</span></p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    Y = \mu + \tau \cdot \tilde{X} + \epsilon, \quad
    \epsilon \sim \operatorname{N}\left(0, \sigma^2\right)
    \\
    \tilde{X} \sim \operatorname{N}\left(0, 1\right)
  \;.
  \end{gathered}
\label{eq:model-2}
\end{equation}\]</span></p>
<p>Models <span class="math inline">\(\eqref{eq:model-1}\)</span> and <span class="math inline">\(\eqref{eq:model-2}\)</span> are represented in (log) measure space, respectively, as follows:</p>
<p><span class="math display">\[\begin{align}
    \log p(Y, X) &amp;= \log P(Y\mid X) + \log P(X)
    \nonumber
    \\
    &amp;= C - \frac{1}{2} \left(\frac{y}{\sigma} - \frac{x}{\sigma}\right)^2 -
       \frac{1}{2} \left(\frac{x}{\tau} - \frac{\mu}{\tau}\right)^2
    \label{eq:log-model-1}
    \\
    &amp;= \tilde{C} - \frac{1}{2} \left(\frac{y}{\sigma} - \frac{\mu - \tau \cdot \tilde{x}}{\sigma}\right)^2 - \frac{1}{2} \tilde{x}^2
  \label{eq:log-model-2}
  \;.
\end{align}\]</span></p>
<p>Via term rewriting, Equation <span class="math inline">\(\eqref{eq:log-model-2}\)</span> is produced–in part–by applying the replacement rule <span class="math inline">\(x \to \mu + \tau \cdot \tilde{x}\)</span> to Equation <span class="math inline">\(\eqref{eq:log-model-1}\)</span>, i.e.</p>
<p><span class="math display">\[\begin{align*}
\tilde{C} - \frac{1}{2} \left(\frac{y}{\sigma} - \frac{\mu + \tau \cdot \tilde{x}}{\sigma}\right)^2 -
  \frac{1}{2} \left(\frac{\mu + \tau \cdot \tilde{x}}{\tau} - \frac{\mu}{\tau}\right)^2
\;.
\end{align*}\]</span></p>
<p>For consistency, the transform must also be applied to the <span class="math inline">\(dx\)</span> term where/when-ever it is considered.</p>
<p>After a few algebraic simplifications, one obtains the exact form of Equation <span class="math inline">\(\eqref{eq:log-model-2}\)</span>.</p>
</section>
<section id="creating-the-minikanren-goals" class="level1">
<h1>Creating the miniKanren Goals</h1>
<p><code>symbolic-pymc</code> is designed to use miniKanren as a means of specifying mathematical relations. The degree to which an implementation of a mathematical relation upholds its known characteristics is–of course–always up to the developer. For the needs of PPLs like PyMC4, we can’t reasonably expect–or provide–capabilities at the level of automatic theorem proving or every relevant state-of-the-art symbolic math routine.</p>
<p>Even so, we <strong>do</strong> expect that some capabilities from within those more advanced areas of symbolic computing will eventually be required–or necessary–and we want to build on a foundation that allows them to be integrated and/or simply expressed. We believe that miniKanren is a great foundation for such work due to the core concepts it shares with symbolic computation, as well as its immense flexibility. It also maintains an elegant simplicity and is amenable to developer intervention at nearly all levels–often without the need for low- or DSL-level rewrites.</p>
<p>User-level development in miniKanren occurs within its DSL, which is a succinct relational/logic programming paradigm that–in our case–is entirely written in Python. This DSL provides primitive <strong>goals</strong> that can be composed and eventually evaluated by the <code>run</code> function. We refer the reader to any one of the many great introductions to miniKanren available at <a href="http://minikanren.org" class="uri">http://minikanren.org</a>, or, for the specific Python package used here: <a href="https://github.com/logpy/logpy/blob/master/doc/basic.md">this simple introduction</a>.</p>
<p>For the matter at hand, we need to create goals that implement the substitution described above. The first step is to understand the exact TF graphs involved, and the best way to do that is to construct the relevant graph objects, observe them directly, and build “patterns” that match their general forms. Patterns are built with <code>symbolic-pymc</code> meta objects obtained from the <code>mt</code> helper “namespace”. Wherever we want to leave room for variation/ambiguity, we use a “logic variable” instead of an explicit TF (meta) object. Logic variables are created with <code>var()</code> and can optionally be given a string “name” argument that identifies them globally as a singleton-like object.</p>
<section id="inspecting-the-tf-graphs" class="level2">
<h2>Inspecting the TF Graphs</h2>
<p>In our case, the log-density returned by PyMC4–via the TensorFlow Probability library (TFP)– uses <code>tf.math.squared_difference</code> to construct the “squared error” term in the exponential of a normal distribution. This term contains everything we need to construct the substitution as a pair of TF graph objects.</p>
<p>Listing <a href="#orgc47d26d">10</a> shows the graph produced by a normal distribution in TFP.</p>
<figure id="orgc47d26d">
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="im">import</span> tensorflow_probability <span class="im">as</span> tfp</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="im">from</span> tensorflow.python.eager.context <span class="im">import</span> graph_mode</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="im">from</span> tensorflow.python.framework.ops <span class="im">import</span> disable_tensor_equality</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a><span class="im">from</span> symbolic_pymc.tensorflow.printing <span class="im">import</span> tf_dprint</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a>disable_tensor_equality()</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a><span class="cf">with</span> graph_mode(), tf.Graph().as_default() <span class="im">as</span> test_graph:</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a>    mu_tf <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, name<span class="op">=</span><span class="st">&#39;mu&#39;</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true"></a>                                     shape<span class="op">=</span>tf.TensorShape([<span class="va">None</span>]))</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true"></a>    tau_tf <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, name<span class="op">=</span><span class="st">&#39;tau&#39;</span>,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true"></a>                                      shape<span class="op">=</span>tf.TensorShape([<span class="va">None</span>]))</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true"></a>    normal_tfp <span class="op">=</span> tfp.distributions.normal.Normal(mu_tf, tau_tf)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true"></a>    value_tf <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, name<span class="op">=</span><span class="st">&#39;value&#39;</span>,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true"></a>                                        shape<span class="op">=</span>tf.TensorShape([<span class="va">None</span>]))</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true"></a>    normal_log_lik <span class="op">=</span> normal_tfp.log_prob(value_tf)</span></code></pre></div>
<figcaption>
Listing 10
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>tf_dprint(normal_log_lik)</span></code></pre></div>
</figure>
<figure>
<pre class="text"><code>Tensor(Sub):0,  shape=[None]    &quot;Normal_1/log_prob/sub:0&quot;
|  Tensor(Mul):0,   shape=[None]    &quot;Normal_1/log_prob/mul:0&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;Normal_1/log_prob/mul/x:0&quot;
|  |  |  -0.5
|  |  Tensor(SquaredDifference):0,  shape=[None]    &quot;Normal_1/log_prob/SquaredDifference:0&quot;
|  |  |  Tensor(RealDiv):0, shape=[None]    &quot;Normal_1/log_prob/truediv:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;value:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;tau:0&quot;
|  |  |  Tensor(RealDiv):0, shape=[None]    &quot;Normal_1/log_prob/truediv_1:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;mu:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;tau:0&quot;
|  Tensor(AddV2):0, shape=[None]    &quot;Normal_1/log_prob/add:0&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;Normal_1/log_prob/add/x:0&quot;
|  |  |  0.9189385
|  |  Tensor(Log):0,    shape=[None]    &quot;Normal_1/log_prob/Log:0&quot;
|  |  |  Tensor(Placeholder):0, shape=[None]    &quot;tau:0&quot;

</code></pre>
</figure>
<p>Instead of looking for the entire log-likelihood graph for a distribution, we can focus on only the <code>SquaredDifference</code> operators, since they contain all the relevant terms for our transformation.</p>
<p>More specifically, if we can identify “chains” of such terms, i.e. <code>SquaredDifference(y, x)</code> and <code>SquaredDifference(x, mu)</code>, then we might be able to assume that the corresponding subgraph was formed from such a hierarchical normal model.</p>
<p>Listing <a href="#orgacfcea8">13</a> shows the <code>SquaredDifference</code> sub-graphs in the log-likelihood graph for our radon model. It demonstrates two instances of said <code>SquaredDifference</code> “chains”: they involve tensors named <code>values_5</code> and <code>values_1</code>.</p>
<figure id="orgacfcea8">
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a>square_diff_outs <span class="op">=</span> [o.outputs[<span class="dv">0</span>] <span class="cf">for</span> o <span class="kw">in</span> logpfn_fg.get_operations()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>                    <span class="cf">if</span> o.<span class="bu">type</span> <span class="op">==</span> <span class="st">&#39;SquaredDifference&#39;</span> <span class="kw">or</span> o.<span class="bu">type</span>.startswith(<span class="st">&#39;Gather&#39;</span>)]</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a><span class="cf">for</span> t <span class="kw">in</span> square_diff_outs:</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>    tf_dprint(t)</span></code></pre></div>
<figcaption>
Listing 13
</figcaption>
</figure>
<figure>
<pre class="text"><code>Tensor(GatherV2):0, shape=[919] &quot;GatherV2:0&quot;
|  Tensor(Placeholder):0,   shape=[85]  &quot;values_3:0&quot;
|  Tensor(Const):0, shape=[919] &quot;GatherV2/indices:0&quot;
|  |  [ 0  0  0 ... 83 84 84]
|  Tensor(Const):0, shape=[]    &quot;GatherV2/axis:0&quot;
|  |  0
Tensor(GatherV2):0, shape=[919] &quot;GatherV2_1:0&quot;
|  Tensor(Placeholder):0,   shape=[85]  &quot;values_2:0&quot;
|  Tensor(Const):0, shape=[919] &quot;GatherV2_1/indices:0&quot;
|  |  [ 0  0  0 ... 83 84 84]
|  Tensor(Const):0, shape=[]    &quot;GatherV2_1/axis:0&quot;
|  |  0
Tensor(SquaredDifference):0,    shape=[]    &quot;Normal_5/log_prob/SquaredDifference:0&quot;
|  Tensor(RealDiv):0,   shape=[]    &quot;Normal_5/log_prob/truediv:0&quot;
|  |  Tensor(Placeholder):0,    shape=[]    &quot;values_1:0&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;Normal/scale:0&quot;
|  |  |  1.
|  Tensor(RealDiv):0,   shape=[]    &quot;Normal_5/log_prob/truediv_1:0&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;Normal/loc:0&quot;
|  |  |  0.
|  |  Tensor(Const):0,  shape=[]    &quot;Normal/scale:0&quot;
|  |  |  1.
Tensor(SquaredDifference):0,    shape=[]    &quot;Normal_1_1/log_prob/SquaredDifference:0&quot;
|  Tensor(RealDiv):0,   shape=[]    &quot;Normal_1_1/log_prob/truediv:0&quot;
|  |  Tensor(Placeholder):0,    shape=[]    &quot;values_4:0&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;Normal_1/scale:0&quot;
|  |  |  1.
|  Tensor(RealDiv):0,   shape=[]    &quot;Normal_1_1/log_prob/truediv_1:0&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;Normal_1/loc:0&quot;
|  |  |  0.
|  |  Tensor(Const):0,  shape=[]    &quot;Normal_1/scale:0&quot;
|  |  |  1.
Tensor(SquaredDifference):0,    shape=[85]  &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/SquaredDifference:0&quot;
|  Tensor(RealDiv):0,   shape=[85]  &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/truediv:0&quot;
|  |  Tensor(Transpose):0,  shape=[85]  &quot;SampleNormal_2_1/log_prob/transpose:0&quot;
|  |  |  Tensor(Reshape):0, shape=[85]  &quot;SampleNormal_2_1/log_prob/Reshape:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[85]  &quot;values_3:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[1]   &quot;SampleNormal_2_1/log_prob/Reshape/shape:0&quot;
|  |  |  |  |  [85]
|  |  |  Tensor(Const):0,   shape=[1]   &quot;SampleNormal_2_1/log_prob/transpose/perm:0&quot;
|  |  |  |  [0]
|  |  Tensor(Exp):0,    shape=[]    &quot;exp_1/forward/Exp:0&quot;
|  |  |  Tensor(Placeholder):0, shape=[]    &quot;values_0:0&quot;
|  Tensor(RealDiv):0,   shape=[]    &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/truediv_1:0&quot;
|  |  Tensor(Placeholder):0,    shape=[]    &quot;values_1:0&quot;
|  |  Tensor(Exp):0,    shape=[]    &quot;exp_1/forward/Exp:0&quot;
|  |  |  ...
Tensor(SquaredDifference):0,    shape=[85]  &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/SquaredDifference:0&quot;
|  Tensor(RealDiv):0,   shape=[85]  &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/truediv:0&quot;
|  |  Tensor(Transpose):0,  shape=[85]  &quot;SampleNormal_3_1/log_prob/transpose:0&quot;
|  |  |  Tensor(Reshape):0, shape=[85]  &quot;SampleNormal_3_1/log_prob/Reshape:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[85]  &quot;values_2:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[1]   &quot;SampleNormal_3_1/log_prob/Reshape/shape:0&quot;
|  |  |  |  |  [85]
|  |  |  Tensor(Const):0,   shape=[1]   &quot;SampleNormal_3_1/log_prob/transpose/perm:0&quot;
|  |  |  |  [0]
|  |  Tensor(Exp):0,    shape=[]    &quot;exp_2_1/forward/Exp:0&quot;
|  |  |  Tensor(Placeholder):0, shape=[]    &quot;values_5:0&quot;
|  Tensor(RealDiv):0,   shape=[]    &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/truediv_1:0&quot;
|  |  Tensor(Placeholder):0,    shape=[]    &quot;values_4:0&quot;
|  |  Tensor(Exp):0,    shape=[]    &quot;exp_2_1/forward/Exp:0&quot;
|  |  |  ...
Tensor(SquaredDifference):0,    shape=[919] &quot;Normal_4_1/log_prob/SquaredDifference:0&quot;
|  Tensor(RealDiv):0,   shape=[919] &quot;Normal_4_1/log_prob/truediv:0&quot;
|  |  Tensor(Const):0,  shape=[919] &quot;Normal_4_1/log_prob/value:0&quot;
|  |  |  [0.8329091 0.8329091 1.0986123 ... 1.6292405 1.3350011 1.0986123]
|  |  Tensor(Exp):0,    shape=[]    &quot;exp_3_1/forward/Exp:0&quot;
|  |  |  Tensor(Placeholder):0, shape=[]    &quot;values_6:0&quot;
|  Tensor(RealDiv):0,   shape=[919] &quot;Normal_4_1/log_prob/truediv_1:0&quot;
|  |  Tensor(AddV2):0,  shape=[919] &quot;add:0&quot;
|  |  |  Tensor(GatherV2):0,    shape=[919] &quot;GatherV2:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[85]  &quot;values_3:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[919] &quot;GatherV2/indices:0&quot;
|  |  |  |  |  [ 0  0  0 ... 83 84 84]
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;GatherV2/axis:0&quot;
|  |  |  |  |  0
|  |  |  Tensor(Mul):0, shape=[919] &quot;mul:0&quot;
|  |  |  |  Tensor(GatherV2):0, shape=[919] &quot;GatherV2_1:0&quot;
|  |  |  |  |  Tensor(Placeholder):0,   shape=[85]  &quot;values_2:0&quot;
|  |  |  |  |  Tensor(Const):0, shape=[919] &quot;GatherV2_1/indices:0&quot;
|  |  |  |  |  |  [ 0  0  0 ... 83 84 84]
|  |  |  |  |  Tensor(Const):0, shape=[]    &quot;GatherV2_1/axis:0&quot;
|  |  |  |  |  |  0
|  |  |  |  Tensor(Const):0,    shape=[919] &quot;mul/y:0&quot;
|  |  |  |  |  [1. 0. 0. ... 0. 0. 0.]
|  |  Tensor(Exp):0,    shape=[]    &quot;exp_3_1/forward/Exp:0&quot;
|  |  |  ...

</code></pre>
</figure>
<p>The names in the TFP graph are not based on the PyMC4 model objects, so, to make the graph output slightly more interpretable, Listing <a href="#orgc9910cb">15</a> attempts to re-association the labels.</p>
<figure id="orgc9910cb">
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>tfp_names_to_pymc <span class="op">=</span> {i.name: k <span class="cf">for</span> i, k <span class="kw">in</span> <span class="bu">zip</span>(logpfn_cf.structured_input_signature[<span class="dv">0</span>], init.keys())}</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a>pprint(tfp_names_to_pymc)</span></code></pre></div>
<figcaption>
Listing 15
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a>{<span class="st">&#39;values_0&#39;</span>: <span class="st">&#39;hierarchical_model/__log_sigma_alpha&#39;</span>,</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a> <span class="st">&#39;values_1&#39;</span>: <span class="st">&#39;hierarchical_model/mu_alpha&#39;</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a> <span class="st">&#39;values_2&#39;</span>: <span class="st">&#39;hierarchical_model/beta&#39;</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a> <span class="st">&#39;values_3&#39;</span>: <span class="st">&#39;hierarchical_model/alpha&#39;</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a> <span class="st">&#39;values_4&#39;</span>: <span class="st">&#39;hierarchical_model/mu_beta&#39;</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a> <span class="st">&#39;values_5&#39;</span>: <span class="st">&#39;hierarchical_model/__log_sigma_beta&#39;</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a> <span class="st">&#39;values_6&#39;</span>: <span class="st">&#39;hierarchical_model/__log_eps&#39;</span>}</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a></span></code></pre></div>
</figure>
</section>
<section id="graph-normalization" class="level2">
<h2>Graph Normalization</h2>
<p>In general, we don’t want our “patterns” to be “brittle”, e.g. rely on explicit–yet variable–term orderings in commutative operators (e.g. a pattern that exclusively targets <code>mt.add(x_lv, y_lv)</code> and won’t match the equivalent <code>mt.add(y_lv, x_lv)</code>).</p>
<p>The <code>grappler</code> library in TensorFlow provides a subset of graph pruning/optimization steps. Ideally, a library like <code>grappler</code> would provide full-fledged graph normalization/canonicalization upon which we could base the subgraphs used in our relations.</p>
<div class="remark" data-markdown="">
<p>While <code>grappler</code> does appear to provide some minimal algebraic normalizations, the extent to which these are performed and their breadth of relevant operator coverage isn’t clear; however, the normalizations that it does provide are worth using, so we’ll make use of them throughout.</p>
</div>
<p>Listing <a href="#org0c58115">17</a> provides a simple means of applying <code>grappler</code>.</p>
<figure id="org0c58115">
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="im">from</span> tensorflow.core.protobuf <span class="im">import</span> config_pb2</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a><span class="im">from</span> tensorflow.python.framework <span class="im">import</span> ops</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a><span class="im">from</span> tensorflow.python.framework <span class="im">import</span> importer</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a><span class="im">from</span> tensorflow.python.framework <span class="im">import</span> meta_graph</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true"></a><span class="im">from</span> tensorflow.python.grappler <span class="im">import</span> cluster</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true"></a><span class="im">from</span> tensorflow.python.grappler <span class="im">import</span> tf_optimizer</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true"></a><span class="cf">try</span>:</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true"></a>    gcluster <span class="op">=</span> cluster.Cluster()</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true"></a><span class="cf">except</span> tf.errors.UnavailableError:</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true"></a>    <span class="cf">pass</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true"></a>config <span class="op">=</span> config_pb2.ConfigProto()</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true"></a><span class="kw">def</span> normalize_tf_graph(graph_output, graph_inputs<span class="op">=</span>[]):</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Use grappler to normalize a graph.</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true"></a><span class="co">    Arguments</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true"></a><span class="co">    =========</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true"></a><span class="co">    graph_output: Tensor</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true"></a><span class="co">      A tensor we want to consider as &quot;output&quot; of a FuncGraph.</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true"></a><span class="co">    graph_inputs: list of Tensor (optional)</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true"></a><span class="co">      Any tensors that correspond to inputs for the given output node.</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true"></a><span class="co">    Returns</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true"></a><span class="co">    =======</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true"></a><span class="co">    The simplified graph.</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true"></a>    train_op <span class="op">=</span> graph_output.graph.get_collection_ref(ops.GraphKeys.TRAIN_OP)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true"></a>    train_op.clear()</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true"></a>    train_op.extend([graph_output] <span class="op">+</span> graph_inputs)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true"></a>    <span class="co"># if graph_inputs is not None:</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true"></a>    <span class="co">#     # ops.GraphKeys.MODEL_VARIABLES?</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true"></a>    <span class="co">#     train_vars = graph_output.graph.get_collection_ref(ops.GraphKeys.TRAINABLE_VARIABLES),</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true"></a>    <span class="co">#     train_vars.clear()</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true"></a>    <span class="co">#     train_vars.extend(graph_inputs)</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true"></a>    metagraph <span class="op">=</span> meta_graph.create_meta_graph_def(graph<span class="op">=</span>graph_output.graph)</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true"></a></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true"></a>    optimized_graphdef <span class="op">=</span> tf_optimizer.OptimizeGraph(</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true"></a>        config, metagraph, verbose<span class="op">=</span><span class="va">True</span>, cluster<span class="op">=</span>gcluster)</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true"></a></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true"></a>    optimized_graph <span class="op">=</span> ops.Graph()</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true"></a>    <span class="cf">with</span> optimized_graph.as_default():</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true"></a>        importer.import_graph_def(optimized_graphdef, name<span class="op">=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true"></a></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true"></a>    opt_graph_output <span class="op">=</span> optimized_graph.get_tensor_by_name(graph_output.name)</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true"></a></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true"></a>    <span class="cf">return</span> opt_graph_output</span></code></pre></div>
<figcaption>
Listing 17
</figcaption>
</figure>
<p>In Listing <a href="#org0c58115">17</a> we run <code>grappler</code> on the log-likelihood graph for a normal random variable from Listing <a href="#orgc47d26d">10</a>.</p>
<figure>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a>normal_log_lik_opt <span class="op">=</span> normalize_tf_graph(normal_log_lik)</span></code></pre></div>
</figure>
<p>Listing <a href="#org04c54ca">19</a> compares the computed outputs for the original and normalized graphs–given identical inputs.</p>
<figure id="org04c54ca">
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a>res_unopt <span class="op">=</span> normal_log_lik.<span class="bu">eval</span>({<span class="st">&#39;mu:0&#39;</span>: np.r_[<span class="dv">3</span>], <span class="st">&#39;tau:0&#39;</span>: np.r_[<span class="dv">1</span>], <span class="st">&#39;value:0&#39;</span>: np.r_[<span class="dv">1</span>]},</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>                                 session<span class="op">=</span>tf.compat.v1.Session(graph<span class="op">=</span>normal_log_lik.graph))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a>res_opt <span class="op">=</span> normal_log_lik_opt.<span class="bu">eval</span>({<span class="st">&#39;mu:0&#39;</span>: np.r_[<span class="dv">3</span>], <span class="st">&#39;tau:0&#39;</span>: np.r_[<span class="dv">1</span>], <span class="st">&#39;value:0&#39;</span>: np.r_[<span class="dv">1</span>]},</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>                                  session<span class="op">=</span>tf.compat.v1.Session(graph<span class="op">=</span>normal_log_lik_opt.graph))</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a><span class="co"># They should be equal, naturally</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a><span class="cf">assert</span> np.array_equal(res_unopt, res_opt)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true"></a>_ <span class="op">=</span> [res_unopt, res_opt]</span></code></pre></div>
<figcaption>
Listing 19
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a>[array([<span class="op">-</span><span class="fl">2.9189386</span>], dtype<span class="op">=</span>float32), array([<span class="op">-</span><span class="fl">2.9189386</span>], dtype<span class="op">=</span>float32)]</span></code></pre></div>
</figure>
<figure id="orge1da777">
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a>tf_dprint(normal_log_lik_opt)</span></code></pre></div>
<figcaption>
Listing 21
</figcaption>
</figure>
<figure>
<pre class="text"><code>Tensor(Sub):0,  shape=[None]    &quot;Normal_1/log_prob/sub:0&quot;
|  Tensor(Mul):0,   shape=[None]    &quot;Normal_1/log_prob/mul:0&quot;
|  |  Tensor(SquaredDifference):0,  shape=[None]    &quot;Normal_1/log_prob/SquaredDifference:0&quot;
|  |  |  Tensor(RealDiv):0, shape=[None]    &quot;Normal_1/log_prob/truediv:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;value:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;tau:0&quot;
|  |  |  Tensor(RealDiv):0, shape=[None]    &quot;Normal_1/log_prob/truediv_1:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;mu:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;tau:0&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;Normal_1/log_prob/mul/x:0&quot;
|  |  |  -0.5
|  Tensor(AddV2):0, shape=[None]    &quot;Normal_1/log_prob/add:0&quot;
|  |  Tensor(Log):0,    shape=[None]    &quot;Normal_1/log_prob/Log:0&quot;
|  |  |  Tensor(Placeholder):0, shape=[None]    &quot;tau:0&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;Normal_1/log_prob/add/x:0&quot;
|  |  |  0.9189385

</code></pre>
</figure>
<p>From the output of Listing <a href="#orge1da777">21</a>, we can see that <code>grappler</code> has performed some constant folding and has reordered the inputs in <code>"add_1_1"</code>–among other things.</p>
</section>
<section id="minikanren-transform-relations" class="level2">
<h2>miniKanren Transform Relations</h2>
<p>In Listing <a href="#org0ad3a96">23</a>, we create miniKanren functions that identify the aforementioned <code>SquaredDifference</code> “chains” and perform the re-centering/scaling substitutions.</p>
<figure id="org0ad3a96">
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="im">from</span> itertools <span class="im">import</span> chain</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true"></a><span class="im">from</span> unification <span class="im">import</span> var, reify, unify</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true"></a><span class="im">from</span> kanren <span class="im">import</span> run, eq, lall, conde</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true"></a><span class="im">from</span> kanren.goals <span class="im">import</span> not_equalo</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true"></a><span class="im">from</span> kanren.core <span class="im">import</span> goaleval</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true"></a><span class="im">from</span> symbolic_pymc.tensorflow.meta <span class="im">import</span> mt</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true"></a><span class="im">from</span> symbolic_pymc.relations <span class="im">import</span> buildo</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true"></a><span class="im">from</span> symbolic_pymc.relations.graph <span class="im">import</span> graph_applyo, reduceo</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true"></a><span class="im">from</span> symbolic_pymc.etuple <span class="im">import</span> ExpressionTuple, etuple</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true"></a><span class="kw">def</span> onceo(goal):</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;A non-relational operator that yields only the first result from a relation.&quot;&quot;&quot;</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true"></a>    <span class="kw">def</span> onceo_goal(s):</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true"></a>        <span class="kw">nonlocal</span> goal</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true"></a>        g <span class="op">=</span> reify(goal, s)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true"></a>        g_stream <span class="op">=</span> goaleval(g)(s)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true"></a>        s <span class="op">=</span> <span class="bu">next</span>(g_stream)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true"></a>        <span class="cf">yield</span> s</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true"></a>    <span class="cf">return</span> onceo_goal</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true"></a><span class="kw">def</span> tf_graph_applyo(relation, a, b):</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Construct a `graph_applyo` goal that evaluates a relation only at tensor nodes in a meta graph.</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true"></a><span class="co">    Parameters</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true"></a><span class="co">    ----------</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true"></a><span class="co">    relation: function</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true"></a><span class="co">      A binary relation/goal constructor function</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true"></a><span class="co">    a: lvar, meta graph, or etuple</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true"></a><span class="co">      The left-hand side of the relation.</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true"></a><span class="co">    b: lvar, meta graph, or etuple</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true"></a><span class="co">      The right-hand side of the relation</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true"></a></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true"></a>    <span class="kw">def</span> _expand_some_nodes(node):</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(node, mt.Tensor) <span class="kw">and</span> node.op <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true"></a>            <span class="cf">return</span> etuple(node.operator, <span class="op">*</span>node.inputs, eval_obj<span class="op">=</span>node)</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true"></a></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true"></a>    gapplyo <span class="op">=</span> partial(graph_applyo, relation, preprocess_graph<span class="op">=</span>_expand_some_nodes)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true"></a>    <span class="cf">return</span> gapplyo(a, b)</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true"></a></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true"></a></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true"></a><span class="kw">def</span> tfp_normal_log_prob(loc, scale):</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true"></a>    log_unnormalized <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> tf.math.squared_difference(</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true"></a>        x <span class="op">/</span> scale, loc <span class="op">/</span> scale)</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true"></a>    log_normalization <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> np.log(<span class="fl">2.</span> <span class="op">*</span> np.pi) <span class="op">+</span> tf.math.log(scale)</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true"></a>    <span class="cf">return</span> log_unnormalized <span class="op">-</span> log_normalization</span></code></pre></div>
<figcaption>
Listing 23
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a><span class="kw">def</span> shift_squared_subso(in_graph, out_subs):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Construct a goal that produces transforms for chains like (y + x)**2, (x + z)**2.&quot;&quot;&quot;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a>    Y_lv, X_lv, mu_X_lv <span class="op">=</span> var(), var(), var()</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a>    scale_Y_lv <span class="op">=</span> var()</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true"></a>    X_form_lv <span class="op">=</span> mt.Placeholder(dtype<span class="op">=</span>var(), shape<span class="op">=</span>var(), name<span class="op">=</span>var())</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true"></a>    <span class="co"># The actual base object&#39;s placeholder might have `_user_specified_name` as</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true"></a>    <span class="co"># an extra `op.node_def.attr`, so let&#39;s just make the entire NodeDef a</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true"></a>    <span class="co"># logic variable.</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true"></a>    X_form_lv.op.node_def <span class="op">=</span> var()</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true"></a>    mu_Y_lv <span class="op">=</span> mt.realdiv(X_lv, scale_Y_lv, name<span class="op">=</span>var())</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true"></a>    <span class="co"># Y_T_reshaped_lv = mt.Transpose(mt.reshape(Y_lv, var(), name=var()), var())</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true"></a>    Y_reshaped_lv <span class="op">=</span> mt.reshape(Y_lv, var(), name<span class="op">=</span>var())</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true"></a>    sqr_diff_Y_lv <span class="op">=</span> mt.SquaredDifference(</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true"></a>        mt.realdiv(Y_reshaped_lv,</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true"></a>                   scale_Y_lv,</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true"></a>                   name<span class="op">=</span>var()),</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true"></a>        mu_Y_lv,</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true"></a>        name<span class="op">=</span>var())</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true"></a>    <span class="kw">def</span> Y_sqrdiffo(in_g, out_g):</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true"></a>        <span class="cf">return</span> lall(eq(in_g, sqr_diff_Y_lv),</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true"></a>                    <span class="co"># This just makes sure that we&#39;re only considering X&#39;s</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true"></a>                    <span class="co"># that are Placeholders.</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true"></a>                    eq(X_lv, X_form_lv))</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true"></a></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true"></a>    scale_X_lv <span class="op">=</span> var()</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true"></a>    sqr_diff_X_lv <span class="op">=</span> mt.SquaredDifference(</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true"></a>        <span class="co"># Mul is only used because RealDiv with 1 is changed by grappler</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true"></a>        <span class="co"># mt.realdiv(X_lv, X_denom_lv, name=var()),</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true"></a>        mt.mul(scale_X_lv, X_lv, name<span class="op">=</span>var()),</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true"></a>        mu_X_lv,</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true"></a>        name<span class="op">=</span>var())</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true"></a></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true"></a>    <span class="kw">def</span> X_sqrdiffo(in_g, out_g):</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true"></a>        <span class="cf">return</span> eq(in_g, sqr_diff_X_lv)</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true"></a></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true"></a>    Y_new_mt <span class="op">=</span> mt.addv2(X_lv, mt.mul(scale_Y_lv, Y_lv))</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true"></a>    Y_log_scale <span class="op">=</span> mt.log(scale_Y_lv, name<span class="op">=</span>var())</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true"></a></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true"></a>    res <span class="op">=</span> lall(</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true"></a>        <span class="co"># The first (y - x/a)**2 (anywhere in the graph)</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true"></a>        tf_graph_applyo(Y_sqrdiffo, in_graph, in_graph),</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true"></a></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true"></a>        <span class="co"># The corresponding (x/b - z)**2 (also anywhere else in the graph)</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true"></a>        tf_graph_applyo(X_sqrdiffo, in_graph, in_graph),</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true"></a></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true"></a>        <span class="co"># Find the log-scale factor (at this point, we might as well match an</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true"></a>        <span class="co"># entire normal log-likelihood!)</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true"></a>        tf_graph_applyo(<span class="kw">lambda</span> x, y: eq(x, Y_log_scale), in_graph, in_graph),</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true"></a></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true"></a>        <span class="co"># Not sure if we need this, but we definitely don&#39;t want X == Y</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true"></a>        (not_equalo, [Y_lv, X_lv], <span class="va">True</span>),</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true"></a></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true"></a>        <span class="co"># Create replacement rule pairs</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true"></a>        eq(out_subs, [[Y_lv, Y_new_mt],</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true"></a>                      [Y_log_scale, <span class="fl">0.0</span>]]))</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true"></a></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true"></a>    <span class="cf">return</span> res</span></code></pre></div>
</figure>
<figure>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="kw">def</span> shift_squared_terms(in_obj, graph_inputs<span class="op">=</span>[]):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Re-center/scale SquaredDifference terms corresponding to hierarchical normals.&quot;&quot;&quot;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a>    <span class="co"># Normalize and convert to a meta graph</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a>    in_obj <span class="op">=</span> mt(normalize_tf_graph(in_obj, graph_inputs<span class="op">=</span>graph_inputs))</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true"></a>    <span class="co"># This run returns all the substitutions found in the graph</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true"></a>    subs_lv <span class="op">=</span> var()</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true"></a>    subs_res <span class="op">=</span> run(<span class="dv">0</span>, subs_lv, shift_squared_subso(in_obj, subs_lv))</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true"></a>    <span class="cf">if</span> <span class="kw">not</span> subs_res:</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="st">&quot;Failed to find the required forms within the graph.&quot;</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true"></a>        <span class="cf">return</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: We&#39;re only going to apply the first transformation pair for now.</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true"></a>    subs_res <span class="op">=</span> [subs_res[<span class="dv">0</span>]]</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true"></a>    <span class="kw">def</span> subs_replaceo(in_g, out_g):</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Create a goal that applies substitutions to a graph.&quot;&quot;&quot;</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true"></a>        <span class="kw">def</span> _subs_replaceo(in_g, out_g):</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true"></a>            <span class="kw">nonlocal</span> subs_res</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true"></a>            <span class="co"># Each result is a pair of replacement pairs:</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true"></a>            <span class="co">#   the first pair is the re-center/scale transform,</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true"></a>            <span class="co">#   the second pair is the cancellation of the log differential scale term.</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true"></a>            subs_goals <span class="op">=</span> [[eq(in_g, x), eq(out_g, y)]</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true"></a>                          <span class="cf">for</span> x, y <span class="kw">in</span> chain.from_iterable(subs_res)]</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true"></a>            x_g <span class="op">=</span> conde(<span class="op">*</span>subs_goals)</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true"></a>            <span class="cf">return</span> x_g</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true"></a></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true"></a>        g <span class="op">=</span> onceo(tf_graph_applyo(_subs_replaceo, in_g, out_g))</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true"></a>        <span class="cf">return</span> g</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true"></a>    <span class="co"># Apply each substitution once</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true"></a>    out_graph_lv <span class="op">=</span> var()</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true"></a>    res <span class="op">=</span> run(<span class="dv">1</span>, out_graph_lv, reduceo(subs_replaceo, in_obj, out_graph_lv))</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true"></a>    <span class="cf">if</span> res:</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true"></a></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true"></a>        <span class="kw">def</span> reify_res(graph_res):</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true"></a>            <span class="co">&quot;&quot;&quot;Reconstruct and/or reify meta object results.&quot;&quot;&quot;</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true"></a>            from_etuple <span class="op">=</span> graph_res.eval_obj <span class="cf">if</span> <span class="bu">isinstance</span>(graph_res, ExpressionTuple) <span class="cf">else</span> graph_res</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(from_etuple, <span class="st">&#39;reify&#39;</span>):</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true"></a>                <span class="cf">return</span> from_etuple.reify()</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true"></a>            <span class="cf">else</span>:</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true"></a>                <span class="cf">return</span> from_etuple</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true"></a>        res <span class="op">=</span> [reify_res(r) <span class="cf">for</span> r <span class="kw">in</span> res]</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true"></a></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true"></a>    <span class="cf">if</span> <span class="bu">len</span>(res) <span class="op">==</span> <span class="dv">1</span> <span class="kw">and</span> <span class="bu">isinstance</span>(res[<span class="dv">0</span>], tf.Tensor):</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true"></a>        graph_res <span class="op">=</span> res[<span class="dv">0</span>]</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true"></a>        <span class="cf">return</span> normalize_tf_graph(graph_res, graph_inputs<span class="op">=</span>graph_inputs), subs_res</span></code></pre></div>
</figure>
<p>As a test, we will run our miniKanren relations on the log-likelihood graph for a normal-normal hierarchical model in Listing <a href="#org29e93d9">26</a>.</p>
<figure id="org29e93d9">
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a><span class="cf">with</span> graph_mode(), tf.Graph().as_default() <span class="im">as</span> demo_graph:</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a>    X_tfp <span class="op">=</span> tfp.distributions.normal.Normal(<span class="fl">0.0</span>, <span class="fl">1.0</span>, name<span class="op">=</span><span class="st">&#39;X&#39;</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a>    x_tf <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, name<span class="op">=</span><span class="st">&#39;value_x&#39;</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true"></a>                                    shape<span class="op">=</span>tf.TensorShape([<span class="va">None</span>]))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true"></a>    tau_tf <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, name<span class="op">=</span><span class="st">&#39;tau&#39;</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true"></a>                                      shape<span class="op">=</span>tf.TensorShape([<span class="va">None</span>]))</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true"></a>    Y_tfp <span class="op">=</span> tfp.distributions.normal.Normal(x_tf, tau_tf, name<span class="op">=</span><span class="st">&#39;Y&#39;</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true"></a>    y_tf <span class="op">=</span> tf.compat.v1.placeholder(tf.float32, name<span class="op">=</span><span class="st">&#39;value_y&#39;</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true"></a>                                    shape<span class="op">=</span>tf.TensorShape([<span class="va">None</span>]))</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true"></a>    y_T_reshaped <span class="op">=</span> tf.transpose(tf.reshape(y_tf, []))</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true"></a>    hier_norm_lik <span class="op">=</span> tf.math.log(y_tf) <span class="op">+</span> Y_tfp.log_prob(y_T_reshaped) <span class="op">+</span> X_tfp.log_prob(x_tf)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true"></a>    hier_norm_lik <span class="op">=</span> normalize_tf_graph(hier_norm_lik)</span></code></pre></div>
<figcaption>
Listing 26
</figcaption>
</figure>
<p>Listing <a href="#org59b1e29">27</a> shows the form that a graph representing a hierarchical normal-normal model will generally take in TFP.</p>
<figure id="org59b1e29">
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a>tf_dprint(hier_norm_lik)</span></code></pre></div>
<figcaption>
Listing 27
</figcaption>
</figure>
<figure>
<pre class="text"><code>Tensor(AddV2):0,    shape=[None]    &quot;add_1:0&quot;
|  Tensor(Sub):0,   shape=[None]    &quot;X_1/log_prob/sub:0&quot;
|  |  Tensor(Mul):0,    shape=[None]    &quot;X_1/log_prob/mul:0&quot;
|  |  |  Tensor(SquaredDifference):0,   shape=[None]    &quot;X_1/log_prob/SquaredDifference:0&quot;
|  |  |  |  Tensor(Mul):0,  shape=[None]    &quot;X_1/log_prob/truediv:0&quot;
|  |  |  |  |  Tensor(Const):0, shape=[]    &quot;ConstantFolding/X_1/log_prob/truediv_recip:0&quot;
|  |  |  |  |  |  1.
|  |  |  |  |  Tensor(Placeholder):0,   shape=[None]    &quot;value_x:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;X_1/log_prob/truediv_1:0&quot;
|  |  |  |  |  0.
|  |  |  Tensor(Const):0,   shape=[]    &quot;Y_1/log_prob/mul/x:0&quot;
|  |  |  |  -0.5
|  |  Tensor(Const):0,  shape=[]    &quot;Y_1/log_prob/add/x:0&quot;
|  |  |  0.9189385
|  Tensor(AddV2):0, shape=[None]    &quot;add:0&quot;
|  |  Tensor(Log):0,    shape=[None]    &quot;Log:0&quot;
|  |  |  Tensor(Placeholder):0, shape=[None]    &quot;value_y:0&quot;
|  |  Tensor(Sub):0,    shape=[None]    &quot;Y_1/log_prob/sub:0&quot;
|  |  |  Tensor(Mul):0, shape=[None]    &quot;Y_1/log_prob/mul:0&quot;
|  |  |  |  Tensor(SquaredDifference):0,    shape=[None]    &quot;Y_1/log_prob/SquaredDifference:0&quot;
|  |  |  |  |  Tensor(RealDiv):0,   shape=[None]    &quot;Y_1/log_prob/truediv:0&quot;
|  |  |  |  |  |  Tensor(Reshape):0,    shape=[]    &quot;Reshape:0&quot;
|  |  |  |  |  |  |  Tensor(Placeholder):0, shape=[None]    &quot;value_y:0&quot;
|  |  |  |  |  |  |  Tensor(Const):0,   shape=[0]   &quot;Reshape/shape:0&quot;
|  |  |  |  |  |  |  |  []
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;tau:0&quot;
|  |  |  |  |  Tensor(RealDiv):0,   shape=[None]    &quot;Y_1/log_prob/truediv_1:0&quot;
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;value_x:0&quot;
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;tau:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;Y_1/log_prob/mul/x:0&quot;
|  |  |  |  |  -0.5
|  |  |  Tensor(AddV2):0,   shape=[None]    &quot;Y_1/log_prob/add:0&quot;
|  |  |  |  Tensor(Log):0,  shape=[None]    &quot;Y_1/log_prob/Log:0&quot;
|  |  |  |  |  Tensor(Placeholder):0,   shape=[None]    &quot;tau:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;Y_1/log_prob/add/x:0&quot;
|  |  |  |  |  0.9189385

</code></pre>
</figure>
<p>Listing <a href="#orgf81b6e5">29</a> runs our transformation and Listing <a href="#orga761bbe">32</a> prints the resulting graph.</p>
<figure id="orgf81b6e5">
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a><span class="cf">with</span> graph_mode(), demo_graph.as_default():</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a>    test_output_res, test_remaps <span class="op">=</span> shift_squared_terms(hier_norm_lik, graph_inputs<span class="op">=</span>[x_tf, y_tf])</span></code></pre></div>
<figcaption>
Listing 29
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a><span class="cf">for</span> rm <span class="kw">in</span> test_remaps:</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a>    <span class="cf">for</span> r <span class="kw">in</span> rm:</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a>      tf_dprint(r[<span class="dv">0</span>])</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true"></a>      <span class="bu">print</span>(<span class="st">&quot;-&gt;&quot;</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true"></a>      tf_dprint(r[<span class="dv">1</span>])</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true"></a>      <span class="bu">print</span>(<span class="st">&quot;------&quot;</span>)</span></code></pre></div>
</figure>
<figure>
<pre class="text"><code>Tensor(Placeholder):0,  shape=[None]    &quot;value_y:0&quot;
-&gt;
Tensor(AddV2):0,    shape=[None]    &quot;AddV2:0&quot;
|  Tensor(Placeholder):0,   shape=[None]    &quot;value_x:0&quot;
|  Tensor(Mul):0,   shape=[None]    &quot;Mul:0&quot;
|  |  Tensor(Placeholder):0,    shape=[None]    &quot;tau:0&quot;
|  |  Tensor(Placeholder):0,    shape=[None]    &quot;value_y:0&quot;
------
Tensor(Log):0,  shape=~_12312   &quot;Y_1/log_prob/Log:0&quot;
|  Tensor(Placeholder):0,   shape=[None]    &quot;tau:0&quot;
-&gt;
0.0
------

</code></pre>
</figure>
<figure id="orga761bbe">
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a>tf_dprint(test_output_res)</span></code></pre></div>
<figcaption>
Listing 32
</figcaption>
</figure>
<figure>
<pre class="text"><code>Tensor(AddV2):0,    shape=[None]    &quot;add_1_1:0&quot;
|  Tensor(Sub):0,   shape=[None]    &quot;X_1/log_prob/sub:0&quot;
|  |  Tensor(Mul):0,    shape=[None]    &quot;X_1/log_prob/mul:0&quot;
|  |  |  Tensor(SquaredDifference):0,   shape=[None]    &quot;X_1/log_prob/SquaredDifference:0&quot;
|  |  |  |  Tensor(Mul):0,  shape=[None]    &quot;X_1/log_prob/truediv:0&quot;
|  |  |  |  |  Tensor(Const):0, shape=[]    &quot;ConstantFolding/X_1/log_prob/truediv_recip:0&quot;
|  |  |  |  |  |  1.
|  |  |  |  |  Tensor(Placeholder):0,   shape=[None]    &quot;value_x:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;X_1/log_prob/truediv_1:0&quot;
|  |  |  |  |  0.
|  |  |  Tensor(Const):0,   shape=[]    &quot;Y_1/log_prob/mul/x:0&quot;
|  |  |  |  -0.5
|  |  Tensor(Const):0,  shape=[]    &quot;Y_1/log_prob/add/x:0&quot;
|  |  |  0.9189385
|  Tensor(AddV2):0, shape=[None]    &quot;add_2:0&quot;
|  |  Tensor(Log):0,    shape=[None]    &quot;Log_1:0&quot;
|  |  |  Tensor(AddV2):0,   shape=[None]    &quot;AddV2:0&quot;
|  |  |  |  Tensor(Mul):0,  shape=[None]    &quot;Mul:0&quot;
|  |  |  |  |  Tensor(Placeholder):0,   shape=[None]    &quot;tau:0&quot;
|  |  |  |  |  Tensor(Placeholder):0,   shape=[None]    &quot;value_y:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[None]    &quot;value_x:0&quot;
|  |  Tensor(Sub):0,    shape=[None]    &quot;Y_1/log_prob/sub_1:0&quot;
|  |  |  Tensor(Mul):0, shape=[None]    &quot;Y_1/log_prob/mul_1:0&quot;
|  |  |  |  Tensor(SquaredDifference):0,    shape=[None]    &quot;Y_1/log_prob/SquaredDifference_1:0&quot;
|  |  |  |  |  Tensor(RealDiv):0,   shape=[None]    &quot;Y_1/log_prob/truediv_1:0&quot;
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;value_x:0&quot;
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;tau:0&quot;
|  |  |  |  |  Tensor(RealDiv):0,   shape=[None]    &quot;Y_1/log_prob/truediv_2:0&quot;
|  |  |  |  |  |  Tensor(Reshape):0,    shape=[]    &quot;Reshape_1:0&quot;
|  |  |  |  |  |  |  Tensor(AddV2):0,   shape=[None]    &quot;AddV2:0&quot;
|  |  |  |  |  |  |  |  ...
|  |  |  |  |  |  |  Tensor(Const):0,   shape=[0]   &quot;Reshape/shape:0&quot;
|  |  |  |  |  |  |  |  []
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[None]    &quot;tau:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;Y_1/log_prob/mul/x:0&quot;
|  |  |  |  |  -0.5
|  |  |  Tensor(Const):0,   shape=[]    &quot;Y_1/log_prob/add/x:0&quot;
|  |  |  |  0.9189385

</code></pre>
</figure>
</section>
<section id="missing-graph-simplifications" class="level2">
<h2>Missing Graph Simplifications</h2>
<p>From Listing <a href="#orga761bbe">32</a> we can see that <code>grappler</code> is not applying enough algebraic simplifications (e.g. it doesn’t remove multiplications with 1 or reduce the <span class="math inline">\(\left(\mu + x - \mu \right)^2\)</span> term in <code>SquaredDifference</code>).</p>
<p>Does missing this simplification amount to anything practical? Listing <a href="#orga71aafb">34</a> demonstrates the difference between our model without the simplification and a manually constructed model without the redundancy in <code>SquaredDifference</code>.</p>
<figure id="orga71aafb">
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true"></a><span class="kw">def</span> compute_point_diff():</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true"></a>    <span class="cf">with</span> graph_mode(), demo_graph.as_default():</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true"></a>        Y_trans_tfp <span class="op">=</span> tfp.distributions.normal.Normal(<span class="fl">0.0</span>, <span class="fl">1.0</span>, name<span class="op">=</span><span class="st">&#39;Y_trans&#39;</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true"></a>        y_shifted_tf <span class="op">=</span> x_tf <span class="op">+</span> tau_tf <span class="op">*</span> y_tf</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true"></a>        hier_norm_trans_lik <span class="op">=</span> tf.math.log(y_shifted_tf) <span class="op">+</span> Y_trans_tfp.log_prob(y_T_reshaped) <span class="op">+</span> X_tfp.log_prob(x_tf)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true"></a>        hier_norm_trans_lik <span class="op">=</span> normalize_tf_graph(hier_norm_trans_lik)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true"></a>    test_point <span class="op">=</span> {x_tf.name: np.r_[<span class="fl">1.0</span>],</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true"></a>                  tau_tf.name: np.r_[<span class="fl">1e-20</span>],</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true"></a>                  y_tf.name: np.r_[<span class="fl">1000.1</span>]}</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true"></a>    <span class="cf">with</span> tf.compat.v1.Session(graph<span class="op">=</span>test_output_res.graph).as_default():</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true"></a>        val <span class="op">=</span> test_output_res.<span class="bu">eval</span>(test_point)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true"></a>    <span class="cf">with</span> tf.compat.v1.Session(graph<span class="op">=</span>hier_norm_trans_lik.graph).as_default():</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true"></a>        val_2 <span class="op">=</span> hier_norm_trans_lik.<span class="bu">eval</span>(test_point)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true"></a>    <span class="cf">return</span> val, val_2</span></code></pre></div>
<figcaption>
Listing 34
</figcaption>
</figure>
<figure id="org7e4367b">
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true"></a>_ <span class="op">=</span> np.subtract(<span class="op">*</span>compute_point_diff())</span></code></pre></div>
<figcaption>
Listing 35
</figcaption>
</figure>
<figure>
<pre class="text"><code>[500099.94]</code></pre>
</figure>
<p>The output of Listing <a href="#org7e4367b">35</a> shows exactly how large the discrepancy can be for carefully chosen parameter values. More specifically, as <code>tau_tf</code> gets smaller and the magnitude of the difference <code>x_tf - y_tf</code> gets larger, the discrepancy can increase. Since such parameter values are likely to be visited during sampling, we should address this missing simplification.</p>
<p>In Listing <a href="#orge313efe">38</a> we create a goal that performs that aforementioned simplification for <code>SquaredDifference</code>.</p>
<figure>
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true"></a><span class="kw">def</span> recenter_sqrdiffo(in_g, out_g):</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Create a goal that essentially reduces `(a / d - (a + d * c) / d)**2` to `d**2`&quot;&quot;&quot;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true"></a>    a_sqd_lv, b_sqd_lv, d_sqd_lv <span class="op">=</span> var(), var(), var()</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true"></a>    <span class="co"># Pattern: (a / d - b / d)**2</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true"></a>    target_sqrdiff_lv <span class="op">=</span> mt.SquaredDifference(</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true"></a>        mt.realdiv(a_sqd_lv, d_sqd_lv, name<span class="op">=</span>var()),</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true"></a>        mt.realdiv(b_sqd_lv, d_sqd_lv, name<span class="op">=</span>var()),</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true"></a>        name<span class="op">=</span>var()</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true"></a>    )</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true"></a>    <span class="co"># Pattern: d * c + a</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true"></a>    c_sqd_lv <span class="op">=</span> var()</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true"></a>    b_part_lv <span class="op">=</span> mt.addv2(mt.mul(d_sqd_lv, c_sqd_lv, name<span class="op">=</span>var()), a_sqd_lv, name<span class="op">=</span>var())</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true"></a>    <span class="co"># Replacement: c**2</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true"></a>    simplified_sqrdiff_lv <span class="op">=</span> mt.SquaredDifference(</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true"></a>        c_sqd_lv,</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true"></a>        <span class="fl">0.0</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true"></a>    )</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true"></a></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true"></a>    reshape_lv <span class="op">=</span> var()</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true"></a>    simplified_sqrdiff_reshaped_lv <span class="op">=</span> mt.SquaredDifference(</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true"></a>        mt.reshape(c_sqd_lv, reshape_lv),</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true"></a>        <span class="fl">0.0</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true"></a>    )</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true"></a></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true"></a>    res <span class="op">=</span> lall(</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true"></a>        <span class="co"># input == (a / d - b / d)**2 must be &quot;true&quot;</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true"></a>        eq(in_g, target_sqrdiff_lv),</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true"></a>        <span class="co"># &quot;and&quot;</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true"></a>        conde([</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true"></a>            <span class="co"># &quot;if&quot; b == d * c + a is &quot;true&quot;</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true"></a>            eq(b_sqd_lv, b_part_lv),</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true"></a>            <span class="co"># &quot;then&quot; output ==  (c - 0)**2 is also &quot;true&quot;</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true"></a>            eq(out_g, simplified_sqrdiff_lv)</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true"></a></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true"></a>            <span class="co"># &quot;or&quot;</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true"></a>        ], [</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true"></a>            <span class="co"># We have to use this to cover some variation also not</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true"></a>            <span class="co"># sufficiently/consistently &quot;normalized&quot; by `grappler`.</span></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true"></a></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true"></a>            <span class="co"># &quot;if&quot; b == reshape(d * c + a, ?) is &quot;true&quot;</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true"></a>            eq(b_sqd_lv, mt.reshape(b_part_lv, reshape_lv, name<span class="op">=</span>var())),</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true"></a>            <span class="co"># &quot;then&quot; output == (reshape(c, ?) - 0)**2 is also &quot;true&quot;</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true"></a>            eq(out_g, simplified_sqrdiff_reshaped_lv)</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true"></a>        ]))</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true"></a>    <span class="cf">return</span> res</span></code></pre></div>
</figure>
<p>We apply the simplification in Listing <a href="#orge313efe">38</a> and print the results in <a href="#orga55e147">39</a>.</p>
<figure id="orge313efe">
<div class="sourceCode" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true"></a><span class="cf">with</span> graph_mode(), test_output_res.graph.as_default():</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true"></a>    res <span class="op">=</span> run(<span class="dv">1</span>, var(<span class="st">&#39;q&#39;</span>),</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true"></a>              reduceo(<span class="kw">lambda</span> x, y: tf_graph_applyo(recenter_sqrdiffo, x, y),</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true"></a>                      test_output_res, var(<span class="st">&#39;q&#39;</span>)))</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true"></a>    test_output_res <span class="op">=</span> normalize_tf_graph(res[<span class="dv">0</span>].eval_obj.reify())</span></code></pre></div>
<figcaption>
Listing 38
</figcaption>
</figure>
<figure id="orga55e147">
<div class="sourceCode" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true"></a>tf_dprint(test_output_res.graph.get_tensor_by_name(<span class="st">&#39;SquaredDifference:0&#39;</span>))</span></code></pre></div>
<figcaption>
Listing 39
</figcaption>
</figure>
<figure>
<pre class="text"><code>Tensor(SquaredDifference):0,    shape=[None]    &quot;SquaredDifference:0&quot;
|  Tensor(Const):0, shape=[]    &quot;X_1/log_prob/truediv_1:0&quot;
|  |  0.
|  Tensor(Placeholder):0,   shape=[None]    &quot;value_y:0&quot;

</code></pre>
</figure>
<p>After simplification, the difference is now gone.</p>
<figure>
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true"></a>_ <span class="op">=</span> np.subtract(<span class="op">*</span>compute_point_diff())</span></code></pre></div>
</figure>
<figure>
<pre class="text"><code>[0.]</code></pre>
</figure>
</section>
</section>
<section id="transforming-the-log-likelihood-graph" class="level1">
<h1>Transforming the Log-likelihood Graph</h1>
<p>Now, we’re ready to apply the transform to the radon model log-likelihood graph.</p>
<figure>
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true"></a><span class="cf">with</span> graph_mode(), tf.Graph().as_default() <span class="im">as</span> trans_graph:</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true"></a>    graph_inputs <span class="op">=</span> [logpfn_fg.get_operation_by_name(i.name).outputs[<span class="dv">0</span>]</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true"></a>                    <span class="cf">for</span> i <span class="kw">in</span> logpfn_cf.structured_input_signature[<span class="dv">0</span>]]</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true"></a>    logpfn_trans_tf, logpfn_remaps <span class="op">=</span> shift_squared_terms(logpfn_fg.outputs[<span class="dv">0</span>], graph_inputs<span class="op">=</span>graph_inputs)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true"></a><span class="cf">with</span> graph_mode(), logpfn_trans_tf.graph.as_default():</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true"></a>    res <span class="op">=</span> run(<span class="dv">1</span>, var(<span class="st">&#39;q&#39;</span>),</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true"></a>              reduceo(<span class="kw">lambda</span> x, y: tf_graph_applyo(recenter_sqrdiffo, x, y),</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true"></a>                      logpfn_trans_tf, var(<span class="st">&#39;q&#39;</span>)))</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true"></a>    logpfn_trans_tf <span class="op">=</span> normalize_tf_graph(res[<span class="dv">0</span>].eval_obj.reify())</span></code></pre></div>
</figure>
<p>Listing <a href="#org73bcbee">44</a> shows the replacements that were made throughout the graph. Two replacements were found and they appear to correspond to the un-centered normal distribution terms <code>a</code> and <code>b</code> in our model–as intended.</p>
<figure id="org73bcbee">
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true"></a><span class="cf">for</span> rm <span class="kw">in</span> logpfn_remaps:</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true"></a>    <span class="cf">for</span> r <span class="kw">in</span> rm:</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true"></a>      tf_dprint(r[<span class="dv">0</span>])</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true"></a>      <span class="bu">print</span>(<span class="st">&quot;-&gt;&quot;</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true"></a>      tf_dprint(r[<span class="dv">1</span>])</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true"></a>      <span class="bu">print</span>(<span class="st">&quot;------&quot;</span>)</span></code></pre></div>
<figcaption>
Listing 44
</figcaption>
</figure>
<figure>
<pre class="text"><code>Tensor(Placeholder):0,  shape=[85]  &quot;values_2:0&quot;
-&gt;
Tensor(AddV2):0,    shape=[85]  &quot;AddV2:0&quot;
|  Tensor(Placeholder):0,   shape=[]    &quot;values_4:0&quot;
|  Tensor(Mul):0,   shape=[85]  &quot;Mul_4:0&quot;
|  |  Tensor(Exp):0,    shape=[]    &quot;exp_2_1/forward/Exp:0&quot;
|  |  |  Tensor(Placeholder):0, shape=[]    &quot;values_5:0&quot;
|  |  Tensor(Placeholder):0,    shape=[85]  &quot;values_2:0&quot;
------
Tensor(Log):0,  shape=~_175065  &quot;SampleNormal_3_1/log_prob/Normal_3/log_prob/Log:0&quot;
|  Tensor(Exp):0,   shape=[]    &quot;exp_2_1/forward/Exp:0&quot;
|  |  Tensor(Placeholder):0,    shape=[]    &quot;values_5:0&quot;
-&gt;
0.0
------

</code></pre>
</figure>
<p>Likewise, Listing <a href="#org0ce0bba">46</a> shows <code>SquaredDifference</code> subgraphs that appear in the transformed log-likelihood.</p>
<figure id="org0ce0bba">
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true"></a>square_diff_outs <span class="op">=</span> [o.outputs[<span class="dv">0</span>] <span class="cf">for</span> o <span class="kw">in</span> logpfn_trans_tf.graph.get_operations()</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true"></a>                    <span class="cf">if</span> o.<span class="bu">type</span> <span class="op">==</span> <span class="st">&#39;SquaredDifference&#39;</span> <span class="kw">or</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true"></a>                    o.<span class="bu">type</span>.startswith(<span class="st">&#39;Gather&#39;</span>) <span class="kw">or</span> o.<span class="bu">type</span> <span class="op">==</span> <span class="st">&#39;Log&#39;</span>]</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true"></a><span class="cf">for</span> t <span class="kw">in</span> square_diff_outs:</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true"></a>    tf_dprint(t)</span></code></pre></div>
<figcaption>
Listing 46
</figcaption>
</figure>
<figure>
<pre class="text"><code>Tensor(GatherV2):0, shape=[919] &quot;GatherV2:0&quot;
|  Tensor(Placeholder):0,   shape=[85]  &quot;values_3:0&quot;
|  Tensor(Const):0, shape=[919] &quot;GatherV2/indices:0&quot;
|  |  [ 0  0  0 ... 83 84 84]
|  Tensor(Const):0, shape=[]    &quot;GatherV2/axis:0&quot;
|  |  0
Tensor(Log):0,  shape=[]    &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/Log:0&quot;
|  Tensor(Exp):0,   shape=[]    &quot;exp_1/forward/Exp:0&quot;
|  |  Tensor(Placeholder):0,    shape=[]    &quot;values_0:0&quot;
Tensor(SquaredDifference):0,    shape=[]    &quot;Normal_5/log_prob/SquaredDifference:0&quot;
|  Tensor(Const):0, shape=[]    &quot;Const_723:0&quot;
|  |  0.
|  Tensor(Mul):0,   shape=[]    &quot;Normal_5/log_prob/truediv:0&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;exp_3_2/inverse_log_det_jacobian/mul_1:0&quot;
|  |  |  1.
|  |  Tensor(Placeholder):0,    shape=[]    &quot;values_1:0&quot;
Tensor(SquaredDifference):0,    shape=[85]  &quot;SquaredDifference:0&quot;
|  Tensor(Const):0, shape=[]    &quot;Const_723:0&quot;
|  |  0.
|  Tensor(Reshape):0,   shape=[85]  &quot;Reshape:0&quot;
|  |  Tensor(Placeholder):0,    shape=[85]  &quot;values_2:0&quot;
|  |  Tensor(Const):0,  shape=[1]   &quot;SampleNormal_2_1/log_prob/Reshape/shape:0&quot;
|  |  |  [85]
Tensor(SquaredDifference):0,    shape=[]    &quot;Normal_1_1/log_prob/SquaredDifference:0&quot;
|  Tensor(Const):0, shape=[]    &quot;Const_723:0&quot;
|  |  0.
|  Tensor(Mul):0,   shape=[]    &quot;Normal_1_1/log_prob/truediv:0&quot;
|  |  Tensor(Const):0,  shape=[]    &quot;exp_3_2/inverse_log_det_jacobian/mul_1:0&quot;
|  |  |  1.
|  |  Tensor(Placeholder):0,    shape=[]    &quot;values_4:0&quot;
Tensor(Log):0,  shape=[]    &quot;Normal_4_1/log_prob/Log:0&quot;
|  Tensor(Exp):0,   shape=[]    &quot;exp_3_1/forward/Exp:0&quot;
|  |  Tensor(Placeholder):0,    shape=[]    &quot;values_6:0&quot;
Tensor(SquaredDifference):0,    shape=[85]  &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/SquaredDifference:0&quot;
|  Tensor(RealDiv):0,   shape=[85]  &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/truediv:0&quot;
|  |  Tensor(Reshape):0,    shape=[85]  &quot;SampleNormal_2_1/log_prob/Reshape:0&quot;
|  |  |  Tensor(Placeholder):0, shape=[85]  &quot;values_3:0&quot;
|  |  |  Tensor(Const):0,   shape=[1]   &quot;SampleNormal_2_1/log_prob/Reshape/shape:0&quot;
|  |  |  |  [85]
|  |  Tensor(Exp):0,    shape=[]    &quot;exp_1/forward/Exp:0&quot;
|  |  |  Tensor(Placeholder):0, shape=[]    &quot;values_0:0&quot;
|  Tensor(RealDiv):0,   shape=[]    &quot;SampleNormal_2_1/log_prob/Normal_2/log_prob/truediv_1:0&quot;
|  |  Tensor(Placeholder):0,    shape=[]    &quot;values_1:0&quot;
|  |  Tensor(Exp):0,    shape=[]    &quot;exp_1/forward/Exp:0&quot;
|  |  |  ...
Tensor(GatherV2):0, shape=[919] &quot;GatherV2_1_1:0&quot;
|  Tensor(AddV2):0, shape=[85]  &quot;AddV2:0&quot;
|  |  Tensor(Mul):0,    shape=[85]  &quot;Mul_4:0&quot;
|  |  |  Tensor(Exp):0, shape=[]    &quot;exp_2_1/forward/Exp:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[]    &quot;values_5:0&quot;
|  |  |  Tensor(Placeholder):0, shape=[85]  &quot;values_2:0&quot;
|  |  Tensor(Placeholder):0,    shape=[]    &quot;values_4:0&quot;
|  Tensor(Const):0, shape=[919] &quot;GatherV2/indices:0&quot;
|  |  [ 0  0  0 ... 83 84 84]
|  Tensor(Const):0, shape=[]    &quot;GatherV2/axis:0&quot;
|  |  0
Tensor(SquaredDifference):0,    shape=[919] &quot;Normal_4_1/log_prob/SquaredDifference_1:0&quot;
|  Tensor(RealDiv):0,   shape=[919] &quot;Normal_4_1/log_prob/truediv:0&quot;
|  |  Tensor(Const):0,  shape=[919] &quot;Normal_4_1/log_prob/value:0&quot;
|  |  |  [0.8329091 0.8329091 1.0986123 ... 1.6292405 1.3350011 1.0986123]
|  |  Tensor(Exp):0,    shape=[]    &quot;exp_3_1/forward/Exp:0&quot;
|  |  |  Tensor(Placeholder):0, shape=[]    &quot;values_6:0&quot;
|  Tensor(RealDiv):0,   shape=[919] &quot;Normal_4_1/log_prob/truediv_1_1:0&quot;
|  |  Tensor(AddV2):0,  shape=[919] &quot;add_12:0&quot;
|  |  |  Tensor(GatherV2):0,    shape=[919] &quot;GatherV2:0&quot;
|  |  |  |  Tensor(Placeholder):0,  shape=[85]  &quot;values_3:0&quot;
|  |  |  |  Tensor(Const):0,    shape=[919] &quot;GatherV2/indices:0&quot;
|  |  |  |  |  [ 0  0  0 ... 83 84 84]
|  |  |  |  Tensor(Const):0,    shape=[]    &quot;GatherV2/axis:0&quot;
|  |  |  |  |  0
|  |  |  Tensor(Mul):0, shape=[919] &quot;mul_5:0&quot;
|  |  |  |  Tensor(GatherV2):0, shape=[919] &quot;GatherV2_1_1:0&quot;
|  |  |  |  |  Tensor(AddV2):0, shape=[85]  &quot;AddV2:0&quot;
|  |  |  |  |  |  Tensor(Mul):0,    shape=[85]  &quot;Mul_4:0&quot;
|  |  |  |  |  |  |  Tensor(Exp):0, shape=[]    &quot;exp_2_1/forward/Exp:0&quot;
|  |  |  |  |  |  |  |  Tensor(Placeholder):0,  shape=[]    &quot;values_5:0&quot;
|  |  |  |  |  |  |  Tensor(Placeholder):0, shape=[85]  &quot;values_2:0&quot;
|  |  |  |  |  |  Tensor(Placeholder):0,    shape=[]    &quot;values_4:0&quot;
|  |  |  |  |  Tensor(Const):0, shape=[919] &quot;GatherV2/indices:0&quot;
|  |  |  |  |  |  [ 0  0  0 ... 83 84 84]
|  |  |  |  |  Tensor(Const):0, shape=[]    &quot;GatherV2/axis:0&quot;
|  |  |  |  |  |  0
|  |  |  |  Tensor(Const):0,    shape=[919] &quot;mul/y:0&quot;
|  |  |  |  |  [1. 0. 0. ... 0. 0. 0.]
|  |  Tensor(Exp):0,    shape=[]    &quot;exp_3_1/forward/Exp:0&quot;
|  |  |  ...

</code></pre>
</figure>
</section>
<section id="creating-a-new-log-likelihood-function" class="level1">
<h1>Creating a new Log-likelihood Function</h1>
<p>Now that we have a transformed version of the original log-likelihood graph (i.e. <code>logpfn_trans_tf</code>), we need to create a new <code>FuncGraph</code> from it. Listing <a href="#org051a679">48</a> provides a simple function that creates a new <code>ConcreteFunction</code> from an updated output node.</p>
<figure id="org051a679">
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true"></a><span class="im">from</span> tensorflow.python.framework.func_graph <span class="im">import</span> FuncGraph</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true"></a><span class="im">from</span> tensorflow.python.eager.function <span class="im">import</span> ConcreteFunction</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true"></a><span class="im">from</span> tensorflow.python.eager.lift_to_graph <span class="im">import</span> lift_to_graph</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true"></a><span class="kw">def</span> new_tf_function(output, orig_cf):</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Create a new ConcreteFunction by replacing a single output in an existing FuncGraph.</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true"></a>    orig_fg <span class="op">=</span> orig_cf.graph</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true"></a>    <span class="co"># with trans_graph.as_default(): #orig_fg.as_default():</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true"></a>    logpfn_fg_new <span class="op">=</span> FuncGraph(<span class="st">&#39;logpfn_new&#39;</span>, orig_fg.collections, orig_fg.capture_by_value)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true"></a>    old_to_new_ops <span class="op">=</span> lift_to_graph([output],</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true"></a>                                    logpfn_fg_new,</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true"></a>                                    add_sources<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true"></a>                                    handle_captures<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true"></a>    logpfn_fg_new.structured_input_signature <span class="op">=</span> orig_fg.structured_input_signature</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true"></a></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true"></a>    new_inputs <span class="op">=</span> [old_to_new_ops.get(output.graph.get_operation_by_name(i.name).outputs[<span class="dv">0</span>])</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true"></a>                  <span class="cf">for</span> i <span class="kw">in</span> orig_cf.structured_input_signature[<span class="dv">0</span>]]</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true"></a></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true"></a>    logpfn_fg_new.inputs <span class="op">=</span> new_inputs</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true"></a></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true"></a>    <span class="cf">assert</span> <span class="bu">all</span>(i <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">for</span> i <span class="kw">in</span> logpfn_fg_new.inputs)</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true"></a></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true"></a>    logpfn_fg_new.outputs <span class="op">=</span> [old_to_new_ops[output]]</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true"></a>    logpfn_fg_new.structured_outputs <span class="op">=</span> logpfn_fg_new.outputs[<span class="dv">0</span>]</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true"></a></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true"></a>    <span class="cf">assert</span> logpfn_fg_new.as_graph_element(logpfn_fg_new.outputs[<span class="dv">0</span>]) <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true"></a></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true"></a>    logpfn_new_cf <span class="op">=</span> ConcreteFunction(logpfn_fg_new)</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true"></a>    logpfn_new_cf._arg_keywords <span class="op">=</span> orig_cf._arg_keywords</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true"></a>    logpfn_new_cf._num_positional_args <span class="op">=</span> <span class="bu">len</span>(logpfn_fg_new.inputs)</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true"></a></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true"></a>    <span class="cf">return</span> logpfn_new_cf</span></code></pre></div>
<figcaption>
Listing 48
</figcaption>
</figure>
<figure id="orge94e0bc">
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true"></a>logpfn_new_cf <span class="op">=</span> new_tf_function(logpfn_trans_tf, logpfn_cf)</span></code></pre></div>
<figcaption>
Listing 49
</figcaption>
</figure>
<p>The new TF function, <code>logpfn_new_cf</code>, in Listing <a href="#org051a679">48</a> is the function we are going to use for sampling from the new log-likelihood.</p>
<figure id="org7bec3c9">
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true"></a>_ <span class="op">=</span> logpfn_cf(<span class="op">*</span>init.values()) <span class="op">-</span> logpfn_new_cf(<span class="op">*</span>init.values())</span></code></pre></div>
<figcaption>
Listing 50
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true"></a>tf.Tensor(<span class="fl">153.41016</span>, shape<span class="op">=</span>(), dtype<span class="op">=</span>float32)</span></code></pre></div>
</figure>
<p>Listing <a href="#org7bec3c9">50</a> shows the difference between a transformed and non-transformed log-likelihood value given the same inputs.</p>
</section>
<section id="sampling-from-the-new-log-likelihood" class="level1">
<h1>Sampling from the new Log-likelihood</h1>
<p>In Listing <a href="#org4a79807">53</a>, we reproduce the remaining steps of <code>pm.inference.sampling.sample</code> and–unnaturally–force the PyMC4 machinery to draw samples from our new transformed log-likelihood function.</p>
<figure>
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true"></a><span class="im">from</span> contextlib <span class="im">import</span> contextmanager</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true"></a><span class="co"># We need to create new initial values for our transformed variables.</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true"></a>new_val_map <span class="op">=</span> {}</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true"></a><span class="cf">for</span> logpfn_remap <span class="kw">in</span> logpfn_remaps:</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true"></a>    transed_var <span class="op">=</span> logpfn_remap[<span class="dv">0</span>][<span class="dv">0</span>].reify()</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true"></a>    transed_var_pymc_name <span class="op">=</span> tfp_names_to_pymc[transed_var.op.name]</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true"></a>    old_val_np <span class="op">=</span> init[transed_var_pymc_name].numpy()</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true"></a>    new_val_np <span class="op">=</span> np.random.standard_normal(old_val_np.shape).astype(old_val_np.dtype)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true"></a>    new_val_map[transed_var_pymc_name] <span class="op">=</span> tf.convert_to_tensor(new_val_np)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true"></a>new_init <span class="op">=</span> init.copy()</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true"></a>new_init.update(new_val_map)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true"></a><span class="at">@contextmanager</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true"></a><span class="kw">def</span> pymc4_force_logp(logpfn_new_cf, new_init):</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Temporarily fix the logp function and init values used by PyMC4&#39;s sampler.&quot;&quot;&quot;</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true"></a></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true"></a>    <span class="kw">def</span> _new_build_logp_function(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true"></a>        <span class="kw">nonlocal</span> logpfn_new_cf, new_init</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true"></a>        <span class="cf">return</span> logpfn_new_cf, new_init</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true"></a></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true"></a>    _old_fn <span class="op">=</span> pm.inference.sampling.build_logp_function</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true"></a>    pm.inference.sampling.build_logp_function <span class="op">=</span> _new_build_logp_function</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true"></a></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true"></a>    <span class="cf">try</span>:</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true"></a>        <span class="cf">yield</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true"></a>    <span class="cf">finally</span>:</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true"></a>        pm.inference.sampling.build_logp_function <span class="op">=</span> _old_fn</span></code></pre></div>
</figure>
<figure id="org4a79807">
<div class="sourceCode" id="cb53"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true"></a><span class="cf">with</span> pymc4_force_logp(logpfn_new_cf, new_init):</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true"></a>    az_trace <span class="op">=</span> sample(model)</span></code></pre></div>
<figcaption>
Listing 53
</figcaption>
</figure>
<figure id="fig:transformed-model-plot-energy" class="plot">
<img src="https://brandonwillard.github.io/figures/transformed-model-plot-energy.png" title="fig:" alt="" />
<figcaption>
</figcaption>
</figure>
<figure id="fig:transformed-model-plot-trace" class="plot">
<img src="https://brandonwillard.github.io/figures/transformed-model-plot-trace.png" title="fig:" alt="" />
<figcaption>
</figcaption>
</figure>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>The goals in the two separate <code>run</code> calls we used in Listing <a href="#org0ad3a96">23</a> could have been combined into a single <code>run</code>. This could’ve been accomplished using some “meta” steps (e.g. construct and evaluate a goal on-the-fly within a miniKanren) or special goals for reading from a miniKanren-generated <code>dict</code>s or association lists. Goals of this nature are not uncommon (e.g. type inference and inhabitation exmaples), and serve to demonstrate the great breadth of activity possible within relational context of miniKanren.</p>
<p>However, the point we want to make doesn’t require much sophistication. Instead, we wanted to demonstrate how a non-trivial “pattern” can be specified and matched using <code>symbolic-pymc</code>, and how easily those results could be used to transform a graph.</p>
<p>More specifically, our goal <code>shift_squared_subso</code> in <a href="#org0ad3a96">23</a> demonstrates <strong>the way in which we were able to specify desired structure(s) within a graph</strong>. We defined one pattern, <code>Y_sqrdiffo</code>, to match anywhere in the graph then another pattern, <code>X_sqrdiffo</code>, that relied on matched terms from <code>Y_sqrdiffo</code> and could also be matched/found anywhere else in the same graph.</p>
<p>Furthermore, our substitutions needed information from both “matched” subgraphs. Specifically, substitution pairs similar to <code>(x, z + x)</code>. Within this framework, we could just as easily have included <code>y</code>–or any terms from either successfully matched subgraph–in the substitution expressions.</p>
<p>In sample-space, the search patterns and substitutions are much easier to specify exactly because they’re single-subgraph patterns that themselves are the subgraphs to be replaced (i.e. if we find a non-standard normal, replace it with a shifted/scaled standard normal). In log-space, we chose to find distinct subgraph “chains”, i.e. all <code>(y - x)**2</code> and <code>(x - z)**2</code> pairs (i.e. “connected” by an “unknown” term <code>x</code>), since these are produced by the log-likelihood form of hierarchical normal distributions.</p>
<p>As a result, we had a non-trivial structure/“pattern” to express–and execute. Using conventional graph search-and-replace functionality would’ve required much more orchestration and resulted considerably less flexible code with little-to-no reusability. In our case, the goals <code>onceo</code> and <code>tf_graph_applyo</code> are universal and the forms in <code>shift_squared_subso</code> can be easily changed to account for more sophisticated (or entirely distinct) patterns and substitutions.</p>
<p>Most related graph manipulation offerings make it easy to find a single subgraph that matches a pattern, but not potentially “co-dependent” and/or distinct subgraphs. In the end, the developer will often have to manually implement a “global” state and orchestrate multiple single-subgraph searches and their results.</p>
<p>For single search-and-replace objectives, this amount of manual developer intervention/orchestration might be excusable; however, for objectives requiring the evaluation of multiple graph transformation, this approach is mostly unmaintainable and extremely difficult to compartmentalize.</p>
<p>This demonstration barely even scratches the surface of what’s possible using miniKanren and relational programming for graph manipulation and symbolic statistical model optimization. As the <code>symbolic-pymc</code> project advances, we’ll cover examples in which miniKanren’s more distinct offerings are demonstrated.</p>
</section>
</body>
</html>

            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'brandonwillard-github-io'; // required: replace example with your forum shortname

            var disqus_config = function () {
                this.language = "en";

                        this.page.identifier = '2019-09-08-symbolic-pymc-radon-example-in-pymc4';
                        this.page.url = 'https://brandonwillard.github.io/symbolic-pymc-radon-example-in-pymc4.html';
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="https://brandonwillard.github.io//images/profile-pic.png"/>
        </p>
    <p>
      <strong>About Brandon T. Willard</strong><br/>
        applied math/stats person
    </p>
</div><!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://github.com/brandonwillard"><i class="fa fa-github-square fa-lg"></i> github</a></li>
    <li class="list-group-item"><a href="https://scholar.google.com/citations?user=g0oUxG4AAAAJ&hl=en"><i class="ai ai-google-scholar ai-lg"></i> google scholar</a></li>
    <li class="list-group-item"><a href="https://www.linkedin.com/in/brandon-t-willard-468bb410/"><i class="fa fa-linkedin fa-lg"></i> linkedin</a></li>
    <li class="list-group-item"><a href="https://bitbucket.io/brandonwillard"><i class="fa fa-bitbucket-square fa-lg"></i> bitbucket</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Brandon T. Willard
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en">Creative Commons Attribution-NonCommercial 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://brandonwillard.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://brandonwillard.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://brandonwillard.github.io/theme/js/respond.min.js"></script>


    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'brandonwillard-github-io'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-91585967-1', '');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->


</body>
</html>