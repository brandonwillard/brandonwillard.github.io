<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Random Variables in Theano - Brandon T. Willard</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://brandonwillard.github.io/random-variables-in-theano.html">

        <meta name="author" content="Brandon T. Willard" />
        <meta name="keywords" content="pymc3,theano,statistics,symbolic computation,python,probability theory" />

        <meta property="og:site_name" content="Brandon T. Willard" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Random Variables in Theano"/>
        <meta property="og:url" content="https://brandonwillard.github.io/random-variables-in-theano.html"/>
        <meta property="og:description" content=""/>
        <meta property="article:published_time" content="2018-12-28" />
            <meta property="article:section" content="articles" />
            <meta property="article:tag" content="pymc3" />
            <meta property="article:tag" content="theano" />
            <meta property="article:tag" content="statistics" />
            <meta property="article:tag" content="symbolic computation" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="probability theory" />
            <meta property="article:author" content="Brandon T. Willard" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://brandonwillard.github.io/theme/css/bootstrap.readable.min.css" type="text/css"/>
    <link href="https://brandonwillard.github.io/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://brandonwillard.github.io/theme/css/academicons.min.css" rel="stylesheet">

    <link href="https://brandonwillard.github.io/theme/css/pygments/vim.css" rel="stylesheet">
    <link rel="stylesheet" href="https://brandonwillard.github.io/theme/css/style.css" type="text/css"/>
        <link href="https://brandonwillard.github.io/extra/custom.css" rel="stylesheet">

        <link href="https://brandonwillard.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Brandon T. Willard ATOM Feed"/>

        <link href="https://brandonwillard.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Brandon T. Willard RSS Feed"/>
        <link href="https://brandonwillard.github.io/feeds/articles.atom.xml" type="application/atom+xml" rel="alternate"
              title="Brandon T. Willard articles ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://brandonwillard.github.io/" class="navbar-brand">
Brandon T. Willard            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://brandonwillard.github.io/pages/publications.html">
                             Publications
                          </a></li>
                         <li><a href="https://brandonwillard.github.io/pages/projects.html">
                             Projects
                          </a></li>
                         <li><a href="https://brandonwillard.github.io/pages/about.html">
                             About
                          </a></li>
                        <li class="active">
                            <a href="https://brandonwillard.github.io/category/articles.html">Articles</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://brandonwillard.github.io/random-variables-in-theano.html"
                       rel="bookmark"
                       title="Permalink to Random Variables in Theano">
                        Random Variables in Theano
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2018-12-28T00:00:00-06:00"> Fri 28 December 2018</time>
    </span>
          <span class="label label-default">Modified</span>
            <span class="modified">
                <i class="fa fa-calendar"></i><time datetime="2019-02-04T00:00:00-06:00"> Mon 04 February 2019</time>
            </span>





<span class="label label-default">Tags</span>
	<a href="https://brandonwillard.github.io/tag/pymc3.html">pymc3</a>
        /
	<a href="https://brandonwillard.github.io/tag/theano.html">theano</a>
        /
	<a href="https://brandonwillard.github.io/tag/statistics.html">statistics</a>
        /
	<a href="https://brandonwillard.github.io/tag/symbolic-computation.html">symbolic computation</a>
        /
	<a href="https://brandonwillard.github.io/tag/python.html">python</a>
        /
	<a href="https://brandonwillard.github.io/tag/probability-theory.html">probability theory</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Brandon T. Willard" />
  <title>Random Variables in Theano</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
</head>
<body>
<!--  -->
<!-- <div id="header"> -->
<!-- <h1 class="title">Random Variables in Theano</h1> -->
<!--  -->
<!--  -->
<!-- <h2 class="author">Brandon T. Willard</h2> -->
<!--  -->
<!--  -->
<!-- <h3 class="date">2018–12–28</h3> -->
<!--  -->
<!-- </div> -->
<!--  -->
<div class="abstract">
<p>Continuing from <a href="#24875a2c31fa7f94ce562adddedc0bf8">Willard, Brandon T. (2018)</a>, we’ll attempt to improve upon <code>RandomFunction</code> and make a case for a similar <code>Op</code> in PyMC3.</p>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>We’ll call the new <code>Op</code> developed here <code>RandomVariable</code>, since random variables are the abstraction we’re primarily targeting. <code>RandomVariable</code> will provide the functionality of <code>Distribution</code>, <code>FreeRV</code> and <code>ObservedRV</code>, and, by working at the <code>Op</code> level, it will be much more capable of leveraging existing Theano functionality.</p>
<p>Specifically, by using the <code>Op</code> interface, we’re able to do the following:</p>
<ol type="1">
<li><p>Remove the need for an explicitly specified shape parameter.</p>
<div class="example" data-markdown="">
<p>For example, definitions like</p>
<div class="sourceCode" id="org9f36fc6"><pre class="sourceCode python"><code class="sourceCode python"><span id="org9f36fc6-1"><a href="#org9f36fc6-1" aria-hidden="true"></a><span class="cf">with</span> pm.Model():</span>
<span id="org9f36fc6-2"><a href="#org9f36fc6-2" aria-hidden="true"></a>    X_rv <span class="op">=</span> pm.Normal(<span class="st">&#39;X_rv&#39;</span>, mu_X, sd<span class="op">=</span>sd_X, shape<span class="op">=</span>(<span class="dv">1</span>,))</span></code></pre></div>
<p>reduce to</p>
<div class="sourceCode" id="orgf62e7a4"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgf62e7a4-1"><a href="#orgf62e7a4-1" aria-hidden="true"></a><span class="cf">with</span> pm.Model():</span>
<span id="orgf62e7a4-2"><a href="#orgf62e7a4-2" aria-hidden="true"></a>    X_rv <span class="op">=</span> pm.Normal(<span class="st">&#39;X_rv&#39;</span>, mu_X, sd<span class="op">=</span>sd_X)</span></code></pre></div>
</div></li>
<li><p>Random variable nodes created by an <code>Op</code> automatically implement <code>Distribution.default</code>/<code>Distribution.get_test_val</code> functionality and remove the reliance on initial values during random variable instantiation. <code>Op</code> automatically uses <code>Op.perform</code>, which will draw a sample as a test value <strong>and</strong> propagate it throughout the graph to down-stream tensor variables.</p></li>
<li><p>Log-densities can be generated as secondary outputs of <code>Op.make_node</code>, which removes the need for <code>Distribution.logp*</code> methods.</p></li>
<li><p><code>pymc.distribution.draw_values</code> and related methods are no longer necessary; their functionality is already covered within Theano’s existing graph machinery–in the same way as <code>pymc.distribution.Distribution.default/get_test_val</code>.</p></li>
</ol>
<p>The main points of entry in our <code>Op</code>, are <code>Op.make_node</code> and <code>Op.perform</code>. <code>Op.make_node</code> is used during symbolic graph creation and provides immediate access to the <code>Op</code>’s symbolic inputs–serving a purpose similar to <code>Distribution.__init__</code>. <code>Op.make_node</code> is where shape inference tasks (e.g. <a href="https://github.com/pymc-devs/pymc3/pull/1125">PyMC3 PR 1125</a>) are more suitably addressed; however, <code>Op</code> provides additional means of shape inference and management (e.g. <code>Op.infer_shape</code>) occurring at different phases of graph compilation that aren’t readily accessible outside of the <code>Op</code> framework.</p>
</section>
<section id="a-new-random-variable-op" class="level1">
<h1>A <strong>new</strong> Random Variable <code>Op</code></h1>
<div class="sourceCode" id="org9c584cc"><pre class="sourceCode python"><code class="sourceCode python"><span id="org9c584cc-1"><a href="#org9c584cc-1" aria-hidden="true"></a><span class="im">import</span> sys</span>
<span id="org9c584cc-2"><a href="#org9c584cc-2" aria-hidden="true"></a><span class="im">import</span> os</span>
<span id="org9c584cc-3"><a href="#org9c584cc-3" aria-hidden="true"></a></span>
<span id="org9c584cc-4"><a href="#org9c584cc-4" aria-hidden="true"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="org9c584cc-5"><a href="#org9c584cc-5" aria-hidden="true"></a></span>
<span id="org9c584cc-6"><a href="#org9c584cc-6" aria-hidden="true"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="org9c584cc-7"><a href="#org9c584cc-7" aria-hidden="true"></a></span>
<span id="org9c584cc-8"><a href="#org9c584cc-8" aria-hidden="true"></a>os.environ[<span class="st">&#39;MKL_THREADING_LAYER&#39;</span>] <span class="op">=</span> <span class="st">&#39;GNU&#39;</span></span>
<span id="org9c584cc-9"><a href="#org9c584cc-9" aria-hidden="true"></a></span>
<span id="org9c584cc-10"><a href="#org9c584cc-10" aria-hidden="true"></a><span class="im">import</span> theano</span>
<span id="org9c584cc-11"><a href="#org9c584cc-11" aria-hidden="true"></a><span class="im">import</span> theano.tensor <span class="im">as</span> tt</span>
<span id="org9c584cc-12"><a href="#org9c584cc-12" aria-hidden="true"></a></span>
<span id="org9c584cc-13"><a href="#org9c584cc-13" aria-hidden="true"></a>theano.config.mode <span class="op">=</span> <span class="st">&#39;FAST_COMPILE&#39;</span></span>
<span id="org9c584cc-14"><a href="#org9c584cc-14" aria-hidden="true"></a>theano.config.exception_verbosity <span class="op">=</span> <span class="st">&#39;high&#39;</span></span>
<span id="org9c584cc-15"><a href="#org9c584cc-15" aria-hidden="true"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: pymc3 requires test values</span></span>
<span id="org9c584cc-16"><a href="#org9c584cc-16" aria-hidden="true"></a>theano.config.compute_test_value <span class="op">=</span> <span class="st">&#39;warn&#39;</span></span>
<span id="org9c584cc-17"><a href="#org9c584cc-17" aria-hidden="true"></a></span>
<span id="org9c584cc-18"><a href="#org9c584cc-18" aria-hidden="true"></a><span class="im">import</span> pymc3 <span class="im">as</span> pm</span></code></pre></div>
<p>Most of the work involved in generalizing <code>RandomFunction</code> has to do with symbolic shape handling and inference. We need to bridge the gaps between symbolic array/tensor broadcasting parameters and the way Numpy random variable functions allow distribution parameters to be specified.</p>
<div class="example" data-markdown="">
<p>Scalar normal random variates have a support and parameters with dimension zero. In Listing <a href="#org352d751">4</a> we create a scalar normal random variate in Numpy and inspect its shape. The length of the shape corresponds to the dimension of the distribution’s support (i.e. zero).</p>
<div class="sourceCode" id="org352d751"><pre class="sourceCode python"><code class="sourceCode python"><span id="org352d751-1"><a href="#org352d751-1" aria-hidden="true"></a>np.shape(np.random.normal(loc<span class="op">=</span><span class="dv">0</span>, scale<span class="op">=</span><span class="dv">1</span>, size<span class="op">=</span><span class="va">None</span>))</span></code></pre></div>
<div class="sourceCode" id="org96612e2"><pre class="sourceCode python"><code class="sourceCode python"><span id="org96612e2-1"><a href="#org96612e2-1" aria-hidden="true"></a>()</span></code></pre></div>
<p>Numpy also allows one to specify <strong>independent</strong> normal variates using one function call with each variate’s parameters spanning dimensions higher than the variate’s. In Listing <a href="#orgbabaa48">6</a> we specify three independent scalar normal variates, each with a different mean and scale parameter. This time, the result’s shape reflects <strong>the number of independent random variates</strong>, and not the dimension of the underlying distribution’s support.</p>
<div class="sourceCode" id="orgbabaa48"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgbabaa48-1"><a href="#orgbabaa48-1" aria-hidden="true"></a>np.shape(np.random.normal(loc<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>], scale<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], size<span class="op">=</span><span class="va">None</span>))</span></code></pre></div>
<div class="sourceCode" id="orgef69d1e"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgef69d1e-1"><a href="#orgef69d1e-1" aria-hidden="true"></a>(<span class="dv">3</span>,)</span></code></pre></div>
<p>Distribution parameters can also be broadcasted, as in <a href="#org6643ee7">8</a>. Now, each independent variate has the same scale value.</p>
<div class="sourceCode" id="org6643ee7"><pre class="sourceCode python"><code class="sourceCode python"><span id="org6643ee7-1"><a href="#org6643ee7-1" aria-hidden="true"></a>np.shape(np.random.normal(loc<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>], scale<span class="op">=</span><span class="dv">1</span>, size<span class="op">=</span><span class="va">None</span>))</span></code></pre></div>
<p>The <code>size</code> parameter effectively replicates variates, in-line with the–potentially broadcasted–distribution parameters.</p>
<p>When bridging these Numpy functions and Theano, we have to adapt the underlying parameter/shape logic of functions like <code>np.random.normal</code> to a scenario involving symbolic parameters and their symbolic shapes.</p>
<p>For instance, in Theano a <strong>symbolic</strong> scalar’s shape is represented in nearly the same way.</p>
<div class="sourceCode" id="orga6116d4"><pre class="sourceCode python"><code class="sourceCode python"><span id="orga6116d4-1"><a href="#orga6116d4-1" aria-hidden="true"></a>test_scalar <span class="op">=</span> tt.scalar()</span>
<span id="orga6116d4-2"><a href="#orga6116d4-2" aria-hidden="true"></a>test_scalar.shape.<span class="bu">eval</span>({test_scalar: <span class="dv">1</span>})</span></code></pre></div>
<div class="sourceCode" id="orgb9018eb"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgb9018eb-1"><a href="#orgb9018eb-1" aria-hidden="true"></a>[]</span></code></pre></div>
<p>This means that our proposed Theano adaptation of <code>np.random.normal</code>, let’s call it <code>tt_normal</code>, should return the same result as Numpy in the case of scalars.</p>
<p>What about <code>tt_normal(loc=tt.vector(), scale=tt.vector(), size=None)</code>? Since the inputs are purely symbolic, the resulting symbolic object’s shape should be, too, but we should also know that the symbolic shape should have dimension equal to one. Just as in Listing <a href="#orgbabaa48">6</a>, each corresponding element in the vector arguments of <code>tt_normal</code> is an independent variate; in the symbolic case, we might not know exactly how many of them there are, yet, but we know that there’s a vector’s worth of them.</p>
<p>How exactly do we get that information from Theano, though? The type produced by <code>tt.vector</code> has an <code>ndim</code> parameter that provides this. Furthermore, there is some (intermittent) functionality that allows one to iterate over shapes. Listing <a href="#org0d70518">11</a> demonstrates this.</p>
<div class="sourceCode" id="org0d70518"><pre class="sourceCode python"><code class="sourceCode python"><span id="org0d70518-1"><a href="#org0d70518-1" aria-hidden="true"></a>test_matrix <span class="op">=</span> tt.matrix()</span>
<span id="org0d70518-2"><a href="#org0d70518-2" aria-hidden="true"></a>shape_parts <span class="op">=</span> <span class="bu">tuple</span>(test_matrix.shape)</span>
<span id="org0d70518-3"><a href="#org0d70518-3" aria-hidden="true"></a>shape_parts</span></code></pre></div>
<div class="sourceCode" id="orgd865db6"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgd865db6-1"><a href="#orgd865db6-1" aria-hidden="true"></a>(Subtensor{int64}<span class="fl">.0</span>, Subtensor{int64}<span class="fl">.0</span>)</span></code></pre></div>
<p>When the matrix in Listing <a href="#org0d70518">11</a> is “materialized” (i.e. given a value), its corresponding shape object–and its components–will take their respective values.</p>
<div class="sourceCode" id="org4d51e03"><pre class="sourceCode python"><code class="sourceCode python"><span id="org4d51e03-1"><a href="#org4d51e03-1" aria-hidden="true"></a><span class="bu">tuple</span>(p.<span class="bu">eval</span>({test_matrix: np.diag([<span class="dv">1</span>, <span class="dv">2</span>])}) <span class="cf">for</span> p <span class="kw">in</span> shape_parts)</span></code></pre></div>
<div class="sourceCode" id="orgc53dece"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgc53dece-1"><a href="#orgc53dece-1" aria-hidden="true"></a>(array(<span class="dv">2</span>), array(<span class="dv">2</span>))</span></code></pre></div>
<p>If we knew that the support of this distribution was a scalar/vector/matrix, then these <code>ndim</code>-related results–obtained from the symbolic parameters–would tell us that we have multiple, independent variates and we could reliably extract the symbolic variables corresponding to those actual dimension sizes.</p>
</div>
<p>To determine the shape parts (i.e. support, number of independent and replicated variates) of the symbolic random variables, we mimic the corresponding Numpy logic and use the Theano <code>ndim</code> shape information described above. The following function generalizes that work for many simple distributions.</p>
<div class="sourceCode" id="org03297c0"><pre class="sourceCode python"><code class="sourceCode python"><span id="org03297c0-1"><a href="#org03297c0-1" aria-hidden="true"></a><span class="im">from</span> collections.abc <span class="im">import</span> Iterable, ByteString</span>
<span id="org03297c0-2"><a href="#org03297c0-2" aria-hidden="true"></a><span class="im">from</span> warnings <span class="im">import</span> warn</span>
<span id="org03297c0-3"><a href="#org03297c0-3" aria-hidden="true"></a><span class="im">from</span> copy <span class="im">import</span> copy</span>
<span id="org03297c0-4"><a href="#org03297c0-4" aria-hidden="true"></a></span>
<span id="org03297c0-5"><a href="#org03297c0-5" aria-hidden="true"></a><span class="im">from</span> theano.tensor.raw_random <span class="im">import</span> (RandomFunction, RandomStateType,</span>
<span id="org03297c0-6"><a href="#org03297c0-6" aria-hidden="true"></a>                                      _infer_ndim_bcast)</span>
<span id="org03297c0-7"><a href="#org03297c0-7" aria-hidden="true"></a></span>
<span id="org03297c0-8"><a href="#org03297c0-8" aria-hidden="true"></a></span>
<span id="org03297c0-9"><a href="#org03297c0-9" aria-hidden="true"></a><span class="kw">def</span> param_supp_shape_fn(ndim_supp, ndims_params, dist_params,</span>
<span id="org03297c0-10"><a href="#org03297c0-10" aria-hidden="true"></a>                        rep_param_idx<span class="op">=</span><span class="dv">0</span>, param_shapes<span class="op">=</span><span class="va">None</span>):</span>
<span id="org03297c0-11"><a href="#org03297c0-11" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;A function for deriving a random variable&#39;s support shape/dimensions</span></span>
<span id="org03297c0-12"><a href="#org03297c0-12" aria-hidden="true"></a><span class="co">    from one of its parameters.</span></span>
<span id="org03297c0-13"><a href="#org03297c0-13" aria-hidden="true"></a></span>
<span id="org03297c0-14"><a href="#org03297c0-14" aria-hidden="true"></a><span class="co">    XXX: It&#39;s not always possible to determine a random variable&#39;s support</span></span>
<span id="org03297c0-15"><a href="#org03297c0-15" aria-hidden="true"></a><span class="co">    shape from its parameters, so this function has fundamentally limited</span></span>
<span id="org03297c0-16"><a href="#org03297c0-16" aria-hidden="true"></a><span class="co">    applicability.</span></span>
<span id="org03297c0-17"><a href="#org03297c0-17" aria-hidden="true"></a></span>
<span id="org03297c0-18"><a href="#org03297c0-18" aria-hidden="true"></a><span class="co">    XXX: This function is not expected to handle `ndim_supp = 0` (i.e.</span></span>
<span id="org03297c0-19"><a href="#org03297c0-19" aria-hidden="true"></a><span class="co">    scalars), since that is already definitively handled in the `Op` that</span></span>
<span id="org03297c0-20"><a href="#org03297c0-20" aria-hidden="true"></a><span class="co">    calls this.</span></span>
<span id="org03297c0-21"><a href="#org03297c0-21" aria-hidden="true"></a></span>
<span id="org03297c0-22"><a href="#org03297c0-22" aria-hidden="true"></a><span class="co">    </span><span class="al">TODO</span><span class="co">: Consider using `theano.compile.ops.shape_i` alongside `ShapeFeature`.</span></span>
<span id="org03297c0-23"><a href="#org03297c0-23" aria-hidden="true"></a></span>
<span id="org03297c0-24"><a href="#org03297c0-24" aria-hidden="true"></a><span class="co">    Parameters</span></span>
<span id="org03297c0-25"><a href="#org03297c0-25" aria-hidden="true"></a><span class="co">    ==========</span></span>
<span id="org03297c0-26"><a href="#org03297c0-26" aria-hidden="true"></a><span class="co">    ndim_supp: int</span></span>
<span id="org03297c0-27"><a href="#org03297c0-27" aria-hidden="true"></a><span class="co">        Total number of dimensions in the support (assumedly &gt; 0).</span></span>
<span id="org03297c0-28"><a href="#org03297c0-28" aria-hidden="true"></a><span class="co">    ndims_params: list of int</span></span>
<span id="org03297c0-29"><a href="#org03297c0-29" aria-hidden="true"></a><span class="co">        Number of dimensions for each distribution parameter.</span></span>
<span id="org03297c0-30"><a href="#org03297c0-30" aria-hidden="true"></a><span class="co">    dist_params: list of `theano.gof.graph.Variable`</span></span>
<span id="org03297c0-31"><a href="#org03297c0-31" aria-hidden="true"></a><span class="co">        The distribution parameters.</span></span>
<span id="org03297c0-32"><a href="#org03297c0-32" aria-hidden="true"></a><span class="co">    param_shapes: list of `theano.compile.ops.Shape` (optional)</span></span>
<span id="org03297c0-33"><a href="#org03297c0-33" aria-hidden="true"></a><span class="co">        Symbolic shapes for each distribution parameter.</span></span>
<span id="org03297c0-34"><a href="#org03297c0-34" aria-hidden="true"></a><span class="co">        Providing this value prevents us from reproducing the requisite</span></span>
<span id="org03297c0-35"><a href="#org03297c0-35" aria-hidden="true"></a><span class="co">        `theano.compile.ops.Shape` object (e.g. when it&#39;s already available to</span></span>
<span id="org03297c0-36"><a href="#org03297c0-36" aria-hidden="true"></a><span class="co">        the caller).</span></span>
<span id="org03297c0-37"><a href="#org03297c0-37" aria-hidden="true"></a><span class="co">    rep_param_idx: int (optional)</span></span>
<span id="org03297c0-38"><a href="#org03297c0-38" aria-hidden="true"></a><span class="co">        The index of the distribution parameter to use as a reference</span></span>
<span id="org03297c0-39"><a href="#org03297c0-39" aria-hidden="true"></a><span class="co">        In other words, a parameter in `dist_param` with a shape corresponding</span></span>
<span id="org03297c0-40"><a href="#org03297c0-40" aria-hidden="true"></a><span class="co">        to the support&#39;s shape.</span></span>
<span id="org03297c0-41"><a href="#org03297c0-41" aria-hidden="true"></a><span class="co">        The default is the first parameter (i.e. the value 0).</span></span>
<span id="org03297c0-42"><a href="#org03297c0-42" aria-hidden="true"></a></span>
<span id="org03297c0-43"><a href="#org03297c0-43" aria-hidden="true"></a><span class="co">    Results</span></span>
<span id="org03297c0-44"><a href="#org03297c0-44" aria-hidden="true"></a><span class="co">    =======</span></span>
<span id="org03297c0-45"><a href="#org03297c0-45" aria-hidden="true"></a><span class="co">    out: a tuple representing the support shape for a distribution with the</span></span>
<span id="org03297c0-46"><a href="#org03297c0-46" aria-hidden="true"></a><span class="co">    given `dist_params`.</span></span>
<span id="org03297c0-47"><a href="#org03297c0-47" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="org03297c0-48"><a href="#org03297c0-48" aria-hidden="true"></a>    <span class="co"># XXX: Gotta be careful slicing Theano variables, the `Subtensor` Op isn&#39;t</span></span>
<span id="org03297c0-49"><a href="#org03297c0-49" aria-hidden="true"></a>    <span class="co"># handled by `tensor.get_scalar_constant_value`!</span></span>
<span id="org03297c0-50"><a href="#org03297c0-50" aria-hidden="true"></a>    <span class="co"># E.g.</span></span>
<span id="org03297c0-51"><a href="#org03297c0-51" aria-hidden="true"></a>    <span class="co">#     test_val = tt.as_tensor_variable([[1], [4]])</span></span>
<span id="org03297c0-52"><a href="#org03297c0-52" aria-hidden="true"></a>    <span class="co">#     tt.get_scalar_constant_value(test_val.shape[-1]) # works</span></span>
<span id="org03297c0-53"><a href="#org03297c0-53" aria-hidden="true"></a>    <span class="co">#     tt.get_scalar_constant_value(test_val.shape[0]) # doesn&#39;t</span></span>
<span id="org03297c0-54"><a href="#org03297c0-54" aria-hidden="true"></a>    <span class="co">#     tt.get_scalar_constant_value(test_val.shape[:-1]) # doesn&#39;t</span></span>
<span id="org03297c0-55"><a href="#org03297c0-55" aria-hidden="true"></a>    <span class="cf">if</span> param_shapes <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="org03297c0-56"><a href="#org03297c0-56" aria-hidden="true"></a>        <span class="co"># return param_shapes[0][-self.ndim_supp:]</span></span>
<span id="org03297c0-57"><a href="#org03297c0-57" aria-hidden="true"></a>        <span class="cf">return</span> (param_shapes[rep_param_idx][<span class="op">-</span>ndim_supp],)</span>
<span id="org03297c0-58"><a href="#org03297c0-58" aria-hidden="true"></a>    <span class="cf">else</span>:</span>
<span id="org03297c0-59"><a href="#org03297c0-59" aria-hidden="true"></a>        <span class="co"># return dist_params[rep_param_idx].shape[-ndim_supp]</span></span>
<span id="org03297c0-60"><a href="#org03297c0-60" aria-hidden="true"></a>        ref_shape <span class="op">=</span> tt.shape(dist_params[rep_param_idx])</span>
<span id="org03297c0-61"><a href="#org03297c0-61" aria-hidden="true"></a>        <span class="cf">return</span> (ref_shape[<span class="op">-</span>ndim_supp],)</span></code></pre></div>
<p>Finally, we put everything together in a new random variable <code>Op</code> called <code>RandomVariable</code>.</p>
<div class="sourceCode" id="orgb7517e4"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgb7517e4-1"><a href="#orgb7517e4-1" aria-hidden="true"></a><span class="kw">class</span> RandomVariable(tt.gof.Op):</span>
<span id="orgb7517e4-2"><a href="#orgb7517e4-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;This is essentially `RandomFunction`, except that it removes the `outtype`</span></span>
<span id="orgb7517e4-3"><a href="#orgb7517e4-3" aria-hidden="true"></a><span class="co">    dependency and handles shape dimension information more directly.</span></span>
<span id="orgb7517e4-4"><a href="#orgb7517e4-4" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="orgb7517e4-5"><a href="#orgb7517e4-5" aria-hidden="true"></a>    __props__ <span class="op">=</span> (<span class="st">&#39;name&#39;</span>, <span class="st">&#39;dtype&#39;</span>, <span class="st">&#39;ndim_supp&#39;</span>, <span class="st">&#39;inplace&#39;</span>, <span class="st">&#39;ndims_params&#39;</span>)</span>
<span id="orgb7517e4-6"><a href="#orgb7517e4-6" aria-hidden="true"></a></span>
<span id="orgb7517e4-7"><a href="#orgb7517e4-7" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name, dtype, ndim_supp, ndims_params, rng_fn,</span>
<span id="orgb7517e4-8"><a href="#orgb7517e4-8" aria-hidden="true"></a>                 <span class="op">*</span>args,</span>
<span id="orgb7517e4-9"><a href="#orgb7517e4-9" aria-hidden="true"></a>                 supp_shape_fn<span class="op">=</span>param_supp_shape_fn,</span>
<span id="orgb7517e4-10"><a href="#orgb7517e4-10" aria-hidden="true"></a>                 inplace<span class="op">=</span><span class="va">False</span>,</span>
<span id="orgb7517e4-11"><a href="#orgb7517e4-11" aria-hidden="true"></a>                 <span class="op">**</span>kwargs):</span>
<span id="orgb7517e4-12"><a href="#orgb7517e4-12" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Create a random variable `Op`.</span></span>
<span id="orgb7517e4-13"><a href="#orgb7517e4-13" aria-hidden="true"></a></span>
<span id="orgb7517e4-14"><a href="#orgb7517e4-14" aria-hidden="true"></a><span class="co">        Parameters</span></span>
<span id="orgb7517e4-15"><a href="#orgb7517e4-15" aria-hidden="true"></a><span class="co">        ==========</span></span>
<span id="orgb7517e4-16"><a href="#orgb7517e4-16" aria-hidden="true"></a><span class="co">        name: str</span></span>
<span id="orgb7517e4-17"><a href="#orgb7517e4-17" aria-hidden="true"></a><span class="co">            The `Op`&#39;s display name.</span></span>
<span id="orgb7517e4-18"><a href="#orgb7517e4-18" aria-hidden="true"></a><span class="co">        dtype: Theano dtype</span></span>
<span id="orgb7517e4-19"><a href="#orgb7517e4-19" aria-hidden="true"></a><span class="co">            The underlying dtype.</span></span>
<span id="orgb7517e4-20"><a href="#orgb7517e4-20" aria-hidden="true"></a><span class="co">        ndim_supp: int</span></span>
<span id="orgb7517e4-21"><a href="#orgb7517e4-21" aria-hidden="true"></a><span class="co">            Dimension of the support.  This value is used to infer the exact</span></span>
<span id="orgb7517e4-22"><a href="#orgb7517e4-22" aria-hidden="true"></a><span class="co">            shape of the support and independent terms from ``dist_params``.</span></span>
<span id="orgb7517e4-23"><a href="#orgb7517e4-23" aria-hidden="true"></a><span class="co">        ndims_params: tuple (int)</span></span>
<span id="orgb7517e4-24"><a href="#orgb7517e4-24" aria-hidden="true"></a><span class="co">            Number of dimensions of each parameter in ``dist_params``.</span></span>
<span id="orgb7517e4-25"><a href="#orgb7517e4-25" aria-hidden="true"></a><span class="co">        rng_fn: function or str</span></span>
<span id="orgb7517e4-26"><a href="#orgb7517e4-26" aria-hidden="true"></a><span class="co">            The non-symbolic random variate sampling function.</span></span>
<span id="orgb7517e4-27"><a href="#orgb7517e4-27" aria-hidden="true"></a><span class="co">            Can be the string name of a method provided by</span></span>
<span id="orgb7517e4-28"><a href="#orgb7517e4-28" aria-hidden="true"></a><span class="co">            `numpy.random.RandomState`.</span></span>
<span id="orgb7517e4-29"><a href="#orgb7517e4-29" aria-hidden="true"></a><span class="co">        supp_shape_fn: callable (optional)</span></span>
<span id="orgb7517e4-30"><a href="#orgb7517e4-30" aria-hidden="true"></a><span class="co">            Function used to determine the exact shape of the distribution&#39;s</span></span>
<span id="orgb7517e4-31"><a href="#orgb7517e4-31" aria-hidden="true"></a><span class="co">            support.</span></span>
<span id="orgb7517e4-32"><a href="#orgb7517e4-32" aria-hidden="true"></a></span>
<span id="orgb7517e4-33"><a href="#orgb7517e4-33" aria-hidden="true"></a><span class="co">            It must take arguments ndim_supp, ndims_params, dist_params</span></span>
<span id="orgb7517e4-34"><a href="#orgb7517e4-34" aria-hidden="true"></a><span class="co">            (i.e. an collection of the distribution parameters) and an</span></span>
<span id="orgb7517e4-35"><a href="#orgb7517e4-35" aria-hidden="true"></a><span class="co">            optional param_shapes (i.e. tuples containing the size of each</span></span>
<span id="orgb7517e4-36"><a href="#orgb7517e4-36" aria-hidden="true"></a><span class="co">            dimension for each distribution parameter).</span></span>
<span id="orgb7517e4-37"><a href="#orgb7517e4-37" aria-hidden="true"></a></span>
<span id="orgb7517e4-38"><a href="#orgb7517e4-38" aria-hidden="true"></a><span class="co">            Defaults to `param_supp_shape_fn`.</span></span>
<span id="orgb7517e4-39"><a href="#orgb7517e4-39" aria-hidden="true"></a><span class="co">        inplace: boolean</span></span>
<span id="orgb7517e4-40"><a href="#orgb7517e4-40" aria-hidden="true"></a><span class="co">            Determine whether or not the underlying rng state is updated in-place or</span></span>
<span id="orgb7517e4-41"><a href="#orgb7517e4-41" aria-hidden="true"></a><span class="co">            not (i.e. copied).</span></span>
<span id="orgb7517e4-42"><a href="#orgb7517e4-42" aria-hidden="true"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="orgb7517e4-43"><a href="#orgb7517e4-43" aria-hidden="true"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="orgb7517e4-44"><a href="#orgb7517e4-44" aria-hidden="true"></a></span>
<span id="orgb7517e4-45"><a href="#orgb7517e4-45" aria-hidden="true"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="orgb7517e4-46"><a href="#orgb7517e4-46" aria-hidden="true"></a>        <span class="va">self</span>.ndim_supp <span class="op">=</span> ndim_supp</span>
<span id="orgb7517e4-47"><a href="#orgb7517e4-47" aria-hidden="true"></a>        <span class="va">self</span>.dtype <span class="op">=</span> dtype</span>
<span id="orgb7517e4-48"><a href="#orgb7517e4-48" aria-hidden="true"></a>        <span class="va">self</span>.supp_shape_fn <span class="op">=</span> supp_shape_fn</span>
<span id="orgb7517e4-49"><a href="#orgb7517e4-49" aria-hidden="true"></a>        <span class="va">self</span>.inplace <span class="op">=</span> inplace</span>
<span id="orgb7517e4-50"><a href="#orgb7517e4-50" aria-hidden="true"></a></span>
<span id="orgb7517e4-51"><a href="#orgb7517e4-51" aria-hidden="true"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(ndims_params, Iterable):</span>
<span id="orgb7517e4-52"><a href="#orgb7517e4-52" aria-hidden="true"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&#39;Parameter ndims_params must be iterable.&#39;</span>)</span>
<span id="orgb7517e4-53"><a href="#orgb7517e4-53" aria-hidden="true"></a></span>
<span id="orgb7517e4-54"><a href="#orgb7517e4-54" aria-hidden="true"></a>        <span class="va">self</span>.ndims_params <span class="op">=</span> <span class="bu">tuple</span>(ndims_params)</span>
<span id="orgb7517e4-55"><a href="#orgb7517e4-55" aria-hidden="true"></a></span>
<span id="orgb7517e4-56"><a href="#orgb7517e4-56" aria-hidden="true"></a>        <span class="va">self</span>.default_output <span class="op">=</span> <span class="dv">1</span></span>
<span id="orgb7517e4-57"><a href="#orgb7517e4-57" aria-hidden="true"></a></span>
<span id="orgb7517e4-58"><a href="#orgb7517e4-58" aria-hidden="true"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(rng_fn, (<span class="bu">str</span>, ByteString)):</span>
<span id="orgb7517e4-59"><a href="#orgb7517e4-59" aria-hidden="true"></a>            <span class="va">self</span>.rng_fn <span class="op">=</span> <span class="bu">getattr</span>(np.random.RandomState, rng_fn)</span>
<span id="orgb7517e4-60"><a href="#orgb7517e4-60" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="orgb7517e4-61"><a href="#orgb7517e4-61" aria-hidden="true"></a>            <span class="va">self</span>.rng_fn <span class="op">=</span> rng_fn</span>
<span id="orgb7517e4-62"><a href="#orgb7517e4-62" aria-hidden="true"></a></span>
<span id="orgb7517e4-63"><a href="#orgb7517e4-63" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="orgb7517e4-64"><a href="#orgb7517e4-64" aria-hidden="true"></a>        <span class="cf">return</span> <span class="st">&#39;</span><span class="sc">{}</span><span class="st">_rv&#39;</span>.<span class="bu">format</span>(<span class="va">self</span>.name)</span>
<span id="orgb7517e4-65"><a href="#orgb7517e4-65" aria-hidden="true"></a></span>
<span id="orgb7517e4-66"><a href="#orgb7517e4-66" aria-hidden="true"></a>    <span class="kw">def</span> _infer_shape(<span class="va">self</span>, size, dist_params, param_shapes<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgb7517e4-67"><a href="#orgb7517e4-67" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Compute shapes and broadcasts properties.</span></span>
<span id="orgb7517e4-68"><a href="#orgb7517e4-68" aria-hidden="true"></a></span>
<span id="orgb7517e4-69"><a href="#orgb7517e4-69" aria-hidden="true"></a><span class="co">        Inspired by `tt.add.get_output_info`.</span></span>
<span id="orgb7517e4-70"><a href="#orgb7517e4-70" aria-hidden="true"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="orgb7517e4-71"><a href="#orgb7517e4-71" aria-hidden="true"></a></span>
<span id="orgb7517e4-72"><a href="#orgb7517e4-72" aria-hidden="true"></a>        size_len <span class="op">=</span> tt.get_vector_length(size)</span>
<span id="orgb7517e4-73"><a href="#orgb7517e4-73" aria-hidden="true"></a></span>
<span id="orgb7517e4-74"><a href="#orgb7517e4-74" aria-hidden="true"></a>        dummy_params <span class="op">=</span> <span class="bu">tuple</span>(p <span class="cf">if</span> n <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> tt.ones(<span class="bu">tuple</span>(p.shape)[:<span class="op">-</span>n])</span>
<span id="orgb7517e4-75"><a href="#orgb7517e4-75" aria-hidden="true"></a>                             <span class="cf">for</span> p, n <span class="kw">in</span> <span class="bu">zip</span>(dist_params, <span class="va">self</span>.ndims_params))</span>
<span id="orgb7517e4-76"><a href="#orgb7517e4-76" aria-hidden="true"></a></span>
<span id="orgb7517e4-77"><a href="#orgb7517e4-77" aria-hidden="true"></a>        _, out_bcasts, bcastd_inputs <span class="op">=</span> tt.add.get_output_info(</span>
<span id="orgb7517e4-78"><a href="#orgb7517e4-78" aria-hidden="true"></a>            tt.DimShuffle, <span class="op">*</span>dummy_params)</span>
<span id="orgb7517e4-79"><a href="#orgb7517e4-79" aria-hidden="true"></a></span>
<span id="orgb7517e4-80"><a href="#orgb7517e4-80" aria-hidden="true"></a>        <span class="co"># _, out_bcasts, bcastd_inputs = tt.add.get_output_info(tt.DimShuffle, *dist_params)</span></span>
<span id="orgb7517e4-81"><a href="#orgb7517e4-81" aria-hidden="true"></a></span>
<span id="orgb7517e4-82"><a href="#orgb7517e4-82" aria-hidden="true"></a>        bcast_ind, <span class="op">=</span> out_bcasts</span>
<span id="orgb7517e4-83"><a href="#orgb7517e4-83" aria-hidden="true"></a>        ndim_ind <span class="op">=</span> <span class="bu">len</span>(bcast_ind)</span>
<span id="orgb7517e4-84"><a href="#orgb7517e4-84" aria-hidden="true"></a>        shape_ind <span class="op">=</span> bcastd_inputs[<span class="dv">0</span>].shape</span>
<span id="orgb7517e4-85"><a href="#orgb7517e4-85" aria-hidden="true"></a></span>
<span id="orgb7517e4-86"><a href="#orgb7517e4-86" aria-hidden="true"></a>        <span class="cf">if</span> <span class="va">self</span>.ndim_supp <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="orgb7517e4-87"><a href="#orgb7517e4-87" aria-hidden="true"></a>            shape_supp <span class="op">=</span> <span class="bu">tuple</span>()</span>
<span id="orgb7517e4-88"><a href="#orgb7517e4-88" aria-hidden="true"></a></span>
<span id="orgb7517e4-89"><a href="#orgb7517e4-89" aria-hidden="true"></a>            <span class="co"># In the scalar case, `size` corresponds to the entire result&#39;s</span></span>
<span id="orgb7517e4-90"><a href="#orgb7517e4-90" aria-hidden="true"></a>            <span class="co"># shape. This implies the following:</span></span>
<span id="orgb7517e4-91"><a href="#orgb7517e4-91" aria-hidden="true"></a>            <span class="co">#     shape_ind[-ndim_ind] == size[:ndim_ind]</span></span>
<span id="orgb7517e4-92"><a href="#orgb7517e4-92" aria-hidden="true"></a>            <span class="co"># </span><span class="al">TODO</span><span class="co">: How do we add this constraint/check symbolically?</span></span>
<span id="orgb7517e4-93"><a href="#orgb7517e4-93" aria-hidden="true"></a></span>
<span id="orgb7517e4-94"><a href="#orgb7517e4-94" aria-hidden="true"></a>            ndim_reps <span class="op">=</span> <span class="bu">max</span>(size_len <span class="op">-</span> ndim_ind, <span class="dv">0</span>)</span>
<span id="orgb7517e4-95"><a href="#orgb7517e4-95" aria-hidden="true"></a>            shape_reps <span class="op">=</span> <span class="bu">tuple</span>(size)[ndim_ind:]</span>
<span id="orgb7517e4-96"><a href="#orgb7517e4-96" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="orgb7517e4-97"><a href="#orgb7517e4-97" aria-hidden="true"></a>            shape_supp <span class="op">=</span> <span class="va">self</span>.supp_shape_fn(<span class="va">self</span>.ndim_supp,</span>
<span id="orgb7517e4-98"><a href="#orgb7517e4-98" aria-hidden="true"></a>                                            <span class="va">self</span>.ndims_params,</span>
<span id="orgb7517e4-99"><a href="#orgb7517e4-99" aria-hidden="true"></a>                                            dist_params,</span>
<span id="orgb7517e4-100"><a href="#orgb7517e4-100" aria-hidden="true"></a>                                            param_shapes<span class="op">=</span>param_shapes)</span>
<span id="orgb7517e4-101"><a href="#orgb7517e4-101" aria-hidden="true"></a></span>
<span id="orgb7517e4-102"><a href="#orgb7517e4-102" aria-hidden="true"></a>            ndim_reps <span class="op">=</span> size_len</span>
<span id="orgb7517e4-103"><a href="#orgb7517e4-103" aria-hidden="true"></a>            shape_reps <span class="op">=</span> size</span>
<span id="orgb7517e4-104"><a href="#orgb7517e4-104" aria-hidden="true"></a></span>
<span id="orgb7517e4-105"><a href="#orgb7517e4-105" aria-hidden="true"></a>        ndim_shape <span class="op">=</span> <span class="va">self</span>.ndim_supp <span class="op">+</span> ndim_ind <span class="op">+</span> ndim_reps</span>
<span id="orgb7517e4-106"><a href="#orgb7517e4-106" aria-hidden="true"></a></span>
<span id="orgb7517e4-107"><a href="#orgb7517e4-107" aria-hidden="true"></a>        <span class="cf">if</span> ndim_shape <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="orgb7517e4-108"><a href="#orgb7517e4-108" aria-hidden="true"></a>            shape <span class="op">=</span> tt.constant([], dtype<span class="op">=</span><span class="st">&#39;int64&#39;</span>)</span>
<span id="orgb7517e4-109"><a href="#orgb7517e4-109" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="orgb7517e4-110"><a href="#orgb7517e4-110" aria-hidden="true"></a>            shape <span class="op">=</span> <span class="bu">tuple</span>(shape_reps) <span class="op">+</span> <span class="bu">tuple</span>(shape_ind) <span class="op">+</span> <span class="bu">tuple</span>(shape_supp)</span>
<span id="orgb7517e4-111"><a href="#orgb7517e4-111" aria-hidden="true"></a></span>
<span id="orgb7517e4-112"><a href="#orgb7517e4-112" aria-hidden="true"></a>        <span class="co"># if shape is None:</span></span>
<span id="orgb7517e4-113"><a href="#orgb7517e4-113" aria-hidden="true"></a>        <span class="co">#     raise tt.ShapeError()</span></span>
<span id="orgb7517e4-114"><a href="#orgb7517e4-114" aria-hidden="true"></a></span>
<span id="orgb7517e4-115"><a href="#orgb7517e4-115" aria-hidden="true"></a>        <span class="cf">return</span> shape</span>
<span id="orgb7517e4-116"><a href="#orgb7517e4-116" aria-hidden="true"></a></span>
<span id="orgb7517e4-117"><a href="#orgb7517e4-117" aria-hidden="true"></a>    <span class="kw">def</span> compute_bcast(<span class="va">self</span>, dist_params, size):</span>
<span id="orgb7517e4-118"><a href="#orgb7517e4-118" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Compute the broadcast array for this distribution&#39;s `TensorType`.</span></span>
<span id="orgb7517e4-119"><a href="#orgb7517e4-119" aria-hidden="true"></a></span>
<span id="orgb7517e4-120"><a href="#orgb7517e4-120" aria-hidden="true"></a><span class="co">        Parameters</span></span>
<span id="orgb7517e4-121"><a href="#orgb7517e4-121" aria-hidden="true"></a><span class="co">        ==========</span></span>
<span id="orgb7517e4-122"><a href="#orgb7517e4-122" aria-hidden="true"></a><span class="co">        dist_params: list</span></span>
<span id="orgb7517e4-123"><a href="#orgb7517e4-123" aria-hidden="true"></a><span class="co">            Distribution parameters.</span></span>
<span id="orgb7517e4-124"><a href="#orgb7517e4-124" aria-hidden="true"></a><span class="co">        size: int or Iterable (optional)</span></span>
<span id="orgb7517e4-125"><a href="#orgb7517e4-125" aria-hidden="true"></a><span class="co">            Numpy-like size of the output (i.e. replications).</span></span>
<span id="orgb7517e4-126"><a href="#orgb7517e4-126" aria-hidden="true"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="orgb7517e4-127"><a href="#orgb7517e4-127" aria-hidden="true"></a>        shape <span class="op">=</span> <span class="va">self</span>._infer_shape(size, dist_params)</span>
<span id="orgb7517e4-128"><a href="#orgb7517e4-128" aria-hidden="true"></a></span>
<span id="orgb7517e4-129"><a href="#orgb7517e4-129" aria-hidden="true"></a>        <span class="co"># Let&#39;s try to do a better job than `_infer_ndim_bcast` when</span></span>
<span id="orgb7517e4-130"><a href="#orgb7517e4-130" aria-hidden="true"></a>        <span class="co"># dimension sizes are symbolic.</span></span>
<span id="orgb7517e4-131"><a href="#orgb7517e4-131" aria-hidden="true"></a>        bcast <span class="op">=</span> []</span>
<span id="orgb7517e4-132"><a href="#orgb7517e4-132" aria-hidden="true"></a>        <span class="cf">for</span> s <span class="kw">in</span> shape:</span>
<span id="orgb7517e4-133"><a href="#orgb7517e4-133" aria-hidden="true"></a>            <span class="cf">try</span>:</span>
<span id="orgb7517e4-134"><a href="#orgb7517e4-134" aria-hidden="true"></a>                <span class="cf">if</span> <span class="bu">isinstance</span>(s.owner.op, tt.Subtensor) <span class="kw">and</span> <span class="op">\</span></span>
<span id="orgb7517e4-135"><a href="#orgb7517e4-135" aria-hidden="true"></a>                   s.owner.inputs[<span class="dv">0</span>].owner <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="orgb7517e4-136"><a href="#orgb7517e4-136" aria-hidden="true"></a>                    <span class="co"># Handle a special case in which</span></span>
<span id="orgb7517e4-137"><a href="#orgb7517e4-137" aria-hidden="true"></a>                    <span class="co"># `tensor.get_scalar_constant_value` doesn&#39;t really work.</span></span>
<span id="orgb7517e4-138"><a href="#orgb7517e4-138" aria-hidden="true"></a>                    s_x, s_idx <span class="op">=</span> s.owner.inputs</span>
<span id="orgb7517e4-139"><a href="#orgb7517e4-139" aria-hidden="true"></a>                    s_idx <span class="op">=</span> tt.get_scalar_constant_value(s_idx)</span>
<span id="orgb7517e4-140"><a href="#orgb7517e4-140" aria-hidden="true"></a>                    <span class="cf">if</span> <span class="bu">isinstance</span>(s_x.owner.op, tt.Shape):</span>
<span id="orgb7517e4-141"><a href="#orgb7517e4-141" aria-hidden="true"></a>                        x_obj, <span class="op">=</span> s_x.owner.inputs</span>
<span id="orgb7517e4-142"><a href="#orgb7517e4-142" aria-hidden="true"></a>                        s_val <span class="op">=</span> x_obj.<span class="bu">type</span>.broadcastable[s_idx]</span>
<span id="orgb7517e4-143"><a href="#orgb7517e4-143" aria-hidden="true"></a>                    <span class="cf">else</span>:</span>
<span id="orgb7517e4-144"><a href="#orgb7517e4-144" aria-hidden="true"></a>                        <span class="co"># </span><span class="al">TODO</span><span class="co">: Could go for an existing broadcastable here, too, no?</span></span>
<span id="orgb7517e4-145"><a href="#orgb7517e4-145" aria-hidden="true"></a>                        s_val <span class="op">=</span> <span class="va">False</span></span>
<span id="orgb7517e4-146"><a href="#orgb7517e4-146" aria-hidden="true"></a>                <span class="cf">else</span>:</span>
<span id="orgb7517e4-147"><a href="#orgb7517e4-147" aria-hidden="true"></a>                    s_val <span class="op">=</span> tt.get_scalar_constant_value(s)</span>
<span id="orgb7517e4-148"><a href="#orgb7517e4-148" aria-hidden="true"></a>            <span class="cf">except</span> tt.NotScalarConstantError:</span>
<span id="orgb7517e4-149"><a href="#orgb7517e4-149" aria-hidden="true"></a>                s_val <span class="op">=</span> <span class="va">False</span></span>
<span id="orgb7517e4-150"><a href="#orgb7517e4-150" aria-hidden="true"></a></span>
<span id="orgb7517e4-151"><a href="#orgb7517e4-151" aria-hidden="true"></a>            bcast <span class="op">+=</span> [s_val <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="orgb7517e4-152"><a href="#orgb7517e4-152" aria-hidden="true"></a>        <span class="cf">return</span> bcast</span>
<span id="orgb7517e4-153"><a href="#orgb7517e4-153" aria-hidden="true"></a></span>
<span id="orgb7517e4-154"><a href="#orgb7517e4-154" aria-hidden="true"></a>    <span class="kw">def</span> infer_shape(<span class="va">self</span>, node, input_shapes):</span>
<span id="orgb7517e4-155"><a href="#orgb7517e4-155" aria-hidden="true"></a>        size <span class="op">=</span> node.inputs[<span class="op">-</span><span class="dv">2</span>]</span>
<span id="orgb7517e4-156"><a href="#orgb7517e4-156" aria-hidden="true"></a>        dist_params <span class="op">=</span> <span class="bu">tuple</span>(node.inputs[:<span class="op">-</span><span class="dv">2</span>])</span>
<span id="orgb7517e4-157"><a href="#orgb7517e4-157" aria-hidden="true"></a>        shape <span class="op">=</span> <span class="va">self</span>._infer_shape(size, dist_params,</span>
<span id="orgb7517e4-158"><a href="#orgb7517e4-158" aria-hidden="true"></a>                                  param_shapes<span class="op">=</span>input_shapes[:<span class="op">-</span><span class="dv">2</span>])</span>
<span id="orgb7517e4-159"><a href="#orgb7517e4-159" aria-hidden="true"></a></span>
<span id="orgb7517e4-160"><a href="#orgb7517e4-160" aria-hidden="true"></a>        <span class="cf">return</span> [<span class="va">None</span>, [s <span class="cf">for</span> s <span class="kw">in</span> shape]]</span>
<span id="orgb7517e4-161"><a href="#orgb7517e4-161" aria-hidden="true"></a></span>
<span id="orgb7517e4-162"><a href="#orgb7517e4-162" aria-hidden="true"></a>    <span class="kw">def</span> make_node(<span class="va">self</span>, <span class="op">*</span>dist_params, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgb7517e4-163"><a href="#orgb7517e4-163" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Create a random variable node.</span></span>
<span id="orgb7517e4-164"><a href="#orgb7517e4-164" aria-hidden="true"></a></span>
<span id="orgb7517e4-165"><a href="#orgb7517e4-165" aria-hidden="true"></a><span class="co">        XXX: Unnamed/non-keyword arguments are considered distribution</span></span>
<span id="orgb7517e4-166"><a href="#orgb7517e4-166" aria-hidden="true"></a><span class="co">        parameters!  If you want to set `size`, `rng`, and/or `name`, use their</span></span>
<span id="orgb7517e4-167"><a href="#orgb7517e4-167" aria-hidden="true"></a><span class="co">        keywords.</span></span>
<span id="orgb7517e4-168"><a href="#orgb7517e4-168" aria-hidden="true"></a></span>
<span id="orgb7517e4-169"><a href="#orgb7517e4-169" aria-hidden="true"></a><span class="co">        Parameters</span></span>
<span id="orgb7517e4-170"><a href="#orgb7517e4-170" aria-hidden="true"></a><span class="co">        ==========</span></span>
<span id="orgb7517e4-171"><a href="#orgb7517e4-171" aria-hidden="true"></a><span class="co">        dist_params: list</span></span>
<span id="orgb7517e4-172"><a href="#orgb7517e4-172" aria-hidden="true"></a><span class="co">            Distribution parameters.</span></span>
<span id="orgb7517e4-173"><a href="#orgb7517e4-173" aria-hidden="true"></a><span class="co">        size: int or Iterable (optional)</span></span>
<span id="orgb7517e4-174"><a href="#orgb7517e4-174" aria-hidden="true"></a><span class="co">            Numpy-like size of the output (i.e. replications).</span></span>
<span id="orgb7517e4-175"><a href="#orgb7517e4-175" aria-hidden="true"></a><span class="co">        rng: RandomState (optional)</span></span>
<span id="orgb7517e4-176"><a href="#orgb7517e4-176" aria-hidden="true"></a><span class="co">            Existing Theano `RandomState` object to be used.  Creates a</span></span>
<span id="orgb7517e4-177"><a href="#orgb7517e4-177" aria-hidden="true"></a><span class="co">            new one, if `None`.</span></span>
<span id="orgb7517e4-178"><a href="#orgb7517e4-178" aria-hidden="true"></a><span class="co">        name: str (optional)</span></span>
<span id="orgb7517e4-179"><a href="#orgb7517e4-179" aria-hidden="true"></a><span class="co">            Label for the resulting node.</span></span>
<span id="orgb7517e4-180"><a href="#orgb7517e4-180" aria-hidden="true"></a></span>
<span id="orgb7517e4-181"><a href="#orgb7517e4-181" aria-hidden="true"></a><span class="co">        Results</span></span>
<span id="orgb7517e4-182"><a href="#orgb7517e4-182" aria-hidden="true"></a><span class="co">        =======</span></span>
<span id="orgb7517e4-183"><a href="#orgb7517e4-183" aria-hidden="true"></a><span class="co">        out: `Apply`</span></span>
<span id="orgb7517e4-184"><a href="#orgb7517e4-184" aria-hidden="true"></a><span class="co">            A node with inputs `dist_args + (size, in_rng, name)` and outputs</span></span>
<span id="orgb7517e4-185"><a href="#orgb7517e4-185" aria-hidden="true"></a><span class="co">            `(out_rng, sample_tensorvar)`.</span></span>
<span id="orgb7517e4-186"><a href="#orgb7517e4-186" aria-hidden="true"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="orgb7517e4-187"><a href="#orgb7517e4-187" aria-hidden="true"></a>        <span class="cf">if</span> size <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="orgb7517e4-188"><a href="#orgb7517e4-188" aria-hidden="true"></a>            size <span class="op">=</span> tt.constant([], dtype<span class="op">=</span><span class="st">&#39;int64&#39;</span>)</span>
<span id="orgb7517e4-189"><a href="#orgb7517e4-189" aria-hidden="true"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(size, <span class="bu">int</span>):</span>
<span id="orgb7517e4-190"><a href="#orgb7517e4-190" aria-hidden="true"></a>            size <span class="op">=</span> tt.as_tensor_variable([size], ndim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="orgb7517e4-191"><a href="#orgb7517e4-191" aria-hidden="true"></a>        <span class="cf">elif</span> <span class="kw">not</span> <span class="bu">isinstance</span>(size, Iterable):</span>
<span id="orgb7517e4-192"><a href="#orgb7517e4-192" aria-hidden="true"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&#39;Parameter size must be None, int, or an iterable with ints.&#39;</span>)</span>
<span id="orgb7517e4-193"><a href="#orgb7517e4-193" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="orgb7517e4-194"><a href="#orgb7517e4-194" aria-hidden="true"></a>            size <span class="op">=</span> tt.as_tensor_variable(size, ndim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="orgb7517e4-195"><a href="#orgb7517e4-195" aria-hidden="true"></a></span>
<span id="orgb7517e4-196"><a href="#orgb7517e4-196" aria-hidden="true"></a>        <span class="cf">assert</span> size.dtype <span class="kw">in</span> tt.int_dtypes</span>
<span id="orgb7517e4-197"><a href="#orgb7517e4-197" aria-hidden="true"></a></span>
<span id="orgb7517e4-198"><a href="#orgb7517e4-198" aria-hidden="true"></a>        dist_params <span class="op">=</span> <span class="bu">tuple</span>(tt.as_tensor_variable(p)</span>
<span id="orgb7517e4-199"><a href="#orgb7517e4-199" aria-hidden="true"></a>                            <span class="cf">for</span> p <span class="kw">in</span> dist_params)</span>
<span id="orgb7517e4-200"><a href="#orgb7517e4-200" aria-hidden="true"></a></span>
<span id="orgb7517e4-201"><a href="#orgb7517e4-201" aria-hidden="true"></a>        <span class="cf">if</span> rng <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="orgb7517e4-202"><a href="#orgb7517e4-202" aria-hidden="true"></a>            rng <span class="op">=</span> theano.shared(np.random.RandomState())</span>
<span id="orgb7517e4-203"><a href="#orgb7517e4-203" aria-hidden="true"></a>        <span class="cf">elif</span> <span class="kw">not</span> <span class="bu">isinstance</span>(rng.<span class="bu">type</span>, RandomStateType):</span>
<span id="orgb7517e4-204"><a href="#orgb7517e4-204" aria-hidden="true"></a>            warn(<span class="st">&#39;The type of rng should be an instance of RandomStateType&#39;</span>)</span>
<span id="orgb7517e4-205"><a href="#orgb7517e4-205" aria-hidden="true"></a></span>
<span id="orgb7517e4-206"><a href="#orgb7517e4-206" aria-hidden="true"></a>        bcast <span class="op">=</span> <span class="va">self</span>.compute_bcast(dist_params, size)</span>
<span id="orgb7517e4-207"><a href="#orgb7517e4-207" aria-hidden="true"></a></span>
<span id="orgb7517e4-208"><a href="#orgb7517e4-208" aria-hidden="true"></a>        <span class="co"># dtype = tt.scal.upcast(self.dtype, *[p.dtype for p in dist_params])</span></span>
<span id="orgb7517e4-209"><a href="#orgb7517e4-209" aria-hidden="true"></a></span>
<span id="orgb7517e4-210"><a href="#orgb7517e4-210" aria-hidden="true"></a>        outtype <span class="op">=</span> tt.TensorType(dtype<span class="op">=</span><span class="va">self</span>.dtype, broadcastable<span class="op">=</span>bcast)</span>
<span id="orgb7517e4-211"><a href="#orgb7517e4-211" aria-hidden="true"></a>        out_var <span class="op">=</span> outtype(name<span class="op">=</span>name)</span>
<span id="orgb7517e4-212"><a href="#orgb7517e4-212" aria-hidden="true"></a>        inputs <span class="op">=</span> dist_params <span class="op">+</span> (size, rng)</span>
<span id="orgb7517e4-213"><a href="#orgb7517e4-213" aria-hidden="true"></a>        outputs <span class="op">=</span> (rng.<span class="bu">type</span>(), out_var)</span>
<span id="orgb7517e4-214"><a href="#orgb7517e4-214" aria-hidden="true"></a></span>
<span id="orgb7517e4-215"><a href="#orgb7517e4-215" aria-hidden="true"></a>        <span class="cf">return</span> theano.gof.Apply(<span class="va">self</span>, inputs, outputs)</span>
<span id="orgb7517e4-216"><a href="#orgb7517e4-216" aria-hidden="true"></a></span>
<span id="orgb7517e4-217"><a href="#orgb7517e4-217" aria-hidden="true"></a>    <span class="kw">def</span> perform(<span class="va">self</span>, node, inputs, outputs):</span>
<span id="orgb7517e4-218"><a href="#orgb7517e4-218" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Draw samples using Numpy/SciPy.&quot;&quot;&quot;</span></span>
<span id="orgb7517e4-219"><a href="#orgb7517e4-219" aria-hidden="true"></a>        rng_out, smpl_out <span class="op">=</span> outputs</span>
<span id="orgb7517e4-220"><a href="#orgb7517e4-220" aria-hidden="true"></a></span>
<span id="orgb7517e4-221"><a href="#orgb7517e4-221" aria-hidden="true"></a>        <span class="co"># Draw from `rng` if `self.inplace` is `True`, and from a copy of `rng`</span></span>
<span id="orgb7517e4-222"><a href="#orgb7517e4-222" aria-hidden="true"></a>        <span class="co"># otherwise.</span></span>
<span id="orgb7517e4-223"><a href="#orgb7517e4-223" aria-hidden="true"></a>        args <span class="op">=</span> <span class="bu">list</span>(inputs)</span>
<span id="orgb7517e4-224"><a href="#orgb7517e4-224" aria-hidden="true"></a>        rng <span class="op">=</span> args.pop()</span>
<span id="orgb7517e4-225"><a href="#orgb7517e4-225" aria-hidden="true"></a>        size <span class="op">=</span> args.pop()</span>
<span id="orgb7517e4-226"><a href="#orgb7517e4-226" aria-hidden="true"></a></span>
<span id="orgb7517e4-227"><a href="#orgb7517e4-227" aria-hidden="true"></a>        <span class="cf">assert</span> <span class="bu">isinstance</span>(rng, np.random.RandomState), (<span class="bu">type</span>(rng), rng)</span>
<span id="orgb7517e4-228"><a href="#orgb7517e4-228" aria-hidden="true"></a></span>
<span id="orgb7517e4-229"><a href="#orgb7517e4-229" aria-hidden="true"></a>        rng_out[<span class="dv">0</span>] <span class="op">=</span> rng</span>
<span id="orgb7517e4-230"><a href="#orgb7517e4-230" aria-hidden="true"></a></span>
<span id="orgb7517e4-231"><a href="#orgb7517e4-231" aria-hidden="true"></a>        <span class="co"># The symbolic output variable corresponding to value produced here.</span></span>
<span id="orgb7517e4-232"><a href="#orgb7517e4-232" aria-hidden="true"></a>        out_var <span class="op">=</span> node.outputs[<span class="dv">1</span>]</span>
<span id="orgb7517e4-233"><a href="#orgb7517e4-233" aria-hidden="true"></a></span>
<span id="orgb7517e4-234"><a href="#orgb7517e4-234" aria-hidden="true"></a>        <span class="co"># If `size == []`, that means no size is enforced, and NumPy is</span></span>
<span id="orgb7517e4-235"><a href="#orgb7517e4-235" aria-hidden="true"></a>        <span class="co"># trusted to draw the appropriate number of samples, NumPy uses</span></span>
<span id="orgb7517e4-236"><a href="#orgb7517e4-236" aria-hidden="true"></a>        <span class="co"># `size=None` to represent that.  Otherwise, NumPy expects a tuple.</span></span>
<span id="orgb7517e4-237"><a href="#orgb7517e4-237" aria-hidden="true"></a>        <span class="cf">if</span> np.size(size) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="orgb7517e4-238"><a href="#orgb7517e4-238" aria-hidden="true"></a>            size <span class="op">=</span> <span class="va">None</span></span>
<span id="orgb7517e4-239"><a href="#orgb7517e4-239" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="orgb7517e4-240"><a href="#orgb7517e4-240" aria-hidden="true"></a>            size <span class="op">=</span> <span class="bu">tuple</span>(size)</span>
<span id="orgb7517e4-241"><a href="#orgb7517e4-241" aria-hidden="true"></a></span>
<span id="orgb7517e4-242"><a href="#orgb7517e4-242" aria-hidden="true"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.inplace:</span>
<span id="orgb7517e4-243"><a href="#orgb7517e4-243" aria-hidden="true"></a>            rng <span class="op">=</span> copy(rng)</span>
<span id="orgb7517e4-244"><a href="#orgb7517e4-244" aria-hidden="true"></a></span>
<span id="orgb7517e4-245"><a href="#orgb7517e4-245" aria-hidden="true"></a>        smpl_val <span class="op">=</span> <span class="va">self</span>.rng_fn(rng, <span class="op">*</span>(args <span class="op">+</span> [size]))</span>
<span id="orgb7517e4-246"><a href="#orgb7517e4-246" aria-hidden="true"></a></span>
<span id="orgb7517e4-247"><a href="#orgb7517e4-247" aria-hidden="true"></a>        <span class="cf">if</span> (<span class="kw">not</span> <span class="bu">isinstance</span>(smpl_val, np.ndarray) <span class="kw">or</span></span>
<span id="orgb7517e4-248"><a href="#orgb7517e4-248" aria-hidden="true"></a>            <span class="bu">str</span>(smpl_val.dtype) <span class="op">!=</span> out_var.<span class="bu">type</span>.dtype):</span>
<span id="orgb7517e4-249"><a href="#orgb7517e4-249" aria-hidden="true"></a>            smpl_val <span class="op">=</span> theano._asarray(smpl_val, dtype<span class="op">=</span>out_var.<span class="bu">type</span>.dtype)</span>
<span id="orgb7517e4-250"><a href="#orgb7517e4-250" aria-hidden="true"></a></span>
<span id="orgb7517e4-251"><a href="#orgb7517e4-251" aria-hidden="true"></a>        <span class="co"># When `size` is `None`, NumPy has a tendency to unexpectedly</span></span>
<span id="orgb7517e4-252"><a href="#orgb7517e4-252" aria-hidden="true"></a>        <span class="co"># return a scalar instead of a higher-dimension array containing</span></span>
<span id="orgb7517e4-253"><a href="#orgb7517e4-253" aria-hidden="true"></a>        <span class="co"># only one element. This value should be reshaped</span></span>
<span id="orgb7517e4-254"><a href="#orgb7517e4-254" aria-hidden="true"></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: Really?  Why shouldn&#39;t the output correctly correspond to</span></span>
<span id="orgb7517e4-255"><a href="#orgb7517e4-255" aria-hidden="true"></a>        <span class="co"># the returned NumPy value?  Sounds more like a mis-specification of</span></span>
<span id="orgb7517e4-256"><a href="#orgb7517e4-256" aria-hidden="true"></a>        <span class="co"># the symbolic output variable.</span></span>
<span id="orgb7517e4-257"><a href="#orgb7517e4-257" aria-hidden="true"></a>        <span class="cf">if</span> size <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> smpl_val.ndim <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> out_var.ndim <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="orgb7517e4-258"><a href="#orgb7517e4-258" aria-hidden="true"></a>            smpl_val <span class="op">=</span> smpl_val.reshape([<span class="dv">1</span>] <span class="op">*</span> out_var.ndim)</span>
<span id="orgb7517e4-259"><a href="#orgb7517e4-259" aria-hidden="true"></a></span>
<span id="orgb7517e4-260"><a href="#orgb7517e4-260" aria-hidden="true"></a>        smpl_out[<span class="dv">0</span>] <span class="op">=</span> smpl_val</span>
<span id="orgb7517e4-261"><a href="#orgb7517e4-261" aria-hidden="true"></a></span>
<span id="orgb7517e4-262"><a href="#orgb7517e4-262" aria-hidden="true"></a>    <span class="kw">def</span> grad(<span class="va">self</span>, inputs, outputs):</span>
<span id="orgb7517e4-263"><a href="#orgb7517e4-263" aria-hidden="true"></a>        <span class="cf">return</span> [theano.gradient.grad_undefined(<span class="va">self</span>, k, inp,</span>
<span id="orgb7517e4-264"><a href="#orgb7517e4-264" aria-hidden="true"></a>                                               <span class="st">&#39;No gradient defined through raw random numbers op&#39;</span>)</span>
<span id="orgb7517e4-265"><a href="#orgb7517e4-265" aria-hidden="true"></a>                <span class="cf">for</span> k, inp <span class="kw">in</span> <span class="bu">enumerate</span>(inputs)]</span>
<span id="orgb7517e4-266"><a href="#orgb7517e4-266" aria-hidden="true"></a></span>
<span id="orgb7517e4-267"><a href="#orgb7517e4-267" aria-hidden="true"></a>    <span class="kw">def</span> R_op(<span class="va">self</span>, inputs, eval_points):</span>
<span id="orgb7517e4-268"><a href="#orgb7517e4-268" aria-hidden="true"></a>        <span class="cf">return</span> [<span class="va">None</span> <span class="cf">for</span> i <span class="kw">in</span> eval_points]</span></code></pre></div>
</section>
<section id="using-randomvariable" class="level1">
<h1>Using <code>RandomVariable</code></h1>
<p>In Listing <a href="#orgf494cec">17</a> we create some <code>RandomVariable</code> <code>Op</code>s.</p>
<div class="sourceCode" id="orgf494cec"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgf494cec-1"><a href="#orgf494cec-1" aria-hidden="true"></a><span class="im">import</span> scipy</span>
<span id="orgf494cec-2"><a href="#orgf494cec-2" aria-hidden="true"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="orgf494cec-3"><a href="#orgf494cec-3" aria-hidden="true"></a></span>
<span id="orgf494cec-4"><a href="#orgf494cec-4" aria-hidden="true"></a></span>
<span id="orgf494cec-5"><a href="#orgf494cec-5" aria-hidden="true"></a><span class="co"># Continuous Numpy-generated variates</span></span>
<span id="orgf494cec-6"><a href="#orgf494cec-6" aria-hidden="true"></a><span class="kw">class</span> UniformRVType(RandomVariable):</span>
<span id="orgf494cec-7"><a href="#orgf494cec-7" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="orgf494cec-8"><a href="#orgf494cec-8" aria-hidden="true"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;uniform&#39;</span>, theano.config.floatX, <span class="dv">0</span>, [<span class="dv">0</span>, <span class="dv">0</span>], <span class="st">&#39;uniform&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="orgf494cec-9"><a href="#orgf494cec-9" aria-hidden="true"></a></span>
<span id="orgf494cec-10"><a href="#orgf494cec-10" aria-hidden="true"></a>    <span class="kw">def</span> make_node(<span class="va">self</span>, lower, upper, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgf494cec-11"><a href="#orgf494cec-11" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">super</span>().make_node(lower, upper, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</span>
<span id="orgf494cec-12"><a href="#orgf494cec-12" aria-hidden="true"></a></span>
<span id="orgf494cec-13"><a href="#orgf494cec-13" aria-hidden="true"></a>UniformRV <span class="op">=</span> UniformRVType()</span>
<span id="orgf494cec-14"><a href="#orgf494cec-14" aria-hidden="true"></a></span>
<span id="orgf494cec-15"><a href="#orgf494cec-15" aria-hidden="true"></a></span>
<span id="orgf494cec-16"><a href="#orgf494cec-16" aria-hidden="true"></a><span class="kw">class</span> NormalRVType(RandomVariable):</span>
<span id="orgf494cec-17"><a href="#orgf494cec-17" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="orgf494cec-18"><a href="#orgf494cec-18" aria-hidden="true"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;normal&#39;</span>, theano.config.floatX, <span class="dv">0</span>, [<span class="dv">0</span>, <span class="dv">0</span>], <span class="st">&#39;normal&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="orgf494cec-19"><a href="#orgf494cec-19" aria-hidden="true"></a></span>
<span id="orgf494cec-20"><a href="#orgf494cec-20" aria-hidden="true"></a>    <span class="kw">def</span> make_node(<span class="va">self</span>, mu, sigma, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgf494cec-21"><a href="#orgf494cec-21" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">super</span>().make_node(mu, sigma, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</span>
<span id="orgf494cec-22"><a href="#orgf494cec-22" aria-hidden="true"></a></span>
<span id="orgf494cec-23"><a href="#orgf494cec-23" aria-hidden="true"></a></span>
<span id="orgf494cec-24"><a href="#orgf494cec-24" aria-hidden="true"></a>NormalRV <span class="op">=</span> NormalRVType()</span>
<span id="orgf494cec-25"><a href="#orgf494cec-25" aria-hidden="true"></a></span>
<span id="orgf494cec-26"><a href="#orgf494cec-26" aria-hidden="true"></a></span>
<span id="orgf494cec-27"><a href="#orgf494cec-27" aria-hidden="true"></a><span class="kw">class</span> GammaRVType(RandomVariable):</span>
<span id="orgf494cec-28"><a href="#orgf494cec-28" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="orgf494cec-29"><a href="#orgf494cec-29" aria-hidden="true"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;gamma&#39;</span>, theano.config.floatX, <span class="dv">0</span>, [<span class="dv">0</span>, <span class="dv">0</span>], <span class="st">&#39;gamma&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="orgf494cec-30"><a href="#orgf494cec-30" aria-hidden="true"></a></span>
<span id="orgf494cec-31"><a href="#orgf494cec-31" aria-hidden="true"></a>    <span class="kw">def</span> make_node(<span class="va">self</span>, shape, scale, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgf494cec-32"><a href="#orgf494cec-32" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">super</span>().make_node(shape, scale, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</span>
<span id="orgf494cec-33"><a href="#orgf494cec-33" aria-hidden="true"></a></span>
<span id="orgf494cec-34"><a href="#orgf494cec-34" aria-hidden="true"></a></span>
<span id="orgf494cec-35"><a href="#orgf494cec-35" aria-hidden="true"></a>GammaRV <span class="op">=</span> GammaRVType()</span>
<span id="orgf494cec-36"><a href="#orgf494cec-36" aria-hidden="true"></a></span>
<span id="orgf494cec-37"><a href="#orgf494cec-37" aria-hidden="true"></a></span>
<span id="orgf494cec-38"><a href="#orgf494cec-38" aria-hidden="true"></a><span class="kw">class</span> ExponentialRVType(RandomVariable):</span>
<span id="orgf494cec-39"><a href="#orgf494cec-39" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="orgf494cec-40"><a href="#orgf494cec-40" aria-hidden="true"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;exponential&#39;</span>, theano.config.floatX, <span class="dv">0</span>, [<span class="dv">0</span>], <span class="st">&#39;exponential&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="orgf494cec-41"><a href="#orgf494cec-41" aria-hidden="true"></a></span>
<span id="orgf494cec-42"><a href="#orgf494cec-42" aria-hidden="true"></a>    <span class="kw">def</span> make_node(<span class="va">self</span>, scale, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgf494cec-43"><a href="#orgf494cec-43" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">super</span>().make_node(scale, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</span>
<span id="orgf494cec-44"><a href="#orgf494cec-44" aria-hidden="true"></a></span>
<span id="orgf494cec-45"><a href="#orgf494cec-45" aria-hidden="true"></a></span>
<span id="orgf494cec-46"><a href="#orgf494cec-46" aria-hidden="true"></a>ExponentialRV <span class="op">=</span> ExponentialRVType()</span>
<span id="orgf494cec-47"><a href="#orgf494cec-47" aria-hidden="true"></a></span>
<span id="orgf494cec-48"><a href="#orgf494cec-48" aria-hidden="true"></a></span>
<span id="orgf494cec-49"><a href="#orgf494cec-49" aria-hidden="true"></a><span class="co"># One with multivariate support</span></span>
<span id="orgf494cec-50"><a href="#orgf494cec-50" aria-hidden="true"></a><span class="kw">class</span> MvNormalRVType(RandomVariable):</span>
<span id="orgf494cec-51"><a href="#orgf494cec-51" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="orgf494cec-52"><a href="#orgf494cec-52" aria-hidden="true"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;multivariate_normal&#39;</span>, theano.config.floatX, <span class="dv">1</span>, [<span class="dv">1</span>, <span class="dv">2</span>], <span class="st">&#39;multivariate_normal&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="orgf494cec-53"><a href="#orgf494cec-53" aria-hidden="true"></a></span>
<span id="orgf494cec-54"><a href="#orgf494cec-54" aria-hidden="true"></a>    <span class="kw">def</span> make_node(<span class="va">self</span>, mean, cov, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgf494cec-55"><a href="#orgf494cec-55" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">super</span>().make_node(mean, cov, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</span>
<span id="orgf494cec-56"><a href="#orgf494cec-56" aria-hidden="true"></a></span>
<span id="orgf494cec-57"><a href="#orgf494cec-57" aria-hidden="true"></a></span>
<span id="orgf494cec-58"><a href="#orgf494cec-58" aria-hidden="true"></a>MvNormalRV <span class="op">=</span> MvNormalRVType()</span>
<span id="orgf494cec-59"><a href="#orgf494cec-59" aria-hidden="true"></a></span>
<span id="orgf494cec-60"><a href="#orgf494cec-60" aria-hidden="true"></a></span>
<span id="orgf494cec-61"><a href="#orgf494cec-61" aria-hidden="true"></a><span class="kw">class</span> DirichletRVType(RandomVariable):</span>
<span id="orgf494cec-62"><a href="#orgf494cec-62" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="orgf494cec-63"><a href="#orgf494cec-63" aria-hidden="true"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;dirichlet&#39;</span>, theano.config.floatX, <span class="dv">1</span>, [<span class="dv">1</span>], <span class="st">&#39;dirichlet&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="orgf494cec-64"><a href="#orgf494cec-64" aria-hidden="true"></a></span>
<span id="orgf494cec-65"><a href="#orgf494cec-65" aria-hidden="true"></a>    <span class="kw">def</span> make_node(<span class="va">self</span>, alpha, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgf494cec-66"><a href="#orgf494cec-66" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">super</span>().make_node(alpha, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</span>
<span id="orgf494cec-67"><a href="#orgf494cec-67" aria-hidden="true"></a></span>
<span id="orgf494cec-68"><a href="#orgf494cec-68" aria-hidden="true"></a></span>
<span id="orgf494cec-69"><a href="#orgf494cec-69" aria-hidden="true"></a>DirichletRV <span class="op">=</span> DirichletRVType()</span>
<span id="orgf494cec-70"><a href="#orgf494cec-70" aria-hidden="true"></a></span>
<span id="orgf494cec-71"><a href="#orgf494cec-71" aria-hidden="true"></a></span>
<span id="orgf494cec-72"><a href="#orgf494cec-72" aria-hidden="true"></a><span class="co"># A discrete Numpy-generated variate</span></span>
<span id="orgf494cec-73"><a href="#orgf494cec-73" aria-hidden="true"></a><span class="kw">class</span> PoissonRVType(RandomVariable):</span>
<span id="orgf494cec-74"><a href="#orgf494cec-74" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="orgf494cec-75"><a href="#orgf494cec-75" aria-hidden="true"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;poisson&#39;</span>, <span class="st">&#39;int64&#39;</span>, <span class="dv">0</span>, [<span class="dv">0</span>], <span class="st">&#39;poisson&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="orgf494cec-76"><a href="#orgf494cec-76" aria-hidden="true"></a></span>
<span id="orgf494cec-77"><a href="#orgf494cec-77" aria-hidden="true"></a>    <span class="kw">def</span> make_node(<span class="va">self</span>, rate, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgf494cec-78"><a href="#orgf494cec-78" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">super</span>().make_node(rate, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</span>
<span id="orgf494cec-79"><a href="#orgf494cec-79" aria-hidden="true"></a></span>
<span id="orgf494cec-80"><a href="#orgf494cec-80" aria-hidden="true"></a></span>
<span id="orgf494cec-81"><a href="#orgf494cec-81" aria-hidden="true"></a>PoissonRV <span class="op">=</span> PoissonRVType()</span>
<span id="orgf494cec-82"><a href="#orgf494cec-82" aria-hidden="true"></a></span>
<span id="orgf494cec-83"><a href="#orgf494cec-83" aria-hidden="true"></a></span>
<span id="orgf494cec-84"><a href="#orgf494cec-84" aria-hidden="true"></a><span class="co"># A SciPy-generated variate</span></span>
<span id="orgf494cec-85"><a href="#orgf494cec-85" aria-hidden="true"></a><span class="kw">class</span> CauchyRVType(RandomVariable):</span>
<span id="orgf494cec-86"><a href="#orgf494cec-86" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="orgf494cec-87"><a href="#orgf494cec-87" aria-hidden="true"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;cauchy&#39;</span>, theano.config.floatX, <span class="dv">0</span>, [<span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="orgf494cec-88"><a href="#orgf494cec-88" aria-hidden="true"></a>                         <span class="kw">lambda</span> rng, <span class="op">*</span>args: scipy.stats.cauchy.rvs(<span class="op">*</span>args, random_state<span class="op">=</span>rng),</span>
<span id="orgf494cec-89"><a href="#orgf494cec-89" aria-hidden="true"></a>                         inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="orgf494cec-90"><a href="#orgf494cec-90" aria-hidden="true"></a></span>
<span id="orgf494cec-91"><a href="#orgf494cec-91" aria-hidden="true"></a>    <span class="kw">def</span> make_node(<span class="va">self</span>, loc, scale, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgf494cec-92"><a href="#orgf494cec-92" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">super</span>().make_node(loc, scale, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</span>
<span id="orgf494cec-93"><a href="#orgf494cec-93" aria-hidden="true"></a></span>
<span id="orgf494cec-94"><a href="#orgf494cec-94" aria-hidden="true"></a></span>
<span id="orgf494cec-95"><a href="#orgf494cec-95" aria-hidden="true"></a>CauchyRV <span class="op">=</span> CauchyRVType()</span>
<span id="orgf494cec-96"><a href="#orgf494cec-96" aria-hidden="true"></a></span>
<span id="orgf494cec-97"><a href="#orgf494cec-97" aria-hidden="true"></a></span>
<span id="orgf494cec-98"><a href="#orgf494cec-98" aria-hidden="true"></a><span class="co"># Support shape is determined by the first dimension in the *second* parameter (i.e.</span></span>
<span id="orgf494cec-99"><a href="#orgf494cec-99" aria-hidden="true"></a><span class="co"># the probabilities vector)</span></span>
<span id="orgf494cec-100"><a href="#orgf494cec-100" aria-hidden="true"></a><span class="kw">class</span> MultinomialRVType(RandomVariable):</span>
<span id="orgf494cec-101"><a href="#orgf494cec-101" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="orgf494cec-102"><a href="#orgf494cec-102" aria-hidden="true"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;multinomial&#39;</span>, <span class="st">&#39;int64&#39;</span>, <span class="dv">1</span>, [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">&#39;multinomial&#39;</span>,</span>
<span id="orgf494cec-103"><a href="#orgf494cec-103" aria-hidden="true"></a>                         supp_shape_fn<span class="op">=</span>partial(param_supp_shape_fn, rep_param_idx<span class="op">=</span><span class="dv">1</span>),</span>
<span id="orgf494cec-104"><a href="#orgf494cec-104" aria-hidden="true"></a>                         inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="orgf494cec-105"><a href="#orgf494cec-105" aria-hidden="true"></a></span>
<span id="orgf494cec-106"><a href="#orgf494cec-106" aria-hidden="true"></a>    <span class="kw">def</span> make_node(<span class="va">self</span>, n, pvals, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgf494cec-107"><a href="#orgf494cec-107" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">super</span>().make_node(n, pvals, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</span>
<span id="orgf494cec-108"><a href="#orgf494cec-108" aria-hidden="true"></a></span>
<span id="orgf494cec-109"><a href="#orgf494cec-109" aria-hidden="true"></a></span>
<span id="orgf494cec-110"><a href="#orgf494cec-110" aria-hidden="true"></a>MultinomialRV <span class="op">=</span> MultinomialRVType()</span></code></pre></div>
<div class="example" data-markdown="">
<p>In Listing <a href="#orged59f09">18</a> we draw samples from instances of <code>RandomVariable</code>s.</p>
<div class="sourceCode" id="orged59f09"><pre class="sourceCode python"><code class="sourceCode python"><span id="orged59f09-1"><a href="#orged59f09-1" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;UniformRV(0., 30., size=[10]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="orged59f09-2"><a href="#orged59f09-2" aria-hidden="true"></a>    UniformRV(<span class="fl">0.</span>, <span class="fl">30.</span>, size<span class="op">=</span>[<span class="dv">10</span>]).<span class="bu">eval</span>()</span>
<span id="orged59f09-3"><a href="#orged59f09-3" aria-hidden="true"></a>))</span>
<span id="orged59f09-4"><a href="#orged59f09-4" aria-hidden="true"></a></span>
<span id="orged59f09-5"><a href="#orged59f09-5" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;NormalRV([0., 100.], 30, size=[4, 2]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="orged59f09-6"><a href="#orged59f09-6" aria-hidden="true"></a>    NormalRV([<span class="fl">0.</span>, <span class="fl">100.</span>], <span class="dv">30</span>, size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]).<span class="bu">eval</span>()))</span>
<span id="orged59f09-7"><a href="#orged59f09-7" aria-hidden="true"></a></span>
<span id="orged59f09-8"><a href="#orged59f09-8" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;GammaRV([2., 1.], 2., size=[4, 2]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="orged59f09-9"><a href="#orged59f09-9" aria-hidden="true"></a>    GammaRV([<span class="fl">2.</span>, <span class="fl">1.</span>], <span class="fl">2.</span>, size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]).<span class="bu">eval</span>()))</span>
<span id="orged59f09-10"><a href="#orged59f09-10" aria-hidden="true"></a></span>
<span id="orged59f09-11"><a href="#orged59f09-11" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;ExponentialRV([2., 50.], size=[4, 2]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="orged59f09-12"><a href="#orged59f09-12" aria-hidden="true"></a>    ExponentialRV([<span class="fl">2.</span>, <span class="fl">50.</span>], size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]).<span class="bu">eval</span>()))</span>
<span id="orged59f09-13"><a href="#orged59f09-13" aria-hidden="true"></a></span>
<span id="orged59f09-14"><a href="#orged59f09-14" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;MvNormalRV([0, 1e2, 2e3], np.diag([1, 1, 1]), size=[3, 2, 3]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="orged59f09-15"><a href="#orged59f09-15" aria-hidden="true"></a>    MvNormalRV([<span class="dv">0</span>, <span class="fl">1e2</span>, <span class="fl">2e3</span>], np.diag([<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>]), size<span class="op">=</span>[<span class="dv">2</span>, <span class="dv">3</span>]).<span class="bu">eval</span>()))</span>
<span id="orged59f09-16"><a href="#orged59f09-16" aria-hidden="true"></a></span>
<span id="orged59f09-17"><a href="#orged59f09-17" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;DirichletRV([0.1, 10, 0.5], size=[3, 2, 3]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="orged59f09-18"><a href="#orged59f09-18" aria-hidden="true"></a>    DirichletRV([<span class="fl">0.1</span>, <span class="dv">10</span>, <span class="fl">0.5</span>], size<span class="op">=</span>[<span class="dv">2</span>, <span class="dv">3</span>]).<span class="bu">eval</span>()))</span>
<span id="orged59f09-19"><a href="#orged59f09-19" aria-hidden="true"></a></span>
<span id="orged59f09-20"><a href="#orged59f09-20" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;PoissonRV([2., 1.], size=[4, 2]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="orged59f09-21"><a href="#orged59f09-21" aria-hidden="true"></a>    PoissonRV([<span class="fl">2.</span>, <span class="fl">15.</span>], size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]).<span class="bu">eval</span>()))</span>
<span id="orged59f09-22"><a href="#orged59f09-22" aria-hidden="true"></a></span>
<span id="orged59f09-23"><a href="#orged59f09-23" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;CauchyRV([1., 100.], 30, size=[4, 2]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="orged59f09-24"><a href="#orged59f09-24" aria-hidden="true"></a>    CauchyRV([<span class="fl">1.</span>, <span class="fl">100.</span>], <span class="dv">30</span>, size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]).<span class="bu">eval</span>()))</span>
<span id="orged59f09-25"><a href="#orged59f09-25" aria-hidden="true"></a></span>
<span id="orged59f09-26"><a href="#orged59f09-26" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;MultinomialRV(20, [1/6.]*6, size=[6, 2]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="orged59f09-27"><a href="#orged59f09-27" aria-hidden="true"></a>    MultinomialRV(<span class="dv">20</span>, [<span class="dv">1</span> <span class="op">/</span> <span class="fl">6.</span>] <span class="op">*</span> <span class="dv">6</span>, size<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">2</span>]).<span class="bu">eval</span>()))</span></code></pre></div>
<div class="sourceCode" id="orga89dd83"><pre class="sourceCode python"><code class="sourceCode python"><span id="orga89dd83-1"><a href="#orga89dd83-1" aria-hidden="true"></a>UniformRV(<span class="fl">0.</span>, <span class="fl">30.</span>, size<span class="op">=</span>[<span class="dv">10</span>]):</span>
<span id="orga89dd83-2"><a href="#orga89dd83-2" aria-hidden="true"></a>[ <span class="fl">5.83131933</span> <span class="fl">28.56231204</span> <span class="fl">20.73018065</span> <span class="fl">17.21042461</span> <span class="fl">25.53140341</span> <span class="fl">23.76268637</span></span>
<span id="orga89dd83-3"><a href="#orga89dd83-3" aria-hidden="true"></a> <span class="fl">28.27629994</span>  <span class="fl">7.10457399</span> <span class="fl">19.88378878</span> <span class="fl">26.62382369</span>]</span>
<span id="orga89dd83-4"><a href="#orga89dd83-4" aria-hidden="true"></a></span>
<span id="orga89dd83-5"><a href="#orga89dd83-5" aria-hidden="true"></a>NormalRV([<span class="fl">0.</span>, <span class="fl">100.</span>], <span class="dv">30</span>, size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]):</span>
<span id="orga89dd83-6"><a href="#orga89dd83-6" aria-hidden="true"></a>[[  <span class="fl">0.73277898</span>  <span class="fl">98.26041204</span>]</span>
<span id="orga89dd83-7"><a href="#orga89dd83-7" aria-hidden="true"></a> [<span class="op">-</span><span class="fl">25.9810085</span>   <span class="fl">79.13385495</span>]</span>
<span id="orga89dd83-8"><a href="#orga89dd83-8" aria-hidden="true"></a> [<span class="op">-</span><span class="fl">23.17013683</span> <span class="fl">130.86966242</span>]</span>
<span id="orga89dd83-9"><a href="#orga89dd83-9" aria-hidden="true"></a> [<span class="op">-</span><span class="fl">52.83756722</span>  <span class="fl">95.21829178</span>]]</span>
<span id="orga89dd83-10"><a href="#orga89dd83-10" aria-hidden="true"></a></span>
<span id="orga89dd83-11"><a href="#orga89dd83-11" aria-hidden="true"></a>GammaRV([<span class="fl">2.</span>, <span class="fl">1.</span>], <span class="fl">2.</span>, size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]):</span>
<span id="orga89dd83-12"><a href="#orga89dd83-12" aria-hidden="true"></a>[[<span class="fl">5.09679154</span> <span class="fl">0.6149213</span> ]</span>
<span id="orga89dd83-13"><a href="#orga89dd83-13" aria-hidden="true"></a> [<span class="fl">2.64231927</span> <span class="fl">0.7277265</span> ]</span>
<span id="orga89dd83-14"><a href="#orga89dd83-14" aria-hidden="true"></a> [<span class="fl">5.98877316</span> <span class="fl">0.41751667</span>]</span>
<span id="orga89dd83-15"><a href="#orga89dd83-15" aria-hidden="true"></a> [<span class="fl">3.77525439</span> <span class="fl">1.11561567</span>]]</span>
<span id="orga89dd83-16"><a href="#orga89dd83-16" aria-hidden="true"></a></span>
<span id="orga89dd83-17"><a href="#orga89dd83-17" aria-hidden="true"></a>ExponentialRV([<span class="fl">2.</span>, <span class="fl">50.</span>], size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]):</span>
<span id="orga89dd83-18"><a href="#orga89dd83-18" aria-hidden="true"></a>[[ <span class="fl">2.29684191</span>  <span class="fl">7.12084933</span>]</span>
<span id="orga89dd83-19"><a href="#orga89dd83-19" aria-hidden="true"></a> [ <span class="fl">0.39386731</span> <span class="fl">38.79158981</span>]</span>
<span id="orga89dd83-20"><a href="#orga89dd83-20" aria-hidden="true"></a> [ <span class="fl">1.11400165</span>  <span class="fl">4.31175303</span>]</span>
<span id="orga89dd83-21"><a href="#orga89dd83-21" aria-hidden="true"></a> [ <span class="fl">1.50499115</span>  <span class="fl">9.65667649</span>]]</span>
<span id="orga89dd83-22"><a href="#orga89dd83-22" aria-hidden="true"></a></span>
<span id="orga89dd83-23"><a href="#orga89dd83-23" aria-hidden="true"></a>MvNormalRV([<span class="dv">0</span>, <span class="fl">1e2</span>, <span class="fl">2e3</span>], np.diag([<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>]), size<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>]):</span>
<span id="orga89dd83-24"><a href="#orga89dd83-24" aria-hidden="true"></a>[[[<span class="op">-</span><span class="fl">6.67447019e-01</span>  <span class="fl">9.88636435e+01</span>  <span class="fl">1.99973471e+03</span>]</span>
<span id="orga89dd83-25"><a href="#orga89dd83-25" aria-hidden="true"></a>  [ <span class="fl">6.06351715e-01</span>  <span class="fl">9.96429347e+01</span>  <span class="fl">1.99915978e+03</span>]</span>
<span id="orga89dd83-26"><a href="#orga89dd83-26" aria-hidden="true"></a>  [ <span class="fl">1.12246741e+00</span>  <span class="fl">9.96807860e+01</span>  <span class="fl">2.00201859e+03</span>]]</span>
<span id="orga89dd83-27"><a href="#orga89dd83-27" aria-hidden="true"></a></span>
<span id="orga89dd83-28"><a href="#orga89dd83-28" aria-hidden="true"></a> [[ <span class="fl">3.61931404e-02</span>  <span class="fl">9.89907880e+01</span>  <span class="fl">2.00036910e+03</span>]</span>
<span id="orga89dd83-29"><a href="#orga89dd83-29" aria-hidden="true"></a>  [<span class="op">-</span><span class="fl">1.61077330e+00</span>  <span class="fl">1.01905479e+02</span>  <span class="fl">2.00134565e+03</span>]</span>
<span id="orga89dd83-30"><a href="#orga89dd83-30" aria-hidden="true"></a>  [ <span class="fl">9.45854243e-01</span>  <span class="fl">1.00877071e+02</span>  <span class="fl">1.99914438e+03</span>]]]</span>
<span id="orga89dd83-31"><a href="#orga89dd83-31" aria-hidden="true"></a></span>
<span id="orga89dd83-32"><a href="#orga89dd83-32" aria-hidden="true"></a>DirichletRV([<span class="fl">0.1</span>, <span class="dv">10</span>, <span class="fl">0.5</span>], size<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>]):</span>
<span id="orga89dd83-33"><a href="#orga89dd83-33" aria-hidden="true"></a>[[[<span class="fl">1.41863953e-06</span> <span class="fl">9.35392908e-01</span> <span class="fl">6.46056738e-02</span>]</span>
<span id="orga89dd83-34"><a href="#orga89dd83-34" aria-hidden="true"></a>  [<span class="fl">4.50961569e-15</span> <span class="fl">9.71338820e-01</span> <span class="fl">2.86611803e-02</span>]</span>
<span id="orga89dd83-35"><a href="#orga89dd83-35" aria-hidden="true"></a>  [<span class="fl">2.41299980e-05</span> <span class="fl">9.94566812e-01</span> <span class="fl">5.40905817e-03</span>]]</span>
<span id="orga89dd83-36"><a href="#orga89dd83-36" aria-hidden="true"></a></span>
<span id="orga89dd83-37"><a href="#orga89dd83-37" aria-hidden="true"></a> [[<span class="fl">5.79850503e-08</span> <span class="fl">9.73090671e-01</span> <span class="fl">2.69092713e-02</span>]</span>
<span id="orga89dd83-38"><a href="#orga89dd83-38" aria-hidden="true"></a>  [<span class="fl">4.17758767e-09</span> <span class="fl">9.61671733e-01</span> <span class="fl">3.83282630e-02</span>]</span>
<span id="orga89dd83-39"><a href="#orga89dd83-39" aria-hidden="true"></a>  [<span class="fl">8.78921782e-03</span> <span class="fl">9.54146972e-01</span> <span class="fl">3.70638103e-02</span>]]]</span>
<span id="orga89dd83-40"><a href="#orga89dd83-40" aria-hidden="true"></a></span>
<span id="orga89dd83-41"><a href="#orga89dd83-41" aria-hidden="true"></a>PoissonRV([<span class="fl">2.</span>, <span class="fl">1.</span>], size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]):</span>
<span id="orga89dd83-42"><a href="#orga89dd83-42" aria-hidden="true"></a>[[ <span class="dv">1</span> <span class="dv">15</span>]</span>
<span id="orga89dd83-43"><a href="#orga89dd83-43" aria-hidden="true"></a> [ <span class="dv">1</span> <span class="dv">12</span>]</span>
<span id="orga89dd83-44"><a href="#orga89dd83-44" aria-hidden="true"></a> [ <span class="dv">2</span> <span class="dv">21</span>]</span>
<span id="orga89dd83-45"><a href="#orga89dd83-45" aria-hidden="true"></a> [ <span class="dv">1</span> <span class="dv">14</span>]]</span>
<span id="orga89dd83-46"><a href="#orga89dd83-46" aria-hidden="true"></a></span>
<span id="orga89dd83-47"><a href="#orga89dd83-47" aria-hidden="true"></a>CauchyRV([<span class="fl">1.</span>, <span class="fl">100.</span>], <span class="dv">30</span>, size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]):</span>
<span id="orga89dd83-48"><a href="#orga89dd83-48" aria-hidden="true"></a>[[ <span class="op">-</span><span class="fl">86.93222925</span>   <span class="fl">79.9758127</span> ]</span>
<span id="orga89dd83-49"><a href="#orga89dd83-49" aria-hidden="true"></a> [  <span class="fl">13.41882831</span> <span class="op">-</span><span class="fl">374.41779179</span>]</span>
<span id="orga89dd83-50"><a href="#orga89dd83-50" aria-hidden="true"></a> [  <span class="fl">75.74505567</span>   <span class="fl">93.2944822</span> ]</span>
<span id="orga89dd83-51"><a href="#orga89dd83-51" aria-hidden="true"></a> [  <span class="fl">30.0824262</span>   <span class="fl">130.40873511</span>]]</span>
<span id="orga89dd83-52"><a href="#orga89dd83-52" aria-hidden="true"></a></span>
<span id="orga89dd83-53"><a href="#orga89dd83-53" aria-hidden="true"></a>MultinomialRV(<span class="dv">20</span>, [<span class="dv">1</span><span class="op">/</span><span class="fl">6.</span>]<span class="op">*</span><span class="dv">6</span>, size<span class="op">=</span>[<span class="dv">6</span>, <span class="dv">2</span>]):</span>
<span id="orga89dd83-54"><a href="#orga89dd83-54" aria-hidden="true"></a>[[[<span class="dv">2</span> <span class="dv">4</span> <span class="dv">4</span> <span class="dv">2</span> <span class="dv">4</span> <span class="dv">4</span>]</span>
<span id="orga89dd83-55"><a href="#orga89dd83-55" aria-hidden="true"></a>  [<span class="dv">2</span> <span class="dv">5</span> <span class="dv">2</span> <span class="dv">4</span> <span class="dv">3</span> <span class="dv">4</span>]]</span>
<span id="orga89dd83-56"><a href="#orga89dd83-56" aria-hidden="true"></a></span>
<span id="orga89dd83-57"><a href="#orga89dd83-57" aria-hidden="true"></a> [[<span class="dv">2</span> <span class="dv">5</span> <span class="dv">6</span> <span class="dv">2</span> <span class="dv">4</span> <span class="dv">1</span>]</span>
<span id="orga89dd83-58"><a href="#orga89dd83-58" aria-hidden="true"></a>  [<span class="dv">0</span> <span class="dv">4</span> <span class="dv">4</span> <span class="dv">3</span> <span class="dv">5</span> <span class="dv">4</span>]]</span>
<span id="orga89dd83-59"><a href="#orga89dd83-59" aria-hidden="true"></a></span>
<span id="orga89dd83-60"><a href="#orga89dd83-60" aria-hidden="true"></a> [[<span class="dv">6</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">4</span> <span class="dv">4</span> <span class="dv">4</span>]</span>
<span id="orga89dd83-61"><a href="#orga89dd83-61" aria-hidden="true"></a>  [<span class="dv">3</span> <span class="dv">4</span> <span class="dv">3</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">5</span>]]]</span>
<span id="orga89dd83-62"><a href="#orga89dd83-62" aria-hidden="true"></a></span></code></pre></div>
</div>
<p>As noted, there are a few long-standing difficulties surrounding the use and determination of shape information in PyMC3. <code>RandomVariable</code> doesn’t suffer the same limitations.</p>
<div class="example" data-markdown="">
<p>In Listing <a href="#org77fdfa2">20</a>, we see that a multivariate normal random variable cannot be created in PyMC3 without explicit shape information.</p>
<div class="sourceCode" id="org77fdfa2"><pre class="sourceCode python"><code class="sourceCode python"><span id="org77fdfa2-1"><a href="#org77fdfa2-1" aria-hidden="true"></a><span class="im">import</span> traceback</span>
<span id="org77fdfa2-2"><a href="#org77fdfa2-2" aria-hidden="true"></a></span>
<span id="org77fdfa2-3"><a href="#org77fdfa2-3" aria-hidden="true"></a>test_mean <span class="op">=</span> tt.vector(<span class="st">&#39;test_mean&#39;</span>)</span>
<span id="org77fdfa2-4"><a href="#org77fdfa2-4" aria-hidden="true"></a>test_cov <span class="op">=</span> tt.matrix(<span class="st">&#39;test_cov&#39;</span>, dtype<span class="op">=</span><span class="st">&#39;int64&#39;</span>)</span>
<span id="org77fdfa2-5"><a href="#org77fdfa2-5" aria-hidden="true"></a></span>
<span id="org77fdfa2-6"><a href="#org77fdfa2-6" aria-hidden="true"></a>test_mean.tag.test_value <span class="op">=</span> np.asarray([<span class="dv">1</span>])</span>
<span id="org77fdfa2-7"><a href="#org77fdfa2-7" aria-hidden="true"></a>test_cov.tag.test_value <span class="op">=</span> np.asarray([[<span class="dv">1</span>]])</span>
<span id="org77fdfa2-8"><a href="#org77fdfa2-8" aria-hidden="true"></a></span>
<span id="org77fdfa2-9"><a href="#org77fdfa2-9" aria-hidden="true"></a><span class="cf">try</span>:</span>
<span id="org77fdfa2-10"><a href="#org77fdfa2-10" aria-hidden="true"></a>  <span class="cf">with</span> pm.Model():</span>
<span id="org77fdfa2-11"><a href="#org77fdfa2-11" aria-hidden="true"></a>    test_rv <span class="op">=</span> pm.MvNormal(<span class="st">&#39;test_rv&#39;</span>, test_mean, test_cov)</span>
<span id="org77fdfa2-12"><a href="#org77fdfa2-12" aria-hidden="true"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="org77fdfa2-13"><a href="#org77fdfa2-13" aria-hidden="true"></a>  <span class="bu">print</span>(<span class="st">&quot;&quot;</span>.join(traceback.format_exception_only(<span class="bu">type</span>(e), e)))</span></code></pre></div>
<div class="sourceCode" id="org9a55c25"><pre class="sourceCode python"><code class="sourceCode python"><span id="org9a55c25-1"><a href="#org9a55c25-1" aria-hidden="true"></a><span class="pp">ValueError</span>: Invalid dimension <span class="cf">for</span> value: <span class="dv">0</span></span>
<span id="org9a55c25-2"><a href="#org9a55c25-2" aria-hidden="true"></a></span></code></pre></div>
<p>As Listing <a href="#orgb7414f6">22</a> demonstrates, the same construction is possible when one specifies an explicit size/shape.</p>
<div class="sourceCode" id="orgb7414f6"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgb7414f6-1"><a href="#orgb7414f6-1" aria-hidden="true"></a><span class="cf">try</span>:</span>
<span id="orgb7414f6-2"><a href="#orgb7414f6-2" aria-hidden="true"></a>  <span class="cf">with</span> pm.Model():</span>
<span id="orgb7414f6-3"><a href="#orgb7414f6-3" aria-hidden="true"></a>    test_rv <span class="op">=</span> pm.MvNormal(<span class="st">&#39;test_rv&#39;</span>, test_mean, test_cov, shape<span class="op">=</span><span class="dv">1</span>)</span>
<span id="orgb7414f6-4"><a href="#orgb7414f6-4" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;test_rv.distribution.shape = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(test_rv.distribution.shape))</span>
<span id="orgb7414f6-5"><a href="#orgb7414f6-5" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;test_rv.tag.test_value = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(test_rv.tag.test_value))</span>
<span id="orgb7414f6-6"><a href="#orgb7414f6-6" aria-hidden="true"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="orgb7414f6-7"><a href="#orgb7414f6-7" aria-hidden="true"></a>  <span class="bu">print</span>(<span class="st">&quot;&quot;</span>.join(traceback.format_exception_only(<span class="bu">type</span>(e), e)))</span></code></pre></div>
<div class="sourceCode" id="orga8cc629"><pre class="sourceCode python"><code class="sourceCode python"><span id="orga8cc629-1"><a href="#orga8cc629-1" aria-hidden="true"></a>test_rv.distribution.shape <span class="op">=</span> [<span class="dv">1</span>]</span>
<span id="orga8cc629-2"><a href="#orga8cc629-2" aria-hidden="true"></a>test_rv.tag.test_value <span class="op">=</span> [<span class="fl">1.</span>]</span>
<span id="orga8cc629-3"><a href="#orga8cc629-3" aria-hidden="true"></a></span></code></pre></div>
</div>
<p>Using <code>RandomVariable</code>, we do not have to specify a shape, nor implement any sampling code outside of <code>RandomVariable.perform</code> to draw random variables and generate valid test values.</p>
<div class="example" data-markdown="">
<p>Listings <a href="#org67b2727">24</a> and <a href="#org56bde38">26</a> demonstrate how easy it is to create dependencies between random variates using <code>RandomVariable</code>, and how sampling and test values are automatic. It uses a multivariate normal as the mean of another multivariate normal.</p>
<div class="sourceCode" id="org67b2727"><pre class="sourceCode python"><code class="sourceCode python"><span id="org67b2727-1"><a href="#org67b2727-1" aria-hidden="true"></a>theano.config.compute_test_value <span class="op">=</span> <span class="st">&#39;ignore&#39;</span></span>
<span id="org67b2727-2"><a href="#org67b2727-2" aria-hidden="true"></a></span>
<span id="org67b2727-3"><a href="#org67b2727-3" aria-hidden="true"></a>mu_tt <span class="op">=</span> tt.vector(<span class="st">&#39;mu&#39;</span>)</span>
<span id="org67b2727-4"><a href="#org67b2727-4" aria-hidden="true"></a>C_tt <span class="op">=</span> tt.matrix(<span class="st">&#39;C&#39;</span>)</span>
<span id="org67b2727-5"><a href="#org67b2727-5" aria-hidden="true"></a>D_tt <span class="op">=</span> tt.matrix(<span class="st">&#39;D&#39;</span>)</span>
<span id="org67b2727-6"><a href="#org67b2727-6" aria-hidden="true"></a></span>
<span id="org67b2727-7"><a href="#org67b2727-7" aria-hidden="true"></a>X_rv <span class="op">=</span> MvNormalRV(mu_tt, C_tt)</span>
<span id="org67b2727-8"><a href="#org67b2727-8" aria-hidden="true"></a>Y_rv <span class="op">=</span> MvNormalRV(X_rv, D_tt)</span>
<span id="org67b2727-9"><a href="#org67b2727-9" aria-hidden="true"></a></span>
<span id="org67b2727-10"><a href="#org67b2727-10" aria-hidden="true"></a><span class="co"># Sample some values under specific parameter values</span></span>
<span id="org67b2727-11"><a href="#org67b2727-11" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="sc">{}</span><span class="st"> ~ X</span><span class="ch">\n</span><span class="sc">{}</span><span class="st"> ~ Y&quot;</span>.<span class="bu">format</span>(</span>
<span id="org67b2727-12"><a href="#org67b2727-12" aria-hidden="true"></a>    X_rv.<span class="bu">eval</span>({mu_tt: [<span class="dv">1</span>, <span class="dv">2</span>], C_tt: np.diag([<span class="dv">1</span>, <span class="dv">2</span>])}),</span>
<span id="org67b2727-13"><a href="#org67b2727-13" aria-hidden="true"></a>    Y_rv.<span class="bu">eval</span>({mu_tt: [<span class="dv">1</span>, <span class="dv">2</span>], C_tt: np.diag([<span class="dv">1</span>, <span class="dv">2</span>]), D_tt: np.diag([<span class="dv">10</span>, <span class="dv">20</span>])})))</span></code></pre></div>
<div class="sourceCode" id="orgd1cac3d"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgd1cac3d-1"><a href="#orgd1cac3d-1" aria-hidden="true"></a>[<span class="op">-</span><span class="fl">1.25047147</span>  <span class="fl">4.87459955</span>] <span class="op">~</span> X</span>
<span id="orgd1cac3d-2"><a href="#orgd1cac3d-2" aria-hidden="true"></a>[ <span class="fl">2.15486205</span> <span class="op">-</span><span class="fl">3.3066946</span> ] <span class="op">~</span> Y</span>
<span id="orgd1cac3d-3"><a href="#orgd1cac3d-3" aria-hidden="true"></a></span></code></pre></div>
<div class="sourceCode" id="org56bde38"><pre class="sourceCode python"><code class="sourceCode python"><span id="org56bde38-1"><a href="#org56bde38-1" aria-hidden="true"></a>theano.config.compute_test_value <span class="op">=</span> <span class="st">&#39;warn&#39;</span></span>
<span id="org56bde38-2"><a href="#org56bde38-2" aria-hidden="true"></a></span>
<span id="org56bde38-3"><a href="#org56bde38-3" aria-hidden="true"></a>mu_tt.tag.test_value <span class="op">=</span> np.array([<span class="dv">0</span>, <span class="dv">30</span>, <span class="dv">40</span>])</span>
<span id="org56bde38-4"><a href="#org56bde38-4" aria-hidden="true"></a>C_tt.tag.test_value <span class="op">=</span> np.diag([<span class="dv">100</span>, <span class="dv">10</span>, <span class="dv">1</span>])</span>
<span id="org56bde38-5"><a href="#org56bde38-5" aria-hidden="true"></a>D_tt.tag.test_value <span class="op">=</span> np.diag([<span class="dv">100</span>, <span class="dv">10</span>, <span class="dv">1</span>])</span>
<span id="org56bde38-6"><a href="#org56bde38-6" aria-hidden="true"></a></span>
<span id="org56bde38-7"><a href="#org56bde38-7" aria-hidden="true"></a>X_rv <span class="op">=</span> MvNormalRV(mu_tt, C_tt)</span>
<span id="org56bde38-8"><a href="#org56bde38-8" aria-hidden="true"></a>Y_rv <span class="op">=</span> MvNormalRV(X_rv, D_tt)</span>
<span id="org56bde38-9"><a href="#org56bde38-9" aria-hidden="true"></a></span>
<span id="org56bde38-10"><a href="#org56bde38-10" aria-hidden="true"></a><span class="co"># Observe the automatically generated test values</span></span>
<span id="org56bde38-11"><a href="#org56bde38-11" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;X test value: </span><span class="sc">{}</span><span class="ch">\n</span><span class="st">Y test value: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="org56bde38-12"><a href="#org56bde38-12" aria-hidden="true"></a>    X_rv.tag.test_value,</span>
<span id="org56bde38-13"><a href="#org56bde38-13" aria-hidden="true"></a>    Y_rv.tag.test_value))</span></code></pre></div>
<div class="sourceCode" id="orgecacfb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgecacfb5-1"><a href="#orgecacfb5-1" aria-hidden="true"></a>X test value: [ <span class="fl">1.78826967</span> <span class="fl">28.73266332</span> <span class="fl">38.57297111</span>]</span>
<span id="orgecacfb5-2"><a href="#orgecacfb5-2" aria-hidden="true"></a>Y test value: [<span class="fl">33.93703352</span> <span class="fl">27.48925582</span> <span class="fl">38.21563854</span>]</span>
<span id="orgecacfb5-3"><a href="#orgecacfb5-3" aria-hidden="true"></a></span></code></pre></div>
</div>
<div class="example" data-markdown="">
<p>In Listing <a href="#orge489ad8">28</a>, we specify the following hierarchical model:</p>
<p><span class="math display">\[\begin{equation*}
  \begin{aligned}
    M &amp;\sim \text{Poisson}\left(10\right)
    \\
    \alpha_i &amp;\sim \text{Uniform}\left(0, 1\right),
    \quad i \in \left\{0, \dots, M\right\}
    \\
    \pi &amp;\sim \text{Dirichlet}\left(\alpha\right)
    \\
    Y &amp;\sim \text{Multinomial}\left(M, \pi\right)
  \end{aligned}
  \;.
\end{equation*}\]</span></p>
<p>This toy model is particularly interesting in how it specifies symbolic dependencies between continuous and discrete distributions and uses random variables to determine the shapes of other random variables.</p>
<div class="sourceCode" id="orge489ad8"><pre class="sourceCode python"><code class="sourceCode python"><span id="orge489ad8-1"><a href="#orge489ad8-1" aria-hidden="true"></a>theano.config.compute_test_value <span class="op">=</span> <span class="st">&#39;ignore&#39;</span></span>
<span id="orge489ad8-2"><a href="#orge489ad8-2" aria-hidden="true"></a>pois_rate <span class="op">=</span> tt.dscalar(<span class="st">&#39;rate&#39;</span>)</span>
<span id="orge489ad8-3"><a href="#orge489ad8-3" aria-hidden="true"></a>test_pois_rv <span class="op">=</span> PoissonRV(pois_rate)</span>
<span id="orge489ad8-4"><a href="#orge489ad8-4" aria-hidden="true"></a>test_alpha <span class="op">=</span> UniformRV(<span class="dv">0</span>, <span class="dv">1</span>, size<span class="op">=</span>test_pois_rv)</span>
<span id="orge489ad8-5"><a href="#orge489ad8-5" aria-hidden="true"></a>test_dirichlet_rv <span class="op">=</span> DirichletRV(test_uniform_rv)</span>
<span id="orge489ad8-6"><a href="#orge489ad8-6" aria-hidden="true"></a>test_multinom_rv <span class="op">=</span> MultinomialRV(test_pois_rv, test_dirichlet_rv)</span>
<span id="orge489ad8-7"><a href="#orge489ad8-7" aria-hidden="true"></a></span>
<span id="orge489ad8-8"><a href="#orge489ad8-8" aria-hidden="true"></a>test_multinom_draw <span class="op">=</span> theano.function(inputs<span class="op">=</span>[], outputs<span class="op">=</span>test_multinom_rv,</span>
<span id="orge489ad8-9"><a href="#orge489ad8-9" aria-hidden="true"></a>                                     givens<span class="op">=</span>{pois_rate: <span class="fl">10.</span>})</span>
<span id="orge489ad8-10"><a href="#orge489ad8-10" aria-hidden="true"></a></span>
<span id="orge489ad8-11"><a href="#orge489ad8-11" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;test_multinom_rv draw 1: </span><span class="sc">{}</span><span class="ch">\n</span><span class="st">test_multinom_rv draw 2: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="orge489ad8-12"><a href="#orge489ad8-12" aria-hidden="true"></a>    test_multinom_draw(), test_multinom_draw()))</span></code></pre></div>
<div class="sourceCode" id="orgff8bd09"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgff8bd09-1"><a href="#orgff8bd09-1" aria-hidden="true"></a>test_multinom_rv draw <span class="dv">1</span>: [<span class="dv">0</span> <span class="dv">2</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">2</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">0</span>]</span>
<span id="orgff8bd09-2"><a href="#orgff8bd09-2" aria-hidden="true"></a>test_multinom_rv draw <span class="dv">2</span>: [<span class="dv">5</span> <span class="dv">2</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>]</span>
<span id="orgff8bd09-3"><a href="#orgff8bd09-3" aria-hidden="true"></a></span></code></pre></div>
</div>
<section id="random-variable-pretty-printing" class="level2">
<h2>Random Variable Pretty Printing</h2>
<p>In Listing <a href="#org52ecc27">30</a>, we implement a pretty printer that produces more readable forms of Theano graphs containing <code>RandomVariable</code> nodes.</p>
<div class="sourceCode" id="org52ecc27"><pre class="sourceCode python"><code class="sourceCode python"><span id="org52ecc27-1"><a href="#org52ecc27-1" aria-hidden="true"></a><span class="kw">class</span> RandomVariablePrinter:</span>
<span id="org52ecc27-2"><a href="#org52ecc27-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Pretty print random variables.</span></span>
<span id="org52ecc27-3"><a href="#org52ecc27-3" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="org52ecc27-4"><a href="#org52ecc27-4" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name<span class="op">=</span><span class="va">None</span>):</span>
<span id="org52ecc27-5"><a href="#org52ecc27-5" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="org52ecc27-6"><a href="#org52ecc27-6" aria-hidden="true"></a><span class="co">        Parameters</span></span>
<span id="org52ecc27-7"><a href="#org52ecc27-7" aria-hidden="true"></a><span class="co">        ==========</span></span>
<span id="org52ecc27-8"><a href="#org52ecc27-8" aria-hidden="true"></a><span class="co">        name: str (optional)</span></span>
<span id="org52ecc27-9"><a href="#org52ecc27-9" aria-hidden="true"></a><span class="co">            A fixed name to use for the random variables printed by this</span></span>
<span id="org52ecc27-10"><a href="#org52ecc27-10" aria-hidden="true"></a><span class="co">            printer.  If not specified, use `RandomVariable.name`.</span></span>
<span id="org52ecc27-11"><a href="#org52ecc27-11" aria-hidden="true"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="org52ecc27-12"><a href="#org52ecc27-12" aria-hidden="true"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="org52ecc27-13"><a href="#org52ecc27-13" aria-hidden="true"></a></span>
<span id="org52ecc27-14"><a href="#org52ecc27-14" aria-hidden="true"></a>    <span class="kw">def</span> process_param(<span class="va">self</span>, idx, sform, pstate):</span>
<span id="org52ecc27-15"><a href="#org52ecc27-15" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;Special per-parameter post-formatting.</span></span>
<span id="org52ecc27-16"><a href="#org52ecc27-16" aria-hidden="true"></a></span>
<span id="org52ecc27-17"><a href="#org52ecc27-17" aria-hidden="true"></a><span class="co">        This can be used, for instance, to change a std. dev. into a variance.</span></span>
<span id="org52ecc27-18"><a href="#org52ecc27-18" aria-hidden="true"></a></span>
<span id="org52ecc27-19"><a href="#org52ecc27-19" aria-hidden="true"></a><span class="co">        Parameters</span></span>
<span id="org52ecc27-20"><a href="#org52ecc27-20" aria-hidden="true"></a><span class="co">        ==========</span></span>
<span id="org52ecc27-21"><a href="#org52ecc27-21" aria-hidden="true"></a><span class="co">        idx: int</span></span>
<span id="org52ecc27-22"><a href="#org52ecc27-22" aria-hidden="true"></a><span class="co">            The index value of the parameter.</span></span>
<span id="org52ecc27-23"><a href="#org52ecc27-23" aria-hidden="true"></a><span class="co">        sform: str</span></span>
<span id="org52ecc27-24"><a href="#org52ecc27-24" aria-hidden="true"></a><span class="co">            The pre-formatted string form of the parameter.</span></span>
<span id="org52ecc27-25"><a href="#org52ecc27-25" aria-hidden="true"></a><span class="co">        pstate: object</span></span>
<span id="org52ecc27-26"><a href="#org52ecc27-26" aria-hidden="true"></a><span class="co">            The printer state.</span></span>
<span id="org52ecc27-27"><a href="#org52ecc27-27" aria-hidden="true"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="org52ecc27-28"><a href="#org52ecc27-28" aria-hidden="true"></a>        <span class="cf">return</span> sform</span>
<span id="org52ecc27-29"><a href="#org52ecc27-29" aria-hidden="true"></a></span>
<span id="org52ecc27-30"><a href="#org52ecc27-30" aria-hidden="true"></a>    <span class="kw">def</span> process(<span class="va">self</span>, output, pstate):</span>
<span id="org52ecc27-31"><a href="#org52ecc27-31" aria-hidden="true"></a>        <span class="cf">if</span> output <span class="kw">in</span> pstate.memo:</span>
<span id="org52ecc27-32"><a href="#org52ecc27-32" aria-hidden="true"></a>            <span class="cf">return</span> pstate.memo[output]</span>
<span id="org52ecc27-33"><a href="#org52ecc27-33" aria-hidden="true"></a></span>
<span id="org52ecc27-34"><a href="#org52ecc27-34" aria-hidden="true"></a>        pprinter <span class="op">=</span> pstate.pprinter</span>
<span id="org52ecc27-35"><a href="#org52ecc27-35" aria-hidden="true"></a>        node <span class="op">=</span> output.owner</span>
<span id="org52ecc27-36"><a href="#org52ecc27-36" aria-hidden="true"></a></span>
<span id="org52ecc27-37"><a href="#org52ecc27-37" aria-hidden="true"></a>        <span class="cf">if</span> node <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="kw">not</span> <span class="bu">isinstance</span>(node.op, RandomVariable):</span>
<span id="org52ecc27-38"><a href="#org52ecc27-38" aria-hidden="true"></a>            <span class="cf">raise</span> <span class="pp">TypeError</span>(<span class="st">&quot;function </span><span class="sc">%s</span><span class="st"> cannot represent a variable that is &quot;</span></span>
<span id="org52ecc27-39"><a href="#org52ecc27-39" aria-hidden="true"></a>                            <span class="st">&quot;not the result of a RandomVariable operation&quot;</span> <span class="op">%</span></span>
<span id="org52ecc27-40"><a href="#org52ecc27-40" aria-hidden="true"></a>                            <span class="va">self</span>.name)</span>
<span id="org52ecc27-41"><a href="#org52ecc27-41" aria-hidden="true"></a></span>
<span id="org52ecc27-42"><a href="#org52ecc27-42" aria-hidden="true"></a>        new_precedence <span class="op">=</span> <span class="op">-</span><span class="dv">1000</span></span>
<span id="org52ecc27-43"><a href="#org52ecc27-43" aria-hidden="true"></a>        <span class="cf">try</span>:</span>
<span id="org52ecc27-44"><a href="#org52ecc27-44" aria-hidden="true"></a>            old_precedence <span class="op">=</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;precedence&#39;</span>, <span class="va">None</span>)</span>
<span id="org52ecc27-45"><a href="#org52ecc27-45" aria-hidden="true"></a>            pstate.precedence <span class="op">=</span> new_precedence</span>
<span id="org52ecc27-46"><a href="#org52ecc27-46" aria-hidden="true"></a>            out_name <span class="op">=</span> VariableWithShapePrinter.process_variable_name(</span>
<span id="org52ecc27-47"><a href="#org52ecc27-47" aria-hidden="true"></a>                output, pstate)</span>
<span id="org52ecc27-48"><a href="#org52ecc27-48" aria-hidden="true"></a>            shape_info_str <span class="op">=</span> VariableWithShapePrinter.process_shape_info(</span>
<span id="org52ecc27-49"><a href="#org52ecc27-49" aria-hidden="true"></a>                output, pstate)</span>
<span id="org52ecc27-50"><a href="#org52ecc27-50" aria-hidden="true"></a>            <span class="cf">if</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;latex&#39;</span>, <span class="va">False</span>):</span>
<span id="org52ecc27-51"><a href="#org52ecc27-51" aria-hidden="true"></a>                dist_format <span class="op">=</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st"> </span><span class="ch">\\</span><span class="st">sim </span><span class="ch">\\</span><span class="st">operatorname{</span><span class="sc">%s</span><span class="st">}</span><span class="ch">\\</span><span class="st">left(</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">right)&quot;</span></span>
<span id="org52ecc27-52"><a href="#org52ecc27-52" aria-hidden="true"></a>                dist_format <span class="op">+=</span> <span class="st">&#39;, </span><span class="ch">\\</span><span class="st">quad </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(shape_info_str)</span>
<span id="org52ecc27-53"><a href="#org52ecc27-53" aria-hidden="true"></a>            <span class="cf">else</span>:</span>
<span id="org52ecc27-54"><a href="#org52ecc27-54" aria-hidden="true"></a>                dist_format <span class="op">=</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st"> ~ </span><span class="sc">%s</span><span class="st">(</span><span class="sc">%s</span><span class="st">)&quot;</span></span>
<span id="org52ecc27-55"><a href="#org52ecc27-55" aria-hidden="true"></a>                dist_format <span class="op">+=</span> <span class="st">&#39;,  </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(shape_info_str)</span>
<span id="org52ecc27-56"><a href="#org52ecc27-56" aria-hidden="true"></a></span>
<span id="org52ecc27-57"><a href="#org52ecc27-57" aria-hidden="true"></a>            op_name <span class="op">=</span> <span class="va">self</span>.name <span class="kw">or</span> node.op.name</span>
<span id="org52ecc27-58"><a href="#org52ecc27-58" aria-hidden="true"></a>            dist_params <span class="op">=</span> node.inputs[:<span class="op">-</span><span class="dv">2</span>]</span>
<span id="org52ecc27-59"><a href="#org52ecc27-59" aria-hidden="true"></a>            formatted_params <span class="op">=</span> [</span>
<span id="org52ecc27-60"><a href="#org52ecc27-60" aria-hidden="true"></a>                <span class="va">self</span>.process_param(i, pprinter.process(p, pstate), pstate)</span>
<span id="org52ecc27-61"><a href="#org52ecc27-61" aria-hidden="true"></a>                <span class="cf">for</span> i, p <span class="kw">in</span> <span class="bu">enumerate</span>(dist_params)</span>
<span id="org52ecc27-62"><a href="#org52ecc27-62" aria-hidden="true"></a>            ]</span>
<span id="org52ecc27-63"><a href="#org52ecc27-63" aria-hidden="true"></a></span>
<span id="org52ecc27-64"><a href="#org52ecc27-64" aria-hidden="true"></a>            dist_params_r <span class="op">=</span> dist_format <span class="op">%</span> (out_name,</span>
<span id="org52ecc27-65"><a href="#org52ecc27-65" aria-hidden="true"></a>                                           op_name,</span>
<span id="org52ecc27-66"><a href="#org52ecc27-66" aria-hidden="true"></a>                                           <span class="st">&quot;, &quot;</span>.join(formatted_params))</span>
<span id="org52ecc27-67"><a href="#org52ecc27-67" aria-hidden="true"></a>        <span class="cf">finally</span>:</span>
<span id="org52ecc27-68"><a href="#org52ecc27-68" aria-hidden="true"></a>            pstate.precedence <span class="op">=</span> old_precedence</span>
<span id="org52ecc27-69"><a href="#org52ecc27-69" aria-hidden="true"></a></span>
<span id="org52ecc27-70"><a href="#org52ecc27-70" aria-hidden="true"></a>        pstate.preamble_lines <span class="op">+=</span> [dist_params_r]</span>
<span id="org52ecc27-71"><a href="#org52ecc27-71" aria-hidden="true"></a>        pstate.memo[output] <span class="op">=</span> out_name</span>
<span id="org52ecc27-72"><a href="#org52ecc27-72" aria-hidden="true"></a></span>
<span id="org52ecc27-73"><a href="#org52ecc27-73" aria-hidden="true"></a>        <span class="cf">return</span> out_name</span></code></pre></div>
<div class="sourceCode" id="org414cfc6"><pre class="sourceCode python"><code class="sourceCode python"><span id="org414cfc6-1"><a href="#org414cfc6-1" aria-hidden="true"></a><span class="im">import</span> string</span>
<span id="org414cfc6-2"><a href="#org414cfc6-2" aria-hidden="true"></a></span>
<span id="org414cfc6-3"><a href="#org414cfc6-3" aria-hidden="true"></a><span class="im">from</span> copy <span class="im">import</span> copy</span>
<span id="org414cfc6-4"><a href="#org414cfc6-4" aria-hidden="true"></a><span class="im">from</span> collections <span class="im">import</span> OrderedDict</span>
<span id="org414cfc6-5"><a href="#org414cfc6-5" aria-hidden="true"></a></span>
<span id="org414cfc6-6"><a href="#org414cfc6-6" aria-hidden="true"></a><span class="im">from</span> sympy <span class="im">import</span> Array <span class="im">as</span> SympyArray</span>
<span id="org414cfc6-7"><a href="#org414cfc6-7" aria-hidden="true"></a><span class="im">from</span> sympy.printing <span class="im">import</span> latex <span class="im">as</span> sympy_latex</span>
<span id="org414cfc6-8"><a href="#org414cfc6-8" aria-hidden="true"></a></span>
<span id="org414cfc6-9"><a href="#org414cfc6-9" aria-hidden="true"></a></span>
<span id="org414cfc6-10"><a href="#org414cfc6-10" aria-hidden="true"></a><span class="kw">class</span> VariableWithShapePrinter:</span>
<span id="org414cfc6-11"><a href="#org414cfc6-11" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Print variable shape info in the preamble and use readable character</span></span>
<span id="org414cfc6-12"><a href="#org414cfc6-12" aria-hidden="true"></a><span class="co">    names for unamed variables.</span></span>
<span id="org414cfc6-13"><a href="#org414cfc6-13" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="org414cfc6-14"><a href="#org414cfc6-14" aria-hidden="true"></a>    available_names <span class="op">=</span> OrderedDict.fromkeys(string.ascii_letters)</span>
<span id="org414cfc6-15"><a href="#org414cfc6-15" aria-hidden="true"></a>    default_printer <span class="op">=</span> theano.printing.default_printer</span>
<span id="org414cfc6-16"><a href="#org414cfc6-16" aria-hidden="true"></a></span>
<span id="org414cfc6-17"><a href="#org414cfc6-17" aria-hidden="true"></a>    <span class="at">@classmethod</span></span>
<span id="org414cfc6-18"><a href="#org414cfc6-18" aria-hidden="true"></a>    <span class="kw">def</span> process(cls, output, pstate):</span>
<span id="org414cfc6-19"><a href="#org414cfc6-19" aria-hidden="true"></a>        <span class="cf">if</span> output <span class="kw">in</span> pstate.memo:</span>
<span id="org414cfc6-20"><a href="#org414cfc6-20" aria-hidden="true"></a>            <span class="cf">return</span> pstate.memo[output]</span>
<span id="org414cfc6-21"><a href="#org414cfc6-21" aria-hidden="true"></a></span>
<span id="org414cfc6-22"><a href="#org414cfc6-22" aria-hidden="true"></a>        using_latex <span class="op">=</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;latex&#39;</span>, <span class="va">False</span>)</span>
<span id="org414cfc6-23"><a href="#org414cfc6-23" aria-hidden="true"></a></span>
<span id="org414cfc6-24"><a href="#org414cfc6-24" aria-hidden="true"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(output, tt.gof.Constant):</span>
<span id="org414cfc6-25"><a href="#org414cfc6-25" aria-hidden="true"></a>            <span class="cf">if</span> output.ndim <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> using_latex:</span>
<span id="org414cfc6-26"><a href="#org414cfc6-26" aria-hidden="true"></a>                out_name <span class="op">=</span> sympy_latex(SympyArray(output.data))</span>
<span id="org414cfc6-27"><a href="#org414cfc6-27" aria-hidden="true"></a>            <span class="cf">else</span>:</span>
<span id="org414cfc6-28"><a href="#org414cfc6-28" aria-hidden="true"></a>                out_name <span class="op">=</span> <span class="bu">str</span>(output.data)</span>
<span id="org414cfc6-29"><a href="#org414cfc6-29" aria-hidden="true"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(output, tt.TensorVariable):</span>
<span id="org414cfc6-30"><a href="#org414cfc6-30" aria-hidden="true"></a>            <span class="co"># Process name and shape</span></span>
<span id="org414cfc6-31"><a href="#org414cfc6-31" aria-hidden="true"></a>            out_name <span class="op">=</span> cls.process_variable_name(output, pstate)</span>
<span id="org414cfc6-32"><a href="#org414cfc6-32" aria-hidden="true"></a>            shape_info <span class="op">=</span> cls.process_shape_info(output, pstate)</span>
<span id="org414cfc6-33"><a href="#org414cfc6-33" aria-hidden="true"></a>            pstate.preamble_lines <span class="op">+=</span> [shape_info]</span>
<span id="org414cfc6-34"><a href="#org414cfc6-34" aria-hidden="true"></a>        <span class="cf">elif</span> output.name:</span>
<span id="org414cfc6-35"><a href="#org414cfc6-35" aria-hidden="true"></a>            out_name <span class="op">=</span> output.name</span>
<span id="org414cfc6-36"><a href="#org414cfc6-36" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="org414cfc6-37"><a href="#org414cfc6-37" aria-hidden="true"></a>            out_name <span class="op">=</span> cls.default_printer.process(output, pstate)</span>
<span id="org414cfc6-38"><a href="#org414cfc6-38" aria-hidden="true"></a></span>
<span id="org414cfc6-39"><a href="#org414cfc6-39" aria-hidden="true"></a>        pstate.memo[output] <span class="op">=</span> out_name</span>
<span id="org414cfc6-40"><a href="#org414cfc6-40" aria-hidden="true"></a>        <span class="cf">return</span> out_name</span>
<span id="org414cfc6-41"><a href="#org414cfc6-41" aria-hidden="true"></a></span>
<span id="org414cfc6-42"><a href="#org414cfc6-42" aria-hidden="true"></a>    <span class="at">@classmethod</span></span>
<span id="org414cfc6-43"><a href="#org414cfc6-43" aria-hidden="true"></a>    <span class="kw">def</span> process_shape_name(cls, output, pstate):</span>
<span id="org414cfc6-44"><a href="#org414cfc6-44" aria-hidden="true"></a>        shape_of_var <span class="op">=</span> output.owner.inputs[<span class="dv">0</span>]</span>
<span id="org414cfc6-45"><a href="#org414cfc6-45" aria-hidden="true"></a>        shape_names <span class="op">=</span> pstate.memo.setdefault(<span class="st">&#39;shape_names&#39;</span>, {})</span>
<span id="org414cfc6-46"><a href="#org414cfc6-46" aria-hidden="true"></a>        out_name <span class="op">=</span> shape_names.setdefault(</span>
<span id="org414cfc6-47"><a href="#org414cfc6-47" aria-hidden="true"></a>            shape_of_var, cls.process_variable_name(output, pstate))</span>
<span id="org414cfc6-48"><a href="#org414cfc6-48" aria-hidden="true"></a>        <span class="cf">return</span> out_name</span>
<span id="org414cfc6-49"><a href="#org414cfc6-49" aria-hidden="true"></a></span>
<span id="org414cfc6-50"><a href="#org414cfc6-50" aria-hidden="true"></a>    <span class="at">@classmethod</span></span>
<span id="org414cfc6-51"><a href="#org414cfc6-51" aria-hidden="true"></a>    <span class="kw">def</span> process_variable_name(cls, output, pstate):</span>
<span id="org414cfc6-52"><a href="#org414cfc6-52" aria-hidden="true"></a>        <span class="cf">if</span> output <span class="kw">in</span> pstate.memo:</span>
<span id="org414cfc6-53"><a href="#org414cfc6-53" aria-hidden="true"></a>            <span class="cf">return</span> pstate.memo[output]</span>
<span id="org414cfc6-54"><a href="#org414cfc6-54" aria-hidden="true"></a></span>
<span id="org414cfc6-55"><a href="#org414cfc6-55" aria-hidden="true"></a>        available_names <span class="op">=</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;available_names&#39;</span>, <span class="va">None</span>)</span>
<span id="org414cfc6-56"><a href="#org414cfc6-56" aria-hidden="true"></a>        <span class="cf">if</span> available_names <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="org414cfc6-57"><a href="#org414cfc6-57" aria-hidden="true"></a>            <span class="co"># Initialize this state&#39;s available names</span></span>
<span id="org414cfc6-58"><a href="#org414cfc6-58" aria-hidden="true"></a>            available_names <span class="op">=</span> copy(cls.available_names)</span>
<span id="org414cfc6-59"><a href="#org414cfc6-59" aria-hidden="true"></a>            fgraph <span class="op">=</span> <span class="bu">getattr</span>(output, <span class="st">&#39;fgraph&#39;</span>, <span class="va">None</span>)</span>
<span id="org414cfc6-60"><a href="#org414cfc6-60" aria-hidden="true"></a>            <span class="cf">if</span> fgraph:</span>
<span id="org414cfc6-61"><a href="#org414cfc6-61" aria-hidden="true"></a>                <span class="co"># Remove known names in the graph.</span></span>
<span id="org414cfc6-62"><a href="#org414cfc6-62" aria-hidden="true"></a>                _ <span class="op">=</span> [available_names.pop(v.name, <span class="va">None</span>)</span>
<span id="org414cfc6-63"><a href="#org414cfc6-63" aria-hidden="true"></a>                     <span class="cf">for</span> v <span class="kw">in</span> fgraph.variables]</span>
<span id="org414cfc6-64"><a href="#org414cfc6-64" aria-hidden="true"></a>            <span class="bu">setattr</span>(pstate, <span class="st">&#39;available_names&#39;</span>, available_names)</span>
<span id="org414cfc6-65"><a href="#org414cfc6-65" aria-hidden="true"></a></span>
<span id="org414cfc6-66"><a href="#org414cfc6-66" aria-hidden="true"></a>        <span class="cf">if</span> output.name:</span>
<span id="org414cfc6-67"><a href="#org414cfc6-67" aria-hidden="true"></a>            <span class="co"># Observed an existing name; remove it.</span></span>
<span id="org414cfc6-68"><a href="#org414cfc6-68" aria-hidden="true"></a>            out_name <span class="op">=</span> output.name</span>
<span id="org414cfc6-69"><a href="#org414cfc6-69" aria-hidden="true"></a>            available_names.pop(out_name, <span class="va">None</span>)</span>
<span id="org414cfc6-70"><a href="#org414cfc6-70" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="org414cfc6-71"><a href="#org414cfc6-71" aria-hidden="true"></a>            <span class="co"># Take an unused name.</span></span>
<span id="org414cfc6-72"><a href="#org414cfc6-72" aria-hidden="true"></a>            out_name, _ <span class="op">=</span> available_names.popitem(last<span class="op">=</span><span class="va">False</span>)</span>
<span id="org414cfc6-73"><a href="#org414cfc6-73" aria-hidden="true"></a></span>
<span id="org414cfc6-74"><a href="#org414cfc6-74" aria-hidden="true"></a>        pstate.memo[output] <span class="op">=</span> out_name</span>
<span id="org414cfc6-75"><a href="#org414cfc6-75" aria-hidden="true"></a>        <span class="cf">return</span> out_name</span>
<span id="org414cfc6-76"><a href="#org414cfc6-76" aria-hidden="true"></a></span>
<span id="org414cfc6-77"><a href="#org414cfc6-77" aria-hidden="true"></a>    <span class="at">@classmethod</span></span>
<span id="org414cfc6-78"><a href="#org414cfc6-78" aria-hidden="true"></a>    <span class="kw">def</span> process_shape_info(cls, output, pstate):</span>
<span id="org414cfc6-79"><a href="#org414cfc6-79" aria-hidden="true"></a>        using_latex <span class="op">=</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;latex&#39;</span>, <span class="va">False</span>)</span>
<span id="org414cfc6-80"><a href="#org414cfc6-80" aria-hidden="true"></a></span>
<span id="org414cfc6-81"><a href="#org414cfc6-81" aria-hidden="true"></a>        <span class="cf">if</span> output.dtype <span class="kw">in</span> tt.int_dtypes:</span>
<span id="org414cfc6-82"><a href="#org414cfc6-82" aria-hidden="true"></a>            sspace_char <span class="op">=</span> <span class="st">&#39;Z&#39;</span></span>
<span id="org414cfc6-83"><a href="#org414cfc6-83" aria-hidden="true"></a>        <span class="cf">elif</span> output.dtype <span class="kw">in</span> tt.uint_dtypes:</span>
<span id="org414cfc6-84"><a href="#org414cfc6-84" aria-hidden="true"></a>            sspace_char <span class="op">=</span> <span class="st">&#39;N&#39;</span></span>
<span id="org414cfc6-85"><a href="#org414cfc6-85" aria-hidden="true"></a>        <span class="cf">elif</span> output.dtype <span class="kw">in</span> tt.float_dtypes:</span>
<span id="org414cfc6-86"><a href="#org414cfc6-86" aria-hidden="true"></a>            sspace_char <span class="op">=</span> <span class="st">&#39;R&#39;</span></span>
<span id="org414cfc6-87"><a href="#org414cfc6-87" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="org414cfc6-88"><a href="#org414cfc6-88" aria-hidden="true"></a>            sspace_char <span class="op">=</span> <span class="st">&#39;?&#39;</span></span>
<span id="org414cfc6-89"><a href="#org414cfc6-89" aria-hidden="true"></a></span>
<span id="org414cfc6-90"><a href="#org414cfc6-90" aria-hidden="true"></a>        fgraph <span class="op">=</span> <span class="bu">getattr</span>(output, <span class="st">&#39;fgraph&#39;</span>, <span class="va">None</span>)</span>
<span id="org414cfc6-91"><a href="#org414cfc6-91" aria-hidden="true"></a>        shape_feature <span class="op">=</span> <span class="va">None</span></span>
<span id="org414cfc6-92"><a href="#org414cfc6-92" aria-hidden="true"></a>        <span class="cf">if</span> fgraph:</span>
<span id="org414cfc6-93"><a href="#org414cfc6-93" aria-hidden="true"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(fgraph, <span class="st">&#39;shape_feature&#39;</span>):</span>
<span id="org414cfc6-94"><a href="#org414cfc6-94" aria-hidden="true"></a>                fgraph.attach_feature(tt.opt.ShapeFeature())</span>
<span id="org414cfc6-95"><a href="#org414cfc6-95" aria-hidden="true"></a>            shape_feature <span class="op">=</span> fgraph.shape_feature</span>
<span id="org414cfc6-96"><a href="#org414cfc6-96" aria-hidden="true"></a></span>
<span id="org414cfc6-97"><a href="#org414cfc6-97" aria-hidden="true"></a>        shape_dims <span class="op">=</span> []</span>
<span id="org414cfc6-98"><a href="#org414cfc6-98" aria-hidden="true"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(output.ndim):</span>
<span id="org414cfc6-99"><a href="#org414cfc6-99" aria-hidden="true"></a>            s_i_out <span class="op">=</span> <span class="va">None</span></span>
<span id="org414cfc6-100"><a href="#org414cfc6-100" aria-hidden="true"></a>            <span class="cf">if</span> using_latex:</span>
<span id="org414cfc6-101"><a href="#org414cfc6-101" aria-hidden="true"></a>                s_i_pat <span class="op">=</span> <span class="st">&#39;{n^{</span><span class="sc">%s}}</span><span class="st">&#39;</span> <span class="op">+</span> (<span class="st">&#39;_{</span><span class="sc">%s</span><span class="st">}&#39;</span> <span class="op">%</span> i)</span>
<span id="org414cfc6-102"><a href="#org414cfc6-102" aria-hidden="true"></a>            <span class="cf">else</span>:</span>
<span id="org414cfc6-103"><a href="#org414cfc6-103" aria-hidden="true"></a>                s_i_pat <span class="op">=</span> <span class="st">&#39;n^</span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">+</span> (<span class="st">&#39;_</span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> i)</span>
<span id="org414cfc6-104"><a href="#org414cfc6-104" aria-hidden="true"></a>            <span class="cf">if</span> shape_feature:</span>
<span id="org414cfc6-105"><a href="#org414cfc6-105" aria-hidden="true"></a>                new_precedence <span class="op">=</span> <span class="op">-</span><span class="dv">1000</span></span>
<span id="org414cfc6-106"><a href="#org414cfc6-106" aria-hidden="true"></a>                <span class="cf">try</span>:</span>
<span id="org414cfc6-107"><a href="#org414cfc6-107" aria-hidden="true"></a>                    old_precedence <span class="op">=</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;precedence&#39;</span>, <span class="va">None</span>)</span>
<span id="org414cfc6-108"><a href="#org414cfc6-108" aria-hidden="true"></a>                    pstate.precedence <span class="op">=</span> new_precedence</span>
<span id="org414cfc6-109"><a href="#org414cfc6-109" aria-hidden="true"></a>                    _s_i_out <span class="op">=</span> shape_feature.get_shape(output, i)</span>
<span id="org414cfc6-110"><a href="#org414cfc6-110" aria-hidden="true"></a>                    <span class="cf">if</span> _s_i_out.owner:</span>
<span id="org414cfc6-111"><a href="#org414cfc6-111" aria-hidden="true"></a>                        <span class="cf">if</span> (<span class="bu">isinstance</span>(_s_i_out.owner.op, tt.Subtensor) <span class="kw">and</span></span>
<span id="org414cfc6-112"><a href="#org414cfc6-112" aria-hidden="true"></a>                            <span class="bu">all</span>(<span class="bu">isinstance</span>(i, tt.Constant)</span>
<span id="org414cfc6-113"><a href="#org414cfc6-113" aria-hidden="true"></a>                                <span class="cf">for</span> i <span class="kw">in</span> _s_i_out.owner.inputs)):</span>
<span id="org414cfc6-114"><a href="#org414cfc6-114" aria-hidden="true"></a>                            s_i_out <span class="op">=</span> <span class="bu">str</span>(_s_i_out.owner.inputs[<span class="dv">0</span>].data[</span>
<span id="org414cfc6-115"><a href="#org414cfc6-115" aria-hidden="true"></a>                                _s_i_out.owner.inputs[<span class="dv">1</span>].data])</span>
<span id="org414cfc6-116"><a href="#org414cfc6-116" aria-hidden="true"></a>                        <span class="cf">elif</span> <span class="kw">not</span> <span class="bu">isinstance</span>(_s_i_out, tt.TensorVariable):</span>
<span id="org414cfc6-117"><a href="#org414cfc6-117" aria-hidden="true"></a>                            s_i_out <span class="op">=</span> pstate.pprinter.process(_s_i_out, pstate)</span>
<span id="org414cfc6-118"><a href="#org414cfc6-118" aria-hidden="true"></a>                <span class="cf">except</span> <span class="pp">KeyError</span>:</span>
<span id="org414cfc6-119"><a href="#org414cfc6-119" aria-hidden="true"></a>                    <span class="cf">pass</span></span>
<span id="org414cfc6-120"><a href="#org414cfc6-120" aria-hidden="true"></a>                <span class="cf">finally</span>:</span>
<span id="org414cfc6-121"><a href="#org414cfc6-121" aria-hidden="true"></a>                    pstate.precedence <span class="op">=</span> old_precedence</span>
<span id="org414cfc6-122"><a href="#org414cfc6-122" aria-hidden="true"></a></span>
<span id="org414cfc6-123"><a href="#org414cfc6-123" aria-hidden="true"></a>            <span class="cf">if</span> <span class="kw">not</span> s_i_out:</span>
<span id="org414cfc6-124"><a href="#org414cfc6-124" aria-hidden="true"></a>                s_i_out <span class="op">=</span> cls.process_variable_name(output, pstate)</span>
<span id="org414cfc6-125"><a href="#org414cfc6-125" aria-hidden="true"></a>                s_i_out <span class="op">=</span> s_i_pat <span class="op">%</span> s_i_out</span>
<span id="org414cfc6-126"><a href="#org414cfc6-126" aria-hidden="true"></a></span>
<span id="org414cfc6-127"><a href="#org414cfc6-127" aria-hidden="true"></a>            shape_dims <span class="op">+=</span> [s_i_out]</span>
<span id="org414cfc6-128"><a href="#org414cfc6-128" aria-hidden="true"></a></span>
<span id="org414cfc6-129"><a href="#org414cfc6-129" aria-hidden="true"></a>        shape_info <span class="op">=</span> cls.process_variable_name(output, pstate)</span>
<span id="org414cfc6-130"><a href="#org414cfc6-130" aria-hidden="true"></a>        <span class="cf">if</span> using_latex:</span>
<span id="org414cfc6-131"><a href="#org414cfc6-131" aria-hidden="true"></a>            shape_info <span class="op">+=</span> <span class="st">&#39; </span><span class="ch">\\</span><span class="st">in </span><span class="ch">\\</span><span class="st">mathbb{</span><span class="sc">%s</span><span class="st">}&#39;</span> <span class="op">%</span> sspace_char</span>
<span id="org414cfc6-132"><a href="#org414cfc6-132" aria-hidden="true"></a>            shape_dims <span class="op">=</span> <span class="st">&#39; </span><span class="ch">\\</span><span class="st">times &#39;</span>.join(shape_dims)</span>
<span id="org414cfc6-133"><a href="#org414cfc6-133" aria-hidden="true"></a>            <span class="cf">if</span> shape_dims:</span>
<span id="org414cfc6-134"><a href="#org414cfc6-134" aria-hidden="true"></a>                shape_info <span class="op">+=</span> <span class="st">&#39;^{</span><span class="sc">%s</span><span class="st">}&#39;</span> <span class="op">%</span> shape_dims</span>
<span id="org414cfc6-135"><a href="#org414cfc6-135" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="org414cfc6-136"><a href="#org414cfc6-136" aria-hidden="true"></a>            shape_info <span class="op">+=</span> <span class="st">&#39; in </span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> sspace_char</span>
<span id="org414cfc6-137"><a href="#org414cfc6-137" aria-hidden="true"></a>            shape_dims <span class="op">=</span> <span class="st">&#39; x &#39;</span>.join(shape_dims)</span>
<span id="org414cfc6-138"><a href="#org414cfc6-138" aria-hidden="true"></a>            <span class="cf">if</span> shape_dims:</span>
<span id="org414cfc6-139"><a href="#org414cfc6-139" aria-hidden="true"></a>                shape_info <span class="op">+=</span> <span class="st">&#39;**(</span><span class="sc">%s</span><span class="st">)&#39;</span> <span class="op">%</span> shape_dims</span>
<span id="org414cfc6-140"><a href="#org414cfc6-140" aria-hidden="true"></a></span>
<span id="org414cfc6-141"><a href="#org414cfc6-141" aria-hidden="true"></a>        <span class="cf">return</span> shape_info</span></code></pre></div>
<div class="sourceCode" id="orgccd5273"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgccd5273-1"><a href="#orgccd5273-1" aria-hidden="true"></a><span class="im">import</span> textwrap</span>
<span id="orgccd5273-2"><a href="#orgccd5273-2" aria-hidden="true"></a></span>
<span id="orgccd5273-3"><a href="#orgccd5273-3" aria-hidden="true"></a></span>
<span id="orgccd5273-4"><a href="#orgccd5273-4" aria-hidden="true"></a><span class="kw">class</span> PreamblePPrinter(theano.printing.PPrinter):</span>
<span id="orgccd5273-5"><a href="#orgccd5273-5" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;Pretty printer that displays a preamble.</span></span>
<span id="orgccd5273-6"><a href="#orgccd5273-6" aria-hidden="true"></a></span>
<span id="orgccd5273-7"><a href="#orgccd5273-7" aria-hidden="true"></a><span class="co">    For example,</span></span>
<span id="orgccd5273-8"><a href="#orgccd5273-8" aria-hidden="true"></a></span>
<span id="orgccd5273-9"><a href="#orgccd5273-9" aria-hidden="true"></a><span class="co">        X ~ N(\mu, \sigma)</span></span>
<span id="orgccd5273-10"><a href="#orgccd5273-10" aria-hidden="true"></a><span class="co">        (b * X)</span></span>
<span id="orgccd5273-11"><a href="#orgccd5273-11" aria-hidden="true"></a></span>
<span id="orgccd5273-12"><a href="#orgccd5273-12" aria-hidden="true"></a><span class="co">    XXX: Not thread-safe!</span></span>
<span id="orgccd5273-13"><a href="#orgccd5273-13" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="orgccd5273-14"><a href="#orgccd5273-14" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="op">*</span>args, pstate_defaults<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs):</span>
<span id="orgccd5273-15"><a href="#orgccd5273-15" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="orgccd5273-16"><a href="#orgccd5273-16" aria-hidden="true"></a><span class="co">        Parameters</span></span>
<span id="orgccd5273-17"><a href="#orgccd5273-17" aria-hidden="true"></a><span class="co">        ==========</span></span>
<span id="orgccd5273-18"><a href="#orgccd5273-18" aria-hidden="true"></a><span class="co">        pstate_defaults: dict (optional)</span></span>
<span id="orgccd5273-19"><a href="#orgccd5273-19" aria-hidden="true"></a><span class="co">            Default printer state parameters.</span></span>
<span id="orgccd5273-20"><a href="#orgccd5273-20" aria-hidden="true"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="orgccd5273-21"><a href="#orgccd5273-21" aria-hidden="true"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="orgccd5273-22"><a href="#orgccd5273-22" aria-hidden="true"></a>        <span class="va">self</span>.pstate_defaults <span class="op">=</span> pstate_defaults <span class="kw">or</span> {}</span>
<span id="orgccd5273-23"><a href="#orgccd5273-23" aria-hidden="true"></a>        <span class="va">self</span>.printers_dict <span class="op">=</span> <span class="bu">dict</span>(tt.pprint.printers_dict)</span>
<span id="orgccd5273-24"><a href="#orgccd5273-24" aria-hidden="true"></a>        <span class="va">self</span>.printers <span class="op">=</span> copy(tt.pprint.printers)</span>
<span id="orgccd5273-25"><a href="#orgccd5273-25" aria-hidden="true"></a>        <span class="va">self</span>._pstate <span class="op">=</span> <span class="va">None</span></span>
<span id="orgccd5273-26"><a href="#orgccd5273-26" aria-hidden="true"></a></span>
<span id="orgccd5273-27"><a href="#orgccd5273-27" aria-hidden="true"></a>    <span class="kw">def</span> create_state(<span class="va">self</span>, pstate):</span>
<span id="orgccd5273-28"><a href="#orgccd5273-28" aria-hidden="true"></a>        <span class="co"># </span><span class="al">FIXME</span><span class="co">: Find all the user-defined node names and make the tag</span></span>
<span id="orgccd5273-29"><a href="#orgccd5273-29" aria-hidden="true"></a>        <span class="co"># generator aware of them.</span></span>
<span id="orgccd5273-30"><a href="#orgccd5273-30" aria-hidden="true"></a>        <span class="cf">if</span> pstate <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="orgccd5273-31"><a href="#orgccd5273-31" aria-hidden="true"></a>            pstate <span class="op">=</span> theano.printing.PrinterState(</span>
<span id="orgccd5273-32"><a href="#orgccd5273-32" aria-hidden="true"></a>                pprinter<span class="op">=</span><span class="va">self</span>,</span>
<span id="orgccd5273-33"><a href="#orgccd5273-33" aria-hidden="true"></a>                preamble_lines<span class="op">=</span>[],</span>
<span id="orgccd5273-34"><a href="#orgccd5273-34" aria-hidden="true"></a>                <span class="op">**</span><span class="va">self</span>.pstate_defaults)</span>
<span id="orgccd5273-35"><a href="#orgccd5273-35" aria-hidden="true"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(pstate, <span class="bu">dict</span>):</span>
<span id="orgccd5273-36"><a href="#orgccd5273-36" aria-hidden="true"></a>            pstate.setdefault(<span class="st">&#39;preamble_lines&#39;</span>, [])</span>
<span id="orgccd5273-37"><a href="#orgccd5273-37" aria-hidden="true"></a>            pstate.update(<span class="va">self</span>.pstate_defaults)</span>
<span id="orgccd5273-38"><a href="#orgccd5273-38" aria-hidden="true"></a>            pstate <span class="op">=</span> theano.printing.PrinterState(pprinter<span class="op">=</span><span class="va">self</span>, <span class="op">**</span>pstate)</span>
<span id="orgccd5273-39"><a href="#orgccd5273-39" aria-hidden="true"></a></span>
<span id="orgccd5273-40"><a href="#orgccd5273-40" aria-hidden="true"></a>        <span class="co"># </span><span class="al">FIXME</span><span class="co">: Good old fashioned circular references...</span></span>
<span id="orgccd5273-41"><a href="#orgccd5273-41" aria-hidden="true"></a>        <span class="co"># We&#39;re doing this so that `self.process` will be called correctly</span></span>
<span id="orgccd5273-42"><a href="#orgccd5273-42" aria-hidden="true"></a>        <span class="co"># accross all code.  (I&#39;m lookin&#39; about you, `DimShufflePrinter`; get</span></span>
<span id="orgccd5273-43"><a href="#orgccd5273-43" aria-hidden="true"></a>        <span class="co"># your act together.)</span></span>
<span id="orgccd5273-44"><a href="#orgccd5273-44" aria-hidden="true"></a>        pstate.pprinter._pstate <span class="op">=</span> pstate</span>
<span id="orgccd5273-45"><a href="#orgccd5273-45" aria-hidden="true"></a></span>
<span id="orgccd5273-46"><a href="#orgccd5273-46" aria-hidden="true"></a>        <span class="cf">return</span> pstate</span>
<span id="orgccd5273-47"><a href="#orgccd5273-47" aria-hidden="true"></a></span>
<span id="orgccd5273-48"><a href="#orgccd5273-48" aria-hidden="true"></a>    <span class="kw">def</span> process(<span class="va">self</span>, r, pstate<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgccd5273-49"><a href="#orgccd5273-49" aria-hidden="true"></a>        pstate <span class="op">=</span> <span class="va">self</span>._pstate</span>
<span id="orgccd5273-50"><a href="#orgccd5273-50" aria-hidden="true"></a>        <span class="cf">assert</span> pstate</span>
<span id="orgccd5273-51"><a href="#orgccd5273-51" aria-hidden="true"></a>        <span class="cf">return</span> <span class="bu">super</span>().process(r, pstate)</span>
<span id="orgccd5273-52"><a href="#orgccd5273-52" aria-hidden="true"></a></span>
<span id="orgccd5273-53"><a href="#orgccd5273-53" aria-hidden="true"></a>    <span class="kw">def</span> process_graph(<span class="va">self</span>, inputs, outputs, updates<span class="op">=</span><span class="va">None</span>,</span>
<span id="orgccd5273-54"><a href="#orgccd5273-54" aria-hidden="true"></a>                      display_inputs<span class="op">=</span><span class="va">False</span>):</span>
<span id="orgccd5273-55"><a href="#orgccd5273-55" aria-hidden="true"></a>        <span class="cf">raise</span> <span class="va">NotImplemented</span>()</span>
<span id="orgccd5273-56"><a href="#orgccd5273-56" aria-hidden="true"></a></span>
<span id="orgccd5273-57"><a href="#orgccd5273-57" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, <span class="op">*</span>args, latex_env<span class="op">=</span><span class="st">&#39;equation&#39;</span>, latex_label<span class="op">=</span><span class="va">None</span>):</span>
<span id="orgccd5273-58"><a href="#orgccd5273-58" aria-hidden="true"></a>        var <span class="op">=</span> args[<span class="dv">0</span>]</span>
<span id="orgccd5273-59"><a href="#orgccd5273-59" aria-hidden="true"></a>        pstate <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(args[<span class="dv">1</span>:]), <span class="va">None</span>)</span>
<span id="orgccd5273-60"><a href="#orgccd5273-60" aria-hidden="true"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(pstate, (theano.printing.PrinterState, <span class="bu">dict</span>)):</span>
<span id="orgccd5273-61"><a href="#orgccd5273-61" aria-hidden="true"></a>            pstate <span class="op">=</span> <span class="va">self</span>.create_state(args[<span class="dv">1</span>])</span>
<span id="orgccd5273-62"><a href="#orgccd5273-62" aria-hidden="true"></a>        <span class="cf">elif</span> pstate <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="orgccd5273-63"><a href="#orgccd5273-63" aria-hidden="true"></a>            pstate <span class="op">=</span> <span class="va">self</span>.create_state(<span class="va">None</span>)</span>
<span id="orgccd5273-64"><a href="#orgccd5273-64" aria-hidden="true"></a>        <span class="co"># else:</span></span>
<span id="orgccd5273-65"><a href="#orgccd5273-65" aria-hidden="true"></a>        <span class="co">#     # XXX: The graph processing doesn&#39;t pass around the printer state!</span></span>
<span id="orgccd5273-66"><a href="#orgccd5273-66" aria-hidden="true"></a>        <span class="co">#     # </span><span class="al">TODO</span><span class="co">: We&#39;ll have to copy the code and fix it...</span></span>
<span id="orgccd5273-67"><a href="#orgccd5273-67" aria-hidden="true"></a>        <span class="co">#     raise NotImplemented(&#39;No preambles for graph printing, yet.&#39;)</span></span>
<span id="orgccd5273-68"><a href="#orgccd5273-68" aria-hidden="true"></a></span>
<span id="orgccd5273-69"><a href="#orgccd5273-69" aria-hidden="true"></a>        <span class="co"># This pretty printer needs more information about shapes and inputs,</span></span>
<span id="orgccd5273-70"><a href="#orgccd5273-70" aria-hidden="true"></a>        <span class="co"># which it gets from a `FunctionGraph`.  Create one, if `var` isn&#39;t</span></span>
<span id="orgccd5273-71"><a href="#orgccd5273-71" aria-hidden="true"></a>        <span class="co"># already assigned one.</span></span>
<span id="orgccd5273-72"><a href="#orgccd5273-72" aria-hidden="true"></a>        fgraph <span class="op">=</span> <span class="bu">getattr</span>(var, <span class="st">&#39;fgraph&#39;</span>, <span class="va">None</span>)</span>
<span id="orgccd5273-73"><a href="#orgccd5273-73" aria-hidden="true"></a>        <span class="cf">if</span> <span class="kw">not</span> fgraph:</span>
<span id="orgccd5273-74"><a href="#orgccd5273-74" aria-hidden="true"></a>            fgraph <span class="op">=</span> tt.gof.fg.FunctionGraph(</span>
<span id="orgccd5273-75"><a href="#orgccd5273-75" aria-hidden="true"></a>                tt.gof.graph.inputs([var]), [var])</span>
<span id="orgccd5273-76"><a href="#orgccd5273-76" aria-hidden="true"></a>            var <span class="op">=</span> fgraph.outputs[<span class="dv">0</span>]</span>
<span id="orgccd5273-77"><a href="#orgccd5273-77" aria-hidden="true"></a></span>
<span id="orgccd5273-78"><a href="#orgccd5273-78" aria-hidden="true"></a>            <span class="co"># Use this to get better shape info</span></span>
<span id="orgccd5273-79"><a href="#orgccd5273-79" aria-hidden="true"></a>            shape_feature <span class="op">=</span> tt.opt.ShapeFeature()</span>
<span id="orgccd5273-80"><a href="#orgccd5273-80" aria-hidden="true"></a>            fgraph.attach_feature(shape_feature)</span>
<span id="orgccd5273-81"><a href="#orgccd5273-81" aria-hidden="true"></a></span>
<span id="orgccd5273-82"><a href="#orgccd5273-82" aria-hidden="true"></a>        body_str <span class="op">=</span> <span class="bu">super</span>().<span class="fu">__call__</span>(var, pstate)</span>
<span id="orgccd5273-83"><a href="#orgccd5273-83" aria-hidden="true"></a></span>
<span id="orgccd5273-84"><a href="#orgccd5273-84" aria-hidden="true"></a>        latex_out <span class="op">=</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;latex&#39;</span>, <span class="va">False</span>)</span>
<span id="orgccd5273-85"><a href="#orgccd5273-85" aria-hidden="true"></a>        <span class="cf">if</span> pstate.preamble_lines <span class="kw">and</span> latex_out:</span>
<span id="orgccd5273-86"><a href="#orgccd5273-86" aria-hidden="true"></a>            preamble_str <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\n\\\\\n</span><span class="st">&quot;</span>.join(pstate.preamble_lines)</span>
<span id="orgccd5273-87"><a href="#orgccd5273-87" aria-hidden="true"></a>            preamble_str <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">begin</span><span class="sc">{gathered}</span><span class="ch">\n</span><span class="sc">%s</span><span class="ch">\n\\</span><span class="st">end</span><span class="sc">{gathered}</span><span class="st">&quot;</span> <span class="op">%</span> (preamble_str)</span>
<span id="orgccd5273-88"><a href="#orgccd5273-88" aria-hidden="true"></a>            res <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\n\\\\\n</span><span class="st">&quot;</span>.join([preamble_str, body_str])</span>
<span id="orgccd5273-89"><a href="#orgccd5273-89" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="orgccd5273-90"><a href="#orgccd5273-90" aria-hidden="true"></a>            res <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(pstate.preamble_lines <span class="op">+</span> [body_str])</span>
<span id="orgccd5273-91"><a href="#orgccd5273-91" aria-hidden="true"></a></span>
<span id="orgccd5273-92"><a href="#orgccd5273-92" aria-hidden="true"></a>        <span class="cf">if</span> latex_out <span class="kw">and</span> latex_env:</span>
<span id="orgccd5273-93"><a href="#orgccd5273-93" aria-hidden="true"></a>            label_out <span class="op">=</span> <span class="ss">f&#39;</span><span class="ch">\\</span><span class="ss">label</span><span class="ch">{{</span><span class="sc">{</span>latex_label<span class="sc">}</span><span class="ss">}}</span><span class="ch">\n</span><span class="ss">&#39;</span> <span class="cf">if</span> latex_label <span class="cf">else</span> <span class="st">&#39;&#39;</span></span>
<span id="orgccd5273-94"><a href="#orgccd5273-94" aria-hidden="true"></a>            res <span class="op">=</span> textwrap.indent(res, <span class="st">&#39;</span><span class="ch">\t\t</span><span class="st">&#39;</span>)</span>
<span id="orgccd5273-95"><a href="#orgccd5273-95" aria-hidden="true"></a>            res <span class="op">=</span> (<span class="ss">f&quot;</span><span class="ch">\\</span><span class="ss">begin</span><span class="ch">{{</span><span class="sc">{</span>latex_env<span class="sc">}</span><span class="ss">}}</span><span class="ch">\n</span><span class="ss">&quot;</span></span>
<span id="orgccd5273-96"><a href="#orgccd5273-96" aria-hidden="true"></a>                   <span class="ss">f&quot;</span><span class="sc">{</span>res<span class="sc">}</span><span class="ch">\n</span><span class="ss">&quot;</span></span>
<span id="orgccd5273-97"><a href="#orgccd5273-97" aria-hidden="true"></a>                   <span class="ss">f&quot;</span><span class="sc">{</span>label_out<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="orgccd5273-98"><a href="#orgccd5273-98" aria-hidden="true"></a>                   <span class="ss">f&quot;</span><span class="ch">\\</span><span class="ss">end</span><span class="ch">{{</span><span class="sc">{</span>latex_env<span class="sc">}</span><span class="ss">}}&quot;</span>)</span>
<span id="orgccd5273-99"><a href="#orgccd5273-99" aria-hidden="true"></a></span>
<span id="orgccd5273-100"><a href="#orgccd5273-100" aria-hidden="true"></a>        <span class="cf">return</span> res</span></code></pre></div>
<div class="sourceCode" id="orgfc82717"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgfc82717-1"><a href="#orgfc82717-1" aria-hidden="true"></a>tt_pprint <span class="op">=</span> PreamblePPrinter()</span>
<span id="orgfc82717-2"><a href="#orgfc82717-2" aria-hidden="true"></a></span>
<span id="orgfc82717-3"><a href="#orgfc82717-3" aria-hidden="true"></a>tt_pprint.assign(<span class="kw">lambda</span> pstate, r: <span class="va">True</span>, VariableWithShapePrinter)</span>
<span id="orgfc82717-4"><a href="#orgfc82717-4" aria-hidden="true"></a>tt_pprint.assign(UniformRV, RandomVariablePrinter(<span class="st">&#39;U&#39;</span>))</span>
<span id="orgfc82717-5"><a href="#orgfc82717-5" aria-hidden="true"></a>tt_pprint.assign(GammaRV, RandomVariablePrinter(<span class="st">&#39;Gamma&#39;</span>))</span>
<span id="orgfc82717-6"><a href="#orgfc82717-6" aria-hidden="true"></a>tt_pprint.assign(ExponentialRV, RandomVariablePrinter(<span class="st">&#39;Exp&#39;</span>))</span>
<span id="orgfc82717-7"><a href="#orgfc82717-7" aria-hidden="true"></a></span>
<span id="orgfc82717-8"><a href="#orgfc82717-8" aria-hidden="true"></a></span>
<span id="orgfc82717-9"><a href="#orgfc82717-9" aria-hidden="true"></a><span class="kw">class</span> NormalRVPrinter(RandomVariablePrinter):</span>
<span id="orgfc82717-10"><a href="#orgfc82717-10" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="orgfc82717-11"><a href="#orgfc82717-11" aria-hidden="true"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;N&#39;</span>)</span>
<span id="orgfc82717-12"><a href="#orgfc82717-12" aria-hidden="true"></a></span>
<span id="orgfc82717-13"><a href="#orgfc82717-13" aria-hidden="true"></a>    <span class="kw">def</span> process_param(<span class="va">self</span>, idx, sform, pstate):</span>
<span id="orgfc82717-14"><a href="#orgfc82717-14" aria-hidden="true"></a>        <span class="cf">if</span> idx <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="orgfc82717-15"><a href="#orgfc82717-15" aria-hidden="true"></a>            <span class="cf">if</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;latex&#39;</span>, <span class="va">False</span>):</span>
<span id="orgfc82717-16"><a href="#orgfc82717-16" aria-hidden="true"></a>                <span class="cf">return</span> <span class="ss">f&#39;</span><span class="ch">{{</span><span class="sc">{</span>sform<span class="sc">}</span><span class="ss">}}^</span><span class="ch">{{</span><span class="ss">2}}&#39;</span></span>
<span id="orgfc82717-17"><a href="#orgfc82717-17" aria-hidden="true"></a>            <span class="cf">else</span>:</span>
<span id="orgfc82717-18"><a href="#orgfc82717-18" aria-hidden="true"></a>                <span class="cf">return</span> <span class="ss">f&#39;</span><span class="sc">{</span>sform<span class="sc">}</span><span class="ss">**2&#39;</span></span>
<span id="orgfc82717-19"><a href="#orgfc82717-19" aria-hidden="true"></a>        <span class="cf">else</span>:</span>
<span id="orgfc82717-20"><a href="#orgfc82717-20" aria-hidden="true"></a>            <span class="cf">return</span> sform</span>
<span id="orgfc82717-21"><a href="#orgfc82717-21" aria-hidden="true"></a></span>
<span id="orgfc82717-22"><a href="#orgfc82717-22" aria-hidden="true"></a>tt_pprint.assign(NormalRV, NormalRVPrinter())</span>
<span id="orgfc82717-23"><a href="#orgfc82717-23" aria-hidden="true"></a>tt_pprint.assign(MvNormalRV, NormalRVPrinter())</span>
<span id="orgfc82717-24"><a href="#orgfc82717-24" aria-hidden="true"></a></span>
<span id="orgfc82717-25"><a href="#orgfc82717-25" aria-hidden="true"></a>tt_pprint.assign(DirichletRV, RandomVariablePrinter(<span class="st">&#39;Dir&#39;</span>))</span>
<span id="orgfc82717-26"><a href="#orgfc82717-26" aria-hidden="true"></a>tt_pprint.assign(PoissonRV, RandomVariablePrinter(<span class="st">&#39;Pois&#39;</span>))</span>
<span id="orgfc82717-27"><a href="#orgfc82717-27" aria-hidden="true"></a>tt_pprint.assign(CauchyRV, RandomVariablePrinter(<span class="st">&#39;C&#39;</span>))</span>
<span id="orgfc82717-28"><a href="#orgfc82717-28" aria-hidden="true"></a>tt_pprint.assign(MultinomialRV, RandomVariablePrinter(<span class="st">&#39;MN&#39;</span>))</span>
<span id="orgfc82717-29"><a href="#orgfc82717-29" aria-hidden="true"></a></span>
<span id="orgfc82717-30"><a href="#orgfc82717-30" aria-hidden="true"></a>tt_tex_pprint <span class="op">=</span> PreamblePPrinter(pstate_defaults<span class="op">=</span>{<span class="st">&#39;latex&#39;</span>: <span class="va">True</span>})</span>
<span id="orgfc82717-31"><a href="#orgfc82717-31" aria-hidden="true"></a>tt_tex_pprint.printers <span class="op">=</span> copy(tt_pprint.printers)</span>
<span id="orgfc82717-32"><a href="#orgfc82717-32" aria-hidden="true"></a>tt_tex_pprint.printers_dict <span class="op">=</span> <span class="bu">dict</span>(tt_pprint.printers_dict)</span>
<span id="orgfc82717-33"><a href="#orgfc82717-33" aria-hidden="true"></a>tt_tex_pprint.assign(tt.mul, theano.printing.OperatorPrinter(<span class="st">&#39;</span><span class="ch">\\</span><span class="st">odot&#39;</span>, <span class="op">-</span><span class="dv">1</span>, <span class="st">&#39;either&#39;</span>))</span>
<span id="orgfc82717-34"><a href="#orgfc82717-34" aria-hidden="true"></a>tt_tex_pprint.assign(tt.true_div, theano.printing.PatternPrinter((<span class="st">&#39;</span><span class="ch">\\</span><span class="st">frac{</span><span class="sc">%(0)s</span><span class="st">}{</span><span class="sc">%(1)s</span><span class="st">}&#39;</span>, <span class="op">-</span><span class="dv">1000</span>)))</span>
<span id="orgfc82717-35"><a href="#orgfc82717-35" aria-hidden="true"></a>tt_tex_pprint.assign(tt.<span class="bu">pow</span>, theano.printing.PatternPrinter((<span class="st">&#39;{</span><span class="sc">%(0)s</span><span class="st">}^{</span><span class="sc">%(1)s</span><span class="st">}&#39;</span>, <span class="op">-</span><span class="dv">1000</span>)))</span></code></pre></div>
<div class="example" data-markdown="">
<p>Listing <a href="#org1ed4a46">35</a>, creates a graph with two random variables and prints the results with the default Theano pretty printer as Equation <span class="math inline">\(\eqref{eq:rv-pprinter-exa}\)</span>.</p>
<div class="sourceCode" id="org0e19f4e"><pre class="sourceCode python"><code class="sourceCode python"><span id="org0e19f4e-1"><a href="#org0e19f4e-1" aria-hidden="true"></a></span>
<span id="org0e19f4e-2"><a href="#org0e19f4e-2" aria-hidden="true"></a></span>
<span id="org0e19f4e-3"><a href="#org0e19f4e-3" aria-hidden="true"></a>tt.config.compute_test_value <span class="op">=</span> <span class="st">&#39;ignore&#39;</span></span>
<span id="org0e19f4e-4"><a href="#org0e19f4e-4" aria-hidden="true"></a></span>
<span id="org0e19f4e-5"><a href="#org0e19f4e-5" aria-hidden="true"></a>Z_tt <span class="op">=</span> UniformRV(tt.scalar(<span class="st">&#39;l_0&#39;</span>), tt.scalar(<span class="st">&#39;l_1&#39;</span>), name<span class="op">=</span><span class="st">&#39;Z&#39;</span>)</span>
<span id="org0e19f4e-6"><a href="#org0e19f4e-6" aria-hidden="true"></a>X_tt <span class="op">=</span> NormalRV(Z_tt, tt.scalar(<span class="st">&#39;\sigma_1&#39;</span>), name<span class="op">=</span><span class="st">&#39;X&#39;</span>)</span>
<span id="org0e19f4e-7"><a href="#org0e19f4e-7" aria-hidden="true"></a>Y_tt <span class="op">=</span> MvNormalRV(tt.vector(<span class="st">&#39;\mu&#39;</span>), tt.abs_(X_tt) <span class="op">*</span> tt.constant(np.diag([<span class="dv">1</span>, <span class="dv">2</span>])), name<span class="op">=</span><span class="st">&#39;Y&#39;</span>)</span>
<span id="org0e19f4e-8"><a href="#org0e19f4e-8" aria-hidden="true"></a></span>
<span id="org0e19f4e-9"><a href="#org0e19f4e-9" aria-hidden="true"></a>W_tt <span class="op">=</span> X_tt <span class="op">*</span> (tt.scalar(<span class="st">&#39;b&#39;</span>) <span class="op">*</span> Y_tt <span class="op">+</span> tt.scalar(<span class="st">&#39;c&#39;</span>))</span></code></pre></div>
<div class="sourceCode" id="org1ed4a46"><pre class="sourceCode python"><code class="sourceCode python"><span id="org1ed4a46-1"><a href="#org1ed4a46-1" aria-hidden="true"></a><span class="bu">print</span>(tt_tex_pprint(W_tt, latex_label<span class="op">=</span><span class="st">&#39;eq:rv-pprinter-exa&#39;</span>))</span></code></pre></div>
<p><span class="math display">\[\begin{equation}
        \begin{gathered}
        l_0 \in \mathbb{R}
        \\
        l_1 \in \mathbb{R}
        \\
        Z \sim \operatorname{U}\left(l_0, l_1\right), \quad Z \in \mathbb{R}
        \\
        \sigma_1 \in \mathbb{R}
        \\
        X \sim \operatorname{N}\left(Z, {\sigma_1}^{2}\right), \quad X \in \mathbb{R}
        \\
        b \in \mathbb{R}
        \\
        \mu \in \mathbb{R}^{{n^{\mu}}_{0}}
        \\
        Y \sim \operatorname{N}\left(\mu, {(|X| \odot \left[\begin{matrix}1 &amp; 0\\0 &amp; 2\end{matrix}\right])}^{2}\right), \quad Y \in \mathbb{R}^{{n^{Y}}_{0}}
        \\
        c \in \mathbb{R}
        \end{gathered}
        \\
        (X \odot ((b \odot Y) + c))
\label{eq:rv-pprinter-exa}
\end{equation}\]</span></p>
</div>
</section>
</section>
<section id="algebraic-manipulations" class="level1">
<h1>Algebraic Manipulations</h1>
<p>With our new <code>RandomVariable</code>, we can alter the replacement patterns used by <code>tt.gof.opt.PatternSub</code> in <a href="#24875a2c31fa7f94ce562adddedc0bf8">Willard, Brandon T. (2018)</a> and implement a slightly better parameter lifting for affine transforms of scalar normal random variables in Listing <a href="#orgc483b75">36</a>.</p>
<div class="sourceCode" id="orgc483b75"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgc483b75-1"><a href="#orgc483b75-1" aria-hidden="true"></a>norm_lift_pats <span class="op">=</span> [</span>
<span id="orgc483b75-2"><a href="#orgc483b75-2" aria-hidden="true"></a>    <span class="co"># Lift element-wise multiplication</span></span>
<span id="orgc483b75-3"><a href="#orgc483b75-3" aria-hidden="true"></a>    tt.gof.opt.PatternSub(</span>
<span id="orgc483b75-4"><a href="#orgc483b75-4" aria-hidden="true"></a>        (tt.mul,</span>
<span id="orgc483b75-5"><a href="#orgc483b75-5" aria-hidden="true"></a>         <span class="st">&#39;a_x&#39;</span>,</span>
<span id="orgc483b75-6"><a href="#orgc483b75-6" aria-hidden="true"></a>         (NormalRV, <span class="st">&#39;mu_x&#39;</span>, <span class="st">&#39;sd_x&#39;</span>, <span class="st">&#39;size_x&#39;</span>, <span class="st">&#39;rs_x&#39;</span>)),</span>
<span id="orgc483b75-7"><a href="#orgc483b75-7" aria-hidden="true"></a>        (NormalRV,</span>
<span id="orgc483b75-8"><a href="#orgc483b75-8" aria-hidden="true"></a>         (tt.mul, <span class="st">&#39;a_x&#39;</span>, <span class="st">&#39;mu_x&#39;</span>),</span>
<span id="orgc483b75-9"><a href="#orgc483b75-9" aria-hidden="true"></a>         (tt.mul, <span class="st">&#39;a_x&#39;</span>, <span class="st">&#39;sd_x&#39;</span>),</span>
<span id="orgc483b75-10"><a href="#orgc483b75-10" aria-hidden="true"></a>         <span class="st">&#39;size_x&#39;</span>,</span>
<span id="orgc483b75-11"><a href="#orgc483b75-11" aria-hidden="true"></a>         <span class="st">&#39;rs_x&#39;</span>,</span>
<span id="orgc483b75-12"><a href="#orgc483b75-12" aria-hidden="true"></a>        )),</span>
<span id="orgc483b75-13"><a href="#orgc483b75-13" aria-hidden="true"></a>    <span class="co"># Lift element-wise addition</span></span>
<span id="orgc483b75-14"><a href="#orgc483b75-14" aria-hidden="true"></a>    tt.gof.opt.PatternSub(</span>
<span id="orgc483b75-15"><a href="#orgc483b75-15" aria-hidden="true"></a>        (tt.add,</span>
<span id="orgc483b75-16"><a href="#orgc483b75-16" aria-hidden="true"></a>         (NormalRV, <span class="st">&#39;mu_x&#39;</span>, <span class="st">&#39;sd_x&#39;</span>, <span class="st">&#39;size_x&#39;</span>, <span class="st">&#39;rs_x&#39;</span>),</span>
<span id="orgc483b75-17"><a href="#orgc483b75-17" aria-hidden="true"></a>         <span class="st">&#39;b_x&#39;</span>),</span>
<span id="orgc483b75-18"><a href="#orgc483b75-18" aria-hidden="true"></a>        (NormalRV,</span>
<span id="orgc483b75-19"><a href="#orgc483b75-19" aria-hidden="true"></a>         (tt.add, <span class="st">&#39;mu_x&#39;</span>, <span class="st">&#39;b_x&#39;</span>),</span>
<span id="orgc483b75-20"><a href="#orgc483b75-20" aria-hidden="true"></a>         <span class="st">&#39;sd_x&#39;</span>,</span>
<span id="orgc483b75-21"><a href="#orgc483b75-21" aria-hidden="true"></a>         <span class="st">&#39;size_x&#39;</span>,</span>
<span id="orgc483b75-22"><a href="#orgc483b75-22" aria-hidden="true"></a>         <span class="st">&#39;rs_x&#39;</span>,</span>
<span id="orgc483b75-23"><a href="#orgc483b75-23" aria-hidden="true"></a>        )),</span>
<span id="orgc483b75-24"><a href="#orgc483b75-24" aria-hidden="true"></a>]</span>
<span id="orgc483b75-25"><a href="#orgc483b75-25" aria-hidden="true"></a></span>
<span id="orgc483b75-26"><a href="#orgc483b75-26" aria-hidden="true"></a>norm_lift_opts <span class="op">=</span> tt.gof.opt.EquilibriumOptimizer(</span>
<span id="orgc483b75-27"><a href="#orgc483b75-27" aria-hidden="true"></a>    norm_lift_pats, max_use_ratio<span class="op">=</span><span class="dv">10</span>)</span></code></pre></div>
<div class="example" data-markdown="">
<div class="sourceCode" id="orgc69f52b"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgc69f52b-1"><a href="#orgc69f52b-1" aria-hidden="true"></a><span class="co"># [[file:~/projects/websites/brandonwillard.github.io/content/articles/src/org/symbolic-math-in-pymc3-new-op.org::graph-manipulation-setup][graph-manipulation-setup]]</span></span>
<span id="orgc69f52b-2"><a href="#orgc69f52b-2" aria-hidden="true"></a><span class="im">from</span> theano.gof <span class="im">import</span> FunctionGraph, Feature, NodeFinder</span>
<span id="orgc69f52b-3"><a href="#orgc69f52b-3" aria-hidden="true"></a><span class="im">from</span> theano.gof.graph <span class="im">import</span> inputs <span class="im">as</span> tt_inputs, clone_get_equiv</span>
<span id="orgc69f52b-4"><a href="#orgc69f52b-4" aria-hidden="true"></a></span>
<span id="orgc69f52b-5"><a href="#orgc69f52b-5" aria-hidden="true"></a>theano.config.compute_test_value <span class="op">=</span> <span class="st">&#39;ignore&#39;</span></span>
<span id="orgc69f52b-6"><a href="#orgc69f52b-6" aria-hidden="true"></a><span class="co"># graph-manipulation-setup ends here</span></span>
<span id="orgc69f52b-7"><a href="#orgc69f52b-7" aria-hidden="true"></a></span>
<span id="orgc69f52b-8"><a href="#orgc69f52b-8" aria-hidden="true"></a>mu_X <span class="op">=</span> tt.vector(<span class="st">&#39;\mu&#39;</span>)</span>
<span id="orgc69f52b-9"><a href="#orgc69f52b-9" aria-hidden="true"></a>sd_X <span class="op">=</span> tt.vector(<span class="st">&#39;\sigma&#39;</span>)</span>
<span id="orgc69f52b-10"><a href="#orgc69f52b-10" aria-hidden="true"></a></span>
<span id="orgc69f52b-11"><a href="#orgc69f52b-11" aria-hidden="true"></a>a_tt <span class="op">=</span> tt.fscalar(<span class="st">&#39;a&#39;</span>)</span>
<span id="orgc69f52b-12"><a href="#orgc69f52b-12" aria-hidden="true"></a>b_tt <span class="op">=</span> tt.fscalar(<span class="st">&#39;b&#39;</span>)</span>
<span id="orgc69f52b-13"><a href="#orgc69f52b-13" aria-hidden="true"></a></span>
<span id="orgc69f52b-14"><a href="#orgc69f52b-14" aria-hidden="true"></a>X_rv <span class="op">=</span> NormalRV(mu_X, sd_X, name<span class="op">=</span><span class="st">&#39;X&#39;</span>)</span>
<span id="orgc69f52b-15"><a href="#orgc69f52b-15" aria-hidden="true"></a>trans_X_rv <span class="op">=</span> a_tt <span class="op">*</span> X_rv <span class="op">+</span> b_tt</span>
<span id="orgc69f52b-16"><a href="#orgc69f52b-16" aria-hidden="true"></a></span>
<span id="orgc69f52b-17"><a href="#orgc69f52b-17" aria-hidden="true"></a>trans_X_graph <span class="op">=</span> FunctionGraph(tt_inputs([trans_X_rv]), [trans_X_rv])</span>
<span id="orgc69f52b-18"><a href="#orgc69f52b-18" aria-hidden="true"></a></span>
<span id="orgc69f52b-19"><a href="#orgc69f52b-19" aria-hidden="true"></a><span class="co"># Create a copy and optimize that</span></span>
<span id="orgc69f52b-20"><a href="#orgc69f52b-20" aria-hidden="true"></a>trans_X_graph_opt <span class="op">=</span> trans_X_graph.clone()</span>
<span id="orgc69f52b-21"><a href="#orgc69f52b-21" aria-hidden="true"></a></span>
<span id="orgc69f52b-22"><a href="#orgc69f52b-22" aria-hidden="true"></a>_ <span class="op">=</span> norm_lift_opts.optimize(trans_X_graph_opt)</span></code></pre></div>
<div class="sourceCode" id="org2bd1258"><pre class="sourceCode python"><code class="sourceCode python"><span id="org2bd1258-1"><a href="#org2bd1258-1" aria-hidden="true"></a><span class="bu">print</span>(tt_tex_pprint(trans_X_graph.outputs[<span class="dv">0</span>], latex_env<span class="op">=</span><span class="st">&#39;equation*&#39;</span>))</span></code></pre></div>
<p>Before applying the optimization:</p>
<p><span class="math display">\[\begin{equation*}
        \begin{gathered}
        a \in \mathbb{R}
        \\
        \mu \in \mathbb{R}^{{n^{\mu}}_{0}}
        \\
        \sigma \in \mathbb{R}^{{n^{\sigma}}_{0}}
        \\
        X \sim \operatorname{N}\left(\mu, {\sigma}^{2}\right), \quad X \in \mathbb{R}^{{n^{X}}_{0}}
        \\
        b \in \mathbb{R}
        \end{gathered}
        \\
        ((a \odot X) + b)
\end{equation*}\]</span></p>
<div class="sourceCode" id="orge71b0ac"><pre class="sourceCode python"><code class="sourceCode python"><span id="orge71b0ac-1"><a href="#orge71b0ac-1" aria-hidden="true"></a><span class="bu">print</span>(tt_tex_pprint(trans_X_graph_opt.outputs[<span class="dv">0</span>], latex_env<span class="op">=</span><span class="st">&#39;equation*&#39;</span>))</span></code></pre></div>
<p>After applying the optimization:</p>
<p><span class="math display">\[\begin{equation*}
        \begin{gathered}
        a \in \mathbb{R}
        \\
        \mu \in \mathbb{R}^{{n^{\mu}}_{0}}
        \\
        b \in \mathbb{R}
        \\
        \sigma \in \mathbb{R}^{{n^{\sigma}}_{0}}
        \\
        c \sim \operatorname{N}\left(((a \odot \mu) + b), {(a \odot \sigma)}^{2}\right), \quad c \in \mathbb{R}^{{n^{c}}_{0}}
        \end{gathered}
        \\
        c
\end{equation*}\]</span></p>
</div>
<p>Now, what if we wanted to handle affine transformations of a multivariate normal random variable? Specifically, consider the following:</p>
<p><span class="math display">\[\begin{equation*}
  X \sim N\left(\mu, \Sigma \right), \quad
  A X \sim N\left(A \mu, A \Sigma A^\top \right)
 \;.
\end{equation*}\]</span></p>
<p>At first, the substitution pattern in Listing <a href="#org4a792de">40</a> might seem reasonable.</p>
<div class="sourceCode" id="org4a792de"><pre class="sourceCode python"><code class="sourceCode python"><span id="org4a792de-1"><a href="#org4a792de-1" aria-hidden="true"></a><span class="co"># Vector multiplication</span></span>
<span id="org4a792de-2"><a href="#org4a792de-2" aria-hidden="true"></a>tt.gof.opt.PatternSub(</span>
<span id="org4a792de-3"><a href="#org4a792de-3" aria-hidden="true"></a>    (tt.dot, <span class="st">&#39;A_x&#39;</span>,</span>
<span id="org4a792de-4"><a href="#org4a792de-4" aria-hidden="true"></a>     (MvNormalRV, <span class="st">&#39;mu_x&#39;</span>, <span class="st">&#39;cov_x&#39;</span>, <span class="st">&#39;size_x&#39;</span>, <span class="st">&#39;rs_x&#39;</span>)),</span>
<span id="org4a792de-5"><a href="#org4a792de-5" aria-hidden="true"></a>    (MvNormalRV,</span>
<span id="org4a792de-6"><a href="#org4a792de-6" aria-hidden="true"></a>     (tt.dot, <span class="st">&#39;A_x&#39;</span>, <span class="st">&#39;mu_x&#39;</span>),</span>
<span id="org4a792de-7"><a href="#org4a792de-7" aria-hidden="true"></a>     (tt.dot,</span>
<span id="org4a792de-8"><a href="#org4a792de-8" aria-hidden="true"></a>      (tt.dot, <span class="st">&#39;A_x&#39;</span>, <span class="st">&#39;cov_x&#39;</span>)</span>
<span id="org4a792de-9"><a href="#org4a792de-9" aria-hidden="true"></a>      (tt.transpose, <span class="st">&#39;A_x&#39;</span>)),</span>
<span id="org4a792de-10"><a href="#org4a792de-10" aria-hidden="true"></a>     <span class="st">&#39;size_x&#39;</span>,</span>
<span id="org4a792de-11"><a href="#org4a792de-11" aria-hidden="true"></a>     <span class="st">&#39;rs_x&#39;</span>,</span>
<span id="org4a792de-12"><a href="#org4a792de-12" aria-hidden="true"></a>    ))</span></code></pre></div>
<p>Unfortunately, the combination of size parameter and broadcasting complicates the scenario. Both parameters indirectly affect the distribution parameters, making the un-lifted dot-product consistent, but not necessarily the lifted products.</p>
<p>The following example demonstrates the lifting issues brought on by broadcasting.</p>
<div class="example" data-markdown="">
<p>We create a simple multivariate normal in Listing <a href="#org7446c7b">41</a>.</p>
<div class="sourceCode" id="org7446c7b"><pre class="sourceCode python"><code class="sourceCode python"><span id="org7446c7b-1"><a href="#org7446c7b-1" aria-hidden="true"></a>mu_X <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">10</span>]</span>
<span id="org7446c7b-2"><a href="#org7446c7b-2" aria-hidden="true"></a>cov_X <span class="op">=</span> np.diag([<span class="dv">1</span>, <span class="fl">1e-2</span>])</span>
<span id="org7446c7b-3"><a href="#org7446c7b-3" aria-hidden="true"></a>size_X_rv <span class="op">=</span> [<span class="dv">2</span>, <span class="dv">3</span>]</span>
<span id="org7446c7b-4"><a href="#org7446c7b-4" aria-hidden="true"></a>X_rv <span class="op">=</span> MvNormalRV(mu_X, cov_X, size<span class="op">=</span>size_X_rv)</span>
<span id="org7446c7b-5"><a href="#org7446c7b-5" aria-hidden="true"></a></span>
<span id="org7446c7b-6"><a href="#org7446c7b-6" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&#39;</span><span class="sc">{}</span><span class="st"> ~ X_rv</span><span class="ch">\n</span><span class="st">&#39;</span>.<span class="bu">format</span>(X_rv.tag.test_value))</span></code></pre></div>
<div class="sourceCode" id="org9e35ff4"><pre class="sourceCode python"><code class="sourceCode python"><span id="org9e35ff4-1"><a href="#org9e35ff4-1" aria-hidden="true"></a>[[[<span class="op">-</span><span class="fl">0.68284424</span>  <span class="fl">9.95587926</span>]</span>
<span id="org9e35ff4-2"><a href="#org9e35ff4-2" aria-hidden="true"></a>  [ <span class="fl">1.66236785</span>  <span class="fl">9.87590909</span>]</span>
<span id="org9e35ff4-3"><a href="#org9e35ff4-3" aria-hidden="true"></a>  [ <span class="fl">0.23449772</span> <span class="fl">10.12455681</span>]]</span>
<span id="org9e35ff4-4"><a href="#org9e35ff4-4" aria-hidden="true"></a></span>
<span id="org9e35ff4-5"><a href="#org9e35ff4-5" aria-hidden="true"></a> [[ <span class="fl">0.3342739</span>  <span class="fl">10.05580428</span>]</span>
<span id="org9e35ff4-6"><a href="#org9e35ff4-6" aria-hidden="true"></a>  [<span class="op">-</span><span class="fl">0.18913408</span> <span class="fl">10.0359336</span> ]</span>
<span id="org9e35ff4-7"><a href="#org9e35ff4-7" aria-hidden="true"></a>  [<span class="op">-</span><span class="fl">1.2463576</span>   <span class="fl">9.90671218</span>]]] <span class="op">~</span> X_rv</span>
<span id="org9e35ff4-8"><a href="#org9e35ff4-8" aria-hidden="true"></a></span></code></pre></div>
<p>Next, we create a simple matrix operator to apply to the multivariate normal.</p>
<div class="sourceCode" id="org0f84661"><pre class="sourceCode python"><code class="sourceCode python"><span id="org0f84661-1"><a href="#org0f84661-1" aria-hidden="true"></a>A_tt <span class="op">=</span> tt.as_tensor_variable([[<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">8</span>], [<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">9</span>]])</span>
<span id="org0f84661-2"><a href="#org0f84661-2" aria-hidden="true"></a><span class="co"># or A_tt = tt.as_tensor_variable([[2, 5, 8]])</span></span>
<span id="org0f84661-3"><a href="#org0f84661-3" aria-hidden="true"></a></span>
<span id="org0f84661-4"><a href="#org0f84661-4" aria-hidden="true"></a><span class="co"># It&#39;s really just `mu_X`...</span></span>
<span id="org0f84661-5"><a href="#org0f84661-5" aria-hidden="true"></a>E_X_rv <span class="op">=</span> X_rv.owner.inputs[<span class="dv">2</span>]</span>
<span id="org0f84661-6"><a href="#org0f84661-6" aria-hidden="true"></a></span>
<span id="org0f84661-7"><a href="#org0f84661-7" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&#39;A * X_rv =</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&#39;</span>.<span class="bu">format</span>(tt.dot(A_tt, X_rv).tag.test_value))</span></code></pre></div>
<div class="sourceCode" id="org05ebd11"><pre class="sourceCode python"><code class="sourceCode python"><span id="org05ebd11-1"><a href="#org05ebd11-1" aria-hidden="true"></a>A <span class="op">*</span> X_rv <span class="op">=</span></span>
<span id="org05ebd11-2"><a href="#org05ebd11-2" aria-hidden="true"></a>[[[  <span class="fl">1.18524621</span> <span class="fl">150.31045062</span>]</span>
<span id="org05ebd11-3"><a href="#org05ebd11-3" aria-hidden="true"></a>  [  <span class="fl">1.07000851</span> <span class="fl">150.65771936</span>]]</span>
<span id="org05ebd11-4"><a href="#org05ebd11-4" aria-hidden="true"></a></span>
<span id="org05ebd11-5"><a href="#org05ebd11-5" aria-hidden="true"></a> [[  <span class="fl">1.31685497</span> <span class="fl">160.33572146</span>]</span>
<span id="org05ebd11-6"><a href="#org05ebd11-6" aria-hidden="true"></a>  [  <span class="fl">0.33506491</span> <span class="fl">160.82202495</span>]]]</span>
<span id="org05ebd11-7"><a href="#org05ebd11-7" aria-hidden="true"></a></span></code></pre></div>
<p>As we can see, the multivariate normal’s test/sampled value has the correct shape for our matrix operator.</p>
<div class="sourceCode" id="orgd95a139"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgd95a139-1"><a href="#orgd95a139-1" aria-hidden="true"></a><span class="im">import</span> traceback</span>
<span id="orgd95a139-2"><a href="#orgd95a139-2" aria-hidden="true"></a><span class="cf">try</span>:</span>
<span id="orgd95a139-3"><a href="#orgd95a139-3" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&#39;A * E[X_rv] =</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&#39;</span>.<span class="bu">format</span>(tt.dot(A_tt, E_X_rv).tag.test_value))</span>
<span id="orgd95a139-4"><a href="#orgd95a139-4" aria-hidden="true"></a><span class="cf">except</span> <span class="pp">ValueError</span> <span class="im">as</span> e:</span>
<span id="orgd95a139-5"><a href="#orgd95a139-5" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;&quot;</span>.join(traceback.format_exception_only(<span class="bu">type</span>(e), e)))</span></code></pre></div>
<div class="sourceCode" id="org51f4e3a"><pre class="sourceCode python"><code class="sourceCode python"><span id="org51f4e3a-1"><a href="#org51f4e3a-1" aria-hidden="true"></a><span class="pp">ValueError</span>: shapes (<span class="dv">2</span>,<span class="dv">3</span>) <span class="kw">and</span> (<span class="dv">2</span>,) <span class="kw">not</span> aligned: <span class="dv">3</span> (dim <span class="dv">1</span>) <span class="op">!=</span> <span class="dv">2</span> (dim <span class="dv">0</span>)</span>
<span id="org51f4e3a-2"><a href="#org51f4e3a-2" aria-hidden="true"></a></span></code></pre></div>
<p>However, we see that the multivariate normal’s inputs (i.e. the <code>Op</code> inputs)–specifically the mean parameter–do not directly reflect the support’s shape, as one might expect.</p>
<div class="sourceCode" id="org6e32649"><pre class="sourceCode python"><code class="sourceCode python"><span id="org6e32649-1"><a href="#org6e32649-1" aria-hidden="true"></a>size_tile <span class="op">=</span> <span class="bu">tuple</span>(size_X_rv) <span class="op">+</span> (<span class="dv">1</span>,)</span>
<span id="org6e32649-2"><a href="#org6e32649-2" aria-hidden="true"></a>E_X_rv_ <span class="op">=</span> tt.tile(E_X_rv, size_tile, X_rv.ndim)</span>
<span id="org6e32649-3"><a href="#org6e32649-3" aria-hidden="true"></a></span>
<span id="org6e32649-4"><a href="#org6e32649-4" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&#39;A * E[X_rv] =</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&#39;</span>.<span class="bu">format</span>(tt.dot(A_tt, E_X_rv_).tag.test_value))</span></code></pre></div>
<div class="sourceCode" id="org7f64727"><pre class="sourceCode python"><code class="sourceCode python"><span id="org7f64727-1"><a href="#org7f64727-1" aria-hidden="true"></a>A <span class="op">*</span> E[X_rv] <span class="op">=</span></span>
<span id="org7f64727-2"><a href="#org7f64727-2" aria-hidden="true"></a>[[[  <span class="dv">0</span> <span class="dv">150</span>]</span>
<span id="org7f64727-3"><a href="#org7f64727-3" aria-hidden="true"></a>  [  <span class="dv">0</span> <span class="dv">150</span>]]</span>
<span id="org7f64727-4"><a href="#org7f64727-4" aria-hidden="true"></a></span>
<span id="org7f64727-5"><a href="#org7f64727-5" aria-hidden="true"></a> [[  <span class="dv">0</span> <span class="dv">160</span>]</span>
<span id="org7f64727-6"><a href="#org7f64727-6" aria-hidden="true"></a>  [  <span class="dv">0</span> <span class="dv">160</span>]]]</span>
<span id="org7f64727-7"><a href="#org7f64727-7" aria-hidden="true"></a></span></code></pre></div>
<p>We can manually replicate the inputs so that they match the output shape, but a solution to the general problem requires a more organized response.</p>
</div>
</section>
<section id="a-problem-with-conversion-from-pymc3" class="level1">
<h1>A Problem with Conversion from PyMC3</h1>
<p>As in <a href="#24875a2c31fa7f94ce562adddedc0bf8">Willard, Brandon T. (2018)</a>, we can create mappings between existing PyMC3 random variables and their new <code>RandomVariable</code> equivalents.</p>
<div class="example" data-markdown="">
<div class="sourceCode" id="org8bffc80"><pre class="sourceCode python"><code class="sourceCode python"><span id="org8bffc80-1"><a href="#org8bffc80-1" aria-hidden="true"></a>pymc_theano_rv_equivs <span class="op">=</span> {</span>
<span id="org8bffc80-2"><a href="#org8bffc80-2" aria-hidden="true"></a>    pm.Normal:</span>
<span id="org8bffc80-3"><a href="#org8bffc80-3" aria-hidden="true"></a>    <span class="kw">lambda</span> dist, rand_state:</span>
<span id="org8bffc80-4"><a href="#org8bffc80-4" aria-hidden="true"></a>    (<span class="va">None</span>,</span>
<span id="org8bffc80-5"><a href="#org8bffc80-5" aria-hidden="true"></a>     <span class="co"># PyMC3 shapes aren&#39;t NumPy-like size parameters, so we attempt to</span></span>
<span id="org8bffc80-6"><a href="#org8bffc80-6" aria-hidden="true"></a>     <span class="co"># adjust for that.</span></span>
<span id="org8bffc80-7"><a href="#org8bffc80-7" aria-hidden="true"></a>     NormalRV(dist.mu, dist.sd, size<span class="op">=</span>dist.shape[<span class="dv">1</span>:], rng<span class="op">=</span>rand_state)),</span>
<span id="org8bffc80-8"><a href="#org8bffc80-8" aria-hidden="true"></a>    pm.MvNormal:</span>
<span id="org8bffc80-9"><a href="#org8bffc80-9" aria-hidden="true"></a>    <span class="kw">lambda</span> dist, rand_state:</span>
<span id="org8bffc80-10"><a href="#org8bffc80-10" aria-hidden="true"></a>    (<span class="va">None</span>, NormalRV(dist.mu, dist.cov, size<span class="op">=</span>dist.shape[<span class="dv">1</span>:], rng<span class="op">=</span>rand_state)),</span>
<span id="org8bffc80-11"><a href="#org8bffc80-11" aria-hidden="true"></a>}</span></code></pre></div>
</div>
<p>However, if we attempt the same PymC3 graph conversion approach as before (i.e. convert a PyMC3 model to a Theano <code>FunctionGraph</code> using <code>model_graph</code>, then replace PyMC3 random variable nodes with our new random variable types using <code>create_theano_rvs</code>), we’re likely to run into a problem involving mismatching broadcastable dimensions.</p>
<p>The problem arises because <strong>PyMC3 “knows” more broadcast information than it should</strong>, since it uses the Theano variables’ test values in order to obtain concrete shapes for the random variables it creates. Using concrete, non-symbolic shapes, it can exactly determine what would otherwise be ambiguous <a href="http://deeplearning.net/software/theano/library/tensor/basic.html?highlight=broadcastable#theano.tensor.TensorType.broadcastable">broadcastable dimensions</a> at the symbolic level.</p>
<p>More specifically, broadcast information is required during the construction of a Theano <code>TensorType</code>, so PyMC3 random variable types can be inconsistent (unnecessarily restrictive, really) causing Theano to complain when we try to construct a <code>FunctionGraph</code>.</p>
<div class="example" data-markdown="">
<p>Consider the following example; it constructs two purely symbolic Theano vectors: one with broadcasting and one without.</p>
<div class="sourceCode" id="orgbd54927"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgbd54927-1"><a href="#orgbd54927-1" aria-hidden="true"></a>y_tt <span class="op">=</span> tt.row(<span class="st">&#39;y&#39;</span>)</span>
<span id="orgbd54927-2"><a href="#orgbd54927-2" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;y_tt.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(y_tt.broadcastable))</span>
<span id="orgbd54927-3"><a href="#orgbd54927-3" aria-hidden="true"></a></span>
<span id="orgbd54927-4"><a href="#orgbd54927-4" aria-hidden="true"></a>x_tt <span class="op">=</span> tt.matrix(<span class="st">&#39;x&#39;</span>)</span>
<span id="orgbd54927-5"><a href="#orgbd54927-5" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;x_tt.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(x_tt.broadcastable))</span></code></pre></div>
<div class="sourceCode" id="orga8f9d4c"><pre class="sourceCode python"><code class="sourceCode python"><span id="orga8f9d4c-1"><a href="#orga8f9d4c-1" aria-hidden="true"></a>y_tt.broadcastable <span class="op">=</span> (<span class="va">True</span>, <span class="va">False</span>)</span>
<span id="orga8f9d4c-2"><a href="#orga8f9d4c-2" aria-hidden="true"></a>x_tt.broadcastable <span class="op">=</span> (<span class="va">False</span>, <span class="va">False</span>)</span>
<span id="orga8f9d4c-3"><a href="#orga8f9d4c-3" aria-hidden="true"></a></span></code></pre></div>
<p>Notice that it–by default–signifies no broadcasting on its first and only dimension.</p>
<p>If we wish–or if <a href="http://deeplearning.net/software/theano/library/config.html#config.compute_test_value">Theano’s configuration demands</a> it–we can assign the symbolic vector arbitrary test values, as long as they’re consistent with its type (i.e. a vector, or 1-dimensional array).</p>
<p>In the following, we assign both a broadcastable (i.e. first–and only–dimension has size 1) and non-broadcastable test value.</p>
<p>Test value is broadcastable:</p>
<div class="sourceCode" id="orgaadc727"><pre class="sourceCode python"><code class="sourceCode python"><span id="orgaadc727-1"><a href="#orgaadc727-1" aria-hidden="true"></a><span class="im">from</span> contextlib <span class="im">import</span> contextmanager</span>
<span id="orgaadc727-2"><a href="#orgaadc727-2" aria-hidden="true"></a></span>
<span id="orgaadc727-3"><a href="#orgaadc727-3" aria-hidden="true"></a></span>
<span id="orgaadc727-4"><a href="#orgaadc727-4" aria-hidden="true"></a>x_tt.tag.test_value <span class="op">=</span> np.array([[<span class="dv">5</span>]])</span>
<span id="orgaadc727-5"><a href="#orgaadc727-5" aria-hidden="true"></a></span>
<span id="orgaadc727-6"><a href="#orgaadc727-6" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;test_value.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="orgaadc727-7"><a href="#orgaadc727-7" aria-hidden="true"></a>    tt.as_tensor_variable(x_tt.tag.test_value).broadcastable))</span>
<span id="orgaadc727-8"><a href="#orgaadc727-8" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;x_tt.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(x_tt.broadcastable))</span>
<span id="orgaadc727-9"><a href="#orgaadc727-9" aria-hidden="true"></a></span>
<span id="orgaadc727-10"><a href="#orgaadc727-10" aria-hidden="true"></a><span class="at">@contextmanager</span></span>
<span id="orgaadc727-11"><a href="#orgaadc727-11" aria-hidden="true"></a><span class="kw">def</span> short_exception_msg(exc_type):</span>
<span id="orgaadc727-12"><a href="#orgaadc727-12" aria-hidden="true"></a>    _verbosity <span class="op">=</span> theano.config.exception_verbosity</span>
<span id="orgaadc727-13"><a href="#orgaadc727-13" aria-hidden="true"></a>    theano.config.exception_verbosity <span class="op">=</span> <span class="st">&#39;low&#39;</span></span>
<span id="orgaadc727-14"><a href="#orgaadc727-14" aria-hidden="true"></a>    <span class="cf">try</span>:</span>
<span id="orgaadc727-15"><a href="#orgaadc727-15" aria-hidden="true"></a>        <span class="cf">yield</span></span>
<span id="orgaadc727-16"><a href="#orgaadc727-16" aria-hidden="true"></a>    <span class="cf">except</span> exc_type <span class="im">as</span> e:</span>
<span id="orgaadc727-17"><a href="#orgaadc727-17" aria-hidden="true"></a>        <span class="im">import</span> traceback</span>
<span id="orgaadc727-18"><a href="#orgaadc727-18" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="st">&quot;&quot;</span>.join(traceback.format_exception_only(<span class="bu">type</span>(e), e)))</span>
<span id="orgaadc727-19"><a href="#orgaadc727-19" aria-hidden="true"></a>    <span class="cf">finally</span>:</span>
<span id="orgaadc727-20"><a href="#orgaadc727-20" aria-hidden="true"></a>        theano.config.exception_verbosity <span class="op">=</span> _verbosity</span>
<span id="orgaadc727-21"><a href="#orgaadc727-21" aria-hidden="true"></a></span>
<span id="orgaadc727-22"><a href="#orgaadc727-22" aria-hidden="true"></a></span>
<span id="orgaadc727-23"><a href="#orgaadc727-23" aria-hidden="true"></a><span class="cf">with</span> short_exception_msg(<span class="pp">TypeError</span>):</span>
<span id="orgaadc727-24"><a href="#orgaadc727-24" aria-hidden="true"></a>    x_tt.shape</span>
<span id="orgaadc727-25"><a href="#orgaadc727-25" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;shape checks out!&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="org9c02ec5"><pre class="sourceCode python"><code class="sourceCode python"><span id="org9c02ec5-1"><a href="#org9c02ec5-1" aria-hidden="true"></a>test_value.broadcastable <span class="op">=</span> (<span class="va">True</span>, <span class="va">True</span>)</span>
<span id="org9c02ec5-2"><a href="#org9c02ec5-2" aria-hidden="true"></a>x_tt.broadcastable <span class="op">=</span> (<span class="va">False</span>, <span class="va">False</span>)</span>
<span id="org9c02ec5-3"><a href="#org9c02ec5-3" aria-hidden="true"></a>shape checks out<span class="op">!</span></span>
<span id="org9c02ec5-4"><a href="#org9c02ec5-4" aria-hidden="true"></a></span></code></pre></div>
<div class="sourceCode" id="org56323a0"><pre class="sourceCode python"><code class="sourceCode python"><span id="org56323a0-1"><a href="#org56323a0-1" aria-hidden="true"></a>y_tt.tag.test_value <span class="op">=</span> np.array([[<span class="dv">5</span>]])</span>
<span id="org56323a0-2"><a href="#org56323a0-2" aria-hidden="true"></a></span>
<span id="org56323a0-3"><a href="#org56323a0-3" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;test_value.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="org56323a0-4"><a href="#org56323a0-4" aria-hidden="true"></a>    tt.as_tensor_variable(y_tt.tag.test_value).broadcastable))</span>
<span id="org56323a0-5"><a href="#org56323a0-5" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;y_tt.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(y_tt.broadcastable))</span>
<span id="org56323a0-6"><a href="#org56323a0-6" aria-hidden="true"></a></span>
<span id="org56323a0-7"><a href="#org56323a0-7" aria-hidden="true"></a><span class="cf">with</span> short_exception_msg(<span class="pp">TypeError</span>):</span>
<span id="org56323a0-8"><a href="#org56323a0-8" aria-hidden="true"></a>    y_tt.shape</span>
<span id="org56323a0-9"><a href="#org56323a0-9" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;shape checks out!&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="orga78b1b0"><pre class="sourceCode python"><code class="sourceCode python"><span id="orga78b1b0-1"><a href="#orga78b1b0-1" aria-hidden="true"></a>test_value.broadcastable <span class="op">=</span> (<span class="va">True</span>, <span class="va">True</span>)</span>
<span id="orga78b1b0-2"><a href="#orga78b1b0-2" aria-hidden="true"></a>y_tt.broadcastable <span class="op">=</span> (<span class="va">True</span>, <span class="va">False</span>)</span>
<span id="orga78b1b0-3"><a href="#orga78b1b0-3" aria-hidden="true"></a>shape checks out<span class="op">!</span></span>
<span id="orga78b1b0-4"><a href="#orga78b1b0-4" aria-hidden="true"></a></span></code></pre></div>
<p>Test value is <strong>not</strong> broadcastable:</p>
<div class="sourceCode" id="orge2d0568"><pre class="sourceCode python"><code class="sourceCode python"><span id="orge2d0568-1"><a href="#orge2d0568-1" aria-hidden="true"></a>x_tt.tag.test_value <span class="op">=</span> np.array([[<span class="dv">5</span>, <span class="dv">4</span>]])</span>
<span id="orge2d0568-2"><a href="#orge2d0568-2" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;test_value.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="orge2d0568-3"><a href="#orge2d0568-3" aria-hidden="true"></a>    tt.as_tensor_variable(x_tt.tag.test_value).broadcastable))</span>
<span id="orge2d0568-4"><a href="#orge2d0568-4" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;x_tt.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(x_tt.broadcastable))</span>
<span id="orge2d0568-5"><a href="#orge2d0568-5" aria-hidden="true"></a></span>
<span id="orge2d0568-6"><a href="#orge2d0568-6" aria-hidden="true"></a><span class="cf">with</span> short_exception_msg(<span class="pp">TypeError</span>):</span>
<span id="orge2d0568-7"><a href="#orge2d0568-7" aria-hidden="true"></a>    x_tt.shape</span>
<span id="orge2d0568-8"><a href="#orge2d0568-8" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;shape checks out!&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="org3ac23d5"><pre class="sourceCode python"><code class="sourceCode python"><span id="org3ac23d5-1"><a href="#org3ac23d5-1" aria-hidden="true"></a>test_value.broadcastable <span class="op">=</span> (<span class="va">True</span>, <span class="va">False</span>)</span>
<span id="org3ac23d5-2"><a href="#org3ac23d5-2" aria-hidden="true"></a>x_tt.broadcastable <span class="op">=</span> (<span class="va">False</span>, <span class="va">False</span>)</span>
<span id="org3ac23d5-3"><a href="#org3ac23d5-3" aria-hidden="true"></a>shape checks out<span class="op">!</span></span>
<span id="org3ac23d5-4"><a href="#org3ac23d5-4" aria-hidden="true"></a></span></code></pre></div>
<div class="sourceCode" id="org53e07ae"><pre class="sourceCode python"><code class="sourceCode python"><span id="org53e07ae-1"><a href="#org53e07ae-1" aria-hidden="true"></a>y_tt.tag.test_value <span class="op">=</span> np.array([[<span class="dv">5</span>, <span class="dv">4</span>], [<span class="dv">3</span>, <span class="dv">2</span>]])</span>
<span id="org53e07ae-2"><a href="#org53e07ae-2" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;test_value.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</span>
<span id="org53e07ae-3"><a href="#org53e07ae-3" aria-hidden="true"></a>    tt.as_tensor_variable(y_tt.tag.test_value).broadcastable))</span>
<span id="org53e07ae-4"><a href="#org53e07ae-4" aria-hidden="true"></a><span class="bu">print</span>(<span class="st">&quot;y_tt.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(y_tt.broadcastable))</span>
<span id="org53e07ae-5"><a href="#org53e07ae-5" aria-hidden="true"></a></span>
<span id="org53e07ae-6"><a href="#org53e07ae-6" aria-hidden="true"></a><span class="cf">with</span> short_exception_msg(<span class="pp">TypeError</span>):</span>
<span id="org53e07ae-7"><a href="#org53e07ae-7" aria-hidden="true"></a>    y_tt.shape</span>
<span id="org53e07ae-8"><a href="#org53e07ae-8" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;shape checks out!&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="org60e8d8f"><pre class="sourceCode python"><code class="sourceCode python"><span id="org60e8d8f-1"><a href="#org60e8d8f-1" aria-hidden="true"></a>test_value.broadcastable <span class="op">=</span> (<span class="va">False</span>, <span class="va">False</span>)</span>
<span id="org60e8d8f-2"><a href="#org60e8d8f-2" aria-hidden="true"></a>y_tt.broadcastable <span class="op">=</span> (<span class="va">True</span>, <span class="va">False</span>)</span>
<span id="org60e8d8f-3"><a href="#org60e8d8f-3" aria-hidden="true"></a><span class="pp">TypeError</span>: For compute_test_value, one <span class="bu">input</span> test value does <span class="kw">not</span> have the requested <span class="bu">type</span>.</span>
<span id="org60e8d8f-4"><a href="#org60e8d8f-4" aria-hidden="true"></a></span>
<span id="org60e8d8f-5"><a href="#org60e8d8f-5" aria-hidden="true"></a>Backtrace when that variable <span class="kw">is</span> created:</span>
<span id="org60e8d8f-6"><a href="#org60e8d8f-6" aria-hidden="true"></a></span>
<span id="org60e8d8f-7"><a href="#org60e8d8f-7" aria-hidden="true"></a>  File <span class="st">&quot;/home/bwillard/apps/anaconda3/envs/github-website/lib/python3.6/site-packages/IPython/terminal/interactiveshell.py&quot;</span>, line <span class="dv">485</span>, <span class="kw">in</span> mainloop</span>
<span id="org60e8d8f-8"><a href="#org60e8d8f-8" aria-hidden="true"></a>    <span class="va">self</span>.interact()</span>
<span id="org60e8d8f-9"><a href="#org60e8d8f-9" aria-hidden="true"></a>  File <span class="st">&quot;/home/bwillard/apps/anaconda3/envs/github-website/lib/python3.6/site-packages/IPython/terminal/interactiveshell.py&quot;</span>, line <span class="dv">476</span>, <span class="kw">in</span> interact</span>
<span id="org60e8d8f-10"><a href="#org60e8d8f-10" aria-hidden="true"></a>    <span class="va">self</span>.run_cell(code, store_history<span class="op">=</span><span class="va">True</span>)</span>
<span id="org60e8d8f-11"><a href="#org60e8d8f-11" aria-hidden="true"></a>  File <span class="st">&quot;/home/bwillard/apps/anaconda3/envs/github-website/lib/python3.6/site-packages/IPython/core/interactiveshell.py&quot;</span>, line <span class="dv">2662</span>, <span class="kw">in</span> run_cell</span>
<span id="org60e8d8f-12"><a href="#org60e8d8f-12" aria-hidden="true"></a>    raw_cell, store_history, silent, shell_futures)</span>
<span id="org60e8d8f-13"><a href="#org60e8d8f-13" aria-hidden="true"></a>  File <span class="st">&quot;/home/bwillard/apps/anaconda3/envs/github-website/lib/python3.6/site-packages/IPython/core/interactiveshell.py&quot;</span>, line <span class="dv">2785</span>, <span class="kw">in</span> _run_cell</span>
<span id="org60e8d8f-14"><a href="#org60e8d8f-14" aria-hidden="true"></a>    interactivity<span class="op">=</span>interactivity, compiler<span class="op">=</span>compiler, result<span class="op">=</span>result)</span>
<span id="org60e8d8f-15"><a href="#org60e8d8f-15" aria-hidden="true"></a>  File <span class="st">&quot;/home/bwillard/apps/anaconda3/envs/github-website/lib/python3.6/site-packages/IPython/core/interactiveshell.py&quot;</span>, line <span class="dv">2909</span>, <span class="kw">in</span> run_ast_nodes</span>
<span id="org60e8d8f-16"><a href="#org60e8d8f-16" aria-hidden="true"></a>    <span class="cf">if</span> <span class="va">self</span>.run_code(code, result):</span>
<span id="org60e8d8f-17"><a href="#org60e8d8f-17" aria-hidden="true"></a>  File <span class="st">&quot;/home/bwillard/apps/anaconda3/envs/github-website/lib/python3.6/site-packages/IPython/core/interactiveshell.py&quot;</span>, line <span class="dv">2963</span>, <span class="kw">in</span> run_code</span>
<span id="org60e8d8f-18"><a href="#org60e8d8f-18" aria-hidden="true"></a>    <span class="bu">exec</span>(code_obj, <span class="va">self</span>.user_global_ns, <span class="va">self</span>.user_ns)</span>
<span id="org60e8d8f-19"><a href="#org60e8d8f-19" aria-hidden="true"></a>  File <span class="st">&quot;&lt;ipython-input-19-7427b1688530&gt;&quot;</span>, line <span class="dv">1</span>, <span class="kw">in</span> <span class="op">&lt;</span>module<span class="op">&gt;</span></span>
<span id="org60e8d8f-20"><a href="#org60e8d8f-20" aria-hidden="true"></a>    __org_babel_python_fname <span class="op">=</span> <span class="st">&#39;/tmp/user/1000/babel-fsZXPU/python-cZypXi&#39;</span><span class="op">;</span> __org_babel_python_fh <span class="op">=</span> <span class="bu">open</span>(__org_babel_python_fname)<span class="op">;</span> <span class="bu">exec</span>(<span class="bu">compile</span>(__org_babel_python_fh.read(), __org_babel_python_fname, <span class="st">&#39;exec&#39;</span>))<span class="op">;</span> __org_babel_python_fh.close()</span>
<span id="org60e8d8f-21"><a href="#org60e8d8f-21" aria-hidden="true"></a>  File <span class="st">&quot;/tmp/user/1000/babel-fsZXPU/python-cZypXi&quot;</span>, line <span class="dv">1</span>, <span class="kw">in</span> <span class="op">&lt;</span>module<span class="op">&gt;</span></span>
<span id="org60e8d8f-22"><a href="#org60e8d8f-22" aria-hidden="true"></a>    y_tt <span class="op">=</span> tt.row(<span class="st">&#39;y&#39;</span>)</span>
<span id="org60e8d8f-23"><a href="#org60e8d8f-23" aria-hidden="true"></a></span>
<span id="org60e8d8f-24"><a href="#org60e8d8f-24" aria-hidden="true"></a>The error when converting the test value to that variable <span class="bu">type</span>:</span>
<span id="org60e8d8f-25"><a href="#org60e8d8f-25" aria-hidden="true"></a>Non<span class="op">-</span>unit value on shape on a broadcastable dimension.</span>
<span id="org60e8d8f-26"><a href="#org60e8d8f-26" aria-hidden="true"></a>(<span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="org60e8d8f-27"><a href="#org60e8d8f-27" aria-hidden="true"></a>(<span class="va">True</span>, <span class="va">False</span>)</span>
<span id="org60e8d8f-28"><a href="#org60e8d8f-28" aria-hidden="true"></a></span></code></pre></div>
<p>Simply put: non-broadcastable Theano tensor variable types can take broadcastable and non-broadcastable values, while broadcastable types can only take broadcastable values.</p>
</div>
<p>What we can take from the example above is that if we determine that a vector has broadcastable dimensions using test values–as PyMC3 does–we unnecessarily introduce restrictions and potential inconsistencies down the line. One point of origin for such issues is <strong>shared variables</strong>.</p>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>In follow-ups to this series, we’ll address a few loose ends, such as</p>
<ul>
<li>the inclusion of density functions and likelihoods,</li>
<li>decompositions/reductions of overlapping multivariate types (e.g. transforms between tensors of univariate normals and equivalent multivariate normals),</li>
<li>canonicalization of graphs containing <code>RandomVariable</code> terms,</li>
<li>and more optimizations that specifically target MCMC schemes (e.g. automatic conversion to scale mixture decompositions).</li>
</ul>
</section>
<script>
 window.MathJax = {
     tex: {
         tags: "ams"
     }
 };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
</body>
</html>

            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'brandonwillard-github-io'; // required: replace example with your forum shortname

            var disqus_config = function () {
                this.language = "en";

                        this.page.identifier = '2018-12-28-random-variables-in-theano';
                        this.page.url = 'https://brandonwillard.github.io/random-variables-in-theano.html';
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="https://brandonwillard.github.io//images/profile-pic.png"/>
        </p>
    <p>
      <strong>About Brandon T. Willard</strong><br/>
        applied math/stats person
    </p>
</div><!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://github.com/brandonwillard"><i class="fa fa-github-square fa-lg"></i> github</a></li>
    <li class="list-group-item"><a href="https://scholar.google.com/citations?user=g0oUxG4AAAAJ&hl=en"><i class="ai ai-google-scholar ai-lg"></i> google scholar</a></li>
    <li class="list-group-item"><a href="https://www.linkedin.com/in/brandon-t-willard-468bb410/"><i class="fa fa-linkedin fa-lg"></i> linkedin</a></li>
    <li class="list-group-item"><a href="https://bitbucket.io/brandonwillard"><i class="fa fa-bitbucket-square fa-lg"></i> bitbucket</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2020 Brandon T. Willard
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en">Creative Commons Attribution-NonCommercial 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://brandonwillard.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://brandonwillard.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://brandonwillard.github.io/theme/js/respond.min.js"></script>


    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'brandonwillard-github-io'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-91585967-1', '');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->


</body>
</html>