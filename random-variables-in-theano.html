<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Random Variables in Theano - Brandon T. Willard</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://brandonwillard.github.io/random-variables-in-theano.html">

        <meta name="author" content="Brandon T. Willard" />
        <meta name="keywords" content="pymc3,theano,statistics,symbolic computation,python,probability theory" />

        <meta property="og:site_name" content="Brandon T. Willard" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Random Variables in Theano"/>
        <meta property="og:url" content="https://brandonwillard.github.io/random-variables-in-theano.html"/>
        <meta property="og:description" content=""/>
        <meta property="article:published_time" content="2018-12-28" />
            <meta property="article:section" content="articles" />
            <meta property="article:tag" content="pymc3" />
            <meta property="article:tag" content="theano" />
            <meta property="article:tag" content="statistics" />
            <meta property="article:tag" content="symbolic computation" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="probability theory" />
            <meta property="article:author" content="Brandon T. Willard" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://brandonwillard.github.io/theme/css/bootstrap.readable.min.css" type="text/css"/>
    <link href="https://brandonwillard.github.io/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://brandonwillard.github.io/theme/css/academicons.min.css" rel="stylesheet">

    <link href="https://brandonwillard.github.io/theme/css/pygments/vim.css" rel="stylesheet">
    <link rel="stylesheet" href="https://brandonwillard.github.io/theme/css/style.css" type="text/css"/>
        <link href="https://brandonwillard.github.io/extra/custom.css" rel="stylesheet">

        <link href="https://brandonwillard.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Brandon T. Willard ATOM Feed"/>

        <link href="https://brandonwillard.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Brandon T. Willard RSS Feed"/>


        <link href="https://brandonwillard.github.io/feeds/articles.atom.xml" type="application/atom+xml" rel="alternate"
              title="Brandon T. Willard articles ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://brandonwillard.github.io/" class="navbar-brand">
Brandon T. Willard            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://brandonwillard.github.io/pages/about.html">
                             About
                          </a></li>
                         <li><a href="https://brandonwillard.github.io/pages/projects.html">
                             Projects
                          </a></li>
                         <li><a href="https://brandonwillard.github.io/pages/publications.html">
                             Publications
                          </a></li>
                        <li class="active">
                            <a href="https://brandonwillard.github.io/category/articles.html">Articles</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://brandonwillard.github.io/random-variables-in-theano.html"
                       rel="bookmark"
                       title="Permalink to Random Variables in Theano">
                        Random Variables in Theano
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2018-12-28T00:00:00-06:00"> Fri 28 December 2018</time>
    </span>
          <span class="label label-default">Modified</span>
            <span class="modified">
                <i class="fa fa-calendar"></i><time datetime="2019-01-31T00:00:00-06:00"> Thu 31 January 2019</time>
            </span>





<span class="label label-default">Tags</span>
	<a href="https://brandonwillard.github.io/tag/pymc3.html">pymc3</a>
        /
	<a href="https://brandonwillard.github.io/tag/theano.html">theano</a>
        /
	<a href="https://brandonwillard.github.io/tag/statistics.html">statistics</a>
        /
	<a href="https://brandonwillard.github.io/tag/symbolic-computation.html">symbolic computation</a>
        /
	<a href="https://brandonwillard.github.io/tag/python.html">python</a>
        /
	<a href="https://brandonwillard.github.io/tag/probability-theory.html">probability theory</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Brandon T. Willard" />
  <title>Random Variables in Theano</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
</head>
<body>
<!--  -->
<!-- <div id="header"> -->
<!-- <h1 class="title">Random Variables in Theano</h1> -->
<!--  -->
<!--  -->
<!-- <h2 class="author">Brandon T. Willard</h2> -->
<!--  -->
<!--  -->
<!-- <h3 class="date">2018–12–28</h3> -->
<!--  -->
<!-- </div> -->
<!--  -->
<div class="abstract">
<p>Continuing from <a href="#24875a2c31fa7f94ce562adddedc0bf8">Willard, Brandon T. (2018)</a>, we’ll attempt to improve upon <code>RandomFunction</code> and make a case for a similar <code>Op</code> in PyMC3.</p>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>We’ll call the new <code>Op</code> developed here <code>RandomVariable</code>, since random variables are the abstraction we’re primarily targeting. <code>RandomVariable</code> will provide the functionality of <code>Distribution</code>, <code>FreeRV</code> and <code>ObservedRV</code>, and, by working at the <code>Op</code> level, it will be much more capable of leveraging existing Theano functionality.</p>
<p>Specifically, by using the <code>Op</code> interface, we’re able to do the following:</p>
<ol type="1">
<li><p>Remove the need for an explicitly specified shape parameter.</p>
<div class="example" data-markdown="">
<p>For example, definitions like</p>
<div class="sourceCode" id="orgb28d042"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgb28d042-1" title="1"><span class="cf">with</span> pm.Model():</a>
<a class="sourceLine" id="orgb28d042-2" title="2">    X_rv <span class="op">=</span> pm.Normal(<span class="st">&#39;X_rv&#39;</span>, mu_X, sd<span class="op">=</span>sd_X, shape<span class="op">=</span>(<span class="dv">1</span>,))</a></code></pre></div>
<p>reduce to</p>
<div class="sourceCode" id="org0650889"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org0650889-1" title="1"><span class="cf">with</span> pm.Model():</a>
<a class="sourceLine" id="org0650889-2" title="2">    X_rv <span class="op">=</span> pm.Normal(<span class="st">&#39;X_rv&#39;</span>, mu_X, sd<span class="op">=</span>sd_X)</a></code></pre></div>
</div></li>
<li>Random variable nodes created by an <code>Op</code> automatically implement <code>Distribution.default</code>/<code>Distribution.get_test_val</code> functionality and remove the reliance on initial values during random variable instantiation. <code>Op</code> automatically uses <code>Op.perform</code>, which will draw a sample as a test value <strong>and</strong> propagate it throughout the graph to down-stream tensor variables.</li>
<li>Log-densities can be generated as secondary outputs of <code>Op.make_node</code>, which removes the need for <code>Distribution.logp*</code> methods.</li>
<li><p><code>pymc.distribution.draw_values</code> and related methods are no longer necessary; their functionality is already covered within Theano’s existing graph machinery–in the same way as <code>pymc.distribution.Distribution.default/get_test_val</code>.</p></li>
</ol>
<p>The main points of entry in our <code>Op</code>, are <code>Op.make_node</code> and <code>Op.perform</code>. <code>Op.make_node</code> is used during symbolic graph creation and provides immediate access to the <code>Op</code>’s symbolic inputs–serving a purpose similar to <code>Distribution.__init__</code>. <code>Op.make_node</code> is where shape inference tasks (e.g. <a href="https://github.com/pymc-devs/pymc3/pull/1125">PyMC3 PR 1125</a>) are more suitably addressed; however, <code>Op</code> provides additional means of shape inference and management (e.g. <code>Op.infer_shape</code>) occurring at different phases of graph compilation that aren’t readily accessible outside of the <code>Op</code> framework.</p>
</section>
<section id="a-new-random-variable-op" class="level1">
<h1>A <strong>new</strong> Random Variable <code>Op</code></h1>
<div class="sourceCode" id="org9c584cc"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org9c584cc-1" title="1"><span class="im">import</span> sys</a>
<a class="sourceLine" id="org9c584cc-2" title="2"><span class="im">import</span> os</a>
<a class="sourceLine" id="org9c584cc-3" title="3"></a>
<a class="sourceLine" id="org9c584cc-4" title="4"><span class="im">from</span> pprint <span class="im">import</span> pprint</a>
<a class="sourceLine" id="org9c584cc-5" title="5"></a>
<a class="sourceLine" id="org9c584cc-6" title="6"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="org9c584cc-7" title="7"></a>
<a class="sourceLine" id="org9c584cc-8" title="8">os.environ[<span class="st">&#39;MKL_THREADING_LAYER&#39;</span>] <span class="op">=</span> <span class="st">&#39;GNU&#39;</span></a>
<a class="sourceLine" id="org9c584cc-9" title="9"></a>
<a class="sourceLine" id="org9c584cc-10" title="10"><span class="im">import</span> theano</a>
<a class="sourceLine" id="org9c584cc-11" title="11"><span class="im">import</span> theano.tensor <span class="im">as</span> tt</a>
<a class="sourceLine" id="org9c584cc-12" title="12"></a>
<a class="sourceLine" id="org9c584cc-13" title="13">theano.config.mode <span class="op">=</span> <span class="st">&#39;FAST_COMPILE&#39;</span></a>
<a class="sourceLine" id="org9c584cc-14" title="14">theano.config.exception_verbosity <span class="op">=</span> <span class="st">&#39;high&#39;</span></a>
<a class="sourceLine" id="org9c584cc-15" title="15"><span class="co"># </span><span class="al">NOTE</span><span class="co">: pymc3 requires test values</span></a>
<a class="sourceLine" id="org9c584cc-16" title="16">theano.config.compute_test_value <span class="op">=</span> <span class="st">&#39;warn&#39;</span></a>
<a class="sourceLine" id="org9c584cc-17" title="17"></a>
<a class="sourceLine" id="org9c584cc-18" title="18"><span class="im">import</span> pymc3 <span class="im">as</span> pm</a></code></pre></div>
<p>Most of the work involved in generalizing <code>RandomFunction</code> has to do with symbolic shape handling and inference. We need to bridge the gaps between symbolic array/tensor broadcasting parameters and the way Numpy random variable functions allow distribution parameters to be specified.</p>
<div class="example" data-markdown="">
<p>Scalar normal random variates have a support and parameters with dimension zero. In Listing <a href="#org352d751">4</a> we create a scalar normal random variate in Numpy and inspect its shape. The length of the shape corresponds to the dimension of the distribution’s support (i.e. zero).</p>
<div class="sourceCode" id="org352d751"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org352d751-1" title="1">np.shape(np.random.normal(loc<span class="op">=</span><span class="dv">0</span>, scale<span class="op">=</span><span class="dv">1</span>, size<span class="op">=</span><span class="va">None</span>))</a></code></pre></div>
<div class="sourceCode" id="orgf019ed0"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgf019ed0-1" title="1">()</a></code></pre></div>
<p>Numpy also allows one to specify <strong>independent</strong> normal variates using one function call with each variate’s parameters spanning dimensions higher than the variate’s. In Listing <a href="#orgbabaa48">6</a> we specify three independent scalar normal variates, each with a different mean and scale parameter. This time, the result’s shape reflects <strong>the number of independent random variates</strong>, and not the dimension of the underlying distribution’s support.</p>
<div class="sourceCode" id="orgbabaa48"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgbabaa48-1" title="1">np.shape(np.random.normal(loc<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>], scale<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], size<span class="op">=</span><span class="va">None</span>))</a></code></pre></div>
<div class="sourceCode" id="orgaaa61c5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgaaa61c5-1" title="1">(<span class="dv">3</span>,)</a></code></pre></div>
<p>Distribution parameters can also be broadcasted, as in <a href="#org6643ee7">8</a>. Now, each independent variate has the same scale value.</p>
<div class="sourceCode" id="org6643ee7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org6643ee7-1" title="1">np.shape(np.random.normal(loc<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>], scale<span class="op">=</span><span class="dv">1</span>, size<span class="op">=</span><span class="va">None</span>))</a></code></pre></div>
<p>The <code>size</code> parameter effectively replicates variates, in-line with the–potentially broadcasted–distribution parameters.</p>
<p>When bridging these Numpy functions and Theano, we have to adapt the underlying parameter/shape logic of functions like <code>np.random.normal</code> to a scenario involving symbolic parameters and their symbolic shapes.</p>
<p>For instance, in Theano a <strong>symbolic</strong> scalar’s shape is represented in nearly the same way.</p>
<div class="sourceCode" id="orga6116d4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orga6116d4-1" title="1">test_scalar <span class="op">=</span> tt.scalar()</a>
<a class="sourceLine" id="orga6116d4-2" title="2">test_scalar.shape.<span class="bu">eval</span>({test_scalar: <span class="dv">1</span>})</a></code></pre></div>
<div class="sourceCode" id="org17f42ea"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org17f42ea-1" title="1">[]</a></code></pre></div>
<p>This means that our proposed Theano adaptation of <code>np.random.normal</code>, let’s call it <code>tt_normal</code>, should return the same result as Numpy in the case of scalars.</p>
<p>What about <code>tt_normal(loc=tt.vector(), scale=tt.vector(), size=None)</code>? Since the inputs are purely symbolic, the resulting symbolic object’s shape should be, too, but we should also know that the symbolic shape should have dimension equal to one. Just as in Listing <a href="#orgbabaa48">6</a>, each corresponding element in the vector arguments of <code>tt_normal</code> is an independent variate; in the symbolic case, we might not know exactly how many of them there are, yet, but we know that there’s a vector’s worth of them.</p>
<p>How exactly do we get that information from Theano, though? The type produced by <code>tt.vector</code> has an <code>ndim</code> parameter that provides this. Furthermore, there is some (intermittent) functionality that allows one to iterate over shapes. Listing <a href="#org0d70518">11</a> demonstrates this.</p>
<div class="sourceCode" id="org0d70518"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org0d70518-1" title="1">test_matrix <span class="op">=</span> tt.matrix()</a>
<a class="sourceLine" id="org0d70518-2" title="2">shape_parts <span class="op">=</span> <span class="bu">tuple</span>(test_matrix.shape)</a>
<a class="sourceLine" id="org0d70518-3" title="3">shape_parts</a></code></pre></div>
<div class="sourceCode" id="org4709491"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org4709491-1" title="1">(Subtensor{int64}.<span class="dv">0</span>, Subtensor{int64}.<span class="dv">0</span>)</a></code></pre></div>
<p>When the matrix in Listing <a href="#org0d70518">11</a> is “materialized” (i.e. given a value), its corresponding shape object–and its components–will take their respective values.</p>
<div class="sourceCode" id="org4d51e03"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org4d51e03-1" title="1"><span class="bu">tuple</span>(p.<span class="bu">eval</span>({test_matrix: np.diag([<span class="dv">1</span>, <span class="dv">2</span>])}) <span class="cf">for</span> p <span class="kw">in</span> shape_parts)</a></code></pre></div>
<div class="sourceCode" id="org4d888c2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org4d888c2-1" title="1">(array(<span class="dv">2</span>), array(<span class="dv">2</span>))</a></code></pre></div>
<p>If we knew that the support of this distribution was a scalar/vector/matrix, then these <code>ndim</code>-related results–obtained from the symbolic parameters–would tell us that we have multiple, independent variates and we could reliably extract the symbolic variables corresponding to those actual dimension sizes.</p>
</div>
<p>To determine the shape parts (i.e. support, number of independent and replicated variates) of the symbolic random variables, we mimic the corresponding Numpy logic and use the Theano <code>ndim</code> shape information described above. The following function generalizes that work for many simple distributions.</p>
<div class="sourceCode" id="org03297c0"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org03297c0-1" title="1"><span class="im">from</span> collections.abc <span class="im">import</span> Iterable, ByteString</a>
<a class="sourceLine" id="org03297c0-2" title="2"><span class="im">from</span> warnings <span class="im">import</span> warn</a>
<a class="sourceLine" id="org03297c0-3" title="3"><span class="im">from</span> copy <span class="im">import</span> copy</a>
<a class="sourceLine" id="org03297c0-4" title="4"></a>
<a class="sourceLine" id="org03297c0-5" title="5"><span class="im">from</span> theano.tensor.raw_random <span class="im">import</span> (RandomFunction, RandomStateType,</a>
<a class="sourceLine" id="org03297c0-6" title="6">                                      _infer_ndim_bcast)</a>
<a class="sourceLine" id="org03297c0-7" title="7"></a>
<a class="sourceLine" id="org03297c0-8" title="8"></a>
<a class="sourceLine" id="org03297c0-9" title="9"><span class="kw">def</span> param_supp_shape_fn(ndim_supp, ndims_params, dist_params,</a>
<a class="sourceLine" id="org03297c0-10" title="10">                        rep_param_idx<span class="op">=</span><span class="dv">0</span>, param_shapes<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="org03297c0-11" title="11">    <span class="co">&quot;&quot;&quot;A function for deriving a random variable&#39;s support shape/dimensions</span></a>
<a class="sourceLine" id="org03297c0-12" title="12"><span class="co">    from one of its parameters.</span></a>
<a class="sourceLine" id="org03297c0-13" title="13"></a>
<a class="sourceLine" id="org03297c0-14" title="14"><span class="co">    XXX: It&#39;s not always possible to determine a random variable&#39;s support</span></a>
<a class="sourceLine" id="org03297c0-15" title="15"><span class="co">    shape from its parameters, so this function has fundamentally limited</span></a>
<a class="sourceLine" id="org03297c0-16" title="16"><span class="co">    applicability.</span></a>
<a class="sourceLine" id="org03297c0-17" title="17"></a>
<a class="sourceLine" id="org03297c0-18" title="18"><span class="co">    XXX: This function is not expected to handle `ndim_supp = 0` (i.e.</span></a>
<a class="sourceLine" id="org03297c0-19" title="19"><span class="co">    scalars), since that is already definitively handled in the `Op` that</span></a>
<a class="sourceLine" id="org03297c0-20" title="20"><span class="co">    calls this.</span></a>
<a class="sourceLine" id="org03297c0-21" title="21"></a>
<a class="sourceLine" id="org03297c0-22" title="22"><span class="co">    </span><span class="al">TODO</span><span class="co">: Consider using `theano.compile.ops.shape_i` alongside `ShapeFeature`.</span></a>
<a class="sourceLine" id="org03297c0-23" title="23"></a>
<a class="sourceLine" id="org03297c0-24" title="24"><span class="co">    Parameters</span></a>
<a class="sourceLine" id="org03297c0-25" title="25"><span class="co">    ==========</span></a>
<a class="sourceLine" id="org03297c0-26" title="26"><span class="co">    ndim_supp: int</span></a>
<a class="sourceLine" id="org03297c0-27" title="27"><span class="co">        Total number of dimensions in the support (assumedly &gt; 0).</span></a>
<a class="sourceLine" id="org03297c0-28" title="28"><span class="co">    ndims_params: list of int</span></a>
<a class="sourceLine" id="org03297c0-29" title="29"><span class="co">        Number of dimensions for each distribution parameter.</span></a>
<a class="sourceLine" id="org03297c0-30" title="30"><span class="co">    dist_params: list of `theano.gof.graph.Variable`</span></a>
<a class="sourceLine" id="org03297c0-31" title="31"><span class="co">        The distribution parameters.</span></a>
<a class="sourceLine" id="org03297c0-32" title="32"><span class="co">    param_shapes: list of `theano.compile.ops.Shape` (optional)</span></a>
<a class="sourceLine" id="org03297c0-33" title="33"><span class="co">        Symbolic shapes for each distribution parameter.</span></a>
<a class="sourceLine" id="org03297c0-34" title="34"><span class="co">        Providing this value prevents us from reproducing the requisite</span></a>
<a class="sourceLine" id="org03297c0-35" title="35"><span class="co">        `theano.compile.ops.Shape` object (e.g. when it&#39;s already available to</span></a>
<a class="sourceLine" id="org03297c0-36" title="36"><span class="co">        the caller).</span></a>
<a class="sourceLine" id="org03297c0-37" title="37"><span class="co">    rep_param_idx: int (optional)</span></a>
<a class="sourceLine" id="org03297c0-38" title="38"><span class="co">        The index of the distribution parameter to use as a reference</span></a>
<a class="sourceLine" id="org03297c0-39" title="39"><span class="co">        In other words, a parameter in `dist_param` with a shape corresponding</span></a>
<a class="sourceLine" id="org03297c0-40" title="40"><span class="co">        to the support&#39;s shape.</span></a>
<a class="sourceLine" id="org03297c0-41" title="41"><span class="co">        The default is the first parameter (i.e. the value 0).</span></a>
<a class="sourceLine" id="org03297c0-42" title="42"></a>
<a class="sourceLine" id="org03297c0-43" title="43"><span class="co">    Results</span></a>
<a class="sourceLine" id="org03297c0-44" title="44"><span class="co">    =======</span></a>
<a class="sourceLine" id="org03297c0-45" title="45"><span class="co">    out: a tuple representing the support shape for a distribution with the</span></a>
<a class="sourceLine" id="org03297c0-46" title="46"><span class="co">    given `dist_params`.</span></a>
<a class="sourceLine" id="org03297c0-47" title="47"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org03297c0-48" title="48">    <span class="co"># XXX: Gotta be careful slicing Theano variables, the `Subtensor` Op isn&#39;t</span></a>
<a class="sourceLine" id="org03297c0-49" title="49">    <span class="co"># handled by `tensor.get_scalar_constant_value`!</span></a>
<a class="sourceLine" id="org03297c0-50" title="50">    <span class="co"># E.g.</span></a>
<a class="sourceLine" id="org03297c0-51" title="51">    <span class="co">#     test_val = tt.as_tensor_variable([[1], [4]])</span></a>
<a class="sourceLine" id="org03297c0-52" title="52">    <span class="co">#     tt.get_scalar_constant_value(test_val.shape[-1]) # works</span></a>
<a class="sourceLine" id="org03297c0-53" title="53">    <span class="co">#     tt.get_scalar_constant_value(test_val.shape[0]) # doesn&#39;t</span></a>
<a class="sourceLine" id="org03297c0-54" title="54">    <span class="co">#     tt.get_scalar_constant_value(test_val.shape[:-1]) # doesn&#39;t</span></a>
<a class="sourceLine" id="org03297c0-55" title="55">    <span class="cf">if</span> param_shapes <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="org03297c0-56" title="56">        <span class="co"># return param_shapes[0][-self.ndim_supp:]</span></a>
<a class="sourceLine" id="org03297c0-57" title="57">        <span class="cf">return</span> (param_shapes[rep_param_idx][<span class="op">-</span>ndim_supp],)</a>
<a class="sourceLine" id="org03297c0-58" title="58">    <span class="cf">else</span>:</a>
<a class="sourceLine" id="org03297c0-59" title="59">        <span class="co"># return dist_params[rep_param_idx].shape[-ndim_supp]</span></a>
<a class="sourceLine" id="org03297c0-60" title="60">        ref_shape <span class="op">=</span> tt.shape(dist_params[rep_param_idx])</a>
<a class="sourceLine" id="org03297c0-61" title="61">        <span class="cf">return</span> (ref_shape[<span class="op">-</span>ndim_supp],)</a></code></pre></div>
<p>Finally, we put everything together in a new random variable <code>Op</code> called <code>RandomVariable</code>.</p>
<div class="sourceCode" id="orgb7517e4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgb7517e4-1" title="1"><span class="kw">class</span> RandomVariable(tt.gof.Op):</a>
<a class="sourceLine" id="orgb7517e4-2" title="2">    <span class="co">&quot;&quot;&quot;This is essentially `RandomFunction`, except that it removes the `outtype`</span></a>
<a class="sourceLine" id="orgb7517e4-3" title="3"><span class="co">    dependency and handles shape dimension information more directly.</span></a>
<a class="sourceLine" id="orgb7517e4-4" title="4"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="orgb7517e4-5" title="5">    __props__ <span class="op">=</span> (<span class="st">&#39;name&#39;</span>, <span class="st">&#39;dtype&#39;</span>, <span class="st">&#39;ndim_supp&#39;</span>, <span class="st">&#39;inplace&#39;</span>, <span class="st">&#39;ndims_params&#39;</span>)</a>
<a class="sourceLine" id="orgb7517e4-6" title="6"></a>
<a class="sourceLine" id="orgb7517e4-7" title="7">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name, dtype, ndim_supp, ndims_params, rng_fn,</a>
<a class="sourceLine" id="orgb7517e4-8" title="8">                 <span class="op">*</span>args,</a>
<a class="sourceLine" id="orgb7517e4-9" title="9">                 supp_shape_fn<span class="op">=</span>param_supp_shape_fn,</a>
<a class="sourceLine" id="orgb7517e4-10" title="10">                 inplace<span class="op">=</span><span class="va">False</span>,</a>
<a class="sourceLine" id="orgb7517e4-11" title="11">                 <span class="op">**</span>kwargs):</a>
<a class="sourceLine" id="orgb7517e4-12" title="12">        <span class="co">&quot;&quot;&quot;Create a random variable `Op`.</span></a>
<a class="sourceLine" id="orgb7517e4-13" title="13"></a>
<a class="sourceLine" id="orgb7517e4-14" title="14"><span class="co">        Parameters</span></a>
<a class="sourceLine" id="orgb7517e4-15" title="15"><span class="co">        ==========</span></a>
<a class="sourceLine" id="orgb7517e4-16" title="16"><span class="co">        name: str</span></a>
<a class="sourceLine" id="orgb7517e4-17" title="17"><span class="co">            The `Op`&#39;s display name.</span></a>
<a class="sourceLine" id="orgb7517e4-18" title="18"><span class="co">        dtype: Theano dtype</span></a>
<a class="sourceLine" id="orgb7517e4-19" title="19"><span class="co">            The underlying dtype.</span></a>
<a class="sourceLine" id="orgb7517e4-20" title="20"><span class="co">        ndim_supp: int</span></a>
<a class="sourceLine" id="orgb7517e4-21" title="21"><span class="co">            Dimension of the support.  This value is used to infer the exact</span></a>
<a class="sourceLine" id="orgb7517e4-22" title="22"><span class="co">            shape of the support and independent terms from ``dist_params``.</span></a>
<a class="sourceLine" id="orgb7517e4-23" title="23"><span class="co">        ndims_params: tuple (int)</span></a>
<a class="sourceLine" id="orgb7517e4-24" title="24"><span class="co">            Number of dimensions of each parameter in ``dist_params``.</span></a>
<a class="sourceLine" id="orgb7517e4-25" title="25"><span class="co">        rng_fn: function or str</span></a>
<a class="sourceLine" id="orgb7517e4-26" title="26"><span class="co">            The non-symbolic random variate sampling function.</span></a>
<a class="sourceLine" id="orgb7517e4-27" title="27"><span class="co">            Can be the string name of a method provided by</span></a>
<a class="sourceLine" id="orgb7517e4-28" title="28"><span class="co">            `numpy.random.RandomState`.</span></a>
<a class="sourceLine" id="orgb7517e4-29" title="29"><span class="co">        supp_shape_fn: callable (optional)</span></a>
<a class="sourceLine" id="orgb7517e4-30" title="30"><span class="co">            Function used to determine the exact shape of the distribution&#39;s</span></a>
<a class="sourceLine" id="orgb7517e4-31" title="31"><span class="co">            support.</span></a>
<a class="sourceLine" id="orgb7517e4-32" title="32"></a>
<a class="sourceLine" id="orgb7517e4-33" title="33"><span class="co">            It must take arguments ndim_supp, ndims_params, dist_params</span></a>
<a class="sourceLine" id="orgb7517e4-34" title="34"><span class="co">            (i.e. an collection of the distribution parameters) and an</span></a>
<a class="sourceLine" id="orgb7517e4-35" title="35"><span class="co">            optional param_shapes (i.e. tuples containing the size of each</span></a>
<a class="sourceLine" id="orgb7517e4-36" title="36"><span class="co">            dimension for each distribution parameter).</span></a>
<a class="sourceLine" id="orgb7517e4-37" title="37"></a>
<a class="sourceLine" id="orgb7517e4-38" title="38"><span class="co">            Defaults to `param_supp_shape_fn`.</span></a>
<a class="sourceLine" id="orgb7517e4-39" title="39"><span class="co">        inplace: boolean</span></a>
<a class="sourceLine" id="orgb7517e4-40" title="40"><span class="co">            Determine whether or not the underlying rng state is updated in-place or</span></a>
<a class="sourceLine" id="orgb7517e4-41" title="41"><span class="co">            not (i.e. copied).</span></a>
<a class="sourceLine" id="orgb7517e4-42" title="42"><span class="co">        &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="orgb7517e4-43" title="43">        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">*</span>args, <span class="op">**</span>kwargs)</a>
<a class="sourceLine" id="orgb7517e4-44" title="44"></a>
<a class="sourceLine" id="orgb7517e4-45" title="45">        <span class="va">self</span>.name <span class="op">=</span> name</a>
<a class="sourceLine" id="orgb7517e4-46" title="46">        <span class="va">self</span>.ndim_supp <span class="op">=</span> ndim_supp</a>
<a class="sourceLine" id="orgb7517e4-47" title="47">        <span class="va">self</span>.dtype <span class="op">=</span> dtype</a>
<a class="sourceLine" id="orgb7517e4-48" title="48">        <span class="va">self</span>.supp_shape_fn <span class="op">=</span> supp_shape_fn</a>
<a class="sourceLine" id="orgb7517e4-49" title="49">        <span class="va">self</span>.inplace <span class="op">=</span> inplace</a>
<a class="sourceLine" id="orgb7517e4-50" title="50"></a>
<a class="sourceLine" id="orgb7517e4-51" title="51">        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(ndims_params, Iterable):</a>
<a class="sourceLine" id="orgb7517e4-52" title="52">            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&#39;Parameter ndims_params must be iterable.&#39;</span>)</a>
<a class="sourceLine" id="orgb7517e4-53" title="53"></a>
<a class="sourceLine" id="orgb7517e4-54" title="54">        <span class="va">self</span>.ndims_params <span class="op">=</span> <span class="bu">tuple</span>(ndims_params)</a>
<a class="sourceLine" id="orgb7517e4-55" title="55"></a>
<a class="sourceLine" id="orgb7517e4-56" title="56">        <span class="va">self</span>.default_output <span class="op">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="orgb7517e4-57" title="57"></a>
<a class="sourceLine" id="orgb7517e4-58" title="58">        <span class="cf">if</span> <span class="bu">isinstance</span>(rng_fn, (<span class="bu">str</span>, ByteString)):</a>
<a class="sourceLine" id="orgb7517e4-59" title="59">            <span class="va">self</span>.rng_fn <span class="op">=</span> <span class="bu">getattr</span>(np.random.RandomState, rng_fn)</a>
<a class="sourceLine" id="orgb7517e4-60" title="60">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="orgb7517e4-61" title="61">            <span class="va">self</span>.rng_fn <span class="op">=</span> rng_fn</a>
<a class="sourceLine" id="orgb7517e4-62" title="62"></a>
<a class="sourceLine" id="orgb7517e4-63" title="63">    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="orgb7517e4-64" title="64">        <span class="cf">return</span> <span class="st">&#39;</span><span class="sc">{}</span><span class="st">_rv&#39;</span>.<span class="bu">format</span>(<span class="va">self</span>.name)</a>
<a class="sourceLine" id="orgb7517e4-65" title="65"></a>
<a class="sourceLine" id="orgb7517e4-66" title="66">    <span class="kw">def</span> _infer_shape(<span class="va">self</span>, size, dist_params, param_shapes<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="orgb7517e4-67" title="67">        <span class="co">&quot;&quot;&quot;Compute shapes and broadcasts properties.</span></a>
<a class="sourceLine" id="orgb7517e4-68" title="68"></a>
<a class="sourceLine" id="orgb7517e4-69" title="69"><span class="co">        Inspired by `tt.add.get_output_info`.</span></a>
<a class="sourceLine" id="orgb7517e4-70" title="70"><span class="co">        &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="orgb7517e4-71" title="71"></a>
<a class="sourceLine" id="orgb7517e4-72" title="72">        size_len <span class="op">=</span> tt.get_vector_length(size)</a>
<a class="sourceLine" id="orgb7517e4-73" title="73"></a>
<a class="sourceLine" id="orgb7517e4-74" title="74">        dummy_params <span class="op">=</span> <span class="bu">tuple</span>(p <span class="cf">if</span> n <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> tt.ones(<span class="bu">tuple</span>(p.shape)[:<span class="op">-</span>n])</a>
<a class="sourceLine" id="orgb7517e4-75" title="75">                             <span class="cf">for</span> p, n <span class="kw">in</span> <span class="bu">zip</span>(dist_params, <span class="va">self</span>.ndims_params))</a>
<a class="sourceLine" id="orgb7517e4-76" title="76"></a>
<a class="sourceLine" id="orgb7517e4-77" title="77">        _, out_bcasts, bcastd_inputs <span class="op">=</span> tt.add.get_output_info(</a>
<a class="sourceLine" id="orgb7517e4-78" title="78">            tt.DimShuffle, <span class="op">*</span>dummy_params)</a>
<a class="sourceLine" id="orgb7517e4-79" title="79"></a>
<a class="sourceLine" id="orgb7517e4-80" title="80">        <span class="co"># _, out_bcasts, bcastd_inputs = tt.add.get_output_info(tt.DimShuffle, *dist_params)</span></a>
<a class="sourceLine" id="orgb7517e4-81" title="81"></a>
<a class="sourceLine" id="orgb7517e4-82" title="82">        bcast_ind, <span class="op">=</span> out_bcasts</a>
<a class="sourceLine" id="orgb7517e4-83" title="83">        ndim_ind <span class="op">=</span> <span class="bu">len</span>(bcast_ind)</a>
<a class="sourceLine" id="orgb7517e4-84" title="84">        shape_ind <span class="op">=</span> bcastd_inputs[<span class="dv">0</span>].shape</a>
<a class="sourceLine" id="orgb7517e4-85" title="85"></a>
<a class="sourceLine" id="orgb7517e4-86" title="86">        <span class="cf">if</span> <span class="va">self</span>.ndim_supp <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="orgb7517e4-87" title="87">            shape_supp <span class="op">=</span> <span class="bu">tuple</span>()</a>
<a class="sourceLine" id="orgb7517e4-88" title="88"></a>
<a class="sourceLine" id="orgb7517e4-89" title="89">            <span class="co"># In the scalar case, `size` corresponds to the entire result&#39;s</span></a>
<a class="sourceLine" id="orgb7517e4-90" title="90">            <span class="co"># shape. This implies the following:</span></a>
<a class="sourceLine" id="orgb7517e4-91" title="91">            <span class="co">#     shape_ind[-ndim_ind] == size[:ndim_ind]</span></a>
<a class="sourceLine" id="orgb7517e4-92" title="92">            <span class="co"># </span><span class="al">TODO</span><span class="co">: How do we add this constraint/check symbolically?</span></a>
<a class="sourceLine" id="orgb7517e4-93" title="93"></a>
<a class="sourceLine" id="orgb7517e4-94" title="94">            ndim_reps <span class="op">=</span> <span class="bu">max</span>(size_len <span class="op">-</span> ndim_ind, <span class="dv">0</span>)</a>
<a class="sourceLine" id="orgb7517e4-95" title="95">            shape_reps <span class="op">=</span> <span class="bu">tuple</span>(size)[ndim_ind:]</a>
<a class="sourceLine" id="orgb7517e4-96" title="96">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="orgb7517e4-97" title="97">            shape_supp <span class="op">=</span> <span class="va">self</span>.supp_shape_fn(<span class="va">self</span>.ndim_supp,</a>
<a class="sourceLine" id="orgb7517e4-98" title="98">                                            <span class="va">self</span>.ndims_params,</a>
<a class="sourceLine" id="orgb7517e4-99" title="99">                                            dist_params,</a>
<a class="sourceLine" id="orgb7517e4-100" title="100">                                            param_shapes<span class="op">=</span>param_shapes)</a>
<a class="sourceLine" id="orgb7517e4-101" title="101"></a>
<a class="sourceLine" id="orgb7517e4-102" title="102">            ndim_reps <span class="op">=</span> size_len</a>
<a class="sourceLine" id="orgb7517e4-103" title="103">            shape_reps <span class="op">=</span> size</a>
<a class="sourceLine" id="orgb7517e4-104" title="104"></a>
<a class="sourceLine" id="orgb7517e4-105" title="105">        ndim_shape <span class="op">=</span> <span class="va">self</span>.ndim_supp <span class="op">+</span> ndim_ind <span class="op">+</span> ndim_reps</a>
<a class="sourceLine" id="orgb7517e4-106" title="106"></a>
<a class="sourceLine" id="orgb7517e4-107" title="107">        <span class="cf">if</span> ndim_shape <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="orgb7517e4-108" title="108">            shape <span class="op">=</span> tt.constant([], dtype<span class="op">=</span><span class="st">&#39;int64&#39;</span>)</a>
<a class="sourceLine" id="orgb7517e4-109" title="109">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="orgb7517e4-110" title="110">            shape <span class="op">=</span> <span class="bu">tuple</span>(shape_reps) <span class="op">+</span> <span class="bu">tuple</span>(shape_ind) <span class="op">+</span> <span class="bu">tuple</span>(shape_supp)</a>
<a class="sourceLine" id="orgb7517e4-111" title="111"></a>
<a class="sourceLine" id="orgb7517e4-112" title="112">        <span class="co"># if shape is None:</span></a>
<a class="sourceLine" id="orgb7517e4-113" title="113">        <span class="co">#     raise tt.ShapeError()</span></a>
<a class="sourceLine" id="orgb7517e4-114" title="114"></a>
<a class="sourceLine" id="orgb7517e4-115" title="115">        <span class="cf">return</span> shape</a>
<a class="sourceLine" id="orgb7517e4-116" title="116"></a>
<a class="sourceLine" id="orgb7517e4-117" title="117">    <span class="kw">def</span> compute_bcast(<span class="va">self</span>, dist_params, size):</a>
<a class="sourceLine" id="orgb7517e4-118" title="118">        <span class="co">&quot;&quot;&quot;Compute the broadcast array for this distribution&#39;s `TensorType`.</span></a>
<a class="sourceLine" id="orgb7517e4-119" title="119"></a>
<a class="sourceLine" id="orgb7517e4-120" title="120"><span class="co">        Parameters</span></a>
<a class="sourceLine" id="orgb7517e4-121" title="121"><span class="co">        ==========</span></a>
<a class="sourceLine" id="orgb7517e4-122" title="122"><span class="co">        dist_params: list</span></a>
<a class="sourceLine" id="orgb7517e4-123" title="123"><span class="co">            Distribution parameters.</span></a>
<a class="sourceLine" id="orgb7517e4-124" title="124"><span class="co">        size: int or Iterable (optional)</span></a>
<a class="sourceLine" id="orgb7517e4-125" title="125"><span class="co">            Numpy-like size of the output (i.e. replications).</span></a>
<a class="sourceLine" id="orgb7517e4-126" title="126"><span class="co">        &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="orgb7517e4-127" title="127">        shape <span class="op">=</span> <span class="va">self</span>._infer_shape(size, dist_params)</a>
<a class="sourceLine" id="orgb7517e4-128" title="128"></a>
<a class="sourceLine" id="orgb7517e4-129" title="129">        <span class="co"># Let&#39;s try to do a better job than `_infer_ndim_bcast` when</span></a>
<a class="sourceLine" id="orgb7517e4-130" title="130">        <span class="co"># dimension sizes are symbolic.</span></a>
<a class="sourceLine" id="orgb7517e4-131" title="131">        bcast <span class="op">=</span> []</a>
<a class="sourceLine" id="orgb7517e4-132" title="132">        <span class="cf">for</span> s <span class="kw">in</span> shape:</a>
<a class="sourceLine" id="orgb7517e4-133" title="133">            <span class="cf">try</span>:</a>
<a class="sourceLine" id="orgb7517e4-134" title="134">                <span class="cf">if</span> <span class="bu">isinstance</span>(s.owner.op, tt.Subtensor) <span class="kw">and</span> <span class="op">\</span></a>
<a class="sourceLine" id="orgb7517e4-135" title="135">                   s.owner.inputs[<span class="dv">0</span>].owner <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="orgb7517e4-136" title="136">                    <span class="co"># Handle a special case in which</span></a>
<a class="sourceLine" id="orgb7517e4-137" title="137">                    <span class="co"># `tensor.get_scalar_constant_value` doesn&#39;t really work.</span></a>
<a class="sourceLine" id="orgb7517e4-138" title="138">                    s_x, s_idx <span class="op">=</span> s.owner.inputs</a>
<a class="sourceLine" id="orgb7517e4-139" title="139">                    s_idx <span class="op">=</span> tt.get_scalar_constant_value(s_idx)</a>
<a class="sourceLine" id="orgb7517e4-140" title="140">                    <span class="cf">if</span> <span class="bu">isinstance</span>(s_x.owner.op, tt.Shape):</a>
<a class="sourceLine" id="orgb7517e4-141" title="141">                        x_obj, <span class="op">=</span> s_x.owner.inputs</a>
<a class="sourceLine" id="orgb7517e4-142" title="142">                        s_val <span class="op">=</span> x_obj.<span class="bu">type</span>.broadcastable[s_idx]</a>
<a class="sourceLine" id="orgb7517e4-143" title="143">                    <span class="cf">else</span>:</a>
<a class="sourceLine" id="orgb7517e4-144" title="144">                        <span class="co"># </span><span class="al">TODO</span><span class="co">: Could go for an existing broadcastable here, too, no?</span></a>
<a class="sourceLine" id="orgb7517e4-145" title="145">                        s_val <span class="op">=</span> <span class="va">False</span></a>
<a class="sourceLine" id="orgb7517e4-146" title="146">                <span class="cf">else</span>:</a>
<a class="sourceLine" id="orgb7517e4-147" title="147">                    s_val <span class="op">=</span> tt.get_scalar_constant_value(s)</a>
<a class="sourceLine" id="orgb7517e4-148" title="148">            <span class="cf">except</span> tt.NotScalarConstantError:</a>
<a class="sourceLine" id="orgb7517e4-149" title="149">                s_val <span class="op">=</span> <span class="va">False</span></a>
<a class="sourceLine" id="orgb7517e4-150" title="150"></a>
<a class="sourceLine" id="orgb7517e4-151" title="151">            bcast <span class="op">+=</span> [s_val <span class="op">==</span> <span class="dv">1</span>]</a>
<a class="sourceLine" id="orgb7517e4-152" title="152">        <span class="cf">return</span> bcast</a>
<a class="sourceLine" id="orgb7517e4-153" title="153"></a>
<a class="sourceLine" id="orgb7517e4-154" title="154">    <span class="kw">def</span> infer_shape(<span class="va">self</span>, node, input_shapes):</a>
<a class="sourceLine" id="orgb7517e4-155" title="155">        size <span class="op">=</span> node.inputs[<span class="op">-</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="orgb7517e4-156" title="156">        dist_params <span class="op">=</span> <span class="bu">tuple</span>(node.inputs[:<span class="op">-</span><span class="dv">2</span>])</a>
<a class="sourceLine" id="orgb7517e4-157" title="157">        shape <span class="op">=</span> <span class="va">self</span>._infer_shape(size, dist_params,</a>
<a class="sourceLine" id="orgb7517e4-158" title="158">                                  param_shapes<span class="op">=</span>input_shapes[:<span class="op">-</span><span class="dv">2</span>])</a>
<a class="sourceLine" id="orgb7517e4-159" title="159"></a>
<a class="sourceLine" id="orgb7517e4-160" title="160">        <span class="cf">return</span> [<span class="va">None</span>, [s <span class="cf">for</span> s <span class="kw">in</span> shape]]</a>
<a class="sourceLine" id="orgb7517e4-161" title="161"></a>
<a class="sourceLine" id="orgb7517e4-162" title="162">    <span class="kw">def</span> make_node(<span class="va">self</span>, <span class="op">*</span>dist_params, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="orgb7517e4-163" title="163">        <span class="co">&quot;&quot;&quot;Create a random variable node.</span></a>
<a class="sourceLine" id="orgb7517e4-164" title="164"></a>
<a class="sourceLine" id="orgb7517e4-165" title="165"><span class="co">        XXX: Unnamed/non-keyword arguments are considered distribution</span></a>
<a class="sourceLine" id="orgb7517e4-166" title="166"><span class="co">        parameters!  If you want to set `size`, `rng`, and/or `name`, use their</span></a>
<a class="sourceLine" id="orgb7517e4-167" title="167"><span class="co">        keywords.</span></a>
<a class="sourceLine" id="orgb7517e4-168" title="168"></a>
<a class="sourceLine" id="orgb7517e4-169" title="169"><span class="co">        Parameters</span></a>
<a class="sourceLine" id="orgb7517e4-170" title="170"><span class="co">        ==========</span></a>
<a class="sourceLine" id="orgb7517e4-171" title="171"><span class="co">        dist_params: list</span></a>
<a class="sourceLine" id="orgb7517e4-172" title="172"><span class="co">            Distribution parameters.</span></a>
<a class="sourceLine" id="orgb7517e4-173" title="173"><span class="co">        size: int or Iterable (optional)</span></a>
<a class="sourceLine" id="orgb7517e4-174" title="174"><span class="co">            Numpy-like size of the output (i.e. replications).</span></a>
<a class="sourceLine" id="orgb7517e4-175" title="175"><span class="co">        rng: RandomState (optional)</span></a>
<a class="sourceLine" id="orgb7517e4-176" title="176"><span class="co">            Existing Theano `RandomState` object to be used.  Creates a</span></a>
<a class="sourceLine" id="orgb7517e4-177" title="177"><span class="co">            new one, if `None`.</span></a>
<a class="sourceLine" id="orgb7517e4-178" title="178"><span class="co">        name: str (optional)</span></a>
<a class="sourceLine" id="orgb7517e4-179" title="179"><span class="co">            Label for the resulting node.</span></a>
<a class="sourceLine" id="orgb7517e4-180" title="180"></a>
<a class="sourceLine" id="orgb7517e4-181" title="181"><span class="co">        Results</span></a>
<a class="sourceLine" id="orgb7517e4-182" title="182"><span class="co">        =======</span></a>
<a class="sourceLine" id="orgb7517e4-183" title="183"><span class="co">        out: `Apply`</span></a>
<a class="sourceLine" id="orgb7517e4-184" title="184"><span class="co">            A node with inputs `dist_args + (size, in_rng, name)` and outputs</span></a>
<a class="sourceLine" id="orgb7517e4-185" title="185"><span class="co">            `(out_rng, sample_tensorvar)`.</span></a>
<a class="sourceLine" id="orgb7517e4-186" title="186"><span class="co">        &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="orgb7517e4-187" title="187">        <span class="cf">if</span> size <span class="kw">is</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="orgb7517e4-188" title="188">            size <span class="op">=</span> tt.constant([], dtype<span class="op">=</span><span class="st">&#39;int64&#39;</span>)</a>
<a class="sourceLine" id="orgb7517e4-189" title="189">        <span class="cf">elif</span> <span class="bu">isinstance</span>(size, <span class="bu">int</span>):</a>
<a class="sourceLine" id="orgb7517e4-190" title="190">            size <span class="op">=</span> tt.as_tensor_variable([size], ndim<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="orgb7517e4-191" title="191">        <span class="cf">elif</span> <span class="kw">not</span> <span class="bu">isinstance</span>(size, Iterable):</a>
<a class="sourceLine" id="orgb7517e4-192" title="192">            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&#39;Parameter size must be None, int, or an iterable with ints.&#39;</span>)</a>
<a class="sourceLine" id="orgb7517e4-193" title="193">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="orgb7517e4-194" title="194">            size <span class="op">=</span> tt.as_tensor_variable(size, ndim<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="orgb7517e4-195" title="195"></a>
<a class="sourceLine" id="orgb7517e4-196" title="196">        <span class="cf">assert</span> size.dtype <span class="kw">in</span> tt.int_dtypes</a>
<a class="sourceLine" id="orgb7517e4-197" title="197"></a>
<a class="sourceLine" id="orgb7517e4-198" title="198">        dist_params <span class="op">=</span> <span class="bu">tuple</span>(tt.as_tensor_variable(p)</a>
<a class="sourceLine" id="orgb7517e4-199" title="199">                            <span class="cf">for</span> p <span class="kw">in</span> dist_params)</a>
<a class="sourceLine" id="orgb7517e4-200" title="200"></a>
<a class="sourceLine" id="orgb7517e4-201" title="201">        <span class="cf">if</span> rng <span class="kw">is</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="orgb7517e4-202" title="202">            rng <span class="op">=</span> theano.shared(np.random.RandomState())</a>
<a class="sourceLine" id="orgb7517e4-203" title="203">        <span class="cf">elif</span> <span class="kw">not</span> <span class="bu">isinstance</span>(rng.<span class="bu">type</span>, RandomStateType):</a>
<a class="sourceLine" id="orgb7517e4-204" title="204">            warn(<span class="st">&#39;The type of rng should be an instance of RandomStateType&#39;</span>)</a>
<a class="sourceLine" id="orgb7517e4-205" title="205"></a>
<a class="sourceLine" id="orgb7517e4-206" title="206">        bcast <span class="op">=</span> <span class="va">self</span>.compute_bcast(dist_params, size)</a>
<a class="sourceLine" id="orgb7517e4-207" title="207"></a>
<a class="sourceLine" id="orgb7517e4-208" title="208">        <span class="co"># dtype = tt.scal.upcast(self.dtype, *[p.dtype for p in dist_params])</span></a>
<a class="sourceLine" id="orgb7517e4-209" title="209"></a>
<a class="sourceLine" id="orgb7517e4-210" title="210">        outtype <span class="op">=</span> tt.TensorType(dtype<span class="op">=</span><span class="va">self</span>.dtype, broadcastable<span class="op">=</span>bcast)</a>
<a class="sourceLine" id="orgb7517e4-211" title="211">        out_var <span class="op">=</span> outtype(name<span class="op">=</span>name)</a>
<a class="sourceLine" id="orgb7517e4-212" title="212">        inputs <span class="op">=</span> dist_params <span class="op">+</span> (size, rng)</a>
<a class="sourceLine" id="orgb7517e4-213" title="213">        outputs <span class="op">=</span> (rng.<span class="bu">type</span>(), out_var)</a>
<a class="sourceLine" id="orgb7517e4-214" title="214"></a>
<a class="sourceLine" id="orgb7517e4-215" title="215">        <span class="cf">return</span> theano.gof.Apply(<span class="va">self</span>, inputs, outputs)</a>
<a class="sourceLine" id="orgb7517e4-216" title="216"></a>
<a class="sourceLine" id="orgb7517e4-217" title="217">    <span class="kw">def</span> perform(<span class="va">self</span>, node, inputs, outputs):</a>
<a class="sourceLine" id="orgb7517e4-218" title="218">        <span class="co">&quot;&quot;&quot;Draw samples using Numpy/SciPy.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="orgb7517e4-219" title="219">        rng_out, smpl_out <span class="op">=</span> outputs</a>
<a class="sourceLine" id="orgb7517e4-220" title="220"></a>
<a class="sourceLine" id="orgb7517e4-221" title="221">        <span class="co"># Draw from `rng` if `self.inplace` is `True`, and from a copy of `rng`</span></a>
<a class="sourceLine" id="orgb7517e4-222" title="222">        <span class="co"># otherwise.</span></a>
<a class="sourceLine" id="orgb7517e4-223" title="223">        args <span class="op">=</span> <span class="bu">list</span>(inputs)</a>
<a class="sourceLine" id="orgb7517e4-224" title="224">        rng <span class="op">=</span> args.pop()</a>
<a class="sourceLine" id="orgb7517e4-225" title="225">        size <span class="op">=</span> args.pop()</a>
<a class="sourceLine" id="orgb7517e4-226" title="226"></a>
<a class="sourceLine" id="orgb7517e4-227" title="227">        <span class="cf">assert</span> <span class="bu">isinstance</span>(rng, np.random.RandomState), (<span class="bu">type</span>(rng), rng)</a>
<a class="sourceLine" id="orgb7517e4-228" title="228"></a>
<a class="sourceLine" id="orgb7517e4-229" title="229">        rng_out[<span class="dv">0</span>] <span class="op">=</span> rng</a>
<a class="sourceLine" id="orgb7517e4-230" title="230"></a>
<a class="sourceLine" id="orgb7517e4-231" title="231">        <span class="co"># The symbolic output variable corresponding to value produced here.</span></a>
<a class="sourceLine" id="orgb7517e4-232" title="232">        out_var <span class="op">=</span> node.outputs[<span class="dv">1</span>]</a>
<a class="sourceLine" id="orgb7517e4-233" title="233"></a>
<a class="sourceLine" id="orgb7517e4-234" title="234">        <span class="co"># If `size == []`, that means no size is enforced, and NumPy is</span></a>
<a class="sourceLine" id="orgb7517e4-235" title="235">        <span class="co"># trusted to draw the appropriate number of samples, NumPy uses</span></a>
<a class="sourceLine" id="orgb7517e4-236" title="236">        <span class="co"># `size=None` to represent that.  Otherwise, NumPy expects a tuple.</span></a>
<a class="sourceLine" id="orgb7517e4-237" title="237">        <span class="cf">if</span> np.size(size) <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="orgb7517e4-238" title="238">            size <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="orgb7517e4-239" title="239">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="orgb7517e4-240" title="240">            size <span class="op">=</span> <span class="bu">tuple</span>(size)</a>
<a class="sourceLine" id="orgb7517e4-241" title="241"></a>
<a class="sourceLine" id="orgb7517e4-242" title="242">        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.inplace:</a>
<a class="sourceLine" id="orgb7517e4-243" title="243">            rng <span class="op">=</span> copy(rng)</a>
<a class="sourceLine" id="orgb7517e4-244" title="244"></a>
<a class="sourceLine" id="orgb7517e4-245" title="245">        smpl_val <span class="op">=</span> <span class="va">self</span>.rng_fn(rng, <span class="op">*</span>(args <span class="op">+</span> [size]))</a>
<a class="sourceLine" id="orgb7517e4-246" title="246"></a>
<a class="sourceLine" id="orgb7517e4-247" title="247">        <span class="cf">if</span> (<span class="kw">not</span> <span class="bu">isinstance</span>(smpl_val, np.ndarray) <span class="kw">or</span></a>
<a class="sourceLine" id="orgb7517e4-248" title="248">            <span class="bu">str</span>(smpl_val.dtype) <span class="op">!=</span> out_var.<span class="bu">type</span>.dtype):</a>
<a class="sourceLine" id="orgb7517e4-249" title="249">            smpl_val <span class="op">=</span> theano._asarray(smpl_val, dtype<span class="op">=</span>out_var.<span class="bu">type</span>.dtype)</a>
<a class="sourceLine" id="orgb7517e4-250" title="250"></a>
<a class="sourceLine" id="orgb7517e4-251" title="251">        <span class="co"># When `size` is `None`, NumPy has a tendency to unexpectedly</span></a>
<a class="sourceLine" id="orgb7517e4-252" title="252">        <span class="co"># return a scalar instead of a higher-dimension array containing</span></a>
<a class="sourceLine" id="orgb7517e4-253" title="253">        <span class="co"># only one element. This value should be reshaped</span></a>
<a class="sourceLine" id="orgb7517e4-254" title="254">        <span class="co"># </span><span class="al">TODO</span><span class="co">: Really?  Why shouldn&#39;t the output correctly correspond to</span></a>
<a class="sourceLine" id="orgb7517e4-255" title="255">        <span class="co"># the returned NumPy value?  Sounds more like a mis-specification of</span></a>
<a class="sourceLine" id="orgb7517e4-256" title="256">        <span class="co"># the symbolic output variable.</span></a>
<a class="sourceLine" id="orgb7517e4-257" title="257">        <span class="cf">if</span> size <span class="kw">is</span> <span class="va">None</span> <span class="kw">and</span> smpl_val.ndim <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> out_var.ndim <span class="op">&gt;</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="orgb7517e4-258" title="258">            smpl_val <span class="op">=</span> smpl_val.reshape([<span class="dv">1</span>] <span class="op">*</span> out_var.ndim)</a>
<a class="sourceLine" id="orgb7517e4-259" title="259"></a>
<a class="sourceLine" id="orgb7517e4-260" title="260">        smpl_out[<span class="dv">0</span>] <span class="op">=</span> smpl_val</a>
<a class="sourceLine" id="orgb7517e4-261" title="261"></a>
<a class="sourceLine" id="orgb7517e4-262" title="262">    <span class="kw">def</span> grad(<span class="va">self</span>, inputs, outputs):</a>
<a class="sourceLine" id="orgb7517e4-263" title="263">        <span class="cf">return</span> [theano.gradient.grad_undefined(<span class="va">self</span>, k, inp,</a>
<a class="sourceLine" id="orgb7517e4-264" title="264">                                               <span class="st">&#39;No gradient defined through raw random numbers op&#39;</span>)</a>
<a class="sourceLine" id="orgb7517e4-265" title="265">                <span class="cf">for</span> k, inp <span class="kw">in</span> <span class="bu">enumerate</span>(inputs)]</a>
<a class="sourceLine" id="orgb7517e4-266" title="266"></a>
<a class="sourceLine" id="orgb7517e4-267" title="267">    <span class="kw">def</span> R_op(<span class="va">self</span>, inputs, eval_points):</a>
<a class="sourceLine" id="orgb7517e4-268" title="268">        <span class="cf">return</span> [<span class="va">None</span> <span class="cf">for</span> i <span class="kw">in</span> eval_points]</a></code></pre></div>
</section>
<section id="using-randomvariable" class="level1">
<h1>Using <code>RandomVariable</code></h1>
<p>In Listing <a href="#orgf494cec">17</a> we create some <code>RandomVariable</code> <code>Op</code>s.</p>
<div class="sourceCode" id="orgf494cec"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgf494cec-1" title="1"><span class="im">import</span> scipy</a>
<a class="sourceLine" id="orgf494cec-2" title="2"><span class="im">from</span> functools <span class="im">import</span> partial</a>
<a class="sourceLine" id="orgf494cec-3" title="3"></a>
<a class="sourceLine" id="orgf494cec-4" title="4"></a>
<a class="sourceLine" id="orgf494cec-5" title="5"><span class="co"># Continuous Numpy-generated variates</span></a>
<a class="sourceLine" id="orgf494cec-6" title="6"><span class="kw">class</span> UniformRVType(RandomVariable):</a>
<a class="sourceLine" id="orgf494cec-7" title="7">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="orgf494cec-8" title="8">        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;uniform&#39;</span>, theano.config.floatX, <span class="dv">0</span>, [<span class="dv">0</span>, <span class="dv">0</span>], <span class="st">&#39;uniform&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="orgf494cec-9" title="9"></a>
<a class="sourceLine" id="orgf494cec-10" title="10">    <span class="kw">def</span> make_node(<span class="va">self</span>, lower, upper, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="orgf494cec-11" title="11">        <span class="cf">return</span> <span class="bu">super</span>().make_node(lower, upper, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</a>
<a class="sourceLine" id="orgf494cec-12" title="12"></a>
<a class="sourceLine" id="orgf494cec-13" title="13">UniformRV <span class="op">=</span> UniformRVType()</a>
<a class="sourceLine" id="orgf494cec-14" title="14"></a>
<a class="sourceLine" id="orgf494cec-15" title="15"></a>
<a class="sourceLine" id="orgf494cec-16" title="16"><span class="kw">class</span> NormalRVType(RandomVariable):</a>
<a class="sourceLine" id="orgf494cec-17" title="17">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="orgf494cec-18" title="18">        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;normal&#39;</span>, theano.config.floatX, <span class="dv">0</span>, [<span class="dv">0</span>, <span class="dv">0</span>], <span class="st">&#39;normal&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="orgf494cec-19" title="19"></a>
<a class="sourceLine" id="orgf494cec-20" title="20">    <span class="kw">def</span> make_node(<span class="va">self</span>, mu, sigma, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="orgf494cec-21" title="21">        <span class="cf">return</span> <span class="bu">super</span>().make_node(mu, sigma, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</a>
<a class="sourceLine" id="orgf494cec-22" title="22"></a>
<a class="sourceLine" id="orgf494cec-23" title="23"></a>
<a class="sourceLine" id="orgf494cec-24" title="24">NormalRV <span class="op">=</span> NormalRVType()</a>
<a class="sourceLine" id="orgf494cec-25" title="25"></a>
<a class="sourceLine" id="orgf494cec-26" title="26"></a>
<a class="sourceLine" id="orgf494cec-27" title="27"><span class="kw">class</span> GammaRVType(RandomVariable):</a>
<a class="sourceLine" id="orgf494cec-28" title="28">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="orgf494cec-29" title="29">        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;gamma&#39;</span>, theano.config.floatX, <span class="dv">0</span>, [<span class="dv">0</span>, <span class="dv">0</span>], <span class="st">&#39;gamma&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="orgf494cec-30" title="30"></a>
<a class="sourceLine" id="orgf494cec-31" title="31">    <span class="kw">def</span> make_node(<span class="va">self</span>, shape, scale, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="orgf494cec-32" title="32">        <span class="cf">return</span> <span class="bu">super</span>().make_node(shape, scale, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</a>
<a class="sourceLine" id="orgf494cec-33" title="33"></a>
<a class="sourceLine" id="orgf494cec-34" title="34"></a>
<a class="sourceLine" id="orgf494cec-35" title="35">GammaRV <span class="op">=</span> GammaRVType()</a>
<a class="sourceLine" id="orgf494cec-36" title="36"></a>
<a class="sourceLine" id="orgf494cec-37" title="37"></a>
<a class="sourceLine" id="orgf494cec-38" title="38"><span class="kw">class</span> ExponentialRVType(RandomVariable):</a>
<a class="sourceLine" id="orgf494cec-39" title="39">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="orgf494cec-40" title="40">        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;exponential&#39;</span>, theano.config.floatX, <span class="dv">0</span>, [<span class="dv">0</span>], <span class="st">&#39;exponential&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="orgf494cec-41" title="41"></a>
<a class="sourceLine" id="orgf494cec-42" title="42">    <span class="kw">def</span> make_node(<span class="va">self</span>, scale, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="orgf494cec-43" title="43">        <span class="cf">return</span> <span class="bu">super</span>().make_node(scale, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</a>
<a class="sourceLine" id="orgf494cec-44" title="44"></a>
<a class="sourceLine" id="orgf494cec-45" title="45"></a>
<a class="sourceLine" id="orgf494cec-46" title="46">ExponentialRV <span class="op">=</span> ExponentialRVType()</a>
<a class="sourceLine" id="orgf494cec-47" title="47"></a>
<a class="sourceLine" id="orgf494cec-48" title="48"></a>
<a class="sourceLine" id="orgf494cec-49" title="49"><span class="co"># One with multivariate support</span></a>
<a class="sourceLine" id="orgf494cec-50" title="50"><span class="kw">class</span> MvNormalRVType(RandomVariable):</a>
<a class="sourceLine" id="orgf494cec-51" title="51">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="orgf494cec-52" title="52">        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;multivariate_normal&#39;</span>, theano.config.floatX, <span class="dv">1</span>, [<span class="dv">1</span>, <span class="dv">2</span>], <span class="st">&#39;multivariate_normal&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="orgf494cec-53" title="53"></a>
<a class="sourceLine" id="orgf494cec-54" title="54">    <span class="kw">def</span> make_node(<span class="va">self</span>, mean, cov, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="orgf494cec-55" title="55">        <span class="cf">return</span> <span class="bu">super</span>().make_node(mean, cov, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</a>
<a class="sourceLine" id="orgf494cec-56" title="56"></a>
<a class="sourceLine" id="orgf494cec-57" title="57"></a>
<a class="sourceLine" id="orgf494cec-58" title="58">MvNormalRV <span class="op">=</span> MvNormalRVType()</a>
<a class="sourceLine" id="orgf494cec-59" title="59"></a>
<a class="sourceLine" id="orgf494cec-60" title="60"></a>
<a class="sourceLine" id="orgf494cec-61" title="61"><span class="kw">class</span> DirichletRVType(RandomVariable):</a>
<a class="sourceLine" id="orgf494cec-62" title="62">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="orgf494cec-63" title="63">        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;dirichlet&#39;</span>, theano.config.floatX, <span class="dv">1</span>, [<span class="dv">1</span>], <span class="st">&#39;dirichlet&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="orgf494cec-64" title="64"></a>
<a class="sourceLine" id="orgf494cec-65" title="65">    <span class="kw">def</span> make_node(<span class="va">self</span>, alpha, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="orgf494cec-66" title="66">        <span class="cf">return</span> <span class="bu">super</span>().make_node(alpha, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</a>
<a class="sourceLine" id="orgf494cec-67" title="67"></a>
<a class="sourceLine" id="orgf494cec-68" title="68"></a>
<a class="sourceLine" id="orgf494cec-69" title="69">DirichletRV <span class="op">=</span> DirichletRVType()</a>
<a class="sourceLine" id="orgf494cec-70" title="70"></a>
<a class="sourceLine" id="orgf494cec-71" title="71"></a>
<a class="sourceLine" id="orgf494cec-72" title="72"><span class="co"># A discrete Numpy-generated variate</span></a>
<a class="sourceLine" id="orgf494cec-73" title="73"><span class="kw">class</span> PoissonRVType(RandomVariable):</a>
<a class="sourceLine" id="orgf494cec-74" title="74">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="orgf494cec-75" title="75">        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;poisson&#39;</span>, <span class="st">&#39;int64&#39;</span>, <span class="dv">0</span>, [<span class="dv">0</span>], <span class="st">&#39;poisson&#39;</span>, inplace<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="orgf494cec-76" title="76"></a>
<a class="sourceLine" id="orgf494cec-77" title="77">    <span class="kw">def</span> make_node(<span class="va">self</span>, rate, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="orgf494cec-78" title="78">        <span class="cf">return</span> <span class="bu">super</span>().make_node(rate, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</a>
<a class="sourceLine" id="orgf494cec-79" title="79"></a>
<a class="sourceLine" id="orgf494cec-80" title="80"></a>
<a class="sourceLine" id="orgf494cec-81" title="81">PoissonRV <span class="op">=</span> PoissonRVType()</a>
<a class="sourceLine" id="orgf494cec-82" title="82"></a>
<a class="sourceLine" id="orgf494cec-83" title="83"></a>
<a class="sourceLine" id="orgf494cec-84" title="84"><span class="co"># A SciPy-generated variate</span></a>
<a class="sourceLine" id="orgf494cec-85" title="85"><span class="kw">class</span> CauchyRVType(RandomVariable):</a>
<a class="sourceLine" id="orgf494cec-86" title="86">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="orgf494cec-87" title="87">        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;cauchy&#39;</span>, theano.config.floatX, <span class="dv">0</span>, [<span class="dv">0</span>, <span class="dv">0</span>],</a>
<a class="sourceLine" id="orgf494cec-88" title="88">                         <span class="kw">lambda</span> rng, <span class="op">*</span>args: scipy.stats.cauchy.rvs(<span class="op">*</span>args, random_state<span class="op">=</span>rng),</a>
<a class="sourceLine" id="orgf494cec-89" title="89">                         inplace<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="orgf494cec-90" title="90"></a>
<a class="sourceLine" id="orgf494cec-91" title="91">    <span class="kw">def</span> make_node(<span class="va">self</span>, loc, scale, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="orgf494cec-92" title="92">        <span class="cf">return</span> <span class="bu">super</span>().make_node(loc, scale, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</a>
<a class="sourceLine" id="orgf494cec-93" title="93"></a>
<a class="sourceLine" id="orgf494cec-94" title="94"></a>
<a class="sourceLine" id="orgf494cec-95" title="95">CauchyRV <span class="op">=</span> CauchyRVType()</a>
<a class="sourceLine" id="orgf494cec-96" title="96"></a>
<a class="sourceLine" id="orgf494cec-97" title="97"></a>
<a class="sourceLine" id="orgf494cec-98" title="98"><span class="co"># Support shape is determined by the first dimension in the *second* parameter (i.e.</span></a>
<a class="sourceLine" id="orgf494cec-99" title="99"><span class="co"># the probabilities vector)</span></a>
<a class="sourceLine" id="orgf494cec-100" title="100"><span class="kw">class</span> MultinomialRVType(RandomVariable):</a>
<a class="sourceLine" id="orgf494cec-101" title="101">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="orgf494cec-102" title="102">        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="st">&#39;multinomial&#39;</span>, <span class="st">&#39;int64&#39;</span>, <span class="dv">1</span>, [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">&#39;multinomial&#39;</span>,</a>
<a class="sourceLine" id="orgf494cec-103" title="103">                         supp_shape_fn<span class="op">=</span>partial(param_supp_shape_fn, rep_param_idx<span class="op">=</span><span class="dv">1</span>),</a>
<a class="sourceLine" id="orgf494cec-104" title="104">                         inplace<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="orgf494cec-105" title="105"></a>
<a class="sourceLine" id="orgf494cec-106" title="106">    <span class="kw">def</span> make_node(<span class="va">self</span>, n, pvals, size<span class="op">=</span><span class="va">None</span>, rng<span class="op">=</span><span class="va">None</span>, name<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="orgf494cec-107" title="107">        <span class="cf">return</span> <span class="bu">super</span>().make_node(n, pvals, size<span class="op">=</span>size, rng<span class="op">=</span>rng, name<span class="op">=</span>name)</a>
<a class="sourceLine" id="orgf494cec-108" title="108"></a>
<a class="sourceLine" id="orgf494cec-109" title="109"></a>
<a class="sourceLine" id="orgf494cec-110" title="110">MultinomialRV <span class="op">=</span> MultinomialRVType()</a></code></pre></div>
<div class="example" data-markdown="">
<p>In Listing <a href="#orged59f09">18</a> we draw samples from instances of <code>RandomVariable</code>s.</p>
<div class="sourceCode" id="orged59f09"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orged59f09-1" title="1"><span class="bu">print</span>(<span class="st">&quot;UniformRV(0., 30., size=[10]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orged59f09-2" title="2">    UniformRV(<span class="fl">0.</span>, <span class="fl">30.</span>, size<span class="op">=</span>[<span class="dv">10</span>]).<span class="bu">eval</span>()</a>
<a class="sourceLine" id="orged59f09-3" title="3">))</a>
<a class="sourceLine" id="orged59f09-4" title="4"></a>
<a class="sourceLine" id="orged59f09-5" title="5"><span class="bu">print</span>(<span class="st">&quot;NormalRV([0., 100.], 30, size=[4, 2]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orged59f09-6" title="6">    NormalRV([<span class="fl">0.</span>, <span class="fl">100.</span>], <span class="dv">30</span>, size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]).<span class="bu">eval</span>()))</a>
<a class="sourceLine" id="orged59f09-7" title="7"></a>
<a class="sourceLine" id="orged59f09-8" title="8"><span class="bu">print</span>(<span class="st">&quot;GammaRV([2., 1.], 2., size=[4, 2]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orged59f09-9" title="9">    GammaRV([<span class="fl">2.</span>, <span class="fl">1.</span>], <span class="fl">2.</span>, size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]).<span class="bu">eval</span>()))</a>
<a class="sourceLine" id="orged59f09-10" title="10"></a>
<a class="sourceLine" id="orged59f09-11" title="11"><span class="bu">print</span>(<span class="st">&quot;ExponentialRV([2., 50.], size=[4, 2]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orged59f09-12" title="12">    ExponentialRV([<span class="fl">2.</span>, <span class="fl">50.</span>], size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]).<span class="bu">eval</span>()))</a>
<a class="sourceLine" id="orged59f09-13" title="13"></a>
<a class="sourceLine" id="orged59f09-14" title="14"><span class="bu">print</span>(<span class="st">&quot;MvNormalRV([0, 1e2, 2e3], np.diag([1, 1, 1]), size=[3, 2, 3]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orged59f09-15" title="15">    MvNormalRV([<span class="dv">0</span>, <span class="fl">1e2</span>, <span class="fl">2e3</span>], np.diag([<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>]), size<span class="op">=</span>[<span class="dv">2</span>, <span class="dv">3</span>]).<span class="bu">eval</span>()))</a>
<a class="sourceLine" id="orged59f09-16" title="16"></a>
<a class="sourceLine" id="orged59f09-17" title="17"><span class="bu">print</span>(<span class="st">&quot;DirichletRV([0.1, 10, 0.5], size=[3, 2, 3]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orged59f09-18" title="18">    DirichletRV([<span class="fl">0.1</span>, <span class="dv">10</span>, <span class="fl">0.5</span>], size<span class="op">=</span>[<span class="dv">2</span>, <span class="dv">3</span>]).<span class="bu">eval</span>()))</a>
<a class="sourceLine" id="orged59f09-19" title="19"></a>
<a class="sourceLine" id="orged59f09-20" title="20"><span class="bu">print</span>(<span class="st">&quot;PoissonRV([2., 1.], size=[4, 2]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orged59f09-21" title="21">    PoissonRV([<span class="fl">2.</span>, <span class="fl">15.</span>], size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]).<span class="bu">eval</span>()))</a>
<a class="sourceLine" id="orged59f09-22" title="22"></a>
<a class="sourceLine" id="orged59f09-23" title="23"><span class="bu">print</span>(<span class="st">&quot;CauchyRV([1., 100.], 30, size=[4, 2]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orged59f09-24" title="24">    CauchyRV([<span class="fl">1.</span>, <span class="fl">100.</span>], <span class="dv">30</span>, size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]).<span class="bu">eval</span>()))</a>
<a class="sourceLine" id="orged59f09-25" title="25"></a>
<a class="sourceLine" id="orged59f09-26" title="26"><span class="bu">print</span>(<span class="st">&quot;MultinomialRV(20, [1/6.]*6, size=[6, 2]):</span><span class="ch">\n</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orged59f09-27" title="27">    MultinomialRV(<span class="dv">20</span>, [<span class="dv">1</span> <span class="op">/</span> <span class="fl">6.</span>] <span class="op">*</span> <span class="dv">6</span>, size<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">2</span>]).<span class="bu">eval</span>()))</a></code></pre></div>
<div class="sourceCode" id="orgd754526"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgd754526-1" title="1">UniformRV(<span class="fl">0.</span>, <span class="fl">30.</span>, size<span class="op">=</span>[<span class="dv">10</span>]):</a>
<a class="sourceLine" id="orgd754526-2" title="2">[ <span class="fl">5.83131933</span> <span class="fl">28.56231204</span> <span class="fl">20.73018065</span> <span class="fl">17.21042461</span> <span class="fl">25.53140341</span> <span class="fl">23.76268637</span></a>
<a class="sourceLine" id="orgd754526-3" title="3"> <span class="fl">28.27629994</span>  <span class="fl">7.10457399</span> <span class="fl">19.88378878</span> <span class="fl">26.62382369</span>]</a>
<a class="sourceLine" id="orgd754526-4" title="4"></a>
<a class="sourceLine" id="orgd754526-5" title="5">NormalRV([<span class="fl">0.</span>, <span class="fl">100.</span>], <span class="dv">30</span>, size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]):</a>
<a class="sourceLine" id="orgd754526-6" title="6">[[  <span class="fl">0.73277898</span>  <span class="fl">98.26041204</span>]</a>
<a class="sourceLine" id="orgd754526-7" title="7"> [<span class="op">-</span><span class="fl">25.9810085</span>   <span class="fl">79.13385495</span>]</a>
<a class="sourceLine" id="orgd754526-8" title="8"> [<span class="op">-</span><span class="fl">23.17013683</span> <span class="fl">130.86966242</span>]</a>
<a class="sourceLine" id="orgd754526-9" title="9"> [<span class="op">-</span><span class="fl">52.83756722</span>  <span class="fl">95.21829178</span>]]</a>
<a class="sourceLine" id="orgd754526-10" title="10"></a>
<a class="sourceLine" id="orgd754526-11" title="11">GammaRV([<span class="fl">2.</span>, <span class="fl">1.</span>], <span class="fl">2.</span>, size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]):</a>
<a class="sourceLine" id="orgd754526-12" title="12">[[<span class="fl">5.09679154</span> <span class="fl">0.6149213</span> ]</a>
<a class="sourceLine" id="orgd754526-13" title="13"> [<span class="fl">2.64231927</span> <span class="fl">0.7277265</span> ]</a>
<a class="sourceLine" id="orgd754526-14" title="14"> [<span class="fl">5.98877316</span> <span class="fl">0.41751667</span>]</a>
<a class="sourceLine" id="orgd754526-15" title="15"> [<span class="fl">3.77525439</span> <span class="fl">1.11561567</span>]]</a>
<a class="sourceLine" id="orgd754526-16" title="16"></a>
<a class="sourceLine" id="orgd754526-17" title="17">ExponentialRV([<span class="fl">2.</span>, <span class="fl">50.</span>], size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]):</a>
<a class="sourceLine" id="orgd754526-18" title="18">[[ <span class="fl">2.29684191</span>  <span class="fl">7.12084933</span>]</a>
<a class="sourceLine" id="orgd754526-19" title="19"> [ <span class="fl">0.39386731</span> <span class="fl">38.79158981</span>]</a>
<a class="sourceLine" id="orgd754526-20" title="20"> [ <span class="fl">1.11400165</span>  <span class="fl">4.31175303</span>]</a>
<a class="sourceLine" id="orgd754526-21" title="21"> [ <span class="fl">1.50499115</span>  <span class="fl">9.65667649</span>]]</a>
<a class="sourceLine" id="orgd754526-22" title="22"></a>
<a class="sourceLine" id="orgd754526-23" title="23">MvNormalRV([<span class="dv">0</span>, <span class="fl">1e2</span>, <span class="fl">2e3</span>], np.diag([<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>]), size<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>]):</a>
<a class="sourceLine" id="orgd754526-24" title="24">[[[<span class="op">-</span><span class="fl">6.67447019e-01</span>  <span class="fl">9.88636435e+01</span>  <span class="fl">1.99973471e+03</span>]</a>
<a class="sourceLine" id="orgd754526-25" title="25">  [ <span class="fl">6.06351715e-01</span>  <span class="fl">9.96429347e+01</span>  <span class="fl">1.99915978e+03</span>]</a>
<a class="sourceLine" id="orgd754526-26" title="26">  [ <span class="fl">1.12246741e+00</span>  <span class="fl">9.96807860e+01</span>  <span class="fl">2.00201859e+03</span>]]</a>
<a class="sourceLine" id="orgd754526-27" title="27"></a>
<a class="sourceLine" id="orgd754526-28" title="28"> [[ <span class="fl">3.61931404e-02</span>  <span class="fl">9.89907880e+01</span>  <span class="fl">2.00036910e+03</span>]</a>
<a class="sourceLine" id="orgd754526-29" title="29">  [<span class="op">-</span><span class="fl">1.61077330e+00</span>  <span class="fl">1.01905479e+02</span>  <span class="fl">2.00134565e+03</span>]</a>
<a class="sourceLine" id="orgd754526-30" title="30">  [ <span class="fl">9.45854243e-01</span>  <span class="fl">1.00877071e+02</span>  <span class="fl">1.99914438e+03</span>]]]</a>
<a class="sourceLine" id="orgd754526-31" title="31"></a>
<a class="sourceLine" id="orgd754526-32" title="32">DirichletRV([<span class="fl">0.1</span>, <span class="dv">10</span>, <span class="fl">0.5</span>], size<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>]):</a>
<a class="sourceLine" id="orgd754526-33" title="33">[[[<span class="fl">1.41863953e-06</span> <span class="fl">9.35392908e-01</span> <span class="fl">6.46056738e-02</span>]</a>
<a class="sourceLine" id="orgd754526-34" title="34">  [<span class="fl">4.50961569e-15</span> <span class="fl">9.71338820e-01</span> <span class="fl">2.86611803e-02</span>]</a>
<a class="sourceLine" id="orgd754526-35" title="35">  [<span class="fl">2.41299980e-05</span> <span class="fl">9.94566812e-01</span> <span class="fl">5.40905817e-03</span>]]</a>
<a class="sourceLine" id="orgd754526-36" title="36"></a>
<a class="sourceLine" id="orgd754526-37" title="37"> [[<span class="fl">5.79850503e-08</span> <span class="fl">9.73090671e-01</span> <span class="fl">2.69092713e-02</span>]</a>
<a class="sourceLine" id="orgd754526-38" title="38">  [<span class="fl">4.17758767e-09</span> <span class="fl">9.61671733e-01</span> <span class="fl">3.83282630e-02</span>]</a>
<a class="sourceLine" id="orgd754526-39" title="39">  [<span class="fl">8.78921782e-03</span> <span class="fl">9.54146972e-01</span> <span class="fl">3.70638103e-02</span>]]]</a>
<a class="sourceLine" id="orgd754526-40" title="40"></a>
<a class="sourceLine" id="orgd754526-41" title="41">PoissonRV([<span class="fl">2.</span>, <span class="fl">1.</span>], size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]):</a>
<a class="sourceLine" id="orgd754526-42" title="42">[[ <span class="dv">1</span> <span class="dv">15</span>]</a>
<a class="sourceLine" id="orgd754526-43" title="43"> [ <span class="dv">1</span> <span class="dv">12</span>]</a>
<a class="sourceLine" id="orgd754526-44" title="44"> [ <span class="dv">2</span> <span class="dv">21</span>]</a>
<a class="sourceLine" id="orgd754526-45" title="45"> [ <span class="dv">1</span> <span class="dv">14</span>]]</a>
<a class="sourceLine" id="orgd754526-46" title="46"></a>
<a class="sourceLine" id="orgd754526-47" title="47">CauchyRV([<span class="fl">1.</span>, <span class="fl">100.</span>], <span class="dv">30</span>, size<span class="op">=</span>[<span class="dv">4</span>, <span class="dv">2</span>]):</a>
<a class="sourceLine" id="orgd754526-48" title="48">[[ <span class="fl">-86.93222925</span>   <span class="fl">79.9758127</span> ]</a>
<a class="sourceLine" id="orgd754526-49" title="49"> [  <span class="fl">13.41882831</span> <span class="fl">-374.41779179</span>]</a>
<a class="sourceLine" id="orgd754526-50" title="50"> [  <span class="fl">75.74505567</span>   <span class="fl">93.2944822</span> ]</a>
<a class="sourceLine" id="orgd754526-51" title="51"> [  <span class="fl">30.0824262</span>   <span class="fl">130.40873511</span>]]</a>
<a class="sourceLine" id="orgd754526-52" title="52"></a>
<a class="sourceLine" id="orgd754526-53" title="53">MultinomialRV(<span class="dv">20</span>, [<span class="dv">1</span><span class="op">/</span><span class="fl">6.</span>]<span class="op">*</span><span class="dv">6</span>, size<span class="op">=</span>[<span class="dv">6</span>, <span class="dv">2</span>]):</a>
<a class="sourceLine" id="orgd754526-54" title="54">[[[<span class="dv">2</span> <span class="dv">4</span> <span class="dv">4</span> <span class="dv">2</span> <span class="dv">4</span> <span class="dv">4</span>]</a>
<a class="sourceLine" id="orgd754526-55" title="55">  [<span class="dv">2</span> <span class="dv">5</span> <span class="dv">2</span> <span class="dv">4</span> <span class="dv">3</span> <span class="dv">4</span>]]</a>
<a class="sourceLine" id="orgd754526-56" title="56"></a>
<a class="sourceLine" id="orgd754526-57" title="57"> [[<span class="dv">2</span> <span class="dv">5</span> <span class="dv">6</span> <span class="dv">2</span> <span class="dv">4</span> <span class="dv">1</span>]</a>
<a class="sourceLine" id="orgd754526-58" title="58">  [<span class="dv">0</span> <span class="dv">4</span> <span class="dv">4</span> <span class="dv">3</span> <span class="dv">5</span> <span class="dv">4</span>]]</a>
<a class="sourceLine" id="orgd754526-59" title="59"></a>
<a class="sourceLine" id="orgd754526-60" title="60"> [[<span class="dv">6</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">4</span> <span class="dv">4</span> <span class="dv">4</span>]</a>
<a class="sourceLine" id="orgd754526-61" title="61">  [<span class="dv">3</span> <span class="dv">4</span> <span class="dv">3</span> <span class="dv">2</span> <span class="dv">3</span> <span class="dv">5</span>]]]</a>
<a class="sourceLine" id="orgd754526-62" title="62"></a></code></pre></div>
</div>
<p>As noted, there are a few long-standing difficulties surrounding the use and determination of shape information in PyMC3. <code>RandomVariable</code> doesn’t suffer the same limitations.</p>
<div class="example" data-markdown="">
<p>In Listing <a href="#org77fdfa2">20</a>, we see that a multivariate normal random variable cannot be created in PyMC3 without explicit shape information.</p>
<div class="sourceCode" id="org77fdfa2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org77fdfa2-1" title="1"><span class="im">import</span> traceback</a>
<a class="sourceLine" id="org77fdfa2-2" title="2"></a>
<a class="sourceLine" id="org77fdfa2-3" title="3">test_mean <span class="op">=</span> tt.vector(<span class="st">&#39;test_mean&#39;</span>)</a>
<a class="sourceLine" id="org77fdfa2-4" title="4">test_cov <span class="op">=</span> tt.matrix(<span class="st">&#39;test_cov&#39;</span>, dtype<span class="op">=</span><span class="st">&#39;int64&#39;</span>)</a>
<a class="sourceLine" id="org77fdfa2-5" title="5"></a>
<a class="sourceLine" id="org77fdfa2-6" title="6">test_mean.tag.test_value <span class="op">=</span> np.asarray([<span class="dv">1</span>])</a>
<a class="sourceLine" id="org77fdfa2-7" title="7">test_cov.tag.test_value <span class="op">=</span> np.asarray([[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="org77fdfa2-8" title="8"></a>
<a class="sourceLine" id="org77fdfa2-9" title="9"><span class="cf">try</span>:</a>
<a class="sourceLine" id="org77fdfa2-10" title="10">  <span class="cf">with</span> pm.Model():</a>
<a class="sourceLine" id="org77fdfa2-11" title="11">    test_rv <span class="op">=</span> pm.MvNormal(<span class="st">&#39;test_rv&#39;</span>, test_mean, test_cov)</a>
<a class="sourceLine" id="org77fdfa2-12" title="12"><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</a>
<a class="sourceLine" id="org77fdfa2-13" title="13">  <span class="bu">print</span>(<span class="st">&quot;&quot;</span>.join(traceback.format_exception_only(<span class="bu">type</span>(e), e)))</a></code></pre></div>
<div class="sourceCode" id="org748f851"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org748f851-1" title="1"><span class="pp">ValueError</span>: Invalid dimension <span class="cf">for</span> value: <span class="dv">0</span></a>
<a class="sourceLine" id="org748f851-2" title="2"></a></code></pre></div>
<p>As Listing <a href="#orgb7414f6">22</a> demonstrates, the same construction is possible when one specifies an explicit size/shape.</p>
<div class="sourceCode" id="orgb7414f6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgb7414f6-1" title="1"><span class="cf">try</span>:</a>
<a class="sourceLine" id="orgb7414f6-2" title="2">  <span class="cf">with</span> pm.Model():</a>
<a class="sourceLine" id="orgb7414f6-3" title="3">    test_rv <span class="op">=</span> pm.MvNormal(<span class="st">&#39;test_rv&#39;</span>, test_mean, test_cov, shape<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="orgb7414f6-4" title="4">    <span class="bu">print</span>(<span class="st">&quot;test_rv.distribution.shape = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(test_rv.distribution.shape))</a>
<a class="sourceLine" id="orgb7414f6-5" title="5">    <span class="bu">print</span>(<span class="st">&quot;test_rv.tag.test_value = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(test_rv.tag.test_value))</a>
<a class="sourceLine" id="orgb7414f6-6" title="6"><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</a>
<a class="sourceLine" id="orgb7414f6-7" title="7">  <span class="bu">print</span>(<span class="st">&quot;&quot;</span>.join(traceback.format_exception_only(<span class="bu">type</span>(e), e)))</a></code></pre></div>
<div class="sourceCode" id="orge3a93eb"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orge3a93eb-1" title="1">test_rv.distribution.shape <span class="op">=</span> [<span class="dv">1</span>]</a>
<a class="sourceLine" id="orge3a93eb-2" title="2">test_rv.tag.test_value <span class="op">=</span> [<span class="fl">1.</span>]</a>
<a class="sourceLine" id="orge3a93eb-3" title="3"></a></code></pre></div>
</div>
<p>Using <code>RandomVariable</code>, we do not have to specify a shape, nor implement any sampling code outside of <code>RandomVariable.perform</code> to draw random variables and generate valid test values.</p>
<div class="example" data-markdown="">
<p>Listings <a href="#org67b2727">24</a> and <a href="#org56bde38">26</a> demonstrate how easy it is to create dependencies between random variates using <code>RandomVariable</code>, and how sampling and test values are automatic. It uses a multivariate normal as the mean of another multivariate normal.</p>
<div class="sourceCode" id="org67b2727"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org67b2727-1" title="1">theano.config.compute_test_value <span class="op">=</span> <span class="st">&#39;ignore&#39;</span></a>
<a class="sourceLine" id="org67b2727-2" title="2"></a>
<a class="sourceLine" id="org67b2727-3" title="3">mu_tt <span class="op">=</span> tt.vector(<span class="st">&#39;mu&#39;</span>)</a>
<a class="sourceLine" id="org67b2727-4" title="4">C_tt <span class="op">=</span> tt.matrix(<span class="st">&#39;C&#39;</span>)</a>
<a class="sourceLine" id="org67b2727-5" title="5">D_tt <span class="op">=</span> tt.matrix(<span class="st">&#39;D&#39;</span>)</a>
<a class="sourceLine" id="org67b2727-6" title="6"></a>
<a class="sourceLine" id="org67b2727-7" title="7">X_rv <span class="op">=</span> MvNormalRV(mu_tt, C_tt)</a>
<a class="sourceLine" id="org67b2727-8" title="8">Y_rv <span class="op">=</span> MvNormalRV(X_rv, D_tt)</a>
<a class="sourceLine" id="org67b2727-9" title="9"></a>
<a class="sourceLine" id="org67b2727-10" title="10"><span class="co"># Sample some values under specific parameter values</span></a>
<a class="sourceLine" id="org67b2727-11" title="11"><span class="bu">print</span>(<span class="st">&quot;</span><span class="sc">{}</span><span class="st"> ~ X</span><span class="ch">\n</span><span class="sc">{}</span><span class="st"> ~ Y&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="org67b2727-12" title="12">    X_rv.<span class="bu">eval</span>({mu_tt: [<span class="dv">1</span>, <span class="dv">2</span>], C_tt: np.diag([<span class="dv">1</span>, <span class="dv">2</span>])}),</a>
<a class="sourceLine" id="org67b2727-13" title="13">    Y_rv.<span class="bu">eval</span>({mu_tt: [<span class="dv">1</span>, <span class="dv">2</span>], C_tt: np.diag([<span class="dv">1</span>, <span class="dv">2</span>]), D_tt: np.diag([<span class="dv">10</span>, <span class="dv">20</span>])})))</a></code></pre></div>
<div class="sourceCode" id="orgec2ca8b"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgec2ca8b-1" title="1">[<span class="op">-</span><span class="fl">1.25047147</span>  <span class="fl">4.87459955</span>] <span class="op">~</span> X</a>
<a class="sourceLine" id="orgec2ca8b-2" title="2">[ <span class="fl">2.15486205</span> <span class="fl">-3.3066946</span> ] <span class="op">~</span> Y</a>
<a class="sourceLine" id="orgec2ca8b-3" title="3"></a></code></pre></div>
<div class="sourceCode" id="org56bde38"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org56bde38-1" title="1">theano.config.compute_test_value <span class="op">=</span> <span class="st">&#39;warn&#39;</span></a>
<a class="sourceLine" id="org56bde38-2" title="2"></a>
<a class="sourceLine" id="org56bde38-3" title="3">mu_tt.tag.test_value <span class="op">=</span> np.array([<span class="dv">0</span>, <span class="dv">30</span>, <span class="dv">40</span>])</a>
<a class="sourceLine" id="org56bde38-4" title="4">C_tt.tag.test_value <span class="op">=</span> np.diag([<span class="dv">100</span>, <span class="dv">10</span>, <span class="dv">1</span>])</a>
<a class="sourceLine" id="org56bde38-5" title="5">D_tt.tag.test_value <span class="op">=</span> np.diag([<span class="dv">100</span>, <span class="dv">10</span>, <span class="dv">1</span>])</a>
<a class="sourceLine" id="org56bde38-6" title="6"></a>
<a class="sourceLine" id="org56bde38-7" title="7">X_rv <span class="op">=</span> MvNormalRV(mu_tt, C_tt)</a>
<a class="sourceLine" id="org56bde38-8" title="8">Y_rv <span class="op">=</span> MvNormalRV(X_rv, D_tt)</a>
<a class="sourceLine" id="org56bde38-9" title="9"></a>
<a class="sourceLine" id="org56bde38-10" title="10"><span class="co"># Observe the automatically generated test values</span></a>
<a class="sourceLine" id="org56bde38-11" title="11"><span class="bu">print</span>(<span class="st">&quot;X test value: </span><span class="sc">{}</span><span class="ch">\n</span><span class="st">Y test value: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="org56bde38-12" title="12">    X_rv.tag.test_value,</a>
<a class="sourceLine" id="org56bde38-13" title="13">    Y_rv.tag.test_value))</a></code></pre></div>
<div class="sourceCode" id="orgb6f99f8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgb6f99f8-1" title="1">X test value: [ <span class="fl">1.78826967</span> <span class="fl">28.73266332</span> <span class="fl">38.57297111</span>]</a>
<a class="sourceLine" id="orgb6f99f8-2" title="2">Y test value: [<span class="fl">33.93703352</span> <span class="fl">27.48925582</span> <span class="fl">38.21563854</span>]</a>
<a class="sourceLine" id="orgb6f99f8-3" title="3"></a></code></pre></div>
</div>
<div class="example" data-markdown="">
<p>In Listing <a href="#orge489ad8">28</a>, we specify the following hierarchical model:</p>
<p><span class="math display">\[\begin{equation*}
  \begin{aligned}
    M &amp;\sim \text{Poisson}\left(10\right)
    \\
    \alpha_i &amp;\sim \text{Uniform}\left(0, 1\right),
    \quad i \in \left\{0, \dots, M\right\}
    \\
    \pi &amp;\sim \text{Dirichlet}\left(\alpha\right)
    \\
    Y &amp;\sim \text{Multinomial}\left(M, \pi\right)
  \end{aligned}
  \;.
\end{equation*}\]</span></p>
<p>This toy model is particularly interesting in how it specifies symbolic dependencies between continuous and discrete distributions and uses random variables to determine the shapes of other random variables.</p>
<div class="sourceCode" id="orge489ad8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orge489ad8-1" title="1">theano.config.compute_test_value <span class="op">=</span> <span class="st">&#39;ignore&#39;</span></a>
<a class="sourceLine" id="orge489ad8-2" title="2">pois_rate <span class="op">=</span> tt.dscalar(<span class="st">&#39;rate&#39;</span>)</a>
<a class="sourceLine" id="orge489ad8-3" title="3">test_pois_rv <span class="op">=</span> PoissonRV(pois_rate)</a>
<a class="sourceLine" id="orge489ad8-4" title="4">test_alpha <span class="op">=</span> UniformRV(<span class="dv">0</span>, <span class="dv">1</span>, size<span class="op">=</span>test_pois_rv)</a>
<a class="sourceLine" id="orge489ad8-5" title="5">test_dirichlet_rv <span class="op">=</span> DirichletRV(test_uniform_rv)</a>
<a class="sourceLine" id="orge489ad8-6" title="6">test_multinom_rv <span class="op">=</span> MultinomialRV(test_pois_rv, test_dirichlet_rv)</a>
<a class="sourceLine" id="orge489ad8-7" title="7"></a>
<a class="sourceLine" id="orge489ad8-8" title="8">test_multinom_draw <span class="op">=</span> theano.function(inputs<span class="op">=</span>[], outputs<span class="op">=</span>test_multinom_rv,</a>
<a class="sourceLine" id="orge489ad8-9" title="9">                                     givens<span class="op">=</span>{pois_rate: <span class="fl">10.</span>})</a>
<a class="sourceLine" id="orge489ad8-10" title="10"></a>
<a class="sourceLine" id="orge489ad8-11" title="11"><span class="bu">print</span>(<span class="st">&quot;test_multinom_rv draw 1: </span><span class="sc">{}</span><span class="ch">\n</span><span class="st">test_multinom_rv draw 2: </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orge489ad8-12" title="12">    test_multinom_draw(), test_multinom_draw()))</a></code></pre></div>
<div class="sourceCode" id="org65f2561"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org65f2561-1" title="1">test_multinom_rv draw <span class="dv">1</span>: [<span class="dv">0</span> <span class="dv">2</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">2</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">0</span>]</a>
<a class="sourceLine" id="org65f2561-2" title="2">test_multinom_rv draw <span class="dv">2</span>: [<span class="dv">5</span> <span class="dv">2</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">1</span> <span class="dv">0</span> <span class="dv">1</span> <span class="dv">0</span>]</a>
<a class="sourceLine" id="org65f2561-3" title="3"></a></code></pre></div>
</div>
<section id="random-variable-pretty-printing" class="level2">
<h2>Random Variable Pretty Printing</h2>
<p>In Listing <a href="#org52ecc27">30</a>, we implement a pretty printer that produces more readable forms of Theano graphs containing <code>RandomVariable</code> nodes.</p>
<div class="sourceCode" id="org52ecc27"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org52ecc27-1" title="1"><span class="kw">class</span> RandomVariablePrinter:</a>
<a class="sourceLine" id="org52ecc27-2" title="2">    <span class="co">&quot;&quot;&quot;Pretty print random variables</span></a>
<a class="sourceLine" id="org52ecc27-3" title="3"></a>
<a class="sourceLine" id="org52ecc27-4" title="4"><span class="co">    </span><span class="al">NOTE</span><span class="co">: When parsing LaTeX output (i.e. `self.latex=True`) in `self.process`,</span></a>
<a class="sourceLine" id="org52ecc27-5" title="5"><span class="co">    the `pstate` object is checked for a boolean `latex`.</span></a>
<a class="sourceLine" id="org52ecc27-6" title="6"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org52ecc27-7" title="7">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name<span class="op">=</span><span class="va">None</span>, latex<span class="op">=</span><span class="va">False</span>):</a>
<a class="sourceLine" id="org52ecc27-8" title="8">        <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org52ecc27-9" title="9"><span class="co">        Parameters</span></a>
<a class="sourceLine" id="org52ecc27-10" title="10"><span class="co">        ==========</span></a>
<a class="sourceLine" id="org52ecc27-11" title="11"><span class="co">        name: str (optional)</span></a>
<a class="sourceLine" id="org52ecc27-12" title="12"><span class="co">            A fixed name to use for the random variables printed by this</span></a>
<a class="sourceLine" id="org52ecc27-13" title="13"><span class="co">            printer.  If not specified, use `RandomVariable.name`.</span></a>
<a class="sourceLine" id="org52ecc27-14" title="14"><span class="co">        latex: boolean (optional)</span></a>
<a class="sourceLine" id="org52ecc27-15" title="15"><span class="co">            Whether or not to print LaTeX strings.</span></a>
<a class="sourceLine" id="org52ecc27-16" title="16"><span class="co">        &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org52ecc27-17" title="17">        <span class="va">self</span>.name <span class="op">=</span> name</a>
<a class="sourceLine" id="org52ecc27-18" title="18">        <span class="va">self</span>.latex <span class="op">=</span> latex</a>
<a class="sourceLine" id="org52ecc27-19" title="19"></a>
<a class="sourceLine" id="org52ecc27-20" title="20">    <span class="kw">def</span> process(<span class="va">self</span>, output, pstate):</a>
<a class="sourceLine" id="org52ecc27-21" title="21">        <span class="cf">if</span> output <span class="kw">in</span> pstate.memo:</a>
<a class="sourceLine" id="org52ecc27-22" title="22">            <span class="cf">return</span> pstate.memo[output]</a>
<a class="sourceLine" id="org52ecc27-23" title="23"></a>
<a class="sourceLine" id="org52ecc27-24" title="24">        pprinter <span class="op">=</span> pstate.pprinter</a>
<a class="sourceLine" id="org52ecc27-25" title="25">        node <span class="op">=</span> output.owner</a>
<a class="sourceLine" id="org52ecc27-26" title="26"></a>
<a class="sourceLine" id="org52ecc27-27" title="27">        <span class="cf">if</span> node <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> <span class="kw">not</span> <span class="bu">isinstance</span>(node.op, RandomVariable):</a>
<a class="sourceLine" id="org52ecc27-28" title="28">            <span class="cf">raise</span> <span class="pp">TypeError</span>(<span class="st">&quot;function </span><span class="sc">%s</span><span class="st"> cannot represent a variable that is &quot;</span></a>
<a class="sourceLine" id="org52ecc27-29" title="29">                            <span class="st">&quot;not the result of a RandomVariable operation&quot;</span> <span class="op">%</span></a>
<a class="sourceLine" id="org52ecc27-30" title="30">                            <span class="va">self</span>.name)</a>
<a class="sourceLine" id="org52ecc27-31" title="31"></a>
<a class="sourceLine" id="org52ecc27-32" title="32">        new_precedence <span class="op">=</span> <span class="dv">-1000</span></a>
<a class="sourceLine" id="org52ecc27-33" title="33">        <span class="cf">try</span>:</a>
<a class="sourceLine" id="org52ecc27-34" title="34">            old_precedence <span class="op">=</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;precedence&#39;</span>, <span class="va">None</span>)</a>
<a class="sourceLine" id="org52ecc27-35" title="35">            pstate.precedence <span class="op">=</span> new_precedence</a>
<a class="sourceLine" id="org52ecc27-36" title="36">            out_name <span class="op">=</span> VariableWithShapePrinter.process_variable_name(</a>
<a class="sourceLine" id="org52ecc27-37" title="37">                output, pstate)</a>
<a class="sourceLine" id="org52ecc27-38" title="38">            shape_info_str <span class="op">=</span> VariableWithShapePrinter.process_shape_info(</a>
<a class="sourceLine" id="org52ecc27-39" title="39">                output, pstate)</a>
<a class="sourceLine" id="org52ecc27-40" title="40">            <span class="cf">if</span> <span class="va">self</span>.latex <span class="kw">or</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;latex&#39;</span>, <span class="va">False</span>):</a>
<a class="sourceLine" id="org52ecc27-41" title="41">                dist_format <span class="op">=</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st"> </span><span class="ch">\\</span><span class="st">sim </span><span class="ch">\\</span><span class="st">operatorname{</span><span class="sc">%s</span><span class="st">}</span><span class="ch">\\</span><span class="st">left(</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">right)&quot;</span></a>
<a class="sourceLine" id="org52ecc27-42" title="42">                dist_format <span class="op">+=</span> <span class="st">&#39;, </span><span class="ch">\\</span><span class="st">quad </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(shape_info_str)</a>
<a class="sourceLine" id="org52ecc27-43" title="43">            <span class="cf">else</span>:</a>
<a class="sourceLine" id="org52ecc27-44" title="44">                dist_format <span class="op">=</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st"> ~ </span><span class="sc">%s</span><span class="st">(</span><span class="sc">%s</span><span class="st">)&quot;</span></a>
<a class="sourceLine" id="org52ecc27-45" title="45">                dist_format <span class="op">+=</span> <span class="st">&#39;,  </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(shape_info_str)</a>
<a class="sourceLine" id="org52ecc27-46" title="46"></a>
<a class="sourceLine" id="org52ecc27-47" title="47">            op_name <span class="op">=</span> <span class="va">self</span>.name <span class="kw">or</span> node.op.name</a>
<a class="sourceLine" id="org52ecc27-48" title="48">            dist_params <span class="op">=</span> node.inputs[:<span class="op">-</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="org52ecc27-49" title="49">            dist_params_r <span class="op">=</span> dist_format <span class="op">%</span> (</a>
<a class="sourceLine" id="org52ecc27-50" title="50">                out_name, op_name,</a>
<a class="sourceLine" id="org52ecc27-51" title="51">                <span class="st">&quot;, &quot;</span>.join([pprinter.process(i, pstate)</a>
<a class="sourceLine" id="org52ecc27-52" title="52">                        <span class="cf">for</span> i <span class="kw">in</span> dist_params]))</a>
<a class="sourceLine" id="org52ecc27-53" title="53">        <span class="cf">finally</span>:</a>
<a class="sourceLine" id="org52ecc27-54" title="54">            pstate.precedence <span class="op">=</span> old_precedence</a>
<a class="sourceLine" id="org52ecc27-55" title="55"></a>
<a class="sourceLine" id="org52ecc27-56" title="56">        pstate.preamble_lines <span class="op">+=</span> [dist_params_r]</a>
<a class="sourceLine" id="org52ecc27-57" title="57">        pstate.memo[output] <span class="op">=</span> out_name</a>
<a class="sourceLine" id="org52ecc27-58" title="58"></a>
<a class="sourceLine" id="org52ecc27-59" title="59">        <span class="cf">return</span> out_name</a></code></pre></div>
<div class="sourceCode" id="org414cfc6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org414cfc6-1" title="1"><span class="im">import</span> string</a>
<a class="sourceLine" id="org414cfc6-2" title="2"></a>
<a class="sourceLine" id="org414cfc6-3" title="3"><span class="im">from</span> theano.<span class="bu">compile</span>.ops <span class="im">import</span> Shape_i</a>
<a class="sourceLine" id="org414cfc6-4" title="4"></a>
<a class="sourceLine" id="org414cfc6-5" title="5"><span class="im">from</span> sympy <span class="im">import</span> Array <span class="im">as</span> SympyArray</a>
<a class="sourceLine" id="org414cfc6-6" title="6"><span class="im">from</span> sympy.printing <span class="im">import</span> latex <span class="im">as</span> sympy_latex</a>
<a class="sourceLine" id="org414cfc6-7" title="7"></a>
<a class="sourceLine" id="org414cfc6-8" title="8"></a>
<a class="sourceLine" id="org414cfc6-9" title="9"><span class="kw">class</span> VariableWithShapePrinter:</a>
<a class="sourceLine" id="org414cfc6-10" title="10">    <span class="co">&quot;&quot;&quot;Print variable shape info in the preamble and use readable character</span></a>
<a class="sourceLine" id="org414cfc6-11" title="11"><span class="co">    names for unamed variables.</span></a>
<a class="sourceLine" id="org414cfc6-12" title="12"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="org414cfc6-13" title="13">    available_names <span class="op">=</span> <span class="bu">set</span>(string.ascii_letters)</a>
<a class="sourceLine" id="org414cfc6-14" title="14">    default_printer <span class="op">=</span> theano.printing.default_printer</a>
<a class="sourceLine" id="org414cfc6-15" title="15"></a>
<a class="sourceLine" id="org414cfc6-16" title="16">    <span class="at">@classmethod</span></a>
<a class="sourceLine" id="org414cfc6-17" title="17">    <span class="kw">def</span> process(cls, output, pstate):</a>
<a class="sourceLine" id="org414cfc6-18" title="18">        <span class="cf">if</span> output <span class="kw">in</span> pstate.memo:</a>
<a class="sourceLine" id="org414cfc6-19" title="19">            <span class="cf">return</span> pstate.memo[output]</a>
<a class="sourceLine" id="org414cfc6-20" title="20"></a>
<a class="sourceLine" id="org414cfc6-21" title="21">        using_latex <span class="op">=</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;latex&#39;</span>, <span class="va">False</span>)</a>
<a class="sourceLine" id="org414cfc6-22" title="22"></a>
<a class="sourceLine" id="org414cfc6-23" title="23">        <span class="cf">if</span> <span class="bu">isinstance</span>(output, tt.gof.Constant):</a>
<a class="sourceLine" id="org414cfc6-24" title="24">            <span class="cf">if</span> output.ndim <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> using_latex:</a>
<a class="sourceLine" id="org414cfc6-25" title="25">                out_name <span class="op">=</span> sympy_latex(SympyArray(output.data))</a>
<a class="sourceLine" id="org414cfc6-26" title="26">            <span class="cf">else</span>:</a>
<a class="sourceLine" id="org414cfc6-27" title="27">                out_name <span class="op">=</span> <span class="bu">str</span>(output.data)</a>
<a class="sourceLine" id="org414cfc6-28" title="28">        <span class="cf">elif</span> <span class="bu">isinstance</span>(output, tt.TensorVariable):</a>
<a class="sourceLine" id="org414cfc6-29" title="29">            <span class="co"># Process name and shape</span></a>
<a class="sourceLine" id="org414cfc6-30" title="30">            out_name <span class="op">=</span> cls.process_variable_name(output, pstate)</a>
<a class="sourceLine" id="org414cfc6-31" title="31">            shape_info <span class="op">=</span> cls.process_shape_info(output, pstate)</a>
<a class="sourceLine" id="org414cfc6-32" title="32">            pstate.preamble_lines <span class="op">+=</span> [shape_info]</a>
<a class="sourceLine" id="org414cfc6-33" title="33">        <span class="cf">elif</span> output.name:</a>
<a class="sourceLine" id="org414cfc6-34" title="34">            out_name <span class="op">=</span> output.name</a>
<a class="sourceLine" id="org414cfc6-35" title="35">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="org414cfc6-36" title="36">            out_name <span class="op">=</span> cls.default_printer.process(output, pstate)</a>
<a class="sourceLine" id="org414cfc6-37" title="37"></a>
<a class="sourceLine" id="org414cfc6-38" title="38">        pstate.memo[output] <span class="op">=</span> out_name</a>
<a class="sourceLine" id="org414cfc6-39" title="39">        <span class="cf">return</span> out_name</a>
<a class="sourceLine" id="org414cfc6-40" title="40"></a>
<a class="sourceLine" id="org414cfc6-41" title="41">    <span class="at">@classmethod</span></a>
<a class="sourceLine" id="org414cfc6-42" title="42">    <span class="kw">def</span> process_shape_name(cls, output, pstate):</a>
<a class="sourceLine" id="org414cfc6-43" title="43">        shape_of_var <span class="op">=</span> output.owner.inputs[<span class="dv">0</span>]</a>
<a class="sourceLine" id="org414cfc6-44" title="44">        shape_names <span class="op">=</span> pstate.memo.setdefault(<span class="st">&#39;shape_names&#39;</span>, {})</a>
<a class="sourceLine" id="org414cfc6-45" title="45">        out_name <span class="op">=</span> shape_names.setdefault(</a>
<a class="sourceLine" id="org414cfc6-46" title="46">            shape_of_var, cls.process_variable_name(output, pstate))</a>
<a class="sourceLine" id="org414cfc6-47" title="47">        <span class="cf">return</span> out_name</a>
<a class="sourceLine" id="org414cfc6-48" title="48"></a>
<a class="sourceLine" id="org414cfc6-49" title="49">    <span class="at">@classmethod</span></a>
<a class="sourceLine" id="org414cfc6-50" title="50">    <span class="kw">def</span> process_variable_name(cls, output, pstate):</a>
<a class="sourceLine" id="org414cfc6-51" title="51">        <span class="cf">if</span> output <span class="kw">in</span> pstate.memo:</a>
<a class="sourceLine" id="org414cfc6-52" title="52">            <span class="cf">return</span> pstate.memo[output]</a>
<a class="sourceLine" id="org414cfc6-53" title="53"></a>
<a class="sourceLine" id="org414cfc6-54" title="54">        available_names <span class="op">=</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;available_names&#39;</span>, <span class="va">None</span>)</a>
<a class="sourceLine" id="org414cfc6-55" title="55">        <span class="cf">if</span> available_names <span class="kw">is</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="org414cfc6-56" title="56">            <span class="co"># Initialize this state&#39;s available names</span></a>
<a class="sourceLine" id="org414cfc6-57" title="57">            available_names <span class="op">=</span> <span class="bu">set</span>(cls.available_names)</a>
<a class="sourceLine" id="org414cfc6-58" title="58">            fgraph <span class="op">=</span> <span class="bu">getattr</span>(output, <span class="st">&#39;fgraph&#39;</span>, <span class="va">None</span>)</a>
<a class="sourceLine" id="org414cfc6-59" title="59">            <span class="cf">if</span> fgraph:</a>
<a class="sourceLine" id="org414cfc6-60" title="60">                <span class="co"># Remove known names in the graph.</span></a>
<a class="sourceLine" id="org414cfc6-61" title="61">                available_names <span class="op">-=</span> {v.name <span class="cf">for</span> v <span class="kw">in</span> fgraph.variables}</a>
<a class="sourceLine" id="org414cfc6-62" title="62">            <span class="bu">setattr</span>(pstate, <span class="st">&#39;available_names&#39;</span>, available_names)</a>
<a class="sourceLine" id="org414cfc6-63" title="63"></a>
<a class="sourceLine" id="org414cfc6-64" title="64">        <span class="cf">if</span> output.name:</a>
<a class="sourceLine" id="org414cfc6-65" title="65">            out_name <span class="op">=</span> output.name</a>
<a class="sourceLine" id="org414cfc6-66" title="66">            available_names.discard(out_name)</a>
<a class="sourceLine" id="org414cfc6-67" title="67">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="org414cfc6-68" title="68">            out_name <span class="op">=</span> available_names.pop()</a>
<a class="sourceLine" id="org414cfc6-69" title="69"></a>
<a class="sourceLine" id="org414cfc6-70" title="70">        pstate.memo[output] <span class="op">=</span> out_name</a>
<a class="sourceLine" id="org414cfc6-71" title="71">        <span class="cf">return</span> out_name</a>
<a class="sourceLine" id="org414cfc6-72" title="72"></a>
<a class="sourceLine" id="org414cfc6-73" title="73">    <span class="at">@classmethod</span></a>
<a class="sourceLine" id="org414cfc6-74" title="74">    <span class="kw">def</span> process_shape_info(cls, output, pstate):</a>
<a class="sourceLine" id="org414cfc6-75" title="75">        using_latex <span class="op">=</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;latex&#39;</span>, <span class="va">False</span>)</a>
<a class="sourceLine" id="org414cfc6-76" title="76"></a>
<a class="sourceLine" id="org414cfc6-77" title="77">        <span class="cf">if</span> output.dtype <span class="kw">in</span> tt.int_dtypes:</a>
<a class="sourceLine" id="org414cfc6-78" title="78">            sspace_char <span class="op">=</span> <span class="st">&#39;Z&#39;</span></a>
<a class="sourceLine" id="org414cfc6-79" title="79">        <span class="cf">elif</span> output.dtype <span class="kw">in</span> tt.uint_dtypes:</a>
<a class="sourceLine" id="org414cfc6-80" title="80">            sspace_char <span class="op">=</span> <span class="st">&#39;N&#39;</span></a>
<a class="sourceLine" id="org414cfc6-81" title="81">        <span class="cf">elif</span> output.dtype <span class="kw">in</span> tt.float_dtypes:</a>
<a class="sourceLine" id="org414cfc6-82" title="82">            sspace_char <span class="op">=</span> <span class="st">&#39;R&#39;</span></a>
<a class="sourceLine" id="org414cfc6-83" title="83">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="org414cfc6-84" title="84">            sspace_char <span class="op">=</span> <span class="st">&#39;?&#39;</span></a>
<a class="sourceLine" id="org414cfc6-85" title="85"></a>
<a class="sourceLine" id="org414cfc6-86" title="86">        fgraph <span class="op">=</span> <span class="bu">getattr</span>(output, <span class="st">&#39;fgraph&#39;</span>, <span class="va">None</span>)</a>
<a class="sourceLine" id="org414cfc6-87" title="87">        shape_feature <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="org414cfc6-88" title="88">        <span class="cf">if</span> fgraph:</a>
<a class="sourceLine" id="org414cfc6-89" title="89">            <span class="cf">if</span> <span class="kw">not</span> <span class="bu">hasattr</span>(fgraph, <span class="st">&#39;shape_feature&#39;</span>):</a>
<a class="sourceLine" id="org414cfc6-90" title="90">                fgraph.attach_feature(tt.opt.ShapeFeature())</a>
<a class="sourceLine" id="org414cfc6-91" title="91">            shape_feature <span class="op">=</span> fgraph.shape_feature</a>
<a class="sourceLine" id="org414cfc6-92" title="92"></a>
<a class="sourceLine" id="org414cfc6-93" title="93">        shape_dims <span class="op">=</span> []</a>
<a class="sourceLine" id="org414cfc6-94" title="94">        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(output.ndim):</a>
<a class="sourceLine" id="org414cfc6-95" title="95">            s_i_out <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="org414cfc6-96" title="96">            <span class="cf">if</span> using_latex:</a>
<a class="sourceLine" id="org414cfc6-97" title="97">                s_i_pat <span class="op">=</span> <span class="st">&#39;{n^{</span><span class="sc">%s}}</span><span class="st">&#39;</span> <span class="op">+</span> (<span class="st">&#39;_{</span><span class="sc">%s</span><span class="st">}&#39;</span> <span class="op">%</span> i)</a>
<a class="sourceLine" id="org414cfc6-98" title="98">            <span class="cf">else</span>:</a>
<a class="sourceLine" id="org414cfc6-99" title="99">                s_i_pat <span class="op">=</span> <span class="st">&#39;n^</span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">+</span> (<span class="st">&#39;_</span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> i)</a>
<a class="sourceLine" id="org414cfc6-100" title="100">            <span class="cf">if</span> shape_feature:</a>
<a class="sourceLine" id="org414cfc6-101" title="101">                new_precedence <span class="op">=</span> <span class="dv">-1000</span></a>
<a class="sourceLine" id="org414cfc6-102" title="102">                <span class="cf">try</span>:</a>
<a class="sourceLine" id="org414cfc6-103" title="103">                    old_precedence <span class="op">=</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;precedence&#39;</span>, <span class="va">None</span>)</a>
<a class="sourceLine" id="org414cfc6-104" title="104">                    pstate.precedence <span class="op">=</span> new_precedence</a>
<a class="sourceLine" id="org414cfc6-105" title="105">                    _s_i_out <span class="op">=</span> shape_feature.get_shape(output, i)</a>
<a class="sourceLine" id="org414cfc6-106" title="106">                    <span class="cf">if</span> _s_i_out.owner:</a>
<a class="sourceLine" id="org414cfc6-107" title="107">                        <span class="cf">if</span> (<span class="bu">isinstance</span>(_s_i_out.owner.op, tt.Subtensor) <span class="kw">and</span></a>
<a class="sourceLine" id="org414cfc6-108" title="108">                            <span class="bu">all</span>(<span class="bu">isinstance</span>(i, tt.Constant)</a>
<a class="sourceLine" id="org414cfc6-109" title="109">                                <span class="cf">for</span> i <span class="kw">in</span> _s_i_out.owner.inputs)):</a>
<a class="sourceLine" id="org414cfc6-110" title="110">                            s_i_out <span class="op">=</span> <span class="bu">str</span>(_s_i_out.owner.inputs[<span class="dv">0</span>].data[</a>
<a class="sourceLine" id="org414cfc6-111" title="111">                                _s_i_out.owner.inputs[<span class="dv">1</span>].data])</a>
<a class="sourceLine" id="org414cfc6-112" title="112">                        <span class="cf">elif</span> <span class="kw">not</span> <span class="bu">isinstance</span>(_s_i_out, tt.TensorVariable):</a>
<a class="sourceLine" id="org414cfc6-113" title="113">                            s_i_out <span class="op">=</span> pstate.pprinter.process(_s_i_out, pstate)</a>
<a class="sourceLine" id="org414cfc6-114" title="114">                <span class="cf">except</span> <span class="pp">KeyError</span>:</a>
<a class="sourceLine" id="org414cfc6-115" title="115">                    <span class="cf">pass</span></a>
<a class="sourceLine" id="org414cfc6-116" title="116">                <span class="cf">finally</span>:</a>
<a class="sourceLine" id="org414cfc6-117" title="117">                    pstate.precedence <span class="op">=</span> old_precedence</a>
<a class="sourceLine" id="org414cfc6-118" title="118"></a>
<a class="sourceLine" id="org414cfc6-119" title="119">            <span class="cf">if</span> <span class="kw">not</span> s_i_out:</a>
<a class="sourceLine" id="org414cfc6-120" title="120">                s_i_out <span class="op">=</span> cls.process_variable_name(output, pstate)</a>
<a class="sourceLine" id="org414cfc6-121" title="121">                s_i_out <span class="op">=</span> s_i_pat <span class="op">%</span> s_i_out</a>
<a class="sourceLine" id="org414cfc6-122" title="122"></a>
<a class="sourceLine" id="org414cfc6-123" title="123">            shape_dims <span class="op">+=</span> [s_i_out]</a>
<a class="sourceLine" id="org414cfc6-124" title="124"></a>
<a class="sourceLine" id="org414cfc6-125" title="125">        shape_info <span class="op">=</span> cls.process_variable_name(output, pstate)</a>
<a class="sourceLine" id="org414cfc6-126" title="126">        <span class="cf">if</span> using_latex:</a>
<a class="sourceLine" id="org414cfc6-127" title="127">            shape_info <span class="op">+=</span> <span class="st">&#39; </span><span class="ch">\\</span><span class="st">in </span><span class="ch">\\</span><span class="st">mathbb{</span><span class="sc">%s</span><span class="st">}&#39;</span> <span class="op">%</span> sspace_char</a>
<a class="sourceLine" id="org414cfc6-128" title="128">            shape_dims <span class="op">=</span> <span class="st">&#39; </span><span class="ch">\\</span><span class="st">times &#39;</span>.join(shape_dims)</a>
<a class="sourceLine" id="org414cfc6-129" title="129">            <span class="cf">if</span> shape_dims:</a>
<a class="sourceLine" id="org414cfc6-130" title="130">                shape_info <span class="op">+=</span> <span class="st">&#39;^{</span><span class="sc">%s</span><span class="st">}&#39;</span> <span class="op">%</span> shape_dims</a>
<a class="sourceLine" id="org414cfc6-131" title="131">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="org414cfc6-132" title="132">            shape_info <span class="op">+=</span> <span class="st">&#39; in </span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> sspace_char</a>
<a class="sourceLine" id="org414cfc6-133" title="133">            shape_dims <span class="op">=</span> <span class="st">&#39; x &#39;</span>.join(shape_dims)</a>
<a class="sourceLine" id="org414cfc6-134" title="134">            <span class="cf">if</span> shape_dims:</a>
<a class="sourceLine" id="org414cfc6-135" title="135">                shape_info <span class="op">+=</span> <span class="st">&#39;**(</span><span class="sc">%s</span><span class="st">)&#39;</span> <span class="op">%</span> shape_dims</a>
<a class="sourceLine" id="org414cfc6-136" title="136"></a>
<a class="sourceLine" id="org414cfc6-137" title="137">        <span class="cf">return</span> shape_info</a></code></pre></div>
<div class="sourceCode" id="orgccd5273"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgccd5273-1" title="1"><span class="kw">class</span> PreamblePPrinter(theano.printing.PPrinter):</a>
<a class="sourceLine" id="orgccd5273-2" title="2">    <span class="co">&quot;&quot;&quot;Pretty printer that displays a preamble.</span></a>
<a class="sourceLine" id="orgccd5273-3" title="3"></a>
<a class="sourceLine" id="orgccd5273-4" title="4"><span class="co">    For example,</span></a>
<a class="sourceLine" id="orgccd5273-5" title="5"></a>
<a class="sourceLine" id="orgccd5273-6" title="6"><span class="co">        X ~ N(\mu, \sigma)</span></a>
<a class="sourceLine" id="orgccd5273-7" title="7"><span class="co">        (b * X)</span></a>
<a class="sourceLine" id="orgccd5273-8" title="8"></a>
<a class="sourceLine" id="orgccd5273-9" title="9"><span class="co">    XXX: Not thread-safe!</span></a>
<a class="sourceLine" id="orgccd5273-10" title="10"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="orgccd5273-11" title="11">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="op">*</span>args, pstate_defaults<span class="op">=</span><span class="va">None</span>, <span class="op">**</span>kwargs):</a>
<a class="sourceLine" id="orgccd5273-12" title="12">        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">*</span>args, <span class="op">**</span>kwargs)</a>
<a class="sourceLine" id="orgccd5273-13" title="13">        <span class="va">self</span>.pstate_defaults <span class="op">=</span> pstate_defaults <span class="kw">or</span> {}</a>
<a class="sourceLine" id="orgccd5273-14" title="14">        <span class="va">self</span>.printers_dict <span class="op">=</span> <span class="bu">dict</span>(tt.pprint.printers_dict)</a>
<a class="sourceLine" id="orgccd5273-15" title="15">        <span class="va">self</span>.printers <span class="op">=</span> copy(tt.pprint.printers)</a>
<a class="sourceLine" id="orgccd5273-16" title="16">        <span class="va">self</span>._pstate <span class="op">=</span> <span class="va">None</span></a>
<a class="sourceLine" id="orgccd5273-17" title="17"></a>
<a class="sourceLine" id="orgccd5273-18" title="18">    <span class="kw">def</span> create_state(<span class="va">self</span>, pstate):</a>
<a class="sourceLine" id="orgccd5273-19" title="19">        <span class="co"># </span><span class="al">FIXME</span><span class="co">: Find all the user-defined node names and make the tag</span></a>
<a class="sourceLine" id="orgccd5273-20" title="20">        <span class="co"># generator aware of them.</span></a>
<a class="sourceLine" id="orgccd5273-21" title="21">        <span class="cf">if</span> pstate <span class="kw">is</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="orgccd5273-22" title="22">            pstate <span class="op">=</span> theano.printing.PrinterState(</a>
<a class="sourceLine" id="orgccd5273-23" title="23">                pprinter<span class="op">=</span><span class="va">self</span>,</a>
<a class="sourceLine" id="orgccd5273-24" title="24">                preamble_lines<span class="op">=</span>[],</a>
<a class="sourceLine" id="orgccd5273-25" title="25">                <span class="op">**</span><span class="va">self</span>.pstate_defaults)</a>
<a class="sourceLine" id="orgccd5273-26" title="26">        <span class="cf">elif</span> <span class="bu">isinstance</span>(pstate, <span class="bu">dict</span>):</a>
<a class="sourceLine" id="orgccd5273-27" title="27">            pstate.setdefault(<span class="st">&#39;preamble_lines&#39;</span>, [])</a>
<a class="sourceLine" id="orgccd5273-28" title="28">            pstate.update(<span class="va">self</span>.pstate_defaults)</a>
<a class="sourceLine" id="orgccd5273-29" title="29">            pstate <span class="op">=</span> theano.printing.PrinterState(pprinter<span class="op">=</span><span class="va">self</span>, <span class="op">**</span>pstate)</a>
<a class="sourceLine" id="orgccd5273-30" title="30"></a>
<a class="sourceLine" id="orgccd5273-31" title="31">        <span class="co"># </span><span class="al">FIXME</span><span class="co">: Good old fashioned circular references...</span></a>
<a class="sourceLine" id="orgccd5273-32" title="32">        <span class="co"># We&#39;re doing this so that `self.process` will be called correctly</span></a>
<a class="sourceLine" id="orgccd5273-33" title="33">        <span class="co"># accross all code.  (I&#39;m lookin&#39; about you, `DimShufflePrinter`; get</span></a>
<a class="sourceLine" id="orgccd5273-34" title="34">        <span class="co"># your act together.)</span></a>
<a class="sourceLine" id="orgccd5273-35" title="35">        pstate.pprinter._pstate <span class="op">=</span> pstate</a>
<a class="sourceLine" id="orgccd5273-36" title="36"></a>
<a class="sourceLine" id="orgccd5273-37" title="37">        <span class="cf">return</span> pstate</a>
<a class="sourceLine" id="orgccd5273-38" title="38"></a>
<a class="sourceLine" id="orgccd5273-39" title="39">    <span class="kw">def</span> process(<span class="va">self</span>, r, pstate<span class="op">=</span><span class="va">None</span>):</a>
<a class="sourceLine" id="orgccd5273-40" title="40">        pstate <span class="op">=</span> <span class="va">self</span>._pstate</a>
<a class="sourceLine" id="orgccd5273-41" title="41">        <span class="cf">assert</span> pstate</a>
<a class="sourceLine" id="orgccd5273-42" title="42">        <span class="cf">return</span> <span class="bu">super</span>().process(r, pstate)</a>
<a class="sourceLine" id="orgccd5273-43" title="43"></a>
<a class="sourceLine" id="orgccd5273-44" title="44">    <span class="kw">def</span> process_graph(<span class="va">self</span>, inputs, outputs, updates<span class="op">=</span><span class="va">None</span>,</a>
<a class="sourceLine" id="orgccd5273-45" title="45">                      display_inputs<span class="op">=</span><span class="va">False</span>):</a>
<a class="sourceLine" id="orgccd5273-46" title="46">        <span class="cf">raise</span> <span class="va">NotImplemented</span>()</a>
<a class="sourceLine" id="orgccd5273-47" title="47"></a>
<a class="sourceLine" id="orgccd5273-48" title="48">    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, <span class="op">*</span>args):</a>
<a class="sourceLine" id="orgccd5273-49" title="49">        var <span class="op">=</span> args[<span class="dv">0</span>]</a>
<a class="sourceLine" id="orgccd5273-50" title="50">        pstate <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(args[<span class="dv">1</span>:]), <span class="va">None</span>)</a>
<a class="sourceLine" id="orgccd5273-51" title="51">        <span class="cf">if</span> <span class="bu">isinstance</span>(pstate, (theano.printing.PrinterState, <span class="bu">dict</span>)):</a>
<a class="sourceLine" id="orgccd5273-52" title="52">            pstate <span class="op">=</span> <span class="va">self</span>.create_state(args[<span class="dv">1</span>])</a>
<a class="sourceLine" id="orgccd5273-53" title="53">        <span class="cf">elif</span> pstate <span class="kw">is</span> <span class="va">None</span>:</a>
<a class="sourceLine" id="orgccd5273-54" title="54">            pstate <span class="op">=</span> <span class="va">self</span>.create_state(<span class="va">None</span>)</a>
<a class="sourceLine" id="orgccd5273-55" title="55">        <span class="co"># else:</span></a>
<a class="sourceLine" id="orgccd5273-56" title="56">        <span class="co">#     # XXX: The graph processing doesn&#39;t pass around the printer state!</span></a>
<a class="sourceLine" id="orgccd5273-57" title="57">        <span class="co">#     # </span><span class="al">TODO</span><span class="co">: We&#39;ll have to copy the code and fix it...</span></a>
<a class="sourceLine" id="orgccd5273-58" title="58">        <span class="co">#     raise NotImplemented(&#39;No preambles for graph printing, yet.&#39;)</span></a>
<a class="sourceLine" id="orgccd5273-59" title="59"></a>
<a class="sourceLine" id="orgccd5273-60" title="60">        <span class="co"># This pretty printer needs more information about shapes and inputs,</span></a>
<a class="sourceLine" id="orgccd5273-61" title="61">        <span class="co"># which it gets from a `FunctionGraph`.  Create one, if `var` isn&#39;t</span></a>
<a class="sourceLine" id="orgccd5273-62" title="62">        <span class="co"># already assigned one.</span></a>
<a class="sourceLine" id="orgccd5273-63" title="63">        fgraph <span class="op">=</span> <span class="bu">getattr</span>(var, <span class="st">&#39;fgraph&#39;</span>, <span class="va">None</span>)</a>
<a class="sourceLine" id="orgccd5273-64" title="64">        <span class="cf">if</span> <span class="kw">not</span> fgraph:</a>
<a class="sourceLine" id="orgccd5273-65" title="65">            fgraph <span class="op">=</span> tt.gof.fg.FunctionGraph(</a>
<a class="sourceLine" id="orgccd5273-66" title="66">                tt.gof.graph.inputs([var]), [var])</a>
<a class="sourceLine" id="orgccd5273-67" title="67">            var <span class="op">=</span> fgraph.outputs[<span class="dv">0</span>]</a>
<a class="sourceLine" id="orgccd5273-68" title="68"></a>
<a class="sourceLine" id="orgccd5273-69" title="69">            <span class="co"># Use this to get better shape info</span></a>
<a class="sourceLine" id="orgccd5273-70" title="70">            shape_feature <span class="op">=</span> tt.opt.ShapeFeature()</a>
<a class="sourceLine" id="orgccd5273-71" title="71">            fgraph.attach_feature(shape_feature)</a>
<a class="sourceLine" id="orgccd5273-72" title="72"></a>
<a class="sourceLine" id="orgccd5273-73" title="73">        body_str <span class="op">=</span> <span class="bu">super</span>().<span class="fu">__call__</span>(var, pstate)</a>
<a class="sourceLine" id="orgccd5273-74" title="74"></a>
<a class="sourceLine" id="orgccd5273-75" title="75">        <span class="cf">if</span> pstate.preamble_lines <span class="kw">and</span> <span class="bu">getattr</span>(pstate, <span class="st">&#39;latex&#39;</span>, <span class="va">False</span>):</a>
<a class="sourceLine" id="orgccd5273-76" title="76">            preamble_str <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\n\\\\\n</span><span class="st">&quot;</span>.join(pstate.preamble_lines)</a>
<a class="sourceLine" id="orgccd5273-77" title="77">            preamble_str <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">begin</span><span class="sc">{gathered}</span><span class="ch">\n</span><span class="sc">%s</span><span class="ch">\n\\</span><span class="st">end</span><span class="sc">{gathered}</span><span class="st">&quot;</span> <span class="op">%</span> (preamble_str)</a>
<a class="sourceLine" id="orgccd5273-78" title="78">            <span class="cf">return</span> <span class="st">&quot;</span><span class="ch">\n\\\\\n</span><span class="st">&quot;</span>.join([preamble_str, body_str])</a>
<a class="sourceLine" id="orgccd5273-79" title="79">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="orgccd5273-80" title="80">            <span class="cf">return</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>.join(pstate.preamble_lines <span class="op">+</span> [body_str])</a></code></pre></div>
<div class="sourceCode" id="orgfc82717"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgfc82717-1" title="1">tt_pprint <span class="op">=</span> PreamblePPrinter()</a>
<a class="sourceLine" id="orgfc82717-2" title="2">tt_pprint.assign(<span class="kw">lambda</span> pstate, r: <span class="va">True</span>, VariableWithShapePrinter)</a>
<a class="sourceLine" id="orgfc82717-3" title="3">tt_pprint.assign(UniformRV, RandomVariablePrinter(<span class="st">&#39;U&#39;</span>))</a>
<a class="sourceLine" id="orgfc82717-4" title="4">tt_pprint.assign(NormalRV, RandomVariablePrinter(<span class="st">&#39;N&#39;</span>))</a>
<a class="sourceLine" id="orgfc82717-5" title="5">tt_pprint.assign(GammaRV, RandomVariablePrinter(<span class="st">&#39;Gamma&#39;</span>))</a>
<a class="sourceLine" id="orgfc82717-6" title="6">tt_pprint.assign(ExponentialRV, RandomVariablePrinter(<span class="st">&#39;Exp&#39;</span>))</a>
<a class="sourceLine" id="orgfc82717-7" title="7">tt_pprint.assign(MvNormalRV, RandomVariablePrinter(<span class="st">&#39;N&#39;</span>))</a>
<a class="sourceLine" id="orgfc82717-8" title="8">tt_pprint.assign(DirichletRV, RandomVariablePrinter(<span class="st">&#39;Dir&#39;</span>))</a>
<a class="sourceLine" id="orgfc82717-9" title="9">tt_pprint.assign(PoissonRV, RandomVariablePrinter(<span class="st">&#39;Pois&#39;</span>))</a>
<a class="sourceLine" id="orgfc82717-10" title="10">tt_pprint.assign(CauchyRV, RandomVariablePrinter(<span class="st">&#39;C&#39;</span>))</a>
<a class="sourceLine" id="orgfc82717-11" title="11">tt_pprint.assign(MultinomialRV, RandomVariablePrinter(<span class="st">&#39;MN&#39;</span>))</a>
<a class="sourceLine" id="orgfc82717-12" title="12"></a>
<a class="sourceLine" id="orgfc82717-13" title="13">tt_tex_pprint <span class="op">=</span> PreamblePPrinter(pstate_defaults<span class="op">=</span>{<span class="st">&#39;latex&#39;</span>: <span class="va">True</span>})</a>
<a class="sourceLine" id="orgfc82717-14" title="14">tt_tex_pprint.printers <span class="op">=</span> copy(tt_pprint.printers)</a>
<a class="sourceLine" id="orgfc82717-15" title="15">tt_tex_pprint.printers_dict <span class="op">=</span> <span class="bu">dict</span>(tt_pprint.printers_dict)</a>
<a class="sourceLine" id="orgfc82717-16" title="16">tt_tex_pprint.assign(tt.mul, theano.printing.OperatorPrinter(<span class="st">&#39;</span><span class="ch">\\</span><span class="st">odot&#39;</span>, <span class="dv">-1</span>, <span class="st">&#39;either&#39;</span>))</a>
<a class="sourceLine" id="orgfc82717-17" title="17">tt_tex_pprint.assign(tt.true_div, theano.printing.PatternPrinter((<span class="st">&#39;</span><span class="ch">\\</span><span class="st">frac{</span><span class="sc">%(0)s</span><span class="st">}{</span><span class="sc">%(1)s</span><span class="st">}&#39;</span>, <span class="dv">-1000</span>)))</a>
<a class="sourceLine" id="orgfc82717-18" title="18">tt_tex_pprint.assign(tt.<span class="bu">pow</span>, theano.printing.PatternPrinter((<span class="st">&#39;{</span><span class="sc">%(0)s</span><span class="st">}^{</span><span class="sc">%(1)s</span><span class="st">}&#39;</span>, <span class="dv">-1000</span>)))</a></code></pre></div>
<div class="example" data-markdown="">
<p>Listing <a href="#org1ed4a46">35</a>, creates a graph with two random variables and prints the results with the default Theano pretty printer.</p>
<div class="sourceCode" id="org0e19f4e"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org0e19f4e-1" title="1">Z_tt <span class="op">=</span> UniformRV(tt.scalar(<span class="st">&#39;l_0&#39;</span>), tt.scalar(<span class="st">&#39;l_1&#39;</span>), name<span class="op">=</span><span class="st">&#39;Z&#39;</span>)</a>
<a class="sourceLine" id="org0e19f4e-2" title="2">X_tt <span class="op">=</span> NormalRV(Z_tt, tt.scalar(<span class="st">&#39;\sigma_1&#39;</span>), name<span class="op">=</span><span class="st">&#39;X&#39;</span>)</a>
<a class="sourceLine" id="org0e19f4e-3" title="3">Y_tt <span class="op">=</span> MvNormalRV(tt.vector(<span class="st">&#39;\mu&#39;</span>), tt.abs_(X_tt) <span class="op">*</span> tt.constant(np.diag([<span class="dv">1</span>, <span class="dv">2</span>])), name<span class="op">=</span><span class="st">&#39;Y&#39;</span>)</a>
<a class="sourceLine" id="org0e19f4e-4" title="4"></a>
<a class="sourceLine" id="org0e19f4e-5" title="5">W_tt <span class="op">=</span> X_tt <span class="op">*</span> (tt.scalar(<span class="st">&#39;b&#39;</span>) <span class="op">*</span> Y_tt <span class="op">+</span> tt.scalar(<span class="st">&#39;c&#39;</span>))</a></code></pre></div>
<div class="sourceCode" id="org1ed4a46"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org1ed4a46-1" title="1"><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">begin</span><span class="sc">{{</span><span class="st">equation*</span><span class="sc">}}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n\\</span><span class="st">end</span><span class="sc">{{</span><span class="st">equation*</span><span class="sc">}}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="org1ed4a46-2" title="2">    tt_tex_pprint(W_tt, {<span class="st">&#39;latex&#39;</span>: <span class="va">True</span>, <span class="st">&#39;latex_aligned&#39;</span>: <span class="va">True</span>})))</a></code></pre></div>
<p><span class="math display">\[\begin{equation*}
\begin{gathered}
l_0 \in \mathbb{R}
\\
l_1 \in \mathbb{R}
\\
Z \sim \operatorname{U}\left(l_0, l_1\right), \quad Z \in \mathbb{R}
\\
\sigma_1 \in \mathbb{R}
\\
X \sim \operatorname{N}\left(Z, \sigma_1\right), \quad X \in \mathbb{R}
\\
b \in \mathbb{R}
\\
\mu \in \mathbb{R}^{{n^{\mu}}_{0}}
\\
Y \sim \operatorname{N}\left(\mu, (|X| \odot \left[\begin{matrix}1 &amp; 0\\0 &amp; 2\end{matrix}\right])\right), \quad Y \in \mathbb{R}^{{n^{Y}}_{0}}
\\
c \in \mathbb{R}
\end{gathered}
\\
(X \odot ((b \odot Y) + c))
\end{equation*}\]</span></p>
</div>
</section>
</section>
<section id="algebraic-manipulations" class="level1">
<h1>Algebraic Manipulations</h1>
<p>With our new <code>RandomVariable</code>, we can alter the replacement patterns used by <code>tt.gof.opt.PatternSub</code> in <a href="#24875a2c31fa7f94ce562adddedc0bf8">Willard, Brandon T. (2018)</a> and implement a slightly better parameter lifting for affine transforms of scalar normal random variables in Listing <a href="#orgc483b75">36</a>.</p>
<div class="sourceCode" id="orgc483b75"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgc483b75-1" title="1">norm_lift_pats <span class="op">=</span> [</a>
<a class="sourceLine" id="orgc483b75-2" title="2">    <span class="co"># Lift element-wise multiplication</span></a>
<a class="sourceLine" id="orgc483b75-3" title="3">    tt.gof.opt.PatternSub(</a>
<a class="sourceLine" id="orgc483b75-4" title="4">        (tt.mul,</a>
<a class="sourceLine" id="orgc483b75-5" title="5">         <span class="st">&#39;a_x&#39;</span>,</a>
<a class="sourceLine" id="orgc483b75-6" title="6">         (NormalRV, <span class="st">&#39;mu_x&#39;</span>, <span class="st">&#39;sd_x&#39;</span>, <span class="st">&#39;size_x&#39;</span>, <span class="st">&#39;rs_x&#39;</span>)),</a>
<a class="sourceLine" id="orgc483b75-7" title="7">        (NormalRV,</a>
<a class="sourceLine" id="orgc483b75-8" title="8">         (tt.mul, <span class="st">&#39;a_x&#39;</span>, <span class="st">&#39;mu_x&#39;</span>),</a>
<a class="sourceLine" id="orgc483b75-9" title="9">         (tt.mul, <span class="st">&#39;a_x&#39;</span>, <span class="st">&#39;sd_x&#39;</span>),</a>
<a class="sourceLine" id="orgc483b75-10" title="10">         <span class="st">&#39;size_x&#39;</span>,</a>
<a class="sourceLine" id="orgc483b75-11" title="11">         <span class="st">&#39;rs_x&#39;</span>,</a>
<a class="sourceLine" id="orgc483b75-12" title="12">        )),</a>
<a class="sourceLine" id="orgc483b75-13" title="13">    <span class="co"># Lift element-wise addition</span></a>
<a class="sourceLine" id="orgc483b75-14" title="14">    tt.gof.opt.PatternSub(</a>
<a class="sourceLine" id="orgc483b75-15" title="15">        (tt.add,</a>
<a class="sourceLine" id="orgc483b75-16" title="16">         (NormalRV, <span class="st">&#39;mu_x&#39;</span>, <span class="st">&#39;sd_x&#39;</span>, <span class="st">&#39;size_x&#39;</span>, <span class="st">&#39;rs_x&#39;</span>),</a>
<a class="sourceLine" id="orgc483b75-17" title="17">         <span class="st">&#39;b_x&#39;</span>),</a>
<a class="sourceLine" id="orgc483b75-18" title="18">        (NormalRV,</a>
<a class="sourceLine" id="orgc483b75-19" title="19">         (tt.add, <span class="st">&#39;mu_x&#39;</span>, <span class="st">&#39;b_x&#39;</span>),</a>
<a class="sourceLine" id="orgc483b75-20" title="20">         <span class="st">&#39;sd_x&#39;</span>,</a>
<a class="sourceLine" id="orgc483b75-21" title="21">         <span class="st">&#39;size_x&#39;</span>,</a>
<a class="sourceLine" id="orgc483b75-22" title="22">         <span class="st">&#39;rs_x&#39;</span>,</a>
<a class="sourceLine" id="orgc483b75-23" title="23">        )),</a>
<a class="sourceLine" id="orgc483b75-24" title="24">]</a>
<a class="sourceLine" id="orgc483b75-25" title="25"></a>
<a class="sourceLine" id="orgc483b75-26" title="26">norm_lift_opts <span class="op">=</span> tt.gof.opt.EquilibriumOptimizer(</a>
<a class="sourceLine" id="orgc483b75-27" title="27">    norm_lift_pats, max_use_ratio<span class="op">=</span><span class="dv">10</span>)</a></code></pre></div>
<div class="example" data-markdown="">
<div class="sourceCode" id="orgc69f52b"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgc69f52b-1" title="1"><span class="co"># [[file:~/projects/websites/brandonwillard.github.io/content/articles/src/org/symbolic-math-in-pymc3-new-op.org::graph-manipulation-setup][graph-manipulation-setup]]</span></a>
<a class="sourceLine" id="orgc69f52b-2" title="2"><span class="im">from</span> theano.gof <span class="im">import</span> FunctionGraph, Feature, NodeFinder</a>
<a class="sourceLine" id="orgc69f52b-3" title="3"><span class="im">from</span> theano.gof.graph <span class="im">import</span> inputs <span class="im">as</span> tt_inputs, clone_get_equiv</a>
<a class="sourceLine" id="orgc69f52b-4" title="4"></a>
<a class="sourceLine" id="orgc69f52b-5" title="5">theano.config.compute_test_value <span class="op">=</span> <span class="st">&#39;ignore&#39;</span></a>
<a class="sourceLine" id="orgc69f52b-6" title="6"><span class="co"># graph-manipulation-setup ends here</span></a>
<a class="sourceLine" id="orgc69f52b-7" title="7"></a>
<a class="sourceLine" id="orgc69f52b-8" title="8">mu_X <span class="op">=</span> tt.vector(<span class="st">&#39;\mu&#39;</span>)</a>
<a class="sourceLine" id="orgc69f52b-9" title="9">sd_X <span class="op">=</span> tt.vector(<span class="st">&#39;\sigma&#39;</span>)</a>
<a class="sourceLine" id="orgc69f52b-10" title="10"></a>
<a class="sourceLine" id="orgc69f52b-11" title="11">a_tt <span class="op">=</span> tt.fscalar(<span class="st">&#39;a&#39;</span>)</a>
<a class="sourceLine" id="orgc69f52b-12" title="12">b_tt <span class="op">=</span> tt.fscalar(<span class="st">&#39;b&#39;</span>)</a>
<a class="sourceLine" id="orgc69f52b-13" title="13"></a>
<a class="sourceLine" id="orgc69f52b-14" title="14">X_rv <span class="op">=</span> NormalRV(mu_X, sd_X, name<span class="op">=</span><span class="st">&#39;X&#39;</span>)</a>
<a class="sourceLine" id="orgc69f52b-15" title="15">trans_X_rv <span class="op">=</span> a_tt <span class="op">*</span> X_rv <span class="op">+</span> b_tt</a>
<a class="sourceLine" id="orgc69f52b-16" title="16"></a>
<a class="sourceLine" id="orgc69f52b-17" title="17">trans_X_graph <span class="op">=</span> FunctionGraph(tt_inputs([trans_X_rv]), [trans_X_rv])</a>
<a class="sourceLine" id="orgc69f52b-18" title="18"></a>
<a class="sourceLine" id="orgc69f52b-19" title="19"><span class="co"># Create a copy and optimize that</span></a>
<a class="sourceLine" id="orgc69f52b-20" title="20">trans_X_graph_opt <span class="op">=</span> trans_X_graph.clone()</a>
<a class="sourceLine" id="orgc69f52b-21" title="21"></a>
<a class="sourceLine" id="orgc69f52b-22" title="22">_ <span class="op">=</span> norm_lift_opts.optimize(trans_X_graph_opt)</a></code></pre></div>
<div class="sourceCode" id="org2bd1258"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org2bd1258-1" title="1"><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">begin</span><span class="sc">{{</span><span class="st">equation*</span><span class="sc">}}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n\\</span><span class="st">end</span><span class="sc">{{</span><span class="st">equation*</span><span class="sc">}}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="org2bd1258-2" title="2">    tt_tex_pprint(trans_X_graph.outputs[<span class="dv">0</span>])))</a></code></pre></div>
<p>Before applying the optimization:</p>
<p><span class="math display">\[\begin{equation*}
\begin{gathered}
a \in \mathbb{R}
\\
\mu \in \mathbb{R}^{{n^{\mu}}_{0}}
\\
\sigma \in \mathbb{R}^{{n^{\sigma}}_{0}}
\\
X \sim \operatorname{N}\left(\mu, \sigma\right), \quad X \in \mathbb{R}^{{n^{X}}_{0}}
\\
b \in \mathbb{R}
\end{gathered}
\\
((a \odot X) + b)
\end{equation*}\]</span></p>
<div class="sourceCode" id="orge71b0ac"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orge71b0ac-1" title="1"><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\\</span><span class="st">begin</span><span class="sc">{{</span><span class="st">equation*</span><span class="sc">}}</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n\\</span><span class="st">end</span><span class="sc">{{</span><span class="st">equation*</span><span class="sc">}}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orge71b0ac-2" title="2">    tt_tex_pprint(trans_X_graph_opt.outputs[<span class="dv">0</span>])))</a></code></pre></div>
<p>After applying the optimization:</p>
<p><span class="math display">\[\begin{equation*}
\begin{gathered}
a \in \mathbb{R}
\\
\mu \in \mathbb{R}^{{n^{\mu}}_{0}}
\\
b \in \mathbb{R}
\\
\sigma \in \mathbb{R}^{{n^{\sigma}}_{0}}
\\
u \sim \operatorname{N}\left(((a \odot \mu) + b), (a \odot \sigma)\right), \quad u \in \mathbb{R}^{{n^{u}}_{0}}
\end{gathered}
\\
u
\end{equation*}\]</span></p>
</div>
<p>Now, what if we wanted to handle affine transformations of a multivariate normal random variable? Specifically, consider the following:</p>
<p><span class="math display">\[\begin{equation*}
  X \sim N\left(\mu, \Sigma \right), \quad
  A X \sim N\left(A \mu, A \Sigma A^\top \right)
 \;.
\end{equation*}\]</span></p>
<p>At first, the substitution pattern in Listing <a href="#org4a792de">40</a> might seem reasonable.</p>
<div class="sourceCode" id="org4a792de"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org4a792de-1" title="1"><span class="co"># Vector multiplication</span></a>
<a class="sourceLine" id="org4a792de-2" title="2">tt.gof.opt.PatternSub(</a>
<a class="sourceLine" id="org4a792de-3" title="3">    (tt.dot, <span class="st">&#39;A_x&#39;</span>,</a>
<a class="sourceLine" id="org4a792de-4" title="4">     (MvNormalRV, <span class="st">&#39;mu_x&#39;</span>, <span class="st">&#39;cov_x&#39;</span>, <span class="st">&#39;size_x&#39;</span>, <span class="st">&#39;rs_x&#39;</span>)),</a>
<a class="sourceLine" id="org4a792de-5" title="5">    (MvNormalRV,</a>
<a class="sourceLine" id="org4a792de-6" title="6">     (tt.dot, <span class="st">&#39;A_x&#39;</span>, <span class="st">&#39;mu_x&#39;</span>),</a>
<a class="sourceLine" id="org4a792de-7" title="7">     (tt.dot,</a>
<a class="sourceLine" id="org4a792de-8" title="8">      (tt.dot, <span class="st">&#39;A_x&#39;</span>, <span class="st">&#39;cov_x&#39;</span>)</a>
<a class="sourceLine" id="org4a792de-9" title="9">      (tt.transpose, <span class="st">&#39;A_x&#39;</span>)),</a>
<a class="sourceLine" id="org4a792de-10" title="10">     <span class="st">&#39;size_x&#39;</span>,</a>
<a class="sourceLine" id="org4a792de-11" title="11">     <span class="st">&#39;rs_x&#39;</span>,</a>
<a class="sourceLine" id="org4a792de-12" title="12">    ))</a></code></pre></div>
<p>Unfortunately, the combination of size parameter and broadcasting complicates the scenario. Both parameters indirectly affect the distribution parameters, making the un-lifted dot-product consistent, but not necessarily the lifted products.</p>
<p>The following example demonstrates the lifting issues brought on by broadcasting.</p>
<div class="example" data-markdown="">
<p>We create a simple multivariate normal in Listing <a href="#org7446c7b">41</a>.</p>
<div class="sourceCode" id="org7446c7b"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org7446c7b-1" title="1">mu_X <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">10</span>]</a>
<a class="sourceLine" id="org7446c7b-2" title="2">cov_X <span class="op">=</span> np.diag([<span class="dv">1</span>, <span class="fl">1e-2</span>])</a>
<a class="sourceLine" id="org7446c7b-3" title="3">size_X_rv <span class="op">=</span> [<span class="dv">2</span>, <span class="dv">3</span>]</a>
<a class="sourceLine" id="org7446c7b-4" title="4">X_rv <span class="op">=</span> MvNormalRV(mu_X, cov_X, size<span class="op">=</span>size_X_rv)</a>
<a class="sourceLine" id="org7446c7b-5" title="5"></a>
<a class="sourceLine" id="org7446c7b-6" title="6"><span class="bu">print</span>(<span class="st">&#39;</span><span class="sc">{}</span><span class="st"> ~ X_rv</span><span class="ch">\n</span><span class="st">&#39;</span>.<span class="bu">format</span>(X_rv.tag.test_value))</a></code></pre></div>
<div class="sourceCode" id="orgc7d92d4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgc7d92d4-1" title="1">[[[<span class="op">-</span><span class="fl">0.68284424</span>  <span class="fl">9.95587926</span>]</a>
<a class="sourceLine" id="orgc7d92d4-2" title="2">  [ <span class="fl">1.66236785</span>  <span class="fl">9.87590909</span>]</a>
<a class="sourceLine" id="orgc7d92d4-3" title="3">  [ <span class="fl">0.23449772</span> <span class="fl">10.12455681</span>]]</a>
<a class="sourceLine" id="orgc7d92d4-4" title="4"></a>
<a class="sourceLine" id="orgc7d92d4-5" title="5"> [[ <span class="fl">0.3342739</span>  <span class="fl">10.05580428</span>]</a>
<a class="sourceLine" id="orgc7d92d4-6" title="6">  [<span class="op">-</span><span class="fl">0.18913408</span> <span class="fl">10.0359336</span> ]</a>
<a class="sourceLine" id="orgc7d92d4-7" title="7">  [<span class="op">-</span><span class="fl">1.2463576</span>   <span class="fl">9.90671218</span>]]] <span class="op">~</span> X_rv</a>
<a class="sourceLine" id="orgc7d92d4-8" title="8"></a></code></pre></div>
<p>Next, we create a simple matrix operator to apply to the multivariate normal.</p>
<div class="sourceCode" id="org0f84661"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org0f84661-1" title="1">A_tt <span class="op">=</span> tt.as_tensor_variable([[<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">8</span>], [<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">9</span>]])</a>
<a class="sourceLine" id="org0f84661-2" title="2"><span class="co"># or A_tt = tt.as_tensor_variable([[2, 5, 8]])</span></a>
<a class="sourceLine" id="org0f84661-3" title="3"></a>
<a class="sourceLine" id="org0f84661-4" title="4"><span class="co"># It&#39;s really just `mu_X`...</span></a>
<a class="sourceLine" id="org0f84661-5" title="5">E_X_rv <span class="op">=</span> X_rv.owner.inputs[<span class="dv">2</span>]</a>
<a class="sourceLine" id="org0f84661-6" title="6"></a>
<a class="sourceLine" id="org0f84661-7" title="7"><span class="bu">print</span>(<span class="st">&#39;A * X_rv =</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&#39;</span>.<span class="bu">format</span>(tt.dot(A_tt, X_rv).tag.test_value))</a></code></pre></div>
<div class="sourceCode" id="org2cb4213"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org2cb4213-1" title="1">A <span class="op">*</span> X_rv <span class="op">=</span></a>
<a class="sourceLine" id="org2cb4213-2" title="2">[[[  <span class="fl">1.18524621</span> <span class="fl">150.31045062</span>]</a>
<a class="sourceLine" id="org2cb4213-3" title="3">  [  <span class="fl">1.07000851</span> <span class="fl">150.65771936</span>]]</a>
<a class="sourceLine" id="org2cb4213-4" title="4"></a>
<a class="sourceLine" id="org2cb4213-5" title="5"> [[  <span class="fl">1.31685497</span> <span class="fl">160.33572146</span>]</a>
<a class="sourceLine" id="org2cb4213-6" title="6">  [  <span class="fl">0.33506491</span> <span class="fl">160.82202495</span>]]]</a>
<a class="sourceLine" id="org2cb4213-7" title="7"></a></code></pre></div>
<p>As we can see, the multivariate normal’s test/sampled value has the correct shape for our matrix operator.</p>
<div class="sourceCode" id="orgd95a139"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgd95a139-1" title="1"><span class="im">import</span> traceback</a>
<a class="sourceLine" id="orgd95a139-2" title="2"><span class="cf">try</span>:</a>
<a class="sourceLine" id="orgd95a139-3" title="3">    <span class="bu">print</span>(<span class="st">&#39;A * E[X_rv] =</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&#39;</span>.<span class="bu">format</span>(tt.dot(A_tt, E_X_rv).tag.test_value))</a>
<a class="sourceLine" id="orgd95a139-4" title="4"><span class="cf">except</span> <span class="pp">ValueError</span> <span class="im">as</span> e:</a>
<a class="sourceLine" id="orgd95a139-5" title="5">    <span class="bu">print</span>(<span class="st">&quot;&quot;</span>.join(traceback.format_exception_only(<span class="bu">type</span>(e), e)))</a></code></pre></div>
<div class="sourceCode" id="org46ec622"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org46ec622-1" title="1"><span class="pp">ValueError</span>: shapes (<span class="dv">2</span>,<span class="dv">3</span>) <span class="kw">and</span> (<span class="dv">2</span>,) <span class="kw">not</span> aligned: <span class="dv">3</span> (dim <span class="dv">1</span>) <span class="op">!=</span> <span class="dv">2</span> (dim <span class="dv">0</span>)</a>
<a class="sourceLine" id="org46ec622-2" title="2"></a></code></pre></div>
<p>However, we see that the multivariate normal’s inputs (i.e. the <code>Op</code> inputs)–specifically the mean parameter–do not directly reflect the support’s shape, as one might expect.</p>
<div class="sourceCode" id="org6e32649"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org6e32649-1" title="1">size_tile <span class="op">=</span> <span class="bu">tuple</span>(size_X_rv) <span class="op">+</span> (<span class="dv">1</span>,)</a>
<a class="sourceLine" id="org6e32649-2" title="2">E_X_rv_ <span class="op">=</span> tt.tile(E_X_rv, size_tile, X_rv.ndim)</a>
<a class="sourceLine" id="org6e32649-3" title="3"></a>
<a class="sourceLine" id="org6e32649-4" title="4"><span class="bu">print</span>(<span class="st">&#39;A * E[X_rv] =</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">&#39;</span>.<span class="bu">format</span>(tt.dot(A_tt, E_X_rv_).tag.test_value))</a></code></pre></div>
<div class="sourceCode" id="orgc405b2a"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgc405b2a-1" title="1">A <span class="op">*</span> E[X_rv] <span class="op">=</span></a>
<a class="sourceLine" id="orgc405b2a-2" title="2">[[[  <span class="dv">0</span> <span class="dv">150</span>]</a>
<a class="sourceLine" id="orgc405b2a-3" title="3">  [  <span class="dv">0</span> <span class="dv">150</span>]]</a>
<a class="sourceLine" id="orgc405b2a-4" title="4"></a>
<a class="sourceLine" id="orgc405b2a-5" title="5"> [[  <span class="dv">0</span> <span class="dv">160</span>]</a>
<a class="sourceLine" id="orgc405b2a-6" title="6">  [  <span class="dv">0</span> <span class="dv">160</span>]]]</a>
<a class="sourceLine" id="orgc405b2a-7" title="7"></a></code></pre></div>
<p>We can manually replicate the inputs so that they match the output shape, but a solution to the general problem requires a more organized response.</p>
</div>
</section>
<section id="a-problem-with-conversion-from-pymc3" class="level1">
<h1>A Problem with Conversion from PyMC3</h1>
<p>As in <a href="#24875a2c31fa7f94ce562adddedc0bf8">Willard, Brandon T. (2018)</a>, we can create mappings between existing PyMC3 random variables and their new <code>RandomVariable</code> equivalents.</p>
<div class="example" data-markdown="">
<div class="sourceCode" id="org8bffc80"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org8bffc80-1" title="1">pymc_theano_rv_equivs <span class="op">=</span> {</a>
<a class="sourceLine" id="org8bffc80-2" title="2">    pm.Normal:</a>
<a class="sourceLine" id="org8bffc80-3" title="3">    <span class="kw">lambda</span> dist, rand_state:</a>
<a class="sourceLine" id="org8bffc80-4" title="4">    (<span class="va">None</span>,</a>
<a class="sourceLine" id="org8bffc80-5" title="5">     <span class="co"># PyMC3 shapes aren&#39;t NumPy-like size parameters, so we attempt to</span></a>
<a class="sourceLine" id="org8bffc80-6" title="6">     <span class="co"># adjust for that.</span></a>
<a class="sourceLine" id="org8bffc80-7" title="7">     NormalRV(dist.mu, dist.sd, size<span class="op">=</span>dist.shape[<span class="dv">1</span>:], rng<span class="op">=</span>rand_state)),</a>
<a class="sourceLine" id="org8bffc80-8" title="8">    pm.MvNormal:</a>
<a class="sourceLine" id="org8bffc80-9" title="9">    <span class="kw">lambda</span> dist, rand_state:</a>
<a class="sourceLine" id="org8bffc80-10" title="10">    (<span class="va">None</span>, NormalRV(dist.mu, dist.cov, size<span class="op">=</span>dist.shape[<span class="dv">1</span>:], rng<span class="op">=</span>rand_state)),</a>
<a class="sourceLine" id="org8bffc80-11" title="11">}</a></code></pre></div>
</div>
<p>However, if we attempt the same PymC3 graph conversion approach as before (i.e. convert a PyMC3 model to a Theano <code>FunctionGraph</code> using <code>model_graph</code>, then replace PyMC3 random variable nodes with our new random variable types using <code>create_theano_rvs</code>), we’re likely to run into a problem involving mismatching broadcastable dimensions.</p>
<p>The problem arises because <strong>PyMC3 “knows” more broadcast information than it should</strong>, since it uses the Theano variables’ test values in order to obtain concrete shapes for the random variables it creates. Using concrete, non-symbolic shapes, it can exactly determine what would otherwise be ambiguous <a href="http://deeplearning.net/software/theano/library/tensor/basic.html?highlight=broadcastable#theano.tensor.TensorType.broadcastable">broadcastable dimensions</a> at the symbolic level.</p>
<p>More specifically, broadcast information is required during the construction of a Theano <code>TensorType</code>, so PyMC3 random variable types can be inconsistent (unnecessarily restrictive, really) causing Theano to complain when we try to construct a <code>FunctionGraph</code>.</p>
<div class="example" data-markdown="">
<p>Consider the following example; it constructs two purely symbolic Theano vectors: one with broadcasting and one without.</p>
<div class="sourceCode" id="orgbd54927"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgbd54927-1" title="1">y_tt <span class="op">=</span> tt.row(<span class="st">&#39;y&#39;</span>)</a>
<a class="sourceLine" id="orgbd54927-2" title="2"><span class="bu">print</span>(<span class="st">&quot;y_tt.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(y_tt.broadcastable))</a>
<a class="sourceLine" id="orgbd54927-3" title="3"></a>
<a class="sourceLine" id="orgbd54927-4" title="4">x_tt <span class="op">=</span> tt.matrix(<span class="st">&#39;x&#39;</span>)</a>
<a class="sourceLine" id="orgbd54927-5" title="5"><span class="bu">print</span>(<span class="st">&quot;x_tt.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(x_tt.broadcastable))</a></code></pre></div>
<div class="sourceCode" id="orgad91de3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgad91de3-1" title="1">y_tt.broadcastable <span class="op">=</span> (<span class="va">True</span>, <span class="va">False</span>)</a>
<a class="sourceLine" id="orgad91de3-2" title="2">x_tt.broadcastable <span class="op">=</span> (<span class="va">False</span>, <span class="va">False</span>)</a>
<a class="sourceLine" id="orgad91de3-3" title="3"></a></code></pre></div>
<p>Notice that it–by default–signifies no broadcasting on its first and only dimension.</p>
<p>If we wish–or if <a href="http://deeplearning.net/software/theano/library/config.html#config.compute_test_value">Theano’s configuration demands</a> it–we can assign the symbolic vector arbitrary test values, as long as they’re consistent with its type (i.e. a vector, or 1-dimensional array).</p>
<p>In the following, we assign both a broadcastable (i.e. first–and only–dimension has size 1) and non-broadcastable test value.</p>
<p>Test value is broadcastable:</p>
<div class="sourceCode" id="orgaadc727"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orgaadc727-1" title="1"><span class="im">from</span> contextlib <span class="im">import</span> contextmanager</a>
<a class="sourceLine" id="orgaadc727-2" title="2"></a>
<a class="sourceLine" id="orgaadc727-3" title="3"></a>
<a class="sourceLine" id="orgaadc727-4" title="4">x_tt.tag.test_value <span class="op">=</span> np.array([[<span class="dv">5</span>]])</a>
<a class="sourceLine" id="orgaadc727-5" title="5"></a>
<a class="sourceLine" id="orgaadc727-6" title="6"><span class="bu">print</span>(<span class="st">&quot;test_value.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orgaadc727-7" title="7">    tt.as_tensor_variable(x_tt.tag.test_value).broadcastable))</a>
<a class="sourceLine" id="orgaadc727-8" title="8"><span class="bu">print</span>(<span class="st">&quot;x_tt.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(x_tt.broadcastable))</a>
<a class="sourceLine" id="orgaadc727-9" title="9"></a>
<a class="sourceLine" id="orgaadc727-10" title="10"><span class="at">@contextmanager</span></a>
<a class="sourceLine" id="orgaadc727-11" title="11"><span class="kw">def</span> short_exception_msg(exc_type):</a>
<a class="sourceLine" id="orgaadc727-12" title="12">    _verbosity <span class="op">=</span> theano.config.exception_verbosity</a>
<a class="sourceLine" id="orgaadc727-13" title="13">    theano.config.exception_verbosity <span class="op">=</span> <span class="st">&#39;low&#39;</span></a>
<a class="sourceLine" id="orgaadc727-14" title="14">    <span class="cf">try</span>:</a>
<a class="sourceLine" id="orgaadc727-15" title="15">        <span class="cf">yield</span></a>
<a class="sourceLine" id="orgaadc727-16" title="16">    <span class="cf">except</span> exc_type <span class="im">as</span> e:</a>
<a class="sourceLine" id="orgaadc727-17" title="17">        <span class="im">import</span> traceback</a>
<a class="sourceLine" id="orgaadc727-18" title="18">        <span class="bu">print</span>(<span class="st">&quot;&quot;</span>.join(traceback.format_exception_only(<span class="bu">type</span>(e), e)))</a>
<a class="sourceLine" id="orgaadc727-19" title="19">    <span class="cf">finally</span>:</a>
<a class="sourceLine" id="orgaadc727-20" title="20">        theano.config.exception_verbosity <span class="op">=</span> _verbosity</a>
<a class="sourceLine" id="orgaadc727-21" title="21"></a>
<a class="sourceLine" id="orgaadc727-22" title="22"></a>
<a class="sourceLine" id="orgaadc727-23" title="23"><span class="cf">with</span> short_exception_msg(<span class="pp">TypeError</span>):</a>
<a class="sourceLine" id="orgaadc727-24" title="24">    x_tt.shape</a>
<a class="sourceLine" id="orgaadc727-25" title="25">    <span class="bu">print</span>(<span class="st">&quot;shape checks out!&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="org2e61ec5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org2e61ec5-1" title="1">test_value.broadcastable <span class="op">=</span> (<span class="va">True</span>, <span class="va">True</span>)</a>
<a class="sourceLine" id="org2e61ec5-2" title="2">x_tt.broadcastable <span class="op">=</span> (<span class="va">False</span>, <span class="va">False</span>)</a>
<a class="sourceLine" id="org2e61ec5-3" title="3">shape checks out<span class="op">!</span></a>
<a class="sourceLine" id="org2e61ec5-4" title="4"></a></code></pre></div>
<div class="sourceCode" id="org56323a0"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org56323a0-1" title="1">y_tt.tag.test_value <span class="op">=</span> np.array([[<span class="dv">5</span>]])</a>
<a class="sourceLine" id="org56323a0-2" title="2"></a>
<a class="sourceLine" id="org56323a0-3" title="3"><span class="bu">print</span>(<span class="st">&quot;test_value.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="org56323a0-4" title="4">    tt.as_tensor_variable(y_tt.tag.test_value).broadcastable))</a>
<a class="sourceLine" id="org56323a0-5" title="5"><span class="bu">print</span>(<span class="st">&quot;y_tt.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(y_tt.broadcastable))</a>
<a class="sourceLine" id="org56323a0-6" title="6"></a>
<a class="sourceLine" id="org56323a0-7" title="7"><span class="cf">with</span> short_exception_msg(<span class="pp">TypeError</span>):</a>
<a class="sourceLine" id="org56323a0-8" title="8">    y_tt.shape</a>
<a class="sourceLine" id="org56323a0-9" title="9">    <span class="bu">print</span>(<span class="st">&quot;shape checks out!&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="org0eb456d"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org0eb456d-1" title="1">test_value.broadcastable <span class="op">=</span> (<span class="va">True</span>, <span class="va">True</span>)</a>
<a class="sourceLine" id="org0eb456d-2" title="2">y_tt.broadcastable <span class="op">=</span> (<span class="va">True</span>, <span class="va">False</span>)</a>
<a class="sourceLine" id="org0eb456d-3" title="3">shape checks out<span class="op">!</span></a>
<a class="sourceLine" id="org0eb456d-4" title="4"></a></code></pre></div>
<p>Test value is <strong>not</strong> broadcastable:</p>
<div class="sourceCode" id="orge2d0568"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orge2d0568-1" title="1">x_tt.tag.test_value <span class="op">=</span> np.array([[<span class="dv">5</span>, <span class="dv">4</span>]])</a>
<a class="sourceLine" id="orge2d0568-2" title="2"><span class="bu">print</span>(<span class="st">&quot;test_value.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="orge2d0568-3" title="3">    tt.as_tensor_variable(x_tt.tag.test_value).broadcastable))</a>
<a class="sourceLine" id="orge2d0568-4" title="4"><span class="bu">print</span>(<span class="st">&quot;x_tt.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(x_tt.broadcastable))</a>
<a class="sourceLine" id="orge2d0568-5" title="5"></a>
<a class="sourceLine" id="orge2d0568-6" title="6"><span class="cf">with</span> short_exception_msg(<span class="pp">TypeError</span>):</a>
<a class="sourceLine" id="orge2d0568-7" title="7">    x_tt.shape</a>
<a class="sourceLine" id="orge2d0568-8" title="8">    <span class="bu">print</span>(<span class="st">&quot;shape checks out!&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="org9673726"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org9673726-1" title="1">test_value.broadcastable <span class="op">=</span> (<span class="va">True</span>, <span class="va">False</span>)</a>
<a class="sourceLine" id="org9673726-2" title="2">x_tt.broadcastable <span class="op">=</span> (<span class="va">False</span>, <span class="va">False</span>)</a>
<a class="sourceLine" id="org9673726-3" title="3">shape checks out<span class="op">!</span></a>
<a class="sourceLine" id="org9673726-4" title="4"></a></code></pre></div>
<div class="sourceCode" id="org53e07ae"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="org53e07ae-1" title="1">y_tt.tag.test_value <span class="op">=</span> np.array([[<span class="dv">5</span>, <span class="dv">4</span>], [<span class="dv">3</span>, <span class="dv">2</span>]])</a>
<a class="sourceLine" id="org53e07ae-2" title="2"><span class="bu">print</span>(<span class="st">&quot;test_value.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(</a>
<a class="sourceLine" id="org53e07ae-3" title="3">    tt.as_tensor_variable(y_tt.tag.test_value).broadcastable))</a>
<a class="sourceLine" id="org53e07ae-4" title="4"><span class="bu">print</span>(<span class="st">&quot;y_tt.broadcastable = </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(y_tt.broadcastable))</a>
<a class="sourceLine" id="org53e07ae-5" title="5"></a>
<a class="sourceLine" id="org53e07ae-6" title="6"><span class="cf">with</span> short_exception_msg(<span class="pp">TypeError</span>):</a>
<a class="sourceLine" id="org53e07ae-7" title="7">    y_tt.shape</a>
<a class="sourceLine" id="org53e07ae-8" title="8">    <span class="bu">print</span>(<span class="st">&quot;shape checks out!&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="orge7e2254"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="orge7e2254-1" title="1">test_value.broadcastable <span class="op">=</span> (<span class="va">False</span>, <span class="va">False</span>)</a>
<a class="sourceLine" id="orge7e2254-2" title="2">y_tt.broadcastable <span class="op">=</span> (<span class="va">True</span>, <span class="va">False</span>)</a>
<a class="sourceLine" id="orge7e2254-3" title="3"><span class="pp">TypeError</span>: For compute_test_value, one <span class="bu">input</span> test value does <span class="kw">not</span> have the requested <span class="bu">type</span>.</a>
<a class="sourceLine" id="orge7e2254-4" title="4"></a>
<a class="sourceLine" id="orge7e2254-5" title="5">Backtrace when that variable <span class="kw">is</span> created:</a>
<a class="sourceLine" id="orge7e2254-6" title="6"></a>
<a class="sourceLine" id="orge7e2254-7" title="7">  File <span class="st">&quot;/home/bwillard/apps/anaconda3/envs/github-website/lib/python3.6/site-packages/IPython/terminal/interactiveshell.py&quot;</span>, line <span class="dv">485</span>, <span class="kw">in</span> mainloop</a>
<a class="sourceLine" id="orge7e2254-8" title="8">    <span class="va">self</span>.interact()</a>
<a class="sourceLine" id="orge7e2254-9" title="9">  File <span class="st">&quot;/home/bwillard/apps/anaconda3/envs/github-website/lib/python3.6/site-packages/IPython/terminal/interactiveshell.py&quot;</span>, line <span class="dv">476</span>, <span class="kw">in</span> interact</a>
<a class="sourceLine" id="orge7e2254-10" title="10">    <span class="va">self</span>.run_cell(code, store_history<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="orge7e2254-11" title="11">  File <span class="st">&quot;/home/bwillard/apps/anaconda3/envs/github-website/lib/python3.6/site-packages/IPython/core/interactiveshell.py&quot;</span>, line <span class="dv">2662</span>, <span class="kw">in</span> run_cell</a>
<a class="sourceLine" id="orge7e2254-12" title="12">    raw_cell, store_history, silent, shell_futures)</a>
<a class="sourceLine" id="orge7e2254-13" title="13">  File <span class="st">&quot;/home/bwillard/apps/anaconda3/envs/github-website/lib/python3.6/site-packages/IPython/core/interactiveshell.py&quot;</span>, line <span class="dv">2785</span>, <span class="kw">in</span> _run_cell</a>
<a class="sourceLine" id="orge7e2254-14" title="14">    interactivity<span class="op">=</span>interactivity, compiler<span class="op">=</span>compiler, result<span class="op">=</span>result)</a>
<a class="sourceLine" id="orge7e2254-15" title="15">  File <span class="st">&quot;/home/bwillard/apps/anaconda3/envs/github-website/lib/python3.6/site-packages/IPython/core/interactiveshell.py&quot;</span>, line <span class="dv">2909</span>, <span class="kw">in</span> run_ast_nodes</a>
<a class="sourceLine" id="orge7e2254-16" title="16">    <span class="cf">if</span> <span class="va">self</span>.run_code(code, result):</a>
<a class="sourceLine" id="orge7e2254-17" title="17">  File <span class="st">&quot;/home/bwillard/apps/anaconda3/envs/github-website/lib/python3.6/site-packages/IPython/core/interactiveshell.py&quot;</span>, line <span class="dv">2963</span>, <span class="kw">in</span> run_code</a>
<a class="sourceLine" id="orge7e2254-18" title="18">    <span class="bu">exec</span>(code_obj, <span class="va">self</span>.user_global_ns, <span class="va">self</span>.user_ns)</a>
<a class="sourceLine" id="orge7e2254-19" title="19">  File <span class="st">&quot;&lt;ipython-input-19-7427b1688530&gt;&quot;</span>, line <span class="dv">1</span>, <span class="kw">in</span> <span class="op">&lt;</span>module<span class="op">&gt;</span></a>
<a class="sourceLine" id="orge7e2254-20" title="20">    __org_babel_python_fname <span class="op">=</span> <span class="st">&#39;/tmp/user/1000/babel-fsZXPU/python-cZypXi&#39;</span><span class="op">;</span> __org_babel_python_fh <span class="op">=</span> <span class="bu">open</span>(__org_babel_python_fname)<span class="op">;</span> <span class="bu">exec</span>(<span class="bu">compile</span>(__org_babel_python_fh.read(), __org_babel_python_fname, <span class="st">&#39;exec&#39;</span>))<span class="op">;</span> __org_babel_python_fh.close()</a>
<a class="sourceLine" id="orge7e2254-21" title="21">  File <span class="st">&quot;/tmp/user/1000/babel-fsZXPU/python-cZypXi&quot;</span>, line <span class="dv">1</span>, <span class="kw">in</span> <span class="op">&lt;</span>module<span class="op">&gt;</span></a>
<a class="sourceLine" id="orge7e2254-22" title="22">    y_tt <span class="op">=</span> tt.row(<span class="st">&#39;y&#39;</span>)</a>
<a class="sourceLine" id="orge7e2254-23" title="23"></a>
<a class="sourceLine" id="orge7e2254-24" title="24">The error when converting the test value to that variable <span class="bu">type</span>:</a>
<a class="sourceLine" id="orge7e2254-25" title="25">Non<span class="op">-</span>unit value on shape on a broadcastable dimension.</a>
<a class="sourceLine" id="orge7e2254-26" title="26">(<span class="dv">2</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="orge7e2254-27" title="27">(<span class="va">True</span>, <span class="va">False</span>)</a>
<a class="sourceLine" id="orge7e2254-28" title="28"></a></code></pre></div>
<p>Simply put: non-broadcastable Theano tensor variable types can take broadcastable and non-broadcastable values, while broadcastable types can only take broadcastable values.</p>
</div>
<p>What we can take from the example above is that if we determine that a vector has broadcastable dimensions using test values–as PyMC3 does–we unnecessarily introduce restrictions and potential inconsistencies down the line. One point of origin for such issues is <strong>shared variables</strong>.</p>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>In follow-ups to this series, we’ll address a few loose ends, such as</p>
<ul>
<li>the inclusion of density functions and likelihoods,</li>
<li>decompositions/reductions of overlapping multivariate types (e.g. transforms between tensors of univariate normals and equivalent multivariate normals),</li>
<li>canonicalization of graphs containing <code>RandomVariable</code> terms,</li>
<li>and more optimizations that specifically target MCMC schemes (e.g. automatic conversion to scale mixture decompositions).</li>
</ul>
</section>
<section id="bibliography" class="level1">
<h1>Bibliography</h1>
<p><a id="WillardSymbolicMathPyMC32018"></a>[WillardSymbolicMathPyMC32018] Willard, Symbolic Math in PyMC3, <i></i>, (2018). <a href="https://brandonwillard.github.io/symbolic-math-in-pymc3.html">link</a>. <a href="#24875a2c31fa7f94ce562adddedc0bf8">↩</a></p>
</section>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  CommonHTML: { linebreaks: { automatic: true } },
  "HTML-CSS": { linebreaks: { automatic: true } },
  SVG: { linebreaks: { automatic: true } },
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
</body>
</html>

            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'brandonwillard-github-io'; // required: replace example with your forum shortname

                    var disqus_identifier = 'random-variables-in-theano';
                var disqus_url = 'https://brandonwillard.github.io/random-variables-in-theano.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="https://brandonwillard.github.io//images/profile-pic.png"/>
        </p>
    <p>
      <strong>About Brandon T. Willard</strong><br/>
        applied math/stats person
    </p>
</div><!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://linkedin.com/pub/brandon-willard/10/bb4/468/"><i class="fa fa-linkedin fa-lg"></i> linkedin</a></li>
    <li class="list-group-item"><a href="https://scholar.google.com/citations?user=g0oUxG4AAAAJ&hl=en"><i class="ai ai-google-scholar ai-lg"></i> google scholar</a></li>
    <li class="list-group-item"><a href="https://plus.google.com/+brandonwillard"><i class="fa fa-google-plus fa-lg"></i> google+</a></li>
    <li class="list-group-item"><a href="https://bitbucket.io/brandonwillard"><i class="fa fa-bitbucket-square fa-lg"></i> bitbucket</a></li>
    <li class="list-group-item"><a href="https://github.com/brandonwillard"><i class="fa fa-github-square fa-lg"></i> github</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2019 Brandon T. Willard
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en">Creative Commons Attribution-NonCommercial 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://brandonwillard.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://brandonwillard.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://brandonwillard.github.io/theme/js/respond.min.js"></script>


    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'brandonwillard-github-io'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-91585967-1', '');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->


</body>
</html>