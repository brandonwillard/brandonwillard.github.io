<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>SymPy Matching Strategies - Brandon T. Willard</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="/sympy-matching-strategies.html">

        <meta name="author" content="Brandon Willard" />
        <meta name="description" content="Following up on sympy-expression-tree-manipulation.htmlmy earlier post on SymPy expression trees, matching and whatnot… If we wanted to implement some crude functionality for inequalities (or at least the one we’re interested in), we might do something like the following: from sympy.assumptions import register_handler, ask, Q from sympy ..." />

        <meta property="og:site_name" content="Brandon T. Willard" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="SymPy Matching Strategies"/>
        <meta property="og:url" content="/sympy-matching-strategies.html"/>
        <meta property="og:description" content="Following up on sympy-expression-tree-manipulation.htmlmy earlier post on SymPy expression trees, matching and whatnot… If we wanted to implement some crude functionality for inequalities (or at least the one we’re interested in), we might do something like the following: from sympy.assumptions import register_handler, ask, Q from sympy ..."/>
        <meta property="article:published_time" content="2016-10-27" />
            <meta property="article:section" content="articles" />
            <meta property="article:author" content="Brandon Willard" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>


</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
Brandon T. Willard            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="/pages/about.html">
                             About
                          </a></li>
                         <li><a href="/pages/projects.html">
                             Projects
                          </a></li>
                         <li><a href="/pages/publications.html">
                             Publications
                          </a></li>
                        <li class="active">
                            <a href="/category/articles.html">Articles</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/sympy-matching-strategies.html"
                       rel="bookmark"
                       title="Permalink to SymPy Matching Strategies">
                        SymPy Matching Strategies
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-10-27T00:00:00-05:00"> Thu 27 October 2016</time>
    </span>



    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Following up on <a href="sympy-expression-tree-manipulation.html">sympy-expression-tree-manipulation.html</a><span>my earlier post</span> on SymPy expression trees, matching and whatnot…</p>
<p>If we wanted to implement some crude functionality for inequalities (or at least the one we’re interested in), we might do something like the following:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sympy.assumptions</span> <span class="kn">import</span> <span class="n">register_handler</span><span class="p">,</span> <span class="n">ask</span><span class="p">,</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">sympy.assumptions.handlers</span> <span class="kn">import</span> <span class="n">AskHandler</span>
<span class="kn">from</span> <span class="nn">sympy.assumptions.handlers.order</span> <span class="kn">import</span> <span class="n">AskPositiveHandler</span>

<span class="k">def</span> <span class="nf">method_decorator</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">assumptions</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">ipdb</span><span class="p">;</span> <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>  <span class="c1"># XXX BREAKPOINT</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">assumptions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapped</span>

    <span class="n">cls</span> <span class="o">=</span> <span class="n">AskPositiveInequalityHandler</span>

<span class="k">def</span> <span class="nf">class_decorator</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">inspect</span>

    <span class="n">members</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span>
                                  <span class="n">predicate</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
<span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                                  <span class="ow">and</span> <span class="s1">&#39;sympy.assumptions&#39;</span> <span class="ow">in</span>
                                  <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;__module__&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
        <span class="n">argspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;assumptions&#39;</span> <span class="ow">in</span> <span class="n">argspec</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">types</span>
            <span class="n">decorated</span> <span class="o">=</span> <span class="n">method_decorator</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">decorated</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">cls</span>

<span class="k">class</span> <span class="nc">AskPositiveInequalityHandler</span><span class="p">(</span><span class="n">AskPositiveHandler</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">register_handler</span><span class="p">(</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="n">AskPositiveInequalityHandler</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">sp</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">positive</span><span class="o">.</span><span class="n">handlers</span>

<span class="n">sp</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">positive</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">i</span><span class="p">),</span> <span class="n">sp</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="bp">True</span>
</pre></div>


<p>Forgoing SymPy’s Assumptions system, <code>sympy.strategies</code> provides a more direct route to effectively maintaining the conditions of our pattern, performing a replacement on sub-expressions of a tree, and removing the catch-all constant multiple term <code>C_w</code>.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sympy.strategies</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">sympy.strategies.rl</span> <span class="kn">import</span> <span class="n">distribute</span>
<span class="kn">from</span> <span class="nn">sympy.strategies.tools</span> <span class="kn">import</span> <span class="n">canon</span><span class="p">,</span> <span class="n">typed</span>

<span class="k">def</span> <span class="nf">distribute_mul_sum</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">Sum</span><span class="p">):</span>
            <span class="n">first</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
<span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">if</span> <span class="n">pick_fn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">new_sum_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">first</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span> <span class="o">+</span>
<span class="n">tail</span><span class="p">)),</span>
                                <span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">Sum</span><span class="p">(</span><span class="o">*</span><span class="n">new_sum_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">other</span> <span class="o">=</span> <span class="n">first</span> <span class="o">+</span> <span class="n">tail</span>
                <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">groupby</span>
                <span class="n">group_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                                  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">pick_fn</span><span class="p">))</span>
                <span class="n">yes_list</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">group_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="p">()))</span>
                <span class="n">no_list</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">group_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="p">()))</span>
                <span class="n">new_sum_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">yes_list</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],))),</span>
                                <span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">no_list</span> <span class="o">+</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Sum</span><span class="p">(</span><span class="o">*</span><span class="n">new_sum_args</span><span class="p">),)))</span>

    <span class="k">return</span> <span class="n">expr</span>

<span class="n">all_dist_rules</span> <span class="o">=</span> <span class="n">typed</span><span class="p">({</span><span class="n">sp</span><span class="o">.</span><span class="n">Mul</span><span class="p">:</span> <span class="n">chain</span><span class="p">(</span><span class="n">distribute</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Mul</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">Add</span><span class="p">),</span>
                                      <span class="n">distribute_mul_sum</span><span class="p">)})</span>

<span class="k">return</span> <span class="n">canon</span><span class="p">(</span><span class="n">all_dist_rules</span><span class="p">,</span> <span class="n">fns</span><span class="o">=</span><span class="n">sp</span><span class="o">.</span><span class="n">strategies</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">expr_fns</span><span class="p">)(</span><span class="n">expr</span><span class="p">)</span>
</pre></div>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="/images/profile-pic.png"/>
        </p>
    <p>
        <strong>About Brandon T. Willard</strong><br/>
        applied math/stats person
    </p>
</div>
<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="http://linkedin.com/pub/brandon-willard/10/bb4/468/"><i class="fa fa-linkedin-square fa-lg"></i> linkedin</a></li>
                <li class="list-group-item"><a href="https://scholar.google.com/citations?user=g0oUxG4AAAAJ&hl=en"><i class="fa fa-google-scholar-square fa-lg"></i> google scholar</a></li>
                <li class="list-group-item"><a href="https://plus.google.com/+brandonwillard"><i class="fa fa-google-plus-square fa-lg"></i> google+</a></li>
                <li class="list-group-item"><a href="https://bitbucket.org/brandonwillard"><i class="fa fa-bitbucket-square fa-lg"></i> bitbucket</a></li>
                <li class="list-group-item"><a href="https://github.com/brandonwillard"><i class="fa fa-github-square fa-lg"></i> gitHub</a></li>
              </ul>
            </li>



            <li class="list-group-item"><a href="/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group " id="tags">
                </ul>
            </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 Brandon T. Willard
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>


</body>
</html>