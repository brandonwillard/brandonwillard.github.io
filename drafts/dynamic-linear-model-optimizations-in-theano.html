<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Dynamic Linear Model Optimizations in Theano - Brandon T. Willard</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://brandonwillard.github.io/drafts/dynamic-linear-model-optimizations-in-theano.html">

        <meta name="author" content="Brandon T. Willard" />
        <meta name="keywords" content="draft,pymc3,theano,statistics,symbolic computation,python,probability theory" />

        <meta property="og:site_name" content="Brandon T. Willard" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Dynamic Linear Model Optimizations in Theano"/>
        <meta property="og:url" content="https://brandonwillard.github.io/drafts/dynamic-linear-model-optimizations-in-theano.html"/>
        <meta property="og:description" content=""/>
        <meta property="article:published_time" content="2020-03-18" />
            <meta property="article:section" content="articles" />
            <meta property="article:tag" content="draft" />
            <meta property="article:tag" content="pymc3" />
            <meta property="article:tag" content="theano" />
            <meta property="article:tag" content="statistics" />
            <meta property="article:tag" content="symbolic computation" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="probability theory" />
            <meta property="article:author" content="Brandon T. Willard" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://brandonwillard.github.io/theme/css/bootstrap.readable.min.css" type="text/css"/>
    <link href="https://brandonwillard.github.io/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://brandonwillard.github.io/theme/css/academicons.min.css" rel="stylesheet">

    <link href="https://brandonwillard.github.io/theme/css/pygments/vim.css" rel="stylesheet">
    <link rel="stylesheet" href="https://brandonwillard.github.io/theme/css/style.css" type="text/css"/>
        <link href="https://brandonwillard.github.io/extra/custom.css" rel="stylesheet">

        <link href="https://brandonwillard.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Brandon T. Willard ATOM Feed"/>

        <link href="https://brandonwillard.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Brandon T. Willard RSS Feed"/>


        <link href="https://brandonwillard.github.io/feeds/articles.atom.xml" type="application/atom+xml" rel="alternate"
              title="Brandon T. Willard articles ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://brandonwillard.github.io/" class="navbar-brand">
Brandon T. Willard            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="https://brandonwillard.github.io/pages/publications.html">
                             Publications
                          </a></li>
                         <li><a href="https://brandonwillard.github.io/pages/projects.html">
                             Projects
                          </a></li>
                         <li><a href="https://brandonwillard.github.io/pages/about.html">
                             About
                          </a></li>
                        <li class="active">
                            <a href="https://brandonwillard.github.io/category/articles.html">Articles</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://brandonwillard.github.io/drafts/dynamic-linear-model-optimizations-in-theano.html"
                       rel="bookmark"
                       title="Permalink to Dynamic Linear Model Optimizations in Theano">
                        Dynamic Linear Model Optimizations in Theano
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2020-03-18T00:00:00-05:00"> Wed 18 March 2020</time>
    </span>
          <span class="label label-default">Modified</span>
            <span class="modified">
                <i class="fa fa-calendar"></i><time datetime="2020-04-22T00:00:00-05:00"> Wed 22 April 2020</time>
            </span>





<span class="label label-default">Tags</span>
	<a href="https://brandonwillard.github.io/tag/draft.html">draft</a>
        /
	<a href="https://brandonwillard.github.io/tag/pymc3.html">pymc3</a>
        /
	<a href="https://brandonwillard.github.io/tag/theano.html">theano</a>
        /
	<a href="https://brandonwillard.github.io/tag/statistics.html">statistics</a>
        /
	<a href="https://brandonwillard.github.io/tag/symbolic-computation.html">symbolic computation</a>
        /
	<a href="https://brandonwillard.github.io/tag/python.html">python</a>
        /
	<a href="https://brandonwillard.github.io/tag/probability-theory.html">probability theory</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Brandon T. Willard" />
  <title>Dynamic Linear Model Optimizations in Theano</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
</head>
<body>
<!--  -->
<!-- <div id="header"> -->
<!-- <h1 class="title">Dynamic Linear Model Optimizations in Theano</h1> -->
<!--  -->
<!--  -->
<!-- <h2 class="author">Brandon T. Willard</h2> -->
<!--  -->
<!--  -->
<!-- <h3 class="date">2020–03–18</h3> -->
<!--  -->
<!-- </div> -->
<!--  -->
<div class="abstract">
<p>In this document we construct dynamic linear models (DLMs) in Theano and explore ideas for automating the production of efficient samplers.</p>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>We start by considering the simple form of a DLM <a href="#4bbd465b4e78e5c5151b0cbba54d984e">(Harrison &amp;amp; West 1999)</a> with prior <span class="math inline">\(\theta_0 \sim \operatorname{N}\left( m_0, C_0 \right)\)</span>:</p>
<p><span class="math display">\[\begin{align}
  y_t &amp;= F_t^{\top} \theta_{t} + \epsilon_t, \quad \epsilon_t \sim \operatorname{N}\left( 0, V \right)
  \label{eq:basic-dlm-obs}
  \\
  \theta_t &amp;= G_t \theta_{t-1} + \nu_t, \quad \nu_t \sim \operatorname{N}\left( 0, W \right)
  \label{eq:basic-dlm-state}
\end{align}\]</span></p>
<p>for <span class="math inline">\(t \in \{1, \dots, T\}\)</span>, <span class="math inline">\(y_t \in \mathbb{R}\)</span>, and <span class="math inline">\(\theta_t \in \mathbb{R}^{M}\)</span>.</p>
<p>The most “notationally” faithful representation of the timeseries model in <span class="math inline">\(\eqref{eq:basic-dlm-state}\)</span> using Theano is provided in Listing <a href="#org27bfd8a">2</a>. It represents the notion of a recursion–to the best of Theano’s ability–by way of the <code>scan</code> operator.</p>
<figure>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="im">import</span> theano</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="im">import</span> theano.tensor <span class="im">as</span> tt</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">plt.style.use(<span class="st">&#39;ggplot&#39;</span>)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">plt_orig_cycler <span class="op">=</span> plt.rcParams[<span class="st">&#39;axes.prop_cycle&#39;</span>]</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">plt.rc(<span class="st">&#39;text&#39;</span>, usetex<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="im">from</span> theano.printing <span class="im">import</span> debugprint <span class="im">as</span> tt_dprint</a>
<a class="sourceLine" id="cb1-13" data-line-number="13"></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="im">from</span> symbolic_pymc.theano.random_variables <span class="im">import</span> NormalRV, MvNormalRV, GammaRV, observed</a>
<a class="sourceLine" id="cb1-15" data-line-number="15"></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="co"># theano.config.cxx = &quot;&quot;</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="co"># theano.config.mode = &quot;FAST_COMPILE&quot;</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19">tt.config.compute_test_value <span class="op">=</span> <span class="st">&#39;ignore&#39;</span></a></code></pre></div>
</figure>
<figure id="org27bfd8a">
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" data-line-number="1"></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">N_obs_tt <span class="op">=</span> tt.iscalar(<span class="st">&quot;N_obs&quot;</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">N_theta_tt <span class="op">=</span> tt.iscalar(<span class="st">&quot;N_theta&quot;</span>)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">G_tt <span class="op">=</span> tt.specify_shape(tt.matrix(), [N_theta_tt, N_theta_tt])</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">G_tt.name <span class="op">=</span> <span class="st">&#39;G_t&#39;</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">F_tt <span class="op">=</span> tt.specify_shape(tt.col(), [N_theta_tt, <span class="dv">1</span>])</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">F_tt.name <span class="op">=</span> <span class="st">&#39;F_t&#39;</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">rng_state <span class="op">=</span> np.random.RandomState(np.random.MT19937(np.random.SeedSequence(<span class="dv">1234</span>)))</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">rng_init_state <span class="op">=</span> rng_state.get_state()</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">rng_tt <span class="op">=</span> theano.shared(rng_state, name<span class="op">=</span><span class="st">&#39;rng&#39;</span>, borrow<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">rng_tt.tag.is_rng <span class="op">=</span> <span class="va">True</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15">rng_tt.default_update <span class="op">=</span> rng_tt</a>
<a class="sourceLine" id="cb2-16" data-line-number="16"></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">m_0_tt <span class="op">=</span> tt.zeros([N_theta_tt])</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">m_0_tt.name <span class="op">=</span> <span class="st">&quot;m_0&quot;</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19">C_0_tt <span class="op">=</span> <span class="fl">10.</span> <span class="op">*</span> tt.eye(N_theta_tt)</a>
<a class="sourceLine" id="cb2-20" data-line-number="20">C_0_tt.name <span class="op">=</span> <span class="st">&quot;C_0&quot;</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">theta_0_rv <span class="op">=</span> MvNormalRV(m_0_tt, C_0_tt, rng<span class="op">=</span>rng_tt, name<span class="op">=</span><span class="st">&#39;theta_0&#39;</span>)</a>
<a class="sourceLine" id="cb2-23" data-line-number="23"></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">nu_scale_tt <span class="op">=</span> theano.shared(np.r_[<span class="fl">1.1</span>, <span class="fl">10.0</span>], name<span class="op">=</span><span class="st">&#39;nu_scale&#39;</span>)</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">W_tt <span class="op">=</span> tt.eye(N_theta_tt) <span class="op">*</span> tt.inv(nu_scale_tt)</a>
<a class="sourceLine" id="cb2-26" data-line-number="26">W_tt.name <span class="op">=</span> <span class="st">&quot;W_t&quot;</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27"></a>
<a class="sourceLine" id="cb2-28" data-line-number="28">eps_scale_tt <span class="op">=</span> theano.shared(<span class="fl">0.7</span>, name<span class="op">=</span><span class="st">&#39;eps_scale&#39;</span>)</a>
<a class="sourceLine" id="cb2-29" data-line-number="29">V_tt <span class="op">=</span> tt.inv(eps_scale_tt)</a>
<a class="sourceLine" id="cb2-30" data-line-number="30">V_tt.name <span class="op">=</span> <span class="st">&quot;V_t&quot;</span></a>
<a class="sourceLine" id="cb2-31" data-line-number="31"></a>
<a class="sourceLine" id="cb2-32" data-line-number="32"><span class="kw">def</span> state_step(theta_tm1, G_t, W_t, N_theta, rng):</a>
<a class="sourceLine" id="cb2-33" data-line-number="33">    nu_rv <span class="op">=</span> MvNormalRV(tt.zeros([N_theta]),</a>
<a class="sourceLine" id="cb2-34" data-line-number="34">                       W_t,</a>
<a class="sourceLine" id="cb2-35" data-line-number="35">                       rng<span class="op">=</span>rng,</a>
<a class="sourceLine" id="cb2-36" data-line-number="36">                       name<span class="op">=</span><span class="st">&#39;nu&#39;</span>)</a>
<a class="sourceLine" id="cb2-37" data-line-number="37">    theta_t <span class="op">=</span> G_t.dot(theta_tm1) <span class="op">+</span> nu_rv</a>
<a class="sourceLine" id="cb2-38" data-line-number="38">    <span class="cf">return</span> theta_t</a>
<a class="sourceLine" id="cb2-39" data-line-number="39"></a>
<a class="sourceLine" id="cb2-40" data-line-number="40"></a>
<a class="sourceLine" id="cb2-41" data-line-number="41">theta_t_rv, theta_t_updates <span class="op">=</span> theano.scan(fn<span class="op">=</span>state_step,</a>
<a class="sourceLine" id="cb2-42" data-line-number="42">                                          outputs_info<span class="op">=</span>{<span class="st">&quot;initial&quot;</span>: theta_0_rv, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb2-43" data-line-number="43">                                          non_sequences<span class="op">=</span>[G_tt, W_tt, N_theta_tt, rng_tt],</a>
<a class="sourceLine" id="cb2-44" data-line-number="44">                                          n_steps<span class="op">=</span>N_obs_tt,</a>
<a class="sourceLine" id="cb2-45" data-line-number="45">                                          <span class="co">#strict=True,</span></a>
<a class="sourceLine" id="cb2-46" data-line-number="46">                                          name<span class="op">=</span><span class="st">&#39;theta_t&#39;</span>)</a>
<a class="sourceLine" id="cb2-47" data-line-number="47"></a>
<a class="sourceLine" id="cb2-48" data-line-number="48"><span class="kw">def</span> obs_step(theta_t, F_t, V_t, rng):</a>
<a class="sourceLine" id="cb2-49" data-line-number="49">    eps_rv <span class="op">=</span> NormalRV(<span class="fl">0.0</span>, V_t,</a>
<a class="sourceLine" id="cb2-50" data-line-number="50">                      rng<span class="op">=</span>rng,</a>
<a class="sourceLine" id="cb2-51" data-line-number="51">                      name<span class="op">=</span><span class="st">&#39;eps&#39;</span>)</a>
<a class="sourceLine" id="cb2-52" data-line-number="52">    y_t <span class="op">=</span> F_t.T.dot(theta_t) <span class="op">+</span> eps_rv</a>
<a class="sourceLine" id="cb2-53" data-line-number="53">    <span class="cf">return</span> y_t</a>
<a class="sourceLine" id="cb2-54" data-line-number="54"></a>
<a class="sourceLine" id="cb2-55" data-line-number="55"></a>
<a class="sourceLine" id="cb2-56" data-line-number="56">Y_t_rv, Y_t_updates <span class="op">=</span> theano.scan(fn<span class="op">=</span>obs_step,</a>
<a class="sourceLine" id="cb2-57" data-line-number="57">                                  sequences<span class="op">=</span>[theta_t_rv],</a>
<a class="sourceLine" id="cb2-58" data-line-number="58">                                  non_sequences<span class="op">=</span>[F_tt, V_tt, rng_tt],</a>
<a class="sourceLine" id="cb2-59" data-line-number="59">                                  <span class="co">#strict=True,</span></a>
<a class="sourceLine" id="cb2-60" data-line-number="60">                                  name<span class="op">=</span><span class="st">&#39;Y_t&#39;</span>)</a></code></pre></div>
<figcaption>
Listing 2
</figcaption>
</figure>
<p>The model in Listing <a href="#org27bfd8a">2</a> is our starting point. We assume that a PyMC3 user–for instance–would define a timeseries model in this way, alongside distributional assumptions on parameters (e.g. inverse-gamma variances). From there, we’ll explore some ideas behind manually producing model-specific efficient samplers–generally by first manually deriving and then demonstrating said samplers.</p>
<p>Throughout we’ll use data sampled from <span class="math inline">\(\eqref{eq:basic-dlm-state}\)</span> for demonstration purposes. Specifically, our simulation has the following values:</p>
<p><span class="math display">\[\begin{gather}
  T = 200,\quad M = 2
  \\
  G_t = \begin{pmatrix}
  1 &amp; 0.1 \\
  0 &amp; 1 \\
  \end{pmatrix},\quad
  F_t = \begin{pmatrix}
  1 \\
  0.2
  \end{pmatrix}
  \\
  \theta_0 = \begin{pmatrix}
  0 \\
  0
  \end{pmatrix}
  \label{eq:sim-settings}
\end{gather}\]</span></p>
<figure>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="im">from</span> theano <span class="im">import</span> function <span class="im">as</span> tt_function</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">dlm_sim_values <span class="op">=</span> {</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    N_obs_tt: <span class="dv">200</span>,</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    N_theta_tt: <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    G_tt: np.r_[<span class="st">&#39;0,2&#39;</span>,</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">                [<span class="fl">1.0</span>, <span class="fl">0.1</span>],</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">                [<span class="fl">0.0</span>, <span class="fl">1.0</span>]].astype(tt.config.floatX),</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">    F_tt: np.r_[[[<span class="fl">1.0</span>],</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">                 [<span class="fl">0.2</span>]]].astype(tt.config.floatX)</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"></a>
<a class="sourceLine" id="cb3-13" data-line-number="13">rng_tt.get_value(borrow<span class="op">=</span><span class="va">True</span>).set_state(rng_init_state)</a>
<a class="sourceLine" id="cb3-14" data-line-number="14"></a>
<a class="sourceLine" id="cb3-15" data-line-number="15">simulate_dlm <span class="op">=</span> tt_function([N_obs_tt, N_theta_tt, G_tt, F_tt],</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">                           [Y_t_rv, theta_t_rv],</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">                           givens<span class="op">=</span>{theta_0_rv: np.r_[<span class="fl">0.0</span>, <span class="fl">0.0</span>]},</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">                           updates<span class="op">=</span>Y_t_updates)</a>
<a class="sourceLine" id="cb3-19" data-line-number="19"></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">y_sim, theta_t_sim <span class="op">=</span> simulate_dlm(dlm_sim_values[N_obs_tt], dlm_sim_values[N_theta_tt], dlm_sim_values[G_tt], dlm_sim_values[F_tt])</a>
<a class="sourceLine" id="cb3-21" data-line-number="21"></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="co"># rng_sim_state = rng_tt.get_value(borrow=True).get_state()</span></a></code></pre></div>
</figure>
<p>In <a href="#orgece0fee">4</a> we plot a sample from the model in Listing <a href="#org27bfd8a">2</a> for a fixed RNG seed.</p>
<figure id="orgece0fee">
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" data-line-number="1">plt.clf()</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">_ <span class="op">=</span> plt.plot(y_sim, label<span class="op">=</span><span class="vs">r&#39;$y_t$&#39;</span>, color<span class="op">=</span><span class="st">&#39;black&#39;</span>, linewidth<span class="op">=</span><span class="fl">0.7</span>)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">plt.tight_layout()</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">plt.legend()</a></code></pre></div>
<figcaption>
Listing 4
</figcaption>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/drafts/figures/basic-dlm-sim-plot.png" alt="" />
<figcaption>
</figcaption>
</figure>
<p>Since our goal is to automate some of the basic steps in the process of analytically manipulating and/or solving DLMs (for the purpose of producing efficient and accurate posterior estimates), we will want to compute as many closed-form operations as possible, and the prior predictive state and observation distributions are a good place to start.</p>
<p>Given all the prior and observed data up to time <span class="math inline">\(t\)</span>, <span class="math inline">\(D_t\)</span>, these distribution are given by the following:</p>
<p><span class="math display">\[\begin{align}
  \theta_{t} \mid D_{t-1} &amp;\sim \operatorname{N}\left( a_{t}, R_{t} \right)
  \\
  y_{t} \mid D_{t-1} &amp;\sim \operatorname{N}\left( f_{t}, Q_{t} \right)
\end{align}\]</span></p>
<p>The prior predictive moments are as follows:</p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    a_t = G_t m_{t-1}, \quad R_t = G_t C_{t-1} G_t^\top + W_t
    \\
    f_t = F_t^\top a_{t}, \quad Q_t = F_t^\top C_{t-1} F_t + V_t
  \end{gathered}
  \label{eq:dlm-prior-predictive}
\end{equation}\]</span></p>
<p>We’ll also want to compute the posterior moments for <span class="math inline">\(\theta_t \mid D_t\)</span>, which are as follows:</p>
<p><span class="math display">\[\begin{equation}
  \begin{gathered}
    m_t = a_{t} + R_t F_t Q_t^{-1} \left(y_t - f_t\right),
    \quad C_t = R_t  - R_t F_t Q_t^{-1} F_t^\top R_t
  \end{gathered}
  \label{eq:dlm-post-moments}
\end{equation}\]</span></p>
<p>These “filtered” moments/distributions are only <strong>one</strong> kind of posterior result for a DLM, and they only take into account the data up to time <span class="math inline">\(t\)</span>. The other kind are the “smoothed” distributions, which provided posterior distributions for each time <span class="math inline">\(t\)</span> given all observations.</p>
<p>Notationally, we’ve used <span class="math inline">\(D_t\)</span> to signify all conditional observations and parameters up to time <span class="math inline">\(t\)</span>, so the smoothed distributions are given by <span class="math inline">\(\theta_t \mid D_T\)</span> and the following moments:</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    s_t &amp;= m_t + C_t G_{t+1}^\top R_{t+1}^{-1} \left( s_{t+1} - a_{t+1} \right)
    \\
    S_t &amp;= C_t - C_t G_{t+1}^\top R_{t+1}^{-1} \left( R_{t+1} - S_{t+1} \right) R_{t+1}^{-1} G_{t+1} C_t
  \end{aligned}
  \label{eq:dlm-smooth-moments}
\end{equation}\]</span></p>
<div class="remark" data-markdown="">
<p>In most cases, models will not be as simple as the standard DLM. Even so, these basic closed-form solutions can still be relevant. For instance, efficient MCMC algorithms can be constructed using these closed-form results for <strong>conditionally linear</strong> models. In those cases, we can compute the posterior moments–in closed-form–conditional on samples generated by other means.</p>
</div>
<p>The standard approach is called forward-filtering backward-sampling (FFBS) and uses smoothed posteriors <span class="math inline">\(\theta_t \mid \theta_{t+1}, D_T\)</span> conditioned on all other parameters.</p>
<p>We’ll build up to forward-backward sampling in what follows, but, first, we need to establish how the requisite quantities can be computed symbolically.</p>
</section>
<section id="posterior-estimation" class="level1">
<h1>Posterior Estimation</h1>
<p>In Listings <a href="#org7278e18">6</a> and <a href="#org874cba4">7</a>, we demonstrate how the posterior moments in <span class="math inline">\(\eqref{eq:dlm-post-moments}\)</span> and <span class="math inline">\(\eqref{eq:dlm-smooth-moments}\)</span> can be computed in Theano.</p>
<p>Unfortunately, if we attempt to implement the exact closed-form updates in <span class="math inline">\(\eqref{eq:dlm-post-moments}\)</span> or <span class="math inline">\(\eqref{eq:dlm-smooth-moments}\)</span>, our results will be fraught with numerical errors. This is a very basic issue with naively implemented Kalman filters. The solution to these issues usually involves some analytic reformulations that compensate for the covariance matrix subtractions. The standard approaches generally use some form of matrix decomposition that directly accounts for the positive semi-definite nature of the covariance matrices.</p>
<p>The approach taken here is based on the singular value decomposition (SVD) and effectively computes only one symmetric “half” of the updated covariances. The SVD also allows for easy inversions. See <a href="#0ae04c048b20d07f32d7f0f75bb51483">Zhang &amp;amp; Li (1996)</a> for more details, or <a href="#3a4d89388a434d7b1b91dc8690f3a03b">Petris, Petrone &amp;amp; Campagnoli (2009)</a> for a concise overview of the procedure in the context of DLMs.</p>
<figure>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="im">import</span> scipy</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="im">import</span> warnings</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="im">from</span> theano.gof <span class="im">import</span> Op, Apply</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="im">from</span> theano.tensor.opt <span class="im">import</span> Assert</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="im">from</span> theano.tensor.slinalg <span class="im">import</span> Solve, MATRIX_STRUCTURES</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="im">from</span> theano.tensor.nlinalg <span class="im">import</span> matrix_dot</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">warnings.filterwarnings(<span class="st">&quot;ignore&quot;</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>, message<span class="op">=</span><span class="st">&quot;Using a non-tuple sequence&quot;</span>)</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="kw">def</span> tt_finite_inv(x):</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">    y <span class="op">=</span> tt.inv(x)</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">    res_subtensor <span class="op">=</span> y[tt.isinf(y)]</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">    <span class="cf">return</span> tt.set_subtensor(res_subtensor, <span class="fl">0.0</span>)</a></code></pre></div>
</figure>
<section id="svd-approach" class="level2">
<h2>SVD Approach</h2>
<p>TODO: Describe SVD filter formulation.</p>
<figure id="org7278e18">
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="im">from</span> theano.tensor.nlinalg <span class="im">import</span> svd</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">y_tt <span class="op">=</span> tt.specify_shape(tt.col(), [N_obs_tt, <span class="dv">1</span>])</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">y_tt.name <span class="op">=</span> <span class="st">&#39;y_t&#39;</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="kw">def</span> filtering_step(y_t, m_tm1, U_C_tm1, S_C_tm1, F_t, G_t, N_W_t, U_V_t, S_V_inv_t):</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    <span class="co">&quot;&quot;&quot;Compute the sequential posterior state and prior predictive parameters.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">    M_R <span class="op">=</span> tt.join(<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">                  matrix_dot(S_C_tm1, U_C_tm1.T, G_t.T),</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">                  N_W_t)</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">    <span class="co"># </span><span class="al">TODO</span><span class="co">: Consider an approach that only computes *one* set of singular</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15">    <span class="co"># vectors</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16">    _, d_M_R, Vt_M_R <span class="op">=</span> svd(M_R)</a>
<a class="sourceLine" id="cb6-17" data-line-number="17">    Vt_M_R.name <span class="op">=</span> <span class="st">&quot;Vt_M_R&quot;</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"></a>
<a class="sourceLine" id="cb6-19" data-line-number="19">    U_R_t, s_R_t <span class="op">=</span> Vt_M_R.T, d_M_R</a>
<a class="sourceLine" id="cb6-20" data-line-number="20">    U_R_t.name <span class="op">=</span> <span class="st">&quot;U_R_t&quot;</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"></a>
<a class="sourceLine" id="cb6-22" data-line-number="22">    <span class="co"># R_t = M_R.T.dot(M_R) = matrix_dot(U_R_t, tt.diag(d_M_R), U_R_t.T)</span></a>
<a class="sourceLine" id="cb6-23" data-line-number="23"></a>
<a class="sourceLine" id="cb6-24" data-line-number="24">    <span class="co"># V_t_inv = N_V_t_inv.T @ N_V_t_inv</span></a>
<a class="sourceLine" id="cb6-25" data-line-number="25">    N_V_t_inv <span class="op">=</span> S_V_inv_t.dot(U_V_t.T)</a>
<a class="sourceLine" id="cb6-26" data-line-number="26">    N_V_t_inv.name <span class="op">=</span> <span class="st">&quot;N_V_t_inv&quot;</span></a>
<a class="sourceLine" id="cb6-27" data-line-number="27"></a>
<a class="sourceLine" id="cb6-28" data-line-number="28">    M_C <span class="op">=</span> tt.join(<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb6-29" data-line-number="29">                  matrix_dot(N_V_t_inv, F_t.T, U_R_t),</a>
<a class="sourceLine" id="cb6-30" data-line-number="30">                  tt.diag(tt_finite_inv(s_R_t)))</a>
<a class="sourceLine" id="cb6-31" data-line-number="31">    <span class="co"># </span><span class="al">TODO</span><span class="co">: Consider an approach that only computes *one* set of singular</span></a>
<a class="sourceLine" id="cb6-32" data-line-number="32">    <span class="co"># vectors</span></a>
<a class="sourceLine" id="cb6-33" data-line-number="33">    _, d_M_C, Vt_M_C <span class="op">=</span> svd(M_C)</a>
<a class="sourceLine" id="cb6-34" data-line-number="34">    Vt_M_C.name <span class="op">=</span> <span class="st">&quot;Vt_M_C&quot;</span></a>
<a class="sourceLine" id="cb6-35" data-line-number="35"></a>
<a class="sourceLine" id="cb6-36" data-line-number="36">    U_C_t, D_C_t <span class="op">=</span> U_R_t.dot(Vt_M_C.T), tt.diag(tt_finite_inv(d_M_C))</a>
<a class="sourceLine" id="cb6-37" data-line-number="37">    U_C_t.name <span class="op">=</span> <span class="st">&quot;U_C_t&quot;</span></a>
<a class="sourceLine" id="cb6-38" data-line-number="38">    D_C_t.name <span class="op">=</span> <span class="st">&quot;D_C_t&quot;</span></a>
<a class="sourceLine" id="cb6-39" data-line-number="39"></a>
<a class="sourceLine" id="cb6-40" data-line-number="40">    C_t <span class="op">=</span> matrix_dot(U_C_t, D_C_t, U_C_t.T)</a>
<a class="sourceLine" id="cb6-41" data-line-number="41">    C_t.name <span class="op">=</span> <span class="st">&quot;C_t&quot;</span></a>
<a class="sourceLine" id="cb6-42" data-line-number="42"></a>
<a class="sourceLine" id="cb6-43" data-line-number="43">    a_t <span class="op">=</span> G_t.dot(m_tm1)</a>
<a class="sourceLine" id="cb6-44" data-line-number="44">    a_t.name <span class="op">=</span> <span class="st">&quot;a_t&quot;</span></a>
<a class="sourceLine" id="cb6-45" data-line-number="45">    f_t <span class="op">=</span> F_t.T.dot(a_t)</a>
<a class="sourceLine" id="cb6-46" data-line-number="46">    f_t.name <span class="op">=</span> <span class="st">&quot;f_t&quot;</span></a>
<a class="sourceLine" id="cb6-47" data-line-number="47">    m_t <span class="op">=</span> a_t <span class="op">+</span> matrix_dot(C_t, F_t, N_V_t_inv.T, N_V_t_inv, y_t <span class="op">-</span> f_t)</a>
<a class="sourceLine" id="cb6-48" data-line-number="48">    m_t.name <span class="op">=</span> <span class="st">&quot;m_t&quot;</span></a>
<a class="sourceLine" id="cb6-49" data-line-number="49"></a>
<a class="sourceLine" id="cb6-50" data-line-number="50">    S_C_t <span class="op">=</span> tt.sqrt(D_C_t)</a>
<a class="sourceLine" id="cb6-51" data-line-number="51">    S_C_t.name <span class="op">=</span> <span class="st">&quot;S_C_t&quot;</span></a>
<a class="sourceLine" id="cb6-52" data-line-number="52"></a>
<a class="sourceLine" id="cb6-53" data-line-number="53">    S_R_t <span class="op">=</span> tt.diag(s_R_t)</a>
<a class="sourceLine" id="cb6-54" data-line-number="54">    S_R_t.name <span class="op">=</span> <span class="st">&quot;S_R_t&quot;</span></a>
<a class="sourceLine" id="cb6-55" data-line-number="55"></a>
<a class="sourceLine" id="cb6-56" data-line-number="56">    <span class="cf">return</span> [m_t, U_C_t, S_C_t, a_t, U_R_t, S_R_t]</a>
<a class="sourceLine" id="cb6-57" data-line-number="57"></a>
<a class="sourceLine" id="cb6-58" data-line-number="58"></a>
<a class="sourceLine" id="cb6-59" data-line-number="59">U_C_0_tt, d_C_0_tt, _ <span class="op">=</span> svd(C_0_tt)</a>
<a class="sourceLine" id="cb6-60" data-line-number="60">S_C_0_tt <span class="op">=</span> tt.diag(tt.sqrt(d_C_0_tt))</a>
<a class="sourceLine" id="cb6-61" data-line-number="61">S_C_0_tt.name <span class="op">=</span> <span class="st">&quot;S_C_0_tt&quot;</span></a>
<a class="sourceLine" id="cb6-62" data-line-number="62"></a>
<a class="sourceLine" id="cb6-63" data-line-number="63">U_W_tt, d_W_tt, _ <span class="op">=</span> svd(W_tt)</a>
<a class="sourceLine" id="cb6-64" data-line-number="64">s_W_tt <span class="op">=</span> tt.sqrt(d_W_tt)</a>
<a class="sourceLine" id="cb6-65" data-line-number="65">N_W_tt <span class="op">=</span> tt.diag(s_W_tt).dot(U_W_tt.T)</a>
<a class="sourceLine" id="cb6-66" data-line-number="66">N_W_tt.name <span class="op">=</span> <span class="st">&quot;N_W&quot;</span></a>
<a class="sourceLine" id="cb6-67" data-line-number="67"></a>
<a class="sourceLine" id="cb6-68" data-line-number="68">U_V_tt, D_V_tt, _ <span class="op">=</span> svd(tt.as_tensor_variable(V_tt, ndim<span class="op">=</span><span class="dv">2</span>) <span class="cf">if</span> V_tt.ndim <span class="op">&lt;</span> <span class="dv">2</span> <span class="cf">else</span> V_tt)</a>
<a class="sourceLine" id="cb6-69" data-line-number="69">S_V_inv_tt <span class="op">=</span> tt.diag(tt_finite_inv(tt.sqrt(D_V_tt)))</a>
<a class="sourceLine" id="cb6-70" data-line-number="70"><span class="co"># N_V_tt = S_V_tt.dot(U_V_tt.T)</span></a>
<a class="sourceLine" id="cb6-71" data-line-number="71"></a>
<a class="sourceLine" id="cb6-72" data-line-number="72">(m_t, U_C_t, S_C_t, a_t, U_R_t, S_R_t), filter_updates <span class="op">=</span> theano.scan(fn<span class="op">=</span>filtering_step,</a>
<a class="sourceLine" id="cb6-73" data-line-number="73">                                                   sequences<span class="op">=</span>y_tt,</a>
<a class="sourceLine" id="cb6-74" data-line-number="74">                                                   outputs_info<span class="op">=</span>[</a>
<a class="sourceLine" id="cb6-75" data-line-number="75">                                                       {<span class="st">&quot;initial&quot;</span>: m_0_tt, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb6-76" data-line-number="76">                                                       {<span class="st">&quot;initial&quot;</span>: U_C_0_tt, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb6-77" data-line-number="77">                                                       {<span class="st">&quot;initial&quot;</span>: S_C_0_tt, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb6-78" data-line-number="78">                                                       {}, {}, {}  <span class="co"># a_t, U_R_t, S_R_t</span></a>
<a class="sourceLine" id="cb6-79" data-line-number="79">                                                   ],</a>
<a class="sourceLine" id="cb6-80" data-line-number="80">                                                   non_sequences<span class="op">=</span>[F_tt, G_tt, N_W_tt, U_V_tt, S_V_inv_tt],</a>
<a class="sourceLine" id="cb6-81" data-line-number="81">                                                   strict<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb6-82" data-line-number="82">                                                   name<span class="op">=</span><span class="st">&#39;theta_t_obs&#39;</span>)</a></code></pre></div>
<figcaption>
Listing 6
</figcaption>
</figure>
<p>TODO: Describe special manipulations behind SVD smoother.</p>
<figure id="org874cba4">
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" data-line-number="1"></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw">def</span> smoother_step(m_t, U_C_t, S_C_t, a_tp1, U_R_tp1, S_R_tp1, m_Ttp1, U_C_Ttp1, S_C_Ttp1, G_tp1, N_W_t_inv):</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">    <span class="co">&quot;&quot;&quot;Smooth a series starting from the &quot;forward&quot;/sequentially computed posterior moments.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">    N_C_t <span class="op">=</span> S_C_t.dot(U_C_t.T)</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"></a>
<a class="sourceLine" id="cb7-7" data-line-number="7">    S_R_tp1_inv <span class="op">=</span> tt_finite_inv(S_R_tp1)</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">    N_R_tp1_inv <span class="op">=</span> S_R_tp1_inv.dot(U_R_tp1.T)</a>
<a class="sourceLine" id="cb7-9" data-line-number="9"></a>
<a class="sourceLine" id="cb7-10" data-line-number="10">    <span class="co"># B_t = C_t @ G_tp1.T @ R_tp1</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11">    B_t <span class="op">=</span> matrix_dot(N_C_t.T, N_C_t, G_tp1.T, N_R_tp1_inv.T, N_R_tp1_inv)</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">    S_C_t_inv <span class="op">=</span> tt_finite_inv(S_C_t)</a>
<a class="sourceLine" id="cb7-14" data-line-number="14"></a>
<a class="sourceLine" id="cb7-15" data-line-number="15">    <span class="co"># M_H_t.T @ M_H_t = G_tp1 @ W_t_inv @ G_tp1.T + C_t_inv</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16">    M_H_t_inv <span class="op">=</span> tt.join(<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">                        N_W_t_inv.dot(G_tp1),</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">                        S_C_t_inv.dot(U_C_t.T))</a>
<a class="sourceLine" id="cb7-19" data-line-number="19">    _, d_H_t_inv, U_H_t <span class="op">=</span> svd(M_H_t_inv)</a>
<a class="sourceLine" id="cb7-20" data-line-number="20"></a>
<a class="sourceLine" id="cb7-21" data-line-number="21">    <span class="co"># H_t = inv(M_H_t.T @ M_H_t) = C_t - B_t @ R_tp1 @ B_t.T</span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22">    D_H_t <span class="op">=</span> tt.diag(tt_finite_inv(d_H_t_inv))</a>
<a class="sourceLine" id="cb7-23" data-line-number="23"></a>
<a class="sourceLine" id="cb7-24" data-line-number="24">    <span class="co"># C_Tt = C_t - matrix_dot(B_t, R_tp1 - C_Ttp1, B_t.T)</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25">    <span class="co"># C_Tt = M_C_Ttp1.T.dot(M_C_Ttp1)</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26">    M_C_Tt <span class="op">=</span> tt.join(<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb7-27" data-line-number="27">                     D_H_t.dot(U_H_t),</a>
<a class="sourceLine" id="cb7-28" data-line-number="28">                     matrix_dot(S_C_Ttp1, U_C_Ttp1.T, B_t.T))</a>
<a class="sourceLine" id="cb7-29" data-line-number="29">    U_C_Tt, d_C_Tt, _ <span class="op">=</span> svd(M_C_Tt)</a>
<a class="sourceLine" id="cb7-30" data-line-number="30"></a>
<a class="sourceLine" id="cb7-31" data-line-number="31">    S_C_Tt <span class="op">=</span> tt.diag(tt.sqrt(d_C_Tt))</a>
<a class="sourceLine" id="cb7-32" data-line-number="32"></a>
<a class="sourceLine" id="cb7-33" data-line-number="33">    m_Tt <span class="op">=</span> m_t <span class="op">+</span> B_t.dot(m_Ttp1 <span class="op">-</span> a_tp1)</a>
<a class="sourceLine" id="cb7-34" data-line-number="34"></a>
<a class="sourceLine" id="cb7-35" data-line-number="35">    <span class="cf">return</span> [m_Tt, U_C_Tt, S_C_Tt]</a>
<a class="sourceLine" id="cb7-36" data-line-number="36"></a>
<a class="sourceLine" id="cb7-37" data-line-number="37"></a>
<a class="sourceLine" id="cb7-38" data-line-number="38">N_W_inv_tt <span class="op">=</span> tt.diag(tt_finite_inv(s_W_tt)).dot(U_W_tt.T)</a>
<a class="sourceLine" id="cb7-39" data-line-number="39"></a>
<a class="sourceLine" id="cb7-40" data-line-number="40">m_T <span class="op">=</span> m_t[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-41" data-line-number="41">U_C_T <span class="op">=</span> U_C_t[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-42" data-line-number="42">S_C_T <span class="op">=</span> S_C_t[<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-43" data-line-number="43"></a>
<a class="sourceLine" id="cb7-44" data-line-number="44"><span class="co"># These series only go from N_obs - 1 to 1</span></a>
<a class="sourceLine" id="cb7-45" data-line-number="45">(m_Tt_rev, U_C_Tt_rev, S_C_Tt_rev), _ <span class="op">=</span> theano.scan(fn<span class="op">=</span>smoother_step,</a>
<a class="sourceLine" id="cb7-46" data-line-number="46">                                                    sequences<span class="op">=</span>[</a>
<a class="sourceLine" id="cb7-47" data-line-number="47">                                                        {<span class="st">&quot;input&quot;</span>: m_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-48" data-line-number="48">                                                        {<span class="st">&quot;input&quot;</span>: U_C_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-49" data-line-number="49">                                                        {<span class="st">&quot;input&quot;</span>: S_C_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-50" data-line-number="50">                                                        {<span class="st">&quot;input&quot;</span>: a_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-51" data-line-number="51">                                                        {<span class="st">&quot;input&quot;</span>: U_R_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-52" data-line-number="52">                                                        {<span class="st">&quot;input&quot;</span>: S_R_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]}</a>
<a class="sourceLine" id="cb7-53" data-line-number="53">                                                    ],</a>
<a class="sourceLine" id="cb7-54" data-line-number="54">                                                    outputs_info<span class="op">=</span>[</a>
<a class="sourceLine" id="cb7-55" data-line-number="55">                                                        {<span class="st">&quot;initial&quot;</span>: m_T, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-56" data-line-number="56">                                                        {<span class="st">&quot;initial&quot;</span>: U_C_T, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-57" data-line-number="57">                                                        {<span class="st">&quot;initial&quot;</span>: S_C_T, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb7-58" data-line-number="58">                                                    ],</a>
<a class="sourceLine" id="cb7-59" data-line-number="59">                                                    non_sequences<span class="op">=</span>[G_tt, N_W_inv_tt],</a>
<a class="sourceLine" id="cb7-60" data-line-number="60">                                                    go_backwards<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb7-61" data-line-number="61">                                                    strict<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb7-62" data-line-number="62">                                                    name<span class="op">=</span><span class="st">&#39;theta_Tt_obs&#39;</span>)</a>
<a class="sourceLine" id="cb7-63" data-line-number="63"></a>
<a class="sourceLine" id="cb7-64" data-line-number="64">m_Tt <span class="op">=</span> m_Tt_rev[::<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-65" data-line-number="65">U_C_Tt <span class="op">=</span> U_C_Tt_rev[::<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-66" data-line-number="66">S_C_Tt <span class="op">=</span> S_C_Tt_rev[::<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-67" data-line-number="67"></a>
<a class="sourceLine" id="cb7-68" data-line-number="68">m_Tt <span class="op">=</span> tt.join(<span class="dv">0</span>, m_Tt, [m_T])</a>
<a class="sourceLine" id="cb7-69" data-line-number="69">U_C_Tt <span class="op">=</span> tt.join(<span class="dv">0</span>, U_C_Tt, [U_C_T])</a>
<a class="sourceLine" id="cb7-70" data-line-number="70">S_C_Tt <span class="op">=</span> tt.join(<span class="dv">0</span>, S_C_Tt, [S_C_T])</a></code></pre></div>
<figcaption>
Listing 7
</figcaption>
</figure>
<p>Listing <a href="#orgad4c1a3">8</a> computes the filtered and smoothed means for our simulated series, and Figure <a href="#org50d26f8">9</a> shows the results.</p>
<figure id="orgad4c1a3">
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" data-line-number="1">filter_smooth_dlm <span class="op">=</span> tt_function([y_tt, N_theta_tt, G_tt, F_tt],</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">                                [m_t, m_Tt],</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">                                <span class="co"># mode=theano.compile.mode.FAST_COMPILE</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">                                )</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">m_t_sim, m_Tt_sim <span class="op">=</span> filter_smooth_dlm(y_sim, dlm_sim_values[N_theta_tt], dlm_sim_values[G_tt], dlm_sim_values[F_tt])</a></code></pre></div>
<figcaption>
Listing 8
</figcaption>
</figure>
<figure id="org50d26f8">
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="im">from</span> cycler <span class="im">import</span> cycler</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">bivariate_cycler <span class="op">=</span> plt_orig_cycler <span class="op">*</span> cycler(<span class="st">&#39;linestyle&#39;</span>, [<span class="st">&#39;-&#39;</span>, <span class="st">&#39;--&#39;</span>])</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">plt.close(fig<span class="op">=</span><span class="st">&#39;all&#39;</span>)</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">ax.set_prop_cycle(bivariate_cycler)</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">ax.plot(theta_t_sim, label<span class="op">=</span><span class="vs">r&#39;$\theta_t$&#39;</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">ax.plot(m_t_sim, label<span class="op">=</span><span class="vs">r&#39;$E[\theta_t \mid D_</span><span class="sc">{t}</span><span class="vs">]$&#39;</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">ax.plot(m_Tt_sim, label<span class="op">=</span><span class="vs">r&#39;$E[\theta_t \mid D_</span><span class="sc">{T}</span><span class="vs">]$&#39;</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">plt.legend(framealpha<span class="op">=</span><span class="fl">0.4</span>)</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">plt.tight_layout()</a></code></pre></div>
<figcaption>
Listing 9
</figcaption>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/drafts/figures/svd-steps-sim-plot.png" alt="" />
<figcaption>
</figcaption>
</figure>
</section>
</section>
<section id="forward-backward-estimation" class="level1">
<h1>Forward-backward Estimation</h1>
<p>We can use the smoothing and filtering steps in the previous section to perform a more efficient MCMC estimation than would otherwise be possible without the implicit Rao-Blackwellization.</p>
<p>Forward-filtering backward-sampling <a href="#66fb99775f308e808a193bd7bb2d2038">(Fr-Schnatter 1994)</a> works by first computing the forward filtered moments, allowing one to draw <span class="math inline">\(\theta_T\)</span> from <span class="math inline">\(\left(\theta_T \mid D_T\right) \sim \operatorname{N}\left(m_T, C_T\right)\)</span> and, subsequently, <span class="math inline">\(\theta_t\)</span> from <span class="math inline">\(\left(\theta_t \mid \theta_{t+1}, D_T \right) \sim \operatorname{N}\left(h_t, H_t\right)\)</span>.</p>
<p>The latter distribution’s moments are essentially a result of smoothing:</p>
<p><span class="math display">\[\begin{gather}
  B_t = C_t G^\top_{t+1} R_{t+1}^{-1}
  \\
  h_t = m_t + B_t \left(\theta_{t+1} - a_{t+1}\right)
  \\
  H_t = C_t - B_t R_{t+1} B^\top_t
\end{gather}\]</span></p>
<p>TODO: Describe SVD formulation.</p>
<figure>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">def</span> ffbs_step(m_t, U_C_t, S_C_t, a_tp1, U_R_tp1, S_R_tp1, theta_tp1, F_tp1, G_tp1, N_W_t_inv, rng):</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    <span class="co">&quot;&quot;&quot;Perform forward-filtering backward-sampling.&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    S_C_t_inv <span class="op">=</span> tt_finite_inv(S_C_t)</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">    <span class="co"># M_H_t.T @ M_H_t = G_tp1 @ W_t_inv @ G_tp1.T + C_t_inv</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">    M_H_t_inv <span class="op">=</span> tt.join(<span class="dv">0</span>,</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">                        N_W_t_inv.dot(G_tp1),</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">                        S_C_t_inv.dot(U_C_t.T))</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">    _, d_H_t_inv, U_H_t <span class="op">=</span> svd(M_H_t_inv)</a>
<a class="sourceLine" id="cb10-11" data-line-number="11"></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">    <span class="co"># H_t = inv(M_H_t.T @ M_H_t) = C_t - B_t @ R_tp1 @ B_t.T</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">    D_H_t <span class="op">=</span> tt.diag(tt_finite_inv(d_H_t_inv))</a>
<a class="sourceLine" id="cb10-14" data-line-number="14"></a>
<a class="sourceLine" id="cb10-15" data-line-number="15">    <span class="co"># H_t = matrix_dot(U_H_t, D_H_t, U_H_t.T)</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16">    <span class="co"># H_t.name = &quot;H_t&quot;</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"></a>
<a class="sourceLine" id="cb10-18" data-line-number="18">    N_C_t <span class="op">=</span> S_C_t.dot(U_C_t.T)</a>
<a class="sourceLine" id="cb10-19" data-line-number="19"></a>
<a class="sourceLine" id="cb10-20" data-line-number="20">    S_R_tp1_inv <span class="op">=</span> tt_finite_inv(S_R_tp1)</a>
<a class="sourceLine" id="cb10-21" data-line-number="21">    N_R_tp1_inv <span class="op">=</span> S_R_tp1_inv.dot(U_R_tp1.T)</a>
<a class="sourceLine" id="cb10-22" data-line-number="22"></a>
<a class="sourceLine" id="cb10-23" data-line-number="23">    <span class="co"># B_t = C_t @ G_tp1.T @ R_tp1</span></a>
<a class="sourceLine" id="cb10-24" data-line-number="24">    B_t <span class="op">=</span> matrix_dot(N_C_t.T, N_C_t, G_tp1.T, N_R_tp1_inv.T, N_R_tp1_inv)</a>
<a class="sourceLine" id="cb10-25" data-line-number="25"></a>
<a class="sourceLine" id="cb10-26" data-line-number="26">    h_t <span class="op">=</span> m_t <span class="op">+</span> B_t.dot(theta_tp1 <span class="op">-</span> a_tp1)</a>
<a class="sourceLine" id="cb10-27" data-line-number="27">    h_t.name <span class="op">=</span> <span class="st">&#39;h_t&#39;</span></a>
<a class="sourceLine" id="cb10-28" data-line-number="28"></a>
<a class="sourceLine" id="cb10-29" data-line-number="29">    <span class="co"># theta_t = MvNormalRV(h_t, H_t, rng=rng, name=&#39;theta_t_ffbs&#39;)</span></a>
<a class="sourceLine" id="cb10-30" data-line-number="30">    theta_t <span class="op">=</span> h_t <span class="op">+</span> matrix_dot(U_H_t, tt.sqrt(D_H_t),</a>
<a class="sourceLine" id="cb10-31" data-line-number="31">                               MvNormalRV(tt.zeros_like(h_t),</a>
<a class="sourceLine" id="cb10-32" data-line-number="32">                                          tt.eye(h_t.shape[<span class="dv">0</span>]),</a>
<a class="sourceLine" id="cb10-33" data-line-number="33">                                          rng<span class="op">=</span>rng)</a>
<a class="sourceLine" id="cb10-34" data-line-number="34">                               )</a>
<a class="sourceLine" id="cb10-35" data-line-number="35"></a>
<a class="sourceLine" id="cb10-36" data-line-number="36">    <span class="co"># These are statistics we&#39;re gathering for other posterior updates</span></a>
<a class="sourceLine" id="cb10-37" data-line-number="37">    theta_tp1_diff <span class="op">=</span> theta_tp1 <span class="op">-</span> G_tp1.dot(theta_t)</a>
<a class="sourceLine" id="cb10-38" data-line-number="38">    f_tp1 <span class="op">=</span> F_tp1.T.dot(theta_t)</a>
<a class="sourceLine" id="cb10-39" data-line-number="39"></a>
<a class="sourceLine" id="cb10-40" data-line-number="40">    <span class="co"># Sequentially sample/update quantities conditional on `theta_t` here...</span></a>
<a class="sourceLine" id="cb10-41" data-line-number="41"></a>
<a class="sourceLine" id="cb10-42" data-line-number="42">    <span class="cf">return</span> [theta_t, theta_tp1_diff, f_tp1]</a>
<a class="sourceLine" id="cb10-43" data-line-number="43"></a>
<a class="sourceLine" id="cb10-44" data-line-number="44"></a>
<a class="sourceLine" id="cb10-45" data-line-number="45">C_T <span class="op">=</span> matrix_dot(U_C_T, tt.square(S_C_T), U_C_T.T)</a>
<a class="sourceLine" id="cb10-46" data-line-number="46">theta_T_post <span class="op">=</span> MvNormalRV(m_T, C_T, rng<span class="op">=</span>rng_tt)</a>
<a class="sourceLine" id="cb10-47" data-line-number="47">theta_T_post.name <span class="op">=</span> <span class="st">&quot;theta_T_post&quot;</span></a>
<a class="sourceLine" id="cb10-48" data-line-number="48"></a>
<a class="sourceLine" id="cb10-49" data-line-number="49">ffbs_output, ffbs_updates <span class="op">=</span> theano.scan(fn<span class="op">=</span>ffbs_step,</a>
<a class="sourceLine" id="cb10-50" data-line-number="50">                                        sequences<span class="op">=</span>[</a>
<a class="sourceLine" id="cb10-51" data-line-number="51">                                            {<span class="st">&quot;input&quot;</span>: m_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb10-52" data-line-number="52">                                            {<span class="st">&quot;input&quot;</span>: U_C_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb10-53" data-line-number="53">                                            {<span class="st">&quot;input&quot;</span>: S_C_t, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb10-54" data-line-number="54">                                            {<span class="st">&quot;input&quot;</span>: a_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb10-55" data-line-number="55">                                            {<span class="st">&quot;input&quot;</span>: U_R_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb10-56" data-line-number="56">                                            {<span class="st">&quot;input&quot;</span>: S_R_t, <span class="st">&quot;taps&quot;</span>: [<span class="dv">1</span>]}</a>
<a class="sourceLine" id="cb10-57" data-line-number="57">                                        ],</a>
<a class="sourceLine" id="cb10-58" data-line-number="58">                                        outputs_info<span class="op">=</span>[</a>
<a class="sourceLine" id="cb10-59" data-line-number="59">                                            {<span class="st">&quot;initial&quot;</span>: theta_T_post, <span class="st">&quot;taps&quot;</span>: [<span class="op">-</span><span class="dv">1</span>]},</a>
<a class="sourceLine" id="cb10-60" data-line-number="60">                                            {}, {}, <span class="co"># theta_tp1_diff, f_tp1</span></a>
<a class="sourceLine" id="cb10-61" data-line-number="61">                                        ],</a>
<a class="sourceLine" id="cb10-62" data-line-number="62">                                        non_sequences<span class="op">=</span>[F_tt, G_tt, N_W_inv_tt, rng_tt],</a>
<a class="sourceLine" id="cb10-63" data-line-number="63">                                        go_backwards<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb10-64" data-line-number="64">                                        strict<span class="op">=</span><span class="va">True</span>,</a>
<a class="sourceLine" id="cb10-65" data-line-number="65">                                        name<span class="op">=</span><span class="st">&#39;ffbs_samples&#39;</span>)</a>
<a class="sourceLine" id="cb10-66" data-line-number="66"></a>
<a class="sourceLine" id="cb10-67" data-line-number="67">(theta_t_post_rev, theta_t_diff_rev, f_t_rev) <span class="op">=</span> ffbs_output</a>
<a class="sourceLine" id="cb10-68" data-line-number="68"></a>
<a class="sourceLine" id="cb10-69" data-line-number="69">theta_t_post <span class="op">=</span> tt.join(<span class="dv">0</span>, theta_t_post_rev[::<span class="op">-</span><span class="dv">1</span>], [theta_T_post])</a>
<a class="sourceLine" id="cb10-70" data-line-number="70"></a>
<a class="sourceLine" id="cb10-71" data-line-number="71"><span class="co"># We need to add the missing end-points onto these statistics...</span></a>
<a class="sourceLine" id="cb10-72" data-line-number="72">f_t_post <span class="op">=</span> tt.join(<span class="dv">0</span>, f_t_rev[::<span class="op">-</span><span class="dv">1</span>], [F_tt.T.dot(theta_T_post)])</a>
<a class="sourceLine" id="cb10-73" data-line-number="73"></a>
<a class="sourceLine" id="cb10-74" data-line-number="74">theta_t_diff_rev <span class="op">=</span> tt.join(<span class="dv">0</span>, theta_t_diff_rev, [theta_t_post[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> G_tt.dot(theta_0_rv)])</a></code></pre></div>
</figure>
<figure>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># E[nu[0]] = 2.0, Var[nu[0]] = 10.0</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co"># E[nu[1]] = 5.0, Var[nu[1]] = 5.0</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">a_nu, b_nu <span class="op">=</span> np.r_[<span class="fl">2.0</span><span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="fl">10.0</span>, <span class="fl">5.0</span><span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="fl">5.0</span>], np.r_[<span class="fl">2.0</span> <span class="op">/</span> <span class="fl">10.0</span>, <span class="fl">5.00</span> <span class="op">/</span> <span class="fl">5.0</span>]</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">a_eps, b_eps <span class="op">=</span> <span class="fl">0.5</span>, <span class="fl">1.0</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">nu_post_tt <span class="op">=</span> GammaRV(a_nu <span class="op">+</span> N_obs_tt <span class="op">*</span> <span class="fl">0.5</span>,</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">                     b_nu <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> tt.square(theta_t_diff_rev).<span class="bu">sum</span>(<span class="dv">0</span>),</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">                     rng<span class="op">=</span>rng_tt, name<span class="op">=</span><span class="st">&#39;nu_post&#39;</span>)</a>
<a class="sourceLine" id="cb11-10" data-line-number="10"></a>
<a class="sourceLine" id="cb11-11" data-line-number="11">eps_post_tt <span class="op">=</span> GammaRV(a_eps <span class="op">+</span> N_obs_tt <span class="op">*</span> <span class="fl">0.5</span>,</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">                      b_eps <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> tt.square(y_tt <span class="op">-</span> f_t_post).<span class="bu">sum</span>(),</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">                      rng<span class="op">=</span>rng_tt, name<span class="op">=</span><span class="st">&#39;eps_post&#39;</span>)</a></code></pre></div>
</figure>
<figure>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb12-1" data-line-number="1">ffbs_dlm <span class="op">=</span> tt_function([y_tt, N_obs_tt, N_theta_tt, G_tt, F_tt],</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">                       [theta_t_post, nu_post_tt, eps_post_tt],</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">                       updates<span class="op">=</span>ffbs_updates)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">nu_scale_tt.set_value(np.random.gamma(a_nu, scale<span class="op">=</span><span class="fl">1.0</span><span class="op">/</span>b_nu))</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">eps_scale_tt.set_value(np.random.gamma(a_eps, scale<span class="op">=</span><span class="fl">1.0</span><span class="op">/</span>b_eps))</a>
<a class="sourceLine" id="cb12-7" data-line-number="7"></a>
<a class="sourceLine" id="cb12-8" data-line-number="8">chain <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9">posterior_samples <span class="op">=</span> {<span class="st">&#39;theta&#39;</span>: [[]], <span class="st">&#39;nu&#39;</span>: [[]], <span class="st">&#39;eps&#39;</span>: [[]]}</a>
<a class="sourceLine" id="cb12-10" data-line-number="10"></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>):</a>
<a class="sourceLine" id="cb12-12" data-line-number="12"></a>
<a class="sourceLine" id="cb12-13" data-line-number="13">    theta_t_post_sim, nu_post_sim, eps_post_sim, nu_a, nu_b, eps_a, eps_b <span class="op">=</span> ffbs_dlm(</a>
<a class="sourceLine" id="cb12-14" data-line-number="14">        y_sim, dlm_sim_values[N_obs_tt], dlm_sim_values[N_theta_tt], dlm_sim_values[G_tt], dlm_sim_values[F_tt])</a>
<a class="sourceLine" id="cb12-15" data-line-number="15"></a>
<a class="sourceLine" id="cb12-16" data-line-number="16">    <span class="co"># Update variance scale parameters</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17">    nu_scale_tt.set_value(nu_post_sim)</a>
<a class="sourceLine" id="cb12-18" data-line-number="18">    eps_scale_tt.set_value(eps_post_sim)</a>
<a class="sourceLine" id="cb12-19" data-line-number="19"></a>
<a class="sourceLine" id="cb12-20" data-line-number="20">    posterior_samples[<span class="st">&#39;theta&#39;</span>][chain].append(theta_t_post_sim)</a>
<a class="sourceLine" id="cb12-21" data-line-number="21">    posterior_samples[<span class="st">&#39;nu&#39;</span>][chain].append(nu_post_sim)</a>
<a class="sourceLine" id="cb12-22" data-line-number="22">    posterior_samples[<span class="st">&#39;eps&#39;</span>][chain].append(eps_post_sim)</a>
<a class="sourceLine" id="cb12-23" data-line-number="23"></a>
<a class="sourceLine" id="cb12-24" data-line-number="24">    <span class="bu">print</span>(<span class="ss">f&#39;i=</span><span class="sc">{i}</span><span class="ss">,</span><span class="ch">\t</span><span class="ss">nu=</span><span class="sc">{</span>nu_post_sim<span class="sc">}</span><span class="ss">,</span><span class="ch">\t</span><span class="ss">eps=</span><span class="sc">{</span>eps_post_sim<span class="sc">}</span><span class="ss">&#39;</span>)</a>
<a class="sourceLine" id="cb12-25" data-line-number="25"></a>
<a class="sourceLine" id="cb12-26" data-line-number="26">posterior_samples <span class="op">=</span> {k: np.asarray(v) <span class="cf">for</span> k,v <span class="kw">in</span> posterior_samples.items()}</a></code></pre></div>
</figure>
<figure>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="im">from</span> cycler <span class="im">import</span> cycler</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="im">from</span> matplotlib.collections <span class="im">import</span> LineCollection</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">plt.clf()</a>
<a class="sourceLine" id="cb13-6" data-line-number="6"></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="fl">4.8</span>))</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">ax.autoscale(enable<span class="op">=</span><span class="va">False</span>)</a>
<a class="sourceLine" id="cb13-9" data-line-number="9"></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="co"># bivariate_cycler =  cycler(&#39;linestyle&#39;, [&#39;-&#39;, &#39;--&#39;]) * plt_orig_cycler</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="co"># ax.set_prop_cycle(bivariate_cycler)</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">thetas_shape <span class="op">=</span> posterior_samples[<span class="st">&#39;theta&#39;</span>][<span class="dv">0</span>].shape</a>
<a class="sourceLine" id="cb13-14" data-line-number="14"></a>
<a class="sourceLine" id="cb13-15" data-line-number="15">cycle <span class="op">=</span> ax._get_lines.prop_cycler</a>
<a class="sourceLine" id="cb13-16" data-line-number="16"></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(thetas_shape[<span class="op">-</span><span class="dv">1</span>]):</a>
<a class="sourceLine" id="cb13-18" data-line-number="18"></a>
<a class="sourceLine" id="cb13-19" data-line-number="19">    styles <span class="op">=</span> <span class="bu">next</span>(cycle)</a>
<a class="sourceLine" id="cb13-20" data-line-number="20">    thetas <span class="op">=</span> posterior_samples[<span class="st">&#39;theta&#39;</span>][<span class="dv">0</span>].T[d].T</a>
<a class="sourceLine" id="cb13-21" data-line-number="21"></a>
<a class="sourceLine" id="cb13-22" data-line-number="22">    theta_lines <span class="op">=</span> np.empty(thetas_shape[:<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> (<span class="dv">2</span>,))</a>
<a class="sourceLine" id="cb13-23" data-line-number="23">    theta_lines.T[<span class="dv">0</span>] <span class="op">=</span> np.tile(np.arange(thetas_shape[<span class="op">-</span><span class="dv">2</span>]), [thetas_shape[<span class="op">-</span><span class="dv">3</span>], <span class="dv">1</span>]).T</a>
<a class="sourceLine" id="cb13-24" data-line-number="24">    theta_lines.T[<span class="dv">1</span>] <span class="op">=</span> thetas.T</a>
<a class="sourceLine" id="cb13-25" data-line-number="25"></a>
<a class="sourceLine" id="cb13-26" data-line-number="26">    ax.add_collection(</a>
<a class="sourceLine" id="cb13-27" data-line-number="27">        LineCollection(theta_lines,</a>
<a class="sourceLine" id="cb13-28" data-line-number="28">                       label<span class="op">=</span><span class="vs">r&#39;$\theta_t \mid D_</span><span class="sc">{T}</span><span class="vs">$&#39;</span>,</a>
<a class="sourceLine" id="cb13-29" data-line-number="29">                       alpha<span class="op">=</span><span class="fl">0.3</span>, linewidth<span class="op">=</span><span class="fl">0.9</span>,</a>
<a class="sourceLine" id="cb13-30" data-line-number="30">                       <span class="op">**</span>styles)</a>
<a class="sourceLine" id="cb13-31" data-line-number="31">    )</a>
<a class="sourceLine" id="cb13-32" data-line-number="32"></a>
<a class="sourceLine" id="cb13-33" data-line-number="33">bivariate_obs_cycler <span class="op">=</span>  cycler(<span class="st">&#39;linestyle&#39;</span>, [<span class="st">&#39;-&#39;</span>, <span class="st">&#39;--&#39;</span>]) <span class="op">*</span> cycler(<span class="st">&#39;color&#39;</span>, [<span class="st">&#39;black&#39;</span>])</a>
<a class="sourceLine" id="cb13-34" data-line-number="34"></a>
<a class="sourceLine" id="cb13-35" data-line-number="35">ax.set_prop_cycle(bivariate_obs_cycler)</a>
<a class="sourceLine" id="cb13-36" data-line-number="36">ax.plot(theta_t_sim, label<span class="op">=</span><span class="vs">r&#39;$\theta_t$&#39;</span>, linewidth<span class="op">=</span><span class="fl">1.0</span>)</a>
<a class="sourceLine" id="cb13-37" data-line-number="37"></a>
<a class="sourceLine" id="cb13-38" data-line-number="38">ax.autoscale(enable<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb13-39" data-line-number="39"></a>
<a class="sourceLine" id="cb13-40" data-line-number="40">plt.tight_layout()</a>
<a class="sourceLine" id="cb13-41" data-line-number="41"></a>
<a class="sourceLine" id="cb13-42" data-line-number="42">plt.legend(framealpha<span class="op">=</span><span class="fl">0.4</span>)</a></code></pre></div>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/drafts/figures/ffbs-sim-plot.png" alt="" />
<figcaption>
</figcaption>
</figure>
<figure>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="im">import</span> arviz <span class="im">as</span> az</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">az_trace <span class="op">=</span> az.from_dict(posterior<span class="op">=</span>posterior_samples)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">az.plot_trace(az_trace, compact<span class="op">=</span><span class="va">True</span>)</a></code></pre></div>
</figure>
<figure id="nil" class="plot">
<img src="https://brandonwillard.github.io/drafts/figures/ffbs-trace-plot.png" alt="" />
<figcaption>
</figcaption>
</figure>
</section>
<section id="discussion" class="level1">
<h1>Discussion</h1>
<p>So far, we’ve only shown how to perform FFBS for DLMs in Theano.</p>
</section>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  CommonHTML: { linebreaks: { automatic: true } },
  "HTML-CSS": { linebreaks: { automatic: true } },
  SVG: { linebreaks: { automatic: true } },
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
</body>
</html>

            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'brandonwillard-github-io'; // required: replace example with your forum shortname

                    var disqus_identifier = 'dynamic-linear-model-optimizations-in-theano';
                var disqus_url = 'https://brandonwillard.github.io/drafts/dynamic-linear-model-optimizations-in-theano.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="https://brandonwillard.github.io//images/profile-pic.png"/>
        </p>
    <p>
      <strong>About Brandon T. Willard</strong><br/>
        applied math/stats person
    </p>
</div><!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://github.com/brandonwillard"><i class="fa fa-github-square fa-lg"></i> github</a></li>
    <li class="list-group-item"><a href="https://scholar.google.com/citations?user=g0oUxG4AAAAJ&hl=en"><i class="ai ai-google-scholar ai-lg"></i> google scholar</a></li>
    <li class="list-group-item"><a href="https://www.linkedin.com/in/brandon-t-willard-468bb410/"><i class="fa fa-linkedin fa-lg"></i> linkedin</a></li>
    <li class="list-group-item"><a href="https://bitbucket.io/brandonwillard"><i class="fa fa-bitbucket-square fa-lg"></i> bitbucket</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2019 Brandon T. Willard
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en">Creative Commons Attribution-NonCommercial 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://brandonwillard.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://brandonwillard.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://brandonwillard.github.io/theme/js/respond.min.js"></script>


    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'brandonwillard-github-io'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-91585967-1', '');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->


</body>
</html>